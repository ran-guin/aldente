<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>RGIO.pm</title>
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>RGIO.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name__uplink_">NAME &lt;UPLINK&gt;</a></li>
	<li><a href="#synopsis__uplink_">SYNOPSIS &lt;UPLINK&gt;</a></li>
	<li><a href="#description__uplink_">DESCRIPTION &lt;UPLINK&gt;</a></li>
	<li><a href="#known_issues__uplink_">KNOWN ISSUES &lt;UPLINK&gt;</a></li>
	<li><a href="#future_improvements__uplink_">FUTURE IMPROVEMENTS &lt;UPLINK&gt;</a></li>
	<li><a href="#authors__uplink_">AUTHORS &lt;UPLINK&gt;</a></li>
	<li><a href="#created__uplink_">CREATED &lt;UPLINK&gt;</a></li>
	<li><a href="#revision__uplink_">REVISION &lt;UPLINK&gt;</a></li>
</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-RGTools::RGIO-">package RGTools::RGIO</a>
<ul>
<li><a href="#err-">err</a></li>
<li><a href="#log_unit_test-">log_unit_test</a></li>
<li><a href="#log_usage-">log_usage</a></li>
<li><a href="#filter_input-">filter_input</a></li>
<li><a href="#split_arrays-">split_arrays</a></li>
<li><a href="#autoquote_string-">autoquote_string</a></li>
<li><a href="#resolve_range-">resolve_range</a></li>
<li><a href="#convert_to_range-">convert_to_range</a></li>
<li><a href="#get_username-">get_username</a></li>
<li><a href="#set_difference-">set_difference</a></li>
<li><a href="#set_operations-">set_operations</a></li>
<li><a href="#chomp_edge_whitespace-">chomp_edge_whitespace</a></li>
<li><a href="#xchomp-">xchomp</a></li>
<li><a href="#unique_items-">unique_items</a></li>
<li><a href="#try_system_command-">try_system_command</a></li>
<li><a href="#date_time-">date_time</a></li>
<li><a href="#timestamp-">timestamp</a></li>
<li><a href="#datestamp-">datestamp</a></li>
<li><a href="#now-">now</a></li>
<li><a href="#today-">today</a></li>
<li><a href="#week_end_date-">week_end_date</a></li>
<li><a href="#Message-">Message</a></li>
<li><a href="#HTML_Comment-">HTML_Comment</a></li>
<li><a href="#Test_Message-">Test_Message</a></li>
<li><a href="#Note-">Note</a></li>
<li><a href="#get_line_with-">get_line_with</a></li>
<li><a href="#list_contains-">list_contains</a></li>
<li><a href="#adjust_list-">adjust_list</a></li>
<li><a href="#array_containing-">array_containing</a></li>
<li><a href="#toggle_colour-">toggle_colour</a></li>
<li><a href="#dim_colour-">dim_colour</a></li>
<li><a href="#show_parameters-">show_parameters</a></li>
<li><a href="#Link_To-">Link_To</a></li>
<li><a href="#make_thumbnail-">make_thumbnail</a></li>
<li><a href="#Hlink_padded-">Hlink_padded</a></li>
<li><a href="#Log_Notes-">Log_Notes</a></li>
<li><a href="#File_to_HTML-">File_to_HTML</a></li>
<li><a href="#random_int-">random_int</a></li>
<li><a href="#start_barcode_form-">start_barcode_form</a></li>
<li><a href="#start_custom_form-">start_custom_form</a></li>
<li><a href="#load_Stats-">load_Stats</a></li>
<li><a href="#Lock_File-">Lock_File</a></li>
<li><a href="#Unlock_File-">Unlock_File</a></li>
<li><a href="#Show_ENV-">Show_ENV</a></li>
<li><a href="#Prompt_Input-">Prompt_Input</a></li>
<li><a href="#Get_Current_Dir-">Get_Current_Dir</a></li>
<li><a href="#Extract_Values-">Extract_Values</a></li>
<li><a href="#Show_Moz_Tool_Tip-">Show_Moz_Tool_Tip</a></li>
<li><a href="#Show_Tool_Tip-">Show_Tool_Tip</a></li>
<li><a href="#Array_Exists-">Array_Exists</a></li>
<li><a href="#Call_Stack-">Call_Stack</a></li>
<li><a href="#Cast_List-">Cast_List</a></li>
<li><a href="#Safe_Freeze-">Safe_Freeze</a></li>
<li><a href="#Safe_Thaw-">Safe_Thaw</a></li>
<li><a href="#input_error_check-">input_error_check</a></li>
<li><a href="#create_dir-">create_dir</a></li>
<li><a href="#Resolve_Path-">Resolve_Path</a></li>
<li><a href="#Parse_CSV_File-">Parse_CSV_File</a></li>
<li><a href="#strim-">strim</a></li>
<li><a href="#truncate_string-">truncate_string</a></li>
<li><a href="#encode_var-">encode_var</a></li>
<li><a href="#decode_var-">decode_var</a></li>
<li><a href="#day_elapsed-">day_elapsed</a></li>
<li><a href="#compare_objects-">compare_objects</a></li>
<li><a href="#compare_data-">compare_data</a></li>
<li><a href="#read_dumper-">read_dumper</a></li>
<li><a href="#unlink_old_file-">unlink_old_file</a></li>
<li><a href="#replace_last_line-">replace_last_line</a></li>
<li><a href="#get_lines_between_tags-">get_lines_between_tags</a></li>
<li><a href="#_record_diff_struct-">_record_diff_struct</a></li>
<li><a href="#_get_CSV_data-">_get_CSV_data</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<pre><span class="c">################################################################################</span>
<span class="c">#</span>
<span class="c"># RGIO.pm</span>
<span class="c">#</span>
<span class="c"># RGIO : This stands for Ran Guin Input/Output</span>
<span class="c">#</span>
<span class="c"># This provides a miscellaneous set of tools for use by Perl scripts</span>
<span class="c">#</span>
<span class="c">################################################################################</span>
<span class="c">################################################################################</span>
<span class="c"># $Id: RGIO.pm,v 1.134 2004/11/30 04:42:29 rguin Exp $</span>
<span class="c">################################################################################</span>
<span class="c"># CVS Revision: $Revision: 1.134 $</span>
<span class="c">################################################################################</span>
<a name="package-RGTools::RGIO-"></a><span class="k">package </span><span class="i">RGTools::RGIO</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># perldoc_header             #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="w">Carp</span><span class="sc">;</span>

</pre><p></p>
<hr />
<h1><a name="name__uplink_">NAME &lt;UPLINK&gt;</a></h1>
<p>RGIO.pm - RGIO : This stands for Ran Guin Input/Output I think -- kteague</p>
<p>
</p>
<hr />
<h1><a name="synopsis__uplink_">SYNOPSIS &lt;UPLINK&gt;</a></h1>
<pre>
        &lt;&lt;SYNOPSIS&gt;&gt;</pre>
<p>
</p>
<hr />
<h1><a name="description__uplink_">DESCRIPTION &lt;UPLINK&gt;</a></h1>
RGIO : This stands for Ran Guin Input/Output I think -- kteague<BR><pre>
<span class="c">##############################</span>
<span class="c"># superclasses               #</span>
<span class="c">##############################</span>

<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># system_variables           #</span>
<span class="c">##############################</span>
<span class="k">require</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="i">@EXPORT</span> = <span class="q">qw(</span>
    <span class="q">err</span>
    <span class="q">log_usage</span>
    <span class="q">filter_input</span>
    <span class="q">split_arrays</span>
    <span class="q">resolve_range</span>
    <span class="q">convert_to_range</span>
    <span class="q">get_username</span>
    <span class="q">set_difference</span>
    <span class="q">set_operations</span>
    <span class="q">chomp_edge_whitespace</span>
    <span class="q">xchomp</span>
    <span class="q">try_system_command</span>
    <span class="q">create_dir</span>
    <span class="q">date_time</span>
    <span class="q">timestamp</span>
    <span class="q">datestamp</span>
    <span class="q">now</span>
    <span class="q">today</span>
    <span class="q">week_end_date</span>
    <span class="q">Message</span>
    <span class="q">HTML_Comment</span>
    <span class="q">Test_Message</span>
    <span class="q">Note</span>
    <span class="q">get_line_with</span>
    <span class="q">list_contains</span>
    <span class="q">adjust_list</span>
    <span class="q">array_containing</span>
    <span class="q">toggle_colour</span>
    <span class="q">dim_colour</span>
    <span class="q">show_parameters</span>
    <span class="q">Link_To</span>
    <span class="q">truncate_string</span>
    <span class="q">Hlink_padded</span>
    <span class="q">Log_Notes</span>
    <span class="q">File_to_HTML</span>
    <span class="q">random_int</span>
    <span class="q">start_barcode_form</span>
    <span class="q">start_custom_form</span>
    <span class="q">load_Stats</span>
    <span class="q">Prompt_Input</span>
    <span class="q">Get_Current_Dir</span>
    <span class="q">Extract_Values</span>
    <span class="q">Show_Tool_Tip</span>
    <span class="q">Array_Exists</span>
    <span class="q">Popup_Menu</span>
    <span class="q">unique_items</span>
    <span class="q">Call_Stack</span>
    <span class="q">Cast_List</span>
    <span class="q">Safe_Freeze</span>
    <span class="q">Safe_Thaw</span>
    <span class="q">input_error_check</span>
    <span class="q">Parse_CSV_File</span>
    <span class="q">Resolve_Path</span>
    <span class="q">$session_id $user $dbase $project $banner $homelink $plate_id $plate_set $current_plates $step_name $solution_id $sol_mix $Current_Department</span>
    <span class="q">$MenuSearch</span>
    <span class="q">strim</span>
    <span class="q">autoquote_string</span>
    <span class="q">day_elapsed</span>
    <span class="q">compare_objects</span>
    <span class="q">compare_data</span>
    <span class="q">read_dumper</span>
    <span class="q">log_unit_test</span>
    <span class="q">replace_last_line</span>
    <span class="q">get_lines_between_tags</span>
<span class="q">)</span><span class="sc">;</span>
<span class="i">@EXPORT_OK</span> = <span class="q">qw(</span>
    <span class="q">err</span>
    <span class="q">log_usage</span>
    <span class="q">filter_input</span>
    <span class="q">split_arrays</span>
    <span class="q">resolve_range</span>
    <span class="q">convert_to_range</span>
    <span class="q">get_username</span>
    <span class="q">set_difference</span>
    <span class="q">set_operations</span>
    <span class="q">chomp_edge_whitespace</span>
    <span class="q">xchomp</span>
    <span class="q">try_system_command</span>
    <span class="q">create_dir</span>
    <span class="q">date_time</span>
    <span class="q">timestamp</span>
    <span class="q">datestamp</span>
    <span class="q">now</span>
    <span class="q">today</span>
    <span class="q">week_end_date</span>
    <span class="q">Message</span>
    <span class="q">Test_Message</span>
    <span class="q">Note</span>
    <span class="q">get_line_with</span>
    <span class="q">list_contains</span>
    <span class="q">adjust_list</span>
    <span class="q">array_containing</span>
    <span class="q">toggle_colour</span>
    <span class="q">dim_colour</span>
    <span class="q">show_parameters</span>
    <span class="q">Link_To</span>
    <span class="q">truncate_string</span>
    <span class="q">Hlink_padded</span>
    <span class="q">Log_Notes</span>
    <span class="q">File_to_HTML</span>
    <span class="q">start_barcode_form</span>
    <span class="q">start_custom_form</span>
    <span class="q">load_Stats</span>
    <span class="q">Prompt_Input</span>
    <span class="q">Get_Current_Dir</span>
    <span class="q">Extract_Values</span>
    <span class="q">Show_Tool_Tip</span>
    <span class="q">Array_Exists</span>
    <span class="q">Popup_Menu</span>
    <span class="q">unique_items</span>
    <span class="q">Call_Stack</span>
    <span class="q">Cast_List</span>
    <span class="q">Safe_Freeze</span>
    <span class="q">Safe_Thaw</span>
    <span class="q">Parse_CSV_File</span>
    <span class="q">Resolve_Path</span>
    <span class="q">$session_id $user $dbase $project $banner $homelink $plate_id $plate_set $current_plates $step_name $solution_id $sol_mix $Current_Department</span>
    <span class="q">$MenuSearch</span>
    <span class="q">autoquote_string</span>
    <span class="q">day_elapsed</span>
    <span class="q">compare_objects</span>
    <span class="q">compare_data</span>
    <span class="q">read_dumper</span>
    <span class="q">replace_last_line</span>
<span class="q">)</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># standard_modules_ref       #</span>
<span class="c">##############################</span>

<span class="k">use</span> <span class="w">CGI</span> <span class="q">qw(:standard)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Storable</span> <span class="q">qw(store retrieve freeze thaw)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Benchmark</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Term::ReadKey</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cwd</span> <span class="q">'abs_path'</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">URI::Escape</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">POSIX</span> <span class="q">qw(strftime)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># custom_modules_ref         #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="w">SDB::CustomSettings</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># global_vars                #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw($style $testing $scanner_mode $Session $Current_Department)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw($MenuSearch)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw($session_id $user $dbase $project $banner $homelink $plate_id $plate_set $current_plates $step_name $solution_id $sol_mix)</span><span class="sc">;</span>    <span class="c">### TEMPORARY</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw($Connection)</span><span class="sc">;</span>                                                                                                                  <span class="c">## &lt;CONSTRUCTION&gt; - remove -temporary</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(%Benchmark)</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># modular_vars               #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># constants                  #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># main_header                #</span>
<span class="c">##############################</span>
<span class="k">my</span> <span class="i">$colour</span>         = <span class="q">&quot;blue&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$note_colour</span>    = <span class="q">&quot;yellow&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$warning_colour</span> = <span class="q">&quot;orange&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$error_colour</span>   = <span class="q">&quot;red&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$error_colour2</span>  = <span class="q">&quot;yellow&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$colour2</span>        = <span class="q">&quot;yellow&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$header_colour</span>  = <span class="q">&quot;#FF5555&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$line_colour1</span>   = <span class="q">&quot;lightyellow&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$line_colour2</span>   = <span class="q">&quot;DDDDDD&quot;</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># constructor                #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># public_methods             #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># public_functions           #</span>
<span class="c">##############################</span>

<span class="c">#===============================================================================================================#</span>
<span class="c"># Method :</span>
<span class="c"># Usage  :</span>
<span class="c">#</span>
<span class="c"># Return :</span>
<span class="c">#===============================================================================================================#</span>

<span class="c">##########</span>
<span class="c">#</span>
<span class="c"># Enable exception handling and return of '0' from methods/functions without dying.</span>
<span class="c"># This returns 0 to be consistent with standard error returns, and generates a carp exception, but does not die.</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#  Example:</span>
<span class="c"># unless ($ok) { return err(&quot;Failed at this step&quot;) }</span>
<span class="c">#</span>
<span class="c"># (this generates a carp warning, but continues running, returning a '0' which can be recognized as a 'fail');</span>
<span class="c">#</span>
<span class="c"># If return 1 is used for some reason as a failure, then it can be called using the optional returnval paramater:</span>
<span class="c">#</span>
<span class="c"># unless ($ok) { return err(&quot;Failed at this step&quot;,1) }</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Return: 0 (or as specified)</span>
<span class="c">############</span>
<a name="err-"></a><span class="k">sub </span><span class="m">err</span> <span class="s">{</span>
<span class="c">############</span>
    <span class="k">my</span> <span class="i">$message</span>   = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$returnval</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c">## optional return value (defaults to 'undef')</span>
    <span class="k">my</span> <span class="i">$verbose</span>   = <span class="k">shift</span><span class="sc">;</span>    <span class="c">## include details</span>

    <span class="k">my</span> <span class="i">$details</span> = <span class="w">Dumper</span> <span class="i">Call_Stack</span><span class="s">(</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$verbose</span><span class="sc">;</span>
    <span class="i">Message</span><span class="s">(</span> <span class="q">&quot;Error: $message&quot;</span><span class="cm">,</span> <span class="i">$details</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">carp</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$returnval</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###################</span>
<span class="c">#</span>
<span class="c"># Provide for logging of input / output combinations for possible unit testing.</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">###################</span>
<a name="log_unit_test-"></a><span class="k">sub </span><span class="m">log_unit_test</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span>
         \<span class="i">@_</span><span class="cm">,</span>
        -<span class="w">args</span>      <span class="cm">=&gt;</span> <span class="q">'input,output,file'</span><span class="cm">,</span>
        -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'input|args,output'</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">require</span> <span class="w">YAML</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input</span>      = <span class="i">$args</span>{-<span class="w">input</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span>     = <span class="i">$args</span>{-<span class="w">output</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$file</span>       = <span class="i">$args</span>{-<span class="w">file</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_args</span> = <span class="i">$args</span>{-<span class="w">args</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$log</span>        = <span class="i">$args</span>{ -<span class="k">log</span> }<span class="sc">;</span>                                                      <span class="c">##</span>
    <span class="k">my</span> <span class="i">$path</span>       = <span class="i">$args</span>{-<span class="w">path</span>} || <span class="q">&quot;/home/sequence/alDente/logs/alDente_unit_test&quot;</span><span class="sc">;</span>    <span class="c">## default path &lt;CUSTOM&gt;</span>
    <span class="k">my</span> <span class="i">$debug</span>      = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span> <span class="i">$log</span> &amp;&amp; <span class="i">$file</span> <span class="s">)</span> <span class="s">{</span><span class="k">return</span><span class="s">}</span>

    <span class="k">my</span> <span class="i">$call</span> = <span class="i">Call_Stack</span><span class="s">(</span> -<span class="w">level</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$call</span> =~ <span class="q">s/::/\//g</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$caller</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$call</span> =~ <span class="q">/(\w+)$/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$caller</span> = <span class="i">$1</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## generate YAML for input ##</span>
    <span class="k">my</span> <span class="i">%Input</span> = <span class="i">%</span>{<span class="i">$input</span>} <span class="k">if</span> <span class="i">$input</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$input_args</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">map</span> <span class="s">{</span> <span class="i">$Input</span>{<span class="i">$_</span>} = <span class="i">$input_args</span>-&gt;{<span class="i">$_</span>} <span class="k">if</span> <span class="k">defined</span> <span class="i">$input_args</span>-&gt;{<span class="i">$_</span>} <span class="s">}</span>
            <span class="k">keys</span> <span class="i">%</span>{<span class="i">$input_args</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$yaml</span> = <span class="i">YAML::Dump</span><span class="s">(</span> \<span class="i">%Input</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## generate YAML for output ##</span>

    <span class="k">my</span> <span class="i">$filename</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$file</span> =~ <span class="q">/\//</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$filename</span> = <span class="i">$file</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c">## if path explicitly defined ##</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="q">`mkdir -p $path/$call`</span> <span class="k">unless</span> <span class="s">(</span> <span class="k">-e</span> <span class="q">&quot;$path/$call/&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$filename</span> = <span class="q">&quot;$path/$call/$caller.unit_test_&quot;</span> . <span class="i">&amp;timestamp</span> . <span class="q">&quot;.case&quot;</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c">## standard storage structure (interfaces with viewing tools)</span>

    <span class="k">open</span><span class="s">(</span> <span class="w">CASE</span><span class="cm">,</span> <span class="q">&quot;&gt;$filename&quot;</span> <span class="s">)</span> || <span class="k">print</span> <span class="q">&quot;could not open $filename&quot;</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="q">&lt;CASE&gt;</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">CASE</span> <span class="q">&quot;*** INPUT ***\n&quot;</span> . <span class="i">YAML::Dump</span><span class="s">(</span> \<span class="i">%Input</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">CASE</span> <span class="q">&quot;*** OUTPUT ***\n&quot;</span> . <span class="i">YAML::Dump</span><span class="s">(</span><span class="i">$output</span><span class="s">)</span> <span class="k">if</span> <span class="i">$output</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">CASE</span> <span class="q">&quot;*** END ***\n&quot;</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span><span class="w">CASE</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;SAVED case to $filename&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">$yaml</span> <span class="k">if</span> <span class="i">$debug</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">###########################</span>
<span class="c">#</span>
<span class="c"># Simple function to allow detailed logging of script usage</span>
<span class="c">#</span>
<span class="c">###############</span>
<a name="log_usage-"></a><span class="k">sub </span><span class="m">log_usage</span> <span class="s">{</span>
<span class="c">###############</span>
    <span class="k">my</span> <span class="i">%args</span>    = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$log</span>     = <span class="i">$args</span>{ -<span class="k">log</span> }<span class="sc">;</span>            <span class="c">## file to log to</span>
    <span class="k">my</span> <span class="i">$data</span>    = <span class="i">$args</span>{-<span class="w">data</span>}<span class="sc">;</span>             <span class="c">##</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="i">$args</span>{-<span class="w">message</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$user</span>    = <span class="i">$args</span>{-<span class="w">user</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$include</span> = <span class="i">$args</span>{-<span class="w">include</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c">## log inclusion options (eg. source, connection)</span>
    <span class="k">my</span> <span class="i">$object</span>  = <span class="i">$args</span>{-<span class="w">object</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$chmod</span>   = <span class="i">$args</span>{ -<span class="k">chmod</span> }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$chown</span>   = <span class="i">$args</span>{ -<span class="k">chown</span> }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$chgrp</span>   = <span class="i">$args</span>{-<span class="w">chgrp</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$include_source</span> = <span class="k">grep</span> <span class="q">/source/</span><span class="cm">,</span> <span class="s">(</span><span class="i">$include</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$user</span> ||= <span class="q">`whoami`</span><span class="sc">;</span>
    <span class="k">chomp</span> <span class="i">$user</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$file</span> = <span class="i">$0</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="w">FILE</span><span class="cm">,</span> <span class="q">&quot;&gt;&gt;$log&quot;</span> <span class="s">)</span> <span class="k">or</span> <span class="k">return</span> <span class="q">&quot;Error logging to $log&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">FILE</span> <span class="q">&quot;\n&quot;</span> . <span class="i">date_time</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">FILE</span> <span class="q">&quot;User: $user\nFile: $0\n**************************\n&quot;</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$include_source</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">FILE</span> <span class="q">&quot;** Source **\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">FILE</span> <span class="k">join</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">Call_Stack</span><span class="s">(</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> }<span class="sc">;</span>
        <span class="k">print</span> <span class="i">FILE</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$object</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">FILE</span> <span class="q">&quot;** Base Object Dump **\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">FILE</span> <span class="i">Dumper</span><span class="s">(</span><span class="i">$object</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$data</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">FILE</span> <span class="q">&quot;** Data Dump **\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">FILE</span> <span class="i">Dumper</span><span class="s">(</span><span class="i">$data</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$message</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="i">FILE</span> <span class="q">&quot;** Message **\n$message\n&quot;</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">close</span> <span class="w">FILE</span><span class="sc">;</span>

    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;chmod $chmod $log&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$chmod</span><span class="sc">;</span>
    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;chown $chown $log&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$chown</span><span class="sc">;</span>
    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;chown $chgrp $log&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$chgrp</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###########################</span>
<span class="c"># Ensures all arguments are in proper '-key =&gt; value' format</span>
<span class="c"># Allows for indication of parameters that should be 'shifted' into arguments</span>
<span class="c"># Allows for indication of defaults if values not supplied</span>
<span class="c">#</span>
<span class="c"># Logs details optionally to file</span>
<span class="c">#</span>
<span class="c"># Sends warning if '-key' detected for as a value</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:</span>
<span class="c">#</span>
<span class="c">#   ## allows 'func($id_list)' as short form for 'func(-sample_id=&gt;$id_list)' format automatically ##</span>
<span class="c">#</span>
<span class="c">#   my %args = &amp;filter_input(\@_,                   ## shift in all arguments</span>
<span class="c">#                            -args=&gt;'sample_id',    ## default order for shifted in arguments</span>
<span class="c">#                            -mandatory=&gt;'sample_id')</span>
<span class="c">#                                 )</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c"># Return: populated hash of input arguments.  (Error/Warning Message generated if there are any problems)</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="filter_input-"></a><span class="k">sub </span><span class="m">filter_input</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$args_ref</span> = <span class="k">shift</span> || <span class="q">''</span><span class="sc">;</span>    <span class="c"># first argument should be reference to input hash...</span>

    <span class="k">unless</span> <span class="s">(</span> !<span class="i">$args_ref</span> || <span class="k">ref</span> <span class="i">$args_ref</span> <span class="k">eq</span> <span class="q">'ARRAY'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">croak</span><span class="s">(</span> <span class="q">&quot;Error: must pass Array reference to filter_input\n&quot;</span> . <span class="i">Call_Stack</span><span class="s">(</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">@input_arguments</span> = <span class="i">@$args_ref</span> <span class="k">if</span> <span class="i">$args_ref</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%output_hash</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$params</span>      = <span class="i">$args</span>{-<span class="w">args</span>}<span class="sc">;</span>        <span class="c"># ordered list of parameters (if NOT already in args format) to be shifted in</span>
    <span class="k">my</span> <span class="i">$default_ref</span> = <span class="i">$args</span>{-<span class="w">defaults</span>}<span class="sc">;</span>    <span class="c"># ordered list of default values if applicable</span>
    <span class="k">my</span> <span class="i">$format_ref</span>  = <span class="i">$args</span>{-<span class="w">formats</span>}<span class="sc">;</span>     <span class="c"># ordered list of formats if applicable  (not yet utilized..)</span>

    <span class="k">my</span> <span class="i">$reset</span>       = <span class="i">$args</span>{ -<span class="k">reset</span> } || <span class="n">1</span><span class="sc">;</span>    <span class="c"># reset all arguments if auto-setting (otherwise maintains)</span>
    <span class="k">my</span> <span class="i">$mandatory</span>   = <span class="i">$args</span>{-<span class="w">mandatory</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$log</span>         = <span class="i">$args</span>{ -<span class="k">log</span> }<span class="sc">;</span>           <span class="c"># log this call in the specified log file...</span>
    <span class="k">my</span> <span class="i">$log_message</span> = <span class="i">$args</span>{-<span class="w">log_message</span>}<span class="sc">;</span>     <span class="c"># include this message with the standard log information</span>
    <span class="k">my</span> <span class="i">$username</span>    = <span class="i">$args</span>{-<span class="w">user</span>} || <span class="q">''</span><span class="sc">;</span>      <span class="c"># user name (for logging purposes)</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>           <span class="c"># less verbose output..</span>
    <span class="k">my</span> <span class="i">$self</span>        = <span class="i">$args</span>{-<span class="w">self</span>}<span class="sc">;</span>            <span class="c"># Object that a method is called from</span>
    <span class="k">my</span> <span class="i">$verbose</span>     = <span class="i">$args</span>{-<span class="w">verbose</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$use_global</span>  = <span class="i">$args</span>{-<span class="w">use_global</span>}<span class="sc">;</span>      <span class="c"># &lt;construction&gt; - temporary to allow for global Connection object.</span>
    <span class="k">my</span> <span class="i">$fatal</span>       = <span class="i">$args</span>{-<span class="w">fatal</span>}<span class="sc">;</span>           <span class="c"># die on ERROR -</span>
                                               <span class="c"># (may be able to get rid of this when GSDB , SDB are combined) #</span>

    <span class="k">my</span> <span class="i">@parameters</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$params</span><span class="cm">,</span>      -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$params</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@defaults</span>   = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$default_ref</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$default_ref</span><span class="sc">;</span>

    <span class="c">## allow input formats as array or hash keyed on arguments ##</span>
    <span class="k">my</span> <span class="i">@formats</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$format_ref</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span> <span class="k">if</span> <span class="k">ref</span> <span class="i">$format_ref</span> <span class="k">eq</span> <span class="q">'ARRAY'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@format_keys</span> = <span class="k">keys</span> <span class="i">%$format_ref</span> <span class="k">if</span> <span class="k">ref</span> <span class="i">$format_ref</span> <span class="k">eq</span> <span class="q">'HASH'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="c">## Check to see if this method is called as a function or an object (set -self key if object identified) ##</span>
    <span class="k">my</span> <span class="i">$object</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$self</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$type</span> = <span class="k">ref</span> <span class="i">$input_arguments</span>[<span class="n">0</span>]<span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">UNIVERSAL::isa</span><span class="s">(</span> <span class="i">$type</span><span class="cm">,</span> <span class="q">&quot;$self&quot;</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c">#	if ($type =~ /\b$self\b/) {</span>
            <span class="c">## Object calling this method is recognized (shift the object out of the input arguments) ##</span>
            <span class="i">$object</span> = <span class="k">shift</span> <span class="i">@input_arguments</span> <span class="k">if</span> <span class="i">@input_arguments</span><span class="sc">;</span>    <span class="c">## shift input arguments</span>
            <span class="k">shift</span> <span class="i">@$args_ref</span><span class="sc">;</span>                                        <span class="c">## also remove here to be consistent</span>
            <span class="k">shift</span> <span class="i">@parameters</span>  <span class="k">if</span> <span class="i">@parameters</span><span class="sc">;</span>                       <span class="c">## shift input parameter list</span>
            <span class="k">shift</span> <span class="i">@defaults</span>    <span class="k">if</span> <span class="i">@defaults</span><span class="sc">;</span>
            <span class="k">shift</span> <span class="i">@formats</span>     <span class="k">if</span> <span class="i">@formats</span><span class="sc">;</span>
            <span class="k">shift</span> <span class="i">@format_keys</span> <span class="k">if</span> <span class="i">@format_keys</span><span class="sc">;</span>

            <span class="c">#	    $index++;                  ## (not needed with above shifts.. )</span>
            <span class="i">Message</span><span class="s">(</span><span class="q">&quot;recognized $type object: $object (shifting input parameters and arguments)\n&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$verbose</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$subtype</span> = <span class="k">ref</span> <span class="i">$type</span><span class="sc">;</span>
            <span class="k">print</span> <span class="q">&quot;Called as a function ($type ne $self) : $subtype.\n&quot;</span> <span class="k">if</span> <span class="i">$verbose</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">## make number of arguments even to allow mapping to hash</span>

    <span class="k">unless</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span> <span class="k">int</span><span class="s">(</span> <span class="i">@input_arguments</span> / <span class="n">2</span> <span class="s">)</span> <span class="s">)</span> == <span class="k">int</span><span class="s">(</span><span class="i">@input_arguments</span><span class="s">)</span> / <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@$args_ref</span><span class="cm">,</span> <span class="q">''</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">%input_hash</span> = <span class="i">@$args_ref</span> <span class="k">if</span> <span class="i">$args_ref</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@input_parameters</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@set_Defaults</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@set_Parameters</span><span class="sc">;</span>
    <span class="c">### If arguments are required, set arguments based on list ###</span>
    <span class="k">my</span> <span class="i">@keys</span>           = <span class="k">keys</span> <span class="i">%input_hash</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@not_args</span>       = <span class="k">grep</span> <span class="q">/^[^-]/</span><span class="cm">,</span> <span class="i">@keys</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@signed_integer</span> = <span class="k">grep</span> <span class="q">/^-[\d\W]/</span><span class="cm">,</span> <span class="i">@keys</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@not_args</span><span class="cm">,</span> <span class="i">@signed_integer</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span><span class="i">@signed_integer</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">@not_args</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@values</span> = <span class="s">(</span><span class="q">''</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">@values</span> = <span class="k">values</span> <span class="i">%input_hash</span> <span class="k">if</span> <span class="i">%input_hash</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@offset</span> = <span class="k">grep</span> <span class="q">/^[-][a-zA-Z]/</span><span class="cm">,</span> <span class="i">@values</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">@parameters</span><span class="s">)</span> <span class="s">{</span>    <span class="c">## shift each value into respective key in arguments hash ##</span>
            <span class="i">$output_hash</span>{-<span class="w">autoset</span>} = <span class="n">1</span><span class="sc">;</span>    <span class="c">## set flag to indicate parameters were autoset</span>
            <span class="k">undef</span> <span class="i">%</span>{<span class="i">$args_ref</span>} <span class="k">if</span> <span class="i">$reset</span><span class="sc">;</span>  <span class="c">## clear arguments and start over (optional)</span>
            <span class="k">my</span> <span class="i">$key</span> = <span class="n">1</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$parameter</span> <span class="s">(</span><span class="i">@parameters</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$value</span> = <span class="i">$input_arguments</span>[<span class="i">$index</span>]<span class="sc">;</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@input_parameters</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$args_ref</span> &amp;&amp; <span class="k">defined</span> <span class="i">$input_arguments</span>[<span class="i">$index</span>] &amp;&amp; <span class="i">$input_arguments</span>[<span class="i">$index</span>] =~ <span class="q">/^-([a-zA-Z].+)/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">while</span> <span class="s">(</span> <span class="i">$input_arguments</span>[<span class="i">$index</span>] =~ <span class="q">/^-([a-zA-Z].+)/</span> <span class="s">)</span> <span class="s">{</span>
                        <span class="k">my</span> <span class="i">$key</span> = <span class="i">$1</span><span class="sc">;</span>

                        <span class="k">my</span> <span class="i">$value</span> = <span class="i">$input_arguments</span>[ ++<span class="i">$index</span> ]<span class="sc">;</span>
                        <span class="i">$output_hash</span>{<span class="q">&quot;-$key&quot;</span>} = <span class="i">$value</span> <span class="k">if</span> <span class="k">defined</span> <span class="i">$value</span><span class="sc">;</span>
                        <span class="i">$index</span>++<span class="sc">;</span>
                    <span class="s">}</span>
                    <span class="k">last</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">elsif</span> <span class="s">(</span> <span class="i">$input_hash</span>{<span class="q">&quot;-$parameter&quot;</span>} <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;** Error: $parameter input out of sequence (put all -key=&gt;value pairs at the end)\n&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="c">## Set defaults if supplied ##</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="i">$value</span> || !<span class="i">$default_ref</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$value</span> = <span class="i">$defaults</span>[<span class="i">$index</span>]<span class="sc">;</span>
                    <span class="k">push</span><span class="s">(</span> <span class="i">@set_Defaults</span><span class="cm">,</span> <span class="q">&quot;$parameter =&gt; &quot;</span> . <span class="i">$defaults</span>[<span class="i">$index</span>] <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="i">$output_hash</span>{<span class="q">&quot;-$parameter&quot;</span>} = <span class="i">$value</span><span class="sc">;</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@set_Parameters</span><span class="cm">,</span> <span class="q">&quot;$parameter =&gt; &quot;</span> . <span class="i">$value</span> <span class="s">)</span> <span class="k">if</span> <span class="k">defined</span> <span class="i">$value</span><span class="sc">;</span>
                <span class="i">$index</span>++<span class="sc">;</span>
            <span class="s">}</span>
            <span class="c">### get any other key=&gt;value pairs that may be specified after default parameters ###</span>
            <span class="k">while</span> <span class="s">(</span> <span class="i">@input_arguments</span> &amp;&amp; <span class="k">defined</span> <span class="i">$input_arguments</span>[<span class="i">$index</span>] &amp;&amp; <span class="i">$input_arguments</span>[<span class="i">$index</span>] =~ <span class="q">/^-([a-zA-Z].+)/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$key</span>   = <span class="i">$1</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$value</span> = <span class="i">$input_arguments</span>[ ++<span class="i">$index</span> ]<span class="sc">;</span>
                <span class="i">$output_hash</span>{<span class="q">&quot;-$key&quot;</span>} = <span class="i">$value</span><span class="sc">;</span>
                <span class="i">$index</span>++<span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input_arguments</span>[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$extra</span> = <span class="i">$input_arguments</span>[<span class="i">$index</span>]<span class="sc">;</span>
                <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;** Error: Extra parameters detected ($extra ?) AFTER recognized parameters\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span><span class="i">@offset</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;** Error: Possible offset of parameters:\n&quot;</span><span class="sc">;</span>    <span class="c">## check for possible offset keys ##</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$off</span> <span class="s">(</span><span class="i">@offset</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;** Error: $off detected as a VALUE (should this be a key ?)\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;** Error: Incorrect format (or at least supply parameter list)\n&quot;</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$fail</span> <span class="s">(</span><span class="i">@not_args</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;** Error: unrecognized Key: $fail\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="i">%output_hash</span> = <span class="i">%input_hash</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## generate '-self' object if object identified ##</span>
    <span class="i">$output_hash</span>{-<span class="w">self</span>} = <span class="i">$object</span> <span class="k">if</span> <span class="i">$object</span><span class="sc">;</span>
    <span class="c">## Temporarily populate '-self' object with global $Connection object for DBIO object types ##</span>
    <span class="i">$output_hash</span>{-<span class="w">self</span>} ||= <span class="i">$Connection</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$use_global</span> &amp;&amp; <span class="i">$Connection</span> &amp;&amp; <span class="i">$self</span> =~ <span class="q">/\bDBIO/</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## &lt;CONSTRUCTION&gt; ##</span>

    <span class="k">my</span> <span class="i">$errors</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$mandatory</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@missed</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$required_arg</span> <span class="s">(</span> <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$mandatory</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## allow one of multiple arguments ##</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$required_arg</span> =~ <span class="q">/\|/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$found</span> = <span class="n">0</span><span class="sc">;</span>
                <span class="k">foreach</span> <span class="k">my</span> <span class="i">$arg</span> <span class="s">(</span> <span class="k">split</span> <span class="q">/\Q|/</span><span class="cm">,</span> <span class="i">$required_arg</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;look for $arg ?&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$verbose</span><span class="sc">;</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="k">exists</span> <span class="i">$output_hash</span>{<span class="q">&quot;-$arg&quot;</span>} <span class="s">)</span> <span class="s">{</span>
                        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;found&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$verbose</span><span class="sc">;</span>
                        <span class="c">### check for non-empty array ###</span>
                        <span class="k">if</span> <span class="s">(</span> <span class="i">$output_hash</span>{<span class="q">&quot;-$arg&quot;</span>} &amp;&amp; <span class="s">(</span> <span class="k">ref</span><span class="s">(</span> <span class="i">$output_hash</span>{<span class="q">&quot;-$arg&quot;</span>} <span class="s">)</span> <span class="k">eq</span> <span class="q">'ARRAY'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                            <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$output_hash</span>{<span class="q">&quot;-$arg&quot;</span>} } <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                                <span class="i">$found</span>++<span class="sc">;</span>
                                <span class="k">last</span><span class="sc">;</span>
                            <span class="s">}</span>    <span class="c">## ok ##</span>
                            <span class="k">else</span> <span class="s">{</span>
                                <span class="k">print</span> <span class="q">&quot;Warning: '-$required_arg=&gt;...' points to an empty array&quot;</span><span class="sc">;</span>
                            <span class="s">}</span>
                        <span class="s">}</span>
                        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$output_hash</span>{<span class="q">&quot;-$arg&quot;</span>} <span class="s">)</span> <span class="s">{</span>
                            <span class="i">$found</span>++<span class="sc">;</span>    <span class="c">## ok</span>
                            <span class="k">last</span><span class="sc">;</span>
                        <span class="s">}</span>
                    <span class="s">}</span>
                    <span class="k">else</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;NOT found&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$verbose</span><span class="sc">;</span> <span class="s">}</span>
                <span class="s">}</span>
                <span class="k">unless</span> <span class="s">(</span><span class="i">$found</span><span class="s">)</span> <span class="s">{</span>
                    <span class="k">print</span> <span class="q">&quot;Warning: Missed argument (must supply one of: $required_arg)\n&quot;</span><span class="sc">;</span>
                    <span class="k">push</span><span class="s">(</span> <span class="i">@missed</span><span class="cm">,</span> <span class="i">$required_arg</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="c">### check for singularly mandatory arguments ###</span>
            <span class="k">else</span> <span class="s">{</span>

                <span class="k">unless</span> <span class="s">(</span> <span class="k">exists</span> <span class="i">$output_hash</span>{<span class="q">&quot;-$required_arg&quot;</span>} <span class="s">)</span> <span class="s">{</span>
                    <span class="k">print</span> <span class="q">&quot;Warning: add '-$required_arg=&gt;...' to arguments\n&quot;</span><span class="sc">;</span>
                    <span class="k">push</span><span class="s">(</span> <span class="i">@missed</span><span class="cm">,</span> <span class="i">$required_arg</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="k">next</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$output_hash</span>{<span class="q">&quot;-$required_arg&quot;</span>} &amp;&amp; <span class="s">(</span> <span class="k">ref</span><span class="s">(</span> <span class="i">$output_hash</span>{<span class="q">&quot;-$required_arg&quot;</span>} <span class="s">)</span> <span class="k">eq</span> <span class="q">'ARRAY'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">unless</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$output_hash</span>{<span class="q">&quot;-$required_arg&quot;</span>} } <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                        <span class="k">print</span> <span class="q">&quot;Warning: '-$required_arg=&gt;...' points to an empty array\n&quot;</span><span class="sc">;</span>
                        <span class="k">push</span><span class="s">(</span> <span class="i">@missed</span><span class="cm">,</span> <span class="i">$required_arg</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="c">## generate error if there are any missed mandatory arguments ##</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@missed</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;** Error: Missing required argument(s): @missed\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$format_ref</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">@formats</span> &amp;&amp; <span class="i">@parameters</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$index</span> <span class="s">(</span> <span class="n">0</span> .. <span class="i">$#parameters</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$key</span>   = <span class="i">$parameters</span>[<span class="i">$index</span>]<span class="sc">;</span>
                <span class="k">my</span> <span class="i">$value</span> = <span class="i">$output_hash</span>{<span class="q">&quot;-$key&quot;</span>}<span class="sc">;</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$value</span> &amp;&amp; <span class="i">$formats</span>[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="i">$value</span> =~ <span class="q">/$formats[$index]/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;** Error: $key ($value) failed format check (should be $formats[$index])\n&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span><span class="i">@format_keys</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">@format_keys</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$format_required</span> = <span class="i">$format_ref</span>-&gt;{<span class="i">$key</span>}<span class="sc">;</span>
                <span class="k">my</span> <span class="i">$value</span>           = <span class="i">$output_hash</span>{<span class="q">&quot;-$key&quot;</span>}<span class="sc">;</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$value</span> &amp;&amp; <span class="i">$format_required</span> <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="i">$value</span> =~ <span class="q">/$format_required/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;** Error: $key ($value) failed format check (should be $format_required)\n&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">### Monitor Input, Defaults set, Parameters set ONLY IF auto-setting used ###</span>
    <span class="k">my</span> <span class="i">$input</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">@input_parameters</span><span class="s">)</span> <span class="s">{</span> <span class="i">$input</span>-&gt;{<span class="w">INPUT</span>}          = \<span class="i">@input_parameters</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">@set_Defaults</span><span class="s">)</span>     <span class="s">{</span> <span class="i">$input</span>-&gt;{<span class="w">set_Defaults</span>}   = \<span class="i">@set_Defaults</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">@set_Parameters</span><span class="s">)</span>   <span class="s">{</span> <span class="i">$input</span>-&gt;{<span class="w">set_Parameters</span>} = \<span class="i">@set_Parameters</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$stack</span> = <span class="k">join</span> <span class="q">&quot;&lt;br&gt;\n&quot;</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">Call_Stack</span><span class="s">(</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> }<span class="sc">;</span>
        <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;\n** Call Stack **&lt;br&gt;\n$stack&quot;</span><span class="sc">;</span>
        <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} .= <span class="q">&quot;\nArgs:\n&quot;</span> . <span class="i">Dumper</span><span class="s">(</span><span class="i">$args_ref</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$log_message</span>         .= <span class="i">$output_hash</span>{<span class="w">ERRORS</span>}<span class="sc">;</span>
        <span class="i">croak</span><span class="s">(</span> <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="k">if</span> <span class="s">(</span><span class="i">$fatal</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## fatal error - abort</span>
        <span class="i">Message</span><span class="s">(</span> <span class="i">$output_hash</span>{<span class="w">ERRORS</span>} <span class="s">)</span><span class="sc">;</span>              <span class="c">## only goes here if 'no_die' option chosen</span>
        <span class="k">return</span> <span class="i">%output_hash</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$log</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$username</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$username</span> = <span class="q">`whoami`</span><span class="sc">;</span>
            <span class="k">chomp</span> <span class="i">$username</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">&amp;log_usage</span><span class="s">(</span>
            -<span class="w">log</span>     <span class="cm">=&gt;</span> <span class="i">$log</span><span class="cm">,</span>
            -<span class="w">message</span> <span class="cm">=&gt;</span> <span class="i">$log_message</span><span class="cm">,</span>
            -<span class="w">user</span>    <span class="cm">=&gt;</span> <span class="i">$username</span><span class="cm">,</span>
            -<span class="w">data</span>    <span class="cm">=&gt;</span> \<span class="i">%output_hash</span><span class="cm">,</span>
            -<span class="w">object</span>  <span class="cm">=&gt;</span> <span class="i">$input</span><span class="cm">,</span>
            -<span class="w">include</span> <span class="cm">=&gt;</span> <span class="q">'source'</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">%output_hash</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################################################</span>
<span class="c"># Function: This function takes in an array of arrays, with each array of the same size.</span>
<span class="c">#           The arrays will be broken down into $size-sized arrays.</span>
<span class="c"># RETURN: An arrayref containing length of arrays/$size array references, each one containing</span>
<span class="c">#         a number of array references equal to the original number of arrays.</span>
<span class="c">###########################################################</span>
<a name="split_arrays-"></a><span class="k">sub </span><span class="m">split_arrays</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$array_of_arrays_ref</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$size</span>                = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@array_of_arrays</span>     = <span class="i">@</span>{<span class="i">$array_of_arrays_ref</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@done</span>                = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$counter</span>             = <span class="n">0</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$num_increments</span> = <span class="k">scalar</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$array_of_arrays</span>[<span class="n">0</span>] } <span class="s">)</span> / <span class="i">$size</span> + <span class="n">1</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="s">(</span> <span class="n">1</span> .. <span class="i">$num_increments</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@single_array</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="s">(</span> <span class="n">1</span> .. <span class="k">scalar</span><span class="s">(</span><span class="i">@array_of_arrays</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@single_array</span><span class="cm">,</span> <span class="s">[</span><span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">foreach</span> <span class="s">(</span> <span class="n">1</span> .. <span class="i">$size</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$arrayref</span> <span class="s">(</span><span class="i">@array_of_arrays</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$elem</span> = <span class="k">shift</span><span class="s">(</span> <span class="i">@</span>{<span class="i">$arrayref</span>} <span class="s">)</span><span class="sc">;</span>
                <span class="k">unless</span> <span class="s">(</span><span class="i">$elem</span><span class="s">)</span> <span class="s">{</span>
                    <span class="k">next</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$single_array</span>[<span class="i">$index</span>] }<span class="cm">,</span> <span class="i">$elem</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$index</span>++<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@done</span><span class="cm">,</span> \<span class="i">@single_array</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> \<span class="i">@done</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################################################</span>
<span class="c"># Function: This function will quote a comma-delimited string</span>
<span class="c">#           ie A01,A02,A03 will become 'A01','A02','A03'</span>
<span class="c"># Return: A string with each element quoted</span>
<span class="c">############################################################</span>
<a name="autoquote_string-"></a><span class="k">sub </span><span class="m">autoquote_string</span> <span class="s">{</span>
<span class="c">############################################################</span>
    <span class="k">my</span> <span class="i">$str</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># (Scalar) a comma-delimited string</span>
    <span class="i">$str</span> = <span class="k">join</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="k">map</span> <span class="s">{</span><span class="q">&quot;'$_'&quot;</span><span class="s">}</span> <span class="k">split</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$str</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$str</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################################################</span>
<span class="c"># Function: resolves a range of numbers into a full comma-delimited list</span>
<span class="c"># RETURN: the range of numbers in a full comma-delimited list</span>
<span class="c">###########################################################</span>
<a name="resolve_range-"></a><span class="k">sub </span><span class="m">resolve_range</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$range</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$range</span> =~ <span class="q">/(\d+)[-](\d+)/</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$2</span> &gt;= <span class="i">$1</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$numlist</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$1</span> .. <span class="i">$2</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$range</span> =~ <span class="q">s/$1[-]$2/$numlist/</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$range</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################################################</span>
<span class="c"># Function: resolves a full comma_delimited list into a range of numbers</span>
<span class="c"># RETURN: the range of numbers in range format (1-3,5,7-10, etc)</span>
<span class="c">###########################################################</span>
<a name="convert_to_range-"></a><span class="k">sub </span><span class="m">convert_to_range</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">$range</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@array</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$range</span><span class="sc">;</span>
    <span class="i">@array</span> = <span class="k">sort</span> <span class="s">{</span> <span class="i">$a</span> &lt;=&gt; <span class="i">$b</span> <span class="s">}</span> <span class="i">@array</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%rangehash</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$val</span> <span class="s">(</span><span class="i">@array</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$rangehash</span>{ <span class="i">$val</span> - <span class="n">1</span> } <span class="s">)</span> <span class="s">{</span>
            <span class="i">$rangehash</span>{<span class="i">$val</span>} = <span class="i">$rangehash</span>{ <span class="i">$val</span> - <span class="n">1</span> }<span class="sc">;</span>
            <span class="k">delete</span> <span class="i">$rangehash</span>{ <span class="i">$val</span> - <span class="n">1</span> }<span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$rangehash</span>{<span class="i">$val</span>} = <span class="i">$val</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">@complete_range</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="s">{</span> <span class="i">$a</span> &lt;=&gt; <span class="i">$b</span> <span class="s">}</span> <span class="k">keys</span> <span class="i">%rangehash</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$range_val</span> = <span class="i">$key</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> != <span class="i">$rangehash</span>{<span class="i">$key</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$range_val</span> = <span class="q">&quot;$rangehash{$key}-$key&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@complete_range</span><span class="cm">,</span> <span class="i">$range_val</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="k">join</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@complete_range</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################################################</span>
<span class="c"># Function: get the unix username of the user running the script</span>
<span class="c"># RETURN: the unix userid of the user</span>
<span class="c">############################################################</span>
<a name="get_username-"></a><span class="k">sub </span><span class="m">get_username</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$username</span> = <span class="i">&amp;RGTools::RGIO::try_system_command</span><span class="s">(</span><span class="q">&quot;whoami&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">chomp</span> <span class="i">$username</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$username</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############################</span>
<span class="c"># Subroutine: takes in two array references A, B, and does A - B (set difference</span>
<span class="c"># Return: arrayref of elements in A that are not in B</span>
<span class="c">############################</span>
<a name="set_difference-"></a><span class="k">sub </span><span class="m">set_difference</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$A</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># (Arrayref) first array</span>
    <span class="k">my</span> <span class="i">$B</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># (Arrayref) second array</span>

    <span class="k">my</span> <span class="i">%A_elements</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$A</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$A_elements</span>{<span class="i">$_</span>} = <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">foreach</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$B</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$A_elements</span>{<span class="i">$_</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$A_elements</span>{<span class="i">$_</span>}++<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">@difference</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%A_elements</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$A_elements</span>{<span class="i">$_</span>} == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@difference</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">#my @difference = grep { $A_elements{$_} == 1 } keys(%A_elements);</span>
    <span class="k">return</span> \<span class="i">@difference</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#######################</span>
<a name="set_operations-"></a><span class="k">sub </span><span class="m">set_operations</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$A</span>         = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$B</span>         = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@A</span>         = <span class="i">@</span>{<span class="i">$A</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@B</span>         = <span class="i">@</span>{<span class="i">$B</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$operation</span> = <span class="k">shift</span> || <span class="q">'intersect'</span><span class="sc">;</span>    <span class="c">## Union,Intersection</span>

    <span class="k">my</span> <span class="i">@union</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%union</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@isect</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%isect</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@diff</span>  = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%count</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$e</span> <span class="s">(</span> <span class="i">@A</span><span class="cm">,</span> <span class="i">@B</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$count</span>{<span class="i">$e</span>}++ <span class="s">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$e</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%count</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@union</span><span class="cm">,</span> <span class="i">$e</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$count</span>{<span class="i">$e</span>} == <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@isect</span><span class="cm">,</span> <span class="i">$e</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@diff</span><span class="cm">,</span> <span class="i">$e</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$operation</span> =~ <span class="q">/intersect/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> \<span class="i">@isect</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$operation</span> =~ <span class="q">/union/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> \<span class="i">@union</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$operation</span> =~ <span class="q">/diff/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> \<span class="i">@diff</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="k">return</span> <span class="n">0</span> <span class="s">}</span>
<span class="s">}</span>

<span class="c">###############################</span>
<span class="c"># Subroutine: takes in a string and removes leading and trailing whitespaces</span>
<span class="c"># Return: the string with the leading and trailing whitespaces removed</span>
<span class="c">############################</span>
<a name="chomp_edge_whitespace-"></a><span class="k">sub </span><span class="m">chomp_edge_whitespace</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$str</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># (Scalar) a string</span>

    <span class="i">$str</span> =~ <span class="q">s/^\s+//</span><span class="sc">;</span>
    <span class="i">$str</span> =~ <span class="q">s/\s+$//</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$str</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############################</span>
<span class="c"># Subroutine: takes in a string and removes trailing whitespaces</span>
<span class="c"># Return: the string with trailing whitespaces removed</span>
<span class="c">############################</span>
<a name="xchomp-"></a><span class="k">sub </span><span class="m">xchomp (\$)</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$str_ref</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># (Scalar) a string</span>
    <span class="i">$$str_ref</span> =~ <span class="q">s/\s+$//</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$</span>{<span class="i">$str_ref</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############################</span>
<span class="c"># Subroutine: takes in an array reference, and returns an array reference of that array with duplicates removed</span>
<span class="c"># Return: An array reference with elements identical to the input, but with duplicates removed</span>
<span class="c">############################</span>
<a name="unique_items-"></a><span class="k">sub </span><span class="m">unique_items</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$array</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="c">### algorithm from the perl cookbook</span>
    <span class="c">### page 102</span>
    <span class="k">my</span> <span class="i">%seen</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@unique</span> = <span class="k">grep</span> <span class="s">{</span> !<span class="i">$seen</span>{<span class="i">$_</span>}++ <span class="s">}</span> <span class="i">@$array</span><span class="sc">;</span>
    <span class="k">return</span> \<span class="i">@unique</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############################</span>
<span class="c">#</span>
<span class="c"># run Shell command (returns STD output)</span>
<span class="c">#</span>
<span class="c">############################</span>
<a name="try_system_command-"></a><span class="k">sub </span><span class="m">try_system_command</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'command,linefeed,remote'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$command</span>  = <span class="i">$args</span>{-<span class="w">command</span>}<span class="sc">;</span>                       <span class="c"># command to execute</span>
    <span class="k">my</span> <span class="i">$linefeed</span> = <span class="i">$args</span>{-<span class="w">linefeed</span>}<span class="sc">;</span>                      <span class="c"># linefeed command (optional) to separate output</span>
    <span class="k">my</span> <span class="i">$remote</span>   = <span class="i">$args</span>{-<span class="w">remote</span>}<span class="sc">;</span>                        <span class="c"># optional remote login host</span>
    <span class="k">my</span> <span class="i">$include</span>  = <span class="i">$args</span>{-<span class="w">include</span>} || <span class="q">'stdout,stderr'</span><span class="sc">;</span>    <span class="c"># include stderr in output by default</span>
    <span class="k">my</span> <span class="i">$verbose</span>  = <span class="i">$args</span>{-<span class="w">verbose</span>} || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$Report</span>   = <span class="i">$args</span>{-<span class="w">report</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$separate_errors</span> = <span class="n">1</span> <span class="k">if</span> <span class="k">wantarray</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>               <span class="c">## separate STDOUT, STDERR in output if array context</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$Report</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$Report</span><span class="i">-&gt;set_Detail</span><span class="s">(</span><span class="q">&quot;EXEC: $command&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$feedback</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$errors</span>   = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="i">$linefeed</span> ||= <span class="q">&quot;\n&quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$remote</span><span class="s">)</span> <span class="s">{</span> <span class="i">$command</span> = <span class="q">qq{rsh $remote $command}</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$pid</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$PROC</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$separate_errors</span> || <span class="i">$Report</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## STDOUT, STDERR</span>
        <span class="i">$pid</span> = <span class="k">open</span><span class="s">(</span> <span class="w">PROC</span><span class="cm">,</span> <span class="q">qq{($command | sed 's/^/STDOUT:/') 2&gt;&amp;1 |}</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$include</span> =~ <span class="q">/stderr/</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$include</span> =~ <span class="q">/stdout/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## STDOUT + STDERR</span>
        <span class="i">$pid</span> = <span class="k">open</span><span class="s">(</span> <span class="w">PROC</span><span class="cm">,</span> <span class="q">qq{$command 2&gt;&amp;1 |}</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$include</span> =~ <span class="q">/stderr/i</span> <span class="s">)</span> <span class="s">{</span>                                   <span class="c">## STDERR only</span>
        <span class="i">$pid</span> = <span class="k">open</span><span class="s">(</span> <span class="w">PROC</span><span class="cm">,</span> <span class="q">qq{$command 2&gt;&amp;1 1&gt;/dev/null |}</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>                                                              <span class="c">## STDOUT only</span>
        <span class="i">$pid</span> = <span class="k">open</span><span class="s">(</span> <span class="w">PROC</span><span class="cm">,</span> <span class="q">qq{$command |}</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">while</span> <span class="s">(</span><span class="q">&lt;PROC&gt;</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$line</span> = <span class="i">chomp_edge_whitespace</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$separate_errors</span> || <span class="i">$Report</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$line</span> .= <span class="i">$linefeed</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">s/^STDOUT://</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$feedback</span> .= <span class="i">$line</span><span class="sc">;</span>                                     <span class="c">## parse out STDOUT if applicable</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$errors</span> .= <span class="i">$line</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/$linefeed$/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$feedback</span> .= <span class="i">$line</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$feedback</span> .= <span class="i">$line</span> . <span class="i">$linefeed</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">close</span> <span class="w">PROC</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$Report</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$Report</span><span class="i">-&gt;set_Error</span><span class="s">(</span><span class="i">$errors</span><span class="s">)</span>    <span class="k">if</span> <span class="s">(</span><span class="i">$errors</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$Report</span><span class="i">-&gt;set_Detail</span><span class="s">(</span><span class="i">$feedback</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span><span class="i">$feedback</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$verbose</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;SHELL CMD: $command\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;$feedback\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;** Errors: **\n$errors\n&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$separate_errors</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$separate_errors</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="s">(</span> <span class="i">$feedback</span><span class="cm">,</span> <span class="i">$errors</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c">## return (STDOUT,STDERR)</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$feedback</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c">## return STDERR included in STDOUT.</span>
<span class="s">}</span>

<span class="c">#########################</span>
<span class="c">#</span>
<span class="c"># Retrieves date_time in 'YYYY-MM-DD HH:MM:SS' format</span>
<span class="c">#</span>
<span class="c"># parameter allows you to specify forward or back (-) any number of</span>
<span class="c"># seconds (s), minutes(m), hours(h) or days(d).</span>
<span class="c">#</span>
<span class="c">#  eg. date_time('-1d') retrieves the same time yesterday</span>
<span class="c">#</span>
<span class="c">##################</span>
<a name="date_time-"></a><span class="k">sub </span><span class="m">date_time</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span>
         \<span class="i">@_</span><span class="cm">,</span>
        -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="w">offset</span> <span class="cm">=&gt;</span> <span class="q">'^[+\-]?\d+\s?[smhdSMHDwWyY]'</span> <span class="s">}</span><span class="cm">,</span>
        -<span class="w">args</span>   <span class="cm">=&gt;</span> <span class="q">'offset'</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$another_time</span> = <span class="i">$args</span>{-<span class="w">offset</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c"># optional other time or +/- number of days</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$sec</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$mday</span><span class="cm">,</span> <span class="i">$mon</span><span class="cm">,</span> <span class="i">$year</span> <span class="s">)</span> = <span class="k">localtime</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$another_time</span> =~ <span class="q">/(\d+)(\s*w)/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$string</span> = <span class="i">$2</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$weeks</span>  = <span class="i">$1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$days</span>   = <span class="i">$weeks</span> * <span class="n">7</span><span class="sc">;</span>
        <span class="i">$another_time</span> =~ <span class="q">s/$weeks$string/$days d/</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$another_time</span> =~ <span class="q">/(\d+)(\s*y)/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$string</span> = <span class="i">$2</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$years</span>  = <span class="i">$1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$months</span> = <span class="i">$years</span> * <span class="n">12</span><span class="sc">;</span>
        <span class="i">$another_time</span> =~ <span class="q">s/$years$string/$months /</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$newtime</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$addon</span><span class="sc">;</span>
    <span class="c">## allow offset of months  ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$another_time</span> =~ <span class="q">/(-)?(\d+)\s*mo/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$plus</span>   = <span class="i">$1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$offset</span> = <span class="i">$2</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$plus</span> <span class="k">eq</span> <span class="q">'-'</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$offset</span> *= <span class="n">-1</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$mon</span> = <span class="i">$mon</span> + <span class="i">$offset</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span> <span class="i">$mon</span> &gt; <span class="n">12</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$mon</span> = <span class="i">$mon</span> - <span class="n">12</span><span class="sc">;</span> <span class="i">$year</span>++<span class="sc">;</span> <span class="s">}</span>
        <span class="k">while</span> <span class="s">(</span> <span class="i">$mon</span> &lt; <span class="n">0</span> <span class="s">)</span>  <span class="s">{</span> <span class="i">$mon</span> = <span class="i">$mon</span> + <span class="n">12</span><span class="sc">;</span> <span class="i">$year</span>--<span class="sc">;</span> <span class="s">}</span>
    <span class="s">}</span>
    <span class="c">############# if standard time units are specified... ###########</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$another_time</span> =~ <span class="q">/^[+\-]?(\d+)\s?([smhdSMHD])/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$adjust</span> = <span class="i">$1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$units</span>  = <span class="i">$2</span><span class="sc">;</span>
        <span class="k">if</span>    <span class="s">(</span> <span class="i">$units</span> =~ <span class="q">/s/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$addon</span> = <span class="i">$adjust</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$units</span> =~ <span class="q">/m/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$addon</span> = <span class="i">$adjust</span> * <span class="n">60</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$units</span> =~ <span class="q">/h/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$addon</span> = <span class="i">$adjust</span> * <span class="n">60</span> * <span class="n">60</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">else</span>                     <span class="s">{</span> <span class="i">$addon</span> = <span class="i">$adjust</span> * <span class="n">60</span> * <span class="n">60</span> * <span class="n">24</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$another_time</span> =~ <span class="q">/^\-/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$addon</span> *= <span class="n">-1</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$newtime</span> = <span class="k">time</span> + <span class="i">$addon</span><span class="sc">;</span>
        <span class="s">(</span> <span class="i">$sec</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$mday</span><span class="cm">,</span> <span class="i">$mon</span><span class="cm">,</span> <span class="i">$year</span> <span class="s">)</span> = <span class="k">localtime</span><span class="s">(</span><span class="i">$newtime</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">############### otherwise convert from stat time...################</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$another_time</span> =~ <span class="q">/^\d+$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$sec</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$mday</span><span class="cm">,</span> <span class="i">$mon</span><span class="cm">,</span> <span class="i">$year</span> <span class="s">)</span> = <span class="k">localtime</span><span class="s">(</span><span class="i">$another_time</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># &lt;CONSTRUCTION&gt; remove this block after format option is added to filter_input</span>
    <span class="c"># Check for the correct delay time format</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$another_time</span><span class="s">)</span> <span class="s">{</span>    <span class="c">## defined delay time, but not recognized (?)</span>
        <span class="k">print</span> <span class="q">&quot;&lt;h3&gt; error: invalid delay ($another_time)&lt;/h3&gt;&quot;</span><span class="sc">;</span>
        <span class="i">Call_Stack</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
        <span class="c">############### otherwise supply current local time... ############</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="c">## use default localtime settings ##</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$nowtime</span> = <span class="k">sprintf</span> <span class="q">&quot;%02d:%02d:%02d&quot;</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$sec</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$nowdate</span> = <span class="k">sprintf</span> <span class="q">&quot;%04d-%02d-%02d&quot;</span><span class="cm">,</span> <span class="i">$year</span> + <span class="n">1900</span><span class="cm">,</span> <span class="i">$mon</span> + <span class="n">1</span><span class="cm">,</span> <span class="i">$mday</span><span class="sc">;</span>
    <span class="i">$nowdate</span> =~ <span class="q">s/ /0/g</span><span class="sc">;</span>
    <span class="i">$nowtime</span> =~ <span class="q">s/ /0/g</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$date_time</span> = <span class="i">$nowdate</span> . <span class="q">&quot; &quot;</span> . <span class="i">$nowtime</span><span class="sc">;</span>

    <span class="c">#    print &quot;TIME: $date_time&quot;;</span>
    <span class="k">return</span> <span class="s">(</span><span class="q">&quot;$date_time&quot;</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################</span>
<a name="timestamp-"></a><span class="k">sub </span><span class="m">timestamp</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">$time</span> = <span class="k">join</span> <span class="q">''</span><span class="cm">,</span> <span class="i">date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$time</span> =~ <span class="q">s/[\:\-\s]//g</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$time</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################</span>
<a name="datestamp-"></a><span class="k">sub </span><span class="m">datestamp</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$date</span><span class="s">)</span> = <span class="k">split</span> <span class="q">' '</span><span class="cm">,</span> <span class="i">date_time</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$date</span> =~ <span class="q">s/[\:\-\s]//g</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$date</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<span class="c">#</span>
<span class="c"># Returns DateTime (parameter allows you to specify +/- N days)</span>
<span class="c">#</span>
<span class="c"># Format:  YYYY-MM-DD 00:00:00</span>
<span class="c">#</span>
<a name="now-"></a><span class="k">sub </span><span class="m">now</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$offset_days</span> = <span class="k">shift</span> || <span class="n">0</span><span class="sc">;</span>    <span class="c"># +/- number of days eg. now(-1) for yesterday</span>
    <span class="k">my</span> <span class="i">$today</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$nowtime</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$offset_days</span><span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$today</span><span class="cm">,</span> <span class="i">$nowtime</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">' '</span><span class="cm">,</span> <span class="i">&amp;date_time</span><span class="s">(</span> -<span class="w">offset</span> <span class="cm">=&gt;</span> <span class="q">&quot;$offset_days&quot;</span> . <span class="q">&quot;d&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="s">(</span> <span class="i">$today</span><span class="cm">,</span> <span class="i">$nowtime</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">' '</span><span class="cm">,</span> <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">return</span> <span class="q">&quot;$today $nowtime&quot;</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<span class="c">#</span>
<span class="c"># Returns Date (parameter allows you to specify +/- N days)</span>
<span class="c">#</span>
<span class="c"># format:  YYYY-MM-DD</span>
<span class="c">#</span>
<a name="today-"></a><span class="k">sub </span><span class="m">today</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$offset_days</span> = <span class="k">shift</span> || <span class="n">0</span><span class="sc">;</span>    <span class="c"># (eg &amp;today(-1) for yesterday)</span>
    <span class="k">my</span> <span class="i">$today</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$offset_days</span><span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span><span class="i">$today</span><span class="s">)</span> = <span class="k">split</span> <span class="q">' '</span><span class="cm">,</span> <span class="i">&amp;date_time</span><span class="s">(</span> -<span class="w">offset</span> <span class="cm">=&gt;</span> <span class="q">&quot;$offset_days&quot;</span> . <span class="q">&quot;d&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="s">(</span><span class="i">$today</span><span class="s">)</span> = <span class="k">split</span> <span class="q">' '</span><span class="cm">,</span> <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$today</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################</span>
<a name="week_end_date-"></a><span class="k">sub </span><span class="m">week_end_date</span> <span class="s">{</span>
<span class="c">######################</span>

    <span class="k">my</span> <span class="i">$weeks_ago</span>  = <span class="k">shift</span><span class="sc">;</span>    <span class="c">## specify weeks ago prior to current week (starting Mon)</span>
    <span class="k">my</span> <span class="i">$week_start</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c">## start day (Monday = 1, Tues = 2 ....</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$week_start</span> =~ <span class="q">/^(\d+)$/</span> &amp;&amp; <span class="i">$week_start</span> &lt; <span class="n">8</span> &amp;&amp; <span class="i">$week_start</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span> <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$week_start</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Invalid week starting point (should be 1-7)&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="i">$week_start</span> = <span class="n">1</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$past</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$weeks_ago</span><span class="s">)</span> <span class="s">{</span> <span class="i">$past</span> = <span class="i">$weeks_ago</span> * <span class="n">7</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$year</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$month</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$day</span><span class="sc">;</span>
    <span class="k">if</span>   <span class="s">(</span><span class="i">$past</span><span class="s">)</span> <span class="s">{</span> <span class="s">(</span> <span class="i">$year</span><span class="cm">,</span> <span class="i">$month</span><span class="cm">,</span> <span class="i">$day</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">'-'</span><span class="cm">,</span> <span class="i">&amp;today</span><span class="s">(</span><span class="q">&quot;-$past&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">else</span>         <span class="s">{</span> <span class="s">(</span> <span class="i">$year</span><span class="cm">,</span> <span class="i">$month</span><span class="cm">,</span> <span class="i">$day</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">'-'</span><span class="cm">,</span> <span class="i">&amp;today</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$days_ago</span> = <span class="i">$past</span><span class="sc">;</span>
    <span class="k">require</span> <span class="w">Date::Calc</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">Date::Calc::Day_of_Week</span><span class="s">(</span> <span class="i">$year</span><span class="cm">,</span> <span class="i">$month</span><span class="cm">,</span> <span class="i">$day</span> <span class="s">)</span> != <span class="i">$week_start</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$days_ago</span>++<span class="sc">;</span>
        <span class="s">(</span> <span class="i">$year</span><span class="cm">,</span> <span class="i">$month</span><span class="cm">,</span> <span class="i">$day</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">'-'</span><span class="cm">,</span> <span class="i">&amp;today</span><span class="s">(</span><span class="q">&quot;-$days_ago&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$day</span> &lt; <span class="n">10</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$day</span> = <span class="k">sprintf</span> <span class="q">&quot;%2d&quot;</span><span class="cm">,</span> <span class="i">$day</span><span class="sc">;</span>
        <span class="i">$day</span> =~ <span class="q">s/ /0/</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$week_end</span> = <span class="q">&quot;$year-$month-$day&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$week_end</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################</span>
<span class="c">#</span>
<span class="c"># Generates a message</span>
<span class="c">#</span>
<span class="c">###########</span>
<a name="Message-"></a><span class="k">sub </span><span class="m">Message</span> <span class="s">{</span>
<span class="c">###########</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'title,message,type,colour'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$title</span>   = <span class="i">$args</span>{-<span class="w">title</span>}   || <span class="q">''</span><span class="sc">;</span>    <span class="c"># message title</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="i">$args</span>{-<span class="w">message</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c"># content of message</span>
    <span class="k">my</span> <span class="i">$type</span>   = <span class="i">$args</span>{-<span class="w">type</span>}<span class="sc">;</span>              <span class="c"># type (eg. 'html' or 'text' or 'hidden') (default = html or global $style variable)</span>
    <span class="k">my</span> <span class="i">$colour</span> = <span class="i">$args</span>{-<span class="w">colour</span>}<span class="sc">;</span>            <span class="c"># colour of message for html format (optional)</span>
    <span class="k">my</span> <span class="i">$log</span>    = <span class="i">$args</span>{ -<span class="k">log</span> }<span class="sc">;</span>             <span class="c"># file to log messages into</span>

    <span class="k">my</span> <span class="i">$size</span>     = <span class="i">$args</span>{-<span class="w">size</span>}     || <span class="q">'-2'</span><span class="sc">;</span>                  <span class="c"># size of message...</span>
    <span class="k">my</span> <span class="i">$brief</span>    = <span class="i">$args</span>{-<span class="w">brief</span>}    || <span class="i">$scanner_mode</span> || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$no_print</span> = <span class="i">$args</span>{-<span class="w">no_print</span>} || <span class="i">$args</span>{-<span class="w">return_html</span>}<span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$type</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$0</span> =~ <span class="q">/ajax/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$type</span> = <span class="q">'ajax'</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$0</span> =~ <span class="q">/Web_Service/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$type</span> = <span class="q">'text - web_service'</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$0</span> =~ <span class="q">/\.html$/</span> || <span class="i">$0</span> =~ <span class="q">/\/cgi-bin\//</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$type</span> = <span class="q">'html'</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$0</span> =~ <span class="q">/\.xml$/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$type</span> = <span class="q">'xml'</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$type</span> = <span class="q">'text'</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$output</span> = <span class="q">''</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$colour</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$title</span> =~ <span class="q">/^error\b/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$colour</span>  = <span class="i">$error_colour</span><span class="sc">;</span>
            <span class="i">$colour2</span> = <span class="i">$error_colour2</span><span class="sc">;</span>
            <span class="i">$size</span>    = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$title</span> =~ <span class="q">/^warning\b/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$colour</span>  = <span class="i">$warning_colour</span><span class="sc">;</span>
            <span class="i">$colour2</span> = <span class="i">$error_colour2</span><span class="sc">;</span>
            <span class="i">$size</span>    = <span class="n">-1</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span> <span class="i">$colour</span> = <span class="i">$note_colour</span><span class="sc">;</span> <span class="i">$colour2</span> = <span class="i">$colour</span><span class="sc">;</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/^t/i</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">### print in simple text format</span>
        <span class="i">$output</span> = <span class="q">&quot;$title $message\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">'ajax'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$output</span> = <span class="i">$title</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/hidden/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">### no printout if hidden...</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$brief</span><span class="s">)</span> <span class="s">{</span>           <span class="c">### print simple html for scanners...</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$title</span> =~ <span class="q">/^(error|warning)\b/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$output</span> = <span class="q">&quot;&lt;B&gt;&lt;FONT COLOR='black' style='background-color:$colour'&gt;&amp;nbsp;$title $message&lt;/FONT&gt;&lt;/B&gt;&lt;BR&gt;&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$output</span> = <span class="q">&quot;&lt;FONT COLOR='black' style='background-color:$colour'&gt;&amp;nbsp;$title $message&lt;/FONT&gt;&lt;BR&gt;&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/html/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> =~ <span class="q">s /\n/&lt;BR&gt;/g</span><span class="sc">;</span>    <span class="c">## replace linefeeds with br</span>
        <span class="i">$output</span> .= <span class="q">&quot;\n&lt;TABLE cellpadding =3 cellspacing=0&gt;&lt;TR&gt;&lt;TD bgcolor=$colour align='left'&gt;&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$size</span><span class="s">)</span> <span class="s">{</span> <span class="i">$output</span> .= <span class="q">&quot;\n&lt;Font size=$size&gt; &quot;</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$output</span> .= <span class="q">&quot;&lt;B&gt;$title&lt;/B&gt;&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$size</span><span class="s">)</span> <span class="s">{</span> <span class="i">$output</span> .= <span class="q">&quot;&lt;/Font&gt;&quot;</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$output</span> .= <span class="q">&quot;&lt;/TD&gt;&lt;TD bgcolor=$colour2 align = left&gt;&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$size</span><span class="s">)</span> <span class="s">{</span> <span class="i">$output</span> .= <span class="q">&quot;\n&lt;Font size=$size&gt; &quot;</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$output</span> .= <span class="q">&quot; $message&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$size</span><span class="s">)</span> <span class="s">{</span> <span class="i">$output</span> .= <span class="q">&quot;&lt;/Font&gt;&quot;</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$output</span> .= <span class="q">&quot;&lt;/TD&gt;&lt;/TR&gt;&lt;/TABLE&gt;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/xml/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$output</span> .= <span class="q">&quot;&lt;message&gt;$title $message&lt;/message&gt;\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="c">############ Custom Insertion (append log files ##################</span>

    <span class="k">my</span> <span class="i">$prefix</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/hidden/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$prefix</span> = <span class="q">&quot;(H):&quot;</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c">### indicate that this message was hidden</span>

    <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$title</span> =~ <span class="q">/^Warning\b/i</span> <span class="s">)</span> || <span class="s">(</span> <span class="i">$message</span> =~ <span class="q">/^Warning\b/i</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$prefix</span> = <span class="q">&quot;** WARNING **&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$title</span> =~ <span class="q">/^Error\b/i</span> <span class="s">)</span> || <span class="s">(</span> <span class="i">$message</span> =~ <span class="q">/^Error\b/i</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># Call_Stack();</span>
        <span class="i">$prefix</span> = <span class="q">&quot;***** ERROR *****&quot;</span><span class="sc">;</span>

        <span class="c">#	unless ($scanner_mode || $type=~/text/) { &amp;Window_Alert(&quot;$title $message&quot;); }</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="i">$prefix</span> = <span class="q">&quot;* Message *&quot;</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$session_id</span><span class="sc">;</span>

    <span class="c">### &lt;CONSTRUCTION&gt; change so that an optional log file is supplied which is appended with message ##</span>
    <span class="k">my</span> <span class="i">$session_dir</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$Sess</span> &amp;&amp; <span class="k">defined</span> <span class="i">$Sess</span>-&gt;{<span class="w">session_id</span>} &amp;&amp; <span class="k">defined</span> <span class="i">$Sess</span>-&gt;{<span class="w">session_dir</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$session_id</span>  = <span class="i">$Sess</span>-&gt;{<span class="w">session_id</span>}<span class="sc">;</span>
        <span class="i">$session_dir</span> = <span class="i">$Sess</span>-&gt;{<span class="w">session_dir</span>}<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$SESSION</span><span class="sc">;</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">SESSION</span><span class="cm">,</span> <span class="q">&quot;&gt;&gt;$session_dir/$session_id.sess&quot;</span> <span class="s">)</span> <span class="k">or</span> <span class="k">die</span><span class="s">(</span><span class="q">'Cannot save session info'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">SESSION</span> <span class="q">&quot;$prefix $title - $message\n&quot;</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span><span class="w">SESSION</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">############ End Custom Insertion (append log files ##################</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$log</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$LOG</span><span class="sc">;</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">LOG</span><span class="cm">,</span> <span class="q">&quot;&gt;&gt;$log&quot;</span> <span class="s">)</span> <span class="k">or</span> <span class="k">die</span><span class="s">(</span><span class="q">'Cannot append log file: $log.'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">LOG</span> <span class="q">&quot;$prefix $title - $message\n&quot;</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span><span class="w">LOG</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$title</span> =~ <span class="q">/^Warning/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'Ignore Warning'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span><span class="k">return</span><span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="c">## generate button prompting user to continue or cancel ##</span>
            <span class="c">## (need to freeze current parameters, and reload upon request) ##</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$no_print</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$output</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/web_service/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$output</span> =~ <span class="q">s/\n/\:  /g</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## linefeeds break Web Service output ...</span>
        <span class="k">print</span> <span class="i">$output</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###########</span>
<a name="HTML_Comment-"></a><span class="k">sub </span><span class="m">HTML_Comment</span> <span class="s">{</span>
<span class="c">###########</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>    = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format</span>  = <span class="i">$args</span>{<span class="q">'-format'</span>} || <span class="q">'html'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$prefix</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$suffix</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/html/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$prefix</span> = <span class="q">&quot;\n&lt;i&gt;&lt;font size=-1&gt;&quot;</span><span class="sc">;</span>
        <span class="i">$suffix</span> = <span class="q">&quot;&lt;/i&gt;&lt;/font&gt;\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$prefix</span> . <span class="i">$message</span> . <span class="i">$suffix</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################</span>
<span class="c">#</span>
<span class="c"># Generates a message only if in 'test mode'</span>
<span class="c">#</span>
<a name="Test_Message-"></a><span class="k">sub </span><span class="m">Test_Message</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$message</span>       = <span class="k">shift</span><span class="sc">;</span>         <span class="c"># message</span>
    <span class="k">my</span> <span class="i">$test_mode</span>     = <span class="k">shift</span> || <span class="n">0</span><span class="sc">;</span>    <span class="c"># test mode</span>
    <span class="k">my</span> <span class="i">$message_level</span> = <span class="k">shift</span> || <span class="n">0</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$test_mode</span> &gt; <span class="i">$message_level</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">$message</span> . <span class="q">&quot;&lt;br&gt;\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###################</span>
<span class="c">#</span>
<span class="c"># outputs Note to screen (like Message without title)</span>
<span class="c">#</span>
<a name="Note-"></a><span class="k">sub </span><span class="m">Note</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c">## message content</span>
    <span class="k">my</span> <span class="i">$type</span>    = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># type (defaults to $style or 'text')</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$style</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$type</span> ||= <span class="i">$style</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/^h/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;&lt;TABLE cellpadding =3&gt;&lt;TR&gt;&lt;TD bgcolor = $colour&gt;&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;&lt;B&gt;Note&lt;/B&gt; &lt;/TD&gt;&lt;TD bgcolor = $colour&gt;&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$message</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;&lt;/TD&gt;&lt;/TR&gt;&lt;/TABLE&gt;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;Note  $message\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<span class="c">#</span>
<span class="c"># Retrieves line from multi-line string that contains given search string</span>
<span class="c">#</span>
<a name="get_line_with-"></a><span class="k">sub </span><span class="m">get_line_with</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$string</span>   = <span class="k">shift</span><span class="sc">;</span>            <span class="c"># multi-line string</span>
    <span class="k">my</span> <span class="i">$search</span>   = <span class="k">shift</span><span class="sc">;</span>            <span class="c"># search string</span>
    <span class="k">my</span> <span class="i">$linefeed</span> = <span class="k">shift</span> || <span class="q">'\n'</span><span class="sc">;</span>    <span class="c"># linefeed separator</span>

    <span class="k">my</span> <span class="i">@lines</span> = <span class="k">split</span><span class="s">(</span> <span class="i">$linefeed</span><span class="cm">,</span> <span class="i">$string</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$return_string</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$line</span> <span class="s">(</span><span class="i">@lines</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/$search/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$return_string</span> .= <span class="i">$line</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$return_string</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<a name="list_contains-"></a><span class="k">sub </span><span class="m">list_contains</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="c">#</span>
    <span class="c"># Returns flag indicating whether one string is an element in a delimited string</span>
    <span class="c"># (ie does the string: &quot;abcd,gef,hij,klm&quot; contain the string &quot;hij&quot; ?);</span>
    <span class="c">#</span>
    <span class="c"># (Removes spaces first) - short string should not contain spaces.</span>
    <span class="c">#</span>
    <span class="c"># Returns 0 if not found.</span>
    <span class="c">#(returns index number of string if found (first element returns '1')</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$longstring</span>  = <span class="k">shift</span><span class="sc">;</span>            <span class="c">#</span>
    <span class="k">my</span> <span class="i">$shortstring</span> = <span class="k">shift</span><span class="sc">;</span>            <span class="c"># search string</span>
    <span class="k">my</span> <span class="i">$separators</span>  = <span class="k">shift</span> || <span class="q">&quot;\,&quot;</span><span class="sc">;</span>    <span class="c"># delimiter character (default = ',')</span>

    <span class="i">$longstring</span> =~ <span class="q">s/ //g</span><span class="sc">;</span>              <span class="c">#remove spaces.</span>

    <span class="k">my</span> <span class="i">$found</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$count</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$element</span> <span class="s">(</span> <span class="k">split</span> <span class="q">/$separators/</span><span class="cm">,</span> <span class="i">$longstring</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$element</span> <span class="k">eq</span> <span class="i">$shortstring</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$count</span>++<span class="sc">;</span> <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$count</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">######################</span>
<a name="adjust_list-"></a><span class="k">sub </span><span class="m">adjust_list</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="c">#</span>
    <span class="c"># Note unique lists may scramble order...</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$array</span>   = <span class="k">shift</span><span class="sc">;</span>    <span class="c">## input array</span>
    <span class="k">my</span> <span class="i">@options</span> = <span class="i">@_</span><span class="sc">;</span>       <span class="c">## array of options - just supply text (eg. adjust_list(\@array,'unique','rev');)</span>

    <span class="k">my</span> <span class="i">$unique</span>   = <span class="k">grep</span> <span class="q">/uni/i</span><span class="cm">,</span>      <span class="i">@options</span><span class="sc">;</span>    <span class="c">## unique list</span>
    <span class="k">my</span> <span class="i">$maintain</span> = <span class="k">grep</span> <span class="q">/maintain/i</span><span class="cm">,</span> <span class="i">@options</span><span class="sc">;</span>    <span class="c">## maintain order</span>
    <span class="k">my</span> <span class="i">$sort</span>     = <span class="k">grep</span> <span class="q">/^sort/</span><span class="cm">,</span>     <span class="i">@options</span><span class="sc">;</span>    <span class="c">## sort</span>
    <span class="k">my</span> <span class="i">$reverse</span>  = <span class="k">grep</span> <span class="q">/^rev/</span><span class="cm">,</span>      <span class="i">@options</span><span class="sc">;</span>    <span class="c">## reverse sort</span>

    <span class="k">my</span> <span class="i">@new_list</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$unique</span> &amp;&amp; <span class="i">$maintain</span> <span class="s">)</span> <span class="s">{</span>                 <span class="c">## generate UNIQUE list but MAINTAIN current order.</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$item</span> <span class="s">(</span><span class="i">@$array</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$item$/</span><span class="cm">,</span> <span class="i">@new_list</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@new_list</span><span class="cm">,</span> <span class="i">$item</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$unique</span><span class="s">)</span> <span class="s">{</span>                             <span class="c">## generate UNIQUE list (order unimportant)</span>
        <span class="k">my</span> <span class="i">%unique_list</span><span class="sc">;</span>
        <span class="k">map</span> <span class="s">{</span> <span class="i">$unique_list</span>{<span class="i">$_</span>} = <span class="n">1</span> <span class="s">}</span> <span class="i">@$array</span><span class="sc">;</span>
        <span class="i">@new_list</span> = <span class="k">keys</span> <span class="i">%unique_list</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">@new_list</span> = <span class="i">@$array</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#    if ($reverse) { return rnatsort @new_list; }  ## Sorted</span>
    <span class="c">#    elsif ($sort) { return natsort @new_list; }  ## Reverse sorted</span>
    <span class="c">#    else { return @new_list; }                   ## unsorted...</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$reverse</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">sort</span> <span class="s">{</span> <span class="i">$b</span> &lt;=&gt; <span class="i">$a</span> <span class="s">}</span> <span class="i">@new_list</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c">## Sorted</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$sort</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">sort</span> <span class="s">{</span> <span class="i">$a</span> &lt;=&gt; <span class="i">$b</span> <span class="s">}</span> <span class="i">@new_list</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c">## Reverse sorted</span>
    <span class="k">else</span> <span class="s">{</span> <span class="k">return</span> <span class="i">@new_list</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## unsorted...</span>
<span class="s">}</span>

<span class="c">#########################</span>
<a name="array_containing-"></a><span class="k">sub </span><span class="m">array_containing</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="c">#</span>
    <span class="c"># Returns an array containing only those elements of original array matching expression</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$original_array</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$pattern</span> = <span class="k">shift</span> || <span class="q">&quot;,&quot;</span><span class="sc">;</span>    <span class="c"># delimiter character (default = ',')</span>

    <span class="k">my</span> <span class="i">@sub_array</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$element</span> <span class="s">(</span><span class="i">@$original_array</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$element</span> =~ <span class="q">/$pattern/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@sub_array</span><span class="cm">,</span> <span class="i">$element</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@sub_array</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<a name="toggle_colour-"></a><span class="k">sub </span><span class="m">toggle_colour</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="c">#</span>
    <span class="c"># this returns the 'other' colour when given 1</span>
    <span class="c"># (repeated calls of $colour=toggle_colour($colour) yields colour toggling)</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$colour</span>  = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># input colour (normally = line_colour1 or line_colour2)</span>
    <span class="k">my</span> <span class="i">$colour1</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$colour2</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$colour1</span> ||= <span class="i">$line_colour1</span><span class="sc">;</span>
    <span class="i">$colour2</span> ||= <span class="i">$line_colour2</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="q">qq{$colour}</span> <span class="k">eq</span> <span class="q">qq{$colour1}</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$colour</span> = <span class="i">$colour2</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$colour</span> = <span class="i">$colour1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$colour</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<a name="dim_colour-"></a><span class="k">sub </span><span class="m">dim_colour</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="c">#</span>
    <span class="c"># Returns 2nd colour if value is zero...(used to dim cells if no value)</span>
    <span class="c"># (eg. $dim_colour($value,$bright,$dim) returns $bright if $value &gt; 0</span>
    <span class="c">#</span>

    <span class="k">my</span> <span class="i">$value</span>       = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># value to test</span>
    <span class="k">my</span> <span class="i">$good_colour</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># colour to return if value &gt; 0</span>
    <span class="k">my</span> <span class="i">$dim_colour</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="sc">;</span>                           <span class="c"># colour to return if value = 0</span>

    <span class="k">if</span>   <span class="s">(</span><span class="i">$value</span><span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$good_colour</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">else</span>          <span class="s">{</span> <span class="k">return</span> <span class="i">$dim_colour</span><span class="sc">;</span> <span class="s">}</span>
<span class="s">}</span>

<span class="c">###########################</span>
<a name="show_parameters-"></a><span class="k">sub </span><span class="m">show_parameters</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="c">#</span>
    <span class="c"># View input parameters to cgi script</span>
    <span class="c">#</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$name</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$value</span> = <span class="i">param</span><span class="s">(</span><span class="i">$name</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Input: $name = &quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$values</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">param</span><span class="s">(</span><span class="i">$name</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;($values)&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################</span>
<a name="Link_To-"></a><span class="k">sub </span><span class="m">Link_To</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="c">#</span>
    <span class="c"># Link label to href...</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'link_url,label,param,colour,window,script,tooltip,style,method,form_name'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#read in options as arguments</span>
    <span class="k">my</span> <span class="i">$link_url</span>     = <span class="i">$args</span>{-<span class="w">link_url</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$label</span>        = <span class="i">$args</span>{-<span class="w">label</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$addons</span>       = <span class="i">$args</span>{-<span class="w">param</span>}<span class="sc">;</span>                <span class="c">### add parameters to link</span>
    <span class="k">my</span> <span class="i">$colour</span>       = <span class="i">$args</span>{-<span class="w">colour</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hover_colour</span> = <span class="i">$args</span>{-<span class="w">hover_colour</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_window</span>   = <span class="i">$args</span>{-<span class="w">window</span>}<span class="sc">;</span>               <span class="c">## = ['newWinName','options...']</span>
    <span class="k">my</span> <span class="i">$options</span>      = <span class="i">$args</span>{-<span class="w">window_options</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$alt_script</span>   = <span class="i">$args</span>{-<span class="w">script</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tool_tip</span>     = <span class="i">$args</span>{-<span class="w">tooltip</span>}<span class="sc">;</span>              <span class="c">### Optional tool tip. If provided then it will override the default tooltips. If provide and value is '', then no tooltip will be displayed.</span>
    <span class="k">my</span> <span class="i">$style</span>        = <span class="i">$args</span>{-<span class="w">style</span>}<span class="sc">;</span>                <span class="c">## in-line style of the link.</span>
    <span class="k">my</span> <span class="i">$method</span>       = <span class="i">$args</span>{-<span class="w">method</span>} || <span class="q">&quot;GET&quot;</span><span class="sc">;</span>      <span class="c">## method of sending data - POST or GET</span>
    <span class="k">my</span> <span class="i">$alt</span>          = <span class="i">$args</span>{-<span class="w">alt</span>}<span class="sc">;</span>                  <span class="c">## alt script for A Href</span>
    <span class="k">my</span> <span class="i">$formname</span>     = <span class="i">$args</span>{-<span class="w">form_name</span>}<span class="sc">;</span>            <span class="c">## Form name the link exists in. Relevant only for POST method</span>

    <span class="c">#    my $font_size = &quot;size='$args{-font_size}'&quot; if ($args{-font_size});</span>
    <span class="k">my</span> <span class="i">$uline</span>
        = <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">ul</span>}
        ? <span class="i">$args</span>{-<span class="w">ul</span>}
        <span class="co">:</span> <span class="n">1</span><span class="sc">;</span>                                         <span class="c">## allow setting of underline flag off or on (default to on)</span>
    <span class="k">my</span> <span class="i">$mouseover</span> = <span class="i">$args</span>{-<span class="w">mouseover</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$mouseout</span>  = <span class="i">$args</span>{-<span class="w">mouseout</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$truncate</span>  = <span class="i">$args</span>{<span class="q">'-truncate'</span>}<span class="sc">;</span>              <span class="c">## truncate label (appends ...) - shows full label as tooltip unless tooltip already provided.</span>
    <span class="k">my</span> <span class="i">$tip_style</span> = <span class="i">$args</span>{-<span class="w">tip_style</span>}<span class="sc">;</span>

    <span class="k">if</span>   <span class="s">(</span> <span class="i">$link_url</span> =~ <span class="q">/\?/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$addons</span> =~ <span class="q">s/^\?/\&amp;/</span> <span class="s">}</span>
    <span class="k">else</span>                       <span class="s">{</span> <span class="i">$addons</span> =~ <span class="q">s/^\&amp;/\?/</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$TT_width</span><span class="sc">;</span>

    <span class="i">$label</span> =~ <span class="q">s /&lt;BR&gt;/\n/ig</span><span class="sc">;</span>                         <span class="c">## convert break tags to allow ...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$truncate</span> &amp;&amp; <span class="i">$label</span> !~ <span class="q">/&lt;.*&gt;/</span> <span class="s">)</span> <span class="s">{</span>           <span class="c">## do not truncate if it contains tags (more complicated)</span>
        <span class="i">$TT_width</span> = <span class="q">'50em'</span><span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$tool_tip</span><span class="s">)</span> <span class="s">{</span> <span class="i">$tool_tip</span> = <span class="i">$label</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$label</span> = <span class="i">&amp;truncate_string</span><span class="s">(</span> <span class="i">$label</span><span class="cm">,</span> <span class="i">$truncate</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$label</span> =~ <span class="q">s /\n/&lt;br&gt;/g</span><span class="sc">;</span>                          <span class="c">## replace break tags</span>

    <span class="c">## add style elements to link object as required ##</span>
    <span class="i">$style</span> .= <span class="q">&quot; text-decoration:none; &quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="i">$uline</span> || <span class="s">(</span> <span class="i">$uline</span> =~ <span class="q">/(no|false)/</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## remove underline effect</span>
    <span class="i">$style</span> .= <span class="q">&quot; color:$colour; &quot;</span> <span class="k">if</span> <span class="i">$colour</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$style</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$style</span> = <span class="q">&quot; style=\&quot;$style\&quot;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$style</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">##</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$tool_tip</span><span class="s">)</span> <span class="s">{</span>                                                                 <span class="c">#</span>
        <span class="i">$mouseover</span> .= <span class="q">&quot; this.style.color='$hover_colour';&quot;</span> <span class="k">if</span> <span class="i">$hover_colour</span><span class="sc">;</span>
        <span class="i">$mouseout</span>  .= <span class="q">&quot; this.style.color='$colour';&quot;</span>       <span class="k">if</span> <span class="i">$colour</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$mouseover</span> &amp;&amp; !<span class="i">$tool_tip</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$mouseover</span> = <span class="q">&quot;onMouseOver=\&quot;$mouseover\&quot;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$mouseover</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$mouseout</span> &amp;&amp; !<span class="i">$tool_tip</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$mouseout</span> = <span class="q">&quot;onMouSeOut=\&quot;$mouseout\&quot;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$mouseout</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$in_form</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$formname</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$in_form</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$wname</span> = <span class="i">RGTools::RGIO::Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$new_window</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$addons</span> =~ <span class="q">/\s/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$addons</span> = <span class="i">URI::Escape::uri_unescape</span><span class="s">(</span><span class="i">$addons</span><span class="s">)</span> <span class="s">}</span>
    <span class="i">$addons</span> =~ <span class="q">s /\s+/\+/g</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$link_url</span> =~ <span class="q">/\s/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$link_url</span> = <span class="i">URI::Escape::uri_unescape</span><span class="s">(</span><span class="i">$link_url</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$link_url</span> =~ <span class="q">s /\s+/\+/g</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$default_options</span> = <span class="q">&quot;height=800,width=1000,scrollbars=yes,resizable=yes,toolbar=yes,location=no,directories=no&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$show</span> = <span class="i">$label</span><span class="sc">;</span>

    <span class="c">#    if ($style) { $show = &quot;\n&lt;span style=$style&gt;\n$show\n&lt;/span&gt;\n&quot; }</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="s">(</span> <span class="k">defined</span> <span class="i">$tool_tip</span> <span class="s">)</span> &amp;&amp; !<span class="i">$scanner_mode</span> &amp;&amp; !<span class="i">$mouseover</span> &amp;&amp; !<span class="i">$mouseout</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$addons</span> =~ <span class="q">/Info=1.*Table=([a-zA-Z0-9_]+)&amp;*/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$tool_tip</span> = <span class="q">&quot;View $1&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$addons</span> =~ <span class="q">/Edit\+Table=([a-zA-Z0-9_]+)&amp;*/</span> <span class="s">)</span> &amp;&amp; !<span class="i">$mouseover</span> &amp;&amp; !<span class="i">$mouseout</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$tool_tip</span> = <span class="q">&quot;Edit $1&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$addon_string_hidden</span> = <span class="k">undef</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rand_num</span>            = <span class="k">undef</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$method</span> <span class="k">eq</span> <span class="q">&quot;POST&quot;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># create the hidden declarations</span>
        <span class="i">$addon_string_hidden</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>

        <span class="c"># remove leading question mark</span>
        <span class="i">$addons</span> =~ <span class="q">s/^\?(.*)/$1/</span><span class="sc">;</span>

        <span class="c"># split on &amp;</span>
        <span class="k">my</span> <span class="i">@arguments</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/&amp;/</span><span class="cm">,</span> <span class="i">$addons</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$arg</span> <span class="s">(</span><span class="i">@arguments</span><span class="s">)</span> <span class="s">{</span>

            <span class="c"># split on the first = sign</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/=/</span><span class="cm">,</span> <span class="i">$arg</span><span class="cm">,</span> <span class="n">2</span> <span class="s">)</span><span class="sc">;</span>

            <span class="c">#remove + and replace with spaces</span>
            <span class="i">$value</span> =~ <span class="q">tr/+/ /</span><span class="sc">;</span>
            <span class="i">$addon_string_hidden</span> .= <span class="q">&quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;$name\&quot; value=\&quot;$value\&quot;/&gt;&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># get a random number</span>
        <span class="i">$rand_num</span> = <span class="k">int</span><span class="s">(</span> <span class="k">rand</span><span class="s">(</span><span class="n">100000</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$formname</span> ||= <span class="q">&quot;linksubmit$rand_num&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## generate return value ##</span>
    <span class="k">my</span> <span class="i">$tt_prefix</span> = <span class="q">''</span><span class="sc">;</span>    <span class="c">## &quot;\n&lt;div id='divToolTip' class='toolTipCont'&gt;&lt;!--Empty div--&gt;&lt;/div&gt;\n&quot; .  ## this causes a linebreak - can we remove that effect ?</span>
<span class="c">##	&quot;&lt;script type='text/javascript'&gt;setToolTip()&lt;/script&gt;\n&quot; if $show_tool_tip;</span>

    <span class="k">my</span> <span class="i">$output</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$new_window</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="i">$options</span> =~ <span class="q">/[a-z]/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$options</span> = <span class="i">$default_options</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="c">### leave out line returns to prevent padding...</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$method</span> <span class="k">eq</span> <span class="q">&quot;POST&quot;</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c"># if in a form, do not create form tags</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$in_form</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">$output</span> .= <span class="q">qq{$tt_prefix$addon_string_hidden&lt;A Href=&quot;$link_url&quot; $style $mouseover $mouseout $alt_script onclick=&quot;document.$formname.submit();return false;&quot;&gt;$show&lt;/A&gt;}</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$output</span>
                    .= <span class="q">qq{$tt_prefix&lt;form name=&quot;$formname&quot; method=&quot;post&quot; action=&quot;$link_url&quot; $style target=&quot;$wname&quot;&gt;$addon_string_hidden&lt;/form&gt;&lt;A Href=&quot;$link_url&quot; style=$style $mouseover $mouseout $alt_script onclick=&quot;document.$formname.submit();return false;&quot;&gt;$show&lt;/A&gt;}</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">chomp</span> <span class="i">$addons</span><span class="sc">;</span>
            <span class="i">$output</span> .= <span class="q">qq{$tt_prefix&lt;A Href=&quot;$link_url$addons&quot; $style $mouseover $mouseout onClick=&quot;window.open('$link_url$addons','$wname','$options'); return false;&quot; $alt_script&gt;$show&lt;/A&gt;}</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$method</span> <span class="k">eq</span> <span class="q">&quot;POST&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$in_form</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">$output</span> .= <span class="q">qq{$tt_prefix\n$addon_string_hidden\n&lt;A Href=&quot;$link_url&quot; $style $mouseover $mouseout $alt_script onclick=&quot;document.$formname.submit();return false;&quot;&gt;$show&lt;/A&gt;}</span><span class="sc">;</span>    <span class="c">## maintain dark font</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$output</span>
                    .= <span class="q">qq{$tt_prefix&lt;form name=&quot;$formname&quot; method=&quot;post&quot; action=&quot;$link_url&quot; $style $mouseover $mouseout target=&quot;&quot;&gt;$addon_string_hidden&lt;/form&gt;&lt;A Href=&quot;$link_url&quot; style=$style onclick=&quot;document.$formname.submit();return false;&quot; $alt_script&gt;$show&lt;/A&gt;}</span>
                    <span class="sc">;</span>                                                                                                                                                                          <span class="c">## maintain dark font</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$output</span> .= <span class="q">qq{$tt_prefix&lt;A Href=&quot;$link_url$addons&quot; $style $mouseover $mouseout $alt_script&gt;$show&lt;/A&gt;}</span><span class="sc">;</span>                                                                             <span class="c">## maintain dark font</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$tool_tip</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$tip_style</span> .= <span class="q">&quot;width:$TT_width;&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$TT_width</span> &amp;&amp; <span class="s">(</span> <span class="i">$tip_style</span> !~ <span class="q">/width:/</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$tip_style</span> .= <span class="q">&quot;white-space:normal;&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$TT_width</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$tip_style</span> = <span class="q">&quot;style=\&quot;$tip_style\&quot;&quot;</span> <span class="k">if</span> <span class="i">$tip_style</span><span class="sc">;</span>
        <span class="c">## use simple hover in css to handle tool tips ##</span>
        <span class="c">#	$output =~s/&lt;A (.*?)&lt;\/A&gt;/&lt;A class='info' $1&lt;span $tip_style&gt;$tool_tip&lt;\/span&gt;&lt;\/A&gt;/i unless $scanner_mode;</span>
        <span class="i">$output</span> = <span class="i">&amp;Show_Tool_Tip</span><span class="s">(</span> <span class="i">$output</span><span class="cm">,</span> <span class="i">$tool_tip</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$output</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################</span>
<a name="make_thumbnail-"></a><span class="k">sub </span><span class="m">make_thumbnail</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'input,output'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$input</span>  = <span class="i">$args</span>{-<span class="w">input</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span> = <span class="i">$args</span>{-<span class="w">output</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$text</span>   = <span class="i">$args</span>{-<span class="w">text</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rotate</span> = <span class="i">$args</span>{-<span class="w">rotate</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$resize</span> = <span class="i">$args</span>{-<span class="w">resize</span>}<span class="sc">;</span>    <span class="c"># format is 100x100 (in pixel)</span>

    <span class="k">my</span> <span class="i">$extra_args</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$rotate</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$extra_args</span> .= <span class="q">&quot; -rotate $rotate &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$resize</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$extra_args</span> .= <span class="q">&quot; -scale $resize &quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$text</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$pointsize</span> = <span class="n">32</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Writing $text&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$extra_args</span> .= <span class="q">&quot; -fill black -draw 'text 10,50 \&quot;$text\&quot;' $output -pointsize $pointsize&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$command</span> = <span class="q">&quot;/usr/X11R6/bin/convert $input $extra_args $output&quot;</span><span class="sc">;</span>

    <span class="c">#    Message(&quot;Running $command&quot;);</span>
    <span class="i">try_system_command</span><span class="s">(</span><span class="i">$command</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################</span>
<a name="Hlink_padded-"></a><span class="k">sub </span><span class="m">Hlink_padded</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="c">#</span>
    <span class="c"># pad spaces with + signs for hyperlinks...</span>
<span class="c">##</span>

    <span class="k">my</span> <span class="i">$string</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$string</span> =~ <span class="q">s/\s/+/g</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$string</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################################</span>
<span class="c">#</span>
<span class="c"># Generate Sequencing Notes and write to Error log file</span>
<span class="c">#</span>
<a name="Log_Notes-"></a><span class="k">sub </span><span class="m">Log_Notes</span> <span class="s">{</span>
<span class="c">################</span>
    <span class="k">my</span> <span class="i">$preface</span>    = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># Preface message with this text</span>
    <span class="k">my</span> <span class="i">$message</span>    = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># message content</span>
    <span class="k">my</span> <span class="i">$LocalStyle</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># defaults to $style (global variable) or 'text'</span>
    <span class="k">my</span> <span class="i">$LocalFile</span>  = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># file to write to (defaults to $error_directory/Err(date)</span>
    <span class="k">my</span> <span class="i">$rewrite</span>    = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># rewrite log file (default = append)</span>

    <span class="s">(</span> <span class="k">my</span> <span class="i">$nowdate</span><span class="cm">,</span> <span class="k">my</span> <span class="i">$nowtime</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">/ /</span><span class="cm">,</span> <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$LocalStyle</span> ||= <span class="i">$style</span><span class="sc">;</span>
    <span class="i">$LocalStyle</span> ||= <span class="q">&quot;text&quot;</span><span class="sc">;</span>

    <span class="c">#   $LocalFile ||= &quot;$error_directory/Err$nowdate&quot;;</span>
    <span class="k">my</span> <span class="i">$ERROR</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$LocalStyle</span> =~ <span class="q">/h/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$rewrite</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">open</span> <span class="w">ERROR</span><span class="cm">,</span> <span class="q">&quot;&gt;$LocalFile&quot;</span> <span class="k">or</span> <span class="k">print</span> <span class="q">&quot;\nCannot open $ERROR\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">open</span> <span class="w">ERROR</span><span class="cm">,</span> <span class="q">&quot;&gt;&gt;$LocalFile&quot;</span> <span class="k">or</span> <span class="k">print</span> <span class="q">&quot;\nCannot open $ERROR\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">print</span> <span class="i">ERROR</span> <span class="q">&quot;$preface $nowtime\n$message\n&quot;</span><span class="sc">;</span>
        <span class="k">close</span> <span class="w">ERROR</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;$preface\n$message\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################</span>
<a name="File_to_HTML-"></a><span class="k">sub </span><span class="m">File_to_HTML</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">$filename</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$title</span>     = <span class="k">shift</span> || <span class="q">'Info'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$separator</span> = <span class="k">shift</span> || <span class="q">&quot;\t&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$output</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$filename</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$SEQFILE</span><span class="sc">;</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">SEQFILE</span><span class="cm">,</span> <span class="q">&quot;$filename&quot;</span> <span class="s">)</span> <span class="k">or</span> <span class="k">print</span> <span class="q">&quot;Error opening $SEQFILE ($filename)&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$Table</span> = <span class="w">HTML_Table</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$Table</span><span class="i">-&gt;Set_Title</span><span class="s">(</span><span class="i">$title</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span><span class="q">&lt;SEQFILE&gt;</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$line</span> = <span class="i">$_</span><span class="sc">;</span>
            <span class="i">$index</span>++<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/$separator/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">@row</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">while</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/^(.*?)$separator(.*)/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$line</span> = <span class="i">$2</span><span class="sc">;</span>
                    <span class="k">push</span><span class="s">(</span> <span class="i">@row</span><span class="cm">,</span> <span class="i">$1</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@row</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$Table</span><span class="i">-&gt;Set_Row</span><span class="s">(</span> \<span class="i">@row</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$Table</span>-&gt;{<span class="w">rows</span>} &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$Table</span><span class="i">-&gt;Set_sub_header</span><span class="s">(</span> <span class="q">&quot;$line&quot;</span><span class="cm">,</span> <span class="q">'mediumredbw'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="i">$Table</span><span class="i">-&gt;Set_sub_header</span><span class="s">(</span> <span class="i">$line</span><span class="cm">,</span> <span class="q">'mediumredbw'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="i">$output</span> .= <span class="i">$Table</span><span class="i">-&gt;Printout</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;Nothing Found&quot;</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">return</span> <span class="i">$output</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################</span>
<a name="random_int-"></a><span class="k">sub </span><span class="m">random_int</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$min</span> = <span class="k">shift</span> || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$max</span> = <span class="s">(</span> <span class="k">defined</span> <span class="i">$_</span>[<span class="n">0</span>] <span class="s">)</span> ? <span class="i">$_</span>[<span class="n">0</span>] <span class="co">:</span> <span class="n">100</span><span class="sc">;</span>

    <span class="c"># Assumes that the two arguments are integers themselves!</span>
    <span class="k">return</span> <span class="i">$min</span> <span class="k">if</span> <span class="i">$min</span> == <span class="i">$max</span><span class="sc">;</span>

    <span class="s">(</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$max</span> <span class="s">)</span> = <span class="s">(</span> <span class="i">$max</span><span class="cm">,</span> <span class="i">$min</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$min</span> &gt; <span class="i">$max</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$min</span> + <span class="k">int</span> <span class="k">rand</span><span class="s">(</span> <span class="n">1</span> + <span class="i">$max</span> - <span class="i">$min</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#############################</span>
<a name="start_barcode_form-"></a><span class="k">sub </span><span class="m">start_barcode_form</span> <span class="s">{</span>
<span class="c">#############################</span>
    <span class="c">#</span>
    <span class="c"># Start html form with baseline parameters...</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$version</span>   = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$form_name</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hyperlink</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c">### was homefile ??</span>
    <span class="k">my</span> <span class="i">$p</span>         = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$target</span>    = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%login_parameters</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$p</span><span class="s">)</span> <span class="s">{</span> <span class="i">%login_parameters</span> = <span class="i">%</span>{<span class="i">$p</span>}<span class="sc">;</span> <span class="s">}</span>

    <span class="k">print</span> <span class="q">&quot;OLD SCHOOL: use start_custom_form instead.&quot;</span><span class="sc">;</span>
    <span class="i">Call_Stack</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$hyperlink</span> ||= <span class="i">$login_parameters</span>{<span class="q">'url'</span>}<span class="sc">;</span>

    <span class="c">#   if (param('Nav On')=~/on/i) {$nav_mode = 1;}</span>
    <span class="k">my</span> <span class="i">$banner_off</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Banner Off'</span><span class="s">)</span> || <span class="n">0</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$method</span> = <span class="q">'POST'</span><span class="sc">;</span>

    <span class="c">#    if ($scanner_mode &amp;&amp; !($form_name=~/prep/)) {$method = 'GET';}  ### allows back button operation.</span>

    <span class="k">my</span> <span class="i">$stamp</span> = <span class="k">time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c">######## enable popup menu search (javascript) ... (last parameter reduces menu #######</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$form_name</span><span class="s">)</span> <span class="s">{</span> <span class="i">$MenuSearch</span> = <span class="q">&quot;MenuSearch(document.$form_name,1)&quot;</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">#    my $form = &quot;\n&quot;.start_form(-action=&gt;&quot;$homefile?Time=$stamp&quot;,-name=&gt;$form_name);</span>
    <span class="i">$form_name</span> ||= <span class="q">'thisform'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$link</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parameters</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$hyperlink</span> =~ <span class="q">/(.*)\?(.*)/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$link</span> = <span class="i">$1</span><span class="sc">;</span> <span class="i">$parameters</span> = <span class="i">$2</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">else</span>                              <span class="s">{</span> <span class="i">$link</span> = <span class="i">$hyperlink</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">#URL unescape characters in parameters</span>
    <span class="i">$parameters</span> = <span class="i">URI::Escape::uri_unescape</span><span class="s">(</span><span class="i">$parameters</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$target</span><span class="s">)</span> <span class="s">{</span> <span class="i">$target</span> = <span class="q">&quot;Target='$target'&quot;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$form</span> = <span class="q">&quot;\n&lt;Form name=$form_name Action='$link' Method='$method' enctype='multipart/form-data' onSubmit='return allowSubmit();' $target&gt;&quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$link</span><span class="s">)</span> <span class="s">{</span>    <span class="c">### send parameters separately as hidden fields..</span>
        <span class="k">my</span> <span class="i">@parameters</span> = <span class="k">split</span> <span class="q">&quot;&amp;&quot;</span><span class="cm">,</span> <span class="i">$parameters</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$param</span> <span class="s">(</span><span class="i">@parameters</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">&quot;=&quot;</span><span class="cm">,</span> <span class="i">$param</span><span class="sc">;</span>
            <span class="i">$form</span> .= <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="i">$key</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$value</span> <span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">#    if ($last_page=~/,/) {($last_page) = split ',',$last_page;}</span>
    <span class="c">#    $form .= &quot;\n&quot;.hidden(-name=&gt;'Last Page',-value=&gt;$last_page,-force=&gt;1);</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$version</span> =~ <span class="q">/^start/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$form</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">#    my $lastpage = param('Last Page');</span>
    <span class="c">#    $form .= &quot;\n&quot;.hidden(-name=&gt;'Last Page',-value=&gt;$lastpage,-force=&gt;1);</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$version</span> =~ <span class="q">/^protocol/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$form</span><span class="sc">;</span> <span class="s">}</span>

    <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
        . <span class="i">hidden</span><span class="s">(</span>
        -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Session'</span><span class="cm">,</span>
        -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'session_id'</span>}<span class="cm">,</span>
        -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span>
        <span class="s">)</span><span class="sc">;</span>

    <span class="c">#$form .= &quot;\n&lt;input type=hidden name='Session' value='$login_parameters{'session_id'}'/&gt;&quot;;</span>
    <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
        . <span class="i">hidden</span><span class="s">(</span>
        -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'User'</span><span class="cm">,</span>
        -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'user'</span>}<span class="cm">,</span>
        -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
        . <span class="i">hidden</span><span class="s">(</span>
        -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Database'</span><span class="cm">,</span>
        -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'dbase'</span>}<span class="cm">,</span>
        -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
        . <span class="i">hidden</span><span class="s">(</span>
        -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Project'</span><span class="cm">,</span>
        -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'project'</span>}<span class="cm">,</span>
        -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$login_parameters</span>{<span class="q">'Target_Department'</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Target_Department'</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'Target_Department'</span>}<span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span>
            <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$login_parameters</span>{<span class="q">'banner'</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Banner'</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'banner'</span>}<span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span>
            <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#    $form .= &quot;\n&quot;.hidden(-name=&gt;'Nav On',-value=&gt;$nav_mode,-force=&gt;1);</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$version</span> =~ <span class="q">/solution/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Solution ID'</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'solution_id'</span>}<span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span>
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Sol Mix'</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'solution_mixture'</span>}<span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span>
            <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$version</span> =~ <span class="q">/prep/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Plate Set'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'plate_set'</span>}
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Plate ID'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'plate_id'</span>}
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Current Plates'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'current_plates'</span>}
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Step Name'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'step_name'</span>}
            <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$version</span> =~ <span class="q">/status/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Barcode'</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'barcode'</span>}<span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span>
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Plate Set'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'plate_set'</span>}
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Plate ID'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'plate_id'</span>}
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Current Plates'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'current_plates'</span>}
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Step Name'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'step_name'</span>}
            <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$version</span> =~ <span class="q">/plate/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Plate Set'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'plate_set'</span>}
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Plate ID'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'plate_id'</span>}
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Current Plates'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'current_plates'</span>}
            <span class="s">)</span><span class="sc">;</span>
        <span class="i">$form</span> .= <span class="q">&quot;\n&quot;</span>
            . <span class="i">hidden</span><span class="s">(</span>
            -<span class="w">name</span>  <span class="cm">=&gt;</span> <span class="q">'Step Name'</span><span class="cm">,</span>
            -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$login_parameters</span>{<span class="q">'step_name'</span>}
            <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$form</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###########################</span>
<a name="start_custom_form-"></a><span class="k">sub </span><span class="m">start_custom_form</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="c">#</span>
    <span class="c"># Start an html form invoking parameters as specified in the passed hash containing arrays:</span>
    <span class="c">#   $P{Name}</span>
    <span class="c">#   $P{Value}</span>
    <span class="c">#</span>
    <span class="c"># and values:</span>
    <span class="c">#   $P{Method}</span>
    <span class="c">#</span>
    <span class="c">#</span>
    <span class="c"># generic version of start_barcode_form (get rid of start_barcode_form)</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">'form'</span><span class="cm">,</span> <span class="q">'link'</span><span class="cm">,</span> <span class="q">'parameters'</span><span class="cm">,</span> <span class="q">'target'</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$form_name</span> = <span class="i">$args</span>{-<span class="w">form</span>} || <span class="q">'thisform'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hyperlink</span> = <span class="i">$args</span>{ -<span class="k">link</span> }<span class="sc">;</span>                        <span class="c">### was homefile ??</span>
    <span class="k">my</span> <span class="i">$p</span>         = <span class="i">$args</span>{-<span class="w">parameters</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$target</span>    = <span class="i">$args</span>{-<span class="w">target</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>        = <span class="q">&quot;id='$args{-id}'&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{-<span class="w">id</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$form_name</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$MenuSearch</span> = <span class="q">&quot;MenuSearch(document.$form_name,1)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>                                                      <span class="c">### export global</span>

    <span class="k">my</span> <span class="i">%P</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$p</span><span class="s">)</span> <span class="s">{</span> <span class="i">%P</span> = <span class="i">%</span>{<span class="i">$p</span>}<span class="sc">;</span> <span class="s">}</span>

    <span class="i">$hyperlink</span> ||= <span class="i">$P</span>{<span class="q">'url'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$method</span> = <span class="i">$P</span>{<span class="q">'Method'</span>} || <span class="q">'POST'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$stamp</span> = <span class="k">time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$link</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parameters</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$hyperlink</span> =~ <span class="q">/(.*)\?(.*)/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$link</span> = <span class="i">$1</span><span class="sc">;</span> <span class="i">$parameters</span> = <span class="i">$2</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">else</span>                              <span class="s">{</span> <span class="i">$link</span> = <span class="i">$hyperlink</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">#URL unescape characters in parameters</span>
    <span class="i">$parameters</span> = <span class="i">URI::Escape::uri_unescape</span><span class="s">(</span><span class="i">$parameters</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$target</span><span class="s">)</span> <span class="s">{</span> <span class="i">$target</span> = <span class="q">&quot;Target='$target'&quot;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$form</span> = <span class="q">&quot;\n&lt;Form name=$form_name Action='$link' Method='$method' enctype='multipart/form-data' onSubmit='return allowSubmit();' $id $target&gt;\n&quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$link</span><span class="s">)</span> <span class="s">{</span>    <span class="c">### send parameters separately as hidden fields..</span>
        <span class="k">my</span> <span class="i">@parameters</span> = <span class="k">split</span> <span class="q">&quot;&amp;&quot;</span><span class="cm">,</span> <span class="i">$parameters</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$param</span> <span class="s">(</span><span class="i">@parameters</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">&quot;=&quot;</span><span class="cm">,</span> <span class="i">$param</span><span class="sc">;</span>
            <span class="i">$value</span> =~ <span class="q">s/\+/ /g</span><span class="sc">;</span>
            <span class="i">$form</span> .= <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="i">$key</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$value</span> <span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>

            <span class="c">#$form .= &quot;&lt;input type=hidden name='key' value='$value'/&gt;\n&quot;;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># Get parameters stored in array format</span>
    <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$P</span>{<span class="w">Name</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$name</span> = <span class="i">$P</span>{<span class="w">Name</span>}[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="i">$form</span> .= <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="i">$name</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$P</span>{<span class="w">Value</span>}[<span class="i">$index</span>] <span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>

        <span class="c">#$form .= &quot;&lt;input type=hidden name='$name' value='&quot; . $P{Value}[$index] . &quot;'/&gt;\n&quot;;</span>
        <span class="i">$index</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Get regular parameters (non-references)...</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$param</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%P</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="k">ref</span> <span class="i">$param</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$form</span> .= <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="i">$param</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$P</span>{<span class="i">$param</span>} <span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$form</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###################</span>
<a name="load_Stats-"></a><span class="k">sub </span><span class="m">load_Stats</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$load_file</span> = <span class="k">shift</span> || <span class="q">'Statistics'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$Stats_dir</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$lock</span>      = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>     = <span class="k">shift</span> || <span class="n">1</span><span class="sc">;</span>              <span class="c">### with feedback  ?</span>

    <span class="k">my</span> <span class="i">%check</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$pre_load_time</span> = <span class="w">new</span> <span class="w">Benchmark</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Stats</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$lock</span><span class="s">)</span> <span class="s">{</span>

        <span class="c">#	if (-e &quot;$Stats_dir/$load_file.lock&quot;) {</span>
        <span class="c">#	    unless ($quiet) {print &quot;$load_file locked (waiting...)&quot;;}</span>
        <span class="c">#	    my $index=0;</span>
        <span class="c">#	    while (-e &quot;$Stats_dir/$load_file.lock&quot;) {</span>
        <span class="c">#		sleep 2;</span>
        <span class="c">#	    }</span>
        <span class="c">#	}</span>
        <span class="i">&amp;Lock_File</span><span class="s">(</span><span class="q">&quot;$Stats_dir/$load_file&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="q">&quot;$Stats_dir/$load_file&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;retrieve $Stats_dir/$load_file..\n&quot;</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="i">$Stats</span> = <span class="i">&amp;Storable::retrieve</span><span class="s">(</span><span class="q">&quot;$Stats_dir/$load_file&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$post_load_time</span> = <span class="w">new</span> <span class="w">Benchmark</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$load_time</span> = <span class="i">&amp;timediff</span><span class="s">(</span> <span class="i">$post_load_time</span><span class="cm">,</span> <span class="i">$pre_load_time</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$quiet</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="q">&quot;&lt;BR&gt;\n&lt;Font size=-2&gt;&quot;</span><span class="sc">;</span>
            <span class="k">print</span> <span class="q">&quot;$load_file Retrieval Time: &quot;</span> . <span class="i">timestr</span><span class="s">(</span><span class="i">$load_time</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">print</span> <span class="q">&quot;&lt;/Font&gt;&lt;BR&gt;\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c">#	return &amp;retrieve(&quot;$Stats_dir/$load_file&quot;);</span>
        <span class="k">return</span> <span class="i">$Stats</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>

        <span class="c">#	$Stats = {};</span>
        <span class="c">#	Message(&quot;Error: $load_file File Not found !&quot;);</span>
        <span class="c">#	Call_Stack();</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">###################</span>
<a name="Lock_File-"></a><span class="k">sub </span><span class="m">Lock_File</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$file</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$details</span> = <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;\t&quot;</span> . <span class="i">$ENV</span>{<span class="w">USER</span>} . <span class="q">&quot; : &quot;</span> . <span class="i">$0</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ok</span> = <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;echo $details &gt; $file.lock&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$ok</span> .= <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;chmod 777 $file.lock&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$ok</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###################</span>
<a name="Unlock_File-"></a><span class="k">sub </span><span class="m">Unlock_File</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$file</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ok</span> = <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;rm -f $file.lock&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$ok</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################</span>
<a name="Show_ENV-"></a><span class="k">sub </span><span class="m">Show_ENV</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="c">#</span>
    <span class="c"># just display environment variables...</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$linefeed</span> = <span class="k">shift</span> || <span class="q">&quot;\n&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@keys</span> = <span class="k">keys</span> <span class="i">%ENV</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">@keys</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;$key = &quot;</span> . <span class="i">$ENV</span>{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="k">print</span> <span class="i">$linefeed</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################</span>
<a name="Prompt_Input-"></a><span class="k">sub </span><span class="m">Prompt_Input</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="c">#</span>
    <span class="c">#Takes command-line input from user and returns the input.</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'type,prompt'</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># Options can be: 'single', 'passwd'</span>

    <span class="k">my</span> <span class="i">$type</span>   = <span class="i">$args</span>{-<span class="w">type</span>}   || <span class="q">'string'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$prompt</span> = <span class="i">$args</span>{-<span class="w">prompt</span>} || <span class="q">''</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ans</span><span class="sc">;</span>

    <span class="k">print</span> <span class="q">&quot;$prompt&gt;&quot;</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/^(single|c)/</span> <span class="s">)</span> <span class="s">{</span>                             <span class="c">#Just read one key without the need to press the return key.</span>
        <span class="i">ReadMode</span><span class="s">(</span><span class="q">'cbreak'</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$ans</span> = <span class="i">ReadKey</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">ReadMode</span><span class="s">(</span><span class="q">'normal'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;$ans\n&quot;</span><span class="sc">;</span>                                         <span class="c">#Display input and then go to next line.</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/^pass/</span> <span class="s">)</span> <span class="s">{</span>                                <span class="c">#For password inputs - do not display the input characters.</span>
        <span class="i">ReadMode</span><span class="s">(</span><span class="q">'noecho'</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$ans</span> = <span class="i">ReadLine</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">chomp</span><span class="s">(</span><span class="i">$ans</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">ReadMode</span><span class="s">(</span><span class="q">'normal'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>                                                      <span class="c"># Regular input</span>
        <span class="i">$ans</span> = <span class="q">&lt;STDIN&gt;</span><span class="sc">;</span>
        <span class="k">chomp</span><span class="s">(</span><span class="i">$ans</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$ans</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################</span>
<a name="Get_Current_Dir-"></a><span class="k">sub </span><span class="m">Get_Current_Dir</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="c">#</span>
    <span class="c">#This function returns the current directory.</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$current_dir</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">-l</span> <span class="i">$0</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c">#if the file name is indeed a symlink then need to dereference.</span>
        <span class="k">my</span> <span class="i">$realfile</span> = <span class="k">readlink</span> <span class="i">$0</span><span class="sc">;</span>
        <span class="i">$realfile</span> =~ <span class="q">/^(.*)\//</span><span class="sc">;</span>
        <span class="i">$current_dir</span> = <span class="i">$1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$0</span> =~ <span class="q">/^(.*)\//</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$current_dir</span> = <span class="i">$1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$current_dir</span> = <span class="i">cwd</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$current_dir</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#######################</span>
<a name="Extract_Values-"></a><span class="k">sub </span><span class="m">Extract_Values</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="c">#</span>
    <span class="c"># This function receives a list of values in an array format and return the first defined value.</span>
    <span class="c"># Future enhancement:  Add switches to test for value as well (e.g. &gt;10, alphanumeric, etc)</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$values_ref</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$retval</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$value</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$values_ref</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$value</span> &amp;&amp; <span class="i">$value</span> <span class="k">ne</span> <span class="q">''</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$retval</span> = <span class="i">$value</span><span class="sc">;</span>
            <span class="k">last</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$retval</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################################</span>
<span class="c">#</span>
<span class="c">#  Tool tip that will only show up in mozilla, not recommended (returns nothing right now since it is disabled)</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="Show_Moz_Tool_Tip-"></a><span class="k">sub </span><span class="m">Show_Moz_Tool_Tip</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$html_tag</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tool_tip_msg</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c">#The message of the tooltip.</span>
    <span class="k">my</span> <span class="i">$no_tips</span>      = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$no_tips</span> || <span class="i">$scanner_mode</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$html_tag</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$output</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$tool_tip_msg</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$tool_tip_msg</span> <span class="k">ne</span> <span class="q">''</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$tool_tip_msg</span> <span class="k">ne</span> <span class="q">'0'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$output</span> = <span class="q">&quot;\n&lt;tooltip&gt;\n  $html_tag\n  &lt;span class='tip'&gt;$tool_tip_msg&lt;/span&gt;\n&lt;/tooltip&gt;\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$output</span> = <span class="i">$html_tag</span><span class="sc">;</span>     <span class="c">#Just return what was passed in</span>
    <span class="s">}</span>

    <span class="c">#  return $output;</span>
    <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#######################</span>
<a name="Show_Tool_Tip-"></a><span class="k">sub </span><span class="m">Show_Tool_Tip</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">%args</span>         = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'element,tip,notip,break_on'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$html_tag</span>     = <span class="i">$args</span>{-<span class="w">element</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tool_tip_msg</span> = <span class="i">$args</span>{-<span class="w">tip</span>}<span class="sc">;</span>                                                   <span class="c"># The message of the tooltip.</span>
    <span class="k">my</span> <span class="i">$no_tips</span>      = <span class="i">$args</span>{-<span class="w">notip</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="s">(</span> <span class="i">$scanner_mode</span> || <span class="i">$no_tips</span> <span class="s">)</span> &amp;&amp; <span class="i">$tool_tip_msg</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$tool_tip_msg</span> =~ <span class="q">s/[\'\&quot;]//g</span><span class="sc">;</span>
        <span class="i">$tool_tip_msg</span> =~ <span class="q">s/\n/&lt;br&gt;/g</span><span class="sc">;</span>
        <span class="i">$tool_tip_msg</span> =~ <span class="q">s/\r//g</span><span class="sc">;</span>

        <span class="k">unless</span> <span class="s">(</span> <span class="i">$html_tag</span> =~ <span class="q">/&gt;/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$html_tag</span> = <span class="q">&quot;&lt;A Href='#' style='text-decoration:none' &gt;$html_tag&lt;/A&gt;&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$html_tag</span> =~ <span class="q">s/(\/)?&gt;/ onmouseover=&quot;writetxt('$tool_tip_msg')&quot; onmouseout=&quot;writetxt(0)&quot;$1&gt;/</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$html_tag</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#######################</span>
<a name="Array_Exists-"></a><span class="k">sub </span><span class="m">Array_Exists</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="c">#</span>
    <span class="c">#Search an array for existance of a given element.</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$array_ref</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c">#Pass in reference to the array to be searched.</span>
    <span class="k">my</span> <span class="i">$search</span>    = <span class="k">shift</span><span class="sc">;</span>    <span class="c">#Pass in the element searching for.</span>

    <span class="k">my</span> <span class="i">$found</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$element</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$array_ref</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$element</span> =~ <span class="q">/^$search$/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$found</span> = <span class="n">1</span><span class="sc">;</span>
            <span class="k">last</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$found</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<span class="c"># Displays the call stack</span>
<span class="c">#</span>
<span class="c"># Returns an arrayref</span>
<span class="c">############################</span>
<a name="Call_Stack-"></a><span class="k">sub </span><span class="m">Call_Stack</span> <span class="s">{</span>
<span class="c">##############</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'level'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$level</span>      = <span class="i">$args</span>{-<span class="w">level</span>}<span class="sc">;</span>         <span class="c"># Maximum level of calls to go</span>
    <span class="k">my</span> <span class="i">$line_break</span> = <span class="i">$args</span>{-<span class="w">line_break</span>}<span class="sc">;</span>    <span class="c"># Linebreak character</span>
    <span class="k">my</span> <span class="i">$quiet</span>      = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$type</span><span class="sc">;</span>
    <span class="k">if</span>    <span class="s">(</span> <span class="i">$0</span> =~ <span class="q">/\.html$/</span> <span class="s">)</span>     <span class="s">{</span> <span class="i">$type</span> = <span class="q">'html'</span><span class="sc">;</span> <span class="i">$line_break</span> ||= <span class="q">'&lt;BR&gt;'</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$0</span> =~ <span class="q">/\/cgi-bin\//</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$type</span> = <span class="q">'html'</span><span class="sc">;</span> <span class="i">$line_break</span> ||= <span class="q">'&lt;BR&gt;'</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">else</span>                          <span class="s">{</span> <span class="i">$type</span> = <span class="q">'text'</span><span class="sc">;</span> <span class="i">$line_break</span> ||= <span class="q">&quot;\n&quot;</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">%calls</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$retval</span><span class="sc">;</span>

    <span class="k">push</span><span class="s">(</span> <span class="i">@$retval</span><span class="cm">,</span> <span class="q">&quot;M =&gt; $0&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">$quiet</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;*** Call Stack *** &quot;</span> . <span class="i">$line_break</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">while</span> <span class="s">(</span><span class="n">1</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$package</span><span class="cm">,</span> <span class="i">$file</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span> = <span class="k">caller</span><span class="s">(</span><span class="i">$i</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$calling_function</span> <span class="s">)</span> = <span class="k">caller</span><span class="s">(</span> <span class="i">$i</span> + <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$calling_function</span> ||= <span class="q">''</span><span class="sc">;</span>
        <span class="i">$package</span>          ||= <span class="q">''</span><span class="sc">;</span>

        <span class="i">$calling_function</span> =~ <span class="q">s/.*::(\w+)/$1/</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$level</span> &amp;&amp; <span class="s">(</span> <span class="i">$i</span> == <span class="i">$level</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">return</span> <span class="i">$package</span> . <span class="q">&quot;::&quot;</span> . <span class="i">$calling_function</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span><span class="i">$package</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$info</span> = <span class="q">&quot;$i =&gt; '$package\:\:$calling_function()' ($line)&quot;</span><span class="sc">;</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@$retval</span><span class="cm">,</span> <span class="i">$info</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">unless</span> <span class="s">(</span><span class="i">$quiet</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/html/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">print</span> <span class="q">&quot;&lt;Font size=-2&gt;&quot;</span><span class="sc">;</span>
                    <span class="k">print</span> <span class="q">&quot;$info$line_break&quot;</span><span class="sc">;</span>
                    <span class="k">print</span> <span class="q">&quot;&lt;/Font&gt;&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="k">print</span> <span class="i">$info</span>. <span class="i">$line_break</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">last</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$i</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$retval</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#############################</span>
<span class="c"># Cast a string or an array ref</span>
<span class="c"># to the desired output</span>
<span class="c">#############################</span>
<a name="Cast_List-"></a><span class="k">sub </span><span class="m">Cast_List</span> <span class="s">{</span>
<span class="c">#################</span>

    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$list</span>               = <span class="i">$args</span>{-<span class="w">list</span>}<span class="sc">;</span>                                     <span class="c"># The list to be casted</span>
    <span class="k">my</span> <span class="i">$delimiter</span>          = <span class="i">$args</span>{-<span class="w">delimiter</span>} || <span class="q">&quot;,&quot;</span><span class="sc">;</span>                         <span class="c"># The delimiter used for the string list</span>
    <span class="k">my</span> <span class="i">$to</span>                 = <span class="i">$args</span>{-<span class="w">to</span>}<span class="sc">;</span>                                       <span class="c"># The format to cast to (i.e. 'array','arrayref','string')</span>
    <span class="k">my</span> <span class="i">$autoquote</span>          = <span class="i">$args</span>{-<span class="w">autoquote</span>}<span class="sc">;</span>                                <span class="c"># put each element in quotes</span>
    <span class="k">my</span> <span class="i">$pad</span>                = <span class="i">$args</span>{-<span class="w">pad</span>} || <span class="n">0</span><span class="sc">;</span>                                 <span class="c"># if single value supplied, pad array to list of length $pad</span>
    <span class="k">my</span> <span class="i">$pad_mode</span>           = <span class="i">$args</span>{-<span class="w">pad_mode</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$default</span>            = <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">default</span>} ? <span class="i">$args</span>{-<span class="w">default</span>} <span class="co">:</span> <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>              = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="n">1000</span><span class="sc">;</span>                            <span class="c"># limit to length of auto-expanded ranges (eg 1-4 -&gt; 1,2,3,4)</span>
    <span class="k">my</span> <span class="i">$trim_leading_zeros</span> = <span class="i">$args</span>{-<span class="w">trim_leading_zeros</span>}<span class="sc">;</span>                       <span class="c"># Remove leading zeros</span>
    <span class="k">my</span> <span class="i">$no_split</span>           = <span class="i">$args</span>{-<span class="w">no_split</span>}<span class="sc">;</span>                                 <span class="c"># suppress splitting on delimiter (just casts between ref types)</span>
    <span class="k">my</span> <span class="i">$sort</span>               = <span class="i">$args</span>{ -<span class="k">sort</span> } || <span class="n">0</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@arr</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$retval</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$list</span><span class="s">)</span> <span class="k">eq</span> <span class="q">'ARRAY'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@arr</span> = <span class="i">@$list</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$autoquote</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">map</span> <span class="s">{</span>
                <span class="k">unless</span> <span class="s">(</span><span class="q">/^[\'\&quot;]/</span><span class="s">)</span> <span class="s">{</span> <span class="i">$_</span> = <span class="q">&quot;'$_'&quot;</span> <span class="s">}</span>
            <span class="s">}</span> <span class="i">@arr</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$list</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">while</span> <span class="s">(</span> <span class="i">$list</span> =~ <span class="q">/(^|,)(\d+)\-(\d+)(,|$)/</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## replace range specification with list</span>
            <span class="k">my</span> <span class="i">$replace</span> = <span class="i">&amp;resolve_range</span><span class="s">(</span><span class="q">&quot;$2-$3&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">$list</span> =~ <span class="q">s /(^|,)$2\-$3(,|$)/$1$replace$2/g</span><span class="sc">;</span>

            <span class="k">last</span> <span class="k">unless</span> <span class="i">$limit</span>--<span class="sc">;</span>                        <span class="c">## just in case this is somehow way too long...</span>
        <span class="s">}</span>
        <span class="k">if</span>   <span class="s">(</span><span class="i">$no_split</span><span class="s">)</span> <span class="s">{</span> <span class="i">@arr</span> = <span class="s">(</span><span class="i">$list</span><span class="s">)</span> <span class="s">}</span>
        <span class="k">else</span>             <span class="s">{</span> <span class="i">@arr</span> = <span class="k">split</span> <span class="q">/\s*$delimiter\s*/</span><span class="cm">,</span> <span class="i">$list</span> <span class="s">}</span>

        <span class="k">unless</span> <span class="s">(</span><span class="i">$list</span><span class="s">)</span> <span class="s">{</span> <span class="i">@arr</span> = <span class="s">(</span><span class="i">$default</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$autoquote</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">map</span> <span class="s">{</span>
                <span class="k">unless</span> <span class="s">(</span><span class="q">/^[\'\&quot;]/</span><span class="s">)</span> <span class="s">{</span> <span class="i">$_</span> = <span class="q">&quot;'$_'&quot;</span> <span class="s">}</span>
            <span class="s">}</span> <span class="i">@arr</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@arr</span><span class="s">)</span> == <span class="n">1</span> <span class="s">)</span> &amp;&amp; <span class="i">$pad</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## pad to list of similar values #</span>
        <span class="i">@arr</span> = <span class="k">map</span> <span class="s">{</span> <span class="i">$arr</span>[<span class="n">0</span>] <span class="s">}</span> <span class="s">(</span> <span class="n">1</span> .. <span class="i">$pad</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@arr</span><span class="s">)</span> == <span class="i">$pad</span> <span class="s">)</span> <span class="s">{</span>

    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$pad</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$repeat</span> = <span class="i">$pad</span> / <span class="k">int</span><span class="s">(</span><span class="i">@arr</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="i">$repeat</span> == <span class="k">int</span><span class="s">(</span><span class="i">$repeat</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Invalid number in array&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$pad_mode</span> <span class="k">eq</span> <span class="q">'Stretch'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">@temp_arr</span> = <span class="i">@arr</span><span class="sc">;</span>
            <span class="i">@arr</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$value</span> <span class="s">(</span><span class="i">@temp_arr</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span><span class="sc">;</span> <span class="i">$i</span> &lt; <span class="i">$repeat</span><span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
                    <span class="k">push</span><span class="s">(</span> <span class="i">@arr</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$pad_mode</span> <span class="k">eq</span> <span class="q">'Zero'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">map</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$size</span> = <span class="k">length</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span><span class="sc">;</span>
                <span class="i">$_</span> = <span class="q">'0'</span> x <span class="s">(</span> <span class="i">$pad</span> - <span class="i">$size</span> <span class="s">)</span> . <span class="i">$_</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$size</span> &lt; <span class="i">$pad</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span> <span class="i">@arr</span><span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$trim_leading_zeros</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@arr</span> = <span class="k">map</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$item</span> = <span class="i">$_</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$item</span> =~ <span class="q">/^\d+$/</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## If all digits</span>
                <span class="i">$item</span> =~ <span class="q">s/^0+//</span><span class="sc">;</span>        <span class="c">## Remove leading zeros</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$item</span> =~ <span class="q">/^$/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$item</span> = <span class="q">'0'</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## If all zeros, put one zero back</span>
            <span class="s">}</span>
            <span class="i">$_</span> = <span class="i">$item</span><span class="sc">;</span>
        <span class="s">}</span> <span class="i">@arr</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@sorted</span> = <span class="i">@arr</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$sort</span> =~ <span class="q">/desc/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@sorted</span> = <span class="k">sort</span> <span class="s">{</span> <span class="i">$b</span> &lt;=&gt; <span class="i">$a</span> <span class="s">}</span> <span class="i">@arr</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$sort</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@sorted</span> = <span class="k">sort</span> <span class="s">{</span> <span class="i">$b</span> &lt;=&gt; <span class="i">$a</span> <span class="s">}</span> <span class="i">@arr</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$to</span> =~ <span class="q">/\barray\b/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">@sorted</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$to</span> =~ <span class="q">/\barrayref\b/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> \<span class="i">@sorted</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$to</span> =~ <span class="q">/\bstring\b/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">join</span> <span class="q">&quot;$delimiter&quot;</span><span class="cm">,</span> <span class="i">@sorted</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">########################################################################################################</span>
<span class="c"># Safely perform the freeze/encode function</span>
<span class="c"># Make sure does not exceed the Windows CE limit on URL params in POST of 2083 characters</span>
<span class="c"># Return:</span>
<span class="c"># - ArrayRef ('-format'=&gt;'array'): An array of the param chopped in pieces</span>
<span class="c"># - String ('-format'=&gt;'hidden'):  A string of the param chopped in pieces embedded in HTML hidden fields</span>
<span class="c"># - String ('-format'=&gt;'url'):     A string of the param chopped in URL parameters format</span>
<span class="c">########################################################################################################</span>
<a name="Safe_Freeze-"></a><span class="k">sub </span><span class="m">Safe_Freeze</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$value</span>   = <span class="i">$args</span>{-<span class="w">value</span>}<span class="sc">;</span>                                                      <span class="c"># The param to be encoded</span>
    <span class="k">my</span> <span class="i">$format</span>  = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>                                                   <span class="c"># Specify the return format</span>
    <span class="k">my</span> <span class="i">$encode</span>  = <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">encode</span>} ? <span class="i">$args</span>{-<span class="w">encode</span>} <span class="co">:</span> <span class="n">0</span><span class="sc">;</span>                        <span class="c"># Whether to encode as well</span>
    <span class="k">my</span> <span class="i">$name</span>    = <span class="i">$args</span>{-<span class="w">name</span>} || <span class="q">'Frozen_Param'</span><span class="sc">;</span>                                     <span class="c"># The name of the param to be frozen (only needed if format is 'hidden' or 'url')</span>
    <span class="k">my</span> <span class="i">$exclude</span> = <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">exclude</span>} ? <span class="i">$args</span>{-<span class="w">exclude</span>} <span class="co">:</span> <span class="q">'dbh,connection,dbc'</span><span class="sc">;</span>

    <span class="k">require</span> <span class="w">MIME::Base32</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$MAX_LENGTH</span> = <span class="n">1000</span><span class="sc">;</span>                                                            <span class="c"># Just playing safe; give it some leeway instead of going 2083</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$exclude</span> &amp;&amp; <span class="k">ref</span><span class="s">(</span><span class="i">$value</span><span class="s">)</span> <span class="k">ne</span> <span class="q">'ARRAY'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@excluded</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$exclude</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">### Since we can't freeze/thaw the DBI::db objects, we have to kill 'em all</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$exclude_key</span> <span class="s">(</span><span class="i">@excluded</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$value</span>-&gt;{<span class="i">$exclude_key</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="k">delete</span> <span class="i">$value</span>-&gt;{<span class="i">$exclude_key</span>}<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">require</span> <span class="w">YAML</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$frozen</span> = <span class="i">YAML::freeze</span><span class="s">(</span><span class="i">$value</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$encode</span><span class="s">)</span> <span class="s">{</span> <span class="i">$frozen</span> = <span class="i">MIME::Base32::encode</span><span class="s">(</span><span class="i">$frozen</span><span class="s">)</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$pos</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$retval</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span><span class="i">$frozen</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$chopped</span> = <span class="k">substr</span><span class="s">(</span> <span class="i">$frozen</span><span class="cm">,</span> <span class="i">$pos</span><span class="cm">,</span> <span class="i">$MAX_LENGTH</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$chopped_length</span> = <span class="k">length</span><span class="s">(</span><span class="i">$chopped</span><span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/hidden/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$retval</span> .= <span class="q">&quot;&lt;input type='hidden' name='$name' value='$chopped'/&gt;\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/array/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@$retval</span><span class="cm">,</span> <span class="i">$chopped</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/url/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span>   <span class="s">(</span><span class="i">$retval</span><span class="s">)</span> <span class="s">{</span> <span class="i">$retval</span> .= <span class="q">&quot;&amp;$name=$chopped&quot;</span> <span class="s">}</span>
            <span class="k">else</span>           <span class="s">{</span> <span class="i">$retval</span> .= <span class="q">&quot;$name=$chopped&quot;</span> <span class="s">}</span>
        <span class="s">}</span>

        <span class="i">$frozen</span> = <span class="k">substr</span><span class="s">(</span> <span class="i">$frozen</span><span class="cm">,</span> <span class="i">$pos</span> + <span class="i">$chopped_length</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$retval</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################################################################################################</span>
<span class="c"># Safely perform the thaw/decode function on a param frozen/encoded by the Safe_Freeze function</span>
<span class="c"># Return: The original param string</span>
<span class="c">########################################################################################################</span>
<a name="Safe_Thaw-"></a><span class="k">sub </span><span class="m">Safe_Thaw</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$name</span> = <span class="i">$args</span>{-<span class="w">name</span>} || <span class="q">'Frozen_Param'</span><span class="sc">;</span>    <span class="c"># The name of the param to be thaw</span>
    <span class="k">my</span> <span class="i">$thaw</span> = <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">thaw</span>} ? <span class="i">$args</span>{-<span class="w">thaw</span>} <span class="co">:</span> <span class="n">1</span><span class="sc">;</span>    <span class="c"># Whether to thaw the string now</span>
    <span class="k">my</span> <span class="i">$encoded</span>
        = <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">encoded</span>}
        ? <span class="i">$args</span>{-<span class="w">encoded</span>}
        <span class="co">:</span> <span class="n">0</span><span class="sc">;</span>                                               <span class="c"># Whether to the param was encoded</span>
    <span class="k">my</span> <span class="i">$bless</span> = <span class="i">$args</span>{ -<span class="k">bless</span> }<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$retval</span><span class="sc">;</span>
    <span class="k">require</span> <span class="w">MIME::Base32</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="i">$name</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@input</span> = <span class="i">param</span><span class="s">(</span><span class="i">$name</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$retval</span> = <span class="k">join</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">@input</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$decoded</span> = <span class="i">$retval</span><span class="sc">;</span>
        <span class="k">require</span> <span class="w">YAML</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$encoded</span><span class="s">)</span> <span class="s">{</span> <span class="i">$decoded</span> = <span class="i">MIME::Base32::decode</span><span class="s">(</span><span class="i">$retval</span><span class="s">)</span> <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$thaw</span><span class="s">)</span>    <span class="s">{</span> <span class="i">$retval</span>  = <span class="i">YAML::thaw</span><span class="s">(</span><span class="i">$decoded</span><span class="s">)</span> <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="i">$retval</span> = <span class="s">{</span><span class="s">}</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$bless</span><span class="s">)</span> <span class="s">{</span> <span class="i">$retval</span> = <span class="k">bless</span> <span class="i">$retval</span><span class="cm">,</span> <span class="i">$bless</span> <span class="s">}</span>
    <span class="k">return</span> <span class="i">$retval</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#############################################</span>
<span class="c"># Automatic formatting check</span>
<span class="c">#</span>
<span class="c"># Return : list of errors (\n separated list)</span>
<span class="c">#############################################</span>
<a name="input_error_check-"></a><span class="k">sub </span><span class="m">input_error_check</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_ref</span>  = <span class="i">$args</span>{-<span class="w">input</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format_ref</span> = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$mandatory</span>  = <span class="i">$args</span>{-<span class="w">mandatory</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%input_args</span> = <span class="i">%</span>{<span class="i">$input_ref</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@errors</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$mandatory</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">@$mandatory</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">unless</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input_args</span>{<span class="i">$key</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@errors</span><span class="cm">,</span> <span class="q">&quot;No $key argument supplied.&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$format_ref</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{<span class="i">$format_ref</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$format</span> = <span class="i">$format_ref</span>-&gt;{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$value</span>  = <span class="i">$input_args</span>{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/^\/(.*)\/$/</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## REGEXP Check ##</span>
                <span class="k">my</span> <span class="i">$pattern</span> = <span class="i">$1</span><span class="sc">;</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="i">$input_args</span>{<span class="i">$key</span>} =~ <span class="q">/$pattern/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">push</span><span class="s">(</span> <span class="i">@errors</span><span class="cm">,</span> <span class="q">&quot;$key argument should be regexp : $pattern.&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$error_list</span> = <span class="k">join</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">@errors</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$error_list</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##########################################################################################</span>
<span class="c"># Wrapper to easily create a directory (including recursive subdirectories) as required</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># (add subdirectories to path (if required) - eg $path/2008/12/31/ )</span>
<span class="c">#</span>
<span class="c"># my $new_path = create_dir($path,-mode=&gt;751);  ## create path directory (no subdirectories)</span>
<span class="c"># my $new_path = create_dir($path, convert_date( &amp;date_time(),'YYYY/MM/DD'),'777');  ## create subdirectories for date ##</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Returns final path (0 if permission denied to create any of subdirectories)</span>
<span class="c">#################</span>
<a name="create_dir-"></a><span class="k">sub </span><span class="m">create_dir</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="k">my</span> <span class="i">%args</span>   = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'path,subdirectory,mode'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$path</span>   = <span class="i">$args</span>{-<span class="w">path</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$subdir</span> = <span class="i">$args</span>{-<span class="w">subdirectory</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$mode</span>   = <span class="i">$args</span>{-<span class="w">mode</span>} || <span class="q">'777'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@dirs</span> = <span class="s">(</span><span class="q">''</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## base directory</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$subdir</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@dirs</span><span class="cm">,</span> <span class="s">(</span> <span class="k">split</span> <span class="q">'/'</span><span class="cm">,</span> <span class="i">$subdir</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$LOGBASE</span> = <span class="i">$path</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$sub</span> <span class="s">(</span><span class="i">@dirs</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$LOGBASE</span> .= <span class="q">&quot;/$sub&quot;</span> <span class="k">if</span> <span class="i">$sub</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">-e</span> <span class="q">&quot;$LOGBASE&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$ok</span> = <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;mkdir '$LOGBASE' -m $mode&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$ok</span> =~ <span class="q">/cannot create directory/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="k">err</span> <span class="s">(</span><span class="q">&quot;Cannot create $LOGBASE&quot;</span><span class="s">)</span> <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$LOGBASE</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># Resolve a file/directory into 2 components</span>
<span class="c"># Return an array:</span>
<span class="c"># - first element: fully qualified path except the file or directory itself</span>
<span class="c"># - second element: the file or directory itself</span>
<span class="c">##############################</span>
<a name="Resolve_Path-"></a><span class="k">sub </span><span class="m">Resolve_Path</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$path</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$prefix</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dir</span><span class="sc">;</span>

    <span class="i">$path</span> =~ <span class="q">s/\/\//\//go</span><span class="sc">;</span>    <span class="c"># Replace '//' by '/'</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$path</span> =~ <span class="q">/(.*\/)(.*)/o</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$prefix</span> = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$dir</span>    = <span class="i">$2</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dir</span> = <span class="i">$path</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$prefix</span><span class="cm">,</span> <span class="i">$dir</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################################</span>
<span class="c"># Parse CSV file</span>
<span class="c">#</span>
<span class="c"># Return formats supported are:</span>
<span class="c">#</span>
<span class="c"># - AofH (The default format):</span>
<span class="c">#   $retval[0] = ('Field1' =&gt; 'Value1 of first record', 'Field2' =&gt; 'Value2 of first record')</span>
<span class="c">#   $retval[1] = ('Field1' =&gt; 'Value1 of second record', 'Field2' =&gt; 'Value2 of second record')</span>
<span class="c">#</span>
<span class="c"># - HofH (Use ONE of the retrieved fields as the key to the record hash, or use the reocrd number as the key to the record hash):</span>
<span class="c">#   a) User specified 'Field1' as the keyfield:</span>
<span class="c">#      $retval{'Value1 of first record'}{'Field2'} = 'Value2 of first record'</span>
<span class="c">#      $retval{'Value1 of second record'}{'Field2'} = 'Value2 of second record'</span>
<span class="c">#   b) User did not specified any keyfield:</span>
<span class="c">#      $retval{1}{'Field1'} = 'Value1 of first record'</span>
<span class="c">#      $retval{1}{'Field2'} = 'Value2 of first record'</span>
<span class="c">#      $retval{2}{'Field1'} = 'Value1 of second record'</span>
<span class="c">#      $retval{2}{'Field2'} = 'Value2 of second record'</span>
<span class="c">#</span>
<span class="c">##############################################</span>
<a name="Parse_CSV_File-"></a><span class="k">sub </span><span class="m">Parse_CSV_File</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$file</span>         = <span class="i">$args</span>{-<span class="w">file</span>}<span class="sc">;</span>                  <span class="c"># The file to be parsed [String]</span>
    <span class="k">my</span> <span class="i">$file_handle</span>  = <span class="i">$args</span>{-<span class="w">file_handle</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$columns_ref</span>  = <span class="i">$args</span>{-<span class="w">columns</span>}<span class="sc">;</span>               <span class="c"># The fields (field numbers) to be extraced from the file [ArrayRef of Int]</span>
    <span class="k">my</span> <span class="i">$fields_ref</span>   = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>                <span class="c"># The name of the fields extracted [ArrayRef of String] - If not specified then use the name provided in the file</span>
    <span class="k">my</span> <span class="i">$header_lines</span> = <span class="i">$args</span>{-<span class="w">header</span>}<span class="sc">;</span>                <span class="c"># The number of lines that the column header span [Int]</span>
    <span class="k">my</span> <span class="i">$delimiter</span>    = <span class="i">$args</span>{-<span class="w">delimiter</span>}<span class="sc">;</span>             <span class="c"># The separator/delimiter to separate the columns</span>
    <span class="k">my</span> <span class="i">$exclude</span>      = <span class="i">$args</span>{-<span class="w">exclude</span>}<span class="sc">;</span>               <span class="c"># Lines to exclude from parsing</span>
    <span class="k">my</span> <span class="i">$replace</span>      = <span class="i">$args</span>{-<span class="w">replace</span>}<span class="sc">;</span>               <span class="c"># Replace character with blank</span>
    <span class="k">my</span> <span class="i">$format</span>       = <span class="i">$args</span>{<span class="q">'-format'</span>} || <span class="q">'AofH'</span><span class="sc">;</span>    <span class="c"># Return format</span>
    <span class="k">my</span> <span class="i">$keyfield</span>     = <span class="i">$args</span>{-<span class="w">keyfield</span>}<span class="sc">;</span>              <span class="c"># The keyfield to be used if return format is 'HofH'</span>
    <span class="k">my</span> <span class="i">$CSV_FILE</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$file</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="i">$CSV_FILE</span><span class="cm">,</span> <span class="q">&quot;$file&quot;</span> <span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;Error opening file: '$file'&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;&gt;&gt;Parsing '$file'...&lt;br&gt;\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$file_handle</span><span class="s">)</span> <span class="s">{</span>

        <span class="i">$CSV_FILE</span> = <span class="i">$file_handle</span><span class="sc">;</span>

        <span class="c">#print $CSV_FILE;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$added</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tried</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@failed</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$line_num</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$skipped</span>  = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@columns</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$columns_ref</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$columns_ref</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$columns_ref</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'arrayref'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">@columns</span> = <span class="i">@$columns_ref</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields_ref</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$fields_ref</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields_ref</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'arrayref'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">@fields</span> = <span class="i">@$fields_ref</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#if ($columns_ref){</span>

    <span class="c">#    }</span>

    <span class="c">#   if ($fields_ref)</span>
    <span class="c">#  {</span>

    <span class="c">#    }</span>
    <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$retval</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span><span class="q">&lt;$CSV_FILE&gt;</span><span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$line</span> = <span class="i">$_</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$exclude</span> &amp;&amp; <span class="i">$line</span> =~ <span class="q">/^$exclude/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$skipped</span>++<span class="sc">;</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$replace</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$line</span> =~ <span class="q">s/$replace//g</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c">## replace character with blank.</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/(.*\S)/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$line</span> = <span class="i">$1</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c">## clear NT linebreak (chomp doesn't seem to do it ??)</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="i">$delimiter</span> &amp;&amp; !<span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/\t/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">next</span><span class="sc">;</span>

            <span class="c">#if (!($line=~/\S/)) {next;}</span>
            <span class="c">#print &quot;\nWarning:  Line $i contains no tabs\n\n&quot;;</span>
        <span class="s">}</span>
        <span class="i">$line_num</span>++<span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$header_lines</span> &gt;= <span class="i">$line_num</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="q">&quot;skipping line $line_num (header)\n&quot;</span><span class="sc">;</span>
            <span class="k">next</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/\S/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>

        <span class="k">my</span> <span class="i">@values</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@fields</span><span class="s">)</span> &lt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">####### Get fields from first row of data ########</span>
            <span class="i">@fields</span> = <span class="i">&amp;_get_CSV_data</span><span class="s">(</span> <span class="i">$line</span><span class="cm">,</span> \<span class="i">@columns</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$delimiter</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">print</span> <span class="q">&quot;Extracting fields: &quot;</span><span class="sc">;</span>
            <span class="k">print</span> <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@fields</span><span class="sc">;</span>
            <span class="k">print</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">@values</span> = <span class="i">&amp;_get_CSV_data</span><span class="s">(</span> <span class="i">$line</span><span class="cm">,</span> \<span class="i">@columns</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$delimiter</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># add quotes if nec.</span>
                                                                            <span class="c">#print @values;</span>

            <span class="k">my</span> <span class="i">%data</span> = <span class="k">map</span> <span class="s">{</span> <span class="i">$fields</span>[<span class="i">$_</span>]<span class="cm">,</span> <span class="i">$values</span>[<span class="i">$_</span>] <span class="s">}</span> <span class="s">(</span> <span class="n">0</span> .. <span class="i">$#fields</span> <span class="s">)</span><span class="sc">;</span>

            <span class="c">#print Dumper \%data;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/\bAofH\b/io</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@$retval</span><span class="cm">,</span> \<span class="i">%data</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/\bHofH\b/io</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$keyfield</span> &amp;&amp; <span class="k">exists</span> <span class="i">$data</span>{<span class="i">$keyfield</span>} <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$retval</span>-&gt;{ <span class="i">$data</span>{<span class="i">$keyfield</span>} } = \<span class="i">%data</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="i">$retval</span>-&gt;{ <span class="i">$i</span> + <span class="n">1</span> } = \<span class="i">%data</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="i">$i</span>++<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">close</span><span class="s">(</span><span class="i">$CSV_FILE</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$retval</span><span class="sc">;</span>
<span class="s">}</span>

<a name="strim-"></a><span class="k">sub </span><span class="m">strim</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$string</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$size</span> = <span class="k">shift</span> || <span class="n">10</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$string</span><span class="s">)</span> &gt; <span class="i">$size</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">substr</span><span class="s">(</span> <span class="i">$string</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$size</span> <span class="s">)</span> . <span class="q">'...'</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$string</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">###################</span>
<span class="c">#</span>
<span class="c"># Truncates a string given a length argument. If longer than length appends ... to the end of string</span>
<span class="c">#  (only cuts off at the end of a word, not in the middle)</span>
<span class="c">#</span>
<span class="c">###################</span>
<a name="truncate_string-"></a><span class="k">sub </span><span class="m">truncate_string</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">%args</span>            = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'string,length,tip'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_string</span> = <span class="i">$args</span>{-<span class="w">string</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$length</span>          = <span class="i">$args</span>{ -<span class="k">length</span> }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$link</span>            = <span class="i">$args</span>{-<span class="w">tip</span>}<span class="sc">;</span>                                          <span class="c">## show full string as tool tip</span>

    <span class="k">my</span> <span class="i">$size</span>   = <span class="k">length</span> <span class="i">$original_string</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$string</span> = <span class="i">$original_string</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$size</span> &gt; <span class="i">$length</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$string</span> = <span class="k">substr</span><span class="s">(</span> <span class="i">$string</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$length</span> <span class="s">)</span><span class="sc">;</span>
        <span class="c">### If the string is not one giant word ...</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$string</span> =~ <span class="q">/\W/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$string</span> =~ <span class="q">s/\w+$//</span><span class="sc">;</span>                                                <span class="c">### cut off the last word</span>
        <span class="s">}</span>
        <span class="i">$string</span> .= <span class="q">&quot;...&quot;</span><span class="sc">;</span>

        <span class="c">#	$string .= &quot;($size)&quot;;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$link</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">return</span> <span class="i">Show_Tool_Tip</span><span class="s">(</span> <span class="i">$string</span><span class="cm">,</span> <span class="i">$original_string</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$string</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">#############################</span>
<span class="c">#</span>
<span class="c">#  Encodes a variable reference</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#############################</span>
<a name="encode_var-"></a><span class="k">sub </span><span class="m">encode_var</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$data</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span> = <span class="k">ref</span><span class="s">(</span><span class="i">$data</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@list</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/HASH/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@list</span> = <span class="i">%</span>{<span class="i">$data</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/ARRAY/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@list</span> = <span class="i">@</span>{<span class="i">$data</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/SCALAR/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@list</span><span class="cm">,</span> <span class="i">$$data</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@list</span><span class="cm">,</span> <span class="i">$data</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@encoded</span> = <span class="s">(</span><span class="i">$type</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="s">(</span><span class="i">@list</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$ascii</span> = <span class="k">unpack</span><span class="s">(</span> <span class="q">&quot;H*&quot;</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$ascii</span> =~ <span class="q">s/[a-zA-Z0-9\-\(\) :\.]//g</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@encoded</span><span class="cm">,</span> <span class="i">$ascii</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> \<span class="i">@encoded</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<span class="c">#</span>
<span class="c">#  Decodes an encoded array into its proper variable</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">############################</span>
<a name="decode_var-"></a><span class="k">sub </span><span class="m">decode_var</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$data</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@encoded</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$data</span><span class="s">)</span> =~ <span class="q">/ARRAY/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@encoded</span> = <span class="i">@</span>{<span class="i">$data</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;Invalid encoded list\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$type</span> = <span class="k">shift</span><span class="s">(</span><span class="i">@encoded</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/HASH/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%decode</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span><span class="i">@encoded</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$key</span>   = <span class="k">shift</span><span class="s">(</span><span class="i">@encoded</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$value</span> = <span class="k">shift</span><span class="s">(</span><span class="i">@encoded</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">$decode</span>{ <span class="k">pack</span><span class="s">(</span> <span class="q">&quot;H*&quot;</span><span class="cm">,</span> <span class="i">$key</span> <span class="s">)</span> } = <span class="k">pack</span><span class="s">(</span> <span class="q">&quot;H*&quot;</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">return</span> \<span class="i">%decode</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/ARRAY/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@decode</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span><span class="i">@encoded</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@decode</span><span class="cm">,</span> <span class="k">pack</span><span class="s">(</span> <span class="q">&quot;H*&quot;</span><span class="cm">,</span> <span class="k">shift</span><span class="s">(</span><span class="i">@encoded</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">return</span> \<span class="i">@decode</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/SCALAR/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$decode</span> = <span class="k">pack</span><span class="s">(</span> <span class="q">&quot;H*&quot;</span><span class="cm">,</span> <span class="k">shift</span><span class="s">(</span><span class="i">@encoded</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> \<span class="i">$decode</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">pack</span><span class="s">(</span> <span class="q">&quot;H*&quot;</span><span class="cm">,</span> <span class="k">shift</span><span class="s">(</span><span class="i">@encoded</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># check the number of days elapsed since a date</span>
<span class="c"># date format: yyyy-mm-dd-hh-mm-ss</span>
<span class="c">##############################</span>
<a name="day_elapsed-"></a><span class="k">sub </span><span class="m">day_elapsed</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">$day</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Error: $0: wrong date format: $day  &quot;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$day</span> !~ <span class="q">/^\d\d\d\d-\d\d-\d\d-\d\d-\d\d-\d\d/</span><span class="sc">;</span>
    <span class="i">$day</span> =~ <span class="q">/^(\d\d\d\d)-(\d\d)-(\d\d)-(\d\d)-(\d\d)-(\d\d)/</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$year</span>  = <span class="i">$1</span> - <span class="n">1900</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$month</span> = <span class="i">$2</span> - <span class="n">1</span><span class="sc">;</span>

    <span class="i">$day</span> = <span class="i">$3</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$hour</span>   = <span class="i">$4</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$minute</span> = <span class="i">$5</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$second</span> = <span class="i">$6</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$pastTime</span> = <span class="i">Time::Local::timelocal</span><span class="s">(</span> <span class="i">$second</span><span class="cm">,</span> <span class="i">$minute</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$day</span><span class="cm">,</span> <span class="i">$month</span><span class="cm">,</span> <span class="i">$year</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$daysElapsed</span> = <span class="s">(</span> <span class="k">time</span> - <span class="i">$pastTime</span> <span class="s">)</span> / <span class="n">86400</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$daysElapsed</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<a name="compare_objects-"></a><span class="k">sub </span><span class="m">compare_objects</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="c">#    my %args = @_;</span>
    <span class="c">#    my $object1 = $args{1};</span>
    <span class="c">#    my $object2 = $args{2};</span>

    <span class="k">my</span> <span class="i">$object1</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$object2</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$Data::Dumper::Sortkeys</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$string1</span> = <span class="i">Dumper</span><span class="s">(</span><span class="i">$object1</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$string2</span> = <span class="i">Dumper</span><span class="s">(</span><span class="i">$object2</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">## clear quotes to remove issues with quoting integers ##</span>
    <span class="i">$string1</span> =~ <span class="q">s/\'//g</span><span class="sc">;</span>
    <span class="i">$string2</span> =~ <span class="q">s/\'//g</span><span class="sc">;</span>

    <span class="k">if</span>   <span class="s">(</span> <span class="i">$string1</span> <span class="k">eq</span> <span class="i">$string2</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="n">1</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">else</span>                          <span class="s">{</span> <span class="k">return</span> <span class="n">0</span><span class="sc">;</span> <span class="s">}</span>
<span class="s">}</span>

<span class="c">########################</span>
<span class="c">#  Method compares 2 data structures recursively</span>
<span class="c">#</span>
<span class="c">#  e.g.  In this example 2 data structures were read in from 2 files, converted to objects, and compared</span>
<span class="c">#</span>
<span class="c">#  open(READ1,&quot;$file1&quot;)||die &quot;Cannot open file $file1\n&quot;;</span>
<span class="c">#  open(READ2,&quot;$file2&quot;)||die &quot;Cannot open file $file2\n&quot;;</span>
<span class="c">#  my @data1 = &lt;READ1&gt;;</span>
<span class="c">#  my @data2 = &lt;READ2&gt;;</span>
<span class="c">#  close(READ1);</span>
<span class="c">#  close(READ2);</span>
<span class="c">#  my $start1 = 0;</span>
<span class="c">#  my $start2 = 0;</span>
<span class="c">#  my %struct1;</span>
<span class="c">#  my %struct2;</span>
<span class="c">#  my $struct1 = read_dumper(\@data1,\$start1,\%struct1);</span>
<span class="c">#  my $struct2 = read_dumper(\@data2,\$start2,\%struct2);</span>
<span class="c">#</span>
<span class="c">#  my @comments;</span>
<span class="c">#  my $same = compare_data(1=&gt;$struct1,</span>
<span class="c">#  			2=&gt;$struct2,</span>
<span class="c">#  			-comment=&gt;\@comments,</span>
<span class="c">#  			-case_insensitive=&gt;1</span>
<span class="c">#  );</span>

<span class="c">#####################</span>
<a name="compare_data-"></a><span class="k">sub </span><span class="m">compare_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">%args</span>        = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$struct1</span>     = <span class="i">$args</span>{<span class="n">1</span>}<span class="sc">;</span>                         <span class="c"># first data structure</span>
    <span class="k">my</span> <span class="i">$struct2</span>     = <span class="i">$args</span>{<span class="n">2</span>}<span class="sc">;</span>                         <span class="c"># second data structure</span>
    <span class="k">my</span> <span class="i">$comment</span>     = <span class="i">$args</span>{-<span class="w">comment</span>}<span class="sc">;</span>                  <span class="c"># reference to array for storing comments of where the differences are</span>
    <span class="k">my</span> <span class="i">$ignore_case</span> = <span class="i">$args</span>{-<span class="w">case_insensitive</span>} || <span class="n">0</span><span class="sc">;</span>    <span class="c"># option to ignore case difference</span>

    <span class="c">########################</span>
    <span class="c">## different data type</span>
    <span class="c">########################</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$struct1</span><span class="s">)</span> <span class="k">ne</span> <span class="k">ref</span><span class="s">(</span><span class="i">$struct2</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">_record_diff_struct</span><span class="s">(</span> <span class="i">$struct1</span><span class="cm">,</span> <span class="i">$struct2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different data structures: &quot;</span> . <span class="k">ref</span><span class="s">(</span><span class="i">$struct1</span><span class="s">)</span> . <span class="q">&quot;, &quot;</span> . <span class="k">ref</span><span class="s">(</span><span class="i">$struct2</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">########################</span>
    <span class="c">## comparing arrays</span>
    <span class="c">########################</span>
    <span class="c"># limitation of array comparison: reference elments have to be in same order in array</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$struct1</span><span class="s">)</span> <span class="k">eq</span> <span class="q">&quot;ARRAY&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@$struct1</span><span class="s">)</span> != <span class="k">scalar</span><span class="s">(</span><span class="i">@$struct2</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># different sizes</span>
            <span class="i">_record_diff_struct</span><span class="s">(</span> <span class="i">$struct1</span><span class="cm">,</span> <span class="i">$struct2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different array sizes: &quot;</span> . <span class="k">scalar</span><span class="s">(</span><span class="i">@$struct1</span><span class="s">)</span> . <span class="q">&quot;, &quot;</span> . <span class="k">scalar</span><span class="s">(</span><span class="i">@$struct2</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># first check the number of reference elements in both arrays</span>
        <span class="c"># sort elements by non-ref and ref</span>
        <span class="k">my</span> <span class="i">@non_ref1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@non_ref2</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@ref1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@ref2</span><span class="sc">;</span>
        <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt; <span class="k">scalar</span><span class="s">(</span><span class="i">@$struct1</span><span class="s">)</span><span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@non_ref1</span><span class="cm">,</span> <span class="i">$$struct1</span>[<span class="i">$i</span>] <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span> <span class="i">$$struct1</span>[<span class="i">$i</span>] <span class="s">)</span> <span class="k">eq</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@non_ref2</span><span class="cm">,</span> <span class="i">$$struct2</span>[<span class="i">$i</span>] <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span> <span class="i">$$struct2</span>[<span class="i">$i</span>] <span class="s">)</span> <span class="k">eq</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@ref1</span><span class="cm">,</span> <span class="i">$$struct1</span>[<span class="i">$i</span>] <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span> <span class="i">$$struct1</span>[<span class="i">$i</span>] <span class="s">)</span> <span class="k">ne</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@ref2</span><span class="cm">,</span> <span class="i">$$struct2</span>[<span class="i">$i</span>] <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span> <span class="i">$$struct2</span>[<span class="i">$i</span>] <span class="s">)</span> <span class="k">ne</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@ref1</span><span class="s">)</span> != <span class="k">scalar</span><span class="s">(</span><span class="i">@ref2</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># different sizes</span>
            <span class="i">_record_diff_struct</span><span class="s">(</span> \<span class="i">@ref1</span><span class="cm">,</span> \<span class="i">@ref2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different reference element sizes: &quot;</span> . <span class="k">scalar</span><span class="s">(</span><span class="i">@ref1</span><span class="s">)</span> . <span class="q">&quot;, &quot;</span> . <span class="k">scalar</span><span class="s">(</span><span class="i">@ref2</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># compare non-ref arrays</span>
        <span class="i">@non_ref1</span> = <span class="k">sort</span> <span class="i">@non_ref1</span><span class="sc">;</span>
        <span class="i">@non_ref2</span> = <span class="k">sort</span> <span class="i">@non_ref2</span><span class="sc">;</span>
        <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt; <span class="k">scalar</span><span class="s">(</span><span class="i">@non_ref1</span><span class="s">)</span><span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$elem1</span> = <span class="i">$non_ref1</span>[<span class="i">$i</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$elem2</span> = <span class="i">$non_ref2</span>[<span class="i">$i</span>]<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$ignore_case</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">$elem1</span> = <span class="k">lc</span><span class="s">(</span><span class="i">$elem1</span><span class="s">)</span><span class="sc">;</span>
                <span class="i">$elem2</span> = <span class="k">lc</span><span class="s">(</span><span class="i">$elem2</span><span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$elem1</span> <span class="k">ne</span> <span class="i">$elem2</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">_record_diff_struct</span><span class="s">(</span> \<span class="i">@non_ref1</span><span class="cm">,</span> \<span class="i">@non_ref2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different non-reference elements: $elem1, $elem2&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="c"># compare arrays of references</span>
        <span class="c"># this is tricky because can't be sure which element to be compared with which element in 2 arrays</span>
        <span class="c"># (1) compare array 1 to itself and array 2 to itself, form non-redundant set and keep track of the number of copies for each non-redundant element</span>

        <span class="k">my</span> <span class="i">%array1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$keyCount</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="s">(</span><span class="i">@ref1</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$found</span> = <span class="n">0</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%array1</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">@comments</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">compare_data</span><span class="s">(</span>
                        <span class="n">1</span>                 <span class="cm">=&gt;</span> <span class="i">$_</span><span class="cm">,</span>
                        <span class="n">2</span>                 <span class="cm">=&gt;</span> <span class="i">$array1</span>{<span class="i">$key</span>}{<span class="w">value</span>}<span class="cm">,</span>
                        -<span class="w">comment</span>          <span class="cm">=&gt;</span> \<span class="i">@comments</span><span class="cm">,</span>
                        -<span class="w">case_insensitive</span> <span class="cm">=&gt;</span> <span class="i">$ignore_case</span>
                    <span class="s">)</span>
                    <span class="s">)</span>
                <span class="s">{</span>
                    <span class="i">$array1</span>{<span class="i">$key</span>}{<span class="w">count</span>}++<span class="sc">;</span>
                    <span class="i">$found</span> = <span class="n">1</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> !<span class="i">$found</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$array1</span>{<span class="i">$keyCount</span>}{<span class="w">value</span>} = <span class="i">$_</span><span class="sc">;</span>
                <span class="i">$array1</span>{<span class="i">$keyCount</span>}{<span class="w">count</span>} = <span class="n">1</span><span class="sc">;</span>
                <span class="i">$keyCount</span>++<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">%array2</span><span class="sc">;</span>
        <span class="i">$keyCount</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="s">(</span><span class="i">@ref2</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$found</span> = <span class="n">0</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%array2</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">@comments</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">compare_data</span><span class="s">(</span>
                        <span class="n">1</span>                 <span class="cm">=&gt;</span> <span class="i">$_</span><span class="cm">,</span>
                        <span class="n">2</span>                 <span class="cm">=&gt;</span> <span class="i">$array2</span>{<span class="i">$key</span>}{<span class="w">value</span>}<span class="cm">,</span>
                        -<span class="w">comment</span>          <span class="cm">=&gt;</span> \<span class="i">@comments</span><span class="cm">,</span>
                        -<span class="w">case_insensitive</span> <span class="cm">=&gt;</span> <span class="i">$ignore_case</span>
                    <span class="s">)</span>
                    <span class="s">)</span>
                <span class="s">{</span>
                    <span class="i">$array2</span>{<span class="i">$key</span>}{<span class="w">count</span>}++<span class="sc">;</span>
                    <span class="i">$found</span> = <span class="n">1</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> !<span class="i">$found</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$array2</span>{<span class="i">$keyCount</span>}{<span class="w">value</span>} = <span class="i">$_</span><span class="sc">;</span>
                <span class="i">$array2</span>{<span class="i">$keyCount</span>}{<span class="w">count</span>} = <span class="n">1</span><span class="sc">;</span>
                <span class="i">$keyCount</span>++<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="c"># (2) compare non-redundant arrays 1 and 2, each element should have exactly 1 match</span>
        <span class="c"># (2.1) first check non-redundant sizes</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span> <span class="k">keys</span> <span class="i">%array1</span> <span class="s">)</span> != <span class="k">scalar</span><span class="s">(</span> <span class="k">keys</span> <span class="i">%array2</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">_record_diff_struct</span><span class="s">(</span> \<span class="i">%array1</span><span class="cm">,</span> \<span class="i">%array2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different non-redundant array sizes: &quot;</span> . <span class="k">scalar</span><span class="s">(</span> <span class="k">keys</span> <span class="i">%array1</span> <span class="s">)</span> . <span class="q">&quot;, &quot;</span> . <span class="k">scalar</span><span class="s">(</span> <span class="k">keys</span> <span class="i">%array2</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># (2.2) compare elements</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%array1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$found_match</span> = <span class="n">0</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%array2</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">@comments</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">compare_data</span><span class="s">(</span>
                        <span class="n">1</span>                 <span class="cm">=&gt;</span> <span class="i">$array1</span>{<span class="i">$key</span>}{<span class="w">value</span>}<span class="cm">,</span>
                        <span class="n">2</span>                 <span class="cm">=&gt;</span> <span class="i">$array2</span>{<span class="i">$_</span>}{<span class="w">value</span>}<span class="cm">,</span>
                        -<span class="w">comment</span>          <span class="cm">=&gt;</span> \<span class="i">@comments</span><span class="cm">,</span>
                        -<span class="w">case_insensitive</span> <span class="cm">=&gt;</span> <span class="i">$ignore_case</span>
                    <span class="s">)</span>
                    <span class="s">)</span>
                <span class="s">{</span>

                    <span class="c"># if there is a match, check to see if the # of copies of each non-redundant element in each array is same</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="i">$array1</span>{<span class="i">$key</span>}{<span class="w">count</span>} != <span class="i">$array2</span>{<span class="i">$_</span>}{<span class="w">count</span>} <span class="s">)</span> <span class="s">{</span>
                        <span class="i">_record_diff_struct</span><span class="s">(</span> \<span class="i">%array1</span><span class="cm">,</span> \<span class="i">%array2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Matching non-redundant elements in array 1 (key $key) and array 2 (key $_) have different # of copies of redundant elements: $array1{$key}{count}, $array2{$_}{count}&quot;</span> <span class="s">)</span><span class="sc">;</span>
                        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
                    <span class="s">}</span>
                    <span class="i">$found_match</span> = <span class="n">1</span><span class="sc">;</span>
                    <span class="k">last</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> !<span class="i">$found_match</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">_record_diff_struct</span><span class="s">(</span> \<span class="i">%array1</span><span class="cm">,</span> \<span class="i">%array2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Element (key $key) in array 1 has no match in array 2&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">########################</span>
    <span class="c">## comparing hashes</span>
    <span class="c">########################</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$struct1</span><span class="s">)</span> <span class="k">eq</span> <span class="q">&quot;HASH&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">### first compare keys</span>
        <span class="k">my</span> <span class="i">@struct1keys</span> = <span class="k">sort</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$struct1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@struct2keys</span> = <span class="k">sort</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$struct2</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@struct1keys</span><span class="s">)</span> != <span class="k">scalar</span><span class="s">(</span><span class="i">@struct2keys</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># different key size</span>
            <span class="i">_record_diff_struct</span><span class="s">(</span> \<span class="i">@struct1keys</span><span class="cm">,</span> \<span class="i">@struct2keys</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different hash key sizes: &quot;</span> . <span class="k">scalar</span><span class="s">(</span><span class="i">@struct1keys</span><span class="s">)</span> . <span class="q">&quot;, &quot;</span> . <span class="k">scalar</span><span class="s">(</span><span class="i">@struct2keys</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt; <span class="k">scalar</span><span class="s">(</span><span class="i">@struct1keys</span><span class="s">)</span><span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>

            <span class="c"># compare keys</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$struct1keys</span>[<span class="i">$i</span>] <span class="k">ne</span> <span class="i">$struct2keys</span>[<span class="i">$i</span>] <span class="s">)</span> <span class="s">{</span>
                <span class="i">_record_diff_struct</span><span class="s">(</span> \<span class="i">@struct1keys</span><span class="cm">,</span> \<span class="i">@struct2keys</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different hash keys: $struct1keys[$i], $struct2keys[$i]&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">my</span> <span class="i">$elem1</span> = <span class="i">$$struct1</span>{ <span class="i">$struct1keys</span>[<span class="i">$i</span>] }<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$elem2</span> = <span class="i">$$struct2</span>{ <span class="i">$struct2keys</span>[<span class="i">$i</span>] }<span class="sc">;</span>

            <span class="c"># compare element types</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$elem1</span><span class="s">)</span> <span class="k">ne</span> <span class="k">ref</span><span class="s">(</span><span class="i">$elem2</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">_record_diff_struct</span><span class="s">(</span> <span class="i">$struct1</span><span class="cm">,</span> <span class="i">$struct2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different hash element types: &quot;</span> . <span class="k">ref</span><span class="s">(</span><span class="i">$elem1</span><span class="s">)</span> . <span class="q">&quot;, &quot;</span> . <span class="k">ref</span><span class="s">(</span><span class="i">$elem2</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span>

            <span class="c"># compare non-ref elements</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$elem1</span><span class="s">)</span> <span class="k">eq</span> <span class="q">&quot;&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$ignore_case</span><span class="s">)</span> <span class="s">{</span>
                    <span class="i">$elem1</span> = <span class="k">lc</span><span class="s">(</span><span class="i">$elem1</span><span class="s">)</span><span class="sc">;</span>
                    <span class="i">$elem2</span> = <span class="k">lc</span><span class="s">(</span><span class="i">$elem2</span><span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$elem1</span> <span class="k">ne</span> <span class="i">$elem2</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">_record_diff_struct</span><span class="s">(</span> <span class="i">$struct1</span><span class="cm">,</span> <span class="i">$struct2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different hash elements on key $struct1keys[$i]: $elem1, $elem2&quot;</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>

            <span class="c"># compare ref elements</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$same</span> = <span class="i">compare_data</span><span class="s">(</span>
                    <span class="n">1</span>                 <span class="cm">=&gt;</span> <span class="i">$elem1</span><span class="cm">,</span>
                    <span class="n">2</span>                 <span class="cm">=&gt;</span> <span class="i">$elem2</span><span class="cm">,</span>
                    -<span class="w">comment</span>          <span class="cm">=&gt;</span> <span class="i">$comment</span><span class="cm">,</span>
                    -<span class="w">case_insensitive</span> <span class="cm">=&gt;</span> <span class="i">$ignore_case</span>
                <span class="s">)</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> !<span class="i">$same</span> <span class="s">)</span> <span class="s">{</span>

                    <span class="c">#		    _record_diff_struct($struct1,$struct2,$comment,&quot;Hash values (ref) on key $struct1keys[$i] are different&quot;);</span>
                    <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">########################</span>
    <span class="c">## comparing scalars</span>
    <span class="c">########################</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$struct1</span><span class="s">)</span> <span class="k">eq</span> <span class="q">&quot;SCALAR&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$$struct1</span> <span class="k">ne</span> <span class="i">$$struct2</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">_record_diff_struct</span><span class="s">(</span> <span class="i">$struct1</span><span class="cm">,</span> <span class="i">$struct2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different scalars&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">########################</span>
    <span class="c">## comparing non-reference scalars</span>
    <span class="c">########################</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$struct1</span><span class="s">)</span> <span class="k">eq</span> <span class="q">&quot;&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$struct1</span> <span class="k">ne</span> <span class="i">$struct2</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">_record_diff_struct</span><span class="s">(</span> <span class="i">$struct1</span><span class="cm">,</span> <span class="i">$struct2</span><span class="cm">,</span> <span class="i">$comment</span><span class="cm">,</span> <span class="q">&quot;Different non-ref scalars&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">########################</span>
    <span class="c">## other types</span>
    <span class="c">########################</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">die</span> <span class="q">&quot;Error:  Invalid type: &quot;</span> . <span class="k">ref</span><span class="s">(</span><span class="i">$struct1</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># read Data::Dumper output (as array of lines) and regenerate original data structure</span>
<span class="c">#</span>
<span class="c">#  my $start = 0;                                                          # line index for @inputArray, which contains data dump</span>
<span class="c">#  my %structure;</span>
<span class="c">#  my $structureRef = &amp;read_dumper(\@inputArray,\$start,\%structure);</span>
<span class="c">#</span>
<span class="c">#  e.g.</span>
<span class="c">#  $VAR1 = {</span>
<span class="c">#            'library_started' =&gt; [</span>
<span class="c">#                                   'Sep-07-2000',</span>
<span class="c">#                                   'Sep-07-2000'</span>
<span class="c">#                                 ]</span>
<span class="c">#  Put this into @inputArray:</span>
<span class="c">#</span>
<span class="c">#  [0]            'library_started' =&gt; [</span>
<span class="c">#  [1]                                   'Sep-07-2000',</span>
<span class="c">#  [2]                                   'Sep-07-2000'</span>
<span class="c">#  [3]                                 ]</span>
<span class="c">#</span>
<span class="c">#  Known bug: Alteration to structure when parsing a string with multiple lines</span>
<span class="c">###############</span>
<a name="read_dumper-"></a><span class="k">sub </span><span class="m">read_dumper</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$dataRef</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># reference to array containing data dump</span>
    <span class="k">my</span> <span class="i">$lineRef</span> = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># line index for @inputArray, which contains data dump</span>
    <span class="k">my</span> <span class="i">$self</span>    = <span class="k">shift</span><span class="sc">;</span>    <span class="c"># data structure</span>

    <span class="k">my</span> <span class="i">$line</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span><span class="n">1</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$dataSize</span> = <span class="i">@$dataRef</span> - <span class="n">1</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$$lineRef</span> &gt; <span class="i">$dataSize</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$line</span> = <span class="i">$$dataRef</span>[<span class="i">$$lineRef</span>]<span class="sc">;</span>
        <span class="i">$$lineRef</span>++<span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/(?:\[|\{)(?:\]|\})/</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># empty hash or array</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/\]|\}/</span> <span class="s">)</span> <span class="s">{</span>              <span class="c"># end of an array or hash</span>
            <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/\[|\{/</span> <span class="s">)</span> <span class="s">{</span>              <span class="c"># start of an array or hash</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/\[/</span> <span class="s">)</span> <span class="s">{</span>                <span class="c"># array</span>
                <span class="i">$line</span> =~ <span class="q">/\'([\w\d\-]+)\' \=\&gt;/</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">@newArray</span>    = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$newArrayRef</span> = \<span class="i">@newArray</span><span class="sc">;</span>
                <span class="i">$newArrayRef</span> = <span class="i">&amp;read_dumper</span><span class="s">(</span> <span class="i">$dataRef</span><span class="cm">,</span> <span class="i">$lineRef</span><span class="cm">,</span> <span class="i">$newArrayRef</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$$self</span>{<span class="i">$1</span>} = <span class="i">$newArrayRef</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/\{/</span> <span class="s">)</span> <span class="s">{</span>             <span class="c"># hash</span>
                <span class="i">$line</span> =~ <span class="q">/\'([\w\d\-]+)\' \=\&gt;/</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">%newHash</span>    = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$newHashRef</span> = \<span class="i">%newHash</span><span class="sc">;</span>
                <span class="i">$newHashRef</span> = <span class="i">&amp;read_dumper</span><span class="s">(</span> <span class="i">$dataRef</span><span class="cm">,</span> <span class="i">$lineRef</span><span class="cm">,</span> <span class="i">$newHashRef</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$$self</span>{<span class="i">$1</span>} = <span class="i">$newHashRef</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">die</span> <span class="q">&quot;$0: unknown line $line &quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/\=\&gt;/</span> <span class="s">)</span> <span class="s">{</span>               <span class="c"># part of a hash</span>
            <span class="i">$line</span> =~ <span class="q">/\'([\w\d\-]+)\' \=\&gt; \'?(.*?)\'?,?$/</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$2</span> <span class="k">eq</span> <span class="q">&quot;undef&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$$self</span>{<span class="i">$1</span>} = <span class="k">undef</span><span class="sc">;</span>               <span class="c"># comment this line if you don't want to create an undef element</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$value</span> = <span class="i">$2</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$key</span>   = <span class="i">$1</span><span class="sc">;</span>
                <span class="i">$value</span> =~ <span class="q">s/\\\'/\'/g</span><span class="sc">;</span>
                <span class="i">$$self</span>{<span class="i">$key</span>} = <span class="i">$value</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/\'?.*\'?,?$/</span> <span class="s">)</span> <span class="s">{</span>        <span class="c"># part of an array</span>
            <span class="i">$line</span> =~ <span class="q">/^\s*\'?(.*?)\'?,?$/</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$1</span> <span class="k">eq</span> <span class="q">&quot;undef&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@$self</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>            <span class="c"># comment this line if you don't want to create an undef element</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$value</span> = <span class="i">$1</span><span class="sc">;</span>
                <span class="i">$value</span> =~ <span class="q">s/\\\'/\'/g</span><span class="sc">;</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@$self</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">print</span> <span class="q">&quot;Line $$lineRef\t$line\nSelf:\n&quot;</span><span class="sc">;</span>
            <span class="k">print</span> <span class="i">Dumper</span> <span class="i">$self</span><span class="sc">;</span>
            <span class="k">die</span> <span class="q">&quot;$0: Unable to process line.  &quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c"># Remove files in a given directory that haven't been accessed for a given number of days</span>
<span class="c">#</span>
<span class="c"># Usage: unlink_old_file(-dir=&gt;$rysnc_dir,-days=&gt;30);</span>
<span class="c">#</span>
<span class="c"># Example: unlink_old_file(-dir=&gt;&quot;/home/aldente/public/logs/File_Transfers/rsync&quot;,-days=&gt;30);</span>
<span class="c">############################</span>
<a name="unlink_old_file-"></a><span class="k">sub </span><span class="m">unlink_old_file</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">%args</span>         = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dir,days'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'dir,days'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dir</span>          = <span class="i">$args</span>{-<span class="w">dir</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$days</span>         = <span class="i">$args</span>{-<span class="w">days</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@files</span>        = <span class="k">glob</span><span class="s">(</span><span class="q">&quot;$dir/*&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$cut_off_date</span> = <span class="w">strftime</span> <span class="q">&quot;%Y%m%d%H%M%S&quot;</span><span class="cm">,</span> <span class="k">localtime</span><span class="s">(</span> <span class="k">time</span> - <span class="s">(</span> <span class="n">86400</span> * <span class="i">$days</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$file</span> <span class="s">(</span><span class="i">@files</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$access_time</span><span class="s">)</span> = <span class="s">(</span> <span class="k">stat</span><span class="s">(</span><span class="i">$file</span><span class="s">)</span> <span class="s">)</span>[<span class="n">8</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$file_date</span> = <span class="w">strftime</span> <span class="q">&quot;%Y%m%d%H%M%S&quot;</span><span class="cm">,</span> <span class="k">localtime</span><span class="s">(</span><span class="i">$access_time</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">-f</span> <span class="i">$file</span> &amp;&amp; <span class="i">$file_date</span> &lt; <span class="i">$cut_off_date</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="q">&quot;unlink $file\n&quot;</span><span class="sc">;</span>
            <span class="k">unlink</span><span class="s">(</span><span class="i">$file</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">#&lt;snip&gt;</span>
<span class="c">#Usage: my $success = replace_last_line(-file=&gt;&quot;$full_path&quot;,-newline=&gt;&quot;$new_line&quot;);</span>
<span class="c">#&lt;/snip&gt;</span>
<span class="c">########################</span>
<a name="replace_last_line-"></a><span class="k">sub </span><span class="m">replace_last_line</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">%args</span>    = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">&quot;file,newline&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$file</span>    = <span class="i">$args</span>{-<span class="w">file</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$newline</span> = <span class="i">$args</span>{-<span class="w">newline</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">-f</span> <span class="q">&quot;$file&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">INFH</span><span class="cm">,</span> <span class="q">&quot;&lt;$file&quot;</span> <span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;Error opening file: '$file'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">Message</span> <span class="q">&quot;Requested file cannot be altered because it does exist: '$file'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@lines</span> = <span class="q">&lt;INFH&gt;</span><span class="sc">;</span>
    <span class="k">close</span> <span class="w">INFH</span><span class="sc">;</span>
    <span class="k">open</span><span class="s">(</span> <span class="w">OUTFH</span><span class="cm">,</span> <span class="q">&quot;&gt;$file&quot;</span> <span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;Could not open file for writing: '$file'&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$last_redone_line_num</span> = <span class="k">scalar</span><span class="s">(</span><span class="i">@lines</span><span class="s">)</span> - <span class="n">2</span> <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@lines</span><span class="s">)</span> &gt;= <span class="n">2</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$last_redone_line_num</span> = <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@lines</span><span class="s">)</span> &lt; <span class="n">2</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$line</span> <span class="s">(</span> <span class="i">@lines</span>[ <span class="n">0</span> .. <span class="i">$last_redone_line_num</span> ] <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">OUTFH</span> <span class="q">&quot;$line&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$newline</span> !~ <span class="q">/\n$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$newline</span> = <span class="q">&quot;$newline\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">print</span> <span class="i">OUTFH</span> <span class="i">$newline</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$success</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;tail -n 1 $file&quot;</span><span class="s">)</span> =~ <span class="q">/^$newline$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$success</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$success</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$success</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#&lt;snip&gt;</span>
<span class="c">#e.g. my $lines_ref = get_lines_between_tags(-filepath=&gt;&quot;$full_path&quot;,-tag=&gt;&quot;$tag_name&quot;);</span>
<span class="c">#OR my %lines = get_lines_between_tags(-filepath=&gt;&quot;$full_path&quot;);</span>
<span class="c"># so $lines{TAG1} = \@lines_within_TAG1;</span>
<span class="c"># $lines{TAG2} = \@lines_within_TAG2;</span>
<span class="c">#&lt;/snip&gt;</span>
<span class="c">###########################</span>
<a name="get_lines_between_tags-"></a><span class="k">sub </span><span class="m">get_lines_between_tags</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'filepath'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'filepath'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$filepath</span> = <span class="i">$args</span>{-<span class="w">filepath</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tag_name</span> = <span class="i">$args</span>{-<span class="w">tag</span>} || <span class="i">$args</span>{-<span class="w">tag_name</span>}<span class="sc">;</span>

    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> !<span class="s">(</span> <span class="k">-f</span> <span class="i">$filepath</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%lines</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="w">FH</span><span class="cm">,</span> <span class="q">&quot;&lt;$filepath&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$begin</span>  = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$middle</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@lines_btw_tags</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tag</span><span class="sc">;</span>    <span class="c">## dynamic, tracks current tag</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$line</span> <span class="s">(</span><span class="q">&lt;FH&gt;</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">chomp</span> <span class="i">$line</span><span class="sc">;</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/^\s*\#/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/^\s*$/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$begin</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$middle</span> = <span class="n">1</span><span class="sc">;</span>
            <span class="i">$begin</span>  = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/^\s*\&lt;(\w+)\&gt;/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$tag</span> = <span class="i">$1</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$tag_name</span> &amp;&amp; <span class="s">(</span> <span class="i">$tag</span> <span class="k">eq</span> <span class="i">$tag_name</span> <span class="s">)</span> || <span class="s">(</span> !<span class="i">$tag_name</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$begin</span> = <span class="n">1</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$begin</span> == <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$middle</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$line</span> =~ <span class="q">/\/$tag\&gt;/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">@lines_copy</span> = <span class="i">@lines_btw_tags</span><span class="sc">;</span>
                <span class="i">$lines</span>{<span class="i">$tag</span>}    = \<span class="i">@lines_copy</span><span class="sc">;</span>
                <span class="i">@lines_btw_tags</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
                <span class="i">$middle</span>         = <span class="n">0</span><span class="sc">;</span>
                <span class="k">next</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">push</span> <span class="i">@lines_btw_tags</span><span class="cm">,</span> <span class="i">$line</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$tag_name</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$lines</span>{<span class="i">$tag_name</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">%lines</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># private_methods            #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># private_functions          #</span>
<span class="c">##############################</span>

<span class="c">###############################################</span>
<span class="c"># method used by compare_data() to record differences between data structures</span>
<span class="c">###############################################</span>
<a name="_record_diff_struct-"></a><span class="k">sub </span><span class="m">_record_diff_struct</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$struct1</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$struct2</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$comments</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span>  = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">push</span><span class="s">(</span> <span class="i">@$comments</span><span class="cm">,</span> <span class="s">[</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$struct1</span><span class="cm">,</span> <span class="i">$struct2</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############################################</span>
<span class="c"># Private helper function for Parse_CSV_File()</span>
<span class="c">###############################################</span>
<a name="_get_CSV_data-"></a><span class="k">sub </span><span class="m">_get_CSV_data</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$line</span>        = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$columns_ref</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quote</span>       = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$delim</span>       = <span class="k">shift</span> || <span class="q">&quot;\t&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$default</span>     = <span class="k">shift</span> || <span class="q">'NULL'</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$delim</span> =~ <span class="q">/s/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$line</span> =~ <span class="q">s/\s{2,}/\t/g</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">@columns</span> = <span class="i">@$columns_ref</span> <span class="k">if</span> <span class="i">$columns_ref</span><span class="sc">;</span>

    <span class="c">#print &quot;\nseparate (with $delim):\n$line\n&quot;;</span>
    <span class="k">my</span> <span class="i">@data_line</span> = <span class="k">split</span> <span class="i">$delim</span><span class="cm">,</span> <span class="i">$line</span><span class="sc">;</span>

    <span class="c">#print &quot;-&gt; @data_line\n&quot;;</span>
    <span class="k">my</span> <span class="i">$col_num</span>  = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$included</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="c">####### Get data from line ###########</span>
    <span class="k">my</span> <span class="i">@fields</span><span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span> <span class="i">@columns</span> = <span class="n">1</span> .. <span class="k">int</span><span class="s">(</span><span class="i">@data_line</span><span class="s">)</span> <span class="s">}</span>

    <span class="c">#    foreach my $col (@data_line) {</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$col_num</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$col</span> = <span class="i">$data_line</span>[ <span class="i">$col_num</span> - <span class="n">1</span> ]<span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$col</span><span class="s">)</span> <span class="s">{</span> <span class="i">$col</span> = <span class="i">$default</span> <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$quote</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$col</span> =~ <span class="q">/^[\'\&quot;](.*)[\'\&quot;]$/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$col</span> = <span class="i">$1</span><span class="sc">;</span> <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@fields</span><span class="cm">,</span> <span class="i">$col</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#print &quot;col $col_num : &quot; . $fields[$included] . &quot; = $col.\n&quot;;</span>
        <span class="i">$included</span>++<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="i">$included</span> == <span class="i">$#fields</span> + <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;** Warning: columns ($included) equal fields ($#fields + 1) ? **\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@fields</span><span class="s">)</span> &gt; <span class="i">$included</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">for</span> <span class="s">(</span> <span class="i">$included</span> .. <span class="i">$#fields</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@fields</span><span class="cm">,</span> <span class="i">$default</span> <span class="s">)</span><span class="sc">;</span>

            <span class="c">#print &quot;** Added &quot; . int(@fields) - $included . &quot; default fields\n&quot;;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@fields</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># main_footer                #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># perldoc_footer             #</span>
<span class="c">##############################</span>

</pre><p></p>
<hr />
<h1><a name="known_issues__uplink_">KNOWN ISSUES &lt;UPLINK&gt;</a></h1>
<p>&lt;&lt;KNOWN ISSUES&gt;&gt;</p>
<p>
</p>
<hr />
<h1><a name="future_improvements__uplink_">FUTURE IMPROVEMENTS &lt;UPLINK&gt;</a></h1>
<p>&lt;&lt;FUTURE IMPROVEMENTS&gt;&gt;</p>
<p>
</p>
<hr />
<h1><a name="authors__uplink_">AUTHORS &lt;UPLINK&gt;</a></h1>
<p>&lt;&lt;AUTHORS&gt;&gt;</p>
<p>
</p>
<hr />
<h1><a name="created__uplink_">CREATED &lt;UPLINK&gt;</a></h1>
<p>2003-11-27</p>
<p>
</p>
<hr />
<h1><a name="revision__uplink_">REVISION &lt;UPLINK&gt;</a></h1>
<p>$Id: RGIO.pm,v 1.134 2004/11/30 04:42:29 rguin Exp $ (Release: $Name:  $)</p>

<pre>
<span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<a name="EOF-"></a></pre></body>

</html>
