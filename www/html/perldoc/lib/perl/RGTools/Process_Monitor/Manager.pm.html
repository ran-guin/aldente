<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Manager.pm</title>
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Manager.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Process_Monitor::Manager-">package Process_Monitor::Manager</a>
<ul>
<li><a href="#new-">new</a></li>
<li><a href="#generate_reports-">generate_reports</a></li>
<li><a href="#_get_script_reports-">_get_script_reports</a></li>
<li><a href="#create_HTML-">create_HTML</a></li>
<li><a href="#create_summary_page-">create_summary_page</a></li>
<li><a href="#send_summary-">send_summary</a></li>
<li><a href="#generate_stats_graphs-">generate_stats_graphs</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<pre>    my @scripts =  keys %{$self-&gt;{reports}};    
   
    my $headers = (&quot;DATE\t\t\t TEST\t TOTAL RUNS\t STATUS\t RUN TIME\t SUCCESSFUL\nTESTS\t MES\t WARN\t ERR\t DETAILS\t\n\n&quot;);
    my $output .= $headers;
 
    if (@scripts) {
        my ($date,$test, $total_runs, $status, $runtime, $tested,$messages,$warnings,$errors,$details);</pre>
<pre>
        foreach my $script (@scripts) {
            my @script_reports = @{$self-&gt;{reports}{$script} };</pre>
<pre>
            foreach my $script_report (@script_reports) {</pre>
<pre>
                $date = $script_report-&gt;{_end_time};</pre>
<pre>
                #set $test with script filename and remove .pl
                $test = $script_report-&gt;{script};
                $test =~ s/\.pl//g;
                
                ($runtime) = split ' ', $script_report-&gt;{_execution_time};</pre>
<pre>
                $total_runs = $self-&gt;{counters}{$script};
                
                $status = 'OK';
                $tested = $script_report-&gt;{succeeded};
                
                $messages = scalar(@{$script_report-&gt;{messages}});</pre>
<pre>
                my ($verbose_messages, $verbose_warnings, $verbose_errors);
                
                if (exists $script_report-&gt;{messages}[0]) {
                    $verbose_messages = Cast_List(-list=&gt;$script_report-&gt;{messages}, -to=&gt;'string',-delimiter=&gt;&quot;&lt;LI&gt;&quot;);</pre>
<pre>
                }</pre>
<pre>
                $warnings = scalar(@{$script_report-&gt;{warnings}});
                if (exists $script_report-&gt;{warnings}[0]) {
                    $verbose_warnings = Cast_List(-list=&gt;$script_report-&gt;{warnings}, -to=&gt;'string',-delimiter=&gt;&quot;&lt;LI&gt;&quot;);</pre>
<pre>
                }</pre>
<pre>
                $errors = scalar(@{$script_report-&gt;{errors}});
                if (exists $script_report-&gt;{errors}[0]) {
                    $verbose_errors = Cast_List(-list=&gt;$script_report-&gt;{errors}, -to=&gt;'string',-delimiter=&gt;&quot;&lt;LI&gt;&quot;);
                }</pre>
<pre>
                $details = Cast_List(-list=&gt;$script_report-&gt;{details}, -to=&gt;'String');
                
                my $log_path = $self-&gt;{cron_dir};
                
                my $logfile = $script . '.log';
                
                try_system_command(&quot;cp $log_path$logfile $URL_temp_dir&quot;);
                
                $details = &quot;&lt;a href=$URL_domain/$URL_dir_name/dynamic/tmp/$logfile'&gt;details&lt;/a&gt;&quot;;
                
                #set status here based on errors/warnings</pre>
<pre>
                if(exists $script_report-&gt;{warnings}[0])
                {$status = 'ATTENTION';}</pre>
<pre>
                if(exists $script_report-&gt;{errors}[0])
                {$status = 'PROBLEM';}</pre>
<pre>
                if($script_report-&gt;{success} == 0)
                {$status = 'INCOMPLETE';}</pre>
<pre>
                my $values = join &quot;\t&quot;,$date,$test,$total_runs,$status,$runtime,$tested,$messages,$warnings,$errors;
                $values .= &quot;\n\n&quot;;
                $output .= $values;</pre>
<pre>
                $output .= (join &quot;\n\n&quot;, &quot;Messages:\n&quot; . $verbose_messages, &quot;Warnings:\n&quot; . $verbose_warnings, &quot;Errors:\n&quot; . $verbose_errors . &quot;\n&quot;);</pre>
<pre>
           } 
        }
                return $output;
    }
    return 0;
}
=cut</pre>

<hr /><pre><a name="package-Process_Monitor::Manager-"></a><span class="k">package </span><span class="i">Process_Monitor::Manager</span><span class="sc">;</span>

<span class="c">################################################################################</span>
<span class="c"># </span>
<span class="c"># This module builds an HTML table summarising the final entries in logfiles created from objects in the RGTools::Process_Manager Module.</span>
<span class="c">#</span>
<span class="c">#  &lt;SYNOPSIS&gt;</span>
<span class="c">#   </span>
<span class="c"># 1. Construct object with attributes of directory for all cron jobs and list of with all script names of cron jobs to be summarised and empty reports hash</span>
<span class="c">#    my Manager = Process_Monitor::Manager-&gt;new(cron_dir =&gt;'/cronjob_scripts/',</span>
<span class="c">#					       cron_list =&gt; {'sys_monitor.pl', 'upgrade_DB.pl', ...});</span>
<span class="c">#</span>
<span class="c">#    $self-&gt;{reports}; #hash of reports</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># 2. create $self-&gt;{reports}, the hash to store: (scriptname =&gt; [array of Process_Monitor objects])</span>
<span class="c">#</span>
<span class="c"># $self-&gt;generate_reports{</span>
<span class="c"># #loop through $self-&gt;{cron_list}, calling get_report on each script name</span>
<span class="c"># </span>
<span class="c"># _get_script_reports(-script, -include){</span>
<span class="c"># Foreach name:</span>
<span class="c">#    i. find the logfile,</span>
<span class="c">#    ii. count number of entries while obtaining the last entry in the logfile </span>
<span class="c">#    iii. convert it to a Process_Monitor object</span>
<span class="c">#    iv. add to @script_reports (array of recent logs determined by include)</span>
<span class="c"># }</span>
<span class="c">#</span>
<span class="c">#  associate @script_reports with current key $script</span>
<span class="c"># }</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># 4. Use $self-&gt;{reports} to write the HTML table using create_HTML()</span>
<span class="c">#</span>
<span class="c"># </span>
<span class="c">##  &lt;/SYNOPSIS&gt;</span>
<span class="c">#</span>
<span class="c">#       OLD SYNOPSIS</span>
<span class="c">#       my $base_dir = '&lt;path to your cron log dir&gt;';</span>
<span class="c">#       my $manager = RGTools::Report::Manager-&gt;new(-base_dir=&gt;$base_dir);</span>
<span class="c">#</span>
<span class="c">#       $manager-&gt;generate_summary(['upgrade_DB','hub_check','restore']);</span>
<span class="c">#</span>
<span class="c">#        is_deeply($self-&gt;{records}, \%test_reports, 'created hash containing reports successfully'); </span>
<span class="c">################################################################################</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">YAML</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">FindBin</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">lib</span> <span class="i">$FindBin::RealBin</span> . <span class="q">&quot;/../lib/perl/&quot;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::HTML_Table</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::RGIO</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::Conversion</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::Process_Monitor</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Notification</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Subscription</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::CustomSettings</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::SDB_Defaults</span> <span class="q">qw($html_header)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">CGI</span> <span class="q">qw(:standard)</span><span class="sc">;</span>

<span class="c">###################</span>
<span class="c">### Constructor ###</span>
<span class="c">##################</span>

<span class="c">### Customize ###</span>
<span class="k">my</span> <span class="i">$DEFAULT_EMAIL</span> = <span class="q">'aldente@bcgsc.ca'</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$link_to_summary</span> = <span class="q">&quot;$URL_domain/$URL_dir_name/dynamic/tmp/&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$tmp_dir</span> = <span class="q">&quot;/tmp/&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$output_log_dir</span> = <span class="q">&quot;dynamic/logs&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$URL_details_dir</span> = <span class="q">&quot;dynamic/tmp&quot;</span><span class="sc">;</span>

<span class="c">#################</span>

<a name="new-"></a><span class="k">sub </span><span class="m">new</span> <span class="s">{</span>
   
    <span class="k">my</span> <span class="i">$this</span> = <span class="k">shift</span><span class="sc">;</span>
    
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span>\<span class="i">@_</span><span class="cm">,</span>-<span class="w">args</span><span class="cm">=&gt;</span><span class="q">'cron_list, cron_dir, include'</span><span class="cm">,</span>-<span class="w">mandatory</span><span class="cm">=&gt;</span><span class="q">'cron_list'</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">### Initialization</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$class</span> = <span class="k">ref</span><span class="s">(</span><span class="i">$this</span><span class="s">)</span> || <span class="i">$this</span><span class="sc">;</span>
    <span class="k">bless</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">$class</span><span class="sc">;</span>

    <span class="c">### Arguments</span>
    <span class="i">$self</span>-&gt;{<span class="w">cron_list</span>} = <span class="i">$args</span>{-<span class="w">cron_list</span>} || <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">include</span>} = <span class="i">$args</span>{-<span class="w">include</span>} || <span class="n">1</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">offset</span>}  = <span class="i">$args</span>{-<span class="w">offset</span>} || <span class="q">'0d'</span><span class="sc">;</span>     <span class="c">## ************** defaults to today, should be set to run as late as possible (eg. 23:50)</span>
    <span class="i">$self</span>-&gt;{<span class="w">report_generated</span>} = <span class="i">date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">notify</span>}  = <span class="i">$args</span>{-<span class="w">notify</span>} || <span class="s">[</span><span class="i">$DEFAULT_EMAIL</span><span class="s">]</span><span class="sc">;</span> 
    <span class="i">$self</span>-&gt;{<span class="w">cron_dir</span>} = <span class="i">$args</span>{-<span class="w">cron_dir</span>} || <span class="i">Process_Monitor::cron_dir</span><span class="s">(</span><span class="i">$self</span>-&gt;{<span class="w">offset</span>}<span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">stats_dir</span>} = <span class="i">$args</span>{-<span class="w">stats_dir</span>} || <span class="i">Process_Monitor::stats_dir</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="c">#    print &quot;cron dir from args: &quot;.$args{-cron_dir}.&quot;, pm_condri: &quot;. Process_Monitor::cron_dir($self-&gt;{offset}) .&quot;\n&quot;;</span>
  <span class="c">#  die();</span>
    <span class="c">### Hashes of reports and missing report</span>
    <span class="i">$self</span>-&gt;{<span class="w">reports</span>}  = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">stats_files</span>} = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">missing_reports</span>}  = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>

    <span class="c">### Atrributes</span>
    <span class="i">$self</span>-&gt;{<span class="w">counters</span>} = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span> 
<span class="s">}</span>

<span class="c">##################</span>
<a name="generate_reports-"></a><span class="k">sub </span><span class="m">generate_reports</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;mkdir -m 775 $self-&gt;{cron_dir}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="c">#unless (-e ($self-&gt;{cron_dir}));</span>
    <span class="k">print</span> <span class="q">&quot;Inspecting &quot;</span> . <span class="k">int</span><span class="s">(</span><span class="k">keys</span> <span class="i">%</span>{<span class="i">$self</span>-&gt;{<span class="w">cron_list</span>}}<span class="s">)</span> . <span class="q">&quot; log files in $self-&gt;{cron_dir}\n\n&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%list</span> = <span class="i">%</span>{<span class="i">$self</span>-&gt;{<span class="w">cron_list</span>}}<span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$script</span> <span class="s">(</span><span class="k">keys</span> <span class="i">%list</span><span class="s">)</span> <span class="s">{</span>
<span class="c">#        my $formatted_name = printf(&quot;%30s&quot;,$script);</span>
        <span class="k">my</span> <span class="i">@variations</span> = <span class="i">Cast_List</span><span class="s">(</span>-<span class="w">list</span><span class="cm">=&gt;</span><span class="i">$list</span>{<span class="i">$script</span>}<span class="cm">,</span>-<span class="w">to</span><span class="cm">=&gt;</span><span class="q">'array'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$variations</span>[<span class="n">0</span>] == <span class="n">1</span><span class="s">)</span> <span class="s">{</span> <span class="i">@variations</span> = <span class="s">(</span><span class="i">$script</span><span class="s">)</span><span class="sc">;</span>        <span class="s">}</span>
<span class="c">#print &quot;120, variations: &quot;.Dumper(@variations).&quot;\n&quot;;</span>
	<span class="k">foreach</span> <span class="k">my</span> <span class="i">$variation</span> <span class="s">(</span><span class="i">@variations</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$logfile</span> = <span class="i">$variation</span><span class="sc">;</span>
            
            <span class="k">if</span> <span class="s">(</span><span class="k">-e</span> <span class="q">&quot;$self-&gt;{cron_dir}/$logfile&quot;</span>. <span class="q">'.log'</span><span class="s">)</span> <span class="s">{</span>
<span class="c">#print &quot;125,cron dir: &quot;.$self-&gt;{cron_dir}.&quot;\n&quot;;</span>
                <span class="i">$self</span>-&gt;{<span class="w">reports</span>}{<span class="i">$logfile</span>} = <span class="i">$self</span><span class="i">-&gt;_get_script_reports</span><span class="s">(</span><span class="i">$logfile</span><span class="s">)</span><span class="sc">;</span>
<span class="c">#print &quot;!27: slf-rpr-logfile: &quot;.Dumper($self-&gt;{reports}{$logfile}).&quot;\n&quot;;</span>
                <span class="k">my</span> <span class="i">@details</span> = <span class="k">split</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">Dumper</span><span class="s">(</span><span class="i">$self</span>-&gt;{<span class="w">reports</span>}{<span class="i">$logfile</span>}<span class="s">)</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">@warnings</span> = <span class="k">grep</span> <span class="q">/^warnings:\b/</span><span class="cm">,</span> <span class="i">@details</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">@errors</span>   = <span class="k">grep</span> <span class="q">/^errors:\b/</span><span class="cm">,</span> <span class="i">@details</span><span class="sc">;</span>
<span class="c">#print &quot;131, what's in error: &quot;.Dumper(@errors).&quot;\n&quot;;</span>
                <span class="k">print</span> <span class="q">&quot;\t\t&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">@warnings</span> || <span class="i">@errors</span><span class="s">)</span><span class="sc">;</span>

                <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span> &amp;&amp; <span class="s">(</span><span class="k">int</span><span class="s">(</span><span class="k">keys</span> <span class="i">%list</span><span class="s">)</span>==<span class="n">1</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">print</span> <span class="q">&quot;** Warnings ** \n&quot;</span> . <span class="k">join</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">@warnings</span> <span class="k">if</span> <span class="i">@warnings</span><span class="sc">;</span>
                    <span class="k">print</span> <span class="q">&quot;** Errors ** \n&quot;</span>  . <span class="k">join</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">@errors</span> <span class="k">if</span> <span class="i">@errors</span><span class="sc">;</span>	
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="k">print</span> <span class="q">&quot;** Warnings ** &quot;</span> <span class="k">if</span> <span class="i">@warnings</span><span class="sc">;</span>
                    <span class="k">print</span> <span class="q">&quot;** Errors **&quot;</span> <span class="k">if</span> <span class="i">@errors</span><span class="sc">;</span>	
                <span class="s">}</span>

                <span class="k">print</span> <span class="i">Dumper</span><span class="s">(</span>\<span class="i">@errors</span><span class="s">)</span> <span class="k">if</span> <span class="i">@errors</span><span class="sc">;</span>
                <span class="k">print</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span><span class="s">{</span>
                <span class="i">$self</span>-&gt;{<span class="w">missing_reports</span>}{<span class="i">$variation</span>} = <span class="s">[</span><span class="q">&quot;$logfile\n&quot;</span><span class="s">]</span><span class="sc">;</span> 
                <span class="k">print</span> <span class="q">&quot;\t\t$self-&gt;{cron_dir}/$logfile NOT found.\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">################################</span>
<span class="c">#</span>
<span class="c"># Input: scriptname</span>
<span class="c">#         </span>
<span class="c"># Output: array Process_Monitor objects for last entry in logfile</span>
<span class="c">#        </span>
<span class="c">################################</span>

<span class="c">###################</span>
<a name="_get_script_reports-"></a><span class="k">sub </span><span class="m">_get_script_reports</span> <span class="s">{</span>    
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span>\<span class="i">@_</span><span class="cm">,</span>-<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'logfile'</span><span class="cm">,</span>-<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'logfile'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$logfile</span> = <span class="i">$args</span>{-<span class="w">logfile</span>}<span class="sc">;</span> 
    <span class="i">$logfile</span> .= <span class="q">'.log'</span><span class="sc">;</span>

    <span class="k">print</span> <span class="q">&quot;log file: $self-&gt;{cron_dir}/$logfile\n&quot;</span><span class="sc">;</span>
    <span class="k">open</span> <span class="k">my</span> <span class="i">$LOG</span><span class="cm">,</span> <span class="q">&quot;$self-&gt;{cron_dir}/$logfile&quot;</span> <span class="k">or</span> <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span> <span class="c"># no log file found, shouldn't happen as should be in $self-&gt;{missing_reports}</span>

    <span class="k">my</span> <span class="i">$check_line</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$log_instance</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$yaml_instance</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@yaml_instances</span> = <span class="s">[</span><span class="s">]</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">counters</span>}{<span class="i">$logfile</span>} = <span class="n">0</span><span class="sc">;</span>
    
    <span class="k">while</span> <span class="s">(</span><span class="i">$check_line</span> = <span class="q">&lt;$LOG&gt;</span><span class="s">)</span><span class="s">{</span>	
	<span class="k">if</span> <span class="s">(</span><span class="i">$check_line</span> =~ <span class="q">/^Repeat Message/</span><span class="s">)</span> <span class="s">{</span>
	    <span class="i">$self</span>-&gt;{<span class="w">counters</span>}{<span class="i">$logfile</span>}++<span class="sc">;</span>
	    <span class="k">next</span><span class="sc">;</span>
	<span class="s">}</span> 
	<span class="k">elsif</span> <span class="s">(</span> <span class="i">$check_line</span> =~ <span class="q">/(\*)START(\*)/</span> <span class="s">)</span> <span class="s">{</span>
	    <span class="i">$log_instance</span> = <span class="q">''</span><span class="sc">;</span>
	    <span class="k">next</span><span class="sc">;</span>
	<span class="s">}</span>
	<span class="k">elsif</span> <span class="s">(</span> <span class="i">$check_line</span> =~ <span class="q">/(\*)END(\*)/</span> <span class="s">)</span> <span class="s">{</span>
	    <span class="i">$self</span>-&gt;{<span class="w">counters</span>}{<span class="i">$logfile</span>}++<span class="sc">;</span>
	    <span class="c">## continue below ##</span>
	<span class="s">}</span>
	<span class="k">else</span> <span class="s">{</span>
	    <span class="i">$log_instance</span> .= <span class="i">$check_line</span><span class="sc">;</span>
	    <span class="k">next</span><span class="sc">;</span>
	<span class="s">}</span>
	
	<span class="k">if</span> <span class="s">(</span><span class="k">scalar</span><span class="s">(</span><span class="i">@yaml_instances</span><span class="s">)</span> == <span class="i">$self</span>-&gt;{<span class="w">include</span>} <span class="s">)</span><span class="s">{</span>
	    <span class="k">shift</span> <span class="i">@yaml_instances</span><span class="sc">;</span>
	<span class="s">}</span>
	
	<span class="i">$yaml_instance</span> = <span class="i">YAML::thaw</span><span class="s">(</span><span class="i">$log_instance</span><span class="s">)</span><span class="sc">;</span>
	
	<span class="k">push</span> <span class="i">@yaml_instances</span><span class="cm">,</span>  <span class="i">$yaml_instance</span><span class="sc">;</span>
	
	<span class="i">$log_instance</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">close</span> <span class="i">$LOG</span><span class="sc">;</span> 
    
    <span class="k">return</span> \<span class="i">@yaml_instances</span><span class="sc">;</span>
<span class="s">}</span> 


<span class="c">##############################</span>
<span class="c">#Create HTML table which summarises information from logfiles, 1 summary line based on most recent report per script unless user determines otherwise</span>
<span class="c">##############################</span>

<span class="c">###################</span>
<a name="create_HTML-"></a><span class="k">sub </span><span class="m">create_HTML</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span> = <span class="k">shift</span> || <span class="q">'html'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@scripts</span> =  <span class="k">keys</span> <span class="i">%</span>{<span class="i">$self</span>-&gt;{<span class="w">reports</span>}}<span class="sc">;</span>    
    <span class="k">my</span> <span class="i">@missing_scripts</span> =  <span class="k">keys</span> <span class="i">%</span>{<span class="i">$self</span>-&gt;{<span class="w">missing_reports</span>}}<span class="sc">;</span>    
    <span class="k">my</span> <span class="i">@missing_logs</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@headers</span> = <span class="s">(</span><span class="q">'DATE'</span><span class="cm">,</span><span class="q">'TEST'</span><span class="cm">,</span> <span class="q">'TOTAL RUNS'</span><span class="cm">,</span> <span class="q">'STATUS'</span><span class="cm">,</span> <span class="q">'RUN TIME'</span> <span class="cm">,</span> <span class="q">&quot;SUCCESSFUL\nTESTS&quot;</span><span class="cm">,</span><span class="q">'MESSAGES'</span><span class="cm">,</span><span class="q">'WARNINGS'</span><span class="cm">,</span><span class="q">'ERRORS'</span><span class="cm">,</span><span class="q">'DETAILS'</span><span class="cm">,</span> <span class="q">'ERROR LOG'</span><span class="cm">,</span> <span class="q">&quot;REPORT\nPAGE&quot;</span><span class="cm">,</span><span class="q">&quot;ERROR\nHISTORY&quot;</span><span class="cm">,</span><span class="q">&quot;WARNING\nHISTORY&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$HTML</span> = <span class="q">&quot;Generated: &quot;</span> . <span class="i">&amp;convert_date</span><span class="s">(</span><span class="i">date_time</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span><span class="q">'Simple'</span><span class="s">)</span> . <span class="w">hr</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">@scripts</span> || <span class="i">@missing_scripts</span><span class="s">)</span> <span class="s">{</span>
	<span class="c"># set up the HTML table for Cron job summary</span>
	<span class="k">my</span> <span class="i">$lst</span> = <span class="w">HTML_Table</span><span class="w">-&gt;new</span><span class="s">(</span>-<span class="w">width</span><span class="cm">=&gt;</span><span class="n">600</span><span class="s">)</span><span class="sc">;</span>
	<span class="i">$lst</span><span class="i">-&gt;Set_Title</span><span class="s">(</span><span class="q">&quot;CRON JOB SUMMARY&quot;</span> <span class="s">)</span><span class="sc">;</span>
	<span class="i">$lst</span><span class="i">-&gt;Set_Headers</span><span class="s">(</span>\<span class="i">@headers</span><span class="cm">,</span> <span class="i">$Settings</span>{<span class="w">HIGHLIGHT_CLASS</span>}<span class="s">)</span><span class="sc">;</span>
	<span class="k">my</span> <span class="s">(</span><span class="i">$date</span><span class="cm">,</span><span class="i">$test</span><span class="cm">,</span> <span class="i">$total_runs</span><span class="cm">,</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$runtime</span><span class="cm">,</span> <span class="i">$tested</span><span class="cm">,</span><span class="i">$messages</span><span class="cm">,</span><span class="i">$warnings</span><span class="cm">,</span><span class="i">$errors</span><span class="cm">,</span> <span class="i">$details</span><span class="cm">,</span> <span class="i">$error_log</span><span class="cm">,</span> <span class="i">$report_page</span><span class="s">)</span><span class="sc">;</span>
   	<span class="k">foreach</span> <span class="k">my</span> <span class="i">$script</span> <span class="s">(</span><span class="k">sort</span> <span class="i">@scripts</span><span class="s">)</span> <span class="s">{</span>
	    <span class="k">my</span> <span class="i">@script_reports</span> = <span class="i">@</span>{<span class="i">$self</span>-&gt;{<span class="w">reports</span>}{<span class="i">$script</span>}}<span class="sc">;</span>
	    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$script_report</span> <span class="s">(</span><span class="i">@script_reports</span><span class="s">)</span> <span class="s">{</span>
		<span class="k">my</span> <span class="i">$var_type</span> = <span class="k">ref</span><span class="s">(</span><span class="i">$script_report</span><span class="s">)</span><span class="sc">;</span>
		<span class="k">if</span> <span class="s">(</span><span class="i">$var_type</span> <span class="k">eq</span> <span class="q">'ARRAY'</span><span class="s">)</span> <span class="s">{</span>
		    <span class="k">unless</span> <span class="s">(</span><span class="k">defined</span><span class="s">(</span><span class="i">@$script_report</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>    
			<span class="k">err</span><span class="s">(</span><span class="q">&quot;$script has an empty report file\n&quot;</span><span class="s">)</span><span class="sc">;</span>
			<span class="k">push</span> <span class="s">(</span><span class="i">@missing_logs</span><span class="cm">,</span><span class="i">$script</span><span class="s">)</span><span class="sc">;</span>
			<span class="k">next</span><span class="sc">;</span> 
		    <span class="s">}</span>
		<span class="s">}</span>
    		<span class="i">$error_log</span> = <span class="q">&quot;N/A&quot;</span><span class="sc">;</span>
	    	<span class="i">$report_page</span> = <span class="q">&quot;N/A&quot;</span><span class="sc">;</span>
    		<span class="i">$date</span> = <span class="i">$script_report</span>-&gt;{<span class="w">_end_time</span>}<span class="sc">;</span> 
		
		<span class="c">#set $test with script filename and remove .pl</span>
		<span class="i">$test</span> = <span class="i">$script_report</span>-&gt;{<span class="w">script</span>}<span class="sc">;</span>
		<span class="i">$test</span> =~ <span class="q">s/\.pl//g</span><span class="sc">;</span>
		<span class="i">$test</span> .= <span class="q">&quot; - $script_report-&gt;{variation}&quot;</span>  <span class="k">if</span> <span class="s">(</span><span class="i">$script_report</span>-&gt;{<span class="w">variation</span>}<span class="s">)</span><span class="sc">;</span>
		
		<span class="s">(</span><span class="i">$runtime</span><span class="s">)</span> = <span class="k">split</span> <span class="q">' '</span><span class="cm">,</span> <span class="i">$script_report</span>-&gt;{<span class="w">_execution_time</span>}<span class="sc">;</span>
		<span class="i">$runtime</span> .= <span class="q">&quot;&lt;BR&gt; wallclock &lt;BR&gt; secs &lt;BR&gt;&quot;</span><span class="sc">;</span>
		
		<span class="i">$total_runs</span> = <span class="i">$self</span>-&gt;{<span class="w">counters</span>}{<span class="i">$script</span>}<span class="sc">;</span>
		
		<span class="i">$status</span> = <span class="q">'OK'</span><span class="sc">;</span>
		<span class="i">$tested</span> = <span class="i">$script_report</span>-&gt;{<span class="w">succeeded</span>}<span class="sc">;</span>
		
		<span class="i">$messages</span> = <span class="k">scalar</span><span class="s">(</span><span class="i">@</span>{<span class="i">$script_report</span>-&gt;{<span class="w">messages</span>}}<span class="s">)</span><span class="sc">;</span>
		
		<span class="k">if</span> <span class="s">(</span><span class="k">exists</span> <span class="i">$script_report</span>-&gt;{<span class="w">messages</span>}[<span class="n">0</span>]<span class="s">)</span> <span class="s">{</span>
		    <span class="k">my</span> <span class="i">$messages_string</span> = <span class="i">Cast_List</span><span class="s">(</span>-<span class="w">list</span><span class="cm">=&gt;</span><span class="i">$script_report</span>-&gt;{<span class="w">messages</span>}<span class="cm">,</span> -<span class="w">to</span><span class="cm">=&gt;</span><span class="q">'string'</span><span class="cm">,</span>-<span class="w">delimiter</span><span class="cm">=&gt;</span><span class="q">&quot;&lt;BR&gt;&quot;</span><span class="s">)</span><span class="sc">;</span>
		    <span class="i">$messages</span> = <span class="i">Show_Tool_Tip</span><span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@</span>{<span class="i">$script_report</span>-&gt;{<span class="w">messages</span>}}<span class="s">)</span><span class="cm">,</span> <span class="i">$messages_string</span><span class="s">)</span><span class="sc">;</span>
		<span class="s">}</span>

		<span class="i">$warnings</span> = <span class="k">scalar</span><span class="s">(</span><span class="i">@</span>{<span class="i">$script_report</span>-&gt;{<span class="w">warnings</span>}}<span class="s">)</span><span class="sc">;</span>
		<span class="k">if</span> <span class="s">(</span><span class="k">exists</span> <span class="i">$script_report</span>-&gt;{<span class="w">warnings</span>}[<span class="n">0</span>]<span class="s">)</span> <span class="s">{</span>
		    <span class="k">my</span> <span class="i">$warnings_string</span> = <span class="i">Cast_List</span><span class="s">(</span>-<span class="w">list</span><span class="cm">=&gt;</span><span class="i">$script_report</span>-&gt;{<span class="w">warnings</span>}<span class="cm">,</span> -<span class="w">to</span><span class="cm">=&gt;</span><span class="q">'string'</span><span class="cm">,</span>-<span class="w">delimiter</span><span class="cm">=&gt;</span><span class="q">&quot;&lt;BR&gt;&quot;</span><span class="s">)</span><span class="sc">;</span>
		    <span class="i">$warnings</span> = <span class="i">Show_Tool_Tip</span><span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@</span>{<span class="i">$script_report</span>-&gt;{<span class="w">warnings</span>}}<span class="s">)</span><span class="cm">,</span> <span class="i">$warnings_string</span><span class="s">)</span><span class="sc">;</span>
		<span class="s">}</span>

		<span class="i">$errors</span> = <span class="k">scalar</span><span class="s">(</span><span class="i">@</span>{<span class="i">$script_report</span>-&gt;{<span class="w">errors</span>}}<span class="s">)</span><span class="sc">;</span>
		<span class="k">if</span> <span class="s">(</span><span class="k">exists</span> <span class="i">$script_report</span>-&gt;{<span class="w">errors</span>}[<span class="n">0</span>]<span class="s">)</span> <span class="s">{</span>
		    <span class="k">my</span> <span class="i">$errors_string</span> = <span class="i">Cast_List</span><span class="s">(</span>-<span class="w">list</span><span class="cm">=&gt;</span><span class="i">$script_report</span>-&gt;{<span class="w">errors</span>}<span class="cm">,</span> -<span class="w">to</span><span class="cm">=&gt;</span><span class="q">'string'</span><span class="cm">,</span>-<span class="w">delimiter</span><span class="cm">=&gt;</span><span class="q">&quot;&lt;BR&gt;&quot;</span><span class="s">)</span><span class="sc">;</span>
		    <span class="i">$errors</span> = <span class="i">Show_Tool_Tip</span><span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@</span>{<span class="i">$script_report</span>-&gt;{<span class="w">errors</span>}}<span class="s">)</span><span class="cm">,</span> <span class="i">$errors_string</span><span class="s">)</span><span class="sc">;</span>
		<span class="s">}</span>

		<span class="i">$details</span> = <span class="i">Cast_List</span><span class="s">(</span>-<span class="w">list</span><span class="cm">=&gt;</span><span class="i">$script_report</span>-&gt;{<span class="w">details</span>}<span class="cm">,</span> -<span class="w">to</span><span class="cm">=&gt;</span><span class="q">'String'</span><span class="s">)</span><span class="sc">;</span>
		<span class="k">my</span> <span class="i">$error_history_graph</span><span class="sc">;</span>
		<span class="k">my</span> <span class="i">$warning_history_graph</span><span class="sc">;</span>
		<span class="k">my</span> <span class="i">$fb</span><span class="sc">;</span>
		<span class="k">if</span> <span class="s">(</span><span class="k">defined</span> <span class="i">$self</span>-&gt;{<span class="w">stats_graphs</span>}{<span class="i">$script_report</span>-&gt;{<span class="w">script</span>}}{<span class="w">Errors</span>}<span class="s">)</span> <span class="s">{</span>
		    <span class="k">my</span> <span class="i">$error_graph_file</span> = <span class="i">$self</span>-&gt;{<span class="w">stats_graphs</span>}{<span class="i">$script_report</span>-&gt;{<span class="w">script</span>}}{<span class="w">Errors</span>}<span class="sc">;</span>
		    <span class="k">my</span> <span class="i">$img</span> = <span class="k">eval</span> <span class="s">{</span> <span class="i">$error_graph_file</span> =~ <span class="q">/\/([\w\.]+.gif)/</span><span class="sc">;</span> <span class="k">return</span> <span class="i">$1</span><span class="sc">;</span> <span class="s">}</span><span class="sc">;</span>
		    <span class="i">$fb</span> = <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;cp $error_graph_file $URL_temp_dir&quot;</span><span class="s">)</span><span class="sc">;</span>	    
		    <span class="i">$error_history_graph</span> = <span class="q">&quot;&lt;img src='$link_to_summary/$img'&gt;&quot;</span><span class="sc">;</span>	    
		<span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
		    <span class="i">$error_history_graph</span> = <span class="q">&quot;No recent errors!&quot;</span><span class="sc">;</span>
		<span class="s">}</span>
		<span class="k">if</span> <span class="s">(</span><span class="k">defined</span> <span class="i">$self</span>-&gt;{<span class="w">stats_graphs</span>}{<span class="i">$script_report</span>-&gt;{<span class="w">script</span>}}{<span class="w">Warnings</span>}<span class="s">)</span> <span class="s">{</span>
		    <span class="k">my</span> <span class="i">$warning_graph_file</span> = <span class="i">$self</span>-&gt;{<span class="w">stats_graphs</span>}{<span class="i">$script_report</span>-&gt;{<span class="w">script</span>}}{<span class="w">Warnings</span>}<span class="sc">;</span>
		    <span class="k">my</span> <span class="i">$img</span> = <span class="k">eval</span> <span class="s">{</span> <span class="i">$warning_graph_file</span> =~ <span class="q">/\/([\w\.]+.gif)/</span><span class="sc">;</span> <span class="k">return</span> <span class="i">$1</span><span class="sc">;</span> <span class="s">}</span><span class="sc">;</span>
		    <span class="i">$fb</span> = <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;cp $warning_graph_file $URL_temp_dir&quot;</span><span class="s">)</span><span class="sc">;</span>
		    <span class="i">$warning_history_graph</span> = <span class="q">&quot;&lt;img src='$link_to_summary/$img'&gt;&quot;</span><span class="sc">;</span>
		<span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
		    <span class="i">$warning_history_graph</span> = <span class="q">&quot;No recent warnings!&quot;</span><span class="sc">;</span>
		<span class="s">}</span>

		<span class="i">$date</span> = <span class="q">&quot;&lt;FONT size=-2&gt;$date&lt;/FONT&gt;&quot;</span><span class="sc">;</span>
		
		<span class="c">#set status here based on errors/warnings</span>
		<span class="k">if</span><span class="s">(</span><span class="k">exists</span> <span class="i">$script_report</span>-&gt;{<span class="w">warnings</span>}[<span class="n">0</span>]<span class="s">)</span>
		<span class="s">{</span><span class="i">$status</span> = <span class="q">'ATTENTION'</span><span class="sc">;</span><span class="s">}</span>
		
		<span class="k">if</span><span class="s">(</span><span class="k">exists</span> <span class="i">$script_report</span>-&gt;{<span class="w">errors</span>}[<span class="n">0</span>]<span class="s">)</span>
		<span class="s">{</span><span class="i">$status</span> = <span class="q">'PROBLEM'</span><span class="sc">;</span><span class="s">}</span>
		
		<span class="k">if</span><span class="s">(</span><span class="i">$script_report</span>-&gt;{<span class="w">success</span>} == <span class="n">0</span><span class="s">)</span> 
		<span class="s">{</span><span class="i">$status</span> = <span class="q">'INCOMPLETE'</span><span class="sc">;</span><span class="s">}</span>
		
		<span class="k">my</span> <span class="i">$log_path</span> = <span class="i">$self</span>-&gt;{<span class="w">cron_dir</span>}<span class="sc">;</span>		
		<span class="k">my</span> <span class="i">$logfile</span> = <span class="i">$script</span> . <span class="q">'.log'</span><span class="sc">;</span>		
		<span class="k">my</span> <span class="i">$error_file</span> = <span class="i">$script</span> . <span class="q">'.err'</span><span class="sc">;</span>
<span class="c">#Call_Stack;</span>
<span class="c">#print &quot;we are in create_HTML of manager, with log path: $self-&gt;{cron_dir}, logfile: $logfile, err file: $error_file\n&quot;;</span>
		<span class="k">if</span> <span class="s">(</span><span class="i">$status</span> <span class="k">eq</span> <span class="q">'INCOMPLETE'</span><span class="s">)</span> <span class="s">{</span>
		    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;cp $log_path/$logfile $URL_temp_dir&quot;</span><span class="s">)</span><span class="sc">;</span>
		    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;chmod 664 $URL_temp_dir/$logfile&quot;</span><span class="s">)</span><span class="sc">;</span>
		    
		    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;cp $log_path/$error_file $URL_temp_dir&quot;</span><span class="s">)</span><span class="sc">;</span>
		    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;chmod 664 $URL_temp_dir/$error_file&quot;</span><span class="s">)</span><span class="sc">;</span>
		    
		    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;chmod 664 $Web_log_directory/$logfile&quot;</span><span class="s">)</span><span class="sc">;</span>
 		    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;chmod 664 $Web_log_directory/$error_file&quot;</span><span class="s">)</span><span class="sc">;</span>
   		    <span class="i">$details</span> = <span class="q">&quot;&lt;a href= $URL_domain/$URL_dir_name/$URL_details_dir/$logfile&gt;details&lt;/a&gt;&quot;</span><span class="sc">;</span>
	 	    <span class="i">$error_log</span> = <span class="q">&quot;&lt;a href= $URL_domain/$URL_dir_name/$URL_details_dir/$error_file&gt;error log&lt;/a&gt;&quot;</span><span class="sc">;</span>
	 	<span class="s">}</span>
	 	<span class="k">else</span> <span class="s">{</span>
		    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;cp $log_path/$logfile $URL_temp_dir&quot;</span><span class="s">)</span><span class="sc">;</span>
		    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;chmod 664 $URL_temp_dir/$logfile&quot;</span><span class="s">)</span><span class="sc">;</span>
		    <span class="i">$details</span> = <span class="q">&quot;&lt;a href= $URL_domain/$URL_dir_name/$URL_details_dir/$logfile&gt;details&lt;/a&gt;&quot;</span><span class="sc">;</span>
		<span class="s">}</span>
<span class="c"># where do we get the url from</span>
        
		<span class="i">$report_page</span> = <span class="q">&quot;&lt;a href = $script_report-&gt;{url}&gt;report page&lt;/a&gt;&quot;</span> <span class="k">unless</span> <span class="s">(</span><span class="i">$script_report</span>-&gt;{<span class="w">url</span>} <span class="k">eq</span> <span class="q">&quot;&quot;</span><span class="s">)</span><span class="sc">;</span>
<span class="c">#print 'whats $script_report: '.Dumper($script_report);</span>
		<span class="k">if</span> <span class="s">(</span><span class="i">$errors</span><span class="s">)</span><span class="s">{</span>
		    <span class="i">$errors</span>= <span class="q">&quot;&lt;FONT color=red&gt;&lt;B&gt;$errors&lt;/B&gt;&lt;/FONT&gt;&quot;</span><span class="sc">;</span>
		<span class="s">}</span>
		<span class="k">if</span> <span class="s">(</span><span class="i">$status</span> <span class="k">eq</span> <span class="q">'OK'</span><span class="s">)</span><span class="s">{</span>
		    <span class="i">$status</span> = <span class="q">&quot;&lt;FONT size=-1 color=darkgreen&gt;&lt;B&gt;$status&lt;/B&gt;&lt;/FONT&gt;&quot;</span><span class="sc">;</span>
		<span class="s">}</span> <span class="k">elsif</span><span class="s">(</span><span class="i">$status</span> <span class="k">eq</span> <span class="q">'ATTENTION'</span><span class="s">)</span> <span class="s">{</span>
		    <span class="i">$status</span> = <span class="q">&quot;&lt;FONT size=-1 color=orangered&gt;&lt;B&gt;$status&lt;/B&gt;&lt;/FONT&gt;&quot;</span><span class="sc">;</span>
		<span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
		    <span class="i">$status</span> = <span class="q">&quot;&lt;FONT size=-1 color=red&gt;&lt;BLINK&gt;&lt;B&gt;$status&lt;/B&gt;&lt;/BLINK&gt;&lt;/FONT&gt;&quot;</span><span class="sc">;</span>
		<span class="s">}</span>
		
		<span class="i">$lst</span><span class="i">-&gt;Set_Row</span><span class="s">(</span><span class="s">[</span><span class="i">$date</span><span class="cm">,</span><span class="i">$test</span><span class="cm">,</span><span class="i">$total_runs</span><span class="cm">,</span><span class="i">$status</span><span class="cm">,</span><span class="i">$runtime</span><span class="cm">,</span><span class="i">$tested</span><span class="cm">,</span><span class="i">$messages</span><span class="cm">,</span><span class="i">$warnings</span><span class="cm">,</span><span class="i">$errors</span><span class="cm">,</span><span class="i">$details</span><span class="cm">,</span><span class="i">$error_log</span><span class="cm">,</span> <span class="i">$report_page</span><span class="cm">,</span> <span class="i">$error_history_graph</span><span class="cm">,</span> <span class="i">$warning_history_graph</span><span class="s">]</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">4</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">5</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">6</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">7</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">8</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">9</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">10</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span><span class="n">11</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span><span class="n">12</span><span class="s">)</span><span class="sc">;</span>
	    <span class="s">}</span>
	<span class="s">}</span>

 	<span class="i">$HTML</span> .= <span class="i">$lst</span><span class="i">-&gt;Printout</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>	

	<span class="i">$HTML</span> .= <span class="q">&quot;&lt;P&gt;&lt;P&gt;&quot;</span><span class="sc">;</span>

	<span class="k">if</span> <span class="s">(</span><span class="i">@missing_scripts</span><span class="s">)</span> <span class="s">{</span>
	    
	    <span class="c"># set up the HTML table for missing logfiles</span>
	    <span class="k">my</span> <span class="i">$missing_lst</span> = <span class="w">HTML_Table</span><span class="w">-&gt;new</span><span class="s">(</span>-<span class="w">width</span><span class="cm">=&gt;</span><span class="n">200</span><span class="s">)</span><span class="sc">;</span>
	    <span class="i">$missing_lst</span><span class="i">-&gt;Set_Title</span><span class="s">(</span><span class="q">&quot;MISSING CRON JOB LOGFILES&quot;</span> <span class="s">)</span><span class="sc">;</span>
	    <span class="i">$missing_lst</span><span class="i">-&gt;Set_Headers</span><span class="s">(</span><span class="s">[</span><span class="q">'DATE'</span> <span class="cm">,</span> <span class="q">'TEST'</span><span class="cm">,</span> <span class="q">'STATUS'</span><span class="s">]</span><span class="cm">,</span> <span class="i">$Settings</span>{<span class="w">HIGHLIGHT_CLASS</span>}<span class="s">)</span><span class="sc">;</span>
  
	    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$missing_script</span> <span class="s">(</span><span class="i">@missing_scripts</span><span class="s">)</span> <span class="s">{</span>
		
		<span class="k">my</span> <span class="i">@missing_script_reports</span> = <span class="i">@</span>{<span class="i">$self</span>-&gt;{<span class="w">missing_reports</span>}{<span class="i">$missing_script</span>} }<span class="sc">;</span>
		
		<span class="k">foreach</span> <span class="k">my</span> <span class="i">$missing_script_report</span> <span class="s">(</span><span class="i">@missing_script_reports</span><span class="s">)</span> <span class="s">{</span>
		    <span class="k">my</span> <span class="s">(</span><span class="i">$date</span><span class="cm">,</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>

		    <span class="i">$date</span> = <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

		    <span class="c">#set $test with script filename and remove .pl</span>
		    <span class="i">$test</span> = <span class="q">&quot;$missing_script_report&quot;</span><span class="sc">;</span>
		    <span class="i">$test</span> =~ <span class="q">s/\.pl//g</span><span class="sc">;</span>

		    <span class="i">$status</span> = <span class="q">&quot;MISSING&quot;</span><span class="sc">;</span>
		    <span class="i">$status</span> = <span class="q">&quot;&lt;FONT size=-1 color=red&gt;&lt;BLINK&gt;&lt;B&gt;$status&lt;/B&gt;&lt;/FONT&gt;&quot;</span><span class="sc">;</span>

		<span class="i">$missing_lst</span><span class="i">-&gt;Set_Row</span><span class="s">(</span><span class="s">[</span><span class="i">$date</span><span class="cm">,</span><span class="i">$test</span><span class="cm">,</span> <span class="i">$status</span><span class="s">]</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$missing_lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$missing_lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">4</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$missing_lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">5</span><span class="s">)</span><span class="sc">;</span>
		<span class="s">}</span>
	    <span class="s">}</span>
	    <span class="i">$HTML</span> .= <span class="i">$missing_lst</span><span class="i">-&gt;Printout</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	<span class="s">}</span>

	<span class="k">if</span> <span class="s">(</span><span class="i">@missing_logs</span><span class="s">)</span> <span class="s">{</span>
	    
	    <span class="c"># set up the HTML table for empty logfiles</span>
	    <span class="k">my</span> <span class="i">$missing_lst</span> = <span class="w">HTML_Table</span><span class="w">-&gt;new</span><span class="s">(</span>-<span class="w">width</span><span class="cm">=&gt;</span><span class="n">200</span><span class="s">)</span><span class="sc">;</span>
	    <span class="i">$missing_lst</span><span class="i">-&gt;Set_Title</span><span class="s">(</span><span class="q">&quot;EMPTY CRON JOB LOGFILES&quot;</span> <span class="s">)</span><span class="sc">;</span>
	    <span class="i">$missing_lst</span><span class="i">-&gt;Set_Headers</span><span class="s">(</span><span class="s">[</span><span class="q">'DATE'</span> <span class="cm">,</span> <span class="q">'TEST'</span><span class="cm">,</span> <span class="q">'STATUS'</span><span class="s">]</span><span class="cm">,</span> <span class="i">$Settings</span>{<span class="w">HIGHLIGHT_CLASS</span>}<span class="s">)</span><span class="sc">;</span>
  
	    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$missing_log</span> <span class="s">(</span><span class="i">@missing_logs</span><span class="s">)</span> <span class="s">{</span>
		
		
		    <span class="k">my</span> <span class="s">(</span><span class="i">$date</span><span class="cm">,</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>

		    <span class="i">$date</span> = <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

		    <span class="c">#set $test with script filename and remove .pl</span>
<span class="c">#		    $test = &quot;$missing_script_report&quot;;</span>
<span class="c">#		    $test =~ s/\.pl//g;</span>

		    <span class="i">$status</span> = <span class="q">&quot;Empty&quot;</span><span class="sc">;</span>
		    <span class="i">$status</span> = <span class="q">&quot;&lt;FONT size=-1 color=red&gt;&lt;BLINK&gt;&lt;B&gt;$status&lt;/B&gt;&lt;/FONT&gt;&quot;</span><span class="sc">;</span>

		    <span class="i">$missing_lst</span><span class="i">-&gt;Set_Row</span><span class="s">(</span><span class="s">[</span><span class="i">$date</span><span class="cm">,</span><span class="i">$missing_log</span><span class="cm">,</span> <span class="i">$status</span><span class="s">]</span><span class="s">)</span><span class="sc">;</span>
    		<span class="i">$missing_lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
	    	<span class="i">$missing_lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">4</span><span class="s">)</span><span class="sc">;</span>
		    <span class="i">$missing_lst</span><span class="i">-&gt;Set_Alignment</span><span class="s">(</span><span class="q">'center'</span><span class="cm">,</span> <span class="n">5</span><span class="s">)</span><span class="sc">;</span>
	    <span class="s">}</span>
	    <span class="i">$HTML</span> .= <span class="i">$missing_lst</span><span class="i">-&gt;Printout</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	<span class="s">}</span>

	<span class="k">return</span> <span class="i">$HTML</span><span class="sc">;</span>
		    
    <span class="s">}</span>
    <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>	
<span class="s">}</span>

</pre><pre>

<span class="k">my</span> <span class="i">$summary_page</span> = <span class="q">&quot;Cronjobs_&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$summary_name</span> = <span class="q">&quot;$0_&quot;</span><span class="sc">;</span>
<span class="i">$summary_name</span> =~<span class="q">s /^(.*)\/(.+?)$/$2/</span><span class="sc">;</span>
<span class="i">$summary_name</span> =~ <span class="q">s/\.pl//g</span><span class="sc">;</span>
<span class="i">$summary_name</span> .= <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$summary_page</span> .= <span class="i">$summary_name</span> . <span class="q">&quot;.html&quot;</span><span class="sc">;</span>

<span class="c">#####################################################################</span>
<span class="c"># make page allowing for display of messages, warnings and errors</span>
<span class="c">#####################################################################</span>

<a name="create_summary_page-"></a><span class="k">sub </span><span class="m">create_summary_page</span><span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    
    <span class="k">my</span> <span class="i">$msg</span> = <span class="i">$html_header</span> . <span class="i">$java_header</span> . <span class="q">&quot;&lt;br&gt;&quot;</span> . <span class="q">&quot;&lt;div id='navtxt' class='navtext'&gt;&lt;/div&gt;\n&lt;BR&gt;&quot;</span><span class="sc">;</span>
    <span class="i">$msg</span> .= <span class="i">$self</span><span class="i">-&gt;create_HTML</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="c">#content of the email</span>
<span class="c">#print &quot;what's msg in create_summary_page: $msg, html: $tmp_dir/$summary_page\n&quot;;</span>


    <span class="k">my</span> <span class="i">$HTML</span><span class="sc">;</span>
    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;rm $tmp_dir/$summary_page&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">open</span> <span class="s">(</span><span class="i">$HTML</span><span class="cm">,</span> <span class="q">&quot;&gt;&gt;$tmp_dir/$summary_page&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="s">{</span><span class="i">$HTML</span><span class="s">}</span> <span class="i">$html_header</span><span class="sc">;</span>
    <span class="k">print</span> <span class="s">{</span><span class="i">$HTML</span><span class="s">}</span> <span class="i">$java_header</span><span class="sc">;</span>
    <span class="k">print</span> <span class="s">{</span><span class="i">$HTML</span><span class="s">}</span> <span class="q">&quot;&lt;div id='navtxt' class='navtext'&gt;&lt;/div&gt;&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="s">{</span><span class="i">$HTML</span><span class="s">}</span> <span class="i">$msg</span><span class="sc">;</span>
    <span class="k">close</span> <span class="i">$HTML</span><span class="sc">;</span>
    <span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;cp $tmp_dir/$summary_page $URL_temp_dir&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">## keep static link to latest cron summary ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$summary_page</span> =~ <span class="q">/Cron_Summary/</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">try_system_command</span><span class="s">(</span><span class="q">&quot;ln -sf $URL_temp_dir/$summary_page $URL_temp_dir/Latest_Cron_Summary.html&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$msg</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># Notify the problems to admin</span>
<span class="c">##############################</span>
<a name="send_summary-"></a><span class="k">sub </span><span class="m">send_summary</span><span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    
    <span class="k">my</span> <span class="i">$msg</span> = <span class="i">$self</span><span class="i">-&gt;create_summary_page</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    
    <span class="i">$link_to_summary</span> .= <span class="q">&quot;$summary_page&quot;</span><span class="sc">;</span>
    <span class="i">$msg</span> .= <span class="q">&quot;&lt;P&gt;&quot;</span> . <span class="i">&amp;Link_To</span><span class="s">(</span><span class="i">$link_to_summary</span><span class="cm">,</span><span class="q">'Link to Cron Summary in alDente'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$to_address</span><span class="sc">;</span> 

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$address</span> <span class="s">(</span><span class="i">@</span>{<span class="i">$self</span>-&gt;{<span class="w">notify</span>}}<span class="s">)</span> <span class="s">{</span>
        <span class="i">$to_address</span> .= <span class="q">&quot;$address&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$from_address</span> = <span class="q">&quot;System_Monitor&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$subject</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@list</span> = <span class="k">keys</span> <span class="i">%</span>{<span class="i">$self</span>-&gt;{<span class="w">cron_list</span>}} <span class="sc">;</span>
    <span class="k">my</span> <span class="i">$count</span> = <span class="i">@list</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$count</span> &gt;<span class="n">1</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$subject</span> = <span class="q">&quot;System Monitor - Cron Summary&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
	<span class="k">if</span> <span class="s">(</span><span class="k">ref</span> <span class="i">$self</span>-&gt;{<span class="w">cron_list</span>}{<span class="i">$list</span>[<span class="n">0</span>]} <span class="k">eq</span> <span class="q">'ARRAY'</span><span class="s">)</span> <span class="s">{</span> <span class="i">$subject</span> = <span class="q">&quot;System Monitor - &quot;</span>.<span class="i">$self</span>-&gt;{<span class="w">cron_list</span>}{<span class="i">$list</span>[<span class="n">0</span>]}[<span class="n">0</span>]<span class="sc">;</span> <span class="s">}</span>
	<span class="k">else</span> <span class="s">{</span> <span class="i">$subject</span> = <span class="q">&quot;System Monitor - &quot;</span>.<span class="i">$list</span>[<span class="n">0</span>]<span class="sc">;</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$msg</span><span class="s">)</span> <span class="s">{</span>
	<span class="c">#my $header = &quot;Content-type: text/html\n\n$java_header\n&quot;;</span>
	<span class="k">my</span> <span class="i">$header</span> = <span class="q">&quot;html&quot;</span><span class="sc">;</span>
	<span class="k">my</span> <span class="i">$ok</span> = <span class="i">&amp;alDente::Notification::Email_Notification</span><span class="s">(</span>
							    -<span class="w">to_address</span><span class="cm">=&gt;</span><span class="i">$to_address</span><span class="cm">,</span>
							    -<span class="w">from_address</span><span class="cm">=&gt;</span><span class="i">$from_address</span><span class="cm">,</span> 
							    -<span class="w">subject</span><span class="cm">=&gt;</span> <span class="i">$subject</span><span class="cm">,</span> 
							    -<span class="w">body_message</span><span class="cm">=&gt;</span><span class="i">$msg</span><span class="cm">,</span>
							    -<span class="w">content_type</span><span class="cm">=&gt;</span><span class="i">$header</span><span class="cm">,</span>
							    -<span class="w">verbose</span><span class="cm">=&gt;</span><span class="n">0</span><span class="cm">,</span>
							    <span class="s">)</span><span class="sc">;</span>

	<span class="c"># check if notification has been sent successfully and make an entry in the summary log</span>
	<span class="k">unless</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">return</span> <span class="q">&quot;Notification Failure&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

<span class="c">#	my $note = &quot;Email notification sent successfully on $now\n&quot;;</span>
<span class="c">#	my $summary_log	= _write_to_log (-logName=&gt;$summaryLogName,-logContent=&gt;$note,-logAppend=&gt;1);</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="k">return</span> <span class="n">1</span><span class="sc">;</span>

<span class="c">#&lt;snip&gt;</span>
<span class="c">#my $graph_gif = $self-&gt;generate_stats_graphs(-script=&gt;$script,-stats_file=&gt;$stats_file,-day_count=&gt;$day_count);</span>
<span class="c">#&lt;/snip&gt;</span>
<span class="c">###########################</span>
<a name="generate_stats_graphs-"></a><span class="k">sub </span><span class="m">generate_stats_graphs</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span>\<span class="i">@_</span><span class="cm">,</span>-<span class="w">mandatory</span><span class="cm">=&gt;</span><span class="q">'script,stats_file'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$script</span> = <span class="i">$args</span>{-<span class="w">script</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$stats_file</span> = <span class="i">$args</span>{-<span class="w">stats_file</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$day_count</span> = <span class="i">$args</span>{-<span class="w">day_count</span>} || <span class="n">7</span><span class="sc">;</span> <span class="c">## Show data for past 7 days by default;</span>

    <span class="i">$self</span>-&gt;{<span class="w">stats_files</span>}{<span class="i">$script</span>} = <span class="i">$stats_file</span><span class="sc">;</span>
   
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$stat_type</span> <span class="s">(</span><span class="q">'Errors'</span><span class="cm">,</span><span class="q">'Warnings'</span><span class="s">)</span> <span class="s">{</span>
	<span class="k">my</span> <span class="i">$x_column_name</span> = <span class="q">&quot;Date&quot;</span><span class="sc">;</span>
	<span class="k">my</span> <span class="i">$y_column_name</span> = <span class="q">&quot;$stat_type&quot;</span><span class="sc">;</span>
	<span class="k">my</span> <span class="i">$output_file</span> = <span class="q">&quot;$stats_file&quot;</span>.<span class="q">&quot;.$stat_type&quot;</span>.<span class="q">&quot;.gif&quot;</span><span class="sc">;</span>

	<span class="c">## graph asthetics:</span>
	<span class="k">my</span> <span class="i">$xsize</span> = <span class="n">100</span><span class="sc">;</span>
	<span class="k">my</span> <span class="i">$ysize</span> = <span class="n">150</span><span class="sc">;</span>
	<span class="k">my</span> <span class="i">$bar_width</span> = <span class="n">5</span><span class="sc">;</span>   
	<span class="k">my</span> <span class="i">$colour</span> = <span class="q">&quot;red&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$stat_type</span> =~ <span class="q">/error/i</span><span class="s">)</span><span class="sc">;</span>
	<span class="i">$colour</span> = <span class="q">&quot;blue&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$stat_type</span> =~ <span class="q">/warning/i</span><span class="s">)</span><span class="sc">;</span>
	<span class="k">my</span> <span class="i">$title</span> = <span class="q">&quot;$stat_type &quot;</span>. <span class="q">&quot;-$day_count&quot;</span>.<span class="q">'d'</span><span class="sc">;</span>
	<span class="k">my</span> <span class="i">$y_label</span> = <span class="q">''</span><span class="sc">;</span> <span class="c">## &quot;Days since today&quot;;</span>
	<span class="k">my</span> <span class="i">$x_label</span> = <span class="q">''</span><span class="sc">;</span> <span class="c">## &quot;$stat_type&quot;;</span>
	<span class="k">my</span> <span class="i">$y_column_name</span> = <span class="q">&quot;Date&quot;</span><span class="sc">;</span>
	<span class="k">my</span> <span class="i">$y_column_name</span> = <span class="q">&quot;$stat_type&quot;</span><span class="sc">;</span>
    
	<span class="k">require</span> <span class="w">RGTools::Graph</span><span class="sc">;</span>
	<span class="k">my</span> <span class="i">$graphed</span> = <span class="i">Graph::generate_graph</span><span class="s">(</span>-<span class="w">title</span><span class="cm">=&gt;</span><span class="i">$title</span><span class="cm">,</span>-<span class="w">output_file</span><span class="cm">=&gt;</span><span class="q">&quot;$output_file&quot;</span><span class="cm">,</span>-<span class="w">file</span><span class="cm">=&gt;</span><span class="q">&quot;$stats_file&quot;</span><span class="cm">,</span>-<span class="w">tail_lines</span><span class="cm">=&gt;</span><span class="i">$day_count</span><span class="cm">,</span>-<span class="w">x_column_name</span><span class="cm">=&gt;</span><span class="q">&quot;$x_column_name&quot;</span><span class="cm">,</span>-<span class="w">y_column_name</span><span class="cm">=&gt;</span><span class="q">&quot;$y_column_name&quot;</span><span class="cm">,</span>-<span class="w">x_label</span><span class="cm">=&gt;</span><span class="q">&quot;$x_label&quot;</span><span class="cm">,</span>-<span class="w">y_label</span><span class="cm">=&gt;</span><span class="q">&quot;$y_label&quot;</span><span class="cm">,</span>-<span class="w">xsize</span><span class="cm">=&gt;</span><span class="i">$xsize</span><span class="cm">,</span>-<span class="w">ysize</span><span class="cm">=&gt;</span><span class="i">$ysize</span><span class="cm">,</span>-<span class="w">bar_width</span><span class="cm">=&gt;</span><span class="i">$bar_width</span><span class="cm">,</span>-<span class="w">colour</span><span class="cm">=&gt;</span><span class="i">$colour</span><span class="cm">,</span>-<span class="w">nominal_x</span><span class="cm">=&gt;</span><span class="n">1</span><span class="cm">,</span>-<span class="w">x_label_skip</span><span class="cm">=&gt;</span><span class="n">1</span><span class="cm">,</span>-<span class="w">y_label_skip</span><span class="cm">=&gt;</span><span class="n">1</span><span class="s">)</span><span class="sc">;</span>
	<span class="k">if</span> <span class="s">(</span><span class="i">$graphed</span> == <span class="n">0</span><span class="s">)</span> <span class="s">{</span>
	    <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
	<span class="s">}</span>

	<span class="i">$self</span>-&gt;{<span class="w">stats_graphs</span>}{<span class="i">$script</span>}{<span class="i">$stat_type</span>} = <span class="i">$output_file</span><span class="sc">;</span>
	
    <span class="s">}</span>    

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>

<span class="s">}</span>
<a name="EOF-"></a></pre></body>

</html>
