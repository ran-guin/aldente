<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>alDente_API.pm</title>
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>alDente_API.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name__uplink_">NAME &lt;UPLINK&gt;</a></li>
	<li><a href="#synopsis__uplink_">SYNOPSIS &lt;UPLINK&gt;</a></li>
	<li><a href="#description__uplink_">DESCRIPTION &lt;UPLINK&gt;</a></li>
</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-alDente::alDente_API-">package alDente::alDente_API</a>
<ul>
<li><a href="#new-">new</a></li>
<li><a href="#DESTROY-">DESTROY</a></li>
<li><a href="#warning-">warning</a></li>
<li><a href="#warnings-">warnings</a></li>
<li><a href="#error-">error</a></li>
<li><a href="#errors-">errors</a></li>
<li><a href="#connect_to_DB-">connect_to_DB</a></li>
<li><a href="#set_log_file-">set_log_file</a></li>
<li><a href="#records-">records</a></li>
<li><a href="#get_record-">get_record</a></li>
<li><a href="#get_next_record-">get_next_record</a></li>
<li><a href="#next_record-">next_record</a></li>
<li><a href="#reset_record_index-">reset_record_index</a></li>
<li><a href="#get_lookup_data-">get_lookup_data</a></li>
<li><a href="#get_Clone_data-">get_Clone_data</a></li>
<li><a href="#get_field_type-">get_field_type</a></li>
<li><a href="#get_template_data-">get_template_data</a></li>
<li><a href="#get_stock_data-">get_stock_data</a></li>
<li><a href="#get_sample_origin_type_data-">get_sample_origin_type_data</a></li>
<li><a href="#get_library_data-">get_library_data</a></li>
<li><a href="#get_pipeline_data-">get_pipeline_data</a></li>
<li><a href="#get_trace_submission_data-">get_trace_submission_data</a></li>
<li><a href="#get_sample_data-">get_sample_data</a></li>
<li><a href="#get_source_data-">get_source_data</a></li>
<li><a href="#get_plate_data-">get_plate_data</a></li>
<li><a href="#get_rearray_data-">get_rearray_data</a></li>
<li><a href="#get_run_data-">get_run_data</a></li>
<li><a href="#get_alert_reason_data-">get_alert_reason_data</a></li>
<li><a href="#add_alert_reason-">add_alert_reason</a></li>
<li><a href="#include_condition-">include_condition</a></li>
<li><a href="#get_run_analysis_data-">get_run_analysis_data</a></li>
<li><a href="#get_genome_data-">get_genome_data</a></li>
<li><a href="#set_genome_data-">set_genome_data</a></li>
<li><a href="#add_genome-">add_genome</a></li>
<li><a href="#get_analysis_software_data-">get_analysis_software_data</a></li>
<li><a href="#get_anatomic_site_data-">get_anatomic_site_data</a></li>
<li><a href="#get_work_request_data-">get_work_request_data</a></li>
<li><a href="#get_incomplete_analysis_libraries-">get_incomplete_analysis_libraries</a></li>
<li><a href="#get_goal_data-">get_goal_data</a></li>
<li><a href="#get_control_type_data-">get_control_type_data</a></li>
<li><a href="#set_run_status-">set_run_status</a></li>
<li><a href="#set_run_comments-">set_run_comments</a></li>
<li><a href="#set_run_validation_status-">set_run_validation_status</a></li>
<li><a href="#set_run_data-">set_run_data</a></li>
<li><a href="#set_multiplex_run_analysis_data-">set_multiplex_run_analysis_data</a></li>
<li><a href="#set_multiplex_run_data-">set_multiplex_run_data</a></li>
<li><a href="#start_run_analysis-">start_run_analysis</a></li>
<li><a href="#finish_run_analysis-">finish_run_analysis</a></li>
<li><a href="#get_event_data-">get_event_data</a></li>
<li><a href="#get_original_reagents-">get_original_reagents</a></li>
<li><a href="#get_gelrun_summary-">get_gelrun_summary</a></li>
<li><a href="#get_gelrun_data-">get_gelrun_data</a></li>
<li><a href="#get_lane_data-">get_lane_data</a></li>
<li><a href="#get_band_data-">get_band_data</a></li>
<li><a href="#get_application_data-">get_application_data</a></li>
<li><a href="#generate_data-">generate_data</a></li>
<li><a href="#parse_date_condition-">parse_date_condition</a></li>
<li><a href="#is_Attribute-">is_Attribute</a></li>
<li><a href="#add_Attributes-">add_Attributes</a></li>
<li><a href="#add_edit_comments-">add_edit_comments</a></li>
<li><a href="#set_new_attribute_type-">set_new_attribute_type</a></li>
<li><a href="#query_preparation-">query_preparation</a></li>
<li><a href="#api_output-">api_output</a></li>
<li><a href="#customize_join_conditions-">customize_join_conditions</a></li>
<li><a href="#map_to_fields-">map_to_fields</a></li>
<li><a href="#extract_Aliases-">extract_Aliases</a></li>
<li><a href="#replace_Aliases-">replace_Aliases</a></li>
<li><a href="#dynamic_joins-">dynamic_joins</a></li>
<li><a href="#necessary_tables_included-">necessary_tables_included</a></li>
<li><a href="#included_tables-">included_tables</a></li>
<li><a href="#get_sample_ids-">get_sample_ids</a></li>
<li><a href="#get_plate_count-">get_plate_count</a></li>
<li><a href="#get_plate_lineage-">get_plate_lineage</a></li>
<li><a href="#get_Plate_list-">get_Plate_list</a></li>
<li><a href="#get_Plate_history-">get_Plate_history</a></li>
<li><a href="#get_libraries-">get_libraries</a></li>
<li><a href="#get_library_changes-">get_library_changes</a></li>
<li><a href="#get_plate_changes-">get_plate_changes</a></li>
<li><a href="#get_sample_changes-">get_sample_changes</a></li>
<li><a href="#get_changes-">get_changes</a></li>
<li><a href="#log_parameters-">log_parameters</a></li>
<li><a href="#_initialize_data-">_initialize_data</a></li>
<li><a href="#_password_check-">_password_check</a></li>
<li><a href="#define_alias-">define_alias</a></li>
<li><a href="#list_Aliases-">list_Aliases</a></li>
<li><a href="#_list_Fields-">_list_Fields</a></li>
<li><a href="#get_alias_info-">get_alias_info</a></li>
<li><a href="#get_failreasons-">get_failreasons</a></li>
<li><a href="#get_project_data-">get_project_data</a></li>
<li><a href="#get_submission_data-">get_submission_data</a></li>
<li><a href="#get_submission_volume_data-">get_submission_volume_data</a></li>
<li><a href="#set_rundata_annotations-">set_rundata_annotations</a></li>
<li><a href="#get_rundata_annotation_sets-">get_rundata_annotation_sets</a></li>
<li><a href="#get_rundata_annotation_value-">get_rundata_annotation_value</a></li>
<li><a href="#convert_parameters_for_summary-">convert_parameters_for_summary</a></li>
<li><a href="#add_work_request-">add_work_request</a></li>
<li><a href="#set_attribute-">set_attribute</a></li>
<li><a href="#get_attribute-">get_attribute</a></li>
<li><a href="#get_process_deviation_data-">get_process_deviation_data</a></li>
<li><a href="#set_data-">set_data</a></li>
<li><a href="#set_plate_growth-">set_plate_growth</a></li>
<li><a href="#update_rearray_well_map-">update_rearray_well_map</a></li>
<li><a href="#add_custom_aliases-">add_custom_aliases</a></li>
<li><a href="#merge_Data_on_Field-">merge_Data_on_Field</a></li>
<li><a href="#get_Atomic_data-">get_Atomic_data</a></li>
<li><a href="#_convert_parameters-">_convert_parameters</a></li>
<li><a href="#_convert_Aliases-">_convert_Aliases</a></li>
<li><a href="#_insert_quotes-">_insert_quotes</a></li>
<li><a href="#_remove_quotes-">_remove_quotes</a></li>
<li><a href="#get_source_lineage-">get_source_lineage</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p></p>
<hr />
<h1><a name="name__uplink_">NAME &lt;UPLINK&gt;</a></h1>
<p>alDente_API.pm - This module handles general access to records associated with standard alDente objects</p>
<p>
</p>
<hr />
<h1><a name="synopsis__uplink_">SYNOPSIS &lt;UPLINK&gt;</a></h1>
<pre>

 #### Example of Usage ####</pre>
<pre>

 ## Connect to the database (you may define the parameters early on and only connect later if necessary) ##
 my $API = alDente_API-&gt;new(-dbase=&gt;'sequence',-host=&gt;'lims-dbm',-user=&gt;'viewer',-password=&gt;$pass);
 $API-&gt;connect();</pre>
<pre>
 my $data    = $API-&gt;get_sample_data(-sample_id=&gt;$sample);
 my $data    = $API-&gt;get_source_data(-source_id=&gt;$source_id);
 my $data    = $API-&gt;get_run_data(-study=&gt;7,-since=&gt;'2005-10-20 00:29:00',-until=&gt;'2005-10-20 05:00:00',-include=&gt;'rejected');
 my $history = $API-&gt;get_library_changes(-study=&gt;7,-quiet=&gt;1);</pre>
<pre>
 ## get number of plates generated from 'MGC01' library... 
 my $plate_count = $API-&gt;get_plate_count(-library=&gt;'MGC01');</pre>
<pre>
 ## get a variety of info for libraries in a project (return data into a hash with library names as keys).
 my $data = $API-&gt;get_library_data(-project_id=&gt;6,-key=&gt;'library');</pre>
<pre>
 #########################
 ## other useful calls: ##
 #########################</pre>
<pre>
  ## list available fields (useful if you do not know what fields are available)
  my $data = $API-&gt;get_library_data(-list_fields=&gt;1);</pre>
<pre>
  ## debug option (shows you the query used without executing it)
  my $data = $API-&gt;get_run_data(-debug=&gt;1);</pre>
<pre>
 #################################
 Using the API as a web service:
 #################################
    Authentication:  LDAP
    Username: LDAP username
    Password: LDAP password
        (ie same password for JIRA)</pre>
<pre>
        &lt;b&gt;PERL Example:&lt;/b&gt;
        
        use XMLRPC::Lite;</pre>
<pre>
        my $web_service_client =  XMLRPC::Lite -&gt;proxy(&quot;<a href="http://lims02.bcgsc.ca/SDB_beta/cgi-bin/Web_Service.pl&quot">http://lims02.bcgsc.ca/SDB_beta/cgi-bin/Web_Service.pl&quot</a>;);</pre>
<pre>
        ## Creating a login object</pre>
<pre>
        my $valid_login = $web_service_client-&gt;call('lims_web_service.login',{'username' =&gt;'testlims', 'password' =&gt;'testlims'})-&gt; result;</pre>
<pre>
        ## Calling an API method:</pre>
<pre>
        my $data = $web_service_client-&gt;call('lims_web_service.&amp;lt;API_method_name&amp;gt;', &amp;lt;login_object&amp;gt;, &amp;lt;api arguments as HASHREF&amp;gt; );</pre>
<p>for example:</p>
<pre>
        my $data = $web_service_client-&gt;call(
            'lims_web_service.get_run_data',$valid_login
            ,{ 'library' =&gt; 'mylib' }
        ) -&gt; result;
        
        print Dumper $data;</pre>
<pre>
        &lt;b&gt;Python Example:&lt;/b&gt;
        
        #!/usr/local/bin/python</pre>
<pre>
        from xmlrpclib import ServerProxy</pre>
<pre>
        limsy = ServerProxy(&quot;<a href="http://lims02.bcgsc.ca/SDB_beta/cgi-bin/Web_Service.pl&quot">http://lims02.bcgsc.ca/SDB_beta/cgi-bin/Web_Service.pl&quot</a>;)</pre>
<pre>
        login = limsy.lims_web_service.login( {'username':'testlims','password':'testlims'} )</pre>
<pre>
        data = limsy.lims_web_service.get_run_data(login,{'library':'mylib' })</pre>
<pre>
        print data</pre>
<pre>
        &lt;b&gt;Java Example:&lt;/b&gt;</pre>
<pre>
        import java.net.MalformedURLException;
        import java.net.URL;
        import java.util.*;</pre>
<pre>
        import org.apache.xmlrpc.XmlRpcException;
        import org.apache.xmlrpc.client.XmlRpcClient;
        import org.apache.xmlrpc.client.XmlRpcClientConfigImpl;
        import org.apache.xmlrpc.client.XmlRpcCommonsTransportFactory;</pre>
<pre>
        .........
        try {
                // create a configuration
                XmlRpcClientConfigImpl config = new XmlRpcClientConfigImpl();
                config.setServerURL(new URL(&quot;<a href="http://lims02.bcgsc.ca/SDB/cgi-bin/Web_Service.pl&quot">http://lims02.bcgsc.ca/SDB/cgi-bin/Web_Service.pl&quot</a>;));
                config.setBasicUserName(&quot;testlims&quot;);
                config.setBasicPassword(&quot;testlims&quot;);
      
                // create a client and set configuration
                XmlRpcClient client = new XmlRpcClient();
                client.setTransportFactory(new XmlRpcCommonsTransportFactory(client));
                client.setConfig(config);
      
                // connect to retrieve loginResult
                Hashtable login = new Hashtable();
                login.put(&quot;username&quot;, &quot;testlims&quot;);
                login.put(&quot;password&quot;, &quot;testlims&quot;);
                Vector logparams = new Vector();
                logparams.add(login);
                // use HashMap so that you can pass it to the next execute call
                HashMap loginResult = new HashMap();
                loginResult =(HashMap)client.execute(&quot;lims_web_service.login&quot;,logparams);    
   
                // connect to retrieve data
                Vector params = new Vector();
                params.add(loginResult);
      
                Hashtable hashArg = new Hashtable();
                hashArg.put(&quot;-fields&quot;,  &quot;library,plate_number&quot;);
                hashArg.put(&quot;-condition&quot;, &quot;run_id=58663&quot;);
      
                params.add(hashArg);
      
                HashMap result = new HashMap();
                result = (HashMap)(client.execute(&quot;lims_web_service.get_run_data&quot;,params));</pre>
<pre>
                // step through the result to get the value
                Set keySet = result.keySet();
                Iterator it = keySet.iterator();
                while (it.hasNext() == true){
                    String key = (String)(it.next());</pre>
<pre>
                    if (result.containsKey(key) == true){
                        Object[] value = (Object[])(result.get(key));
                        for (int i = 0; i &amp;lt; value.length; i++){
                             System.out.println(key + &quot;[&quot; + i + &quot;]: &quot; + value[i].toString());
                        }</pre>
<pre>
                    }
                }
          }catch (MalformedURLException e) {
                e.printStackTrace();
          } catch (XmlRpcException e) {
                e.printStackTrace();
          }
      ............</pre>
<pre>
 NOTE:  The api arguments passed into the web service are equivalent to those passed directly to the API</pre>
<p>
</p>
<hr />
<h1><a name="description__uplink_">DESCRIPTION &lt;UPLINK&gt;</a></h1>
This module handles custom data access functions for the sequencing plug-in<BR>


<hr /><pre><span class="c">################################################################################</span>
<span class="c"># alDente_API.pm</span>
<span class="c">#</span>
<span class="c"># This module handles data access functions for general alDente objects</span>
<span class="c">#</span>
<span class="c"># More application specific API's may also be available that inherit the alDente_API object,</span>
<span class="c"># but which may access data more specific to the needs of the application.</span>
<span class="c"># (eg. the Sequencing/Sequencing_API module accesses information pertaining to sequence data)</span>
<span class="c">#</span>
<span class="c">###############################################################################</span>
<a name="package-alDente::alDente_API-"></a><span class="k">package </span><span class="i">alDente::alDente_API</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># perldoc_header             #</span>
<span class="c">##############################</span>

</pre><pre>
<span class="c">##############################</span>
<span class="c"># superclasses               #</span>
<span class="c">##############################</span>

<span class="i">@ISA</span> = <span class="q">qw(Exporter SDB::DBIO)</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># system_variables           #</span>
<span class="c">##############################</span>
<span class="k">require</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="i">@EXPORT</span> = <span class="q">qw(</span>
    <span class="q">connect_to_DB</span>
    <span class="q">map_to_fields</span>
<span class="q">)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">lib</span> <span class="i">$FindBin::RealBin</span> . <span class="q">&quot;/../lib/perl/Imported/&quot;</span><span class="sc">;</span>
<span class="c">##############################</span>
<span class="c"># standard_modules_ref       #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="w">CGI</span> <span class="q">qw(:standard)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">JSON</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Benchmark</span><span class="sc">;</span>

<span class="c">#use AutoLoader;</span>
<span class="k">use</span> <span class="w">Carp</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># custom_modules_ref         #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="w">SDB::DBIO</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::DB_Object</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::CustomSettings</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::HTML</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::Views</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::Conversion</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::RGIO</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::RGmath</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Run</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::SDB_Defaults</span> <span class="q">qw($project_dir %object_aliases)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Sequencing::Tools</span> <span class="q">qw(SQL_phred)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Sequencing::Sequencing_Library</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Library</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Container</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Well</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::ReArray</span><span class="sc">;</span>
<span class="c">## use alDente::Clone_Sample;</span>
<span class="k">use</span> <span class="w">alDente::Employee</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Validation</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># global_vars                #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># custom_modules_ref #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># global_vars                #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw($AUTOLOAD $testing $Security $project_dir $Web_log_directory %Aliases %object_aliases $Connection %Attr_Aliases)</span><span class="sc">;</span>
<span class="c">##############################</span>
<span class="c"># modular_vars               #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># constants                  #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># main_header                #</span>
<span class="c">##############################</span>
<span class="k">my</span> <span class="i">$Q20</span> = <span class="i">SQL_phred</span><span class="s">(</span><span class="n">20</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$Q30</span> = <span class="i">SQL_phred</span><span class="s">(</span><span class="n">30</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$Q40</span> = <span class="i">SQL_phred</span><span class="s">(</span><span class="n">40</span><span class="s">)</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">sequenced_plate</span>}                    = <span class="q">&quot;Run.FK_Plate__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_name</span>}                           = <span class="q">&quot;Run.Run_Directory&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_display_name</span>}                   = <span class="q">&quot;Run.Run_Directory&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">subdirectory</span>}                       = <span class="q">&quot;Run.Run_Directory&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">earliest_run</span>}                       = <span class="q">&quot;Min(Run.Run_DateTime)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">latest_run</span>}                         = <span class="q">&quot;Max(Run.Run_DateTime)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_status</span>}                         = <span class="q">&quot;Run.Run_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">validation</span>}                         = <span class="q">&quot;Run.Run_Validation&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">billable</span>}                           = <span class="q">&quot;Run.Billable&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">test_status</span>}                        = <span class="q">&quot;Run.Run_Test_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_QC_status</span>}                      = <span class="q">&quot;Run.QC_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_qc_alert</span>}                       = <span class="q">&quot;Run_Alert.Alert_Reason&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_qc_alert_notes</span>}                 = <span class="q">&quot;Run_Alert.Alert_Reason_Notes&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_qc_alert_id</span>}                    = <span class="q">&quot;Run_Alert.Alert_Reason_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run</span>}{<span class="w">multiplex_qc_alert_id</span>}    = <span class="q">&quot;Multiplex_Run_Alert.Alert_Reason_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run</span>}{<span class="w">multiplex_qc_alert</span>}       = <span class="q">&quot;Multiplex_Run_Alert.Alert_Reason&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run</span>}{<span class="w">multiplex_qc_alert_notes</span>} = <span class="q">&quot;Multiplex_Run_Alert.Alert_Reason_Notes&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">flowcell_code</span>}                                  = <span class="q">&quot;Flowcell.Flowcell_Code&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">grafted_datetime</span>}                               = <span class="q">&quot;Flowcell.Grafted_Datetime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">lot_number</span>}                                     = <span class="q">&quot;Flowcell.Lot_Number&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">run_tray_id</span>}                                    = <span class="q">&quot;Flowcell.FK_Tray__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">lane</span>}                                           = <span class="q">&quot;SolexaRun.Lane&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">sample_name</span>}                                    = <span class="q">&quot;Sample.Sample_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">plate_id</span>}                                       = <span class="q">&quot;Plate.Plate_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">flowcell_id</span>}                                    = <span class="q">&quot;Flowcell.Flowcell_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">cycles</span>}                                         = <span class="q">&quot;SolexaRun.Cycles&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">solexarun_type</span>}                                 = <span class="q">&quot;SolexaRun.SolexaRun_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">solexarun_mode</span>}                                 = <span class="q">&quot;SolexaRun.SolexaRun_Mode&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">solexarun_finished</span>}                             = <span class="q">&quot;SolexaRun.SolexaRun_Finished&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">solexa_end_read_type</span>}                           = <span class="q">&quot;Solexa_Read.End_Read_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">solexa_tiles_analyzed</span>}                          = <span class="q">&quot;Solexa_Read.Tiles_Analyzed&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">solexa_raw_clusters</span>}                            = <span class="q">&quot;Solexa_Read.Raw_Clusters&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">solexa_pf_clusters_percent</span>}                     = <span class="q">&quot;Solexa_Read.PF_Clusters_Percent&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">solexa_lane_yield_kb</span>}                           = <span class="q">&quot;Solexa_Read.Lane_Yield_KB&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">solexa_pf_clusters</span>}                             = <span class="q">&quot;Solexa_Read.PF_Clusters&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">submission_experiment_paired_2nd_base_coord</span>}    = <span class="q">&quot;SolexaRun.Cycles + 1&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">submission_experiment_number_of_reads_per_spot</span>} = <span class="q">&quot;CASE WHEN (SolexaRun.SolexaRun_Type ='Single') THEN ('1') WHEN (SolexaRun.SolexaRun_Type ='Paired') THEN ('2') END&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SolexaRun</span>}{<span class="w">multiplex_run</span>}                                  = <span class="q">&quot;'View Multiplex Info'&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">solexa_phasing</span>}                               = <span class="q">&quot;Solexa_Read.Phasing&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">solexa_prephasing</span>}                            = <span class="q">&quot;Solexa_Read.Prephasing&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">solexa_read_length</span>}                           = <span class="q">&quot;Solexa_Read.Read_Length&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">number_reads</span>}                                 = <span class="q">&quot;Solexa_Read.Number_Reads&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">bwa_analysis_dir</span>}                             = <span class="q">&quot;CONCAT('BWA_',Date(Run_Analysis_Started))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">bismark_analysis_dir</span>}                         = <span class="q">&quot;CONCAT('BISMARK_',Date(Run_Analysis_Started))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">illumina_pipeline</span>}                            = <span class="q">&quot;Analysis_Pipeline.Pipeline_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">illumina_pipeline_id</span>}                         = <span class="q">&quot;Solexa_Read.FKAnalysis_Pipeline__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">pf_q20_percent</span>}                               = <span class="q">&quot;Solexa_Read.PF_Q20_Percent&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">pf_q30_percent</span>}                               = <span class="q">&quot;Solexa_Read.PF_Q30_Percent&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Read</span>}{<span class="w">number_mismatched_reads</span>}                      = <span class="q">&quot;Solexa_Read.Number_Mismatched_Reads&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">reference_genome_name</span>}                             = <span class="q">&quot;Genome.Genome_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">reference_genome_path</span>}                             = <span class="q">&quot;Genome.Genome_Path&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">reference_genome_id</span>}                               = <span class="q">&quot;Genome.Genome_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">taxonomy_id</span>}                                       = <span class="q">&quot;Genome.FK_Taxonomy__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">reference_genome_url</span>}                              = <span class="q">&quot;Genome.Genome_URL&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">reference_genome_alias</span>}                            = <span class="q">&quot;Genome.Genome_Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">reference_genome_type</span>}                             = <span class="q">&quot;Genome.Genome_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">reference_genome_status</span>}                           = <span class="q">&quot;Genome.Genome_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">parent_reference_genome_id</span>}                        = <span class="q">&quot;Genome.FKParent_Genome__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">reference_sort_order</span>}                              = <span class="q">&quot;Genome.Genome_Reference_Sort_Order&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Genome</span>}{<span class="w">default_genome</span>}                                    = <span class="q">&quot;Genome.Default_Genome&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Assembly_Sequence</span>}{<span class="w">chromosomes</span>}                            = <span class="q">&quot;group_concat(distinct(Assembly_Sequence.Reference_Label) order by Reference_Label asc)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Assembly_Sequence</span>}{<span class="w">assembly_accessions</span>}                    = <span class="q">&quot;group_concat(distinct(Assembly_Sequence.Unique_Identifier) order by Reference_Label asc)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">run_analysis_started</span>}                        = <span class="q">&quot;Run_Analysis.Run_Analysis_Started&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">run_analysis_finished</span>}                       = <span class="q">&quot;Run_Analysis.Run_Analysis_Finished&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">run_analysis_current</span>}                        = <span class="q">&quot;Run_Analysis.Current_Analysis&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">run_analysis_sample_id</span>}                      = <span class="q">&quot;Run_Analysis.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">parent_run_analysis_id</span>}                      = <span class="q">&quot;Run_Analysis.FKParent_Run_Analysis__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">run_analysis_test_mode</span>}                      = <span class="q">&quot;Run_Analysis.Run_Analysis_Test_Mode&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">run_analysis_type</span>}                           = <span class="q">&quot;Run_Analysis.Run_Analysis_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">run_analysis_status</span>}                         = <span class="q">&quot;Run_Analysis.Run_Analysis_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">run_analysis_comments</span>}                       = <span class="q">&quot;Run_Analysis.Run_Analysis_Comments&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run_Analysis</span>}{<span class="w">run_analysis_pipeline_id</span>}                    = <span class="q">&quot;Run_Analysis.FKAnalysis_Pipeline__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Run_Analysis</span>}{<span class="w">solexa_reference_genome_id</span>}           = <span class="q">&quot;Solexa_Run_Analysis.FK_Genome__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Run_Analysis</span>}{<span class="w">solexa_read1_aligned_length</span>}          = <span class="q">&quot;Solexa_Run_Analysis.Read1_Aligned_Length&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solexa_Run_Analysis</span>}{<span class="w">solexa_read2_aligned_length</span>}          = <span class="q">&quot;Solexa_Run_Analysis.Read2_Aligned_Length&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SOLID_Run_Analysis</span>}{<span class="w">solid_reference_genome_id</span>}             = <span class="q">&quot;SOLID_Run_Analysis.FK_Genome__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SOLID_Run_Analysis</span>}{<span class="w">solid_end_read_type</span>}                   = <span class="q">&quot;SOLID_Run_Analysis.End_Read_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SOLID_Run_Analysis</span>}{<span class="w">solid_number_reads</span>}                    = <span class="q">&quot;SOLID_Run_Analysis.Number_Reads&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SOLID_Run_Analysis</span>}{<span class="w">solid_zero_missmatch</span>}                  = <span class="q">&quot;SOLID_Run_Analysis.Zero_Missmatch&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SOLID_Run_Analysis</span>}{<span class="w">solid_megabases_of_coverage</span>}           = <span class="q">&quot;SOLID_Run_Analysis.Megabases_Of_Coverage&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SOLID_Run_Analysis</span>}{<span class="w">solid_reads_per_start</span>}                 = <span class="q">&quot;SOLID_Run_Analysis.Reads_Per_Start&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SOLID_Run_Analysis</span>}{<span class="w">solid_number_aligned_reads</span>}            = <span class="q">&quot;SOLID_Run_Analysis.Number_Aligned_Reads&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SOLID_Run_Analysis</span>}{<span class="w">bioscope_analysis_dir</span>}                 = <span class="q">&quot;CONCAT('bioscope_',Date(Run_Analysis_Started))&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Multiplex_Run</span>}{<span class="w">multiplex_adapter_index</span>}                       = <span class="q">&quot;Multiplex_Run.Adapter_Index&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run_Analysis</span>}{<span class="w">multiplex_solexa_reference_genome_id</span>} = <span class="q">&quot;Multiplex_Solexa_Run_Analysis.FK_Genome__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run_Analysis</span>}{<span class="w">multiplex_solexa_number_reads</span>}        = <span class="q">&quot;Multiplex_Solexa_Run_Analysis.Number_Reads&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run_Analysis</span>}{<span class="w">multiplex_sample_id</span>}                  = <span class="q">&quot;Multiplex_Run_Analysis.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run_Analysis</span>}{<span class="w">multiplex_analysis_sample</span>}            = <span class="q">&quot;Multiplex_Run_Analysis.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run_Analysis</span>}{<span class="w">multiplex_analysis_test_mode</span>}         = <span class="q">&quot;Multiplex_Run_Analysis.Multiplex_Run_Analysis_Test_Mode&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run</span>}{<span class="w">multiplex_run_qc_status</span>}                       = <span class="q">&quot;Multiplex_Run.Multiplex_Run_QC_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Multiplex_Run</span>}{<span class="w">multiplex_run_id</span>}                              = <span class="q">&quot;Multiplex_Run.Multiplex_Run_ID&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">LS_454Run</span>}{<span class="w">cycles</span>} = <span class="q">&quot;LS_454Run.Cycles&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Analysis_Software</span>}{<span class="w">analysis_software_id</span>}   = <span class="q">&quot;Analysis_Software.Analysis_Software_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Analysis_Software</span>}{<span class="w">analysis_software_name</span>} = <span class="q">&quot;Analysis_Software.Analysis_Software_Name&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Average_Q20</span>}              = <span class="q">&quot;Sum(SequenceAnalysis.Q20total)/Sum(Wells)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Total_Q20</span>}                = <span class="q">&quot;Sum(SequenceAnalysis.Q20total)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Average_QL</span>}               = <span class="q">&quot;Sum(SequenceAnalysis.QLtotal)/Sum(Wells)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Total_QL</span>}                 = <span class="q">&quot;Sum(SequenceAnalysis.QLtotal)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Average_SL</span>}               = <span class="q">&quot;Sum(SequenceAnalysis.SLtotal)/Sum(Wells)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Total_SL</span>}                 = <span class="q">&quot;Sum(SequenceAnalysis.SLtotal)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Average_V</span>}                = <span class="q">&quot;Sum(SequenceAnalysis.Vtotal)/Sum(Wells)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Total_V</span>}                  = <span class="q">&quot;Sum(SequenceAnalysis.Vtotal)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Total_QV</span>}                 = <span class="q">&quot;Sum(SequenceAnalysis.QVTotal)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Average_Length</span>}           = <span class="q">&quot;Sum(SequenceAnalysis.SLtotal)/Sum(Wells)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Total_Length</span>}             = <span class="q">&quot;Sum(SequenceAnalysis.SLtotal)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Maximum_Q20</span>}              = <span class="q">&quot;Max(SequenceAnalysis.Q20max)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Average_Trimmed_Length</span>}   = <span class="q">&quot;Sum(SequenceAnalysis.QLTotal - QVtotal)/Sum(Wells)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">Total_Trimmed_Length</span>}     = <span class="q">&quot;Sum(SequenceAnalysis.QLTotal - QVtotal)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">successful_reads</span>}         = <span class="q">&quot;Sum(SequenceAnalysis.successful_reads)&quot;</span><span class="sc">;</span>                           <span class="c">## QL &gt; 100</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">trimmed_successful_reads</span>} = <span class="q">&quot;Sum(SequenceAnalysis.trimmed_successful_reads)&quot;</span><span class="sc">;</span>                   <span class="c">## QL - VQ &gt; 100</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">success_rate</span>}             = <span class="q">&quot;Sum(SequenceAnalysis.successful_reads)/Sum(Wells)*100&quot;</span><span class="sc">;</span>            <span class="c">## % with QL &gt; 100 (excluding No grows, unused wells)</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">trimmed_success_rate</span>}     = <span class="q">&quot;Sum(SequenceAnalysis.trimmed_successful_reads)/Sum(Wells)*100&quot;</span><span class="sc">;</span>    <span class="c">## % with QL &gt; 100 (excluding No grows, unused wells)</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">reads</span>}                    = <span class="q">&quot;Sum(SequenceAnalysis.AllReads)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">good_reads</span>}               = <span class="q">&quot;Sum(SequenceAnalysis.Wells)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">no_grows</span>}                 = <span class="q">&quot;Sum(SequenceAnalysis.NGs)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">primer</span>}                   = <span class="q">&quot;Primer.Primer_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">mask_restriction_site</span>}    = <span class="q">&quot;SequenceAnalysis.mask_restriction_site&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">analysis_time</span>}            = <span class="q">&quot;SequenceAnalysis_DateTime&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_id</span>}                        = <span class="q">&quot;Run.Run_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_type</span>}                      = <span class="q">&quot;Run.Run_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">sequencer</span>}                     = <span class="q">&quot;RunBatch.FK_Equipment__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_time</span>}                      = <span class="q">&quot;Run_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">month</span>}                         = <span class="q">&quot;MONTHNAME(Run.Run_DateTime)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">year</span>}                          = <span class="q">&quot;Year(Run_DateTime)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_comments</span>}                  = <span class="q">&quot;CASE WHEN Length(RunBatch.RunBatch_Comments) &gt; 0 &quot;</span> . <span class="q">&quot;THEN concat(RunBatch.RunBatch_Comments,'; ',Run.Run_Comments) &quot;</span> . <span class="q">&quot;ELSE Run.Run_Comments END&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">full_run_path</span>}                 = <span class="q">&quot;concat('$Configs{project_dir}','/',Project.Project_Path,'/',Library.Library_Name,'/AnalyzedData/',Run.Run_Directory)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_time_xml_datetime_format</span>}  = <span class="q">&quot;DATE_FORMAT(CONVERT_TZ(Run_DateTime,'SYSTEM','+00:00'), '%Y-%m-%dT%TZ')&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">BAC_trace_submission_run_date</span>} = <span class="q">&quot;Left(Run_DateTime,10)&quot;</span><span class="sc">;</span>

<span class="c"># aliases below use SequenceAnalysis</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">runs</span>}                  = <span class="q">&quot;count(DISTINCT Run_ID)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">chemistry_code</span>}        = <span class="q">&quot;Plate.FK_Branch__Code&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">unique_samples</span>}        = <span class="q">&quot;count(DISTINCT Clone_Sequence.FK_Sample__ID)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">unique_sample_reads</span>}   = <span class="q">&quot;count(DISTINCT concat(Clone_Sequence.FK_Sample__ID,Plate.FK_Branch__Code))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">unique_wells</span>}  = <span class="q">&quot;count(DISTINCT concat(Library_Name,Plate_Number,Parent_Quadrant,Clone_Sequence.Well))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SequenceRun</span>}{<span class="w">unique_reads</span>}  = <span class="q">&quot;count(DISTINCT concat(Library_Name,Plate_Number,Parent_Quadrant,Clone_Sequence.Well,Plate.FK_Branch__Code))&quot;</span><span class="sc">;</span>    <span class="c">## unique clones + chemistry</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">history</span>}             = <span class="q">&quot;'View Plate History'&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">scheduled_pipelines</span>} = <span class="q">&quot;'Scheduled Pipelines'&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">work_request</span>}        = <span class="q">&quot;Plate.FK_Work_Request__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Project</span>}{<span class="w">project</span>}           = <span class="q">&quot;Project.Project_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Project</span>}{<span class="w">project_id</span>}        = <span class="q">&quot;Project.Project_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Project</span>}{<span class="w">project_path</span>}      = <span class="q">&quot;Project.Project_Path&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Project</span>}{<span class="w">project_started</span>}   = <span class="q">&quot;Project.Project_Initiated&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Project</span>}{<span class="w">project_completed</span>} = <span class="q">&quot;Project.Project_Completed&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Project</span>}{<span class="w">project_status</span>}    = <span class="q">&quot;Project.Project_Status&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">data_path</span>} = <span class="q">&quot;concat('$Configs{project_dir}','/',Project.Project_Path,'/',Library.Library_Name,'/AnalyzedData')&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Study</span>}{<span class="w">study</span>}             = <span class="q">&quot;Study.Study_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Study</span>}{<span class="w">study_id</span>}          = <span class="q">&quot;Study.Study_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Study</span>}{<span class="w">study_description</span>} = <span class="q">&quot;Study.Study_Description&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">original_contact</span>}              = <span class="q">&quot;Original_Contact.Contact_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">original_contact_organization</span>} = <span class="q">&quot;Original_Organization.Organization_Name&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Contact</span>}{<span class="w">original_contact_position</span>} = <span class="q">&quot;Original_Contact.Position&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Contact</span>}{<span class="w">original_contact_phone</span>}    = <span class="q">&quot;Original_Contact.Contact_Phone&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Contact</span>}{<span class="w">original_contact_email</span>}    = <span class="q">&quot;Original_Contact.Contact_Email&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Contact</span>}{<span class="w">contact</span>}                   = <span class="q">&quot;Contact.Contact_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Contact</span>}{<span class="w">contact_position</span>}          = <span class="q">&quot;Contact.Position&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Contact</span>}{<span class="w">contact_phone</span>}             = <span class="q">&quot;Contact.Contact_Phone&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Contact</span>}{<span class="w">contact_email</span>}             = <span class="q">&quot;Contact.Contact_Email&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Organization</span>}{<span class="w">organization</span>}         = <span class="q">&quot;Organization.Organization_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Organization</span>}{<span class="w">contact_organization</span>} = <span class="q">&quot;Organization.Organization_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Organization</span>}{<span class="w">organization_phone</span>}   = <span class="q">&quot;Organization.Phone&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">description</span>}             = <span class="q">&quot;Library.Library_Description&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library</span>}                 = <span class="q">&quot;Library.Library_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_source</span>}          = <span class="q">&quot;Library.Library_Source&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_started</span>}         = <span class="q">&quot;Library.Library_Obtained_Date&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_completed</span>}       = <span class="q">&quot;Library.Library_Completion_Date&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_type</span>}            = <span class="q">&quot;Library.Library_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_source_name</span>}     = <span class="q">&quot;Library.External_Library_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">external_library_name</span>}   = <span class="q">&quot;Library.External_Library_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_format</span>}          = <span class="q">&quot;Vector_Based_Library.Vector_Based_Library_Format&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">vector</span>}                  = <span class="q">&quot;Vector_Type.Vector_Type_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">sequencing_library_type</span>} = <span class="q">&quot;Vector_Based_Library.Vector_Based_Library_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">group_name</span>}              = <span class="q">&quot;Grp.Grp_Name&quot;</span><span class="sc">;</span>

<span class="c">## SAGE Stuff</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">SAGE_library_type</span>} = <span class="q">&quot;SAGE_Library.SAGE_Library_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">anchoring_enzyme</span>}  = <span class="q">&quot;Anchoring_Enzyme.Enzyme_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">tagging_enzyme</span>}    = <span class="q">&quot;Tagging_Enzyme.Enzyme_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">tags_requested</span>}    = <span class="q">&quot;SAGE_Library.Tags_Requested&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">SAGE_type</span>}         = <span class="q">&quot;SAGE_Library.SAGE_Library_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">primer</span>}            = <span class="q">&quot;Primer.Primer_Name&quot;</span><span class="sc">;</span>

<span class="c">#$Aliases{Library}{direction} = &quot;LibraryApplication.Direction&quot;;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">direction</span>}           = <span class="q">&quot;SequenceRun.Run_Direction&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_format</span>}      = <span class="q">&quot;Vector_Based_Library.Vector_Based_Library_Format&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_status</span>}      = <span class="q">&quot;Library.Library_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_description</span>} = <span class="q">&quot;Library.Library_Description&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">starting_amount_ng</span>}  = <span class="q">&quot;SAGE_Library.Starting_RNA_DNA_Amnt_ng&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_goal</span>}            = <span class="q">&quot;GROUP_CONCAT(Library_Goal.Goal_Name)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_goal_target</span>}     = <span class="q">&quot;GROUP_CONCAT(Library_Work_Request.Goal_Target)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_goal_target_sum</span>} = <span class="q">&quot;SUM(Library_Work_Request.Goal_Target)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Funding</span>}{<span class="w">project_funding_source</span>}  = <span class="q">&quot;GROUP_CONCAT(Library_Funding.Funding_Source)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">library_funding</span>}         = <span class="q">&quot;GROUP_CONCAT(Library_Funding.Funding_Code)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Project</span>}{<span class="w">project_funding</span>}         = <span class="q">&quot;GROUP_CONCAT(Library_Funding.Funding_Code)&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">distinct_library_goal</span>}           = <span class="q">&quot;GROUP_CONCAT(DISTINCT(CONCAT(Work_Request_ID, ': ', Library_Goal.Goal_Name)))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">distinct_library_goal_target</span>}    = <span class="q">&quot;GROUP_CONCAT(DISTINCT(CONCAT(Work_Request_ID, ': ', Library_Work_Request.Goal_Target)))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Funding</span>}{<span class="w">distinct_project_funding_source</span>} = <span class="q">&quot;GROUP_CONCAT(DISTINCT(CONCAT(Work_Request_ID, ': ', Library_Funding.Funding_Source)))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Library</span>}{<span class="w">distinct_library_funding</span>}        = <span class="q">&quot;GROUP_CONCAT(DISTINCT(CONCAT(Work_Request_ID, ': ', Library_Funding.Funding_Code)))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Project</span>}{<span class="w">distinct_project_funding</span>}        = <span class="q">&quot;GROUP_CONCAT(DISTINCT(CONCAT(Work_Request_ID, ': ', Library_Funding.Funding_Code)))&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Funding</span>}{<span class="w">funding_source</span>} = <span class="q">&quot;Library_Funding.Funding_Source&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Funding</span>}{<span class="w">funding_code</span>}   = <span class="q">&quot;Library_Funding.Funding_Code&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_funding</span>}     = <span class="q">'GROUP_CONCAT(Plate_Funding.Funding_Code)'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_goal</span>}        = <span class="q">'GROUP_CONCAT(Plate_Goal.Goal_Name)'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_goal_target</span>} = <span class="q">'GROUP_CONCAT(Plate_Work_Request.Goal_Target)'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">distinct_plate_funding</span>}     = <span class="q">&quot;GROUP_CONCAT(DISTINCT(CONCAT(Work_Request_ID, ': ', Plate_Funding.Funding_Code)))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">distinct_plate_goal</span>}        = <span class="q">&quot;GROUP_CONCAT(DISTINCT(CONCAT(Work_Request_ID, ': ', Plate_Goal.Goal_Name)))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">distinct_plate_goal_target</span>} = <span class="q">&quot;GROUP_CONCAT(DISTINCT(CONCAT(Work_Request_ID, ': ', Plate_Work_Request.Goal_Target)))&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">original_source_name</span>} = <span class="q">&quot;Original_Source.Original_Source_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">original_source_id</span>}   = <span class="q">'Original_Source.Original_Source_ID'</span><span class="sc">;</span>

<span class="c"># $Aliases{Original_Source}{organism            } = &quot;Organism.Organism_Name&quot;;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">organism</span>}      = <span class="q">&quot;Taxonomy.Taxonomy_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">taxonomy_id</span>}   = <span class="q">&quot;Taxonomy.Taxonomy_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">common_name</span>}   = <span class="q">&quot;Taxonomy.Common_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">taxonomy_name</span>} = <span class="q">&quot;Taxonomy.Taxonomy_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">species</span>}       = <span class="q">&quot;Taxonomy.Taxonomy_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">sub_species</span>}   = <span class="q">&quot;''&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">original_source_description</span>} = <span class="q">&quot;Original_Source.Description&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">pathology_alias</span>}             = <span class="q">&quot;Field_Reference(Pathology_ID)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">anatomic_site</span>}               = <span class="q">&quot;Anatomic_Site.Anatomic_Site_Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">cell_line_name</span>}              = <span class="q">&quot;Cell_Line.Cell_Line_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">original_source_type</span>}        = <span class="q">&quot;Original_Source.Original_Source_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">disease_status</span>}              = <span class="q">&quot;Original_Source.Disease_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">pathology_type</span>}              = <span class="q">&quot;Original_Source.Pathology_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">pathology_stage</span>}             = <span class="q">&quot;Original_Source.Pathology_Stage&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">pathology_grade</span>}             = <span class="q">&quot;Original_Source.Pathology_Grade&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Original_Source</span>}{<span class="w">pathology_occurrence</span>}        = <span class="q">&quot;Original_Source.Pathology_Occurrence&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Pathology</span>}{<span class="w">path_alias</span>}             = <span class="q">&quot;Pathology.Pathology_Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Anatomic_Site</span>}{<span class="w">anatomic_site_name</span>} = <span class="q">&quot;Anatomic_Site.Anatomic_Site_Name&quot;</span><span class="sc">;</span>

<span class="c"># $Aliases{Original_Source}{species            } = &quot;Organism.Species&quot;;</span>
<span class="c"># $Aliases{Original_Source}{sub_species}         = &quot;Organism.Sub_species&quot;;</span>

<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">stage</span>}                                 = <span class="q">&quot;Stage.Stage_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">strain</span>}                                = <span class="q">&quot;Strain.Strain_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">sex</span>}                                   = <span class="q">&quot;Original_Source.Sex&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">host</span>}                                  = <span class="q">&quot;Original_Source.Host&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">parent_source</span>}                         = <span class="q">&quot;PoolSrc.Source_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">external_id</span>}                           = <span class="q">&quot;Source.External_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">source_received_date</span>}                  = <span class="q">&quot;Source.Received_Date&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenografted</span>}                           = <span class="q">&quot;Source.Xenograft&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenograft_engraftment_time_weeks</span>}      = <span class="q">&quot;Xenograft.Engraftment_Time_in_Weeks&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenograft_harvest_date</span>}                = <span class="q">&quot;Xenograft.Harvest_Date&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenograft_transplant_anatomic_site_id</span>} = <span class="q">&quot;FKTransplant_Anatomic_Site__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenograft_harvest_anatomic_site_id</span>}    = <span class="q">&quot;FKHarvest_Anatomic_Site__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenograft_transplant_method</span>}           = <span class="q">&quot;Transplant_Method.Transplant_Method_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenograft_host_patient_identifier</span>}     = <span class="q">&quot;Host_Patient.Patient_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenograft_host_patient_taxonomy</span>}       = <span class="q">&quot;Host_Patient.FK_Taxonomy__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenograft_patient_birthdate</span>}           = <span class="q">&quot;Host_Patient.Patient_Birthdate&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">xenograft_patient_sex</span>}                 = <span class="q">&quot;Host_Patient.Patient_Sex&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">current_amount</span>}                        = <span class="q">&quot;Source.Current_Amount&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">amount_units</span>}                          = <span class="q">&quot;Source.Amount_Units&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">source_rack_alias</span>}                     = <span class="q">&quot;Rack.Rack_Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">source_rack_id</span>}                        = <span class="q">&quot;Rack.Rack_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">sample_collection_date</span>}                = <span class="q">&quot;Left(Source.Sample_Collection_Time,10)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">sample_collection_time</span>}                = <span class="q">&quot;Source.Sample_Collection_Time&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">pathology_primary_anatomic_site_id</span>}    = <span class="q">&quot;Pathology.FKPrimary_Anatomic_Site__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">histology_alias</span>}                       = <span class="q">&quot;Histology.Histology_Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">source_label</span>}                          = <span class="q">&quot;Source.Source_Label&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">Sample_Alert</span>}                          = <span class="q">&quot;Source_Alert.Alert_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">Sample_Alert_Reason</span>}                   = <span class="q">&quot;Alert_Reason.Alert_Reason&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">source_number</span>}                         = <span class="q">&quot;Source.Source_Number&quot;</span><span class="sc">;</span>
<span class="i">$Attr_Aliases</span>{<span class="w">source_submitted_concentration</span>}           = <span class="q">&quot;Source.Submitted_Concentration&quot;</span><span class="sc">;</span>
<span class="i">$Attr_Aliases</span>{<span class="w">source_submitted_concentration_units</span>}     = <span class="q">&quot;Source.Submitted_Concentration_Units&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Anatomic_Site</span>}{<span class="w">anatomic_site_id</span>}    = <span class="q">&quot;Anatomic_Site.Anatomic_Site_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Anatomic_Site</span>}{<span class="w">anatomic_site_alias</span>} = <span class="q">&quot;Anatomic_Site.Anatomic_Site_Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Anatomic_Site</span>}{<span class="w">anatomic_site_type</span>}  = <span class="q">&quot;Anatomic_Site_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Shipment</span>}{<span class="w">shipment_received</span>}        = <span class="q">&quot;Shipment.Shipment_Received&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Shipment</span>}{<span class="w">shipment_sent</span>}            = <span class="q">&quot;Shipment.Shipment_Sent&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Shipment</span>}{<span class="w">supplier_organization</span>}    = <span class="q">&quot;Shipment_Org.Organization_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source_Pool</span>}{<span class="w">pooled_sources</span>}        = <span class="q">&quot;Source_Pool.FKParent_Source__ID&quot;</span><span class="sc">;</span>

<span class="c"># Equipment aliases</span>
<span class="i">$Aliases</span>{<span class="w">Equipment</span>}{<span class="w">machine</span>}            = <span class="q">&quot;Equipment.Equipment_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Equipment</span>}{<span class="w">machine_id</span>}         = <span class="q">&quot;Equipment.Equipment_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Equipment</span>}{<span class="w">equipment_location</span>} = <span class="q">&quot;Location.Location_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Equipment</span>}{<span class="w">rack_location</span>}      = <span class="q">&quot;Location.Location_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Equipment</span>}{<span class="w">equipment_status</span>}   = <span class="q">&quot;Equipment.Equipment_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Equipment</span>}{<span class="w">equipment_category</span>} = <span class="q">&quot;Concat(Equipment_Category.Category,' ',Sub_Category)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Equipment</span>}{<span class="w">equipment_type</span>}     = <span class="q">&quot;Concat(Equipment_Category.Category,' ',Sub_Category)&quot;</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%Vector_Alias</span><span class="sc">;</span>    <span class="c">## Library Alias ##</span>
<span class="i">$Aliases</span>{<span class="w">Vector</span>}{<span class="w">vector_file</span>} = <span class="q">&quot;Vector_Type.Vector_Sequence_File&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Vector</span>}{<span class="w">vector</span>}      = <span class="q">&quot;Vector_Type.Vector_Type_Name&quot;</span><span class="sc">;</span>

<span class="c">## Primer Alias ##</span>
<span class="k">my</span> <span class="i">%Primer_Alias</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">custom_primer_sequence</span>}      = <span class="q">&quot;Custom_Primer.Primer_Sequence&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">custom_primer</span>}               = <span class="q">&quot;Custom_Primer.Primer_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_sequence</span>}             = <span class="q">&quot;Primer.Primer_Sequence&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer</span>}                      = <span class="q">&quot;Primer.Primer_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_type</span>}                 = <span class="q">&quot;Primer.Primer_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">alternate_primer_identifier</span>} = <span class="q">&quot;Primer.Alternate_Primer_Identifier&quot;</span><span class="sc">;</span>

<span class="c">#$Aliases{Primer}{primer_type} = &quot;CASE WHEN Primer.Primer_Name='Custom' THEN Custom_Primer.Primer_Name ELSE Primer.Primer_Name END&quot;;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">oligo_primer</span>}           = <span class="q">&quot;Primer_Plate_Well.FK_Primer__Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">oligo_sequence</span>}         = <span class="q">&quot;Custom_Primer.Primer_Sequence&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">oligo_direction</span>}        = <span class="q">&quot;Primer_Customization.Direction&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">oligo_type</span>}             = <span class="q">&quot;Custom_Primer.Primer_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">working_tm</span>}             = <span class="q">&quot;Primer_Customization.Tm_Working&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">adapter_index_sequence</span>} = <span class="q">&quot;Primer_Customization.Adapter_Index_Sequence&quot;</span><span class="sc">;</span>

<span class="c">## Primer Aliases (related to Primer_Plate)</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_plate_name</span>}        = <span class="q">&quot;Primer_Plate.Primer_Plate_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_plate_notes</span>}       = <span class="q">&quot;Primer_Plate.Notes&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_plate_status</span>}      = <span class="q">&quot;Primer_Plate.Primer_Plate_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_plate_id</span>}          = <span class="q">&quot;Primer_Plate.Primer_Plate_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_plate_well</span>}        = <span class="q">&quot;Primer_Plate_Well.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_well</span>}              = <span class="q">&quot;Primer_Plate_Well.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_plate_well_status</span>} = <span class="q">'Primer_Plate_Well.Primer_Plate_Well_Check'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">order_date</span>}               = <span class="q">&quot;Primer_Plate.Order_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">arrival_date</span>}             = <span class="q">&quot;Primer_Plate.Arrival_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">primer_plate_solution</span>}    = <span class="q">&quot;Primer_Plate.FK_Solution__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">amplicon_length</span>}          = <span class="q">&quot;Primer_Customization.Amplicon_Length&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">stock_source</span>}             = <span class="q">&quot;Stock_Catalog.Stock_Source&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">nt_index</span>}                 = <span class="q">&quot;Primer_Customization.nt_index&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Primer</span>}{<span class="w">nt_index_sequence</span>}        = <span class="q">&quot;RIGHT(Primer.Primer_Sequence,Primer_Customization.nt_index)&quot;</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%Pool_Alias</span><span class="sc">;</span>    <span class="c">## Pool Alias ##</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_id</span>}          = <span class="q">&quot;Pool_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_type</span>}        = <span class="q">&quot;Pool_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_name</span>}        = <span class="q">&quot;Pool.FK_Library__Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_status</span>}      = <span class="q">&quot;Transposon_Pool.Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pooled_by</span>}        = <span class="q">&quot;Pool.FK_Employee__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_description</span>} = <span class="q">&quot;Pool_Description&quot;</span><span class="sc">;</span>

<span class="c">#$Aliases{Pool}{pool_target_plate} = &quot;Pool.FK_Plate__ID&quot;;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_date</span>}           = <span class="q">&quot;Pool_Date&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_comments</span>}       = <span class="q">&quot;Pool_Comments&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_gel_id</span>}         = <span class="q">&quot;Transposon_Pool.FK_GelRun__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">OD_id</span>}               = <span class="q">&quot;Transposon_Pool.FK_Optical_Density__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_pipeline</span>}       = <span class="q">&quot;Transposon_Pool.Pipeline&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_reads_required</span>} = <span class="q">&quot;Transposon_Pool.Reads_Required&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_transposon_id</span>}  = <span class="q">&quot;Transposon_Pool.FK_Transposon__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pool</span>}{<span class="w">pool_transposon</span>}     = <span class="q">&quot;Transposon.Transposon_Name&quot;</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%PoolSample_Alias</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">PoolSample</span>}{<span class="w">pooled_source_well</span>}  = <span class="q">&quot;PoolSample.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">PoolSample</span>}{<span class="w">pooled_source_plate</span>} = <span class="q">&quot;PoolSample.FK_Plate__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">PoolSample</span>}{<span class="w">pooled_wells</span>}        = <span class="q">&quot;Count(DISTINCT PoolSample.Well,PoolSample.FK_Plate__ID)&quot;</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%ReArray_Alias</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">ReArray</span>}{<span class="w">rearray_request_id</span>}  = <span class="q">'ReArray_Request.ReArray_Request_ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">ReArray</span>}{<span class="w">rearray_type</span>}        = <span class="q">'ReArray_Request.ReArray_Type'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">ReArray</span>}{<span class="w">rearray_target_well</span>} = <span class="q">'ReArray.Target_Well'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">ReArray</span>}{<span class="w">rearray_target</span>}      = <span class="q">'ReArray_Request.FKTarget_Plate__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">ReArray</span>}{<span class="w">rearray_source</span>}      = <span class="q">'ReArray.FKSource_Plate__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">ReArray</span>}{<span class="w">rearray_source_well</span>} = <span class="q">'ReArray.Source_Well'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">ReArray</span>}{<span class="w">rearray_datetime</span>}    = <span class="q">'ReArray_Request.Request_DateTime'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">ReArray</span>}{<span class="w">rearray_sample_id</span>}   = <span class="q">'ReArray.FK_Sample__ID'</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%Read_Alias</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">unique_samples</span>}  = <span class="q">&quot;count(DISTINCT Clone_Sequence.FK_Sample__ID)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">sequenced_well</span>}  = <span class="q">&quot;Clone_Sequence.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">Q20</span>}             = <span class="i">SQL_phred</span><span class="s">(</span><span class="n">20</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">Q30</span>}             = <span class="i">SQL_phred</span><span class="s">(</span><span class="n">30</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">Q40</span>}             = <span class="i">SQL_phred</span><span class="s">(</span><span class="n">40</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">run_initiated_by</span>} = <span class="q">'Sequenced_by.Employee_Name'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'Max_Q20'</span>}      = <span class="q">&quot;Max(&quot;</span> . <span class="i">SQL_phred</span><span class="s">(</span><span class="n">20</span><span class="s">)</span> . <span class="q">&quot;)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'Max_Q30'</span>}      = <span class="q">&quot;Max(&quot;</span> . <span class="i">SQL_phred</span><span class="s">(</span><span class="n">30</span><span class="s">)</span> . <span class="q">&quot;)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'Max_Q40'</span>}      = <span class="q">&quot;Max(&quot;</span> . <span class="i">SQL_phred</span><span class="s">(</span><span class="n">40</span><span class="s">)</span> . <span class="q">&quot;)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'Avg_Q20'</span>}      = <span class="q">&quot;Sum(&quot;</span> . <span class="i">SQL_phred</span><span class="s">(</span><span class="n">20</span><span class="s">)</span> . <span class="q">&quot;) / count(*)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'Avg_Q30'</span>}      = <span class="q">&quot;Sum(&quot;</span> . <span class="i">SQL_phred</span><span class="s">(</span><span class="n">30</span><span class="s">)</span> . <span class="q">&quot;) / count(*)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'Avg_Q40'</span>}      = <span class="q">&quot;Sum(&quot;</span> . <span class="i">SQL_phred</span><span class="s">(</span><span class="n">40</span><span class="s">)</span> . <span class="q">&quot;) / count(*)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'Sum_Q20'</span>}      = <span class="q">&quot;Sum(&quot;</span> . <span class="i">SQL_phred</span><span class="s">(</span><span class="n">20</span><span class="s">)</span> . <span class="q">&quot;)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'Sum_Q30'</span>}      = <span class="q">&quot;Sum(&quot;</span> . <span class="i">SQL_phred</span><span class="s">(</span><span class="n">30</span><span class="s">)</span> . <span class="q">&quot;)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'Sum_Q40'</span>}      = <span class="q">&quot;Sum(&quot;</span> . <span class="i">SQL_phred</span><span class="s">(</span><span class="n">40</span><span class="s">)</span> . <span class="q">&quot;)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">warning</span>}        = <span class="q">&quot;Clone_Sequence.Read_Warning&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">error</span>}          = <span class="q">&quot;Clone_Sequence.Read_Error&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">read_comments</span>}  = <span class="q">&quot;Clone_Sequence.Clone_Sequence_Comments&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">read_sample_id</span>} = <span class="q">&quot;Clone_Sequence.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="c">###### Run trimmed for both quality and vector ##########</span>

<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'trimmed_sequence'</span>} = <span class="q">&quot;MID(Clone_Sequence.Sequence,GREATEST(Quality_Left+1,Vector_Left+2,0),&quot;</span> . <span class="q">&quot;CASE WHEN (Vector_Right&gt;0 OR Vector_Left&gt;0) &quot;</span> . <span class="q">&quot;THEN (Quality_Length-Vector_Quality) ELSE Clone_Sequence.Quality_Length END)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'trimmed_length'</span>}   = <span class="q">&quot;Clone_Sequence.Quality_Length - Clone_Sequence.Vector_Quality&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'trimmed_scores'</span>}   = <span class="q">&quot;MID(Sequence_Scores,GREATEST(Quality_Left+1,Vector_Left+2,0),&quot;</span> . <span class="q">&quot;CASE WHEN (Vector_Right&gt;0 OR Vector_Left&gt;0) &quot;</span> . <span class="q">&quot;THEN (Quality_Length-Vector_Quality) ELSE Clone_Sequence.Quality_Length END)&quot;</span><span class="sc">;</span>
<span class="c">###### Run trimmed for quality alone (based on phred contiguous quality region) ######</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'quality_sequence'</span>}                        = <span class="q">&quot;MID(Clone_Sequence.Sequence,GREATEST(Quality_Left+1,0),GREATEST(Quality_Length,0))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'quality_length'</span>}                          = <span class="q">&quot;Clone_Sequence.Quality_Length&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'quality_vector'</span>}                          = <span class="q">&quot;Clone_Sequence.Vector_Quality&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'quality_scores'</span>}                          = <span class="q">&quot;MID(Clone_Sequence.Sequence_Scores,GREATEST(Quality_Left+1,0),GREATEST(Quality_Length,0))&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'sequence'</span>}                                = <span class="q">'Clone_Sequence.Sequence'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'sequence_length'</span>}                         = <span class="q">'Clone_Sequence.Sequence_Length'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'sequence_scores'</span>}                         = <span class="q">'Clone_Sequence.Sequence_Scores'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'vector_left'</span>}                             = <span class="q">'Clone_Sequence.Vector_Left'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'vector_right'</span>}                            = <span class="q">'Clone_Sequence.Vector_Right'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'quality_left'</span>}                            = <span class="q">'Clone_Sequence.Quality_Left'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="w">read_sample</span>}                               = <span class="q">&quot;Clone_Sequence.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'phred_version'</span>}                           = <span class="q">&quot;SequenceAnalysis.Phred_Version&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'BAC_trace_submission_phred_version'</span>}      = <span class="q">&quot;Concat('phred-',SequenceAnalysis.Phred_Version)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'BAC_trace_submission_CLIP_QUALITY_LEFT'</span>}  = <span class="q">&quot;CASE WHEN Quality_Left &gt;=0 THEN Quality_Left ELSE NULL END&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Read</span>}{<span class="q">'BAC_trace_submission_CLIP_QUALITY_RIGHT'</span>} = <span class="q">&quot;CASE WHEN Quality_Length &gt;= 0 THEN Quality_Left + Quality_Length - 1 ELSE NULL END&quot;</span><span class="sc">;</span>

<span class="c">## my %Sample_Alias;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">sample_name</span>}    = <span class="q">&quot;Sample.Sample_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">name_of_sample</span>} = <span class="q">&quot;Sample.Sample_Name&quot;</span><span class="sc">;</span>                        <span class="c">### Previous entry conflicts with SolexaRun</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">samples</span>}        = <span class="q">&quot;count(DISTINCT Sample_Name)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">sample_plate</span>}   = <span class="q">&quot;Left(Sample_Name,LENGTH(Sample_Name)-4)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">sample_id</span>}      = <span class="q">&quot;Sample.Sample_ID&quot;</span><span class="sc">;</span>

<span class="c">## my %Clone_Alias;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">clone_id</span>}         = <span class="q">&quot;Clone_Sample.Clone_Sample_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">clone_name</span>}       = <span class="q">&quot;Sample.Sample_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">original_library</span>} = <span class="q">&quot;Clone_Sample.FK_Library__Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">original_libraries</span>}
    = <span class="q">&quot;CASE WHEN (COUNT(DISTINCT Clone_Sample.FK_Library__Name) &gt; 1) &quot;</span>
    . <span class="q">&quot;THEN ('(hybrid)') &quot;</span>
    . <span class="q">&quot;WHEN (COUNT(DISTINCT Clone_Sample.FK_Library__Name,Clone_Sample.Library_Plate_Number) &gt; 1) &quot;</span>
    . <span class="q">&quot;THEN (Clone_Sample.FK_Library__Name) &quot;</span>
    . <span class="q">&quot;WHEN (COUNT(DISTINCT Clone_Sample.FK_Library__Name,Clone_Sample.Library_Plate_Number,Clone_Sample.Original_Quadrant) &gt; 1) &quot;</span>
    . <span class="q">&quot;THEN (CONCAT(Clone_Sample.FK_Library__Name,'-',Clone_Sample.Library_Plate_Number)) &quot;</span>
    . <span class="q">&quot;ELSE (CONCAT(Clone_Sample.FK_Library__Name,'-',Clone_Sample.Library_Plate_Number,Clone_Sample.Original_Quadrant) ) END&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">original_plate_id</span>} = <span class="q">&quot;Clone_Sample.FKOriginal_Plate__ID&quot;</span><span class="sc">;</span>    <span class="c">##</span>

<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">original_extraction_plate_id</span>} = <span class="q">&quot;Extraction_Sample.FKOriginal_Plate__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">original_extraction_well</span>}     = <span class="q">&quot;Extraction_Sample.Original_Well&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Sample_Type</span>}{<span class="w">sample_type</span>} = <span class="q">'Sample_Type.Sample_Type'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">original_well</span>}         = <span class="q">&quot;Clone_Sample.Original_Well&quot;</span><span class="sc">;</span>           <span class="c">##</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">applied_plate_id</span>}      = <span class="q">&quot;Plate_Sample.FKOriginal_Plate__ID&quot;</span><span class="sc">;</span>    <span class="c">## original plate_id (of value for ReArrays)...</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">applied_well</span>}          = <span class="q">&quot;Plate_Sample.Well&quot;</span><span class="sc">;</span>                    <span class="c">## Well as applied to original (of value for ReArrays)...</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">original_plate_number</span>} = <span class="q">&quot;Clone_Sample.Library_Plate_Number&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">original_quadrant</span>}     = <span class="q">&quot;Clone_Sample.Original_Quadrant&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">original_quadrants</span>} = <span class="q">&quot;CASE WHEN (COUNT(DISTINCT Clone_Sample.Original_Quadrant) &gt; 1) &quot;</span> . <span class="q">&quot;THEN (COUNT(DISTINCT Clone_Sample.Original_Quadrant)) &quot;</span> . <span class="q">&quot;ELSE (Clone_Sample.Original_Quadrant) END&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">alias_name</span>}        = <span class="q">&quot;Sample_Alias.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">sample_alias</span>}      = <span class="q">&quot;Sample_Alias.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">clone_alias</span>}       = <span class="q">&quot;Sample_Alias.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">mgc_number</span>}        = <span class="q">&quot;Sample_Alias.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Sample</span>}{<span class="w">alias_type</span>} = <span class="q">&quot;Sample_Alias.Alias_Type&quot;</span><span class="sc">;</span>                        <span class="c">## Change name to Clone_Alias.Alias_Type (Source is reserved word) ##</span>

<span class="c">#my %Source_Alias;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">parent_group</span>}            = <span class="q">&quot;Parent_Group.Grp_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">parent_library</span>}          = <span class="q">&quot;Parent_Library.Library_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">required_parent_group</span>}   = <span class="q">&quot;R_Parent_Group.Grp_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">required_parent_library</span>} = <span class="q">&quot;R_Parent_Library.Library_Name&quot;</span><span class="sc">;</span>

<span class="c">#$Aliases{Clone}{source_clone_id} = &quot;Clone_Source.FK_Clone__ID&quot;;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_name</span>}   = <span class="q">&quot;Clone_Source.Source_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_org_id</span>} = <span class="q">&quot;Clone_Source.FKSource_Organization__ID&quot;</span><span class="sc">;</span>

<span class="c">#$Aliases{Clone}{source_id} = &quot;Clone_Source.Source_Name&quot;;</span>
<span class="c">#$Aliases{Clone}{source_library} = &quot;Clone_Source.Source_Library_Name&quot;;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_collection</span>} = <span class="q">&quot;Clone_Source.Source_Collection&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_3prime_tag</span>} = <span class="q">&quot;Clone_Source.3prime_tag&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_5prime_tag</span>} = <span class="q">&quot;Clone_Source.5prime_tag&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_vector</span>}     = <span class="q">&quot;Clone_Source.Source_Vector&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_library_id</span>} = <span class="q">&quot;Clone_Source.Source_Library_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_plate</span>}      = <span class="q">&quot;Clone_Source.Source_Plate&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_plates</span>}
    = <span class="q">&quot;CASE WHEN (COUNT(DISTINCT Clone_Source.Source_Collection) &gt; 1) THEN ('(hybrid)') WHEN (COUNT(DISTINCT Clone_Source.Source_Collection,Clone_Source.Source_Plate) &gt; 1) THEN (Clone_Source.Source_Collection) ELSE (CONCAT(Clone_Source.Source_Collection,'-',Clone_Source.Source_Plate) ) END&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_row</span>}             = <span class="q">&quot;Clone_Source.Source_Row&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_col</span>}             = <span class="q">&quot;Clone_Source.Source_Col&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_comments</span>}        = <span class="q">&quot;Clone_Source.Source_Comments&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_description</span>}     = <span class="q">&quot;Clone_Source.Source_Description&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_quadrant</span>}        = <span class="q">&quot;Clone_Sample.Original_Quadrant&quot;</span><span class="sc">;</span>                       <span class="c">## same as original_quadrant (?)...</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">source_score</span>}           = <span class="q">&quot;Clone_Source.Source_Score&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">clone_comments</span>}         = <span class="q">&quot;Clone_Details.Clone_Comments&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">clone_chimerism</span>}        = <span class="q">&quot;Clone_Details.Chimerism_check_with_ESTs&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">clone_gel_id</span>}           = <span class="q">&quot;Clone_Gel.Clone_Gel_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">clone_band_sizes</span>}       = <span class="q">&quot;Clone_Gel.Band_Sizes&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">clone_size_estimate</span>}    = <span class="q">&quot;Clone_Gel.Clone_Size_Estimate&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">clone_gel_comments</span>}     = <span class="q">&quot;Clone_Gel.Comments&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">gel_id</span>}                 = <span class="q">&quot;GelRun.GelRun_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">gel_datetime</span>}           = <span class="q">&quot;GelRun.Gel_Date&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">gel_plate</span>}              = <span class="q">&quot;GelRun.FK_Plate__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">gel_well</span>}               = <span class="q">&quot;GelRun.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">gel_lane</span>}               = <span class="q">&quot;GelRun.Lane&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">clone_gels</span>}             = <span class="q">&quot;COUNT(DISTINCT Clone_Gel_ID)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">OD_density</span>}             = <span class="q">&quot;Optical_Density.Density&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">OD_plate</span>}               = <span class="q">&quot;Optical_Density.FK_Plate__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">OD_well</span>}                = <span class="q">&quot;Optical_Density.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">OD_concentration</span>}       = <span class="q">&quot;Optical_Density.Concentration&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">OD_runs</span>}                = <span class="q">&quot;COUNT(DISTINCT Optical_Density.Optical_Density_ID)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">concentration</span>}          = <span class="q">&quot;Concentrations.Concentration&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">concentration_datetime</span>} = <span class="q">&quot;ConcentrationRun.DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">concentration_plate</span>}    = <span class="q">&quot;ConcentrationRun.FK_Plate__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">concentration_well</span>}     = <span class="q">&quot;Concentrations.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">concentration_run</span>}      = <span class="q">&quot;Concentrations.FK_ConcentrationRun__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Clone</span>}{<span class="w">concentration_runs</span>}     = <span class="q">&quot;COUNT(DISTINCT ConcentrationRun_ID)&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">analysis_start_time</span>} = <span class="q">'GelAnalysis.GelAnalysis_DateTime'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Bandleader_Version</span>}  = <span class="q">'GelAnalysis.Bandleader_Version'</span><span class="sc">;</span>

<span class="c">## my %Plate_Alias;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_id</span>}                 = <span class="q">'Plate.Plate_ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">original_parent_plate_id</span>} = <span class="q">'Plate.FKOriginal_Plate__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">parent_plate_id</span>}          = <span class="q">'Plate.FKParent_Plate__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_made_by</span>}            = <span class="q">'Plater.Employee_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_number</span>}             = <span class="q">'Plate.Plate_Number'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">library</span>}                  = <span class="q">'Plate.FK_Library__Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_location_id</span>}        = <span class="q">'Plate.FK_Rack__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_format_id</span>}          = <span class="q">'Plate.FK_Plate_Format__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_status</span>}             = <span class="q">'Plate.Plate_Status'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_size</span>}               = <span class="q">'Plate.Plate_Size'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_application</span>}        = <span class="q">'Plate.Plate_Application'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_type</span>}               = <span class="q">'Plate.Plate_Type'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_test_status</span>}        = <span class="q">'Plate.Plate_Test_Status'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">parent_quadrant</span>}          = <span class="q">'Plate.Parent_Quadrant'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_position</span>}           = <span class="q">'Library_Plate.Plate_Position'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_class</span>}              = <span class="q">'Plate.Plate_Class'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">unused_wells</span>}             = <span class="q">'Library_Plate.Unused_Wells'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_comments</span>}           = <span class="q">'Plate.Plate_Comments'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">problematic_wells</span>}        = <span class="q">'Library_Plate.Problematic_Wells'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">empty_wells</span>}              = <span class="q">'Library_Plate.Empty_Wells'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">NGs</span>}                      = <span class="q">'Library_Plate.No_Grows'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">SGs</span>}                      = <span class="q">'Library_Plate.Slow_Grows'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_created</span>}            = <span class="q">'Plate.Plate_Created'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">first_plate_created</span>}      = <span class="q">'Min(Plate.Plate_Created)'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">last_plate_created</span>}       = <span class="q">'Max(Plate.Plate_Created)'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">branch_code</span>}              = <span class="q">'Plate.FK_Branch__Code'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_contents</span>}           = <span class="q">'Sample_Type.Sample_Type'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">pipeline</span>}                 = <span class="q">'Plate.FK_Pipeline__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">pipeline_code</span>}            = <span class="q">'Pipeline.Pipeline_Code'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">tray_id</span>}                  = <span class="q">'Plate_Tray.FK_Tray__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_volume</span>}             = <span class="q">'Plate.Current_Volume'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_volume_units</span>}       = <span class="q">'Plate.Current_Volume_Units'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Run</span>}{<span class="w">plate_QC_status</span>} = <span class="q">&quot;Plate.QC_Status&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Branch</span>}{<span class="w">branch_description</span>} = <span class="q">'Branch.Branch_Description'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rack</span>}{<span class="w">location</span>}             = <span class="q">'Rack.Rack_Alias'</span><span class="sc">;</span>
<span class="c">## delete those below at next release (verify with users) ##</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">rack</span>} = <span class="q">'Rack.Rack_Alias'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">rack_id</span>}                = <span class="q">'Plate.FK_Rack__ID'</span><span class="sc">;</span>         <span class="c">## &lt;CONSTRUCTION&gt; - remove - not a Plate attribute</span>
<span class="i">$Aliases</span>{<span class="w">Equipment</span>}{<span class="w">equipment_location</span>} = <span class="q">'Location.Location_Name'</span><span class="sc">;</span>    <span class="c">## &lt;CONSTRUCTION&gt; - remove - confuse with location</span>

<span class="c">## my %Plate_Format_Alias;</span>
<span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_format</span>} = <span class="q">'Plate_Format.Plate_Format_Type'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">event</span>}             = <span class="q">&quot;Prep.Prep_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">event_time</span>}        = <span class="q">&quot;Prep.Prep_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">event_comments</span>}    = <span class="q">&quot;Prep.Prep_Comments&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">application_time</span>}  = <span class="q">&quot;Prep.Prep_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">applied_solution</span>}  = <span class="q">&quot;Plate_Prep.FK_Solution__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">prep_plate_id</span>}     = <span class="q">&quot;Plate_Prep.FK_Plate__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">applied_by</span>}        = <span class="q">&quot;Prepper.Employee_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">applied_qty</span>}       = <span class="q">&quot;Plate_Prep.Solution_Quantity&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">plate_set_number</span>}  = <span class="q">&quot;Plate_Prep.FK_Plate_Set__Number&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">applied_equipment</span>} = <span class="q">&quot;Plate_Prep.FK_Equipment__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Prep</span>}{<span class="w">lab_protocol_name</span>} = <span class="q">&quot;Lab_Protocol.Lab_Protocol_Name&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Employee</span>}{<span class="w">employee</span>}    = <span class="q">&quot;Employee.Employee_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Employee</span>}{<span class="w">employee_id</span>} = <span class="q">&quot;Employee.Employee_ID&quot;</span><span class="sc">;</span>

<span class="c">## Rearray Aliases;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">source_plate_id</span>}       = <span class="q">'Source_Plate.Plate_ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">source_library</span>}        = <span class="q">'Source_Plate.FK_Library__Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">source_plate_number</span>}   = <span class="q">'Source_Plate.Plate_Number'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">source_plate_quadrant</span>} = <span class="q">'Source_Plate.Parent_Quadrant'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">target_plate_id</span>}       = <span class="q">'Plate.Plate_ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">target_library</span>}        = <span class="q">'Plate.FK_Library__Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">target_plate_number</span>}   = <span class="q">'Plate.Plate_Number'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">primer_name</span>}           = <span class="q">'Primer.Primer_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">source_well</span>}           = <span class="q">'ReArray.Source_Well'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">target_well</span>}           = <span class="q">'ReArray.Target_Well'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">oligo_direction</span>}       = <span class="q">'Primer_Customization.Oligo_Direction'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">rearray_request_id</span>}    = <span class="q">&quot;ReArray_Request.ReArray_Request_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">tm</span>}                    = <span class="q">'Primer_Customization.Tm_Working'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">primer_sequence</span>}       = <span class="q">'Primer.Primer_Sequence'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">rearray_type</span>}          = <span class="q">'ReArray_Request.ReArray_Type'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">rearray_status</span>}        = <span class="q">'Status.Status_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">primer_well</span>}           = <span class="q">'Primer_Plate_Well.Well'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">solution_id</span>}           = <span class="q">'Primer_Plate.FK_Solution__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">primer_plate_name</span>}     = <span class="q">&quot;Primer_Plate.Primer_Plate_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">primer_order_date</span>}     = <span class="q">&quot;Primer_Plate.Order_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">primer_arrival_date</span>}   = <span class="q">&quot;Primer_Plate.Arrival_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">sample_id</span>}             = <span class="q">&quot;Plate_Sample.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">sample_name</span>}           = <span class="q">&quot;Sample.Sample_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">rearray_date</span>}          = <span class="q">&quot;ReArray_Request.Request_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">employee_name</span>}         = <span class="q">&quot;Employee.Employee_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Rearray</span>}{<span class="w">employee_id</span>}           = <span class="q">&quot;ReArray_Request.FK_Employee__ID&quot;</span><span class="sc">;</span>

<span class="c"># alternate aliases for rearrays (if going through an applied primer instead of an oligo rearray)</span>
<span class="c"># note that these are more limited than the above</span>
<span class="c">## alt_Rearray aliases;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">target_plate_id</span>}     = <span class="q">'Plate.Plate_ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">target_library</span>}      = <span class="q">'Plate.FK_Library__Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">target_plate_number</span>} = <span class="q">'Plate.Plate_Number'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">primer_name</span>}         = <span class="q">'Primer.Primer_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">target_well</span>}         = <span class="q">'Primer_Plate_Well.Well'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">tm</span>}                  = <span class="q">'Primer_Customization.Tm_Working'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">primer_sequence</span>}     = <span class="q">'Primer.Primer_Sequence'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">primer_well</span>}         = <span class="q">'Primer_Plate_Well.Well'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">solution_id</span>}         = <span class="q">'Primer_Plate.FK_Solution__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">primer_plate_name</span>}   = <span class="q">&quot;Primer_Plate.Primer_Plate_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">primer_order_date</span>}   = <span class="q">&quot;Primer_Plate.Order_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">primer_arrival_date</span>} = <span class="q">&quot;Primer_Plate.Arrival_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">sample_id</span>}           = <span class="q">&quot;Plate_Sample.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">alt_Rearray</span>}{<span class="w">sample_name</span>}         = <span class="q">&quot;Sample.Sample_Name&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Stock</span>}{<span class="w">vendor</span>}       = <span class="q">'Vendor.Organization_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Stock</span>}{<span class="w">manufacturer</span>} = <span class="q">'Manufacturer.Organization_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Stock</span>}{<span class="w">stock_name</span>}   = <span class="q">&quot;Stock_Catalog.Stock_Catalog_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Stock</span>}{<span class="w">Stock_Name</span>}   = <span class="q">&quot;Stock_Catalog.Stock_Catalog_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Stock</span>}{<span class="w">stock_size</span>}   = <span class="q">&quot;Stock_Catalog.Stock_Size&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Stock</span>}{<span class="w">stock_units</span>}  = <span class="q">&quot;Stock_Catalog.Stock_Size_Units&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Stock</span>}{<span class="w">stock_id</span>}     = <span class="q">&quot;Stock.Stock_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Stock</span>}{<span class="w">stock_model</span>}  = <span class="q">&quot;CASE WHEN (Stock_Catalog.Model ='Solexa') THEN ('Illumina Genome Analyzer IIx') WHEN (Stock_Catalog.Model ='2000') THEN ('Illumina HiSeq 2000') WHEN (Stock_Catalog_Name = 'MiSeq') THEN ('Illumina MiSeq') END&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Solution</span>}{<span class="w">solution_id</span>}            = <span class="q">&quot;Solution.Solution_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solution</span>}{<span class="w">solution_name</span>}          = <span class="q">&quot;Stock_Catalog.Stock_Catalog_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solution</span>}{<span class="w">solution_quantity_used</span>} = <span class="q">&quot;Solution.Quantity_Used&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solution</span>}{<span class="w">solution_quantity</span>}      = <span class="q">&quot;Solution.Solution_Quantity&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Solution</span>}{<span class="w">solution_status</span>}        = <span class="q">&quot;Solution.Solution_Status&quot;</span><span class="sc">;</span>

<span class="c">### Gel Run</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">analysis_status</span>}     = <span class="q">'Gel_Analysis_Status.Status_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Gel_Name</span>}            = <span class="q">'GelAnalysis.Gel_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Swap_Check</span>}          = <span class="q">'GelAnalysis.Swap_Check'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Self_Check</span>}          = <span class="q">'GelAnalysis.Self_Check'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Cross_Check</span>}         = <span class="q">'GelAnalysis.Cross_Check'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Validation_Override</span>} = <span class="q">'GelAnalysis.Validation_Override'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">billable</span>}         = <span class="q">'Run.Billable'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Analysis_Status</span>}  = <span class="q">'Gel_Analysis_Status.Status_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">gel_type</span>}         = <span class="q">&quot;GelRun.GelRun_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Comb</span>}             = <span class="q">&quot;CombEquipment.Equipment_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">poured_equipment</span>} = <span class="q">&quot;PouredEquipment.Equipment_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">agarose_solution</span>} = <span class="q">&quot;GelRun.FKAgarose_Solution__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">agarose_percent</span>}  = <span class="q">&quot;GelRun.Agarose_Percentage&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Poured</span>}           = <span class="q">&quot;PouredEmployee.Employee_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">GelTray</span>}          = <span class="q">&quot;CONCAT(GelRack.FKParent_Rack__ID,':',GelRack.Rack_Name)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">PouredDate</span>}       = <span class="q">&quot;RunBatch.RunBatch_RequestDateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Loaded</span>}           = <span class="q">&quot;LoadedEmployee.Employee_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">LoadDate</span>}         = <span class="q">&quot;Run.Run_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">GelBox</span>}           = <span class="q">&quot;BoxEquipment.Equipment_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">Scanner</span>}          = <span class="q">&quot;ScannerEquipment.Equipment_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">thumbnail</span>}        = <span class="q">&quot;CONCAT(Project.Project_Path,'/',Library.Library_Name,'/AnalyzedData/',Run.Run_Directory,'/annotated.jpg')&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">TIF</span>}              = <span class="q">&quot;CONCAT(Project.Project_Path,'/',Library.Library_Name,'/AnalyzedData/',Run.Run_Directory,'/image.tif')&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">lab_comments</span>}     = <span class="q">'1'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">autopass</span>} = <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### Attribute</span>

<span class="c">#$Aliases{GelRun}{Temperature} = '1'; ### Attribute</span>
<span class="i">$Aliases</span>{<span class="w">GelRun</span>}{<span class="w">gelrun_purpose</span>} = <span class="q">&quot;GelRun_Purpose.GelRun_Purpose_Name&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Lane</span>}{<span class="w">lane_sample</span>}   = <span class="q">'Lane.FK_Sample__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Lane</span>}{<span class="w">lane_number</span>}   = <span class="q">'Lane.Lane_Number'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Lane</span>}{<span class="w">lane_status</span>}   = <span class="q">'Lane.Lane_Status'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Lane</span>}{<span class="w">well</span>}          = <span class="q">'Lane.Well'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Lane</span>}{<span class="w">size_estimate</span>} = <span class="q">'Lane.Band_Size_Estimate'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Band</span>}{<span class="w">band_id</span>}        = <span class="q">'Band.Band_ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Band</span>}{<span class="w">band_size</span>}      = <span class="q">'Band.Band_Size'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Band</span>}{<span class="w">band_mobility</span>}  = <span class="q">'Band.Band_Mobility'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Band</span>}{<span class="w">band_number</span>}    = <span class="q">'Band.Band_Number'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Band</span>}{<span class="w">band_intensity</span>} = <span class="q">'Band.Band_Intensity'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Band</span>}{<span class="w">band_type</span>}      = <span class="q">'Band.Band_Type'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Fail</span>}{<span class="w">failed_by</span>}     = <span class="q">'Fail.FK_Employee__ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Fail</span>}{<span class="w">fail_datetime</span>} = <span class="q">'Fail.DateTime'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">FailReason</span>}{<span class="w">fail_reason</span>}      = <span class="q">'FailReason.FailReason_Name'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">FailReason</span>}{<span class="w">fail_description</span>} = <span class="q">'FailReason.FailReason_Description'</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">submission_date</span>}           = <span class="q">&quot;Submission.Submission_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">submission_source</span>}         = <span class="q">&quot;Submission.Submission_Source&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">submission_status</span>}         = <span class="q">&quot;Submission.Submission_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">submitted_by</span>}              = <span class="q">&quot;Submitter.Employee_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">submission_comments</span>}       = <span class="q">&quot;Submission.Submission_Comments&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">approved_by</span>}               = <span class="q">&quot;Approver.Employee_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">approved_date</span>}             = <span class="q">&quot;Submission.Approved_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">work_request_type</span>}         = <span class="q">&quot;Work_Request_Type.Work_Request_Type_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">work_num_plates_submitted</span>} = <span class="q">&quot;Work_Request.Num_Plates_Submitted&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">work_goal_target</span>}          = <span class="q">&quot;Work_Request.Goal_Target&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">work_goal_target_sum</span>}      = <span class="q">&quot;Sum(Work_Request.Goal_Target)&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission</span>}{<span class="w">work_request_comments</span>}     = <span class="q">&quot;Work_Request.Comments&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">SpectRun</span>}{<span class="w">A260_blank_avg</span>}    = <span class="q">&quot;SpectAnalysis.A260_Blank_Avg&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRun</span>}{<span class="w">A280_blank_avg</span>}    = <span class="q">&quot;SpectAnalysis.A280_Blank_Avg&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRun</span>}{<span class="w">scanner_equipment</span>} = <span class="q">&quot;SpectRun.FKScanner_Equipment__ID&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">well</span>}               = <span class="q">&quot;SpectRead.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">well_status</span>}        = <span class="q">&quot;SpectRead.Well_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">well_category</span>}      = <span class="q">&quot;SpectRead.Well_Category&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">A260m</span>}              = <span class="q">&quot;SpectRead.A260m&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">A260cor</span>}            = <span class="q">&quot;SpectRead.A260cor&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">A280m</span>}              = <span class="q">&quot;SpectRead.A280m&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">A280cor</span>}            = <span class="q">&quot;SpectRead.A280cor&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">A260</span>}               = <span class="q">&quot;SpectRead.A260&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">A280</span>}               = <span class="q">&quot;SpectRead.A280&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">A260_A280_ratio</span>}    = <span class="q">&quot;SpectRead.A260_A280_ratio&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">dilution_factor</span>}    = <span class="q">&quot;SpectRead.Dilution_Factor&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">spec_concentration</span>} = <span class="q">&quot;SpectRead.Concentration&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">unit</span>}               = <span class="q">&quot;SpectRead.Unit&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">read_error</span>}         = <span class="q">&quot;SpectRead.Read_Error&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">SpectRead</span>}{<span class="w">read_warning</span>}       = <span class="q">&quot;SpectRead.Read_Warning&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">BioanalyzerRun</span>}{<span class="w">scanner_equipment</span>}       = <span class="q">&quot;BioanalyzerRun.FKScanner_Equipment__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRun</span>}{<span class="w">dilution_factor</span>}         = <span class="q">&quot;BioanalyzerRun.Dilution_Factor&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRun</span>}{<span class="w">bioanalyzerrun_invoiced</span>} = <span class="q">&quot;BioanalyzerRun.Invoiced&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">BioanalyzerRead</span>}{<span class="w">well</span>}                       = <span class="q">&quot;BioanalyzerRead.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRead</span>}{<span class="w">well_status</span>}                = <span class="q">&quot;BioanalyzerRead.Well_Status&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRead</span>}{<span class="w">well_category</span>}              = <span class="q">&quot;BioanalyzerRead.Well_Category&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRead</span>}{<span class="w">RNA_DNA_concentration</span>}      = <span class="q">&quot;BioanalyzerRead.RNA_DNA_Concentration&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRead</span>}{<span class="w">RNA_DNA_concentration_unit</span>} = <span class="q">&quot;BioanalyzerRead.RNA_DNA_Concentration_Unit&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRead</span>}{<span class="w">RNA_DNA_integrity_number</span>}   = <span class="q">&quot;BioanalyzerRead.RNA_DNA_Integrity_Number&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRead</span>}{<span class="w">read_error</span>}                 = <span class="q">&quot;BioanalyzerRead.Read_Error&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRead</span>}{<span class="w">read_warning</span>}               = <span class="q">&quot;BioanalyzerRead.Read_Warning&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerRead</span>}{<span class="w">sample_comments</span>}            = <span class="q">&quot;BioanalyzerRead.Sample_Comment&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">BioanalyzerAnalysis</span>}{<span class="w">file_name</span>}              = <span class="q">&quot;BioanalyzerAnalysis.File_Name&quot;</span><span class="sc">;</span>

<span class="c">#$Aliases{GenechipRun}{cel_file} = &quot;GenechipRun.CEL_file&quot;;</span>
<span class="c">#$Aliases{GenechipRun}{dat_file} = &quot;GenechipRun.DAT_file&quot;;</span>
<span class="c">#$Aliases{GenechipRun}{chp_file} = &quot;GenechipRun.CHP_file&quot;;</span>

<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">genechiprun_invoiced</span>} = <span class="q">&quot;GenechipRun.Invoiced&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">sample</span>}               = <span class="q">&quot;GenechipAnalysis.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">analysis_type</span>}        = <span class="q">&quot;GenechipAnalysis.Analysis_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">analysis_datetime</span>}    = <span class="q">&quot;GenechipAnalysis.GenechipAnalysis_DateTime&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">artifact</span>}             = <span class="q">&quot;GenechipAnalysis.Artifact&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">total_snp</span>}            = <span class="q">&quot;GenechipMapAnalysis.Total_SNP&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">qc_mcr_percent</span>}       = <span class="q">&quot;GenechipMapAnalysis.QC_MCR_Percent&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">qc_mdr_percent</span>}       = <span class="q">&quot;GenechipMapAnalysis.QC_MDR_Percent&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">snp_call_percent</span>}     = <span class="q">&quot;GenechipMapAnalysis.SNP_Call_Percent&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">aa_call_percent</span>}      = <span class="q">&quot;GenechipMapAnalysis.AA_Call_Percent&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">ab_call_percent</span>}      = <span class="q">&quot;GenechipMapAnalysis.AB_Call_Percent&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">bb_call_percent</span>}      = <span class="q">&quot;GenechipMapAnalysis.BB_Call_Percent&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">alpha1</span>}                = <span class="q">&quot;GenechipExpAnalysis.Alpha1&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">alpha2</span>}                = <span class="q">&quot;GenechipExpAnalysis.Alpha2&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">tau</span>}                   = <span class="q">&quot;GenechipExpAnalysis.Tau&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">noise_rawq</span>}            = <span class="q">&quot;GenechipExpAnalysis.Noise_RawQ&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">scale_factor</span>}          = <span class="q">&quot;GenechipExpAnalysis.Scale_Factor&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">norm_factor</span>}           = <span class="q">&quot;GenechipExpAnalysis.Norm_Factor&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">avg_a_signal</span>}          = <span class="q">&quot;GenechipExpAnalysis.Avg_A_Signal&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">avg_p_signal</span>}          = <span class="q">&quot;GenechipExpAnalysis.Avg_P_Signal&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">avg_m_signal</span>}          = <span class="q">&quot;GenechipExpAnalysis.Avg_M_Signal&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">tgt</span>}                   = <span class="q">&quot;GenechipExpAnalysis.TGT&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">source_id</span>}                  = <span class="q">'Source.Source_ID'</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">patient_id</span>}                 = <span class="q">&quot;Source.External_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">gender</span>}                     = <span class="q">&quot;Original_Source.Sex&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">chip_external_barcode</span>} = <span class="q">&quot;Genechip.External_Barcode&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">chip_name</span>}             = <span class="q">&quot;Genechip_Type.Genechip_Type_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">QC_plot</span>}               = <span class="q">&quot;CONCAT(Run.Run_Directory,': N/A')&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="q">'re_scan'</span>}             = <span class="q">&quot;CONCAT(Run.Run_Directory,': N/A')&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">nature</span>}                   = <span class="q">&quot;Sample_Type.Sample_Type_Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Source</span>}{<span class="w">RNA_DNA_isolation_method</span>} = <span class="q">&quot;Nucleic_Acid.RNA_DNA_Isolation_Method&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">GenechipRun</span>}{<span class="w">thumbnail</span>}
    = <span class="q">&quot;CONCAT('&lt;a href=$URL_domain/$URL_dir_name/dynamic/data_home/private/Projects/',Project_Path,'/',Library_Name,'/AnalyzedData/',Run.Run_Directory,'.JPG&gt;&lt;img src=$URL_domain/$URL_dir_name/dynamic/data_home/private/Projects/',Project_Path,'/',Library_Name,'/AnalyzedData/',Run.Run_Directory,'_small.JPG&gt;&lt;/a&gt;')&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Nucleic_Acid</span>}{<span class="w">nucleic_acid_description</span>} = <span class="q">&quot;Nucleic_Acid.Description&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Pipeline</span>}{<span class="w">pipeline_id</span>}          = <span class="q">&quot;Pipeline.Pipeline_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pipeline</span>}{<span class="w">pipeline_code</span>}        = <span class="q">&quot;Pipeline.Pipeline_Code&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pipeline</span>}{<span class="w">pipeline_type</span>}        = <span class="q">&quot;Pipeline.Pipeline_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pipeline</span>}{<span class="w">pipeline_name</span>}        = <span class="q">&quot;Pipeline.Pipeline_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pipeline</span>}{<span class="w">pipeline_description</span>} = <span class="q">&quot;Pipeline.Pipeline_Description&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pipeline</span>}{<span class="w">group_name</span>}           = <span class="q">&quot;Grp.Grp_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pipeline</span>}{<span class="w">pipeline_group</span>}       = <span class="q">&quot;Pipeline_Group.Pipeline_Group_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Pipeline</span>}{<span class="w">plate_format</span>}         = <span class="q">&quot;Plate_Format.Plate_Format_Type&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">submission_volume_name</span>}                        = <span class="q">&quot;Submission_Volume.Volume_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">submission_volume_date</span>}                        = <span class="q">&quot;Submission_Volume.Submission_Date&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">volume_status</span>}                                 = <span class="q">&quot;Status.Status_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_metadata_object_type</span>}                 = <span class="q">&quot;Analysis_Metadata_Object.Object_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_metadata_object_external_defined</span>}     = <span class="q">&quot;Analysis_Metadata_Object.Externally_Defined&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_metadata_object_alias</span>}                = <span class="q">&quot;Analysis_Metadata_Object.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_metadata_object_unique_identifier</span>}    = <span class="q">&quot;Analysis_Metadata_Object.Unique_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_file_path</span>}                            = <span class="q">&quot;Analysis_File.Analysis_File_Path&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_file_checksum</span>}                        = <span class="q">&quot;Analysis_File.Checksum&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">external_analysis_field_type</span>}                  = <span class="q">&quot;Analysis_File.External_Analysis_Field_Type&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">external_analysis_field_value</span>}                 = <span class="q">&quot;Analysis_File.External_Analysis_Field_Value&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">sample_metadata_object_external_defined</span>}       = <span class="q">&quot;Sample_Metadata_Object.Externally_Defined&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">sample_metadata_object_alias</span>}                  = <span class="q">&quot;Sample_Metadata_Object.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">sample_metadata_object_unique_identifier</span>}      = <span class="q">&quot;Sample_Metadata_Object.Unique_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_submission_run_analysis_id</span>}           = <span class="q">&quot;Analysis_Submission.FK_Run_Analysis__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_submission_multiplex_run_analysis_id</span>} = <span class="q">&quot;Analysis_Submission.FK_Multiplex_Run_Analysis__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_submission_started</span>}                   = <span class="q">&quot;Analysis_Submission.Analysis_Submission_Started&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_submission_finished</span>}                  = <span class="q">&quot;Analysis_Submission.Analysis_Submission_Finished&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">multiplex_run_analysis_index</span>}                  = <span class="q">&quot;Multiplex_Run_Analysis.Adapter_Index&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">run_analysis_sample</span>}                           = <span class="q">&quot;Run_Analysis.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">trace_submission_status</span>}                       = <span class="q">&quot;Trace_Submission_Status.Status_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_submission_status</span>}                    = <span class="q">&quot;Analysis_Submission_Status.Status_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">analysis_metadata_status</span>}                      = <span class="q">&quot;Analysis_Metadata_Status.Status_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Submission_Volume</span>}{<span class="w">submission_volume_organization</span>}                = <span class="q">&quot;Organization.Organization_Name&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">trace_submission_id</span>}        = <span class="q">&quot;Trace_Submission.Trace_Submission_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">trace_submission_run_id</span>}    = <span class="q">&quot;Trace_Submission.FK_Run__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">trace_submission_sample_id</span>} = <span class="q">&quot;Trace_Submission.FK_Sample__ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">trace_submission_well</span>}      = <span class="q">&quot;Trace_Submission.Well&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Patient</span>}{<span class="w">patient_id</span>}                          = <span class="q">&quot;Patient.Patient_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Patient</span>}{<span class="w">patient_identifier</span>}                  = <span class="q">&quot;Patient.Patient_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Patient</span>}{<span class="w">patient_birthdate</span>}                   = <span class="q">&quot;Patient.Patient_Birthdate&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Patient</span>}{<span class="w">patient_date_of_death</span>}               = <span class="q">&quot;Patient.Date_of_death&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Patient</span>}{<span class="w">patient_sex</span>}                         = <span class="q">&quot;Patient.Patient_Sex&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Work_Request</span>}{<span class="w">work_request</span>}                  = <span class="q">&quot;Work_Request.Work_Request_ID&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Work_Request</span>}{<span class="w">work_request_library</span>}          = <span class="q">&quot;Work_Request.FK_Library__Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Work_Request</span>}{<span class="w">work_request_funding_sow</span>}      = <span class="q">&quot;Funding.Funding_Code&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Work_Request</span>}{<span class="w">work_request_goal</span>}             = <span class="q">&quot;Goal.Goal_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Work_Request</span>}{<span class="w">work_request_percent_complete</span>} = <span class="q">&quot;Work_Request.Percent_Complete&quot;</span><span class="sc">;</span>

<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">sample_name</span>}               = <span class="q">&quot;Sample.Sample_Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">library</span>}                   = <span class="q">&quot;Sample.FK_Library__Name&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">study_alias</span>}               = <span class="q">&quot;Study_MO.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">study_unique_id</span>}           = <span class="q">&quot;Study_MO.Unique_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">metadata_sample_alias</span>}     = <span class="q">&quot;Sample_MO.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">metadata_sample_unique_id</span>} = <span class="q">&quot;Sample_MO.Unique_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">experiment_alias</span>}          = <span class="q">&quot;Experiment_MO.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">experiment_unique_id</span>}      = <span class="q">&quot;Experiment_MO.Unique_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">run_alias</span>}                 = <span class="q">&quot;Run_MO.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">run_unique_id</span>}             = <span class="q">&quot;Run_MO.Unique_Identifier&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">analysis_alias</span>}            = <span class="q">&quot;Analysis_MO.Alias&quot;</span><span class="sc">;</span>
<span class="i">$Aliases</span>{<span class="w">Trace_Submission</span>}{<span class="w">analysis_unique_id</span>}        = <span class="q">&quot;Analysis_MO.Unique_Identifier&quot;</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># constructor                #</span>
<span class="c">##############################</span>

<span class="c">##########</span>
<a name="new-"></a><span class="k">sub </span><span class="m">new</span> <span class="s">{</span>
<span class="c">##########</span>
    <span class="k">my</span> <span class="i">$this</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$class</span> = <span class="k">ref</span><span class="s">(</span><span class="i">$this</span><span class="s">)</span> || <span class="i">$this</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERROR</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$this</span><span class="i">-&gt;error</span><span class="s">(</span> <span class="i">$args</span>{<span class="w">ERROR</span>} <span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">### Connection parameters ###</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>}<span class="sc">;</span>
    <span class="c">### Mandatory ###</span>
    <span class="k">my</span> <span class="i">$dbase</span> = <span class="i">$args</span>{-<span class="w">dbase</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$host</span>  = <span class="i">$args</span>{-<span class="w">host</span>}  || <span class="i">$Defaults</span>{<span class="w">SQL_HOST</span>}<span class="sc">;</span>    <span class="c"># Name of host on which database resides [String]</span>
    <span class="k">my</span> <span class="i">$LIMS_user</span>        = <span class="i">$args</span>{-<span class="w">LIMS_user</span>}<span class="sc">;</span>            <span class="c"># LIMS user name (NOT same as Database connection user name) [String]</span>
    <span class="k">my</span> <span class="i">$LIMS_password</span>    = <span class="i">$args</span>{-<span class="w">LIMS_password</span>}<span class="sc">;</span>        <span class="c"># LIMS password (NOT same as Database connection password) [String]</span>
    <span class="k">my</span> <span class="i">$DB_user</span>          = <span class="i">$args</span>{-<span class="w">DB_user</span>} || <span class="q">'guest'</span><span class="sc">;</span>   <span class="c"># Database connection username (NOT same as LIMS user)</span>
    <span class="k">my</span> <span class="i">$web_service_user</span> = <span class="i">$args</span>{-<span class="w">web_service_user</span>}<span class="sc">;</span>     <span class="c"># The login name used to connect to web service</span>
    <span class="c">### Common Options ###</span>
    <span class="k">my</span> <span class="i">$connect</span> = <span class="i">$args</span>{ -<span class="k">connect</span> }<span class="sc">;</span>                     <span class="c"># Flag to indicate that connection should be made immediately</span>
    <span class="k">my</span> <span class="i">$quiet</span> = <span class="i">$args</span>{-<span class="w">quiet</span>} || <span class="n">0</span><span class="sc">;</span>                      <span class="c"># suppress printed feedback (defaults to 0) [Int]</span>
    <span class="k">my</span> <span class="i">$DB_password</span><span class="sc">;</span>
    <span class="i">$DB_password</span> = <span class="i">$args</span>{-<span class="w">DB_password</span>} || <span class="q">''</span><span class="sc">;</span>            <span class="c">## may supply Database password directly if known</span>
    <span class="c">### Advanced optional parameters ###</span>
    <span class="k">my</span> <span class="i">$driver</span> = <span class="i">$args</span>{-<span class="w">driver</span>} || <span class="i">$Defaults</span>{<span class="w">SQL_DRIVER</span>} || <span class="q">'mysql'</span><span class="sc">;</span>    <span class="c"># SQL driver  [String]</span>
    <span class="k">my</span> <span class="i">$dsn</span>    = <span class="i">$args</span>{-<span class="w">dsn</span>}<span class="sc">;</span>                                           <span class="c"># Connection string [String]</span>
    <span class="k">my</span> <span class="i">$trace</span>  = <span class="i">$args</span>{-<span class="w">trace_level</span>} || <span class="n">0</span><span class="sc">;</span>                              <span class="c"># set trace level on database connection (defaults to 0) [Int]</span>
    <span class="k">my</span> <span class="i">$trace_file</span><span class="sc">;</span>
    <span class="i">$trace_file</span> = <span class="i">$args</span>{-<span class="w">trace_file</span>} || <span class="q">'Trace.log'</span><span class="sc">;</span>                    <span class="c"># optional trace_file where trace info to be written. (required if trace_level set)  [String]</span>
    <span class="k">my</span> <span class="i">$alias_file</span> = <span class="i">$args</span>{-<span class="w">alias_file</span>} || <span class="q">&quot;$config_dir/db_alias.conf&quot;</span><span class="sc">;</span> <span class="c"># Location of DB alias file (optional) [String]</span>
    <span class="k">my</span> <span class="i">$alias_ref</span><span class="sc">;</span>
    <span class="i">$alias_ref</span> = <span class="i">$args</span>{-<span class="w">alias</span>}<span class="sc">;</span>                                         <span class="c"># Reference to DB alias hash (optional). if passed in then overrides alias file [HashRef]</span>

    <span class="k">my</span> <span class="i">$log_call</span> = <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">log_call</span>} ? <span class="i">$args</span>{-<span class="w">log_call</span>} <span class="co">:</span> <span class="n">1</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$dsn</span> &amp;&amp; <span class="i">$driver</span> &amp;&amp; <span class="i">$dbase</span> &amp;&amp; <span class="i">$host</span> <span class="s">)</span> <span class="s">{</span>                        <span class="c"># If DSN is not specified but all other info are provided, then we build a DSN.</span>
        <span class="i">$dsn</span> = <span class="q">&quot;DBI:$driver:database=$dbase:$host&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## Define connection attributes</span>
    <span class="k">my</span> <span class="i">$self</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$dbc</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span> = <span class="i">$dbc</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$self</span> = <span class="i">$this</span><span class="i">-&gt;SDB::DBIO::new</span><span class="s">(</span> -<span class="w">dbase</span> <span class="cm">=&gt;</span> <span class="i">$dbase</span><span class="cm">,</span> -<span class="w">host</span> <span class="cm">=&gt;</span> <span class="i">$host</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$DB_user</span><span class="cm">,</span> -<span class="w">password</span> <span class="cm">=&gt;</span> <span class="i">$DB_password</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">bless</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">$class</span><span class="sc">;</span>

    <span class="c">###  Connection attributes ###</span>
    <span class="i">$self</span>-&gt;{<span class="w">sth</span>}    = <span class="q">''</span><span class="sc">;</span>         <span class="c"># Current statement handle [Object]</span>
    <span class="i">$self</span>-&gt;{<span class="w">dbase</span>}  = <span class="i">$dbase</span><span class="sc">;</span>     <span class="c"># Database name [String]</span>
    <span class="i">$self</span>-&gt;{<span class="w">host</span>}   = <span class="i">$host</span><span class="sc">;</span>      <span class="c"># (MANDATORY unless global default set) host for SQL server. [String]</span>
    <span class="i">$self</span>-&gt;{<span class="w">driver</span>} = <span class="i">$driver</span><span class="sc">;</span>    <span class="c"># SQL driver [String]</span>
    <span class="i">$self</span>-&gt;{<span class="w">dsn</span>}    = <span class="i">$dsn</span><span class="sc">;</span>       <span class="c"># Connection string [String]</span>

    <span class="i">$self</span>-&gt;{<span class="w">DB_user</span>}          = <span class="i">$DB_user</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">DB_password</span>}      = <span class="i">$DB_password</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">LIMS_user</span>}        = <span class="i">$LIMS_user</span><span class="sc">;</span>          <span class="c"># Login user name [String]</span>
    <span class="i">$self</span>-&gt;{<span class="w">LIMS_password</span>}    = <span class="i">$LIMS_password</span><span class="sc">;</span>      <span class="c"># (MANDATORY unless login_file used) specification of password [String]</span>
    <span class="i">$self</span>-&gt;{<span class="w">web_service_user</span>} = <span class="i">$web_service_user</span><span class="sc">;</span>

    <span class="i">$self</span>-&gt;{<span class="w">log_call</span>} = <span class="i">$log_call</span><span class="sc">;</span>
    <span class="c">### query attributes ###</span>
    <span class="i">$self</span>-&gt;{<span class="w">field_list</span>}           = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">join_conditions</span>}      = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">tables</span>}               = <span class="q">''</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">join_tables</span>}          = <span class="q">''</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">left_join_tables</span>}     = <span class="q">''</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">left_join_conditions</span>} = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">order</span>}                = <span class="q">''</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">key</span>}                  = <span class="q">''</span><span class="sc">;</span>

    <span class="i">$self</span>-&gt;{<span class="w">trace</span>}      = <span class="i">$trace</span><span class="sc">;</span>         <span class="c"># set trace level on database connection (defaults to 0) [Int]</span>
    <span class="i">$self</span>-&gt;{<span class="w">trace_file</span>} = <span class="i">$trace_file</span><span class="sc">;</span>    <span class="c"># optional trace_file where trace info to be written. (required if trace_level set) [String]</span>
    <span class="i">$self</span>-&gt;{<span class="w">quiet</span>}      = <span class="i">$quiet</span><span class="sc">;</span>         <span class="c"># suppress printed feedback (defaults to 0) [Int]</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$connect</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;connect_to_DB</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">isConnected</span>} = <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">isConnected</span>} = <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$self</span>-&gt;{<span class="w">warnings</span>} = <span class="s">[</span><span class="s">]</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">errors</span>}   = <span class="s">[</span><span class="s">]</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># public_methods             #</span>
<span class="c">##############################</span>

<span class="c">##########################</span>
<a name="DESTROY-"></a><span class="k">sub </span><span class="m">DESTROY</span> <span class="s">{</span>
<span class="c">##########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;dbh</span><span class="s">(</span><span class="s">)</span><span class="i">-&gt;disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############</span>
<a name="warning-"></a><span class="k">sub </span><span class="m">warning</span> <span class="s">{</span>
<span class="c">##############</span>
    <span class="k">my</span> <span class="i">$self</span>    = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$warning</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">warnings</span>} }<span class="cm">,</span> <span class="i">$warning</span><span class="sc">;</span>
    <span class="i">Message</span><span class="s">(</span><span class="i">$warning</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$self</span>-&gt;{<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################</span>
<a name="warnings-"></a><span class="k">sub </span><span class="m">warnings</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="k">my</span> <span class="i">$self</span>    = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">warnings</span>} } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> .= <span class="q">&quot;\n*****************\n** Warnings: \n*****************\n&quot;</span><span class="sc">;</span>
        <span class="i">$message</span> .= <span class="k">join</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">warnings</span>} }<span class="sc">;</span>
        <span class="i">$message</span> .= <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$message</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">##############</span>
<a name="error-"></a><span class="k">sub </span><span class="m">error</span> <span class="s">{</span>
<span class="c">##############</span>
    <span class="k">my</span> <span class="i">$self</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">errors</span>} }<span class="cm">,</span> <span class="i">$error</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">#################</span>
<a name="errors-"></a><span class="k">sub </span><span class="m">errors</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="k">my</span> <span class="i">$self</span>    = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">errors</span>} } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> .= <span class="q">&quot;\n*****************\n** Errors: \n*****************\n&quot;</span><span class="sc">;</span>
        <span class="i">$message</span> .= <span class="k">join</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">errors</span>} }<span class="sc">;</span>
        <span class="i">$message</span> .= <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$message</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">###########################</span>
<span class="c"># Connect to database using either LIMS password or direct DB password</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:  $LIMS-&gt;connect_to_DB();  # LIMS_user, LIMS_password or DB_user, DB_password should have been sent to constructor</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">######################</span>
<a name="connect_to_DB-"></a><span class="k">sub </span><span class="m">connect_to_DB</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="c">## required to use DIFFERENT password from login password to access database ##</span>

    <span class="k">my</span> <span class="i">$LIMS_user</span>     = <span class="i">$self</span>-&gt;{<span class="w">LIMS_user</span>}     || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$LIMS_password</span> = <span class="i">$self</span>-&gt;{<span class="w">LIMS_password</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$DB_user</span>       = <span class="i">$self</span>-&gt;{<span class="w">DB_user</span>}       || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$DB_password</span>   = <span class="i">$self</span>-&gt;{<span class="w">DB_password</span>}   || <span class="q">''</span><span class="sc">;</span>    <span class="c">## normally this should not be passed in (retrieved automatically from login_file during connect process)</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">LIMS_user</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$validated</span> = <span class="i">$self</span><span class="i">-&gt;_password_check</span><span class="s">(</span> -<span class="w">LIMS_user</span> <span class="cm">=&gt;</span> <span class="i">$LIMS_user</span><span class="cm">,</span> -<span class="w">LIMS_password</span> <span class="cm">=&gt;</span> <span class="i">$self</span>-&gt;{<span class="w">LIMS_password</span>}<span class="cm">,</span> -<span class="w">DB_user</span> <span class="cm">=&gt;</span> <span class="i">$DB_user</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">unless</span> <span class="s">(</span><span class="i">$validated</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="q">&quot;$LIMS_user failed to connect as $DB_user.\n&quot;</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="i">$self</span><span class="i">-&gt;connect</span><span class="s">(</span> -<span class="w">password</span> <span class="cm">=&gt;</span> <span class="i">$DB_password</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$self</span><span class="i">-&gt;dbh</span><span class="s">(</span><span class="s">)</span> &amp;&amp; <span class="i">$self</span><span class="i">-&gt;dbh</span><span class="s">(</span><span class="s">)</span><span class="i">-&gt;ping</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">isConnected</span>} = <span class="i">$self</span><span class="i">-&gt;dbh</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">log_call</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;set_log_file</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">Message</span><span class="s">(</span><span class="q">&quot;NO Log call&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> !<span class="i">$self</span>-&gt;{<span class="w">quiet</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">isConnected</span>} = <span class="n">0</span><span class="sc">;</span>
        <span class="k">die</span> <span class="q">&quot;Connection to database failed : Aborting...\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># set permissions if user set</span>

    <span class="i">$LIMS_user</span> ||= <span class="q">'API client'</span><span class="sc">;</span>    <span class="c">## default user for API - enables tracking of Change History tied to Employee_ID</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$LIMS_user</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$emp_id</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Employee&quot;</span><span class="cm">,</span> <span class="q">&quot;Employee_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Email_Address='$LIMS_user' OR Employee_Name = '$LIMS_user'&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$emp_id</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;** Invalid user ($LIMS_user) - cannot set permissions **&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$self</span><span class="i">-&gt;set_local</span><span class="s">(</span> <span class="q">'user_id'</span><span class="cm">,</span> <span class="i">$emp_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$eo</span> = <span class="i">new</span> <span class="i">alDente::Employee</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$emp_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$eo</span><span class="i">-&gt;define_User</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Update Aliases with Field_Reference by using the database connection</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%Aliases</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">for</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$Aliases</span>{<span class="i">$table</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$Aliases</span>{<span class="i">$table</span>}{<span class="i">$key</span>} =~ <span class="q">/Field_Reference\((.+)\)/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$field</span> = <span class="i">$1</span><span class="sc">;</span>
                <span class="s">(</span> <span class="i">$Aliases</span>{<span class="i">$table</span>}{<span class="i">$key</span>} <span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;DBField&quot;</span><span class="cm">,</span> <span class="q">&quot;Field_Reference&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Field_Name = '$field'&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Establish path to logging file</span>
<span class="c">#</span>
<span class="c">##################</span>
<a name="set_log_file-"></a><span class="k">sub </span><span class="m">set_log_file</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">$self</span>             = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$LIMS_user</span>        = <span class="k">shift</span> || <span class="i">$self</span>-&gt;{<span class="w">LIMS_user</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$DB_user</span>          = <span class="k">shift</span> || <span class="i">$self</span>-&gt;{<span class="w">DB_user</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$web_service_user</span> = <span class="k">shift</span> || <span class="i">$self</span>-&gt;{<span class="w">web_service_user</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$web_service_user</span><span class="s">)</span> <span class="s">{</span> <span class="i">$web_service_user</span> = <span class="q">&quot;-$web_service_user&quot;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$LOGBASE</span>    = <span class="i">$Configs</span>{<span class="w">Home_public</span>} . <span class="q">'/logs/API_logs'</span><span class="sc">;</span>                                    <span class="c">## Log file base name (should be globally accessible location)</span>
    <span class="k">my</span> <span class="i">$LOGPATH</span>    = <span class="i">create_dir</span><span class="s">(</span> <span class="i">$LOGBASE</span><span class="cm">,</span> <span class="i">convert_date</span><span class="s">(</span> <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">'YYYY/MM/DD'</span> <span class="s">)</span><span class="cm">,</span> <span class="q">'777'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$url_domain</span> = <span class="i">try_system_command</span><span class="s">(</span><span class="q">'hostname'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">chomp</span> <span class="i">$url_domain</span><span class="sc">;</span>
    <span class="i">$url_domain</span> =~ <span class="q">s/\..*//</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">-e</span> <span class="i">$LOGPATH</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;Error: couldn't create $LOGPATH\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$LIMS_user</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">log_file</span>} = <span class="q">&quot;$LOGPATH/API_usage.$url_domain.$DB_user-$LIMS_user$web_service_user.log&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$user</span> = <span class="i">try_system_command</span><span class="s">(</span><span class="q">'whoami'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">chomp</span> <span class="i">$user</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">log_file</span>} = <span class="q">&quot;$LOGPATH/API_usage.$url_domain.$DB_user.$user$web_service_user.log&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">################################################</span>
<span class="c"># return: hash containing number of records retrieved</span>
<span class="c">##############</span>
<a name="records-"></a><span class="k">sub </span><span class="m">records</span> <span class="s">{</span>
<span class="c">##############</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">records</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">###########################################################################</span>
<span class="c">#</span>
<span class="c"># &lt;CONSTRUCTION&gt; All of the get_record and associated functionality should be inhereted from the DBIO / GSDB level.</span>
<span class="c">#</span>
<span class="c">###########################################</span>
<span class="c"># To be used when retrieved data is saved</span>
<span class="c">#  (use -save option in data extraction method to enable)</span>
<span class="c">#</span>
<span class="c"># Retrieves the current record</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:</span>
<span class="c">#   my $data = get_Plate_data(-library=&gt;'LIB01',-save=&gt;1);</span>
<span class="c">#</span>
<span class="c">#   my $plate1 = $data-&gt;get_record();</span>
<span class="c">#   ...</span>
<span class="c">#   my $plate20 = $data-&gt;get_record(20);</span>
<span class="c">#</span>
<span class="c">#   ## (example of data format for first record retrieved ($plate1))</span>
<span class="c">#   $plate1 = {plate_id =&gt; 2000,</span>
<span class="c">#              library  =&gt; 'LIB01',</span>
<span class="c">#              plate_number =&gt; 1,</span>
<span class="c">#              ....</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># return: hash containing next record values</span>
<span class="c">##############</span>
<a name="get_record-"></a><span class="k">sub </span><span class="m">get_record</span> <span class="s">{</span>
<span class="c">##############</span>
    <span class="k">my</span> <span class="i">$self</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$index</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$index</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} = <span class="i">$index</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">more_records</span>} = <span class="i">$self</span>-&gt;{<span class="w">records</span>} - <span class="i">$index</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">unless</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">data</span>} <span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;No Data retrieved (did you use the -save option ?)&quot;</span><span class="sc">;</span> <span class="k">return</span> <span class="s">{</span><span class="s">}</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">records</span>} <span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;No more records returned&quot;</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} = <span class="n">0</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">@keys</span> = <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$self</span>-&gt;{<span class="w">data</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">%hash</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">@keys</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$hash</span>{<span class="i">$key</span>} = <span class="i">$self</span>-&gt;{<span class="w">data</span>}{<span class="i">$key</span>}[ <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} ]<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> \<span class="i">%hash</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################################</span>
<span class="c"># To be used when retrieved data is saved</span>
<span class="c">#  (use -save option in data extraction method to enable)</span>
<span class="c">#</span>
<span class="c"># Retrieves the next record</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:</span>
<span class="c">#   my $data = get_Plate_data(-library=&gt;'LIB01',-save=&gt;1);</span>
<span class="c">#   foreach my $plate (1 .. $data-&gt;record_count()) {</span>
<span class="c">#     my $plate = $data-&gt;get_next_record();</span>
<span class="c">#     ...</span>
<span class="c">#</span>
<span class="c">#     ## each subsequent call retrieves a new record ##</span>
<span class="c">#     $plate1 = {plate_id =&gt; 2000,</span>
<span class="c">#              library  =&gt; 'LIB01',</span>
<span class="c">#              plate_number =&gt; 1,</span>
<span class="c">#              ....</span>
<span class="c">#   }</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># return: hash containing next record values</span>
<span class="c">##################</span>
<a name="get_next_record-"></a><span class="k">sub </span><span class="m">get_next_record</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$self</span><span class="i">-&gt;next_record</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;No more records&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_record</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############################################</span>
<span class="c"># To be used when retrieved data is saved</span>
<span class="c">#  (use -save option in data extraction method to enable)</span>
<span class="c">#</span>
<span class="c"># increments index (useful when calling get_data('attribute')</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:</span>
<span class="c">#   my $data = get_Plate_data(-library=&gt;'LIB01',-save=&gt;1);</span>
<span class="c">#   foreach my $plate (1 .. $data-&gt;record_count()) {</span>
<span class="c">#     my $plate = $data-&gt;get_record();</span>
<span class="c">#     $data-&gt;next_record();</span>
<span class="c">#   }</span>
<span class="c">#  ## note these two lines (get_record... next_record) are equivalent to simply : get_next_record.</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># return: index counter</span>
<span class="c">##############</span>
<a name="next_record-"></a><span class="k">sub </span><span class="m">next_record</span> <span class="s">{</span>
<span class="c">##############</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">records</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">defined</span> <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} = <span class="n">0</span> <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} &gt;= <span class="i">$self</span>-&gt;{<span class="w">records</span>} - <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="q">&quot;No more records\n&quot;</span><span class="sc">;</span>
            <span class="i">$self</span>-&gt;{<span class="w">more_records</span>} = <span class="n">0</span><span class="sc">;</span>
            <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} = <span class="i">$self</span>-&gt;{<span class="w">records</span>} - <span class="n">1</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$self</span>-&gt;{<span class="w">record_index</span>}++<span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$self</span>-&gt;{<span class="w">more_records</span>} = <span class="i">$self</span>-&gt;{<span class="w">records</span>} - <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} - <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">data</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;No records retrieved\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;No Data saved\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">record_index</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#############################################</span>
<span class="c"># To be used when retrieved data is saved</span>
<span class="c">#  (use -save option in data extraction method to enable)</span>
<span class="c">#</span>
<span class="c"># resets index when using 'get_attribute' or 'get_next_attribute'</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># return: total records in saved data set</span>
<span class="c">#######################</span>
<a name="reset_record_index-"></a><span class="k">sub </span><span class="m">reset_record_index</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$index</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$index</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} = <span class="i">$index</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">more_records</span>} = <span class="i">$self</span>-&gt;{<span class="w">records</span>} - <span class="i">$index</span> - <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">records</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">record_index</span>} = <span class="k">undef</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">more_records</span>} = <span class="i">$self</span>-&gt;{<span class="w">records</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">data</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;No records retrieved&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;No Data saved&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">records</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################</span>
<a name="get_lookup_data-"></a><span class="k">sub </span><span class="m">get_lookup_data</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'lookup'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'lookup'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$table</span> = <span class="i">$args</span>{-<span class="w">lookup</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>

    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>

    <span class="c">### Re-Cast arguments as required ###</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

    <span class="c">## Initial Framework for query ##</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="i">$table</span><span class="sc">;</span>                                        <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">'WHERE 1'</span><span class="sc">;</span>                                     <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>                                            <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">##### DYNAMICALLY JOINED Tables: #####</span>
    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>                                             <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>                                        <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## adapt conditions using appropriate aliases as required ##</span>
    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>

    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="i">$self</span><span class="i">-&gt;get_fields</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="i">$table</span> <span class="s">)</span><span class="sc">;</span>               <span class="c">## &lt;- Default list of fields to retrieve</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#############################</span>
<span class="c">## Data extraction methods ##</span>
<span class="c">#############################</span>
<span class="c"># sample</span>
<span class="c"># source</span>
<span class="c"># plate</span>
<span class="c"># library</span>
<span class="c"># run</span>
<span class="c">#############################</span>
<span class="c">################################</span>
<span class="c"># Must specify ONE of the following keys (logically tested in this order):</span>
<span class="c">#</span>
<span class="c"># - mgc_number (.. ELSE ..)</span>
<span class="c"># - original_plate_id (.. ELSE ..)</span>
<span class="c"># - source_collection (and source_plate , source_quadrant if desired)  (.. ELSE ..)</span>
<span class="c"># - sample_name (.. ELSE ..)</span>
<span class="c"># - library (and plate_number if desired)  (.. ELSE ..)</span>
<span class="c"># - project_id (may include comma-delimited list as a string)</span>
<span class="c">#</span>
<span class="c"># AND include (optional) extra conditions such as:</span>
<span class="c"># - sample_id(s)  (comma-delimited list) - may include with above to indicate domain of samples to search from</span>
<span class="c"># - source_quadrant (quadrant from original sourced plate)</span>
<span class="c">#</span>
<span class="c"># May also specify:</span>
<span class="c"># -  condition : (extra SQL condition applied ONLY to Clone / Source information)</span>
<span class="c"># -  limit : to the number of unique clone records retrieved.</span>
<span class="c"># -  a specified list of fields to retrieve (defaults to a fairly complete list of info)</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:</span>
<span class="c">#   my $data = $API-&gt;get_Clone_data(</span>
<span class="c">#          -source_collection=&gt;'IRAL',-source_plate=&gt;49,-source_quadrant=&gt;'b',</span>
<span class="c">#          -key=&gt;'mgc_number');  ## set key of hash to mgc_number</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># (see _generate_query method for more details on input parameter options)</span>
<span class="c">#</span>
<span class="c"># Returns: hash (eg %data-&gt;{field1}=[val1,val2,val3..] etc.) or a hash for each record (format=&gt;'array' or key=&gt;'$key')</span>
<span class="c">###################</span>
<a name="get_Clone_data-"></a><span class="k">sub </span><span class="m">get_Clone_data</span> <span class="s">{</span>    <span class="c"># (same as get_sample_data)</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_sample_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################</span>
<span class="c"># Retrieve field type for field or alias.</span>
<span class="c">#</span>
<span class="c"># In case of aliases which do not map directly to a single field, the method will return a literal translation of the field.</span>
<span class="c">#</span>
<span class="c"># eg.</span>
<span class="c"># get_field_type(&quot;Max(Plate_ID)&quot;) returns 'LITERAL: Max(Plate_ID)'.</span>
<span class="c"># get_field_type('unique_samples') = &quot;LITERAL: count(DISTINCT Clone_Sequence.FK_Sample__ID)&quot;</span>
<span class="c">#</span>
<span class="c"># Return: field type or &quot;LITERAL: &lt;literal translation&gt;&quot;</span>
<span class="c">#####################</span>
<a name="get_field_type-"></a><span class="k">sub </span><span class="m">get_field_type</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$field</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="c">## check if using alias first ##</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%Aliases</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Aliases</span>{<span class="i">$key</span>}{<span class="i">$field</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$field</span> = <span class="i">$Aliases</span>{<span class="i">$key</span>}{<span class="i">$field</span>}<span class="sc">;</span>
            <span class="k">last</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$extra_condition</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$field</span> =~ <span class="q">/^(\w+)\.(\w+)$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## field fully qualified with table name ##</span>
        <span class="i">$field</span>           = <span class="i">$2</span><span class="sc">;</span>
        <span class="i">$extra_condition</span> = <span class="q">&quot; AND DBTable_Name = '$1'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$field_type</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'DBField,DBTable'</span><span class="cm">,</span> <span class="q">'Field_Type'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_DBTable__ID=DBTable_ID AND Field_Name = '$field' $extra_condition&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$field_type</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;LITERAL: $field&quot;</span><span class="sc">;</span>    <span class="c">## return literal string if no single field identified.</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$field_type</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>

<span class="c"># Template for creating a new database object api</span>
<span class="c"># Fill in the necessary options, conditions and tables</span>
<span class="c">#</span>
<span class="c">############################</span>
<a name="get_template_data-"></a><span class="k">sub </span><span class="m">get_template_data</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Include below any arguments that should appear in perldoc + any arguments needing specific attention</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$study_id</span>         = <span class="i">$args</span>{-<span class="w">study_id</span>}<span class="sc">;</span>            <span class="c">### a study id (a defined set of libraries/projects)</span>
    <span class="k">my</span> <span class="i">$project_id</span>       = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>          <span class="c">### specify project_id</span>
    <span class="k">my</span> <span class="i">$library</span>          = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>             <span class="c">### specify library</span>
    <span class="c">## plate specification options</span>
    <span class="k">my</span> <span class="i">$plate_id</span>          = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                   <span class="c">### specify plate_id</span>
    <span class="k">my</span> <span class="i">$plate_number</span>      = <span class="i">$args</span>{-<span class="w">plate_number</span>}<span class="sc">;</span>               <span class="c">### specify plate number</span>
    <span class="k">my</span> <span class="i">$well</span>              = <span class="i">$args</span>{-<span class="w">well</span>}<span class="sc">;</span>                       <span class="c">### specify plate number</span>
    <span class="k">my</span> <span class="i">$plate_type</span>        = <span class="i">$args</span>{-<span class="w">plate_type</span>} || <span class="q">''</span><span class="sc">;</span>           <span class="c">### specify type of plate (tube or Library_Plate)</span>
    <span class="k">my</span> <span class="i">$plate_class</span>       = <span class="i">$args</span>{-<span class="w">plate_class</span>} || <span class="q">''</span><span class="sc">;</span>          <span class="c">### specify class of plate (clone or extraction)</span>
    <span class="k">my</span> <span class="i">$plate_application</span> = <span class="i">$args</span>{-<span class="w">plate_application</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c">### specify application of plate (Sequencing/Mapping/PCR)</span>
    <span class="k">my</span> <span class="i">$original_plate_id</span> = <span class="i">$args</span>{-<span class="w">original_plate_id</span>}<span class="sc">;</span>          <span class="c">### specify original plate id</span>
    <span class="k">my</span> <span class="i">$original_well</span>     = <span class="i">$args</span>{-<span class="w">original_well</span>}<span class="sc">;</span>              <span class="c">### specify original well</span>
    <span class="k">my</span> <span class="i">$applied_plate_id</span>  = <span class="i">$args</span>{-<span class="w">applied_plate_id</span>}<span class="sc">;</span>           <span class="c">### specify original plate id (including ReArrays)</span>
    <span class="k">my</span> <span class="i">$quadrant</span>          = <span class="i">$args</span>{-<span class="w">quadrant</span>}<span class="sc">;</span>                   <span class="c">### specify quadrant from original plate</span>
    <span class="k">my</span> <span class="i">$sample_id</span>         = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>                  <span class="c">### specify sample_id</span>
    <span class="k">my</span> <span class="i">$run_id</span>            = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_type</span>      = <span class="i">$args</span>{-<span class="w">library_type</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                                  <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                                <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">''</span><span class="sc">;</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>

            <span class="c">### Re-Cast arguments as required ###</span>
            <span class="k">my</span> <span class="i">$libs</span><span class="sc">;</span>
            <span class="i">$libs</span> = <span class="i">$self</span><span class="i">-&gt;get_libraries</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$study_id</span> || <span class="i">$project_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$libs</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span><span class="sc">;</span>
    <span class="i">$plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_numbers</span><span class="sc">;</span>
    <span class="i">$plate_numbers</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_number</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_number</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$wells</span><span class="sc">;</span>
    <span class="i">$wells</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$well</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$well</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$samples</span><span class="sc">;</span>
    <span class="i">$samples</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$sample_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_types</span><span class="sc">;</span>
    <span class="i">$library_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library_type</span><span class="sc">;</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

    <span class="c">## Initial Framework for query ##</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="q">''</span><span class="sc">;</span>    <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">''</span><span class="sc">;</span>    <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>    <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">##### DYNAMICALLY JOINED Tables: #####</span>
    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>     <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>    <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## adapt conditions using appropriate aliases as required ##</span>
    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>

    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw()</span><span class="sc">;</span>            <span class="c">## &lt;- Default list of fields to retrieve</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################################################</span>
<span class="c"># Retrieve data about Stock Items</span>
<span class="c"># (Use to retrieve information about Solutions, Equipment, Boxes etc</span>
<span class="c">#</span>
<span class="c"># &lt;SNIP&gt;</span>
<span class="c"># Example:</span>
<span class="c">#   $API-&gt;get_stock_data(-barcode=&gt;'sol19883',-fields=&gt;'primer_sequence');</span>
<span class="c">#</span>
<span class="c">#   $API-&gt;get_stock_data(-type=&gt;'solution',-id=&gt;'19883', -add_fields=&gt;['Solution.FK_Rack__ID']);</span>
<span class="c">#&lt;/SNIP&gt;</span>
<span class="c">#</span>
<span class="c">#####################</span>
<a name="get_stock_data-"></a><span class="k">sub </span><span class="m">get_stock_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'type|barcode'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="c">## Include below any arguments that should appear in perldoc + any arguments needing specific attention</span>
    <span class="k">my</span> <span class="i">$barcode</span>            = <span class="i">$args</span>{-<span class="w">barcode</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>                 = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>               = <span class="i">$args</span>{-<span class="w">type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$name</span>               = <span class="i">$args</span>{-<span class="w">name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$cat</span>                = <span class="i">$args</span>{-<span class="w">catalog_number</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$vendor</span>             = <span class="i">$args</span>{-<span class="w">vendor</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$manufacturer</span>       = <span class="i">$args</span>{-<span class="w">manufacturer</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$equipment_category</span> = <span class="i">$args</span>{-<span class="w">equipment_category</span>}<span class="sc">;</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="c">## plate specification options</span>
    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                          <span class="c">### specify Received date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                        <span class="c">### specify Received date to stop search (context dependent)</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>

            <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(Stock_Catalog_Name Stock_Received Stock_Catalog.Stock_Catalog_Number vendor manufacturer)</span><span class="sc">;</span>    <span class="c">## &lt;- Default list of fields to retrieve</span>

            <span class="c">## Set type if barcode supplied directly ##</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$barcode</span> =~ <span class="q">/^(sol|equ|box)(\d+)/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$prefix</span> = <span class="i">$1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$table</span><span class="sc">;</span>
        <span class="k">if</span>    <span class="s">(</span> <span class="i">$prefix</span> =~ <span class="q">/sol/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$table</span> = <span class="q">'Solution'</span> <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$prefix</span> =~ <span class="q">/equ/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$table</span> = <span class="q">'Equipment'</span> <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$prefix</span> =~ <span class="q">/box/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$table</span> = <span class="q">'Box'</span> <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$table</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$id</span> = <span class="i">$self</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> <span class="q">&quot;FK_&quot;</span> . <span class="i">$table</span> . <span class="q">&quot;__ID&quot;</span><span class="cm">,</span> <span class="i">$barcode</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Item prefix: $prefix not recognized&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$type</span> ||= <span class="i">$table</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

    <span class="c">## Initial Framework for query ##</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="q">'Stock,Stock_Catalog'</span><span class="sc">;</span>                                    <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">'WHERE Stock.FK_Stock_Catalog__ID = Stock_Catalog_ID'</span><span class="sc">;</span>    <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>                                                       <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">##### DYNAMICALLY JOINED Tables: #####</span>

    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="c">## standards ##</span>

        <span class="c">## special cases included dynamically if required ##</span>
        <span class="q">&quot;Primer&quot;</span> <span class="cm">=&gt;</span> <span class="q">&quot;Primer.Primer_Name=Stock_Catalog_Name&quot;</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>                                                                               <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">### Re-Cast arguments as required ###</span>
    <span class="k">my</span> <span class="i">$ids</span><span class="sc">;</span>
    <span class="i">$ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$id</span><span class="sc">;</span>
    <span class="c">## adjust type ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/(primer)/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'Primer.Primer_Sequence'</span><span class="cm">,</span> <span class="q">'solution_status'</span><span class="sc">;</span>
        <span class="i">$join_conditions</span>-&gt;{<span class="q">'Solution'</span>} = <span class="q">&quot;Solution.FK_Stock__ID = Stock_ID&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/(solution|reagent|primer|matrix|buffer)/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$type</span> = <span class="q">'Solution'</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'solution_type'</span><span class="cm">,</span> <span class="q">'solution_status'</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/(box|kit)/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$type</span> = <span class="q">'Box'</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'Box.Box_Type'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/equipment/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$type</span>                                    = <span class="q">'Equipment'</span><span class="sc">;</span>
        <span class="i">$join_conditions</span>-&gt;{<span class="i">$type</span>}                = <span class="q">&quot;$type.FK_Stock__ID = Stock_ID&quot;</span><span class="sc">;</span>
        <span class="i">$join_conditions</span>-&gt;{<span class="q">'Equipment_Category'</span>} = <span class="q">&quot;Stock_Catalog.FK_Equipment_Category__ID=Equipment_Category.Equipment_Category_ID&quot;</span><span class="sc">;</span>
        <span class="i">$join_conditions</span>-&gt;{<span class="w">Location</span>}             = <span class="q">'Equipment.FK_Location__ID=Location.Location_ID'</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'equipment_status'</span><span class="cm">,</span> <span class="q">'equipment_category'</span><span class="cm">,</span> <span class="q">'equipment_location'</span><span class="cm">,</span> <span class="q">'equipment_id'</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/misc/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$type</span> = <span class="q">'Misc_Item'</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'Misc_Item.Misc_Item_Type'</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> &amp;&amp; <span class="i">$type</span> !~ <span class="q">/equipment/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## add location fields ##</span>
        <span class="i">$join_conditions</span>-&gt;{<span class="i">$type</span>} = <span class="q">&quot;$type.FK_Stock__ID = Stock_ID&quot;</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> !~ <span class="q">/equipment/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$join_conditions</span>-&gt;{<span class="w">Rack</span>}                   = <span class="q">&quot;$type.FK_Rack__ID = Rack.Rack_ID&quot;</span><span class="sc">;</span>
            <span class="i">$join_conditions</span>-&gt;{<span class="q">'Equipment as Storage'</span>} = <span class="q">&quot;Rack.FK_Equipment__ID=Storage.Equipment_ID&quot;</span><span class="sc">;</span>
            <span class="i">$join_conditions</span>-&gt;{<span class="w">Location</span>}               = <span class="q">'Storage.FK_Location__ID=Location.Location_ID'</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$ids</span> &amp;&amp; <span class="i">$type</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;$type.$type&quot;</span> . <span class="q">&quot;_ID IN ($ids)&quot;</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$ids</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Stock.Stock_ID IN ($ids)&quot;</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$name</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Stock_Catalog.Stock_Catalog_Name LIKE '$name'&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$cat</span><span class="s">)</span>  <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Stock_Catalog.Stock_Catalog_Number LIKE '$name'&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$vendor</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;vendor like '$vendor'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$manufacturer</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;manufacturer like '$manufacturer'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$equipment_category</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;equipment_category like '$equipment_category%'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">'Organization as Vendor'</span>       <span class="cm">=&gt;</span> <span class="q">'Stock_Catalog.FKVendor_Organization__ID=Vendor.Organization_ID'</span><span class="cm">,</span>
        <span class="q">'Organization as Manufacturer'</span> <span class="cm">=&gt;</span> <span class="q">'Stock_Catalog.FK_Organization__ID=Manufacturer.Organization_ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>    <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## adapt conditions using appropriate aliases as required ##</span>
    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>

    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">date_field</span>           <span class="cm">=&gt;</span> <span class="q">&quot;Stock.Stock_Received&quot;</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################################</span>
<span class="c"># API to retrieve a list of sample origin types</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#   Example:</span>
<span class="c">#   my $original_source_types = $API-&gt;get_sample_origin_type_data();</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c"># Return: array ref of data</span>
<span class="c">#######################</span>
<a name="get_sample_origin_type_data-"></a><span class="k">sub </span><span class="m">get_sample_origin_type_data</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$table</span>               = <span class="q">'Original_Source'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$field</span>               = <span class="q">'Original_Source_Type'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@sample_origin_types</span> = <span class="i">$self</span><span class="i">-&gt;get_enum_list</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$field</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> \<span class="i">@sample_origin_types</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################################</span>
<span class="c"># API to retrieve library information</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#   Example:</span>
<span class="c">#   my $library = &quot;HGL01&quot;;</span>
<span class="c">#   my $libary_data = $API-&gt;get_library_data(-library=&gt;$library);</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c"># Return: hash of data</span>
<span class="c">#######################</span>
<a name="get_library_data-"></a><span class="k">sub </span><span class="m">get_library_data</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>                <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$study_id</span>         = <span class="i">$args</span>{-<span class="w">study_id</span>}  || <span class="i">$args</span>{ -<span class="k">study</span> }<span class="sc">;</span>    <span class="c">### a study id (a defined set of libraries/projects)</span>
    <span class="k">my</span> <span class="i">$project_id</span>       = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>                      <span class="c">### specify project_id</span>
    <span class="k">my</span> <span class="i">$library</span>          = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>                         <span class="c">### specify library</span>
    <span class="k">my</span> <span class="i">$library_type</span>     = <span class="i">$args</span>{-<span class="w">library_type</span>}<span class="sc">;</span>                    <span class="c">### specify the library type to filter on</span>
    <span class="k">my</span> <span class="i">$debug</span>            = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$goal</span> = <span class="i">$args</span>{-<span class="w">goal</span>}<span class="sc">;</span>                                        <span class="c">### Retrieve information for libraries with specified goal.</span>

    <span class="k">my</span> <span class="i">$goal_type</span>               = <span class="i">$args</span>{-<span class="w">goal_type</span>}<span class="sc">;</span>                <span class="c">### specify the type of goal to filter on (ie 'Lab Work','Data Analysis','Custom Data Analysis')</span>
    <span class="k">my</span> <span class="i">$library_analysis_status</span> = <span class="i">$args</span>{-<span class="w">library_analysis_status</span>}<span class="sc">;</span>  <span class="c">### specify the library_analysis_status (ie 'N/A', 'In production','Complete')</span>
    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                                      <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                                    <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">'Library.Library_Obtained_Date'</span><span class="sc">;</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>     = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span> = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>      = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>                   <span class="c">### ORDER BY</span>
                                                                    <span class="c">#my $group       = $args{-group} || $args{-group_by} || $args{-key} || 'library';    ### GROUP BY</span>
            <span class="k">my</span> <span class="i">$KEY</span>        = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>                           <span class="c"># || $group;                               ### KEY on</span>

            <span class="k">my</span> <span class="i">$group</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span><span class="s">(</span> <span class="i">$args</span>{-<span class="w">group</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$group</span> = <span class="i">$args</span>{-<span class="w">group</span>}<span class="sc">;</span>
        <span class="i">$KEY</span> = <span class="i">$group</span> <span class="k">if</span> !<span class="i">$KEY</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">defined</span><span class="s">(</span> <span class="i">$args</span>{-<span class="w">group_by</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$group</span> = <span class="i">$args</span>{-<span class="w">group_by</span>}<span class="sc">;</span>
        <span class="i">$KEY</span> = <span class="i">$group</span> <span class="k">if</span> !<span class="i">$KEY</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">key</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$group</span> = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$group</span> = <span class="q">'library'</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>          <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>    <span class="c">### just generate a list of output fields</span>

    <span class="c">### Re-Cast arguments if necessary ###</span>
    <span class="k">my</span> <span class="i">$study_ids</span><span class="sc">;</span>
    <span class="i">$study_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$study_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$study_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$project_ids</span><span class="sc">;</span>
    <span class="i">$project_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$project_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$project_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_types</span><span class="sc">;</span>
    <span class="i">$library_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library_type</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$goals</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$goal</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$goal</span><span class="sc">;</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$tables</span>           = <span class="q">'Library,Original_Source'</span><span class="sc">;</span>                                    <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">'WHERE Library.FK_Original_Source__ID=Original_Source_ID'</span><span class="sc">;</span>    <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>                                                           <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="q">'Project'</span>      <span class="cm">=&gt;</span> <span class="q">'Library.FK_Project__ID=Project.Project_ID'</span><span class="cm">,</span>
        <span class="q">'Contact'</span>      <span class="cm">=&gt;</span> <span class="q">'Library.FK_Contact__ID=Contact.Contact_ID'</span><span class="cm">,</span>
        <span class="q">'Organization'</span> <span class="cm">=&gt;</span> <span class="q">'Contact.FK_Organization__ID=Organization.Organization_ID'</span><span class="cm">,</span>

        <span class="c">#	'Vector_Based_Library'                    =&gt;'Vector_Based_Library.FK_Library__Name = Library.Library_Name',</span>
        <span class="q">'RNA_DNA_Collection'</span>                    <span class="cm">=&gt;</span> <span class="q">'RNA_DNA_Collection.FK_Library__Name = Library.Library_Name'</span><span class="cm">,</span>
        <span class="q">'LibraryApplication'</span>                    <span class="cm">=&gt;</span> <span class="q">'LibraryApplication.FK_Library__Name = Library.Library_Name'</span><span class="cm">,</span>                   <span class="c">## only relevant if primer specified as condition/field</span>
        <span class="q">'Contact as Original_Contact'</span>           <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Contact__ID = Original_Contact.Contact_ID'</span><span class="cm">,</span>
        <span class="q">'Organization as Original_Organization'</span> <span class="cm">=&gt;</span> <span class="q">'Original_Contact.FK_Organization__ID=Original_Organization.Organization_ID'</span><span class="cm">,</span>
        <span class="q">'Primer'</span>                                <span class="cm">=&gt;</span> <span class="q">'LibraryApplication.Object_ID = Primer.Primer_ID'</span><span class="cm">,</span>
        <span class="q">'Source'</span>                                <span class="cm">=&gt;</span> <span class="q">'Library_Source.FK_Source__ID = Source.Source_ID'</span><span class="cm">,</span>
        <span class="q">'Library_Source'</span>                        <span class="cm">=&gt;</span> <span class="q">'Library_Source.FK_Library__Name=Library.Library_Name'</span><span class="cm">,</span>

        <span class="c"># 'Organism'                              =&gt;'Original_Source.FK_Organism__ID = Organism.Organism_ID',</span>
        <span class="q">'Taxonomy'</span> <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Taxonomy__ID = Taxonomy.Taxonomy_ID'</span><span class="cm">,</span>
        <span class="q">'Grp'</span>      <span class="cm">=&gt;</span> <span class="q">'Library.FK_Grp__ID = Grp_ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">'Vector_Based_Library'</span>                 <span class="cm">=&gt;</span> <span class="q">'Vector_Based_Library.FK_Library__Name = Library.Library_Name'</span><span class="cm">,</span>
        <span class="q">'SAGE_Library'</span>                         <span class="cm">=&gt;</span> <span class="q">'SAGE_Library.FK_Vector_Based_Library__ID = Vector_Based_Library.Vector_Based_Library_ID'</span><span class="cm">,</span>
        <span class="q">'Mapping_Library'</span>                      <span class="cm">=&gt;</span> <span class="q">'Mapping_Library.FK_Vector_Based_Library__ID = Vector_Based_Library.Vector_Based_Library_ID'</span><span class="cm">,</span>
        <span class="q">'Stage'</span>                                <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Stage__ID = Stage.Stage_ID'</span><span class="cm">,</span>
        <span class="q">'Work_Request as Library_Work_Request'</span> <span class="cm">=&gt;</span> <span class="q">'Library.Library_Name = Library_Work_Request.FK_Library__Name'</span><span class="cm">,</span>
        <span class="q">'Goal as Library_Goal'</span>                 <span class="cm">=&gt;</span> <span class="q">'Library_Work_Request.FK_Goal__ID = Library_Goal.Goal_ID'</span><span class="cm">,</span>
        <span class="q">'Funding as Library_Funding'</span>           <span class="cm">=&gt;</span> <span class="q">'Library_Work_Request.FK_Funding__ID = Library_Funding.Funding_ID'</span><span class="cm">,</span>
        <span class="q">'Cell_Line'</span>                            <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Cell_Line__ID = Cell_Line_ID'</span><span class="cm">,</span>
        <span class="q">'Pathology'</span>                            <span class="cm">=&gt;</span> <span class="q">'Pathology.Pathology_ID = Original_Source.FK_Pathology__ID'</span><span class="cm">,</span>
        <span class="q">'Anatomic_Site'</span>                        <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Anatomic_Site__ID = Anatomic_Site_ID'</span><span class="cm">,</span>
        <span class="q">'Histology'</span>                            <span class="cm">=&gt;</span> <span class="q">'Pathology.FK_Histology__ID = Histology.Histology_ID'</span><span class="cm">,</span>
        <span class="q">'Patient'</span>                              <span class="cm">=&gt;</span> <span class="q">'Patient.Patient_ID = Original_Source.FK_Patient__ID'</span><span class="cm">,</span>
        <span class="q">'Strain'</span>                               <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Strain__ID = Strain.Strain_ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>    <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$study_ids</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@libs</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Study,LibraryStudy'</span><span class="cm">,</span> <span class="q">'FK_Library__Name'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Study__ID=Study_ID AND (Study_ID = $study_id OR Study_Name = '$study_id')&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@proj_libs</span>
            = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Study,Library,ProjectStudy'</span><span class="cm">,</span> <span class="q">'Library_Name'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Study__ID=Study_ID AND ProjectStudy.FK_Project__ID=Library.FK_Project__ID AND Library.FK_Project__ID &gt; 0 AND (Study_ID = $study_id OR Study_Name = '$study_id')&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="i">@libs</span><span class="cm">,</span> <span class="i">@proj_libs</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@field_list</span>
        = <span class="q">qw(library original_source_id library_status organism anatomic_site cell_line_name original_source_type strain host library_started library_source library_source_name contact contact_position contact_phone contact_email contact_organization original_contact original_contact_position original_contact_phone original_contact_email original_contact_organization project library_description)</span>
        <span class="sc">;</span>    <span class="c">## &lt;- Default list of fields to retrieve</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$project_ids</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$project_ids</span> =~ <span class="q">/[a-z]+/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Project.Project_Name = '$project_ids'&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.FK_Project__ID IN ($project_ids)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$libraries</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$library_types</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Type IN ($library_types)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$goal_type</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$goal_type</span> = <span class="i">RGTools::Conversion::wildcard_to_SQL</span><span class="s">(</span><span class="i">$goal_type</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library_Goal.Goal_Type LIKE '$goal_type'&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$goals</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'library_goal'</span><span class="cm">,</span> <span class="q">'library_goal_target'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library_Goal.Goal_Name IN ($goals)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$library_analysis_status</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$library_analysis_status</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library_analysis_status</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library_Analysis_Status IN ($library_analysis_status)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>

    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">#if ( $library_type =~ /Sequencing/ ) {</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$library_type</span> =~ <span class="q">/Vector_Based/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'vector'</span><span class="cm">,</span> <span class="q">'direction'</span><span class="cm">,</span> <span class="q">'library_format'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$library_type</span> =~ <span class="q">/RNA_DNA_Collection/</span> <span class="s">)</span> <span class="s">{</span>

    <span class="s">}</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>

        <span class="c">#        -attribute_link       =&gt; &quot;Original_Source.original_source_id&quot;,</span>
        -<span class="w">date_field</span> <span class="cm">=&gt;</span> <span class="q">&quot;Library.Library_Obtained_Date&quot;</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<span class="c"># API to retrieve pipeline information</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#   Example:</span>
<span class="c">#   my $pipeline = &quot;IPE&quot;;</span>
<span class="c">#   my $pipeline_data = $API-&gt;get_pipeline_data(-pipeline_code =&gt; $pipeline);</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c"># Return: hash of data</span>
<span class="c">############################</span>
<a name="get_pipeline_data-"></a><span class="k">sub </span><span class="m">get_pipeline_data</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Include below any arguments that should appear in perldoc + any arguments needing specific attention</span>

    <span class="c">## Specify conditions for data retrieval</span>

    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$pipeline_id</span>      = <span class="i">$args</span>{-<span class="w">pipeline_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_name</span>    = <span class="i">$args</span>{-<span class="w">pipeline_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_code</span>    = <span class="i">$args</span>{-<span class="w">pipeline_code</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_type</span>    = <span class="i">$args</span>{-<span class="w">pipeline_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_group</span>   = <span class="i">$args</span>{-<span class="w">pipeline_group</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_format</span>     = <span class="i">$args</span>{-<span class="w">plate_format</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group_name</span>       = <span class="i">$args</span>{-<span class="w">group_name</span>}<span class="sc">;</span>
    <span class="c">## plate specification options</span>

    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>      <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>    <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">''</span><span class="sc">;</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>

            <span class="c">### Re-Cast arguments as required ###</span>
            <span class="k">my</span> <span class="i">$pipeline_ids</span><span class="sc">;</span>
            <span class="i">$pipeline_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$pipeline_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$pipeline_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_codes</span><span class="sc">;</span>
    <span class="i">$pipeline_codes</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$pipeline_code</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$pipeline_code</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_types</span><span class="sc">;</span>
    <span class="i">$pipeline_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$pipeline_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$pipeline_type</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_groups</span><span class="sc">;</span>
    <span class="i">$pipeline_groups</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$pipeline_group</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$pipeline_group</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_formats</span><span class="sc">;</span>
    <span class="i">$plate_formats</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_format</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_format</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group_names</span><span class="sc">;</span>
    <span class="i">$group_names</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$group_name</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$group_name</span><span class="sc">;</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

    <span class="c">## Initial Framework for query ##</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="q">'Pipeline'</span><span class="sc">;</span>    <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">'WHERE 1'</span><span class="sc">;</span>     <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>            <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">##### DYNAMICALLY JOINED Tables: #####</span>
    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span> <span class="q">'Grp'</span> <span class="cm">=&gt;</span> <span class="q">'Pipeline.FK_Grp__ID = Grp.Grp_ID'</span> <span class="s">}</span><span class="sc">;</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">'Plate_Format'</span>       <span class="cm">=&gt;</span> <span class="q">'Pipeline.FKApplicable_Plate_Format__ID = Plate_Format.Plate_Format_ID'</span><span class="cm">,</span>
        <span class="q">'Pipeline_Group'</span>     <span class="cm">=&gt;</span> <span class="q">'Pipeline.FK_Pipeline_Group__ID = Pipeline_Group.Pipeline_Group_ID'</span><span class="cm">,</span>
        <span class="q">'Pipeline as Parent'</span> <span class="cm">=&gt;</span> <span class="q">'Pipeline.FKParent_Pipeline__ID = Parent.Pipeline_ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>                                    <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## adapt conditions using appropriate aliases as required ##</span>
    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$pipeline_ids</span><span class="s">)</span>    <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Pipeline.Pipeline_ID IN ($pipeline_ids)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$pipeline_name</span><span class="s">)</span>   <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Pipeline.Pipeline_Name LIKE '%$pipeline_name%'&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$pipeline_codes</span><span class="s">)</span>  <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Pipeline.Pipeline_Code IN ($pipeline_codes)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$pipeline_types</span><span class="s">)</span>  <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Pipeline.Pipeline_Type IN ($pipeline_types)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$pipeline_groups</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Pipeline_Group.Pipeline_Group_Name IN ($pipeline_groups)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_formats</span><span class="s">)</span>   <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Format.Plate_Format_Type IN ($plate_formats)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$group_names</span><span class="s">)</span>     <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Grp.Grp_Name IN ($group_names)&quot;</span> <span class="s">)</span> <span class="s">}</span>

    <span class="c"># Ignore inactive pipelines</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Pipeline_Status = 'Active'&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw( pipeline_id pipeline_name pipeline_code pipeline_type pipeline_description pipeline_group plate_format group_name )</span><span class="sc">;</span>    <span class="c">## &lt;- Default list of fields to retrieve</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<span class="c">#</span>
<span class="c">############################</span>
<a name="get_trace_submission_data-"></a><span class="k">sub </span><span class="m">get_trace_submission_data</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Include below any arguments that should appear in perldoc + any arguments needing specific attention</span>

    <span class="c">## Specify conditions for data retrieval</span>

    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$library</span>          = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$analysis_id</span>      = <span class="i">$args</span>{-<span class="w">analysis_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_id</span>        = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_id</span>           = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_alias</span>     = <span class="i">$args</span>{-<span class="w">sample_alias</span>}<span class="sc">;</span>
    <span class="c">## plate specification options</span>

    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                          <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                        <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">''</span><span class="sc">;</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>

            <span class="c">### Re-Cast arguments as required ###</span>
            <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
            <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$analysis_ids</span><span class="sc">;</span>
    <span class="i">$analysis_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$analysis_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$analysis_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_ids</span><span class="sc">;</span>
    <span class="i">$sample_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$sample_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_ids</span><span class="sc">;</span>
    <span class="i">$run_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_aliases</span><span class="sc">;</span>
    <span class="i">$sample_aliases</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_alias</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$sample_alias</span><span class="sc">;</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

    <span class="c">## Initial Framework for query ##</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="q">'Trace_Submission, Submission_Volume,Sample'</span><span class="sc">;</span>                                                                                                 <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">'WHERE Trace_Submission.FK_Submission_Volume__ID = Submission_Volume.Submission_Volume_ID and Trace_Submission.FK_Sample__ID = Sample_ID'</span><span class="sc">;</span>    <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>                                                                                                                                           <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">##### DYNAMICALLY JOINED Tables: #####</span>
    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">'Run_Link'</span>                         <span class="cm">=&gt;</span> <span class="q">'Run_Link.FK_Trace_Submission__ID = Trace_Submission.Trace_Submission_ID'</span><span class="cm">,</span>
        <span class="q">'Metadata_Object as Run_MO'</span>        <span class="cm">=&gt;</span> <span class="q">&quot;Run_MO.Metadata_Object_ID = Run_Link.FKRun_Metadata_Object__ID and Run_MO.Object_Type = 'Run'&quot;</span><span class="cm">,</span>
        <span class="q">'Metadata_Object as Experiment_MO'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Experiment_MO.Metadata_Object_ID = Run_Link.FKExperiment_Metadata_Object__ID and Experiment_MO.Object_Type = 'Experiment'&quot;</span><span class="cm">,</span>
        <span class="q">'Experiment_Link'</span>                  <span class="cm">=&gt;</span> <span class="q">'Experiment_Link.FKExperiment_Metadata_Object__ID = Experiment_MO.Metadata_Object_ID'</span><span class="cm">,</span>
        <span class="q">'Metadata_Object as Sample_MO'</span>     <span class="cm">=&gt;</span> <span class="q">&quot;Sample_MO.Metadata_Object_ID = Experiment_Link.FKSample_Metadata_Object__ID and Sample_MO.Object_Type = 'Sample'&quot;</span><span class="cm">,</span>
        <span class="q">'Metadata_Object as Study_MO'</span>      <span class="cm">=&gt;</span> <span class="q">&quot;Study_MO.Metadata_Object_ID = Experiment_Link.FKStudy_Metadata_Object__ID and Study_MO.Object_Type = 'Study'&quot;</span><span class="cm">,</span>
        <span class="q">'Analysis_Link'</span>                    <span class="cm">=&gt;</span> <span class="q">'Analysis_Link.FKStudy_Metadata_Object__ID = Study_MO.Metadata_Object_ID and Analysis_Link.FKSample_Metadata_Object__ID = Sample_MO.Metadata_Object_ID'</span><span class="cm">,</span>
        <span class="q">'Metadata_Object as Analysis_MO'</span>   <span class="cm">=&gt;</span> <span class="q">&quot;Analysis_MO.Metadata_Object_ID = Analysis_Link.FKAnalysis_Metadata_Object__ID and Analysis_MO.Object_Type = 'Analysis'&quot;</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>    <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## adapt conditions using appropriate aliases as required ##</span>
    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$libraries</span><span class="s">)</span>      <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Sample.FK_Library__Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$analysis_ids</span><span class="s">)</span>   <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Analysis_MO.Unique_Identifier IN ($analysis_ids)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$sample_ids</span><span class="s">)</span>     <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Sample_MO.Unique_Identifier IN ($sample_ids)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$run_ids</span><span class="s">)</span>        <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run_MO.Unique_Identifier IN ($run_ids)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$sample_aliases</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Sample_MO.Alias IN ($sample_aliases)&quot;</span> <span class="s">)</span> <span class="s">}</span>

    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw( trace_submission_id library analysis_unique_id study_unique_id sample_unique_id run_unique_id )</span><span class="sc">;</span>    <span class="c">## &lt;- Default list of fields to retrieve</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># New method to simplify run data extraction (avoids complexity of _generate_query method)</span>
<span class="c"># (this style should replace all of the other API methods as well to simplify maintenance / debugging.</span>
<span class="c">#</span>
<span class="c"># Return: hash of data</span>
<span class="c">#########################</span>
<a name="get_sample_data-"></a><span class="k">sub </span><span class="m">get_sample_data</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span>
        -<span class="w">mandatory</span> <span class="cm">=&gt;</span>
            <span class="q">&quot;condition|study_id|project_id|library|plate_id|plate_number|well|plate_type|plate_class|plate_application|original_plate_id|original_well|applied_plate_id|sample_id|parent_sample_id|library_type|since|until|original_source_id|source_id|original_source_name&quot;</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$study_id</span>         = <span class="i">$args</span>{-<span class="w">study_id</span>}<span class="sc">;</span>            <span class="c">### a study id (a defined set of libraries/projects)</span>
    <span class="k">my</span> <span class="i">$project_id</span>       = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>          <span class="c">### specify project_id</span>
    <span class="k">my</span> <span class="i">$library</span>          = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>             <span class="c">### specify library</span>
    <span class="c">## plate specification options</span>
    <span class="k">my</span> <span class="i">$plate_id</span>             = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                   <span class="c">### specify plate_id</span>
    <span class="k">my</span> <span class="i">$plate_number</span>         = <span class="i">$args</span>{-<span class="w">plate_number</span>}<span class="sc">;</span>               <span class="c">### specify plate number</span>
    <span class="k">my</span> <span class="i">$well</span>                 = <span class="i">$args</span>{-<span class="w">well</span>}<span class="sc">;</span>                       <span class="c">### specify plate number</span>
    <span class="k">my</span> <span class="i">$plate_type</span>           = <span class="i">$args</span>{-<span class="w">plate_type</span>} || <span class="q">''</span><span class="sc">;</span>           <span class="c">### specify type of plate (tube or Library_Plate)</span>
    <span class="k">my</span> <span class="i">$plate_class</span>          = <span class="i">$args</span>{-<span class="w">plate_class</span>} || <span class="q">''</span><span class="sc">;</span>          <span class="c">### specify class of plate (clone or extraction)</span>
    <span class="k">my</span> <span class="i">$plate_application</span>    = <span class="i">$args</span>{-<span class="w">plate_application</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c">### specify application of plate (Sequencing/Mapping/PCR)</span>
    <span class="k">my</span> <span class="i">$original_plate_id</span>    = <span class="i">$args</span>{-<span class="w">original_plate_id</span>}<span class="sc">;</span>          <span class="c">### specify original plate id</span>
    <span class="k">my</span> <span class="i">$original_well</span>        = <span class="i">$args</span>{-<span class="w">original_well</span>}<span class="sc">;</span>              <span class="c">### specify original well</span>
    <span class="k">my</span> <span class="i">$applied_plate_id</span>     = <span class="i">$args</span>{-<span class="w">applied_plate_id</span>}<span class="sc">;</span>           <span class="c">### specify original plate id (including ReArrays)</span>
    <span class="k">my</span> <span class="i">$quadrant</span>             = <span class="i">$args</span>{-<span class="w">quadrant</span>}<span class="sc">;</span>                   <span class="c">### specify quadrant from original plate</span>
    <span class="k">my</span> <span class="i">$sample_id</span>            = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>                  <span class="c">### specify sample_id</span>
    <span class="k">my</span> <span class="i">$parent_sample_id</span>     = <span class="i">$args</span>{-<span class="w">parent_sample_id</span>}<span class="sc">;</span>           <span class="c">### specify FKParent_Sample__ID</span>
    <span class="k">my</span> <span class="i">$library_type</span>         = <span class="i">$args</span>{-<span class="w">library_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_id</span>   = <span class="i">$args</span>{-<span class="w">original_source_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_name</span> = <span class="i">$args</span>{-<span class="w">original_source_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_id</span>            = <span class="i">$args</span>{-<span class="w">source_id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                                     <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                                   <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">'Plate_Created'</span><span class="sc">;</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>
            <span class="c">## Special Conditions ##</span>
            <span class="k">my</span> <span class="i">$attribute</span>   = <span class="i">$args</span>{-<span class="w">attribute</span>}<span class="sc">;</span>                                  <span class="c">### specify an attribute to extract (only one allowed for now)</span>
            <span class="k">my</span> <span class="i">$alias_type</span>  = <span class="i">$args</span>{-<span class="w">alias_type</span>}<span class="sc">;</span>                                 <span class="c">### specify an attribute to extract (only one allowed for now)</span>
            <span class="k">my</span> <span class="i">$alias_value</span> = <span class="i">$args</span>{-<span class="w">alias_value</span>}<span class="sc">;</span>
            <span class="i">$alias_value</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$alias_value</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_type</span> = <span class="i">$args</span>{-<span class="w">sample_type</span>} || <span class="q">'extraction'</span><span class="sc">;</span>

    <span class="c">### Re-Cast arguments if necessary ###</span>
    <span class="k">my</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="i">$libs</span> = <span class="i">$self</span><span class="i">-&gt;get_libraries</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$study_id</span> || <span class="i">$project_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$libs</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span><span class="sc">;</span>
    <span class="i">$plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_numbers</span><span class="sc">;</span>
    <span class="i">$plate_numbers</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_number</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_number</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$wells</span><span class="sc">;</span>
    <span class="i">$wells</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$well</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$well</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$samples</span><span class="sc">;</span>
    <span class="i">$samples</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$sample_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parent_samples</span><span class="sc">;</span>
    <span class="i">$parent_samples</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$parent_sample_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$parent_sample_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_types</span><span class="sc">;</span>
    <span class="i">$library_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library_type</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$original_source_ids</span><span class="sc">;</span>
    <span class="i">$original_source_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$original_source_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$original_source_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_names</span><span class="sc">;</span>
    <span class="i">$original_source_names</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$original_source_name</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$original_source_name</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_ids</span><span class="sc">;</span>
    <span class="i">$source_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$source_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$source_id</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

<span class="c">##########################################</span>
    <span class="c"># Retrieve Record Data from the Database #</span>
<span class="c">##########################################</span>

    <span class="c">## Generate Condition ##</span>
    <span class="k">my</span> <span class="i">$tables</span> = <span class="q">'Sample,Plate_Sample,Plate,Source,Original_Source,Library'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">&quot;WHERE Plate_Sample.FK_Sample__ID=Sample_ID AND Plate_Sample.FKOriginal_Plate__ID=Plate_ID&quot;</span><span class="sc">;</span>
    <span class="i">$join_condition</span> .= <span class="q">&quot; AND Sample.FK_Source__ID=Source.Source_ID AND Source.FK_Original_Source__ID=Original_Source_ID&quot;</span><span class="sc">;</span>
    <span class="i">$join_condition</span> .= <span class="q">&quot; AND Plate.FK_Library__Name=Library_Name&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>    <span class="c">## always included ... Clone_Sample' ;</span>

    <span class="c">## specify optional tables to include (with associated condition) - used in 'include_if_necessary' method ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="q">'Project'</span>          <span class="cm">=&gt;</span> <span class="q">&quot;Project.Project_ID=Library.FK_Project__ID&quot;</span><span class="cm">,</span>
        <span class="q">'Library_Plate'</span>    <span class="cm">=&gt;</span> <span class="q">&quot;Library_Plate.FK_Plate__ID=Plate.Plate_ID&quot;</span><span class="cm">,</span>
        <span class="q">'ConcentrationRun'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Concentrations.FK_ConcentrationRun__ID=ConcentrationRun_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Concentrations'</span>   <span class="cm">=&gt;</span> <span class="q">&quot;Concentrations.FK_Sample__ID=Sample_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Clone_Source'</span>     <span class="cm">=&gt;</span> <span class="q">&quot;Clone_Source.FK_Clone_Sample__ID = Clone_Sample.Clone_Sample_ID&quot;</span><span class="cm">,</span>

        <span class="c">#	'Clone_Sample'   =&gt; &quot;Clone_Sample.FK_Sample__ID=Sample.Sample_ID&quot;,</span>
        <span class="q">'Sample_Attribute'</span> <span class="cm">=&gt;</span> <span class="q">'Sample_Attribute.FK_Sample__ID=Sample_ID'</span><span class="cm">,</span>
        <span class="q">'Attribute'</span>        <span class="cm">=&gt;</span> <span class="q">'Sample_Attribute.FK_Attribute__ID=Attribute.Attribute_ID'</span><span class="cm">,</span>
        <span class="q">'Sample_Alias'</span>     <span class="cm">=&gt;</span> <span class="q">&quot;Sample_Alias.FK_Sample__ID=Sample_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Source_Pool'</span>      <span class="cm">=&gt;</span> <span class="q">&quot;FKChild_Source__ID = FK_Source__ID&quot;</span><span class="cm">,</span>

        <span class="c"># 'Organism'               =&gt; 'Original_Source.FK_Organism__ID = Organism.Organism_ID',</span>
        <span class="q">'Taxonomy'</span> <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Taxonomy__ID = Taxonomy.Taxonomy_ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">'Clone_Sample'</span>       <span class="cm">=&gt;</span> <span class="q">&quot;Clone_Sample.FK_Sample__ID=Sample.Sample_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Extraction_Sample'</span>  <span class="cm">=&gt;</span> <span class="q">&quot;Extraction_Sample.FK_Sample__ID=Sample.Sample_ID&quot;</span><span class="cm">,</span>
        <span class="q">'LibraryApplication'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Library.Library_Name=LibraryApplication.FK_Library__Name&quot;</span><span class="cm">,</span>
        <span class="q">'Primer'</span>             <span class="cm">=&gt;</span> <span class="q">&quot;Primer.Primer_ID=LibraryApplication.Object_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Source as PoolSrc'</span>  <span class="cm">=&gt;</span> <span class="q">&quot;Source_Pool.FKParent_Source__ID = PoolSrc.Source_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Anatomic_Site'</span>      <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Anatomic_Site__ID = Anatomic_Site_ID'</span><span class="cm">,</span>
        <span class="q">'Cell_Line'</span>          <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Cell_Line__ID = Cell_Line_ID'</span><span class="cm">,</span>
        <span class="q">'Pathology'</span>          <span class="cm">=&gt;</span> <span class="q">'Pathology.Pathology_ID = Original_Source.FK_Pathology__ID'</span><span class="cm">,</span>
        <span class="q">'Shipment'</span>           <span class="cm">=&gt;</span> <span class="q">'Source.FK_Shipment__ID = Shipment.Shipment_ID'</span><span class="cm">,</span>
        <span class="q">'Histology'</span>          <span class="cm">=&gt;</span> <span class="q">'Pathology.FK_Histology__ID = Histology.Histology_ID'</span><span class="cm">,</span>
        <span class="q">'Patient'</span>            <span class="cm">=&gt;</span> <span class="q">'Patient.Patient_ID = Original_Source.FK_Patient__ID'</span><span class="cm">,</span>
        <span class="q">'Strain'</span>             <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Strain__ID = Strain.Strain_ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$libraries</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plates</span><span class="s">)</span>              <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_ID IN ($plates)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_numbers</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_Number IN ($plate_numbers)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$wells</span><span class="s">)</span>               <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Sample.Well IN ($wells)&quot;</span> <span class="s">)</span> <span class="s">}</span>                                                                              <span class="c">## &lt;CONSTRUCTION&gt; -should be more flexible (ie well for donwstream plate)</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$samples</span><span class="s">)</span>             <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Sample_ID IN ($samples)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$parent_samples</span><span class="s">)</span>      <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;FKParent_Sample__ID IN ($parent_samples)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$library_types</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;(Vector_Based_Library.Vector_Based_Library_Type IN ($library_types) OR Library_Type IN ($library_types))&quot;</span> <span class="s">)</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$source_ids</span><span class="s">)</span>            <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Source_ID IN ($source_ids)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$original_source_ids</span><span class="s">)</span>   <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Original_Source_ID IN ($original_source_ids)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$original_source_names</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Original_Source_Name IN ($original_source_names)&quot;</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$attribute</span><span class="s">)</span>   <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Attribute.Attribute_Name = '$attribute'&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$alias_type</span><span class="s">)</span>  <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Sample_Alias.Alias_Type = '$alias_type'&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$alias_value</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Sample_Alias.Alias IN ($alias_value)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## Special inclusion / exclusion options ##</span>
    <span class="c">#    if ($since) { push(@extra_conditions,&quot;Plate_Created &gt;= '$since'&quot;) }</span>
    <span class="c">#    if ($until)  { push(@extra_conditions,&quot;Plate_Created &lt;= '$until'&quot;) }</span>

    <span class="c">## actually this is the same logic as get_read_data, but looking at slightly different info ...</span>
    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(library Source_Number Source_ID Original_Source_Name organism anatomic_site cell_line_name original_source_type strain sample_id sample_name library_source library_source_name)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$sample_type</span> =~ <span class="q">/clone/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'original_plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$sample_type</span> =~ <span class="q">/extraction/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'original_extraction_plate_id'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'original_extraction_well'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## add fields if grouping samples ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$group</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'Count(*) as count'</span><span class="cm">,</span> <span class="q">'first_plate_created'</span><span class="cm">,</span> <span class="q">'last_plate_created'</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">else</span>        <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'plate_created'</span> <span class="s">)</span> <span class="s">}</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">&quot;Sample_Alias.Alias AS $alias_type&quot;</span> <span class="s">)</span> <span class="k">unless</span> <span class="s">(</span> !<span class="i">$alias_type</span> || <span class="s">(</span> <span class="k">grep</span> <span class="q">/\b$alias_type\b/</span><span class="cm">,</span> <span class="i">@field_list</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>               <span class="c">## add to fields if not already...</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">&quot;Sample_Attribute.Attribute_Value AS $attribute&quot;</span> <span class="s">)</span> <span class="k">unless</span> <span class="s">(</span> !<span class="i">$attribute</span> || <span class="s">(</span> <span class="k">grep</span> <span class="q">/\b$attribute\b/</span><span class="cm">,</span> <span class="i">@field_list</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## add to fields if not already...</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>

        <span class="c">#        -attribute_link       =&gt; &quot;Sample.sample_id&quot;,</span>
        -<span class="w">date_field</span> <span class="cm">=&gt;</span> <span class="q">&quot;Plate.Plate_Created&quot;</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c"># API To retrieve Source information</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">######################</span>
<a name="get_source_data-"></a><span class="k">sub </span><span class="m">get_source_data</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$source_id</span> = <span class="i">$args</span>{-<span class="w">source_id</span>}<span class="sc">;</span>
    <span class="c">## Source specific</span>
    <span class="k">my</span> <span class="i">$original_source_id</span>   = <span class="i">$args</span>{-<span class="w">original_source_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_name</span> = <span class="i">$args</span>{-<span class="w">original_source_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_joins</span>          = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span>     = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>
    <span class="c">## allow specification of library , project or study ##</span>
    <span class="k">my</span> <span class="i">$library</span>    = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$study_id</span>   = <span class="i">$args</span>{-<span class="w">study_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$project_id</span> = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>
<span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>              = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>          = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>               = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>               = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>                 = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>               = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>               = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>                = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$list_fields</span>         = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tables</span>              = <span class="i">$args</span>{-<span class="w">tables</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$external_identifier</span> = <span class="i">$args</span>{-<span class="w">external_identifier</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_id</span>           = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$patient_identifier</span>  = <span class="i">$args</span>{-<span class="w">patient_identifier</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

<span class="c">##########################################</span>
    <span class="c"># Retrieve Record Data from the Database #</span>
<span class="c">##########################################</span>

    <span class="c">## Generate Condition ##</span>
    <span class="i">$tables</span> = <span class="q">'Source,Original_Source'</span> <span class="k">if</span> !<span class="i">$tables</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">&quot;WHERE Source.FK_Original_Source__ID = Original_Source_ID&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="i">$libs</span> = <span class="i">$self</span><span class="i">-&gt;get_libraries</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$study_id</span> || <span class="i">$project_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$libs</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$samples</span><span class="sc">;</span>
    <span class="i">$samples</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$sample_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$patient_identifiers</span><span class="sc">;</span>
    <span class="i">$patient_identifiers</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$patient_identifier</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$patient_identifier</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_ids</span><span class="sc">;</span>
    <span class="i">$original_source_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$original_source_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$original_source_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_names</span><span class="sc">;</span>
    <span class="i">$original_source_names</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$original_source_name</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$original_source_name</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>    <span class="c">## always included ... Clone_Sample' ;</span>

    <span class="c">## specify optional tables to include (with associated condition) - used in 'include_if_necessary' method ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="q">'Library as R_Parent_Library'</span> <span class="cm">=&gt;</span> <span class="q">'Source_Plate.FK_Library__Name = R_Parent_Library.Library_Name'</span><span class="cm">,</span>
        <span class="q">'Plate as R_Source_Plate'</span>     <span class="cm">=&gt;</span> <span class="q">'Source.FKSource_Plate__ID = Source_Plate.Plate_ID'</span><span class="cm">,</span>
        <span class="q">'Grp as R_Parent_Group'</span>       <span class="cm">=&gt;</span> <span class="q">'R_Parent_Library.FK_Grp__ID = R_Parent_Group.Grp_ID'</span><span class="cm">,</span>

        <span class="c"># 'Organism'               =&gt; 'Original_Source.FK_Organism__ID = Organism.Organism_ID',</span>
        <span class="q">'Taxonomy'</span>                              <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Taxonomy__ID = Taxonomy.Taxonomy_ID'</span><span class="cm">,</span>
        <span class="q">'Nucleic_Acid'</span>                          <span class="cm">=&gt;</span> <span class="q">'Nucleic_Acid.FK_Source__ID=Source_ID'</span><span class="cm">,</span>                                         <span class="c">## only one of the following should be included in any query.  (DO NOT include any fields in these tables as default)</span>
        <span class="q">'Ligation'</span>                              <span class="cm">=&gt;</span> <span class="q">'Ligation.FK_Source__ID=Source_ID'</span><span class="cm">,</span>
        <span class="q">'Xformed_Cells'</span>                         <span class="cm">=&gt;</span> <span class="q">'Xformed_Cells.FK_Source__ID=Source_ID'</span><span class="cm">,</span>
        <span class="q">'Microtiter'</span>                            <span class="cm">=&gt;</span> <span class="q">'Microtiter.FK_Source__ID=Source_ID'</span><span class="cm">,</span>
        <span class="q">'ReArray_Plate'</span>                         <span class="cm">=&gt;</span> <span class="q">'ReArray_Plate.FK_Source__ID=Source_ID'</span><span class="cm">,</span>
        <span class="q">'Contact as Original_Contact'</span>           <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Contact__ID = Original_Contact.Contact_ID'</span><span class="cm">,</span>
        <span class="q">'Organization as Original_Organization'</span> <span class="cm">=&gt;</span> <span class="q">'Original_Contact.FK_Organization__ID=Original_Organization.Organization_ID'</span><span class="cm">,</span>

    <span class="s">}</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">'Library'</span>                      <span class="cm">=&gt;</span> <span class="q">'Library_Source.FK_Library__Name = Library.Library_Name'</span><span class="cm">,</span>
        <span class="q">'Library_Source'</span>               <span class="cm">=&gt;</span> <span class="q">'Library_Source.FK_Source__ID = Source_ID'</span><span class="cm">,</span>
        <span class="q">'Library as Parent_Library'</span>    <span class="cm">=&gt;</span> <span class="q">'Source_Plate.FK_Library__Name = Parent_Library.Library_Name'</span><span class="cm">,</span>
        <span class="q">'Plate as Source_Plate'</span>        <span class="cm">=&gt;</span> <span class="q">'Source.FKSource_Plate__ID = Source_Plate.Plate_ID'</span><span class="cm">,</span>
        <span class="q">'Grp as Parent_Group'</span>          <span class="cm">=&gt;</span> <span class="q">'Parent_Library.FK_Grp__ID = Parent_Group.Grp_ID'</span><span class="cm">,</span>
        <span class="q">'Rack'</span>                         <span class="cm">=&gt;</span> <span class="q">'Source.FK_Rack__ID = Rack_ID'</span><span class="cm">,</span>
        <span class="q">'Equipment'</span>                    <span class="cm">=&gt;</span> <span class="q">'Rack.FK_Equipment__ID=Equipment_ID'</span><span class="cm">,</span>
        <span class="q">'Location'</span>                     <span class="cm">=&gt;</span> <span class="q">'Equipment.FK_Location__ID=Location_ID'</span><span class="cm">,</span>
        <span class="q">'Cell_Line'</span>                    <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Cell_Line__ID = Cell_Line_ID'</span><span class="cm">,</span>
        <span class="q">'Pathology'</span>                    <span class="cm">=&gt;</span> <span class="q">'Pathology.Pathology_ID = Original_Source.FK_Pathology__ID'</span><span class="cm">,</span>
        <span class="q">'Anatomic_Site'</span>                <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Anatomic_Site__ID = Anatomic_Site_ID'</span><span class="cm">,</span>
        <span class="q">'Shipment'</span>                     <span class="cm">=&gt;</span> <span class="q">'Source.FK_Shipment__ID = Shipment.Shipment_ID'</span><span class="cm">,</span>
        <span class="q">'Histology'</span>                    <span class="cm">=&gt;</span> <span class="q">'Pathology.FK_Histology__ID = Histology.Histology_ID'</span><span class="cm">,</span>
        <span class="q">'Xenograft'</span>                    <span class="cm">=&gt;</span> <span class="q">'Xenograft.FK_Source__ID = Source.Source_ID'</span><span class="cm">,</span>
        <span class="q">'Transplant_Method'</span>            <span class="cm">=&gt;</span> <span class="q">'Transplant_Method.Transplant_Method_ID = Xenograft.FK_Transplant_Method__ID'</span><span class="cm">,</span>
        <span class="q">'Patient as Host_Patient'</span>      <span class="cm">=&gt;</span> <span class="q">'Host_Patient.Patient_ID = Xenograft.FKHost_Patient__ID'</span><span class="cm">,</span>
        <span class="q">'Organization as Shipment_Org'</span> <span class="cm">=&gt;</span> <span class="q">'Shipment.FKSupplier_Organization__ID = Shipment_Org.Organization_ID'</span><span class="cm">,</span>
        <span class="q">'Sample'</span>                       <span class="cm">=&gt;</span> <span class="q">'Sample.FK_Source__ID = Source.Source_ID'</span><span class="cm">,</span>
        <span class="q">'Sample_Type'</span><span class="cm">,</span>                 <span class="cm">=&gt;</span> <span class="q">'Sample_Type.Sample_Type_ID = Source.FK_Sample_Type__ID'</span><span class="cm">,</span>
        <span class="q">'Strain'</span>                       <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Strain__ID = Strain.Strain_ID'</span><span class="cm">,</span>
        <span class="q">'Patient'</span><span class="cm">,</span>                     <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Patient__ID = Patient.Patient_ID'</span><span class="cm">,</span>
        <span class="q">'Source_Alert'</span>                 <span class="cm">=&gt;</span> <span class="q">'Source.Source_ID = Source_Alert.FK_Source__ID'</span><span class="cm">,</span>
        <span class="q">'Alert_Reason'</span>                 <span class="cm">=&gt;</span> <span class="q">'Alert_Reason.Alert_Reason_ID = Source_Alert.FK_Alert_Reason__ID'</span><span class="cm">,</span>
        <span class="q">'Source_Pool'</span>                  <span class="cm">=&gt;</span> <span class="q">'Source_Pool.FKChild_Source__ID = Source.Source_ID'</span>                              <span class="c"># it's a child source</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$source_id</span><span class="s">)</span>           <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Source_ID IN ($source_id)&quot;</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$libraries</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$external_identifier</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$external_identifier</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$external_identifier</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$external_identifier</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Source.External_Identifier IN ($external_identifier)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$patient_identifiers</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Patient.Patient_Identifier IN ($patient_identifiers)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$original_source_ids</span><span class="s">)</span>   <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Original_Source_ID IN ($original_source_ids)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$original_source_names</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Original_Source_Name IN ($original_source_names)&quot;</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$samples</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Sample.Sample_ID IN ($samples)&quot;</span> <span class="s">)</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(Source_Number Source_ID Original_Source_Name organism anatomic_site cell_line_name original_source_type strain Source_Status sample_type)</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c"># API to retrieve plate information</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">########################</span>
<a name="get_plate_data-"></a><span class="k">sub </span><span class="m">get_plate_data</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'study_id|project_id|library|plate_id|plate_number|original_plate_id|applied_plate_id|sample_id|run_id|tray_id|rack|since|condition|limit'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$study_id</span>         = <span class="i">$args</span>{-<span class="w">study_id</span>}<span class="sc">;</span>            <span class="c">### a study id (a defined set of libraries/projects)</span>
    <span class="k">my</span> <span class="i">$project_id</span>       = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>          <span class="c">### specify project_id</span>
    <span class="k">my</span> <span class="i">$library</span>          = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>             <span class="c">### specify library</span>
    <span class="c">## plate specification options</span>
    <span class="k">my</span> <span class="i">$plate_id</span>             = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                   <span class="c">### specify plate_id</span>
    <span class="k">my</span> <span class="i">$plate_number</span>         = <span class="i">$args</span>{-<span class="w">plate_number</span>}<span class="sc">;</span>               <span class="c">### specify plate number</span>
    <span class="k">my</span> <span class="i">$well</span>                 = <span class="i">$args</span>{-<span class="w">well</span>}<span class="sc">;</span>                       <span class="c">### specify plate number</span>
    <span class="k">my</span> <span class="i">$plate_type</span>           = <span class="i">$args</span>{-<span class="w">plate_type</span>} || <span class="q">''</span><span class="sc">;</span>           <span class="c">### specify type of plate (tube or Library_Plate)</span>
    <span class="k">my</span> <span class="i">$plate_class</span>          = <span class="i">$args</span>{-<span class="w">plate_class</span>} || <span class="q">''</span><span class="sc">;</span>          <span class="c">### specify class of plate (clone or extraction)</span>
    <span class="k">my</span> <span class="i">$plate_status</span>         = <span class="i">$args</span>{-<span class="w">plate_status</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_application</span>    = <span class="i">$args</span>{-<span class="w">plate_application</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c">### specify application of plate (Sequencing/Mapping/PCR)</span>
    <span class="k">my</span> <span class="i">$plate_format</span>         = <span class="i">$args</span>{-<span class="w">plate_format</span>}<span class="sc">;</span>               <span class="c">### specify plate format (eg 'Glycerol') -only 1..</span>
    <span class="k">my</span> <span class="i">$original_plate_id</span>    = <span class="i">$args</span>{-<span class="w">original_plate_id</span>}<span class="sc">;</span>          <span class="c">### specify original plate id</span>
    <span class="k">my</span> <span class="i">$original_well</span>        = <span class="i">$args</span>{-<span class="w">original_well</span>}<span class="sc">;</span>              <span class="c">### specify original well</span>
    <span class="k">my</span> <span class="i">$applied_plate_id</span>     = <span class="i">$args</span>{-<span class="w">applied_plate_id</span>}<span class="sc">;</span>           <span class="c">### specify original plate id (including ReArrays)</span>
    <span class="k">my</span> <span class="i">$quadrant</span>             = <span class="i">$args</span>{-<span class="w">quadrant</span>}<span class="sc">;</span>                   <span class="c">### specify quadrant from original plate</span>
    <span class="k">my</span> <span class="i">$sample_id</span>            = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>                  <span class="c">### specify sample_id</span>
    <span class="k">my</span> <span class="i">$run_id</span>               = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_type</span>         = <span class="i">$args</span>{-<span class="w">library_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tray_id</span>              = <span class="i">$args</span>{-<span class="w">tray_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rack</span>                 = <span class="i">$args</span>{-<span class="w">rack</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_id</span>   = <span class="i">$args</span>{-<span class="w">original_source_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_name</span> = <span class="i">$args</span>{-<span class="w">original_source_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_id</span>            = <span class="i">$args</span>{-<span class="w">source_id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>      <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>    <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">'Plate_Created'</span><span class="sc">;</span>
            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>     = <span class="i">$args</span>{-<span class="w">fields</span>}     || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span> = <span class="i">$args</span>{-<span class="w">add_fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>      = <span class="i">$args</span>{-<span class="w">order</span>}      || <span class="q">''</span><span class="sc">;</span>

            <span class="c">#my $group      = $args{-group}      || $args{-group_by} || $args{-key} || 'plate_id';</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">group</span>} ? <span class="i">$args</span>{-<span class="w">group</span>} <span class="co">:</span> <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">group_by</span>} ? <span class="i">$args</span>{-<span class="w">group_by</span>} <span class="co">:</span> <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">key</span>} ? <span class="i">$args</span>{-<span class="w">key</span>} <span class="co">:</span> <span class="q">'plate_id'</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                                                                                                    <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                                                                                                          <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                                                                                                    <span class="c">### just generate a list of output fields</span>

            <span class="c">### Re-Cast arguments if necessary ###</span>
            <span class="k">my</span> <span class="i">$libs</span><span class="sc">;</span>
            <span class="i">$libs</span> = <span class="i">$self</span><span class="i">-&gt;get_libraries</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$study_id</span> || <span class="i">$project_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$libs</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span><span class="sc">;</span>
    <span class="i">$plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_numbers</span><span class="sc">;</span>
    <span class="i">$plate_numbers</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_number</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_number</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$racks</span><span class="sc">;</span>
    <span class="i">$racks</span> = <span class="i">extract_range</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$rack</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$rack</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$wells</span><span class="sc">;</span>
    <span class="i">$wells</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$well</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$well</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$samples</span><span class="sc">;</span>
    <span class="i">$samples</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$sample_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_types</span><span class="sc">;</span>
    <span class="i">$library_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library_type</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_classes</span><span class="sc">;</span>
    <span class="i">$plate_classes</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_class</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_class</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quadrants</span><span class="sc">;</span>
    <span class="i">$quadrants</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$quadrant</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$quadrant</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tray_ids</span><span class="sc">;</span>
    <span class="i">$tray_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$tray_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$tray_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_statuses</span><span class="sc">;</span>
    <span class="i">$plate_statuses</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_status</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_status</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_ids</span><span class="sc">;</span>
    <span class="i">$run_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_id</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$original_source_ids</span><span class="sc">;</span>
    <span class="i">$original_source_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$original_source_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$original_source_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_names</span><span class="sc">;</span>
    <span class="i">$original_source_names</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$original_source_name</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$original_source_name</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_ids</span><span class="sc">;</span>
    <span class="i">$source_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$source_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$source_id</span><span class="sc">;</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$tables</span>         = <span class="q">'Plate,Plate_Format,Library'</span><span class="sc">;</span>                                                                         <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">&quot;WHERE Plate.FK_Plate_Format__ID=Plate_Format_ID AND Plate.FK_Library__Name=Library.Library_Name&quot;</span><span class="sc">;</span>    <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>

    <span class="k">my</span> <span class="i">@field_list</span>
        = <span class="q">qw(library plate_id plate_number rack parent_quadrant parent_plate_id original_parent_plate_id project plate_size plate_format plate_created library organism library_started strain anatomic_site cell_line_name original_source_type plate_made_by plate_status sample_type)</span><span class="sc">;</span>
    <span class="c">## &lt;- Default list of fields to retrieve</span>

    <span class="k">my</span> <span class="i">$left_join_tables</span><span class="sc">;</span>                                                                                                      <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>
    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="q">'Library'</span>            <span class="cm">=&gt;</span> <span class="q">&quot;Plate.FK_Library__Name=Library.Library_Name&quot;</span><span class="cm">,</span>
        <span class="q">'Project'</span>            <span class="cm">=&gt;</span> <span class="q">'Library.FK_Project__ID=Project.Project_ID'</span><span class="cm">,</span>
        <span class="q">'Primer'</span>             <span class="cm">=&gt;</span> <span class="q">'LibraryApplication.Object_ID=Primer.Primer_ID'</span><span class="cm">,</span>
        <span class="q">'LibraryApplication'</span> <span class="cm">=&gt;</span> <span class="q">'LibraryApplication.FK_Library__Name=Library.Library_Name'</span><span class="cm">,</span>

        <span class="c">#	'Vector_Based_Library'     =&gt; 'Vector_Based_Library.FK_Library__Name = Library.Library_Name',</span>
        <span class="q">'Vector'</span>             <span class="cm">=&gt;</span> <span class="q">'LibraryVector.FK_Vector__ID = Vector.Vector_ID'</span><span class="cm">,</span>
        <span class="q">'Original_Source'</span>    <span class="cm">=&gt;</span> <span class="q">'Library.FK_Original_Source__ID=Original_Source_ID'</span><span class="cm">,</span>
        <span class="q">'Source'</span>             <span class="cm">=&gt;</span> <span class="q">'Sample.FK_Source__ID=Source_ID'</span><span class="cm">,</span>                                                              <span class="c">## link back through source (nned to group !)</span>
        <span class="q">'Sample'</span>             <span class="cm">=&gt;</span> <span class="q">'Plate_Sample.FK_Sample__ID=Sample.Sample_ID'</span><span class="cm">,</span>
        <span class="q">'Plate_Sample'</span>       <span class="cm">=&gt;</span> <span class="q">'Plate_Sample.FKOriginal_Plate__ID=Plate.Plate_ID'</span><span class="cm">,</span>
        <span class="q">'Clone_Sample'</span>       <span class="cm">=&gt;</span> <span class="q">'Clone_Sample.FK_Sample__ID=Sample.Sample_ID'</span><span class="cm">,</span>
        <span class="q">'Employee as Plater'</span> <span class="cm">=&gt;</span> <span class="q">'Plater.Employee_ID = Plate.FK_Employee__ID'</span><span class="cm">,</span>
        <span class="q">'Rack'</span>               <span class="cm">=&gt;</span> <span class="q">'Plate.FK_Rack__ID = Rack.Rack_ID'</span><span class="cm">,</span>
        <span class="q">'Vector_Type'</span>        <span class="cm">=&gt;</span> <span class="q">'Vector.FK_Vector_Type__ID = Vector_Type.Vector_Type_ID'</span><span class="cm">,</span>

        <span class="c"># 'Organism'               =&gt; 'Original_Source.FK_Organism__ID = Organism.Organism_ID',</span>
        <span class="q">'Taxonomy'</span>   <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Taxonomy__ID = Taxonomy.Taxonomy_ID'</span><span class="cm">,</span>
        <span class="q">'Fail'</span>       <span class="cm">=&gt;</span> <span class="q">'Fail.Object_ID = Plate.Plate_ID'</span><span class="cm">,</span>
        <span class="q">'FailReason'</span> <span class="cm">=&gt;</span> <span class="q">'FailReason.FailReason_ID = Fail.FK_FailReason__ID'</span><span class="cm">,</span>
        <span class="q">'Pipeline'</span>   <span class="cm">=&gt;</span> <span class="q">'Plate.FK_Pipeline__ID=Pipeline.Pipeline_ID'</span><span class="cm">,</span>
        <span class="q">'Equipment'</span>  <span class="cm">=&gt;</span> <span class="q">'Rack.FK_Equipment__ID = Equipment.Equipment_ID'</span><span class="cm">,</span>
        <span class="q">'Location'</span>   <span class="cm">=&gt;</span> <span class="q">'Location.Location_ID=Equipment.FK_Location__ID'</span><span class="cm">,</span>

        <span class="c"># Original contact information #</span>
        <span class="q">'Contact as Original_Contact'</span>           <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Contact__ID = Original_Contact.Contact_ID'</span><span class="cm">,</span>
        <span class="q">'Organization as Original_Organization'</span> <span class="cm">=&gt;</span> <span class="q">'Original_Contact.FK_Organization__ID=Original_Organization.Organization_ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>
    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">'Run'</span>                                  <span class="cm">=&gt;</span> <span class="q">'Run.FK_Plate__ID=Plate_ID'</span><span class="cm">,</span>
        <span class="q">'SequenceRun'</span>                          <span class="cm">=&gt;</span> <span class="q">'SequenceRun.FK_Run __ID=Run.Run_ID'</span><span class="cm">,</span>
        <span class="q">'SequenceAnalysis'</span>                     <span class="cm">=&gt;</span> <span class="q">'SequenceAnalysis.FK_SequenceRun__ID=SequenceRun.SequenceRun_ID'</span><span class="cm">,</span>
        <span class="q">'Stage'</span>                                <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Stage__ID = Stage.Stage_ID'</span><span class="cm">,</span>
        <span class="q">'Branch'</span>                               <span class="cm">=&gt;</span> <span class="q">'Branch.Branch_Code = Plate.FK_Branch__Code'</span><span class="cm">,</span>
        <span class="q">'Sample_Type'</span>                          <span class="cm">=&gt;</span> <span class="q">'Plate.FK_Sample_Type__ID = Sample_Type.Sample_Type_ID'</span><span class="cm">,</span>
        <span class="q">'Vector_Based_Library'</span>                 <span class="cm">=&gt;</span> <span class="q">'Vector_Based_Library.FK_Library__Name = Library.Library_Name'</span><span class="cm">,</span>
        <span class="q">'Work_Request as Library_Work_Request'</span> <span class="cm">=&gt;</span> <span class="q">'Library.Library_Name = Library_Work_Request.FK_Library__Name'</span><span class="cm">,</span>
        <span class="q">'Goal as Library_Goal'</span>                 <span class="cm">=&gt;</span> <span class="q">'Library_Work_Request.FK_Goal__ID = Library_Goal.Goal_ID'</span><span class="cm">,</span>
        <span class="q">'Funding as Library_Funding'</span>           <span class="cm">=&gt;</span> <span class="q">'Library_Work_Request.FK_Funding__ID = Library_Funding.Funding_ID'</span><span class="cm">,</span>
        <span class="q">'Work_Request as Plate_Work_Request'</span>   <span class="cm">=&gt;</span> <span class="q">'Plate.FK_Work_Request__ID = Plate_Work_Request.Work_Request_ID'</span><span class="cm">,</span>
        <span class="q">'Goal as Plate_Goal'</span>                   <span class="cm">=&gt;</span> <span class="q">'Plate_Work_Request.FK_Goal__ID = Plate_Goal.Goal_ID'</span><span class="cm">,</span>
        <span class="q">'Funding as Plate_Funding'</span>             <span class="cm">=&gt;</span> <span class="q">'Plate_Work_Request.FK_Funding__ID = Plate_Funding.Funding_ID'</span><span class="cm">,</span>
        <span class="q">'Anatomic_Site'</span>                        <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Anatomic_Site__ID = Anatomic_Site_ID'</span><span class="cm">,</span>
        <span class="q">'Cell_Line'</span>                            <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Cell_Line__ID = Cell_Line_ID'</span><span class="cm">,</span>
        <span class="q">'Plate_Tray'</span>                           <span class="cm">=&gt;</span> <span class="q">'Plate_Tray.FK_Plate__ID = Plate.Plate_ID'</span><span class="cm">,</span>
        <span class="q">'Strain'</span>                               <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Strain__ID = Strain.Strain_ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_type</span> =~ <span class="q">/(library|96|384)/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$join_conditions</span>-&gt;{<span class="q">'Library_Plate'</span>} = <span class="q">&quot;Library_Plate.FK_Plate__ID=Plate_ID&quot;</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'plate_position'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plate_type</span> =~ <span class="q">/(tube|1)/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$join_conditions</span>-&gt;{<span class="q">'Tube'</span>} = <span class="q">&quot;Tube.FK_Plate__ID=Plate_ID&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="c">## no type supplied - left join ALL plate types - MUCH MORE EFFICIENT to include the plate_type - perhaps it should be mandatory (?)</span>
        <span class="i">$left_join_conditions</span>-&gt;{<span class="q">'Library_Plate'</span>} = <span class="q">&quot;Library_Plate.FK_Plate__ID=Plate_ID&quot;</span><span class="sc">;</span>
        <span class="i">$left_join_conditions</span>-&gt;{<span class="q">'Tube'</span>}          = <span class="q">&quot;Tube.FK_Plate__ID=Plate_ID&quot;</span><span class="sc">;</span>
        <span class="i">$left_join_conditions</span>-&gt;{<span class="q">'Array'</span>}         = <span class="q">&quot;Array.FK_Plate__ID=Plate_ID&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$libraries</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plates</span><span class="s">)</span>              <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_ID IN ($plates)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_classes</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_Class IN ($plate_classes)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_format</span><span class="s">)</span>        <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Format.Plate_Format_Type LIKE '%$plate_format%'&quot;</span> <span class="s">)</span> <span class="s">}</span>    <span class="c">## flexible</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_numbers</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_Number IN ($plate_numbers)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$racks</span><span class="s">)</span>               <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.FK_Rack__ID IN ($racks)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$library_types</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Type IN ($library_types)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$wells</span><span class="s">)</span>               <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Sample.Well IN ($wells)&quot;</span> <span class="s">)</span> <span class="s">}</span>                            <span class="c">## &lt;CONSTRUCTION&gt; -should be more flexible (ie well for donwstream plate)</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$samples</span><span class="s">)</span>             <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Sample.Sample_ID IN ($samples)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$quadrants</span><span class="s">)</span>           <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Parent_Quadrant IN ($quadrants)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$tray_ids</span><span class="s">)</span>            <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Tray.FK_Tray__ID IN ($tray_ids)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_statuses</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_Status IN ($plate_statuses)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$run_ids</span><span class="s">)</span>        <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Run_ID IN ($run_ids)&quot;</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$original_source_ids</span><span class="s">)</span>   <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Original_Source.Original_Source_ID IN ($original_source_ids)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$source_ids</span><span class="s">)</span>            <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Source.Source_ID IN ($source_ids)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$original_source_names</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Original_Source.Original_Source_Name IN ($original_source_names)&quot;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span> <span class="k">if</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="q">'1'</span><span class="sc">;</span>
    <span class="c">## Special inclusion / exclusion options ##</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>

        <span class="c">#        -attribute_link       =&gt; [&quot;Plate.plate_id&quot;,&quot;Library.library&quot;],</span>
        -<span class="w">date_field</span> <span class="cm">=&gt;</span> <span class="q">&quot;Plate.Plate_Created&quot;</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################################################</span>
<span class="c">#</span>
<span class="c"># Wrapper for get_plate_data specific to rearrays</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">##########################</span>
<a name="get_rearray_data-"></a><span class="k">sub </span><span class="m">get_rearray_data</span> <span class="s">{</span>
<span class="c">##########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>                = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_plate_id</span>     = <span class="i">$args</span>{-<span class="w">source_plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_library</span>      = <span class="i">$args</span>{-<span class="w">source_library</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_plate_number</span> = <span class="i">$args</span>{-<span class="w">source_plate_number</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$target_plate_id</span>     = <span class="i">$args</span>{-<span class="w">target_plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$target_library</span>      = <span class="i">$args</span>{-<span class="w">target_library</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$target_plate_number</span> = <span class="i">$args</span>{-<span class="w">target_plate_number</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_well</span>         = <span class="i">$args</span>{-<span class="w">source_well</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$target_well</span>         = <span class="i">$args</span>{-<span class="w">target_well</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rearray_request_id</span>  = <span class="i">$args</span>{-<span class="w">rearray_request_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rearray_status</span>      = <span class="i">$args</span>{-<span class="w">rearray_status</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$solution_id</span>         = <span class="i">$args</span>{-<span class="w">solution_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$primer_plate_name</span>   = <span class="i">$args</span>{-<span class="w">primer_plate_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_id</span>           = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_name</span>         = <span class="i">$args</span>{-<span class="w">sample_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rearray_type</span>        = <span class="i">$args</span>{-<span class="w">rearray_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$primer_name</span>         = <span class="i">$args</span>{-<span class="w">primer_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$condition</span>           = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@add_fields</span><span class="sc">;</span>
    <span class="i">@add_fields</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>

    <span class="c"># build argument list and queries for get_plate_data</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$target_plate_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$args</span>{-<span class="w">plate_id</span>} = <span class="i">$target_plate_id</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$target_library</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$args</span>{-<span class="w">library</span>} = <span class="i">$target_library</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$target_plate_number</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$args</span>{-<span class="w">plate_number</span>} = <span class="i">$target_plate_number</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@conditions</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$condition</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="i">$condition</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$rearray_request_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;ReArray_Request.ReArray_Request_ID = $rearray_request_id &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$rearray_status</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Status.Status_Name = '$rearray_status' &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$source_plate_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;ReArray.FKSource_Plate__ID = $source_plate_id &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$source_library</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Source_Plate.FK_Library__Name = '$source_library' &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$source_plate_number</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Source_Plate.Plate_Number in ($source_plate_number) &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$source_well</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;ReArray.Source_Well in (&quot;</span> . <span class="i">&amp;autoquote_string</span><span class="s">(</span><span class="i">$source_well</span><span class="s">)</span> . <span class="q">&quot;) &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$target_well</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;ReArray.Target_Well in (&quot;</span> . <span class="i">&amp;autoquote_string</span><span class="s">(</span><span class="i">$target_well</span><span class="s">)</span> . <span class="q">&quot;) &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$rearray_type</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;ReArray_Request.ReArray_Type = '$rearray_type' &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$primer_name</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Primer.Primer_Name LIKE '$primer_name' &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$solution_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Primer_Plate.FK_Solution__ID = $solution_id &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$primer_plate_name</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Primer_Plate.Primer_Plate_Name = '$primer_plate_name' &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$sample_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@samples</span> = <span class="k">split</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$sample_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Sample.Sample_ID in (@samples)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$sample_name</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Sample.Sample_Name in (&quot;</span> . <span class="i">&amp;autoquote_string</span><span class="s">(</span><span class="i">$sample_name</span><span class="s">)</span> . <span class="q">&quot;) &quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$input_joins</span> = <span class="s">{</span>
        <span class="q">'ReArray_Request'</span>       <span class="cm">=&gt;</span> <span class="q">'ReArray_Request.FKTarget_Plate__ID=Plate.Plate_ID'</span><span class="cm">,</span>
        <span class="q">'Plate as Source_Plate'</span> <span class="cm">=&gt;</span> <span class="q">'ReArray.FKSource_Plate__ID=Source_Plate.Plate_ID'</span><span class="cm">,</span>
        <span class="q">'ReArray'</span>               <span class="cm">=&gt;</span> <span class="q">'ReArray.FK_ReArray_Request__ID=ReArray_Request.ReArray_Request_ID'</span><span class="cm">,</span>
        <span class="q">'Sample'</span>                <span class="cm">=&gt;</span> <span class="q">'ReArray.FK_Sample__ID=Sample.Sample_ID'</span><span class="cm">,</span>
        <span class="q">'Plate_Sample'</span>          <span class="cm">=&gt;</span> <span class="q">'Plate_Sample.FKOriginal_Plate__ID=Plate.Plate_ID AND Plate_Sample.Well=ReArray.Target_Well'</span><span class="cm">,</span>
        <span class="q">'Plate_PrimerPlateWell'</span> <span class="cm">=&gt;</span> <span class="q">'Plate_PrimerPlateWell.FK_Plate__ID=ReArray_Request.FKTarget_Plate__ID AND ReArray.Target_Well=Plate_PrimerPlateWell.Plate_Well'</span><span class="cm">,</span>
        <span class="q">'Primer_Plate_Well'</span>     <span class="cm">=&gt;</span> <span class="q">'Plate_PrimerPlateWell.FK_Primer_Plate_Well__ID=Primer_Plate_Well.Primer_Plate_Well_ID'</span><span class="cm">,</span>
        <span class="q">'Primer_Plate'</span>          <span class="cm">=&gt;</span> <span class="q">'Primer_Plate.Primer_Plate_ID=Primer_Plate_Well.FK_Primer_Plate__ID'</span><span class="cm">,</span>
        <span class="q">'Primer'</span>                <span class="cm">=&gt;</span> <span class="q">'Primer.Primer_Name=Primer_Plate_Well.FK_Primer__Name'</span><span class="cm">,</span>
        <span class="q">'Status'</span>                <span class="cm">=&gt;</span> <span class="q">'ReArray_Request.FK_Status__ID=Status.Status_ID'</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="k">push</span><span class="s">(</span> <span class="i">@add_fields</span><span class="cm">,</span> <span class="q">'rearray_request_id'</span><span class="cm">,</span> <span class="q">'rearray_date'</span><span class="cm">,</span> <span class="q">'target_well'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">@conditions</span><span class="s">)</span> <span class="s">{</span> <span class="i">$args</span>{-<span class="w">condition</span>} = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@conditions</span> <span class="s">}</span>

    <span class="i">$args</span>{-<span class="w">input_joins</span>} = <span class="i">$input_joins</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">add_fields</span>}  = \<span class="i">@add_fields</span><span class="sc">;</span>

    <span class="c">#    $args{-plate_type} = 'library';  ## &lt;CONSTRUCTION&gt; - is this always the case ?</span>
    <span class="k">my</span> <span class="i">$group</span> = <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">group</span>} ? <span class="i">$args</span>{-<span class="w">group</span>} <span class="co">:</span> <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">group_by</span>} ? <span class="i">$args</span>{-<span class="w">group_by</span>} <span class="co">:</span> <span class="k">defined</span> <span class="i">$args</span>{-<span class="w">key</span>} ? <span class="i">$args</span>{-<span class="w">key</span>} <span class="co">:</span> <span class="q">''</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_plate_data</span><span class="s">(</span> <span class="i">%args</span><span class="cm">,</span> -<span class="w">group</span> <span class="cm">=&gt;</span> <span class="i">$group</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># New method to simplify run data extraction (avoids complexity of _generate_query method)</span>
<span class="c"># (this style should replace all of the other API methods as well to simplify maintenance / debugging.</span>
<span class="c">#</span>
<span class="c"># Return: hash of data</span>
<span class="c">#####################</span>
<a name="get_run_data-"></a><span class="k">sub </span><span class="m">get_run_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">&quot;study_id|project_id|library|run_id|run_name|plate_id|sample_id|pipeline|since|limit|include&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$study_id</span>   = <span class="i">$args</span>{-<span class="w">study_id</span>}<span class="sc">;</span>      <span class="c">### a study id (a defined set of libraries/projects)</span>
    <span class="k">my</span> <span class="i">$project_id</span> = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>    <span class="c">### specify project_id</span>
    <span class="k">my</span> <span class="i">$library</span>    = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>       <span class="c">### specify library</span>
    <span class="c">## run specification options</span>
    <span class="k">my</span> <span class="i">$run_id</span>         = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>            <span class="c">### specify run id</span>
    <span class="k">my</span> <span class="i">$run_name</span>       = <span class="i">$args</span>{-<span class="w">run_name</span>}<span class="sc">;</span>          <span class="c">### specify run name (must be exact format)</span>
    <span class="k">my</span> <span class="i">$exclude_run_id</span> = <span class="i">$args</span>{-<span class="w">exclude_run_id</span>}<span class="sc">;</span>    <span class="c">### specify run id to EXCLUDE (for Run or Read scope)</span>
    <span class="k">my</span> <span class="i">$equipment</span>      = <span class="i">$args</span>{-<span class="w">equipment</span>}<span class="sc">;</span>
    <span class="c">## plate specification options</span>
    <span class="k">my</span> <span class="i">$plate_id</span>                = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                   <span class="c">### specify plate_id</span>
    <span class="k">my</span> <span class="i">$plate_number</span>            = <span class="i">$args</span>{-<span class="w">plate_number</span>}<span class="sc">;</span>               <span class="c">### specify plate number</span>
    <span class="k">my</span> <span class="i">$plate_type</span>              = <span class="i">$args</span>{-<span class="w">plate_type</span>} || <span class="q">''</span><span class="sc">;</span>           <span class="c">### specify type of plate (tube or Library_Plate)</span>
    <span class="k">my</span> <span class="i">$plate_class</span>             = <span class="i">$args</span>{-<span class="w">plate_class</span>} || <span class="q">''</span><span class="sc">;</span>          <span class="c">### specify class of plate (clone or extraction)</span>
    <span class="k">my</span> <span class="i">$plate_application</span>       = <span class="i">$args</span>{-<span class="w">plate_application</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c">### specify application of plate (Sequencing/Mapping/PCR)</span>
    <span class="k">my</span> <span class="i">$original_plate_id</span>       = <span class="i">$args</span>{-<span class="w">original_plate_id</span>}<span class="sc">;</span>          <span class="c">### specify original plate id</span>
    <span class="k">my</span> <span class="i">$original_well</span>           = <span class="i">$args</span>{-<span class="w">original_well</span>}<span class="sc">;</span>              <span class="c">### specify original well</span>
    <span class="k">my</span> <span class="i">$applied_plate_id</span>        = <span class="i">$args</span>{-<span class="w">applied_plate_id</span>}<span class="sc">;</span>           <span class="c">### specify original plate id (including ReArrays)</span>
    <span class="k">my</span> <span class="i">$quadrant</span>                = <span class="i">$args</span>{-<span class="w">quadrant</span>}<span class="sc">;</span>                   <span class="c">### specify quadrant from original plate</span>
    <span class="k">my</span> <span class="i">$sample_id</span>               = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>                  <span class="c">### specify sample_id</span>
    <span class="k">my</span> <span class="i">$pipeline</span>                = <span class="i">$args</span>{-<span class="w">pipeline</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$branch</span>                  = <span class="i">$args</span>{-<span class="w">branch</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_validation</span>          = <span class="i">$args</span>{-<span class="w">run_validation</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_qc_status</span>           = <span class="i">$args</span>{-<span class="w">run_qc_status</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_status</span>              = <span class="i">$args</span>{-<span class="w">run_status</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$multiplex_adapter_index</span> = <span class="i">$args</span>{-<span class="w">multiplex_adapter_index</span>}<span class="sc">;</span>

    <span class="c">## advanced options</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="i">$args</span>{-<span class="w">tables</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_type</span>     = <span class="i">$args</span>{-<span class="w">library_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>
    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>      <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>    <span class="c">### specify date to stop search (context dependent)</span>

            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">'Run_DateTime'</span><span class="sc">;</span>

            <span class="k">my</span> <span class="i">$include</span> = <span class="i">$args</span>{-<span class="w">include</span>} || <span class="n">0</span><span class="sc">;</span>    <span class="c">### data to include (production,approved,billable,pending,analyzed) - 'AND' joined.</span>
            <span class="k">my</span> <span class="i">$exclude</span> = <span class="i">$args</span>{-<span class="w">exclude</span>} || <span class="n">0</span><span class="sc">;</span>    <span class="c">### OR specify data to exclude (eg. failed)</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>} || <span class="q">'run_id'</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>                                                    <span class="c"># || $group;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                            <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                                  <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>                                                   <span class="c">### save query results in hash for easy retrieval</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                            <span class="c">### just generate a list of output fields</span>
            <span class="k">my</span> <span class="i">$debug</span>       = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$key_hash</span>    = <span class="i">$args</span>{-<span class="w">key_hash</span>}<span class="sc">;</span>
            <span class="c">### Re-Cast arguments if necessary ###</span>
            <span class="c">#    my $study_ids ; $study_ids = Cast_List(-list=&gt;$study_id,-to=&gt;'string') if $study_id;</span>
            <span class="c">#    my $project_ids ; $project_ids = Cast_List(-list=&gt;$project_id,-to=&gt;'string') if $project_id;</span>

            <span class="k">my</span> <span class="i">$libs</span><span class="sc">;</span>
            <span class="i">$libs</span> = <span class="i">$self</span><span class="i">-&gt;get_libraries</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$study_id</span> || <span class="i">$project_id</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$libs</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$libs</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plates</span><span class="sc">;</span>
    <span class="i">$plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_numbers</span><span class="sc">;</span>
    <span class="i">$plate_numbers</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_number</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_number</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$runs</span><span class="sc">;</span>
    <span class="i">$runs</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_names</span><span class="sc">;</span>
    <span class="i">$run_names</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_name</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_name</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$equipments</span><span class="sc">;</span>
    <span class="i">$equipments</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$equipment</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$samples</span><span class="sc">;</span>
    <span class="i">$samples</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$sample_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_types</span><span class="sc">;</span>
    <span class="i">$library_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library_type</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipelines</span><span class="sc">;</span>
    <span class="i">$pipelines</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$pipeline</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$pipeline</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$branches</span><span class="sc">;</span>
    <span class="i">$branches</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$branch</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$branch</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quadrants</span><span class="sc">;</span>
    <span class="i">$quadrants</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$quadrant</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$branch</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_validations</span><span class="sc">;</span>
    <span class="i">$run_validations</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_validation</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_validation</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_qc_statuses</span><span class="sc">;</span>
    <span class="i">$run_qc_statuses</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_qc_status</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_qc_status</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_statuses</span><span class="sc">;</span>
    <span class="i">$run_statuses</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_status</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_status</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$multiplex_adapter_indices</span><span class="sc">;</span>
    <span class="i">$multiplex_adapter_indices</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$multiplex_adapter_index</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$multiplex_adapter_index</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>
<span class="c">##########################################</span>
    <span class="c"># Retrieve Record Data from the Database #</span>
<span class="c">##########################################</span>

    <span class="c">## Generate Condition ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE 1'</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$tables</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## normally the tables parameter will NOT be passed (if it is conditions should be also passed if required) ##</span>
        <span class="i">$tables</span> = <span class="q">'Run,RunBatch,Plate,Library'</span><span class="sc">;</span>
        <span class="i">$join_condition</span> .= <span class="q">&quot; AND Run.FK_Plate__ID = Plate.Plate_ID&quot;</span><span class="sc">;</span>
        <span class="i">$join_condition</span> .= <span class="q">&quot; AND Plate.FK_Library__Name = Library.Library_Name&quot;</span><span class="sc">;</span>
        <span class="i">$join_condition</span> .= <span class="q">&quot; AND Run.FK_RunBatch__ID = RunBatch.RunBatch_ID&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="q">'RunBatch'</span>           <span class="cm">=&gt;</span> <span class="q">&quot;Run.FK_RunBatch__ID = RunBatch.RunBatch_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Equipment'</span>          <span class="cm">=&gt;</span> <span class="q">&quot;RunBatch.FK_Equipment__ID = Equipment.Equipment_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Equipment_Category'</span> <span class="cm">=&gt;</span> <span class="q">'Stock_Catalog.FK_Equipment_Category__ID=Equipment_Category.Equipment_Category_ID'</span><span class="cm">,</span>
        <span class="q">'Stock'</span>              <span class="cm">=&gt;</span> <span class="q">'Equipment.FK_Stock__ID=Stock.Stock_ID'</span><span class="cm">,</span>
        <span class="q">'Stock_Catalog'</span>      <span class="cm">=&gt;</span> <span class="q">'Stock.FK_Stock_Catalog__ID=Stock_Catalog.Stock_Catalog_ID'</span><span class="cm">,</span>

        <span class="c">#	'Vector_Based_Library' =&gt; &quot;Vector_Based_Library.FK_Library__Name=Library.Library_Name&quot;,</span>
        <span class="q">'Library_Plate'</span>    <span class="cm">=&gt;</span> <span class="q">&quot;Library_Plate.FK_Plate__ID=Plate.Plate_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Branch'</span>           <span class="cm">=&gt;</span> <span class="q">&quot;Plate.FK_Branch__Code = Branch.Branch_Code&quot;</span><span class="cm">,</span>
        <span class="q">'Branch_Condition'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Branch.Branch_Code = Branch_Condition.FK_Branch__Code&quot;</span><span class="cm">,</span>
        <span class="q">'Object_Class'</span>     <span class="cm">=&gt;</span> <span class="q">&quot;Object_Class.Object_Class_ID = Branch_Condition.FK_Object_Class__ID&quot;</span><span class="cm">,</span>

        <span class="c">#'Primer'             =&gt; &quot;Chemistry_Code.FK_Primer__Name=Primer.Primer_Name&quot;,</span>
        <span class="q">'Clone_Sequence'</span>   <span class="cm">=&gt;</span> <span class="q">&quot;Clone_Sequence.FK_Run__ID=Run.Run_ID&quot;</span><span class="cm">,</span>
        <span class="q">'SequenceAnalysis'</span> <span class="cm">=&gt;</span> <span class="q">&quot;SequenceAnalysis.FK_SequenceRun__ID=SequenceRun.SequenceRun_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Project'</span>          <span class="cm">=&gt;</span> <span class="q">&quot;Library.FK_Project__ID=Project.Project_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Original_Source'</span>  <span class="cm">=&gt;</span> <span class="q">&quot;Library.FK_Original_Source__ID=Original_Source_ID&quot;</span><span class="cm">,</span>

        <span class="c"># 'Organism'           =&gt; &quot;Original_Source.FK_Organism__ID=Organism_ID&quot;,</span>
        <span class="q">'Taxonomy'</span>                 <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Taxonomy__ID = Taxonomy.Taxonomy_ID'</span><span class="cm">,</span>
        <span class="q">'Employee as Sequenced_by'</span> <span class="cm">=&gt;</span> <span class="q">&quot;RunBatch.FK_Employee__ID = Sequenced_by.Employee_ID&quot;</span><span class="cm">,</span>
        <span class="c">## the following should be standard joins even though they may not be required (faster)...</span>
   <span class="c">#	'Primer' =&gt; &quot;Primer.Primer_Name=Chemistry_Code.FK_Primer__Name&quot;,  ## ALSO should link via LibraryPrimer tables, but problem if logic moved here.. (?) - Custom Primer details should be handled below (add custom_primer, custom_primer_sequence if req'd)</span>
        <span class="q">'Primer'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Primer.Primer_ID = Branch_Condition.Object_ID AND Object_Class.Object_Class='Primer'&quot;</span>
        <span class="cm">,</span>    <span class="c">## ALSO should link via LibraryPrimer tables, but problem if logic moved here.. (?) - Custom Primer details should be handled below (add custom_primer, custom_primer_sequence if req'd)</span>

        <span class="c">#	'Primer as Custom_Primer' =&gt; &quot;Custom_Primer.Primer_Name=Primer_Plate_Well.FK_Primer__Name&quot;,</span>
        <span class="q">'Primer as Custom_Primer'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Custom_Primer.Primer_Name=Primer_Plate_Well.FK_Primer__Name&quot;</span><span class="cm">,</span>
        <span class="q">'Primer_Plate_Well'</span>       <span class="cm">=&gt;</span> <span class="q">&quot;Plate_PrimerPlateWell.FK_Primer_Plate_Well__ID=Primer_Plate_Well.Primer_Plate_Well_ID AND Clone_Sequence.Well = Plate_PrimerPlateWell.Plate_Well&quot;</span><span class="cm">,</span>
        <span class="q">'Plate_PrimerPlateWell'</span>   <span class="cm">=&gt;</span> <span class="q">&quot;Plate_PrimerPlateWell.FK_Plate__ID=Plate.FKOriginal_Plate__ID&quot;</span><span class="cm">,</span>
        <span class="q">'SequenceRun'</span>             <span class="cm">=&gt;</span> <span class="q">'SequenceRun.FK_Run__ID=Run_ID'</span><span class="cm">,</span>
        <span class="q">'Pipeline'</span>                <span class="cm">=&gt;</span> <span class="q">'Pipeline.Pipeline_ID = Plate.FK_Pipeline__ID'</span><span class="cm">,</span>
        <span class="q">'Plate_Format'</span>            <span class="cm">=&gt;</span> <span class="q">'Plate_Format_ID=Plate.FK_Plate_Format__ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>

        <span class="c">#	'Primer as Custom_Primer' =&gt; &quot;Custom_Primer.Primer_Name=Primer_Plate_Well.FK_Primer__Name&quot;,</span>
        <span class="q">'LibraryApplication'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Library.Library_Name=LibraryApplication.FK_Library__Name AND Primer.Primer_ID=LibraryApplication.Object_ID&quot;</span><span class="cm">,</span>

        <span class="c">#	'Primer_Plate_Well' =&gt; &quot;Plate_PrimerPlateWell.FK_Primer_Plate_Well__ID=Primer_Plate_Well.Primer_Plate_Well_ID&quot;,</span>
        <span class="c">#	'Plate_PrimerPlateWell' =&gt; &quot;Plate_PrimerPlateWell.FK_Plate__ID=Plate.FKOriginal_Plate__ID&quot;,</span>
        <span class="q">'Branch'</span>               <span class="cm">=&gt;</span> <span class="q">'Plate.FK_Branch__Code = Branch.Branch_Code'</span><span class="cm">,</span>
        <span class="q">'Vector_Based_Library'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Vector_Based_Library.FK_Library__Name=Library.Library_Name&quot;</span><span class="cm">,</span>
        <span class="q">'Anatomic_Site'</span>        <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Anatomic_Site__ID = Anatomic_Site_ID'</span><span class="cm">,</span>
        <span class="q">'Cell_Line'</span>            <span class="cm">=&gt;</span> <span class="q">'Original_Source.FK_Cell_Line__ID = Cell_Line_ID'</span><span class="cm">,</span>
        <span class="q">'Pathology'</span>            <span class="cm">=&gt;</span> <span class="q">'Pathology.Pathology_ID = Original_Source.FK_Pathology__ID'</span><span class="cm">,</span>
        <span class="q">'Genome'</span>               <span class="cm">=&gt;</span> <span class="q">'FK_Genome__ID=Genome_ID'</span><span class="cm">,</span>

        <span class="c">#	'Histology'          =&gt; 'Pathology.FK_Histology__ID = Histology.Histology_ID',</span>
        <span class="q">'Run_Analysis'</span>                        <span class="cm">=&gt;</span> <span class="q">'Run_Analysis.FK_Run__ID=Run.Run_ID'</span><span class="cm">,</span>
        <span class="q">'Run_QC_Alert'</span>                        <span class="cm">=&gt;</span> <span class="q">'Run_QC_Alert.FK_Run__ID = Run.Run_ID'</span><span class="cm">,</span>
        <span class="q">'Multiplex_Run_Analysis'</span>              <span class="cm">=&gt;</span> <span class="q">'Multiplex_Run_Analysis.FK_Run_Analysis__ID=Run_Analysis.Run_Analysis_ID'</span><span class="cm">,</span>
        <span class="q">'Multiplex_Run'</span>                       <span class="cm">=&gt;</span> <span class="q">'Multiplex_Run.FK_Run__ID = Run.Run_ID'</span><span class="cm">,</span>
        <span class="q">'Multiplex_Run_QC_Alert'</span>              <span class="cm">=&gt;</span> <span class="q">'Multiplex_Run_QC_Alert.FK_Multiplex_Run__ID = Multiplex_Run_ID'</span><span class="cm">,</span>
        <span class="q">'Alert_Reason as Multiplex_Run_Alert'</span> <span class="cm">=&gt;</span> <span class="q">'Multiplex_Run_Alert.Alert_Reason_ID = Multiplex_Run_QC_Alert.FK_Alert_Reason__ID'</span><span class="cm">,</span>
        <span class="q">'Alert_Reason as Run_Alert'</span>           <span class="cm">=&gt;</span> <span class="q">'Run_Alert.Alert_Reason_ID = Run_QC_Alert.FK_Alert_Reason__ID'</span><span class="cm">,</span>
        <span class="q">'Sample'</span>                              <span class="cm">=&gt;</span> <span class="q">'Multiplex_Run_Analysis.FK_Sample__ID=Sample.Sample_ID'</span><span class="cm">,</span>
        <span class="q">'Source'</span>                              <span class="cm">=&gt;</span> <span class="q">'Source.Source_ID=Sample.FK_Source__ID'</span><span class="cm">,</span>
        <span class="q">'Work_Request as Plate_Work_Request'</span>  <span class="cm">=&gt;</span> <span class="q">'Plate_Work_Request.Work_Request_ID = Plate.FK_Work_Request__ID'</span><span class="cm">,</span>
        <span class="q">'Funding as Plate_Funding'</span>            <span class="cm">=&gt;</span> <span class="q">'Plate_Work_Request.FK_Funding__ID = Plate_Funding.Funding_ID'</span><span class="cm">,</span>
        <span class="q">'LibraryVector'</span>                       <span class="cm">=&gt;</span> <span class="q">'LibraryVector.FK_Library__Name = Library.Library_Name'</span><span class="cm">,</span>
        <span class="q">'Vector'</span>                              <span class="cm">=&gt;</span> <span class="q">'LibraryVector.FK_Vector__ID = Vector.Vector_ID'</span><span class="cm">,</span>
        <span class="q">'Vector_Type'</span>                         <span class="cm">=&gt;</span> <span class="q">'Vector.FK_Vector_Type__ID = Vector_Type.Vector_Type_ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$libraries</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plates</span><span class="s">)</span>              <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_ID IN ($plates)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_numbers</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_Number IN ($plate_numbers)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$runs</span><span class="s">)</span>                <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Run_ID IN ($runs)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$equipments</span><span class="s">)</span>          <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Equipment.Equipment_ID IN ($equipments)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$samples</span><span class="s">)</span>             <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Clone_Sequence.FK_Sample__ID IN ($samples)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$library_types</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;(Vector_Based_Library.Vector_Based_Library_Type IN ($library_types) OR Library_Type IN ($library_types))&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$exclude_run_id</span><span class="s">)</span>      <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Run_ID NOT IN ($exclude_run_id)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$branches</span><span class="s">)</span>                  <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.FK_Branch__Code IN ($branches)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$pipelines</span><span class="s">)</span>                 <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.FK_Pipeline__ID IN ($pipelines)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$quadrants</span><span class="s">)</span>                 <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Parent_Quadrant IN ($quadrants)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$run_validations</span><span class="s">)</span>           <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Run_Validation IN ($run_validations)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$run_qc_statuses</span><span class="s">)</span>           <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.QC_Status IN ($run_qc_statuses)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$run_statuses</span><span class="s">)</span>              <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Run_Status IN ($run_statuses)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$multiplex_adapter_indices</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Multiplex_Run.Adapter_Index IN ($multiplex_adapter_indices)&quot;</span> <span class="s">}</span>
    <span class="c">## Include runs (ie Approved / Production / Billable ##</span>
    <span class="k">my</span> <span class="i">$run_test_status_condition</span> = <span class="i">include_condition</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'Run_Test_Status'</span><span class="cm">,</span> -<span class="w">available_values</span> <span class="cm">=&gt;</span> <span class="q">&quot;Production|Test&quot;</span><span class="cm">,</span> -<span class="w">include</span> <span class="cm">=&gt;</span> <span class="i">$include</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$run_test_status_condition</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="i">$run_test_status_condition</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$include</span> =~ <span class="q">/\bApproved\b/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run_Validation = 'Approved'&quot;</span> <span class="s">)</span> <span class="s">}</span>

    <span class="c">#if ( $include =~ /\bProduction\b/i ) { push( @extra_conditions, &quot;Run_Test_Status = 'Production'&quot; ) }</span>
    <span class="c">#if ( $include =~ /\bTest\b/i )       { push( @extra_conditions, &quot;Run_Test_Status = 'Test'&quot; ) }</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$include</span> =~ <span class="q">/\bBillable\b/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Billable = 'Yes'&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$include</span> =~ <span class="q">/\bPending\b/i</span> <span class="s">)</span>  <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run_Status IN ('Initiated','Data Acquired','In Process')&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$include</span> =~ <span class="q">/\bAnalyzed\b/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run_Status = 'Analyzed'&quot;</span> <span class="s">}</span>

    <span class="c">## &lt;CONSTRUCTION&gt; - is this to be a standard or custom specification ?</span>
    <span class="k">if</span>    <span class="s">(</span> <span class="i">$include</span> =~ <span class="q">/\bExternal\b/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.FK_Branch__Code LIKE 'EXT'&quot;</span> <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$include</span> =~ <span class="q">/\bInternal\b/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.FK_Branch__Code NOT LIKE 'EXT'&quot;</span> <span class="s">}</span>

    <span class="c">## Retrieve list of applicable Experiments / Runs ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>
    <span class="c">## Special inclusion / exclusion options ##</span>

    <span class="c">## &lt;CONSTRUCTION&gt;  Separate out Sequence Run fields and put in Sequencing_API with different default fields</span>
    <span class="c">## actually this is the same logic as get_read_data, but looking at slightly different info ...</span>
    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span> <span class="q">'library'</span><span class="cm">,</span> <span class="q">'data_path'</span><span class="cm">,</span> <span class="q">'plate_number'</span><span class="cm">,</span> <span class="q">'Average_Q20'</span><span class="cm">,</span> <span class="q">'Average_Length'</span><span class="cm">,</span> <span class="q">'Total_Length'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$key_hash</span><span class="s">)</span> <span class="s">{</span> <span class="i">$KEY</span> = <span class="q">''</span><span class="sc">;</span> <span class="i">$group</span> = <span class="q">''</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$group</span> || <span class="i">$KEY</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$group</span> !~ <span class="q">/^(run_name|run_id)$/</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$KEY</span> !~ <span class="q">/^(run_name|run_id)$/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## only valid if grouped</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">&quot;Count(Run.Run_ID) as runs&quot;</span><span class="cm">,</span> <span class="q">'earliest_run'</span><span class="cm">,</span> <span class="q">'latest_run'</span><span class="cm">,</span> <span class="q">'first_plate_created'</span><span class="cm">,</span> <span class="q">'last_plate_created'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> !<span class="i">$group</span> <span class="s">)</span> <span class="s">{</span>                                                                                           <span class="c">## only valid if NOT grouped</span>
        <span class="i">$group</span> .= <span class="q">&quot;run_name&quot;</span><span class="sc">;</span>                                                                                     <span class="c">## group by run_name to allow Average values to be calculated ##</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span>
            <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">'sequencer'</span><span class="cm">,</span> <span class="q">'vector'</span><span class="cm">,</span> <span class="q">'primer'</span><span class="cm">,</span> <span class="q">'run_time'</span><span class="cm">,</span> <span class="q">'run_id'</span><span class="cm">,</span> <span class="q">'run_name'</span><span class="cm">,</span> <span class="q">'Run_Directory'</span><span class="cm">,</span> <span class="q">'unused_wells'</span><span class="cm">,</span> <span class="q">'direction'</span><span class="cm">,</span> <span class="q">'plate_created'</span><span class="cm">,</span> <span class="q">'plate_class'</span><span class="cm">,</span> <span class="q">'library_format'</span><span class="cm">,</span> <span class="q">'parent_quadrant'</span><span class="cm">,</span> <span class="q">'plate_position'</span><span class="cm">,</span> <span class="q">'run_status'</span><span class="cm">,</span> <span class="q">'validation'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">&quot;Count(Run.Run_ID) as runs&quot;</span><span class="cm">,</span> <span class="q">'earliest_run'</span><span class="cm">,</span> <span class="q">'latest_run'</span><span class="cm">,</span> <span class="q">'first_plate_created'</span><span class="cm">,</span> <span class="q">'last_plate_created'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$group</span> .= <span class="q">&quot;,run_name&quot;</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span>
            <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">'sequencer'</span><span class="cm">,</span> <span class="q">'vector'</span><span class="cm">,</span> <span class="q">'primer'</span><span class="cm">,</span> <span class="q">'run_time'</span><span class="cm">,</span> <span class="q">'run_id'</span><span class="cm">,</span> <span class="q">'run_name'</span><span class="cm">,</span> <span class="q">'Run_Directory'</span><span class="cm">,</span> <span class="q">'unused_wells'</span><span class="cm">,</span> <span class="q">'direction'</span><span class="cm">,</span> <span class="q">'plate_created'</span><span class="cm">,</span> <span class="q">'plate_class'</span><span class="cm">,</span> <span class="q">'library_format'</span><span class="cm">,</span> <span class="q">'parent_quadrant'</span><span class="cm">,</span> <span class="q">'plate_position'</span><span class="cm">,</span> <span class="q">'run_status'</span><span class="cm">,</span> <span class="q">'validation'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">&quot;Count(Run.Run_ID) as runs&quot;</span><span class="cm">,</span> <span class="q">'earliest_run'</span><span class="cm">,</span> <span class="q">'latest_run'</span><span class="cm">,</span> <span class="q">'first_plate_created'</span><span class="cm">,</span> <span class="q">'last_plate_created'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">### get_run_data();</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">date_field</span>           <span class="cm">=&gt;</span> <span class="q">&quot;Run.Run_DateTime&quot;</span><span class="cm">,</span>
        -<span class="w">debug</span>                <span class="cm">=&gt;</span> <span class="i">$debug</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c"># get alert reasons in the system, can input reason or alert_type as a filter</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">###########################</span>
<a name="get_alert_reason_data-"></a><span class="k">sub </span><span class="m">get_alert_reason_data</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Include below any arguments that should appear in perldoc + any arguments needing specific attention</span>

    <span class="c">## Specify conditions for data retrieval</span>

    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="c">## plate specification options</span>

    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$alert_type</span>   = <span class="i">$args</span>{-<span class="w">alert_type</span>}<span class="sc">;</span>              <span class="c">## one or more alert types arrayref, example 'QC Notification'</span>
    <span class="k">my</span> <span class="i">$alert_reason</span> = <span class="i">$args</span>{-<span class="w">alert_reason</span>}<span class="sc">;</span>            <span class="c">## scalar one alert reason, will do pattern match, example 'QC_1'</span>
    <span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>

    <span class="c">### Re-Cast arguments as required ###</span>
    <span class="k">my</span> <span class="i">$alert_types</span><span class="sc">;</span>
    <span class="i">$alert_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$alert_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$alert_type</span><span class="sc">;</span>
    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

    <span class="c">## Initial Framework for query ##</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="q">'Alert_Reason'</span><span class="sc">;</span>                                <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">'WHERE 1'</span><span class="sc">;</span>                                     <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>                                            <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">##### DYNAMICALLY JOINED Tables: #####</span>
    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>                                        <span class="c">##    eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## adapt conditions using appropriate aliases as required ##</span>
    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$alert_reason</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Alert_Reason LIKE '%$alert_reason%'&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$alert_types</span><span class="s">)</span>  <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Alert_Reason.Alert_Type IN ($alert_types)&quot;</span> <span class="s">)</span> <span class="s">}</span>

    <span class="c"># Ignore inactive pipelines</span>

    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(Alert_Reason Alert_Type Alert_Reason_Notes)</span><span class="sc">;</span>    <span class="c">## &lt;- Default list of fields to retrieve</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c"># Add an alert reason to an object (supported objects are Run_QC_Alert and Multiplex_QC_Alert for now)</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">######################</span>
<a name="add_alert_reason-"></a><span class="k">sub </span><span class="m">add_alert_reason</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>            = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'object,key_id,alert_reason_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$object</span>          = <span class="i">$args</span>{-<span class="w">object</span>}<span class="sc">;</span>                                                        <span class="c">## object to add ie Run_QC_Alert or Multiplex_QC_Alert</span>
    <span class="k">my</span> <span class="i">$key_id</span>          = <span class="i">$args</span>{-<span class="w">key_id</span>}<span class="sc">;</span>                                                        <span class="c">## array ref of key_id(s) for the object, ie Run_ID or Multiplex_Run_ID</span>
    <span class="k">my</span> <span class="i">$alert_reason_id</span> = <span class="i">$args</span>{-<span class="w">alert_reason_id</span>}<span class="sc">;</span>                                               <span class="c"># array ref  alert reason id for respective key_id(s)</span>
    <span class="k">my</span> <span class="i">$alert_type</span>      = <span class="i">$args</span>{-<span class="w">alert_type</span>}<span class="sc">;</span>                                                    <span class="c"># alert type. It's used for validating alert reason id</span>
    <span class="k">my</span> <span class="i">$comments</span>        = <span class="i">$args</span>{-<span class="w">comments</span>}<span class="sc">;</span>                                                      <span class="c">## additional comments</span>

    <span class="k">my</span> <span class="i">@supported_tables</span> = <span class="s">(</span> <span class="q">'Run_QC_Alert'</span><span class="cm">,</span> <span class="q">'Multiplex_Run_QC_Alert'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">## check to make sure that the object is supported</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$object$/</span><span class="cm">,</span> <span class="i">@supported_tables</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$added</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>             = <span class="i">$self</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@key_id</span>          = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$key_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@alert_reason_id</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$alert_reason_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@comments_arr</span>    = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$comments</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%alert_reason_values</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$si</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fk_field</span><span class="sc">;</span>
    <span class="i">$fk_field</span>{<span class="q">'Run_QC_Alert'</span>}{<span class="w">field</span>}           = <span class="q">'FK_Run__ID'</span><span class="sc">;</span>
    <span class="i">$fk_field</span>{<span class="q">'Run_QC_Alert'</span>}{<span class="w">table</span>}           = <span class="q">'Run'</span><span class="sc">;</span>
    <span class="i">$fk_field</span>{<span class="q">'Multiplex_Run_QC_Alert'</span>}{<span class="w">field</span>} = <span class="q">'FK_Multiplex_Run__ID'</span><span class="sc">;</span>
    <span class="i">$fk_field</span>{<span class="q">'Multiplex_Run_QC_Alert'</span>}{<span class="w">table</span>} = <span class="q">'Multiplex_Run'</span><span class="sc">;</span>

    <span class="c">## validate key_id</span>
    <span class="k">my</span> <span class="i">$valid_key_ids_list</span> = <span class="i">$dbc</span><span class="i">-&gt;valid_ids</span><span class="s">(</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$key_id</span><span class="cm">,</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="i">$fk_field</span>{<span class="i">$object</span>}{<span class="w">table</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@valid_key_ids</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$valid_key_ids_list</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@valid_key_ids</span><span class="s">)</span> &lt; <span class="k">int</span><span class="s">(</span><span class="i">@key_id</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="n">0</span> <span class="s">}</span>

    <span class="c">## validate alert_reason_id</span>
    <span class="k">my</span> <span class="i">$valid_alert_reason_list</span> = <span class="i">$dbc</span><span class="i">-&gt;valid_ids</span><span class="s">(</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$alert_reason_id</span><span class="cm">,</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Alert_Reason'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@valid_alert_reason_ids</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$valid_alert_reason_list</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@valid_alert_reason_ids</span><span class="s">)</span> &lt; <span class="k">int</span><span class="s">(</span><span class="i">@alert_reason_id</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="n">0</span> <span class="s">}</span>

    <span class="c"># validate against Alert_Type</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$alert_type</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$alert_reason_id_list</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@alert_reason_id</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@invalid</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Alert_Reason'</span><span class="cm">,</span> <span class="q">'Alert_Reason_ID'</span><span class="cm">,</span> <span class="q">&quot;Where Alert_Reason_ID in ($alert_reason_id_list) AND Alert_Type &lt;&gt; '$alert_type'&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@invalid</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="n">0</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@fields</span>  = <span class="s">(</span> <span class="i">$fk_field</span>{<span class="i">$object</span>}{<span class="w">field</span>}<span class="cm">,</span> <span class="q">'Alert_Type'</span><span class="cm">,</span> <span class="q">'FK_Alert_Reason__ID'</span><span class="cm">,</span> <span class="q">'FK_Employee__ID'</span><span class="cm">,</span> <span class="q">'Alert_Notification_Date'</span><span class="cm">,</span> <span class="q">'Alert_Comments'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$i</span>       = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$user_id</span> = <span class="i">$self</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'user_id'</span><span class="s">)</span><span class="sc">;</span>
    <span class="c">## build the hash for adding the values</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">@key_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$alert_type</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Alert_Reason'</span><span class="cm">,</span> <span class="q">'Alert_Type'</span><span class="cm">,</span> <span class="q">&quot;WHERE Alert_Reason_ID = $alert_reason_id[$i]&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@values</span> = <span class="s">(</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$alert_type</span><span class="cm">,</span> <span class="i">$alert_reason_id</span>[<span class="i">$i</span>]<span class="cm">,</span> <span class="i">$user_id</span><span class="cm">,</span> <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="i">$comments_arr</span>[<span class="i">$i</span>] <span class="s">)</span><span class="sc">;</span>
        <span class="i">$alert_reason_values</span>{<span class="i">$si</span>} = \<span class="i">@values</span><span class="sc">;</span>
        <span class="i">$i</span>++<span class="sc">;</span>
        <span class="i">$si</span>++<span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$added</span> = <span class="i">$dbc</span><span class="i">-&gt;smart_append</span><span class="s">(</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="q">&quot;$object&quot;</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> \<span class="i">@fields</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> \<span class="i">%alert_reason_values</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$added</span><span class="sc">;</span>
<span class="s">}</span>

<a name="include_condition-"></a><span class="k">sub </span><span class="m">include_condition</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">%args</span>             = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$field</span>            = <span class="i">$args</span>{-<span class="w">field</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$available_values</span> = <span class="i">$args</span>{-<span class="w">available_values</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$include</span>          = <span class="i">$args</span>{-<span class="w">include</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">my</span> <span class="i">@test_options</span> = <span class="k">grep</span> <span class="q">/($available_values)/i</span><span class="cm">,</span> <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$include</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@test_options</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;$field IN ($list)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="q">''</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># New method to get run analysis data extraction</span>
<span class="c">#</span>
<span class="c"># Return: hash of data</span>
<span class="c">#####################</span>
<a name="get_run_analysis_data-"></a><span class="k">sub </span><span class="m">get_run_analysis_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">&quot;run_id|since&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="c">## run specification options</span>
    <span class="k">my</span> <span class="i">$run_id</span> = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>    <span class="c">### specify run id</span>
    <span class="k">my</span> <span class="i">$tables</span> = <span class="i">$args</span>{-<span class="w">tables</span>}<span class="sc">;</span>
    <span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>                  = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>              = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>                   = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>                   = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>                     = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>                   = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                      <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>                   = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                            <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>                    = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>                                             <span class="c">### save query results in hash for easy retrieval</span>
    <span class="k">my</span> <span class="i">$list_fields</span>             = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                      <span class="c">### just generate a list of output fields</span>
    <span class="k">my</span> <span class="i">$debug</span>                   = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$analysis_software</span>       = <span class="i">$args</span>{-<span class="w">analysis_software</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$current_analysis</span>        = <span class="i">$args</span>{-<span class="w">current_analysis</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$multiplex_adapter_index</span> = <span class="i">$args</span>{-<span class="w">multiplex_adapter_index</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_conditions</span>        = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$since</span>                   = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                                            <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span>                   = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                                          <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$run_analysis_type</span> = <span class="i">$args</span>{-<span class="w">run_analysis_type</span>} || <span class="q">&quot;Secondary&quot;</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

            <span class="c">## Generate Condition ##</span>
            <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE 1'</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$current_analysis</span><span class="s">)</span> <span class="s">{</span> <span class="i">$join_condition</span> .= <span class="q">' AND Current_Analysis = &quot;Yes&quot;'</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$run_analysis_type</span><span class="s">)</span> <span class="s">{</span> <span class="i">$join_condition</span> .= <span class="q">&quot; AND Run_Analysis_Type = '$run_analysis_type'&quot;</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## normally the tables parameter will NOT be passed (if it is conditions should be also passed if required) ##</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$tables</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$tables</span> = <span class="q">'Run,Run_Analysis,Analysis_Step,Pipeline_Step,Analysis_Software'</span><span class="sc">;</span>
        <span class="i">$join_condition</span> .= <span class="q">&quot; AND Run_Analysis.FK_Run__ID = Run.Run_ID&quot;</span><span class="sc">;</span>
        <span class="i">$join_condition</span> .= <span class="q">&quot; AND Analysis_Step.FK_Run_Analysis__ID = Run_Analysis.Run_Analysis_ID&quot;</span><span class="sc">;</span>
        <span class="i">$join_condition</span> .= <span class="q">&quot; AND Analysis_Step.FK_Pipeline_Step__ID = Pipeline_Step.Pipeline_Step_ID&quot;</span><span class="sc">;</span>
        <span class="i">$join_condition</span> .= <span class="q">&quot; AND Pipeline_Step.Object_ID = Analysis_Software.Analysis_Software_ID&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span> <span class="q">'run_id'</span><span class="cm">,</span> <span class="q">'run_analysis_id'</span><span class="cm">,</span> <span class="q">'analysis_step_id'</span><span class="cm">,</span> <span class="q">'analysis_software_name'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$runs</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$runs</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Run_ID IN ($runs)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$multiplex_adapter_index</span><span class="s">)</span> <span class="s">{</span>

        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot; Adapter_Index = '$multiplex_adapter_index'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$analysis_software</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Analysis_Software_Name like '%$analysis_software%'&quot;</span> <span class="s">}</span>

    <span class="c">## Retrieve list of applicable Experiments / Runs ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">'SOLID_Run_Analysis'</span>            <span class="cm">=&gt;</span> <span class="q">&quot;SOLID_Run_Analysis.FK_Run_Analysis__ID = Run_Analysis_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Solexa_Run_Analysis'</span>           <span class="cm">=&gt;</span> <span class="q">&quot;Solexa_Run_Analysis.FK_Run_Analysis__ID = Run_Analysis_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Solexa_Read'</span>                   <span class="cm">=&gt;</span> <span class="q">&quot;Run_ID = Solexa_Read.FK_Run__ID&quot;</span><span class="cm">,</span>
        <span class="q">'Multiplex_Run_Analysis'</span>        <span class="cm">=&gt;</span> <span class="q">&quot;Run_Analysis_ID = Multiplex_Run_Analysis.FK_Run_Analysis__ID&quot;</span><span class="cm">,</span>
        <span class="q">'Multiplex_Solexa_Run_Analysis'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Multiplex_Solexa_Run_Analysis.FK_Multiplex_Run_Analysis__ID = Multiplex_Run_Analysis.Multiplex_Run_Analysis_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Multiplex_SOLID_Run_Analysis'</span>  <span class="cm">=&gt;</span> <span class="q">&quot;Multiplex_SOLID_Run_Analysis.FK_Multiplex_Run_Analysis__ID = Multiplex_Run_Analysis.Multiplex_Run_Analysis_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Run_Analysis'</span>                  <span class="cm">=&gt;</span> <span class="q">''</span><span class="cm">,</span>                                                                                                                 <span class="c">#for left join sort</span>
        <span class="q">'Sample'</span>                        <span class="cm">=&gt;</span> <span class="q">'Multiplex_Run_Analysis.FK_Sample__ID=Sample_ID'</span><span class="cm">,</span>
        <span class="q">'Source'</span>                        <span class="cm">=&gt;</span> <span class="q">'Source.Source_ID=Sample.FK_Source__ID'</span><span class="cm">,</span>
        <span class="q">'Multiplex_Run'</span>                 <span class="cm">=&gt;</span> <span class="q">'Multiplex_Run.FK_Run__ID = Run.Run_ID AND Multiplex_Run.Adapter_Index = Multiplex_Run_Analysis.Adapter_Index'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>
    <span class="i">$left_join_conditions</span> = <span class="i">RGmath::merge_Hash</span><span class="s">(</span> -<span class="w">hash1</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">hash2</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>          <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>     <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>          <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>            <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>          <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>         <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>     <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>

        <span class="c">#-left_join_tables     =&gt; $left_join_tables,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>

        <span class="c">#-join_conditions      =&gt; $join_conditions,</span>
        -<span class="w">limit</span>      <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>      <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>      <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span>
        -<span class="w">date_field</span> <span class="cm">=&gt;</span> <span class="q">&quot;Run_Analysis.Run_Analysis_Started&quot;</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># New method to get a list of genomes</span>
<span class="c">#</span>
<span class="c"># Return: hash of data</span>
<span class="c">#####################</span>
<a name="get_genome_data-"></a><span class="k">sub </span><span class="m">get_genome_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="c">## run specification options</span>
    <span class="k">my</span> <span class="i">$genome_id</span> = <span class="i">$args</span>{-<span class="w">genome_id</span>}<span class="sc">;</span>    <span class="c">### specify run id</span>

    <span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>                                       <span class="c">### save query results in hash for easy retrieval</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>
    <span class="k">my</span> <span class="i">$debug</span>       = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="c">## Generate Condition ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE 1'</span><span class="sc">;</span>

    <span class="c">## normally the tables parameter will NOT be passed (if it is conditions should be also passed if required) ##</span>
    <span class="k">my</span> <span class="i">$tables</span> = <span class="q">'Genome'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span> <span class="q">'reference_genome_id'</span><span class="cm">,</span> <span class="q">'reference_genome_name'</span><span class="cm">,</span> <span class="q">'reference_genome_path'</span><span class="cm">,</span> <span class="q">'taxonomy_id'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$genome_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$genome_id</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$genome_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Genome.Genome_ID IN ($genome_id)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">## Retrieve list of applicable Experiments / Runs ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>          <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>     <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>          <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>            <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>          <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>         <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>     <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>          <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>          <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>          <span class="cm">=&gt;</span> <span class="i">$debug</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c"># Update a genome record</span>
<span class="c">#</span>
<span class="c"># $API-&gt;set_genome_data(-fields=&gt;\@array, -values=&gt;\@array,-genome_id=&gt;18,-comment=&gt;&quot;updating some field&quot;);</span>
<span class="c">#</span>
<a name="set_genome_data-"></a><span class="k">sub </span><span class="m">set_genome_data</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'values,genome_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$table</span>        = <span class="i">$args</span>{-<span class="w">table</span>} || <span class="q">'Genome'</span><span class="sc">;</span>    <span class="c">## eg SolexaRun or Solexa_Read</span>
    <span class="k">my</span> <span class="i">$fields</span>       = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>               <span class="c">## list of fields to update (using defined aliases)</span>
    <span class="k">my</span> <span class="i">$values</span>       = <span class="i">$args</span>{ -<span class="k">values</span> }<span class="sc">;</span>             <span class="c">## associated list of values</span>
    <span class="k">my</span> <span class="i">$genome_id</span>    = <span class="i">$args</span>{-<span class="w">genome_id</span>}<span class="sc">;</span>            <span class="c">## specify update based upon run_id</span>
    <span class="k">my</span> <span class="i">$condition</span>    = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$valid_fields</span> = <span class="i">$args</span>{-<span class="w">valid_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>        = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>        = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$comment</span>      = <span class="i">$args</span>{-<span class="w">comment</span>}<span class="sc">;</span>

    <span class="c">### Generate condition based upon input parameters ###</span>

    <span class="c">## pass all parameters to allow use of filtering options to retrieve list of run_ids</span>
    <span class="i">$args</span>{-<span class="w">tables</span>} = <span class="q">'Genome'</span><span class="sc">;</span>
    <span class="i">$condition</span> = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%retrieve_args</span> = <span class="i">%args</span><span class="sc">;</span>
    <span class="i">$retrieve_args</span>{-<span class="w">fields</span>} = <span class="q">'genome_id'</span><span class="sc">;</span>    <span class="c"># just get the run_ids given the other filtering options...</span>
    <span class="k">my</span> <span class="i">%genome_data</span><span class="sc">;</span>
    <span class="i">%genome_data</span> = <span class="i">%</span>{ <span class="i">$self</span><span class="i">-&gt;get_genome_data</span><span class="s">(</span><span class="i">%retrieve_args</span><span class="s">)</span> } <span class="k">if</span> <span class="k">defined</span> <span class="i">$self</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@genome_ids</span> = <span class="i">@</span>{ <span class="i">$genome_data</span>{<span class="w">genome_id</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$genome_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@genome_ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@valid_field_list</span><span class="sc">;</span>
    <span class="k">if</span>   <span class="s">(</span><span class="i">$valid_fields</span><span class="s">)</span> <span class="s">{</span> <span class="i">@valid_field_list</span> = <span class="i">@$valid_fields</span> <span class="s">}</span>
    <span class="k">else</span>                 <span class="s">{</span> <span class="i">@valid_field_list</span> = <span class="q">qw(Genome.Genome_URL Genome.Genome_Alias Genome.Genome_Path Genome.Genome_Type Genome.Genome_Status Genome.FKParent_Genome__ID Genome.Genome_Default)</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$genome_list</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$condition</span> .= <span class="q">&quot; AND Genome_ID IN ($genome_list)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;No runs found&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$start</span>   = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$updated</span> = <span class="i">$self</span><span class="i">-&gt;set_data</span><span class="s">(</span>
        -<span class="w">table</span>        <span class="cm">=&gt;</span> <span class="i">$table</span><span class="cm">,</span>
        -<span class="w">fields</span>       <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span>
        -<span class="w">values</span>       <span class="cm">=&gt;</span> <span class="i">$values</span><span class="cm">,</span>
        -<span class="w">condition</span>    <span class="cm">=&gt;</span> <span class="q">&quot;WHERE 1 $condition&quot;</span><span class="cm">,</span>
        -<span class="w">valid_fields</span> <span class="cm">=&gt;</span> \<span class="i">@valid_field_list</span><span class="cm">,</span>
        -<span class="w">quiet</span>        <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>        <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span>
        -<span class="w">comment</span>      <span class="cm">=&gt;</span> <span class="i">$comment</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;updated $updated Genome records&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$updated</span><span class="cm">,</span> -<span class="w">summary</span> <span class="cm">=&gt;</span> <span class="q">&quot;Updated $updated Genome records&quot;</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c"># API to add a reference genome record</span>
<span class="c">#</span>
<span class="c"># Example:</span>
<span class="c"># $API-&gt;add_genome(-genome_name=&gt;&quot;&lt;ref_genome&quot;,-genome_path=&gt;&quot;hg19&quot;, -taxonomy_id=&gt;9606,-genome_alias=&gt;'hg19',-genome_url=&gt;&quot;http://www...&quot;,-parent_genome_id=&gt;18, -genome_type=&gt;'Transcriptome&quot;);</span>
<a name="add_genome-"></a><span class="k">sub </span><span class="m">add_genome</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>          = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'genome_name,genome_path,taxonomy_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$genome_name</span>   = <span class="i">$args</span>{-<span class="w">genome_name</span>}<span class="sc">;</span>                                                         <span class="c"># Genome Name</span>
    <span class="k">my</span> <span class="i">$genome_path</span>   = <span class="i">$args</span>{-<span class="w">genome_path</span>}<span class="sc">;</span>                                                         <span class="c"># filesystem path name</span>
    <span class="k">my</span> <span class="i">$taxonomy</span>      = <span class="i">$args</span>{-<span class="w">taxonomy_id</span>}<span class="sc">;</span>                                                         <span class="c"># taxonomy</span>
    <span class="k">my</span> <span class="i">$genome_type</span>   = <span class="i">$args</span>{-<span class="w">genome_type</span>} || <span class="q">'Genome'</span><span class="sc">;</span>                                             <span class="c">#Genome or Transcriptome</span>
    <span class="k">my</span> <span class="i">$genome_alias</span>  = <span class="i">$args</span>{-<span class="w">genome_alias</span>}<span class="sc">;</span>                                                        <span class="c"># ie hg18</span>
    <span class="k">my</span> <span class="i">$genome_url</span>    = <span class="i">$args</span>{-<span class="w">genome_url</span>}<span class="sc">;</span>                                                          <span class="c"># web URL for the genome local or external</span>
    <span class="k">my</span> <span class="i">$parent_genome</span> = <span class="i">$args</span>{-<span class="w">parent_genome_id</span>}<span class="sc">;</span>                                                    <span class="c"># link to a parent genome id</span>
    <span class="k">my</span> <span class="i">@fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values</span><span class="sc">;</span>
    <span class="i">@fields</span> = <span class="s">(</span> <span class="q">'Genome_Name'</span><span class="cm">,</span> <span class="q">'Genome_Path'</span><span class="cm">,</span> <span class="q">'FK_Taxonomy__ID'</span><span class="cm">,</span> <span class="q">'Genome_Type'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">@values</span> = <span class="s">(</span> <span class="i">$genome_name</span><span class="cm">,</span> <span class="i">$genome_path</span><span class="cm">,</span> <span class="i">$taxonomy</span><span class="cm">,</span> <span class="i">$genome_type</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">## add optional fields</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$genome_alias</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@fields</span><span class="cm">,</span> <span class="q">'Genome_Alias'</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$genome_alias</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$genome_url</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@fields</span><span class="cm">,</span> <span class="q">'Genome_URL'</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$genome_url</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$parent_genome</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@fields</span><span class="cm">,</span> <span class="q">'FKParent_Genome__ID'</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$parent_genome</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$self</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$genome_id</span><span class="sc">;</span>
    <span class="c">## add the genome record</span>
    <span class="i">$genome_id</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="q">'Genome'</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> \<span class="i">@values</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$genome_id</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># New method to get a list of analysis_software</span>
<span class="c">#</span>
<span class="c"># Return: hash of data</span>
<span class="c">#####################</span>
<a name="get_analysis_software_data-"></a><span class="k">sub </span><span class="m">get_analysis_software_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="c">## run specification options</span>
    <span class="k">my</span> <span class="i">$run_id</span> = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>    <span class="c">### specify run id</span>

    <span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>                                       <span class="c">### save query results in hash for easy retrieval</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>
    <span class="k">my</span> <span class="i">$debug</span>       = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="c">## Generate Condition ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE 1'</span><span class="sc">;</span>

    <span class="c">## normally the tables parameter will NOT be passed (if it is conditions should be also passed if required) ##</span>
    <span class="k">my</span> <span class="i">$tables</span> = <span class="q">'Analysis_Software'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span> <span class="q">'analysis_software_id'</span><span class="cm">,</span> <span class="q">'analysis_software_name'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>

    <span class="c">## Retrieve list of applicable Experiments / Runs ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>          <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>     <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>          <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>            <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>          <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>         <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>     <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>          <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>          <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>          <span class="cm">=&gt;</span> <span class="i">$debug</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># New method to get a list of anatomic site</span>
<span class="c">#</span>
<span class="c"># Return: hash of data</span>
<span class="c">#####################</span>
<a name="get_anatomic_site_data-"></a><span class="k">sub </span><span class="m">get_anatomic_site_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="c">## run specification options</span>
    <span class="k">my</span> <span class="i">$run_id</span> = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>    <span class="c">### specify run id</span>

    <span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>                                       <span class="c">### save query results in hash for easy retrieval</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>
    <span class="k">my</span> <span class="i">$debug</span>       = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="c">## Generate Condition ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE 1'</span><span class="sc">;</span>

    <span class="c">## normally the tables parameter will NOT be passed (if it is conditions should be also passed if required) ##</span>
    <span class="k">my</span> <span class="i">$tables</span> = <span class="q">'Anatomic_Site'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span> <span class="q">'anatomic_site_id'</span><span class="cm">,</span> <span class="q">'anatomic_site_alias'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>

    <span class="c">## Retrieve list of applicable Experiments / Runs ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>          <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>     <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>          <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>            <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>          <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>         <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>     <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>          <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>          <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>          <span class="cm">=&gt;</span> <span class="i">$debug</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># New method to get a list of work request</span>
<span class="c">#</span>
<span class="c"># Return: hash of data</span>
<span class="c">#####################</span>
<a name="get_work_request_data-"></a><span class="k">sub </span><span class="m">get_work_request_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="c">## run specification options</span>
    <span class="k">my</span> <span class="i">$run_id</span> = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>    <span class="c">### specify run id</span>

    <span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>                                       <span class="c">### save query results in hash for easy retrieval</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>
    <span class="k">my</span> <span class="i">$debug</span>       = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$library</span>          = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>                               <span class="c">### specify library</span>
    <span class="k">my</span> <span class="i">$goal</span>             = <span class="i">$args</span>{-<span class="w">goal</span>}<span class="sc">;</span>                                  <span class="c">### specify goal name</span>
    <span class="k">my</span> <span class="i">$percent_complete</span> = <span class="i">$args</span>{-<span class="w">percent_complete</span>}<span class="sc">;</span>                      <span class="c">### specify percent complete</span>

    <span class="c">## Generate Condition ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE 1'</span><span class="sc">;</span>

    <span class="c">## normally the tables parameter will NOT be passed (if it is conditions should be also passed if required) ##</span>
    <span class="k">my</span> <span class="i">$tables</span> = <span class="q">'Work_Request,Funding,Goal'</span><span class="sc">;</span>
    <span class="i">$join_condition</span> .= <span class="q">&quot; AND Work_Request.FK_Funding__ID = Funding.Funding_ID&quot;</span><span class="sc">;</span>
    <span class="i">$join_condition</span> .= <span class="q">&quot; AND Work_Request.FK_Goal__ID = Goal.Goal_ID&quot;</span><span class="sc">;</span>
    <span class="i">$join_condition</span> .= <span class="q">&quot; AND Work_Request.Scope = 'Library'&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span> <span class="q">'work_request_id'</span><span class="cm">,</span> <span class="q">'work_request_library'</span><span class="cm">,</span> <span class="q">'work_request_funding_sow'</span><span class="cm">,</span> <span class="q">'work_request_goal'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$goals</span><span class="sc">;</span>
    <span class="i">$goals</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$goal</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$goal</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$libraries</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Work_Request.FK_Library__Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$goals</span><span class="s">)</span>     <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Goal.Goal_Name IN ($goals)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$percent_complete</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Work_Request.Percent_Complete &lt; $percent_complete&quot;</span> <span class="s">}</span>

    <span class="c">## Retrieve list of applicable Experiments / Runs ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>          <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>     <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>          <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>            <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>          <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>         <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>     <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>          <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>          <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>          <span class="cm">=&gt;</span> <span class="i">$debug</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># Accessor for getting libraries that have goals with analysis pipeline not finish</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="get_incomplete_analysis_libraries-"></a><span class="k">sub </span><span class="m">get_incomplete_analysis_libraries</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>          = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'pipeline_name'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'pipeline_name'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_name</span> = <span class="i">$args</span>{-<span class="w">pipeline_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>         = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%goals</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
        <span class="q">&quot;Goal,Work_Request,Pipeline&quot;</span><span class="cm">,</span>
        <span class="s">[</span> <span class="q">'Goal_Tables'</span><span class="cm">,</span> <span class="q">'Goal_Count'</span><span class="cm">,</span> <span class="q">'Goal_Condition'</span><span class="cm">,</span> <span class="q">'FK_Library__Name'</span><span class="cm">,</span> <span class="q">'SUM(Goal_Target)'</span> <span class="s">]</span><span class="cm">,</span>
        <span class="q">&quot;WHERE FK_Goal__ID = Goal_ID AND Pipeline_Name IN ('$pipeline_name') AND Goal_Name = Pipeline_Name Group By FK_Library__Name AND Scope = 'Library'&quot;</span><span class="cm">,</span>
        -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c">#print Dumper \%goals;</span>

    <span class="k">my</span> <span class="i">$libraries</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="k">map</span> <span class="s">{</span><span class="q">&quot;\'$_\'&quot;</span><span class="s">}</span> <span class="i">@</span>{ <span class="i">$goals</span>{<span class="w">FK_Library__Name</span>} } <span class="s">)</span><span class="sc">;</span>

    <span class="c">#print &quot;$libraries\n&quot;;</span>
    <span class="k">my</span> <span class="i">$tables</span>    = <span class="i">$goals</span>{<span class="w">Goal_Tables</span>}[<span class="n">0</span>]<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$select</span>    = <span class="i">$goals</span>{<span class="w">Goal_Count</span>}[<span class="n">0</span>]<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$condition</span> = <span class="i">$goals</span>{<span class="w">Goal_Condition</span>}[<span class="n">0</span>]<span class="sc">;</span>
    <span class="i">$condition</span> =~ <span class="q">s/\= \'\&lt;LIBRARY\&gt;\'/IN \($libraries\)/</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%found</span><span class="sc">;</span>
    <span class="i">%found</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="i">$tables</span><span class="cm">,</span> <span class="s">[</span> <span class="i">$select</span><span class="cm">,</span> <span class="q">'FK_Library__Name'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE $condition Group By FK_Library__Name&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$select</span><span class="sc">;</span>

    <span class="c">#print Dumper \%found;</span>

    <span class="k">my</span> <span class="i">%goal_met</span><span class="sc">;</span>
    <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt;= <span class="i">$#</span>{ <span class="i">$found</span>{<span class="w">FK_Library__Name</span>} }<span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
        <span class="i">$goal_met</span>{ <span class="i">$found</span>{<span class="w">FK_Library__Name</span>}[<span class="i">$i</span>] } = <span class="i">$found</span>{<span class="i">$select</span>}[<span class="i">$i</span>]<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#print Dumper \%goal_met;</span>

    <span class="k">my</span> <span class="i">@incomplete_analysis_libraries</span><span class="sc">;</span>
    <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt;= <span class="i">$#</span>{ <span class="i">$goals</span>{<span class="w">FK_Library__Name</span>} }<span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$goals</span>{<span class="q">'SUM(Goal_Target)'</span>}[<span class="i">$i</span>] &gt; <span class="i">$goal_met</span>{ <span class="i">$goals</span>{<span class="w">FK_Library__Name</span>}[<span class="i">$i</span>] } <span class="s">)</span> <span class="s">{</span>

            <span class="c">#print &quot;$goals{FK_Library__Name}[$i] goal not met\n&quot;;</span>
            <span class="k">push</span> <span class="i">@incomplete_analysis_libraries</span><span class="cm">,</span> <span class="i">$goals</span>{<span class="w">FK_Library__Name</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">#print Dumper \@incomplete_analysis_libraries;</span>

    <span class="k">my</span> <span class="i">$output</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="i">@incomplete_analysis_libraries</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$output</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># Get a list of goals</span>
<span class="c">#</span>
<span class="c"># Return: hash of data</span>
<span class="c">#####################</span>
<a name="get_goal_data-"></a><span class="k">sub </span><span class="m">get_goal_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>

    <span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>                                       <span class="c">### save query results in hash for easy retrieval</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>
    <span class="k">my</span> <span class="i">$debug</span>       = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$goal</span>      = <span class="i">$args</span>{-<span class="w">goal</span>}<span class="sc">;</span>                                         <span class="c">### specify goal name</span>
    <span class="k">my</span> <span class="i">$goal_type</span> = <span class="i">$args</span>{-<span class="w">goal_type</span>}<span class="sc">;</span>                                    <span class="c"># specify the goal type</span>
    <span class="c">## Generate Condition ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE 1'</span><span class="sc">;</span>

    <span class="c">## normally the tables parameter will NOT be passed (if it is conditions should be also passed if required) ##</span>
    <span class="k">my</span> <span class="i">$tables</span> = <span class="q">'Goal'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span> <span class="q">'Goal_Name'</span><span class="cm">,</span> <span class="q">'Goal_Type'</span><span class="cm">,</span> <span class="q">'Goal_Scope'</span><span class="cm">,</span> <span class="q">'Goal_Description'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$goals</span><span class="sc">;</span>
    <span class="i">$goals</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$goal</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$goal</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$goal_types</span><span class="sc">;</span>
    <span class="i">$goal_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$goal_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$goal_type</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$goals</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Goal.Goal_Name IN ($goals)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$goal_types</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Goal_Type IN ($goal_types) &quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## Retrieve list of applicable Experiments / Runs ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>          <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>     <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>          <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>            <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>          <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>         <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>     <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>          <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>          <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>          <span class="cm">=&gt;</span> <span class="i">$debug</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#####################</span>
<a name="get_control_type_data-"></a><span class="k">sub </span><span class="m">get_control_type_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="c">## run specification options</span>

    <span class="c">## Output options</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>                                       <span class="c">### save query results in hash for easy retrieval</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>
    <span class="k">my</span> <span class="i">$debug</span>       = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="c">## Generate Condition ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE 1'</span><span class="sc">;</span>

    <span class="c">## normally the tables parameter will NOT be passed (if it is conditions should be also passed if required) ##</span>
    <span class="k">my</span> <span class="i">$tables</span> = <span class="q">'Control_Type,Organization'</span><span class="sc">;</span>
    <span class="i">$join_condition</span> .= <span class="q">&quot; AND Control_Type.FK_Organization__ID = Organization_ID&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span> <span class="q">'Control_Type_ID'</span><span class="cm">,</span> <span class="q">'Control_Type_Name'</span><span class="cm">,</span> <span class="q">'Control_Description'</span><span class="cm">,</span> <span class="q">'Organization_Name'</span><span class="cm">,</span> <span class="q">'Control_Type'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>

    <span class="c">##if ($goals)     { push( @extra_conditions, &quot;Goal.Goal_Name IN ($goals)&quot; ) }</span>
    <span class="c">##if ($percent_complete) { push @extra_conditions, &quot;Work_Request.Percent_Complete &lt; $percent_complete&quot; }</span>

    <span class="c">## Retrieve list of applicable Experiments / Runs ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>          <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>     <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>          <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>            <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>          <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>         <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>     <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>          <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>          <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>          <span class="cm">=&gt;</span> <span class="i">$debug</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># Accessor for setting the Run_Status through the API</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="set_run_status-"></a><span class="k">sub </span><span class="m">set_run_status</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>    = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'run_ids,status'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'run_ids,status'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_ids</span> = <span class="i">$args</span>{-<span class="w">run_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$status</span>  = <span class="i">$args</span>{-<span class="w">status</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span>   = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span>  = <span class="i">&amp;alDente::Run::set_run_status</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">run_ids</span> <span class="cm">=&gt;</span> <span class="i">$run_ids</span><span class="cm">,</span> -<span class="w">status</span> <span class="cm">=&gt;</span> <span class="i">$status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$output</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># Accessor for setting the Run_Comments through the API</span>
<span class="c">#</span>
<span class="c"># usage: $API-&gt;set_run_comments(-run_ids=&gt;'90001,90002,90003',-comment=&gt;&quot;This is a test&quot;,-name=&gt;'Dean');</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="set_run_comments-"></a><span class="k">sub </span><span class="m">set_run_comments</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>    = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'run_ids,comment,name'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'run_ids,comment,name'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_ids</span> = <span class="i">$args</span>{-<span class="w">run_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$comment</span> = <span class="i">$args</span>{-<span class="w">comment</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$name</span>    = <span class="i">$args</span>{-<span class="w">name</span>}<span class="sc">;</span>

    <span class="i">$comment</span> = <span class="q">&quot;Comment by $name: $comment&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span> = <span class="i">&amp;alDente::Run::annotate_runs</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">run_ids</span> <span class="cm">=&gt;</span> <span class="i">$run_ids</span><span class="cm">,</span> -<span class="w">comments</span> <span class="cm">=&gt;</span> <span class="i">$comment</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="q">&quot;Updated $output Run Comments&quot;</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># Accessor for setting the Run_Validation through the API</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="set_run_validation_status-"></a><span class="k">sub </span><span class="m">set_run_validation_status</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>    = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'run_ids,status'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'run_ids,status'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_ids</span> = <span class="i">$args</span>{-<span class="w">run_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$status</span>  = <span class="i">$args</span>{-<span class="w">status</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span>   = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span>  = <span class="i">&amp;alDente::Run::set_validation_status</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">run_ids</span> <span class="cm">=&gt;</span> <span class="i">$run_ids</span><span class="cm">,</span> -<span class="w">status</span> <span class="cm">=&gt;</span> <span class="i">$status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$output</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############</span>
<span class="c"># call for updating the fields in Run tables</span>
<span class="c">#</span>
<span class="c"># usage $Solexa_API-&gt;set_run_data=&gt;$dbc,-fields =&gt; ['QC_Status'],-values=&gt;['Passed'],-run_id=&gt;'53595,53596');</span>
<span class="c">#</span>
<span class="c">########################</span>
<a name="set_run_data-"></a><span class="k">sub </span><span class="m">set_run_data()</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'values,run_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$table</span>        = <span class="i">$args</span>{-<span class="w">table</span>} || <span class="q">'Run,RunBatch'</span><span class="sc">;</span>    <span class="c">## eg SolexaRun or Solexa_Read</span>
    <span class="k">my</span> <span class="i">$fields</span>       = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>                     <span class="c">## list of fields to update (using defined aliases)</span>
    <span class="k">my</span> <span class="i">$values</span>       = <span class="i">$args</span>{ -<span class="k">values</span> }<span class="sc">;</span>                   <span class="c">## associated list of values</span>
    <span class="k">my</span> <span class="i">$run_id</span>       = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>                     <span class="c">## specify update based upon run_id</span>
    <span class="k">my</span> <span class="i">$condition</span>    = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$valid_fields</span> = <span class="i">$args</span>{-<span class="w">valid_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>        = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>        = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$comment</span>      = <span class="i">$args</span>{-<span class="w">comment</span>}<span class="sc">;</span>

    <span class="c">### Generate condition based upon input parameters ###</span>

    <span class="c">## pass all parameters to allow use of filtering options to retrieve list of run_ids</span>
    <span class="i">$args</span>{-<span class="w">tables</span>}    = <span class="q">'Run,RunBatch'</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">condition</span>} = <span class="q">'FK_RunBatch__ID = RunBatch_ID'</span><span class="sc">;</span>
    <span class="i">$condition</span>        = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%retrieve_args</span> = <span class="i">%args</span><span class="sc">;</span>
    <span class="i">$retrieve_args</span>{-<span class="w">fields</span>} = <span class="q">'run_id'</span><span class="sc">;</span>    <span class="c"># just get the run_ids given the other filtering options...</span>
    <span class="k">my</span> <span class="i">%run_data</span><span class="sc">;</span>
    <span class="i">%run_data</span> = <span class="i">%</span>{ <span class="i">$self</span><span class="i">-&gt;get_run_data</span><span class="s">(</span><span class="i">%retrieve_args</span><span class="s">)</span> } <span class="k">if</span> <span class="k">defined</span> <span class="i">$self</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@run_ids</span> = <span class="i">@</span>{ <span class="i">$run_data</span>{<span class="w">Run_ID</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@run_ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@valid_field_list</span><span class="sc">;</span>
    <span class="k">if</span>   <span class="s">(</span><span class="i">$valid_fields</span><span class="s">)</span> <span class="s">{</span> <span class="i">@valid_field_list</span> = <span class="i">@$valid_fields</span> <span class="s">}</span>
    <span class="k">else</span>                 <span class="s">{</span> <span class="i">@valid_field_list</span> = <span class="q">qw(QC_Status Run.QC_Status Billable Run_Test_Status)</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$run_list</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$condition</span> .= <span class="q">&quot; AND Run_ID IN ($run_list)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;No runs found&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$start</span>   = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$updated</span> = <span class="i">$self</span><span class="i">-&gt;set_data</span><span class="s">(</span>
        -<span class="w">table</span>        <span class="cm">=&gt;</span> <span class="i">$table</span><span class="cm">,</span>
        -<span class="w">fields</span>       <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span>
        -<span class="w">values</span>       <span class="cm">=&gt;</span> <span class="i">$values</span><span class="cm">,</span>
        -<span class="w">condition</span>    <span class="cm">=&gt;</span> <span class="q">&quot;WHERE $condition&quot;</span><span class="cm">,</span>
        -<span class="w">valid_fields</span> <span class="cm">=&gt;</span> \<span class="i">@valid_field_list</span><span class="cm">,</span>
        -<span class="w">quiet</span>        <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>        <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span>
        -<span class="w">comment</span>      <span class="cm">=&gt;</span> <span class="i">$comment</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;updated $updated Run records&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$updated</span><span class="cm">,</span> -<span class="w">summary</span> <span class="cm">=&gt;</span> <span class="q">&quot;Updated $updated Run records&quot;</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############</span>
<span class="c"># call for updating the fields in Run tables</span>
<span class="c">#</span>
<span class="c"># usage $Solexa_API-&gt;set_run_data=&gt;$dbc,-fields =&gt; ['QC_Status'],-values=&gt;['Passed'],-run_id=&gt;'53595,53596');</span>
<span class="c">#</span>
<span class="c">########################</span>
<a name="set_multiplex_run_analysis_data-"></a><span class="k">sub </span><span class="m">set_multiplex_run_analysis_data</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'values,run_id,multiplex_adapter_index'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;set_multiplex_run_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'values,run_id,multiplex_adapter_index'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$table</span>         = <span class="i">$args</span>{-<span class="w">table</span>} || <span class="q">'Multiplex_Run_Analysis'</span><span class="sc">;</span>    <span class="c">## eg SolexaRun or Solexa_Read</span>
    <span class="k">my</span> <span class="i">$fields</span>        = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>                               <span class="c">## list of fields to update (using defined aliases)</span>
    <span class="k">my</span> <span class="i">$values</span>        = <span class="i">$args</span>{ -<span class="k">values</span> }<span class="sc">;</span>                             <span class="c">## associated list of values</span>
    <span class="k">my</span> <span class="i">$run_id</span>        = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>                               <span class="c">## specify update based upon run_id</span>
    <span class="k">my</span> <span class="i">$adapter_index</span> = <span class="i">$args</span>{-<span class="w">multiplex_adapter_index</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$condition</span>     = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$valid_fields</span>  = <span class="i">$args</span>{-<span class="w">valid_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>         = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>         = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$comment</span>       = <span class="i">$args</span>{-<span class="w">comment</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$force</span>         = <span class="i">$args</span>{-<span class="w">force</span>}<span class="sc">;</span>

    <span class="c">### Generate condition based upon input parameters ###</span>

    <span class="c">## pass all parameters to allow use of filtering options to retrieve list of run_ids</span>
    <span class="i">$args</span>{-<span class="w">tables</span>}                  = <span class="q">'Multiplex_Run_Analysis,Run_Analysis,Run'</span><span class="sc">;</span>
    <span class="i">$condition</span>                      = <span class="q">&quot;Multiplex_Run_Analysis.FK_Run_Analysis__ID = Run_Analysis_ID and Run_Analysis.FK_Run__ID = Run_ID&quot;</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">condition</span>}               = <span class="i">$condition</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">multiplex_adapter_index</span>} = <span class="i">$adapter_index</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">current_analysis</span>}        = <span class="n">1</span><span class="sc">;</span>                                                                                                     <span class="c">## get the latest run analysis</span>
    <span class="k">my</span> <span class="i">%retrieve_args</span> = <span class="i">%args</span><span class="sc">;</span>
    <span class="i">$retrieve_args</span>{-<span class="w">fields</span>}   = <span class="q">'multiplex_run_analysis_id,multiplex_adapter_index'</span><span class="sc">;</span>                                                         <span class="c"># just get the run_ids given the other filtering options...</span>
    <span class="i">$retrieve_args</span>{-<span class="w">distinct</span>} = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%run_data</span><span class="sc">;</span>
    <span class="i">%run_data</span> = <span class="i">%</span>{ <span class="i">$self</span><span class="i">-&gt;get_run_analysis_data</span><span class="s">(</span><span class="i">%retrieve_args</span><span class="s">)</span> } <span class="k">if</span> <span class="k">defined</span> <span class="i">$self</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@ids</span> = <span class="i">@</span>{ <span class="i">$run_data</span>{<span class="w">multiplex_run_analysis_id</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$multiplex_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@valid_field_list</span><span class="sc">;</span>
    <span class="k">if</span>   <span class="s">(</span><span class="i">$valid_fields</span><span class="s">)</span> <span class="s">{</span> <span class="i">@valid_field_list</span> = <span class="i">@$valid_fields</span> <span class="s">}</span>
    <span class="k">else</span>                 <span class="s">{</span> <span class="i">@valid_field_list</span> = <span class="q">qw(Multiplex_Run_QC_Status)</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$set_condition</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$multiplex_list</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$set_condition</span> .= <span class="q">&quot;WHERE 1 AND Multiplex_Run_Analysis_ID IN ($multiplex_list) &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;No multiplex runs found&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">$force</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## check to see if the multiplex run analysis already has comments or qc status set</span>
        <span class="k">my</span> <span class="i">$runs</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@qc_status</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Multiplex_Run_Analysis,Run_Analysis'</span><span class="cm">,</span> <span class="q">'Multiplex_Run_QC_Status'</span><span class="cm">,</span> <span class="q">&quot;WHERE Run_Analysis_ID = Multiplex_Run_Analysis.FK_Run_Analysis__ID and FK_Run__ID IN ($runs) and Adapter_Index = '$adapter_index'&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">@qc_status</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$qc_set</span> = <span class="n">0</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$qc_status</span> <span class="s">(</span><span class="i">@qc_status</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$qc_status</span> <span class="k">ne</span> <span class="q">'N/A'</span> <span class="k">and</span> <span class="k">length</span><span class="s">(</span><span class="i">$qc_status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$qc_set</span> = <span class="n">1</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$qc_set</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$start</span>   = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$updated</span> = <span class="i">$self</span><span class="i">-&gt;set_data</span><span class="s">(</span>
        -<span class="w">table</span>        <span class="cm">=&gt;</span> <span class="i">$table</span><span class="cm">,</span>
        -<span class="w">fields</span>       <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span>
        -<span class="w">values</span>       <span class="cm">=&gt;</span> <span class="i">$values</span><span class="cm">,</span>
        -<span class="w">condition</span>    <span class="cm">=&gt;</span> <span class="i">$set_condition</span><span class="cm">,</span>
        -<span class="w">valid_fields</span> <span class="cm">=&gt;</span> \<span class="i">@valid_field_list</span><span class="cm">,</span>
        -<span class="w">quiet</span>        <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">debug</span>        <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span>
        -<span class="w">comment</span>      <span class="cm">=&gt;</span> <span class="i">$comment</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;updated $updated Run records&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$updated</span><span class="cm">,</span> -<span class="w">summary</span> <span class="cm">=&gt;</span> <span class="q">&quot;Updated $updated Run records&quot;</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############</span>
<span class="c"># call for updating the fields in Run tables</span>
<span class="c">#</span>
<span class="c"># usage $Solexa_API-&gt;set_run_data=&gt;$dbc,-fields =&gt; ['QC_Status'],-values=&gt;['Passed'],-run_id=&gt;'53595,53596');</span>
<span class="c">#</span>
<span class="c">########################</span>
<a name="set_multiplex_run_data-"></a><span class="k">sub </span><span class="m">set_multiplex_run_data</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'values,run_id,multiplex_adapter_index'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$table</span>         = <span class="i">$args</span>{-<span class="w">table</span>} || <span class="q">'Multiplex_Run'</span><span class="sc">;</span>    <span class="c">## eg SolexaRun or Solexa_Read</span>
    <span class="k">my</span> <span class="i">$fields</span>        = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>                      <span class="c">## list of fields to update (using defined aliases)</span>
    <span class="k">my</span> <span class="i">$values</span>        = <span class="i">$args</span>{ -<span class="k">values</span> }<span class="sc">;</span>                    <span class="c">## associated list of values</span>
    <span class="k">my</span> <span class="i">$run_id</span>        = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>                      <span class="c">## specify update based upon run_id</span>
    <span class="k">my</span> <span class="i">$adapter_index</span> = <span class="i">$args</span>{-<span class="w">multiplex_adapter_index</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$condition</span>     = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$valid_fields</span>  = <span class="i">$args</span>{-<span class="w">valid_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>         = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>         = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$comment</span>       = <span class="i">$args</span>{-<span class="w">comment</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$force</span>         = <span class="i">$args</span>{-<span class="w">force</span>}<span class="sc">;</span>

    <span class="c">### Generate condition based upon input parameters ###</span>

    <span class="c">## pass all parameters to allow use of filtering options to retrieve list of run_ids</span>
    <span class="i">$args</span>{-<span class="w">tables</span>}                  = <span class="q">'Multiplex_Run,Run'</span><span class="sc">;</span>
    <span class="i">$condition</span>                      = <span class="q">&quot;Multiplex_Run.FK_Run__ID = Run_ID&quot;</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">condition</span>}               = <span class="i">$condition</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">multiplex_adapter_index</span>} = <span class="i">$adapter_index</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">current_analysis</span>}        = <span class="n">1</span><span class="sc">;</span>                                     <span class="c">## get the latest run analysis</span>
    <span class="k">my</span> <span class="i">%retrieve_args</span> = <span class="i">%args</span><span class="sc">;</span>
    <span class="i">$retrieve_args</span>{-<span class="w">fields</span>}   = <span class="q">'multiplex_run_id,multiplex_adapter_index'</span><span class="sc">;</span>    <span class="c"># just get the run_ids given the other filtering options...</span>
    <span class="i">$retrieve_args</span>{-<span class="w">distinct</span>} = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%run_data</span><span class="sc">;</span>
    <span class="i">%run_data</span> = <span class="i">%</span>{ <span class="i">$self</span><span class="i">-&gt;get_run_data</span><span class="s">(</span><span class="i">%retrieve_args</span><span class="s">)</span> } <span class="k">if</span> <span class="k">defined</span> <span class="i">$self</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%ids</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$run_data</span>{<span class="w">multiplex_run_id</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt;= <span class="i">$#</span>{ <span class="i">$run_data</span>{<span class="w">multiplex_run_id</span>} }<span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
            <span class="i">$ids</span>{ <span class="i">$run_data</span>{<span class="w">multiplex_adapter_index</span>}[<span class="i">$i</span>] } = <span class="i">$run_data</span>{<span class="w">multiplex_run_id</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">for</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%run_data</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$run_data</span>{<span class="i">$key</span>}{<span class="w">multiplex_run_id</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="i">$ids</span>{ <span class="i">$run_data</span>{<span class="i">$key</span>}{<span class="w">multiplex_adapter_index</span>} } = <span class="i">$run_data</span>{<span class="i">$key</span>}{<span class="w">multiplex_run_id</span>}<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@valid_field_list</span><span class="sc">;</span>
    <span class="k">if</span>   <span class="s">(</span><span class="i">$valid_fields</span><span class="s">)</span> <span class="s">{</span> <span class="i">@valid_field_list</span> = <span class="i">@$valid_fields</span> <span class="s">}</span>
    <span class="k">else</span>                 <span class="s">{</span> <span class="i">@valid_field_list</span> = <span class="q">qw(Multiplex_Run_QC_Status)</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">keys</span> <span class="i">%ids</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;No multiplex runs found&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@adapter_index_array</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$adapter_index</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields_array</span>        = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span>        -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values_array</span>        = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$values</span><span class="cm">,</span>        -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@comment_array</span>       = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$comment</span><span class="cm">,</span>       -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#check to see if all array size the same if not, do not procced</span>
    <span class="k">my</span> <span class="i">%size</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id_size</span> = <span class="k">keys</span> <span class="i">%ids</span><span class="sc">;</span>
    <span class="i">$size</span>{ <span class="i">$id_size</span> - <span class="n">1</span> } = <span class="n">1</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$size</span>{<span class="i">$#adapter_index_array</span>} || !<span class="i">$size</span>{<span class="i">$#fields_array</span>} || !<span class="i">$size</span>{<span class="i">$#values_array</span>} || !<span class="i">$size</span>{<span class="i">$#comment_array</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;Inconsistent number of entries&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$update</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span>  = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt;= <span class="i">$#adapter_index_array</span><span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$ids</span>{ <span class="i">$adapter_index_array</span>[<span class="i">$i</span>] } <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>
        <span class="k">my</span> <span class="i">$set_condition_one</span> = <span class="q">&quot;WHERE 1 AND Multiplex_Run_ID IN ($ids{$adapter_index_array[$i]})&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$adapter_index_one</span> = <span class="i">$adapter_index_array</span>[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$field</span>             = <span class="i">$fields_array</span>[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$value</span>             = <span class="i">$values_array</span>[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$comment_one</span>       = <span class="i">$comment_array</span>[<span class="i">$i</span>]<span class="sc">;</span>

        <span class="k">unless</span> <span class="s">(</span><span class="i">$force</span><span class="s">)</span> <span class="s">{</span>
            <span class="c">## check to see if the multiplex run analysis already has comments or qc status set</span>
            <span class="k">my</span> <span class="i">$runs</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">@qc_status</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Multiplex_Run'</span><span class="cm">,</span> <span class="q">'Multiplex_Run_QC_Status'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Run__ID IN ($runs) and Adapter_Index = '$adapter_index_one'&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">@qc_status</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$qc_set</span> = <span class="n">0</span><span class="sc">;</span>
                <span class="k">foreach</span> <span class="k">my</span> <span class="i">$qc_status</span> <span class="s">(</span><span class="i">@qc_status</span><span class="s">)</span> <span class="s">{</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="i">$qc_status</span> <span class="k">ne</span> <span class="q">'N/A'</span> <span class="k">and</span> <span class="k">length</span><span class="s">(</span><span class="i">$qc_status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
                        <span class="i">$qc_set</span> = <span class="n">1</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$qc_set</span><span class="s">)</span> <span class="s">{</span>

                    <span class="c">#return 0;</span>
                    <span class="k">next</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">my</span> <span class="i">$updated</span> = <span class="i">$self</span><span class="i">-&gt;set_data</span><span class="s">(</span>
            -<span class="w">table</span>        <span class="cm">=&gt;</span> <span class="i">$table</span><span class="cm">,</span>
            -<span class="w">fields</span>       <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">$field</span><span class="s">]</span><span class="cm">,</span>
            -<span class="w">values</span>       <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">$value</span><span class="s">]</span><span class="cm">,</span>
            -<span class="w">condition</span>    <span class="cm">=&gt;</span> <span class="i">$set_condition_one</span><span class="cm">,</span>
            -<span class="w">valid_fields</span> <span class="cm">=&gt;</span> \<span class="i">@valid_field_list</span><span class="cm">,</span>
            -<span class="w">quiet</span>        <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
            -<span class="w">debug</span>        <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span>
            -<span class="w">comment</span>      <span class="cm">=&gt;</span> <span class="i">$comment_one</span><span class="cm">,</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;updated $updated Run records&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="i">$update</span> += <span class="i">$updated</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$update</span><span class="cm">,</span> -<span class="w">summary</span> <span class="cm">=&gt;</span> <span class="q">&quot;Updated $update Run records&quot;</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># Accessor for starting run analysis through the API</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="start_run_analysis-"></a><span class="k">sub </span><span class="m">start_run_analysis</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>                   = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'run_id,pipeline_id'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'run_id,pipeline_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_id</span>                 = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$barcode_index</span>          = <span class="i">$args</span>{-<span class="w">barcode_index</span>}<span class="sc">;</span>                                                                     <span class="c">## optional list of indices</span>
    <span class="k">my</span> <span class="i">$pipeline_id</span>            = <span class="i">$args</span>{-<span class="w">pipeline_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$force</span>                  = <span class="i">$args</span>{-<span class="w">force</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parent_run_analysis_id</span> = <span class="i">$args</span>{-<span class="w">parent_run_analysis_id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$analysis_type</span> = <span class="q">'Tertiary'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span>         = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">require</span> <span class="w">alDente::Run_Analysis</span><span class="sc">;</span>
    <span class="k">require</span> <span class="w">BWA::Run_Analysis</span><span class="sc">;</span>                                                                                              <span class="c">## &lt;CONSTRUCTION&gt; may want to change scope of create_multiplex_analysis</span>
    <span class="k">my</span> <span class="i">$run_analysis_obj</span> = <span class="i">new</span> <span class="i">alDente::Run_Analysis</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$bwa_run_analysis</span> = <span class="i">new</span> <span class="i">BWA::Run_Analysis</span><span class="s">(</span> -<span class="w">dbc</span>     <span class="cm">=&gt;</span> <span class="i">$self</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_analysis_id</span> = <span class="i">$run_analysis_obj</span><span class="i">-&gt;start_run_analysis</span><span class="s">(</span> -<span class="w">run_id</span> <span class="cm">=&gt;</span> <span class="i">$run_id</span><span class="cm">,</span> -<span class="w">analysis_pipeline_id</span> <span class="cm">=&gt;</span> <span class="i">$pipeline_id</span><span class="cm">,</span> -<span class="w">run_analysis_type</span> <span class="cm">=&gt;</span> <span class="q">'Tertiary'</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="i">$force</span><span class="cm">,</span> -<span class="w">parent_run_analysis_id</span> <span class="cm">=&gt;</span> <span class="i">$parent_run_analysis_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$barcode_index</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$bwa_run_analysis</span><span class="i">-&gt;create_multiplex_run_analysis</span><span class="s">(</span> -<span class="w">run_analysis_id</span> <span class="cm">=&gt;</span> <span class="i">$run_analysis_id</span><span class="cm">,</span> -<span class="w">index</span> <span class="cm">=&gt;</span> <span class="i">$barcode_index</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$run_analysis_obj</span><span class="i">-&gt;run_analysis</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$run_analysis_id</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># Accessor for finishing run analysis through the API</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="finish_run_analysis-"></a><span class="k">sub </span><span class="m">finish_run_analysis</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>                = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'run_analysis_id,run_analysis_status'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'run_analysis_id,run_analysis_status'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_analysis_id</span>     = <span class="i">$args</span>{-<span class="w">run_analysis_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_analysis_status</span> = <span class="i">$args</span>{-<span class="w">run_analysis_status</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">require</span> <span class="w">alDente::Run_Analysis</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_analysis_obj</span> = <span class="i">new</span> <span class="i">alDente::Run_Analysis</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$pipeline_step_id</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Analysis_Step&quot;</span><span class="cm">,</span> <span class="q">&quot;FK_Pipeline_Step__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Run_Analysis__ID = $run_analysis_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$run_analysis_obj</span><span class="i">-&gt;finish_analysis_step</span><span class="s">(</span> -<span class="w">run_analysis_id</span> <span class="cm">=&gt;</span> <span class="i">$run_analysis_id</span><span class="cm">,</span> -<span class="w">pipeline_step_id</span> <span class="cm">=&gt;</span> <span class="i">$pipeline_step_id</span><span class="cm">,</span> -<span class="w">analysis_step_status</span> <span class="cm">=&gt;</span> <span class="i">$run_analysis_status</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$pipeline_step_id</span><span class="sc">;</span>

    <span class="i">$run_analysis_obj</span><span class="i">-&gt;finish_run_analysis</span><span class="s">(</span> -<span class="w">run_analysis_id</span> <span class="cm">=&gt;</span> <span class="i">$run_analysis_id</span><span class="cm">,</span> -<span class="w">run_analysis_status</span> <span class="cm">=&gt;</span> <span class="i">$run_analysis_status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span> = <span class="q">&quot;Run_Analysis $run_analysis_id set to $run_analysis_status&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$output</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># New method to simplify run data extraction (avoids complexity of _generate_query method)</span>
<span class="c"># (this style should replace all of the other API methods as well to simplify maintenance / debugging.</span>
<span class="c">#</span>
<span class="c"># Return: hash of data</span>
<span class="c">#####################</span>
<a name="get_event_data-"></a><span class="k">sub </span><span class="m">get_event_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'study_id|project_id|library|run_id|run_name|plate_id|plate_number|original_plate_id|applied_plate_id|sample_id|since|condition|limit|protocol|protocol_step'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_condition</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$study_id</span>        = <span class="i">$args</span>{-<span class="w">study_id</span>}<span class="sc">;</span>            <span class="c">### a study id (a defined set of libraries/projects)</span>
    <span class="k">my</span> <span class="i">$project_id</span>      = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>          <span class="c">### specify project_id</span>
    <span class="k">my</span> <span class="i">$library</span>         = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>             <span class="c">### specify library</span>
    <span class="c">## run specification options</span>
    <span class="k">my</span> <span class="i">$run_id</span>         = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>               <span class="c">### specify run id</span>
    <span class="k">my</span> <span class="i">$run_name</span>       = <span class="i">$args</span>{-<span class="w">run_name</span>}<span class="sc">;</span>             <span class="c">### specify run name (must be exact format)</span>
    <span class="k">my</span> <span class="i">$exclude_run_id</span> = <span class="i">$args</span>{-<span class="w">exclude_run_id</span>}<span class="sc">;</span>       <span class="c">### specify run id to EXCLUDE (for Run or Read scope)</span>
    <span class="c">## plate specification options</span>
    <span class="k">my</span> <span class="i">$plate_id</span>          = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                   <span class="c">### specify plate_id</span>
    <span class="k">my</span> <span class="i">$plate_number</span>      = <span class="i">$args</span>{-<span class="w">plate_number</span>}<span class="sc">;</span>               <span class="c">### specify plate number</span>
    <span class="k">my</span> <span class="i">$plate_type</span>        = <span class="i">$args</span>{-<span class="w">plate_type</span>} || <span class="q">''</span><span class="sc">;</span>           <span class="c">### specify type of plate (tube or Library_Plate)</span>
    <span class="k">my</span> <span class="i">$plate_class</span>       = <span class="i">$args</span>{-<span class="w">plate_class</span>} || <span class="q">''</span><span class="sc">;</span>          <span class="c">### specify class of plate (clone or extraction)</span>
    <span class="k">my</span> <span class="i">$plate_application</span> = <span class="i">$args</span>{-<span class="w">plate_application</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c">### specify application of plate (Sequencing/Mapping/PCR)</span>
    <span class="k">my</span> <span class="i">$original_plate_id</span> = <span class="i">$args</span>{-<span class="w">original_plate_id</span>}<span class="sc">;</span>          <span class="c">### specify original plate id</span>
    <span class="k">my</span> <span class="i">$original_well</span>     = <span class="i">$args</span>{-<span class="w">original_well</span>}<span class="sc">;</span>              <span class="c">### specify original well</span>
    <span class="k">my</span> <span class="i">$applied_plate_id</span>  = <span class="i">$args</span>{-<span class="w">applied_plate_id</span>}<span class="sc">;</span>           <span class="c">### specify original plate id (including ReArrays)</span>
    <span class="k">my</span> <span class="i">$quadrant</span>          = <span class="i">$args</span>{-<span class="w">quadrant</span>}<span class="sc">;</span>                   <span class="c">### specify quadrant from original plate</span>
    <span class="k">my</span> <span class="i">$sample_id</span>         = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>                  <span class="c">### specify sample_id</span>
    <span class="k">my</span> <span class="i">$library_type</span>      = <span class="i">$args</span>{-<span class="w">library_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_conditions</span>  = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_joins</span>       = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span>  = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>
    <span class="c">## Custom additions for this method ##</span>
    <span class="k">my</span> <span class="i">$solution_id</span>     = <span class="i">$args</span>{-<span class="w">solution_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$equipment_id</span>    = <span class="i">$args</span>{-<span class="w">equipment_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$protocol</span>        = <span class="i">$args</span>{-<span class="w">protocol</span>}<span class="sc">;</span>                     <span class="c">### protocol name</span>
    <span class="k">my</span> <span class="i">$protocol_step</span>   = <span class="i">$args</span>{-<span class="w">protocol_step</span>}<span class="sc">;</span>                <span class="c">### protocol step name</span>
    <span class="k">my</span> <span class="i">$plate_format</span>    = <span class="i">$args</span>{-<span class="w">plate_format</span>}<span class="sc">;</span>                 <span class="c">### plate format</span>
    <span class="k">my</span> <span class="i">$include_parents</span> = <span class="i">$args</span>{-<span class="w">include_parents</span>}<span class="sc">;</span>              <span class="c">### check for events applied to parent plates as well</span>
    <span class="k">my</span> <span class="i">$include_source</span>  = <span class="i">$args</span>{-<span class="w">include_source</span>}<span class="sc">;</span>               <span class="c">### check for events applied to parent plates of redefined source plates as well</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                                  <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                                <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">'Prep_DateTime'</span><span class="sc">;</span>

            <span class="c">#    my $include    = $args{-include} || 0;                        ### specify data to include (eg. production,approved)</span>
            <span class="k">my</span> <span class="i">$exclude</span> = <span class="i">$args</span>{-<span class="w">exclude</span>} || <span class="n">0</span><span class="sc">;</span>                 <span class="c">### OR specify data to exclude (eg. failed)</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>     = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span> = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>      = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>      = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>        = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>                                        <span class="c"># || $group;</span>
            <span class="k">my</span> <span class="i">$limit</span>      = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>      = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>

            <span class="c">### Re-Cast arguments if necessary ###</span>
            <span class="k">my</span> <span class="i">$libs</span><span class="sc">;</span>
            <span class="i">$libs</span> = <span class="i">$self</span><span class="i">-&gt;get_libraries</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$study_id</span> || <span class="i">$project_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$libs</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span><span class="sc">;</span>
    <span class="i">$plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_id</span> &amp;&amp; <span class="i">$include_parents</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$plates</span> = <span class="i">&amp;alDente::Container::get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span><span class="cm">,</span> -<span class="w">simple</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">include_source</span> <span class="cm">=&gt;</span> <span class="i">$include_source</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$plate_numbers</span><span class="sc">;</span>
    <span class="i">$plate_numbers</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_number</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_number</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$runs</span><span class="sc">;</span>
    <span class="i">$runs</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_names</span><span class="sc">;</span>
    <span class="i">$run_names</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_name</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_name</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$samples</span><span class="sc">;</span>
    <span class="i">$samples</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$sample_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_types</span><span class="sc">;</span>
    <span class="i">$library_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library_type</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$solutions</span><span class="sc">;</span>
    <span class="i">$solutions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$solution_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$solution_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$equipment</span><span class="sc">;</span>
    <span class="i">$equipment</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$equipment_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$equipment_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$protocols</span><span class="sc">;</span>
    <span class="i">$protocols</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$protocol</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_formats</span><span class="sc">;</span>
    <span class="i">$plate_format</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_format</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_format</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>

<span class="c">##########################################</span>
    <span class="c"># Retrieve Record Data from the Database #</span>
<span class="c">##########################################</span>

    <span class="k">my</span> <span class="i">$tables</span>         = <span class="q">'Lab_Protocol,Prep'</span><span class="sc">;</span>                                <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE Prep.FK_Lab_Protocol__ID=Lab_Protocol_ID'</span><span class="sc">;</span>
    <span class="c">## Generate Condition ##</span>

    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>

    <span class="c">## specify optional tables to include (with associated condition) - used in 'include_if_necessary' method ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="q">'Plate'</span>        <span class="cm">=&gt;</span> <span class="q">&quot;Plate_Prep.FK_Plate__ID=Plate_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Plate_Format'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Plate_Format.Plate_Format_ID = Plate.FK_Plate_Format__ID&quot;</span><span class="cm">,</span>
        <span class="q">'Plate_Prep'</span>   <span class="cm">=&gt;</span> <span class="q">&quot;Plate_Prep.FK_Prep__ID=Prep_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Library'</span>      <span class="cm">=&gt;</span> <span class="q">&quot;Plate.FK_Library__Name = Library.Library_Name&quot;</span><span class="cm">,</span>
        <span class="q">'Run'</span>          <span class="cm">=&gt;</span> <span class="q">&quot;Run.FK_Plate__ID = Plate.Plate_ID&quot;</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">'Solution'</span>  <span class="cm">=&gt;</span> <span class="q">&quot;Plate_Prep.FK_Solution__ID=Solution_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Equipment'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Plate_Prep.FK_Equipment__ID=Equipment_ID&quot;</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>    <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$libraries</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plates</span><span class="s">)</span>              <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_ID IN ($plates)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_numbers</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_Number IN ($plate_numbers)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$runs</span><span class="s">)</span>                <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Run_ID IN ($runs)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$samples</span><span class="s">)</span>             <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Clone_Sequence.FK_Sample__ID IN ($samples)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$library_types</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;(Vector_Based_Library.Vector_Based_Library_Type IN ($library_types) OR Library_Type IN ($library_types))&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$solutions</span><span class="s">)</span>           <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Prep.FK_Solution__ID IN ($solutions)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$equipment</span><span class="s">)</span>           <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Prep.FK_Equipment__ID IN ($equipment)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$protocols</span><span class="s">)</span>           <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Lab_Protocol.Lab_Protocol_Name IN ($protocols)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$protocol_step</span><span class="s">)</span>       <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Prep.Prep_Name like \&quot;%$protocol_step%\&quot;&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_format</span><span class="s">)</span>        <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Format.Plate_Format_Type IN ($plate_formats)&quot;</span> <span class="s">)</span> <span class="s">}</span>

    <span class="c">## Special inclusion / exclusion options ##</span>
    <span class="c">#    if ($since) { push(@extra_conditions,&quot;Run_DateTime &gt;= '$since'&quot;) }</span>
    <span class="c">#    if ($until)  { push(@extra_conditions,&quot;Run_DateTime &lt;= '$until'&quot;) }</span>

    <span class="c">## Retrieve list of applicable Experiments / Runs ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="c">## actually this is the same logic as get_read_data, but looking at slightly different info ...</span>
    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(event event_time event_comments)</span><span class="sc">;</span>
    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">date_field</span>           <span class="cm">=&gt;</span> <span class="q">&quot;Prep.Prep_DateTime&quot;</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<a name="get_original_reagents-"></a><span class="k">sub </span><span class="m">get_original_reagents</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>        = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'solution_id'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'solution_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$solution_id</span> = <span class="i">$args</span>{-<span class="w">solution_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$class</span>       = <span class="i">$args</span>{-<span class="w">class</span>}<span class="sc">;</span>                                                               <span class="c">### To filter original reagents based on Stock_Type. E.g. Primer</span>

    <span class="k">my</span> <span class="i">@field_list</span>     = <span class="q">qw(FKUsed_Solution__ID Stock_Catalog_Name Stock_Type)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$conditions</span>     = <span class="q">&quot;FKMade_Solution__ID in ($solution_id)&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tables</span>         = <span class="q">'Stock_Catalog,Stock,Solution as Made,Mixture,Solution as Used'</span><span class="sc">;</span>                                                                                                    <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">'WHERE FK_Stock_Catalog__ID = Stock_Catalog_ID AND FKMade_Solution__ID=Made.Solution_ID AND FKUsed_Solution__ID=Used.Solution_ID AND Used.FK_Stock__ID=Stock_ID'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$alldata</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$used_list</span> = <span class="i">$solution_id</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="i">$used_list</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$data</span> = <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
            -<span class="w">input</span>          <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
            -<span class="w">field_list</span>     <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
            -<span class="w">tables</span>         <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
            -<span class="w">conditions</span>     <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
            -<span class="w">join_condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span> <span class="i">$data</span>-&gt;{<span class="w">Stock_Catalog_Name</span>} <span class="k">eq</span> <span class="q">'ARRAY'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">Stock_Catalog_Name</span>} }<span class="cm">,</span>  <span class="i">@</span>{ <span class="i">$data</span>-&gt;{<span class="w">Stock_Catalog_Name</span>} }<span class="sc">;</span>
            <span class="k">push</span> <span class="i">@</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">FKUsed_Solution__ID</span>} }<span class="cm">,</span> <span class="i">@</span>{ <span class="i">$data</span>-&gt;{<span class="w">FKUsed_Solution__ID</span>} }<span class="sc">;</span>
            <span class="k">push</span> <span class="i">@</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">Stock_Type</span>} }<span class="cm">,</span>          <span class="i">@</span>{ <span class="i">$data</span>-&gt;{<span class="w">Stock_Type</span>} } <span class="k">if</span> <span class="i">$class</span><span class="sc">;</span>
            <span class="i">$used_list</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$data</span>-&gt;{<span class="w">FKUsed_Solution__ID</span>} }<span class="sc">;</span>
            <span class="i">$conditions</span> = <span class="q">&quot;FKMade_Solution__ID in ($used_list)&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span> <span class="i">$used_list</span> = <span class="q">''</span><span class="sc">;</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">#take out non-unique solutions</span>
    <span class="k">my</span> <span class="i">%unique</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$count</span> = <span class="i">$#</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">FKUsed_Solution__ID</span>} }<span class="sc">;</span>
    <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt;= <span class="i">$count</span><span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$unique</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">FKUsed_Solution__ID</span>}[<span class="i">$i</span>] } || <span class="s">(</span> <span class="i">$class</span> &amp;&amp; <span class="i">$alldata</span>-&gt;{<span class="w">Stock_Type</span>}[<span class="i">$i</span>] <span class="k">ne</span> <span class="i">$class</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">splice</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">FKUsed_Solution__ID</span>} }<span class="cm">,</span> <span class="i">$i</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">splice</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">Stock_Catalog_Name</span>} }<span class="cm">,</span>  <span class="i">$i</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">splice</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">Stock_Type</span>} }<span class="cm">,</span>          <span class="i">$i</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$class</span><span class="sc">;</span>
            <span class="i">$count</span> = <span class="i">$#</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">FKUsed_Solution__ID</span>} }<span class="sc">;</span>
            <span class="i">$i</span>--<span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span> <span class="i">$unique</span>{ <span class="i">$alldata</span>-&gt;{<span class="w">FKUsed_Solution__ID</span>}[<span class="i">$i</span>] } = <span class="n">1</span><span class="sc">;</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$alldata</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##########################</span>
<a name="get_gelrun_summary-"></a><span class="k">sub </span><span class="m">get_gelrun_summary</span> <span class="s">{</span>
<span class="c">##########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;convert_parameters_for_summary</span><span class="s">(</span> -<span class="w">scope</span> <span class="cm">=&gt;</span> <span class="q">'gelrun'</span><span class="cm">,</span> <span class="i">%args</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Gel Run Data</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#####################</span>
<a name="get_gelrun_data-"></a><span class="k">sub </span><span class="m">get_gelrun_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$fields</span>          = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>      = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group_id</span>        = <span class="i">$args</span>{-<span class="w">group_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$billable</span>        = <span class="i">$args</span>{-<span class="w">billable</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_status</span>      = <span class="i">$args</span>{-<span class="w">run_status</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_validation</span>  = <span class="i">$args</span>{-<span class="w">run_validation</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$analysis_status</span> = <span class="i">$args</span>{-<span class="w">analysis_status</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$gelrun_purpose</span>  = <span class="i">$args</span>{-<span class="w">gelrun_purpose</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$gel_name</span>        = <span class="i">$args</span>{-<span class="w">Gel_Name</span>}<span class="sc">;</span>          <span class="c">### If Gel_Name has been passed, return the Approved, Non-aborted/non-failed run</span>
    <span class="k">my</span> <span class="i">$gelrun_type</span>     = <span class="i">$args</span>{-<span class="w">type</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@input_conditions</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$gelrun_purpose</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$gelrun_purposes</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$gelrun_purpose</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@input_conditions</span><span class="cm">,</span> <span class="q">&quot;GelRun_Purpose.GelRun_Purpose_Name IN ($gelrun_purposes)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$analysis_status</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@input_conditions</span><span class="cm">,</span> <span class="q">&quot;Gel_Analysis_Status.Status_Name='$analysis_status'&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$group_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@input_conditions</span><span class="cm">,</span> <span class="q">&quot;Pipeline.FK_Grp__ID in ($group_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$billable</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@input_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Billable in ($billable)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$gel_name</span> <span class="k">and</span> <span class="s">(</span> <span class="i">$run_status</span> <span class="k">or</span> <span class="i">$run_validation</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Cant specify both Gel_Name, and Run_Status or Run Validation&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$gel_name</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$run_validation</span> = <span class="q">'Approved'</span><span class="sc">;</span>
        <span class="i">$run_status</span>     = <span class="q">'Initiated,In Process,Data Acquired,Analyzed,Analyzing'</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@input_conditions</span><span class="cm">,</span> <span class="q">&quot;Gel_Name='$gel_name'&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$run_status</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$run_status</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_status</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@input_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Run_Status in ($run_status)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$run_validation</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$run_validation</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_validation</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@input_conditions</span><span class="cm">,</span> <span class="q">&quot;Run.Run_Validation in ($run_validation)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$gelrun_type</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@input_conditions</span><span class="cm">,</span> <span class="q">&quot;GelRun.GelRun_Type IN ($gelrun_type)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(run_time run_name run_status plate_id library plate_number gel_type)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$args</span>{-<span class="w">fields</span>} = \<span class="i">@field_list</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$input_joins</span><span class="sc">;</span>

    <span class="i">$args</span>{-<span class="w">tables</span>} = <span class="q">'Run,GelRun'</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@input_conditions</span><span class="cm">,</span> <span class="q">'GelRun.FK_Run__ID=Run_ID'</span><span class="sc">;</span>

    <span class="i">$args</span>{-<span class="w">condition</span>} = \<span class="i">@input_conditions</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$input_left_joins</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Plate'</span>}                         = <span class="q">'Run.FK_Plate__ID = Plate.Plate_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Library'</span>}                       = <span class="q">'Plate.FK_Library__Name = Library.Library_Name'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Project'</span>}                       = <span class="q">'Library.FK_Project__ID = Project.Project_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'GelAnalysis'</span>}                   = <span class="q">'GelAnalysis.FK_Run__ID = Run.Run_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Equipment AS CombEquipment'</span>}    = <span class="q">'GelRun.FKComb_Equipment__ID = CombEquipment.Equipment_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Equipment AS PouredEquipment'</span>}  = <span class="q">'GelRun.FKAgarosePour_Equipment__ID = PouredEquipment.Equipment_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Equipment AS BoxEquipment'</span>}     = <span class="q">'GelRun.FKGelBox_Equipment__ID = BoxEquipment.Equipment_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Equipment AS ScannerEquipment'</span>} = <span class="q">'RunBatch.FK_Equipment__ID = ScannerEquipment.Equipment_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Employee AS PouredEmployee'</span>}    = <span class="q">'GelRun.FKPoured_Employee__ID = PouredEmployee.Employee_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Employee AS LoadedEmployee'</span>}    = <span class="q">'RunBatch.FK_Employee__ID = LoadedEmployee.Employee_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Rack AS GelRack'</span>}               = <span class="q">'Run.FKPosition_Rack__ID = GelRack.Rack_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Status AS Gel_Analysis_Status'</span>} = <span class="q">'GelAnalysis.FK_Status__ID = Gel_Analysis_Status.Status_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Pipeline'</span>}                      = <span class="q">'Plate.FK_Pipeline__ID = Pipeline.Pipeline_ID'</span><span class="sc">;</span>

    <span class="c"># &lt;CONSTRUCTION&gt; dynamically determine Object_Class_ID?</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'FailReason'</span>}     = <span class="q">'Fail.FK_FailReason__ID = FailReason.FailReason_ID AND FailReason.FK_Object_Class__ID = 7'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Fail'</span>}           = <span class="q">'Fail.Object_ID = GelRun.GelRun_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'GelRun_Purpose'</span>} = <span class="q">'GelRun.FK_GelRun_Purpose__ID = GelRun_Purpose.GelRun_Purpose_ID'</span><span class="sc">;</span>

    <span class="i">$args</span>{-<span class="w">input_joins</span>}      = <span class="i">$input_joins</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">input_left_joins</span>} = <span class="i">$input_left_joins</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">date_format</span>}      = <span class="q">'SQL'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$data</span>  = <span class="i">$self</span><span class="i">-&gt;get_run_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## access method in general</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> <span class="i">$data</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">sql</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################################</span>
<span class="c"># Like get_gelrun_data, but increased degree of focus to include land info.</span>
<span class="c">#</span>
<span class="c">#####################</span>
<a name="get_lane_data-"></a><span class="k">sub </span><span class="m">get_lane_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$alias_type</span>  = <span class="i">$args</span>{-<span class="w">alias_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fail_reason</span> = <span class="i">$args</span>{-<span class="w">fail_reason</span>}<span class="sc">;</span>    <span class="c">### Retrieve lanes failed with '%$fail_reason%'</span>
    <span class="k">my</span> <span class="i">$lane_status</span> = <span class="i">$args</span>{-<span class="w">lane_status</span>}<span class="sc">;</span>    <span class="c">### Filter out by the given lane status</span>

    <span class="c">## common options understood by get_run_data (see alDente_API::get_run_data for more options) ##</span>
    <span class="k">my</span> <span class="i">$run_id</span>           = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>                                            <span class="c">### specify run id</span>
    <span class="k">my</span> <span class="i">$library</span>          = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>                                           <span class="c">### specify library</span>
    <span class="k">my</span> <span class="i">$group_by</span>         = <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="q">'Lane_ID'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@condition</span>        = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">condition</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span> <span class="q">'run_name'</span><span class="cm">,</span> <span class="q">'run_time'</span><span class="cm">,</span> <span class="q">'lane_sample'</span><span class="cm">,</span> <span class="q">'lane_status'</span><span class="cm">,</span> <span class="q">'well'</span><span class="cm">,</span> <span class="q">'size_estimate'</span><span class="cm">,</span> <span class="q">'band_size'</span><span class="cm">,</span> <span class="q">'band_number'</span><span class="cm">,</span> <span class="q">'band_intensity'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$lane_status</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@condition</span><span class="cm">,</span> <span class="q">&quot;Lane.Lane_Status='$lane_status'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$fail_reason</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@condition</span><span class="cm">,</span> <span class="q">&quot;FailReason.FailReason_Name LIKE '%$fail_reason%'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">### Over ride the grouping for get_run_data if multiple failed lanes exist in the database</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$lane_status</span> =~ <span class="q">/failed/i</span> <span class="k">or</span> <span class="i">$fail_reason</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$group_by</span> .= <span class="q">',Fail.Fail_ID'</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$lane_object_id</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Object_Class'</span><span class="cm">,</span> <span class="q">'Object_Class_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Object_Class='Lane'&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$args</span>{-<span class="w">fields</span>} = \<span class="i">@field_list</span><span class="sc">;</span>

    <span class="i">$input_joins</span>-&gt;{<span class="q">'GelRun'</span>} = <span class="q">'GelRun.FK_Run__ID = Run.Run_ID'</span><span class="sc">;</span>
    <span class="i">$input_joins</span>-&gt;{<span class="q">'Sample'</span>} = <span class="q">'Sample.Sample_ID = Lane.FK_Sample__ID'</span><span class="sc">;</span>
    <span class="i">$input_joins</span>-&gt;{<span class="q">'Lane'</span>}   = <span class="q">'Lane.FK_GelRun__ID = GelRun.GelRun_ID'</span><span class="sc">;</span>

    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Equipment AS CombEquipment'</span>}    = <span class="q">'GelRun.FKComb_Equipment__ID = CombEquipment.Equipment_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Equipment AS BoxEquipment'</span>}     = <span class="q">'GelRun.FKGelBox_Equipment__ID = BoxEquipment.Equipment_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Equipment AS ScannerEquipment'</span>} = <span class="q">'RunBatch.FK_Equipment__ID = ScannerEquipment.Equipment_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Employee AS PouredEmployee'</span>}    = <span class="q">'GelRun.FKPoured_Employee__ID = PouredEmployee.Employee_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Employee AS LoadedEmployee'</span>}    = <span class="q">'RunBatch.FK_Employee__ID = LoadedEmployee.Employee_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Rack AS GelRack'</span>}               = <span class="q">'Run.FKPosition_Rack__ID = GelRack.Rack_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Status AS Gel_Analysis_Status'</span>} = <span class="q">'GelAnalysis.FK_Status__ID = Gel_Analysis_Status.Status_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Fail'</span>}                          = <span class="q">'Lane.Lane_ID = Fail.Object_ID'</span><span class="sc">;</span>
    <span class="i">$input_left_joins</span>-&gt;{<span class="q">'FailReason'</span>}                    = <span class="q">&quot;FailReason.FailReason_ID = Fail.FK_FailReason__ID AND Fail.FK_Object_Class__ID=$lane_object_id&quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$alias_type</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$input_left_joins</span>-&gt;{<span class="q">'Sample_Alias'</span>} = <span class="q">&quot;Lane.FK_Sample__ID = Sample_Alias.FK_Sample__ID&quot;</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'alias_name'</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@condition</span><span class="cm">,</span>  <span class="q">&quot;Sample_Alias.Alias_Type='$alias_type'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$args</span>{-<span class="w">input_joins</span>}      = <span class="i">$input_joins</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">input_left_joins</span>} = <span class="i">$input_left_joins</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">date_format</span>}      = <span class="q">'SQL'</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">group_by</span>}         = <span class="i">$group_by</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">condition</span>}        = \<span class="i">@condition</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_run_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## access method in general</span>
<span class="s">}</span>

<span class="c">####################################</span>
<span class="c"># Like get_gelrun_data, but increased degree of focus to include band info.</span>
<span class="c">#</span>
<span class="c">#####################</span>
<a name="get_band_data-"></a><span class="k">sub </span><span class="m">get_band_data</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$fields</span>           = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>       = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## common options understood by get_run_data (see alDente_API::get_run_data for more options) ##</span>
    <span class="k">my</span> <span class="i">$run_id</span>  = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>     <span class="c">### specify run id</span>
    <span class="k">my</span> <span class="i">$library</span> = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>    <span class="c">### specify library</span>

    <span class="k">my</span> <span class="i">$group_by</span> = <span class="q">'Band_ID'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(sample_id band_size band_number band_intensity band_type)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$input_joins</span>-&gt;{<span class="q">'Band'</span>} = <span class="q">'Lane.Lane_ID = Band.FK_Lane__ID'</span><span class="sc">;</span>

    <span class="i">$args</span>{-<span class="w">fields</span>}      = \<span class="i">@field_list</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">input_joins</span>} = <span class="i">$input_joins</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">group_by</span>}    = <span class="i">$group_by</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_lane_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## access method in general</span>
<span class="s">}</span>
<span class="c">#####################</span>
<span class="c"># Find out solution information applied to a plate or during a prep</span>
<span class="c">#  &lt;snip&gt;</span>
<span class="c">#   Example:</span>
<span class="c">#      my $data = $API-&gt;get_application_data(-plate_id=&gt;$plate);</span>
<span class="c">#  &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">######################</span>
<a name="get_application_data-"></a><span class="k">sub </span><span class="m">get_application_data</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$fields</span>           = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_fields</span>       = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>} || <span class="s">{</span><span class="s">}</span><span class="sc">;</span>    <span class="c">## specific join table conditions ...</span>
    <span class="k">my</span> <span class="i">$left_joins</span>       = <span class="i">$args</span>{-<span class="w">left_joins</span>} || <span class="s">{</span><span class="s">}</span><span class="sc">;</span>     <span class="c">## specific join table conditions ...</span>
    <span class="k">my</span> <span class="i">$include_parents</span>  = <span class="i">$args</span>{-<span class="w">include_parents</span>}<span class="sc">;</span>      <span class="c">## include solutions applied to parent plates</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>             = <span class="i">$args</span>{-<span class="w">type</span>}<span class="sc">;</span>

    <span class="i">$input_joins</span>-&gt;{<span class="q">'Solution'</span>}            = <span class="q">'Solution.Solution_ID=Plate_Prep.FK_Solution__ID'</span><span class="sc">;</span>
    <span class="i">$input_joins</span>-&gt;{<span class="q">'Stock'</span>}               = <span class="q">'Solution.FK_Stock__ID=Stock.Stock_ID'</span><span class="sc">;</span>
    <span class="i">$input_joins</span>-&gt;{<span class="q">'Stock_Catalog'</span>}       = <span class="q">'Stock_Catalog.Stock_Catalog_ID = Stock.FK_Stock_Catalog__ID'</span><span class="sc">;</span>
    <span class="i">$input_joins</span>-&gt;{<span class="q">'Employee as Prepper'</span>} = <span class="q">'Prep.FK_Employee__ID=Prepper.Employee_ID'</span><span class="sc">;</span>
    <span class="i">$input_joins</span>-&gt;{<span class="q">'Primer'</span>}              = <span class="q">'Primer.Primer_Name = Stock_Catalog.Stock_Catalog_Name'</span><span class="sc">;</span>         <span class="c">## will only include primers if Primer fields are requested ##</span>

    <span class="k">my</span> <span class="i">$types</span><span class="sc">;</span>
    <span class="i">$types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$type</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(event application_time applied_by event_comments solution_id solution_name)</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'stock_id'</span><span class="cm">,</span> <span class="q">'solution_id'</span><span class="cm">,</span> <span class="q">'stock_name'</span><span class="cm">,</span> <span class="q">'count(*) as plates'</span><span class="cm">,</span> <span class="q">'GROUP_CONCAT(plate_id) as plate_list'</span><span class="cm">,</span> <span class="q">'applied_qty'</span><span class="cm">,</span> <span class="q">'plate_set_number'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Solution.Solution_Type IN ($types)&quot;</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$types</span><span class="sc">;</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$args</span>{-<span class="w">fields</span>}           = \<span class="i">@field_list</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">input_joins</span>}      = <span class="i">$input_joins</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">input_left_joins</span>} = <span class="i">$left_joins</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">condition</span>}        = \<span class="i">@extra_conditions</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_event_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################################################</span>
<span class="c">## methods to facilitate automated query generation ##</span>
<span class="c">######################################################</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># Generic method which generates the data output by dynamically building the query statement as required:</span>
<span class="c">#  - allows aliases for field names (in either field list, group list or conditions)</span>
<span class="c">#  - dynamically includes only tables necessary based upon join_conditions hash and left_join_conditions hash.</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="generate_data-"></a><span class="k">sub </span><span class="m">generate_data</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>           <span class="c">### (flag) save query results in hash for easy retrieval</span>
    <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>    <span class="c">### (flag) just generate a list of output fields</span>
    <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>          <span class="c">### (flag) suppress most feedback</span>
    <span class="k">my</span> <span class="i">$input</span>       = <span class="i">$args</span>{-<span class="w">input</span>}<span class="sc">;</span>          <span class="c">### input arguments (to allow caching of queries)</span>
    <span class="c">### retrieve applicable object attributes ###</span>
    <span class="k">my</span> <span class="i">@field_list</span><span class="sc">;</span>
    <span class="i">@field_list</span> = <span class="i">&amp;Cast_List</span><span class="s">(</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">field_list</span>} <span class="s">)</span> <span class="k">if</span> <span class="i">$args</span>{-<span class="w">field_list</span>}<span class="sc">;</span>    <span class="c">### list of fields to retrieve</span>
    <span class="k">my</span> <span class="i">$group</span> = <span class="i">$args</span>{-<span class="w">group</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span>   = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span> = <span class="i">$args</span>{-<span class="w">order</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit</span> = <span class="i">$args</span>{-<span class="w">limit</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span> = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$log</span><span class="sc">;</span>
    <span class="i">$log</span> = <span class="i">$input</span>-&gt;{<span class="q">'-log'</span>} <span class="k">if</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{<span class="q">'-log'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$retroactive</span><span class="sc">;</span>
    <span class="i">$retroactive</span> = <span class="i">$input</span>-&gt;{<span class="q">'-retroactive'</span>} <span class="k">if</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{<span class="q">'-retroactive'</span>}<span class="sc">;</span>    <span class="c">### flag to pass to add_Attributes() for allowing attribute retrieval retroactively back to the original plates if the attribute value for the current plate is empty</span>
    <span class="k">my</span> <span class="i">$view_edit_comments</span><span class="sc">;</span>
    <span class="i">$view_edit_comments</span> = <span class="i">$input</span>-&gt;{<span class="q">'-view_edit_comments'</span>} <span class="k">if</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{<span class="q">'-view_edit_comments'</span>}<span class="sc">;</span>    <span class="c">### flag to add edit comments of given fields</span>

    <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>}<span class="sc">;</span>

    <span class="c">#    my $attribute_link = $args{-attribute_link};   deprecated for now... may be useful, but currently this is figured out automatically      ### explicitly indicate which attributes may be linked to this object</span>

    <span class="k">my</span> <span class="i">$tables</span>               = <span class="i">$args</span>{-<span class="w">tables</span>}<span class="sc">;</span>                                                           <span class="c">### static list of tables to include (always)</span>
    <span class="k">my</span> <span class="i">$join_condition</span>       = <span class="i">$args</span>{-<span class="w">join_condition</span>}<span class="sc">;</span>                                                   <span class="c">### condition (if applicable) which joins static table list</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span>     = <span class="i">$args</span>{-<span class="w">left_join_tables</span>}<span class="sc">;</span>                                                 <span class="c">### static -left_join_tables=&gt;'LEFT JOIN Plate ON Run.FK_Plate__ID=Plate_ID'</span>
    <span class="k">my</span> <span class="i">$conditions</span>           = <span class="i">$args</span>{-<span class="w">conditions</span>} || <span class="n">1</span><span class="sc">;</span>                                                  <span class="c">### input conditions</span>
    <span class="k">my</span> <span class="i">$join_conditions</span>      = <span class="i">$args</span>{-<span class="w">join_conditions</span>}<span class="sc">;</span>                                                  <span class="c">### dynamic joins eg: -join_conditions=&gt;{'Plate' =&gt; 'Run.FK_Plate__ID=Plate_ID'}</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="i">$args</span>{-<span class="w">left_join_conditions</span>}<span class="sc">;</span>                                             <span class="c">### dynamic left joins eg: -left_join_conditions=&gt;{'Plate' =&gt; 'Run.FK_Plate__ID=Plate_ID'}</span>

    <span class="c">## Options that may be passed in as general arguments ##</span>
    <span class="k">my</span> <span class="i">$date_format</span> = <span class="q">'Simple'</span><span class="sc">;</span>                                                                          <span class="c">## (Mon DD, YYYY)</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{-<span class="w">date_format</span>} <span class="s">)</span>    <span class="s">{</span> <span class="i">$date_format</span>    = <span class="i">$input</span>-&gt;{-<span class="w">date_format</span>} <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{-<span class="w">tables</span>} <span class="s">)</span>         <span class="s">{</span> <span class="i">$tables</span>         = <span class="i">$input</span>-&gt;{-<span class="w">tables</span>} <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{-<span class="w">join_condition</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$join_condition</span> = <span class="i">$input</span>-&gt;{-<span class="w">join_condition</span>}<span class="sc">;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{-<span class="w">save</span>} <span class="s">)</span>  <span class="s">{</span> <span class="i">$save</span>  ||= <span class="i">$input</span>-&gt;{-<span class="w">save</span>}<span class="sc">;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{-<span class="w">debug</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$debug</span> ||= <span class="i">$input</span>-&gt;{-<span class="w">debug</span>}<span class="sc">;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{-<span class="w">list_fields</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$list_fields</span> = <span class="i">$input</span>-&gt;{-<span class="w">list_fields</span>}<span class="sc">;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$group</span> || <span class="i">$KEY</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'Count(*) as count'</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">@include_tables</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$tables</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$join_conditions</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@include_tables</span><span class="cm">,</span> <span class="k">map</span> <span class="s">{</span>
            <span class="k">if</span>   <span class="s">(</span><span class="q">/(.+) AS (.*)/i</span><span class="s">)</span> <span class="s">{</span><span class="i">$1</span><span class="s">}</span>
            <span class="k">else</span>                   <span class="s">{</span><span class="i">$_</span><span class="s">}</span>
        <span class="s">}</span> <span class="k">keys</span> <span class="i">%$join_conditions</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$left_join_conditions</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@include_tables</span><span class="cm">,</span> <span class="k">map</span> <span class="s">{</span>
            <span class="k">if</span>   <span class="s">(</span><span class="q">/(.+) AS (.*)/i</span><span class="s">)</span> <span class="s">{</span><span class="i">$1</span><span class="s">}</span>
            <span class="k">else</span>                   <span class="s">{</span><span class="i">$_</span><span class="s">}</span>
        <span class="s">}</span> <span class="k">keys</span> <span class="i">%$left_join_conditions</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#    my @include_tables = @{ unique_items( \@unique_tables ) };</span>

    <span class="c">## parse Since, Until options to applicable date field ##</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$since</span><span class="cm">,</span> <span class="i">$until</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{-<span class="w">since</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$since</span> = <span class="i">$input</span>-&gt;{-<span class="w">since</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$input</span>-&gt;{ -<span class="k">until</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$until</span> = <span class="i">$input</span>-&gt;{ -<span class="k">until</span> }<span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$since</span> || <span class="i">$until</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$date_condition</span> = <span class="i">$self</span><span class="i">-&gt;parse_date_condition</span><span class="s">(</span> -<span class="w">date_field</span> <span class="cm">=&gt;</span> <span class="i">$date_field</span><span class="cm">,</span> -<span class="w">since</span> <span class="cm">=&gt;</span> <span class="i">$since</span><span class="cm">,</span> -<span class="w">until</span> <span class="cm">=&gt;</span> <span class="i">$until</span><span class="cm">,</span> -<span class="w">on_fail</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$date_condition</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$conditions</span> .= <span class="q">' AND '</span> . <span class="i">$date_condition</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$KEY</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">$key</span> <span class="s">)</span> <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/\b$key\b/</span><span class="cm">,</span> <span class="i">@field_list</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## add to fields if not already...</span>
    <span class="s">}</span>
<span class="c">###    if ($group =~/month/i){</span>
<span class="c">###	   my $month_replace = &quot;Month($date_field), Year($date_field)&quot;;</span>
<span class="c">###	   $group =~s/month/$month_replace/ig;</span>
<span class="c">###    } elsif ($group =~/year/i){</span>
<span class="c">###	   my $year_replace = &quot;Year($date_field)&quot;;</span>
<span class="c">###	   $group =~s/year/$year_replace/ig;</span>
<span class="c">###    }</span>
<span class="c">###    print &quot;GROUP $group&quot;;</span>
    <span class="c">## retrieve mapping of simple names to actual fields</span>

    <span class="k">my</span> <span class="i">%Fields</span> = <span class="i">%</span>{
        <span class="i">&amp;alDente::alDente_API::map_to_fields</span><span class="s">(</span>
            -<span class="w">key</span>        <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
            -<span class="w">fields</span>     <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
            -<span class="w">order</span>      <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
            -<span class="w">group</span>      <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
            -<span class="w">key</span>        <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
            -<span class="w">tables</span>     <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
            -<span class="w">quiet</span>      <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
            -<span class="w">conditions</span> <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
            -<span class="w">left_joins</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
            -<span class="w">joins</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span>
        <span class="s">)</span>
        }<span class="sc">;</span>
    <span class="c">## &lt;CONSTRUCTION&gt; - send reference which is adapted instead (check the way this works with a scalar..)</span>

    <span class="c">## reset variables as required (replaces aliases as necessary)</span>
    <span class="i">$group</span>      = <span class="i">$Fields</span>{<span class="w">group</span>}<span class="sc">;</span>
    <span class="i">$KEY</span>        = <span class="i">$Fields</span>{<span class="w">key</span>}<span class="sc">;</span>
    <span class="i">$order</span>      = <span class="i">$Fields</span>{<span class="w">order</span>}<span class="sc">;</span>
    <span class="i">$conditions</span> = <span class="i">$Fields</span>{<span class="w">conditions</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@final_field_list</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@attribute_types</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$newfield</span> <span class="s">(</span><span class="i">@field_list</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$att_types</span> = <span class="i">$self</span><span class="i">-&gt;is_Attribute</span><span class="s">(</span> -<span class="w">alias</span> <span class="cm">=&gt;</span> <span class="i">$newfield</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> \<span class="i">@include_tables</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$att_types</span><span class="s">)</span> <span class="s">{</span>
            <span class="c">## this field is actually an attribute (or contains an attribute)</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$att</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$att_types</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span> <span class="i">@attribute_types</span><span class="cm">,</span> <span class="i">$att</span><span class="sc">;</span>
                <span class="k">my</span> <span class="s">(</span><span class="i">$att_table</span><span class="s">)</span> = <span class="k">split</span> <span class="q">/\./</span><span class="cm">,</span> <span class="i">$att</span><span class="sc">;</span>

                <span class="k">if</span> <span class="s">(</span> !<span class="i">$att_table</span> <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>    <span class="c">## just in case this is somehow blank</span>

                <span class="k">my</span> <span class="s">(</span><span class="i">$primary_field</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;SDB::DBIO::get_field_info</span><span class="s">(</span> <span class="i">$att_table</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="q">'Primary'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">push</span> <span class="i">@final_field_list</span><span class="cm">,</span> <span class="q">&quot;$att_table.$primary_field&quot;</span><span class="sc">;</span>    <span class="c">## include reference to records for which there are attributes pointing</span>
            <span class="s">}</span>
            <span class="k">next</span><span class="sc">;</span>
            <span class="c">## exclude fields which are retrieved via add_Attributes later</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$newfield</span> =~ <span class="q">/(.*) AS (.*)/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$field</span>   = <span class="i">$1</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$thiskey</span> = <span class="i">$2</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$Fields</span>{<span class="i">$thiskey</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="i">$newfield</span> = <span class="q">&quot;$Fields{$thiskey} AS $thiskey&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$Fields</span>{<span class="i">$newfield</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$newfield</span> = <span class="q">&quot;$Fields{$newfield} AS $newfield&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">print</span> <span class="q">&quot;$newfield NOT FOUND (ok if explicit field)\n&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{-<span class="w">debug</span>} &amp;&amp; !<span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">push</span> <span class="i">@final_field_list</span><span class="cm">,</span> <span class="i">$newfield</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## Add optional fields if necessary (check fields requested, conditions for extra tables)</span>
    <span class="k">my</span> <span class="i">$dynamic_joins</span> = <span class="i">&amp;alDente::alDente_API::dynamic_joins</span><span class="s">(</span>
        -<span class="w">fields</span>     <span class="cm">=&gt;</span> \<span class="i">@final_field_list</span><span class="cm">,</span>
        -<span class="w">condition</span>  <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">table_list</span> <span class="cm">=&gt;</span> <span class="q">&quot;$tables $left_join_tables&quot;</span><span class="cm">,</span>
        -<span class="w">join</span>       <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">left_join</span>  <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">quiet</span>      <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">dbc</span>        <span class="cm">=&gt;</span> <span class="i">$self</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">$left_join_tables</span> .= <span class="q">&quot; $dynamic_joins &quot;</span><span class="sc">;</span>

    <span class="c">## set limit, group parameters ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$limit</span><span class="s">)</span> <span class="s">{</span> <span class="i">$limit</span> = <span class="q">&quot;LIMIT $limit&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$group</span><span class="s">)</span> <span class="s">{</span> <span class="i">$group</span> = <span class="q">&quot;GROUP BY $group&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$order</span><span class="s">)</span> <span class="s">{</span> <span class="i">$order</span> = <span class="q">&quot;ORDER BY $order&quot;</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$list_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$left_join_tables</span> =~ <span class="q">/^\s*$/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;_list_Fields</span><span class="s">(</span> <span class="i">$tables</span><span class="cm">,</span> !<span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;_list_Fields</span><span class="s">(</span> <span class="q">&quot;$tables $left_join_tables&quot;</span><span class="cm">,</span> !<span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">return</span> <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sql</span><span class="sc">;</span>
    <span class="i">$sql</span> = <span class="q">&quot;SELECT &quot;</span> . <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@final_field_list</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span> <span class="s">)</span> . <span class="q">&quot; FROM ($tables) $left_join_tables&quot;</span> . <span class="q">&quot;$join_condition AND $conditions $group $order $limit&quot;</span><span class="sc">;</span>

    <span class="i">$self</span>-&gt;{<span class="w">last_query</span>} = <span class="i">$sql</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%data</span><span class="sc">;</span>

    <span class="i">%data</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">&quot;($tables) $left_join_tables&quot;</span><span class="cm">,</span> \<span class="i">@final_field_list</span><span class="cm">,</span> <span class="q">&quot;$join_condition AND $conditions $group $order $limit&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">date_format</span> <span class="cm">=&gt;</span> <span class="i">$date_format</span> <span class="s">)</span> <span class="k">if</span> <span class="i">@final_field_list</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">@attribute_types</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;add_Attributes</span><span class="s">(</span> -<span class="w">attributes</span> <span class="cm">=&gt;</span> \<span class="i">@attribute_types</span><span class="cm">,</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%data</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span> -<span class="w">retroactive</span> <span class="cm">=&gt;</span> <span class="i">$retroactive</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$view_edit_comments</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@view_edit_comment</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$view_edit_comments</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">map</span> <span class="s">{</span><span class="q">s/_edit_comments//</span><span class="s">}</span> <span class="i">@view_edit_comment</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">%Fields</span> = <span class="i">%</span>{
            <span class="i">&amp;alDente::alDente_API::map_to_fields</span><span class="s">(</span>
                -<span class="w">fields</span>     <span class="cm">=&gt;</span> \<span class="i">@view_edit_comment</span><span class="cm">,</span>
                -<span class="w">tables</span>     <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
                -<span class="w">quiet</span>      <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
                -<span class="w">conditions</span> <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
                -<span class="w">left_joins</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
                -<span class="w">joins</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span>
            <span class="s">)</span>
            }<span class="sc">;</span>
        <span class="i">$self</span><span class="i">-&gt;add_edit_comments</span><span class="s">(</span> -<span class="w">edit_fields</span> <span class="cm">=&gt;</span> \<span class="i">@view_edit_comment</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> \<span class="i">%Fields</span><span class="cm">,</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%data</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;keying on $KEY&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$KEY</span> &amp;&amp; !<span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> \<span class="i">%data</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">save</span> <span class="cm">=&gt;</span> <span class="i">$save</span><span class="cm">,</span> -<span class="w">key</span> <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span> -<span class="w">sql</span> <span class="cm">=&gt;</span> <span class="i">$sql</span><span class="cm">,</span> -<span class="w">input</span> <span class="cm">=&gt;</span> <span class="i">$input</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="i">$log</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###########################</span>
<a name="parse_date_condition-"></a><span class="k">sub </span><span class="m">parse_date_condition</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">$self</span>       = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>}<span class="sc">;</span>     <span class="c">## field of interest</span>
    <span class="k">my</span> <span class="i">$since</span>      = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$until</span>      = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$on_fail</span> = <span class="i">$args</span>{-<span class="w">on_fail</span>} || <span class="q">'0'</span><span class="sc">;</span>

            <span class="k">my</span> <span class="i">@conditions</span><span class="sc">;</span>

            <span class="k">unless</span> <span class="s">(</span><span class="i">$date_field</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Warning: Since or Until arguments need to be applied to a particular date field&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="i">$on_fail</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">%date_tags</span> = <span class="s">(</span> <span class="q">'LASTMONTH'</span> <span class="cm">=&gt;</span> <span class="q">'-30d'</span><span class="cm">,</span> <span class="q">'LASTWEEK'</span> <span class="cm">=&gt;</span> <span class="q">'-7d'</span><span class="cm">,</span> <span class="q">'YESTERDAY'</span> <span class="cm">=&gt;</span> <span class="q">'-1d'</span><span class="cm">,</span> <span class="q">'LASTYEAR'</span> <span class="cm">=&gt;</span> <span class="q">'-365d'</span><span class="cm">,</span> <span class="q">'TODAY'</span> <span class="cm">=&gt;</span> <span class="q">''</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$since</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$since</span> =~ <span class="q">/^\d\d\d\d-\d\d-\d\d/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;$date_field &gt;= '$since'&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/$since/i</span><span class="cm">,</span> <span class="k">keys</span> <span class="i">%date_tags</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$since</span> = <span class="i">date_time</span><span class="s">(</span> -<span class="w">offset</span> <span class="cm">=&gt;</span> <span class="i">$date_tags</span>{<span class="i">$since</span>} <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;$date_field &gt;= '$since'&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Error in Date Format (since '$since' ?)&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="i">$on_fail</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$until</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$since</span> =~ <span class="q">/^\d\d\d\d-\d\d-\d\d/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;$date_field &lt;= '$until'&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/$until/i</span><span class="cm">,</span> <span class="k">keys</span> <span class="i">%date_tags</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$since</span> = <span class="i">date_time</span><span class="s">(</span> -<span class="w">offset</span> <span class="cm">=&gt;</span> <span class="i">$date_tags</span>{<span class="i">$until</span>} <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;$date_field &gt;= '$until'&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Error in Date Format (since '$since' ?)&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="i">$on_fail</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@conditions</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##</span>
<span class="c"># Simply determine if a given alias is actually an attribute instead of a field</span>
<span class="c">#</span>
<span class="c"># optionally supply list of attribute_links (eg [&quot;Run.run_id&quot;]) which include Table + alias retrieved (which needs to be in the field_list to work)</span>
<span class="c">#</span>
<span class="c"># Return: class of attribute if field alias is an attribute (0 if not an attribute)</span>
<span class="c">#####################</span>
<a name="is_Attribute-"></a><span class="k">sub </span><span class="m">is_Attribute</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span>      = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>      = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'alias,tables'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$alias</span>     = <span class="i">$args</span>{-<span class="w">alias</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tables</span>    = <span class="i">$args</span>{-<span class="w">tables</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$condition</span> = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>     = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="c">## &lt;construction&gt; For now leave out handling for attribute_link, though this should be added in.</span>

    <span class="i">$alias</span> =~ <span class="q">s / AS (\w+)//i</span><span class="sc">;</span>    <span class="c">## ignore second level alias if supplied</span>

    <span class="k">my</span> <span class="i">@words</span> = <span class="k">split</span> <span class="q">/\W+/</span><span class="cm">,</span> <span class="i">$alias</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$table_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$table_list</span><span class="s">)</span> <span class="s">{</span> <span class="i">$condition</span> .= <span class="q">&quot; AND Attribute_Class in ($table_list)&quot;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">@found</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$word</span> <span class="s">(</span><span class="i">@words</span><span class="s">)</span> <span class="s">{</span>

        <span class="c">#check if attribute alias is used</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$Attr_Aliases</span>{<span class="i">$word</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$attr</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\./</span><span class="cm">,</span> <span class="i">$Attr_Aliases</span>{<span class="i">$word</span>} <span class="s">)</span><span class="sc">;</span>
            <span class="i">$word</span> = <span class="i">$attr</span><span class="sc">;</span>
            <span class="i">$condition</span> .= <span class="q">&quot; AND Attribute_Class in ('$table')&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$class</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Attribute'</span><span class="cm">,</span> <span class="q">'Attribute_Class'</span><span class="cm">,</span> <span class="q">&quot;WHERE Attribute_Name like \&quot;$word\&quot; $condition&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$class</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@found</span><span class="cm">,</span> <span class="q">&quot;$class.$word&quot;</span> <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;$word attribute ?: $class.$word&quot;</span><span class="s">)</span> <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@found</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################</span>
<a name="add_Attributes-"></a><span class="k">sub </span><span class="m">add_Attributes</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'attributes,data'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$attributes</span>  = <span class="i">$args</span>{-<span class="w">attributes</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$data_ref</span>    = <span class="i">$args</span>{-<span class="w">data</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>       = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$retroactive</span> = <span class="i">$args</span>{-<span class="w">retroactive</span>}<span class="sc">;</span>    <span class="c"># flag for allowing attribute retrieval retroactively back to the original plates if the attribute value for the current plate is empty</span>

    <span class="k">my</span> <span class="i">@attributes</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@field_list</span> = <span class="i">@$fields</span><span class="sc">;</span>                <span class="c">## fields originally requested so we can check if we want to re-alias an attribute</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span> <span class="i">$attributes</span> <span class="k">eq</span> <span class="q">'ARRAY'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@attributes</span> = <span class="i">@$attributes</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">@attributes</span> = <span class="s">(</span><span class="i">$attributes</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">@attributes</span> = <span class="i">@</span>{ <span class="i">unique_items</span><span class="s">(</span> \<span class="i">@attributes</span> <span class="s">)</span> }<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Add Attributes: @attributes&quot;</span><span class="s">)</span> <span class="s">}</span>

    <span class="c">## parse out Attribute table and ID field from indicated attribute_link ##</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$attribute</span> <span class="s">(</span><span class="i">@attributes</span><span class="s">)</span> <span class="s">{</span>

        <span class="c">### check Attributes for each class of Object requested (eg Plate.plate_id, Run.run_id)</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$primary_table</span><span class="cm">,</span> <span class="i">$attribute_name</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">/\./</span><span class="cm">,</span> <span class="i">$attribute</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$primary_field</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;SDB::DBIO::get_field_info</span><span class="s">(</span> <span class="i">$primary_table</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="q">'Primary'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$FK_to_primary_field</span> = <span class="i">$primary_field</span><span class="sc">;</span>
        <span class="i">$FK_to_primary_field</span> =~ <span class="q">s/^(.+)_(\w+)$/FK_$1__$2/</span><span class="sc">;</span>    <span class="c">## figure out what reference to primary key is called</span>

        <span class="k">my</span> <span class="i">@ids</span><span class="sc">;</span>
        <span class="i">@ids</span> = <span class="i">@</span>{ <span class="i">$data_ref</span>-&gt;{<span class="i">$primary_field</span>} } <span class="k">if</span> <span class="k">defined</span> <span class="i">$data_ref</span>-&gt;{<span class="i">$primary_field</span>}<span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">@ids</span><span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$data_ref</span><span class="sc">;</span> <span class="s">}</span>

        <span class="k">my</span> <span class="i">@full_id_list</span>   = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@unique_id_list</span> = <span class="i">@</span>{ <span class="i">unique_items</span><span class="s">(</span> \<span class="i">@full_id_list</span> <span class="s">)</span> }<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$id_list</span>        = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@unique_id_list</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#&lt;CONSTRUCTION&gt; shouldn't this be just a single attribute and id since attribute name and class should be unique? Don't need an array</span>
        <span class="k">my</span> <span class="i">@potential_attributes</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Attribute'</span><span class="cm">,</span> <span class="q">'Attribute_ID,Attribute_Name'</span><span class="cm">,</span> <span class="q">&quot;WHERE Attribute_Class = '$primary_table' AND Attribute_Name = '$attribute_name'&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">@attributes_requested</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@att_ids_requested</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$pot_attribute</span> <span class="s">(</span><span class="i">@potential_attributes</span><span class="s">)</span> <span class="s">{</span>
            <span class="c">## check to see which of the potential attributes for this class of object have been requested ##</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$att_id</span><span class="cm">,</span> <span class="i">$att_name</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$pot_attribute</span><span class="sc">;</span>

            <span class="k">my</span> <span class="i">@more_atts_requested</span> = <span class="k">grep</span> <span class="q">/\b$att_name\b/</span><span class="cm">,</span> <span class="i">@field_list</span><span class="sc">;</span>    <span class="c">## allow for more complex requests such as 'PCR_cycles as Cycles' where PCR_cycles is an attribute ##</span>

            <span class="k">if</span> <span class="s">(</span><span class="i">@more_atts_requested</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span> <span class="i">@attributes_requested</span><span class="cm">,</span> <span class="i">@more_atts_requested</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">push</span> <span class="i">@att_ids_requested</span><span class="cm">,</span> <span class="i">$att_id</span><span class="sc">;</span>                               <span class="c">## potential duplicates should not be a problem (eg, PCR_cycles, PCR_cycles as Cycles)</span>
        <span class="s">}</span>

        <span class="c">#check for attribute alias</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$attr_alias</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%Attr_Aliases</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">@more_atts_requested</span> = <span class="k">grep</span> <span class="q">/\b$attr_alias\b/</span><span class="cm">,</span> <span class="i">@field_list</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">@more_atts_requested</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$attr</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\./</span><span class="cm">,</span> <span class="i">$Attr_Aliases</span>{<span class="i">$attr_alias</span>} <span class="s">)</span><span class="sc">;</span>

                <span class="c">#only substituting the current potential attribute</span>
                <span class="k">my</span> <span class="s">(</span> <span class="i">$att_id</span><span class="cm">,</span> <span class="i">$att_name</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$potential_attributes</span>[<span class="n">0</span>]<span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="i">$primary_table</span> &amp;&amp; <span class="i">$attr</span> <span class="k">eq</span> <span class="i">$att_name</span> &amp;&amp; <span class="i">$att_name</span> <span class="k">ne</span> <span class="i">$attr_alias</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">for</span> <span class="k">my</span> <span class="i">$more_att_requested</span> <span class="s">(</span><span class="i">@more_atts_requested</span><span class="s">)</span> <span class="s">{</span>

                        <span class="c">#substitute alias</span>
                        <span class="i">$more_att_requested</span> =~ <span class="q">s/\b$attr_alias\b/$attr/g</span><span class="sc">;</span>

                        <span class="c">#check to see if need to add AS for alias</span>
                        <span class="k">if</span> <span class="s">(</span> <span class="i">$more_att_requested</span> !~ <span class="q">/^(.+) AS (\w+)/i</span> <span class="s">)</span> <span class="s">{</span>
                            <span class="i">$more_att_requested</span> = <span class="q">&quot;$more_att_requested AS $attr_alias&quot;</span><span class="sc">;</span>
                        <span class="s">}</span>
                        <span class="k">push</span> <span class="i">@attributes_requested</span><span class="cm">,</span> <span class="i">$more_att_requested</span><span class="sc">;</span>
                        <span class="k">push</span> <span class="i">@att_ids_requested</span><span class="cm">,</span>    <span class="i">$att_id</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$att_id_list</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@att_ids_requested</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$att_id_list</span> <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>    <span class="c">## no attributes for this class of object ... check next attribute type...</span>

        <span class="k">my</span> <span class="i">%Attributes</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
            <span class="q">&quot;Attribute,$primary_table,${primary_table}_Attribute&quot;</span><span class="cm">,</span>
            <span class="s">[</span> <span class="i">$primary_field</span><span class="cm">,</span> <span class="q">'Attribute_Name'</span><span class="cm">,</span> <span class="q">'Attribute_Value'</span><span class="cm">,</span> <span class="q">'Attribute_Type'</span> <span class="s">]</span><span class="cm">,</span>
            <span class="q">&quot;WHERE FK_Attribute__ID=Attribute_ID AND $FK_to_primary_field=$primary_field AND Attribute_ID IN ($att_id_list) AND $primary_field IN ($id_list) GROUP BY $primary_field,Attribute_Name&quot;</span><span class="cm">,</span>
            -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="c"># retroactive</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$primary_table</span> <span class="k">eq</span> <span class="q">'Plate'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span><span class="i">@ids</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">@got_ids</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
                <span class="i">@got_ids</span> = <span class="i">@</span>{ <span class="i">$Attributes</span>{<span class="i">$primary_field</span>} } <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Attributes</span>{<span class="i">$primary_field</span>} <span class="s">)</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$id$/</span><span class="cm">,</span> <span class="i">@got_ids</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">next</span><span class="sc">;</span>
                <span class="s">}</span>

                <span class="c"># no attribute value found for this id</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$retroactive</span><span class="s">)</span> <span class="s">{</span>    <span class="c"># retroactive back to the parent plates to get the attribute value</span>
                    <span class="k">my</span> <span class="i">$parents</span> = <span class="i">&amp;alDente::Container::get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="k">my</span> <span class="i">%parent_Attributes</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
                        <span class="q">&quot;Attribute,$primary_table,${primary_table}_Attribute&quot;</span><span class="cm">,</span>
                        <span class="s">[</span> <span class="i">$primary_field</span><span class="cm">,</span> <span class="q">'Attribute_Name'</span><span class="cm">,</span> <span class="q">'Attribute_Value'</span><span class="cm">,</span> <span class="q">'Attribute_Type'</span> <span class="s">]</span><span class="cm">,</span>
                        <span class="q">&quot;WHERE FK_Attribute__ID=Attribute_ID AND $FK_to_primary_field=$primary_field AND Attribute_ID IN ($att_id_list) AND $primary_field IN ($parents) GROUP BY $primary_field,Attribute_Name&quot;</span><span class="cm">,</span>
                        -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span>
                    <span class="s">)</span><span class="sc">;</span>
                    <span class="c">## get the attribute value from parent plates. If multiple values exist, give warning</span>
                    <span class="k">my</span> <span class="i">%parent_values</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
                    <span class="k">my</span> <span class="i">$index</span>         = <span class="n">0</span><span class="sc">;</span>
                    <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$parent_Attributes</span>{<span class="i">$primary_field</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
                        <span class="k">my</span> <span class="i">$pf</span>         = <span class="i">$parent_Attributes</span>{<span class="i">$primary_field</span>}[<span class="i">$index</span>]<span class="sc">;</span>
                        <span class="k">my</span> <span class="i">$attr_name</span>  = <span class="i">$parent_Attributes</span>{<span class="w">Attribute_Name</span>}[<span class="i">$index</span>]<span class="sc">;</span>
                        <span class="k">my</span> <span class="i">$attr_value</span> = <span class="i">$parent_Attributes</span>{<span class="w">Attribute_Value</span>}[<span class="i">$index</span>]<span class="sc">;</span>
                        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$parent_values</span>{<span class="i">$attr_name</span>} <span class="s">)</span> <span class="s">{</span>
                            <span class="k">push</span> <span class="i">@</span>{ <span class="i">$parent_values</span>{<span class="i">$attr_name</span>} }<span class="cm">,</span> <span class="i">$attr_value</span><span class="sc">;</span>
                        <span class="s">}</span>
                        <span class="k">else</span> <span class="s">{</span>
                            <span class="i">$parent_values</span>{<span class="i">$attr_name</span>} = <span class="s">[</span><span class="i">$attr_value</span><span class="s">]</span><span class="sc">;</span>
                        <span class="s">}</span>
                        <span class="i">$index</span>++<span class="sc">;</span>
                    <span class="s">}</span>

                    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$attr</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%parent_values</span> <span class="s">)</span> <span class="s">{</span>
                        <span class="k">my</span> <span class="i">$distinct_values</span> = <span class="i">RGmath::distinct_list</span><span class="s">(</span> <span class="i">$parent_values</span>{<span class="i">$attr</span>} <span class="s">)</span><span class="sc">;</span>
                        <span class="k">if</span> <span class="s">(</span> <span class="i">@$distinct_values</span> &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># multiple values in parent plates, give warning</span>
                            <span class="k">my</span> <span class="i">$msg</span> = <span class="q">''</span><span class="sc">;</span>
                            <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
                            <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$parent_Attributes</span>{<span class="i">$primary_field</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
                                <span class="k">if</span> <span class="s">(</span> <span class="i">$parent_Attributes</span>{<span class="w">Attribute_Name</span>}[<span class="i">$index</span>] <span class="k">eq</span> <span class="i">$attr</span> <span class="s">)</span> <span class="s">{</span>
                                    <span class="k">my</span> <span class="i">$pla</span>   = <span class="i">$parent_Attributes</span>{<span class="i">$primary_field</span>}[<span class="i">$index</span>]<span class="sc">;</span>
                                    <span class="k">my</span> <span class="i">$value</span> = <span class="i">$parent_Attributes</span>{<span class="w">Attribute_Value</span>}[<span class="i">$index</span>]<span class="sc">;</span>
                                    <span class="i">$msg</span> .= <span class="q">&quot;pla$pla $attr=$value; &quot;</span><span class="sc">;</span>
                                <span class="s">}</span>
                                <span class="i">$index</span>++<span class="sc">;</span>
                            <span class="s">}</span>
                            <span class="i">Message</span><span class="s">(</span><span class="q">&quot;WARNING: Multiple different values exist for plate $id attribute name $attr in its parent plates! ( $msg ). A concatenation of these values is returned. Please set the right attribute value for plate $id!&quot;</span><span class="s">)</span><span class="sc">;</span>
                        <span class="s">}</span>
                        <span class="i">$parent_values</span>{<span class="i">$attr</span>} = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@$distinct_values</span><span class="sc">;</span>
                    <span class="s">}</span>

                    <span class="c"># merge to %Attributes</span>
                    <span class="k">if</span> <span class="s">(</span><span class="i">$id</span><span class="s">)</span> <span class="s">{</span>    <span class="c"># make sure $id is not empty</span>
                        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$attr</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%parent_values</span> <span class="s">)</span> <span class="s">{</span>
                            <span class="k">if</span> <span class="s">(</span> <span class="i">$parent_values</span>{<span class="i">$attr</span>} <span class="s">)</span> <span class="s">{</span>    <span class="c"># make sure it is not empty</span>
                                <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Attributes</span>{<span class="i">$primary_field</span>} <span class="s">)</span> <span class="s">{</span>
                                    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$Attributes</span>{<span class="i">$primary_field</span>} }<span class="cm">,</span> <span class="i">$id</span><span class="sc">;</span>
                                <span class="s">}</span>
                                <span class="k">else</span> <span class="s">{</span>
                                    <span class="i">$Attributes</span>{<span class="i">$primary_field</span>} = <span class="s">[</span><span class="i">$id</span><span class="s">]</span><span class="sc">;</span>
                                <span class="s">}</span>
                                <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Attributes</span>{<span class="w">Attribute_Name</span>} <span class="s">)</span> <span class="s">{</span>
                                    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$Attributes</span>{<span class="w">Attribute_Name</span>} }<span class="cm">,</span> <span class="i">$attr</span><span class="sc">;</span>
                                <span class="s">}</span>
                                <span class="k">else</span> <span class="s">{</span>
                                    <span class="i">$Attributes</span>{<span class="w">Attribute_Name</span>} = <span class="s">[</span><span class="i">$attr</span><span class="s">]</span><span class="sc">;</span>
                                <span class="s">}</span>
                                <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Attributes</span>{<span class="w">Attribute_Value</span>} <span class="s">)</span> <span class="s">{</span>
                                    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$Attributes</span>{<span class="w">Attribute_Value</span>} }<span class="cm">,</span> <span class="i">$parent_values</span>{<span class="i">$attr</span>}<span class="sc">;</span>
                                <span class="s">}</span>
                                <span class="k">else</span> <span class="s">{</span>
                                    <span class="i">$Attributes</span>{<span class="w">Attribute_Value</span>} = <span class="s">[</span> <span class="i">$parent_values</span>{<span class="i">$attr</span>} <span class="s">]</span><span class="sc">;</span>
                                <span class="s">}</span>
                                <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Attributes</span>{<span class="w">Attribute_Type</span>} <span class="s">)</span> <span class="s">{</span>
                                    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$Attributes</span>{<span class="w">Attribute_Type</span>} }<span class="cm">,</span> <span class="i">$parent_values</span>{<span class="i">$attr</span>}<span class="sc">;</span>
                                <span class="s">}</span>
                                <span class="k">else</span> <span class="s">{</span>
                                    <span class="i">$Attributes</span>{<span class="w">Attribute_Type</span>} = <span class="s">[</span> <span class="i">$parent_values</span>{<span class="i">$attr</span>} <span class="s">]</span><span class="sc">;</span>
                                <span class="s">}</span>
                            <span class="s">}</span>
                        <span class="s">}</span>    <span class="c"># END foreach my $attr ( keys %parent_values )</span>
                    <span class="s">}</span>    <span class="c"># END if( $id )</span>
                <span class="s">}</span>    <span class="c"># END retroactive</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">%Attr</span><span class="sc">;</span>

        <span class="c"># Populate hash with attributes indexed by primary object id ##</span>
        <span class="c"># eg Attr{1222}{Cycles} = '10' ....</span>

        <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Attributes</span>{<span class="i">$primary_field</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$id</span>    = <span class="i">$Attributes</span>{<span class="i">$primary_field</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$attr</span>  = <span class="i">$Attributes</span>{<span class="w">Attribute_Name</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$value</span> = <span class="i">$Attributes</span>{<span class="w">Attribute_Value</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$type</span>  = <span class="i">$Attributes</span>{<span class="w">Attribute_Type</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/^FK/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$value</span> = <span class="i">$self</span><span class="i">-&gt;get_FK_info</span><span class="s">(</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## convert to readable form</span>
            <span class="s">}</span>
            <span class="i">$index</span>++<span class="sc">;</span>

            <span class="c">#	    push @attributes, $attr unless ( grep /^$attr$/, @attributes );    ## add to current list of attributes</span>
            <span class="i">$Attr</span>{<span class="i">$id</span>}{<span class="i">$attr</span>} = <span class="i">$value</span><span class="sc">;</span>

            <span class="c">#	    $Attr{$id}{Attribute_Name} = $attr;</span>
        <span class="s">}</span>

        <span class="c">## populate data attributes for this class of object ##</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span><span class="i">@ids</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$attribute_requested</span> <span class="s">(</span><span class="i">@attributes_requested</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$alias</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$attribute_requested</span> =~ <span class="q">/^(.+) AS (\w+)/i</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="i">$att</span> = <span class="i">$1</span><span class="sc">;</span>
                    <span class="i">$alias</span> = <span class="i">$2</span><span class="sc">;</span>
                    <span class="k">my</span> <span class="i">$data</span><span class="sc">;</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Attr</span>{<span class="i">$id</span>}{<span class="i">$att</span>} <span class="s">)</span> <span class="s">{</span>
                        <span class="c">## normal case ##</span>
                        <span class="i">$data</span> = <span class="i">$Attr</span>{<span class="i">$id</span>}{<span class="i">$att</span>}<span class="sc">;</span>
                    <span class="s">}</span>
                    <span class="k">else</span> <span class="s">{</span>
                        <span class="c">## Attribute embedded in field_name somewhere (eg Concat(Att_Name,' ml'))</span>
                        <span class="k">my</span> <span class="i">$name</span> = <span class="i">$attribute_name</span><span class="sc">;</span>                <span class="c">## $attribute; ## $Attr{$id}{'Attribute_Name'};</span>
                        <span class="k">my</span> <span class="i">$att_value</span> = <span class="i">$Attr</span>{<span class="i">$id</span>}{<span class="i">$name</span>} || <span class="q">''</span><span class="sc">;</span>

                        <span class="i">$att</span> =~ <span class="q">s/$name/\&quot;$att_value\&quot;/g</span><span class="sc">;</span>          <span class="c">## replace attribute name in field with actual value (quoted)</span>
                        <span class="c">## use SQL to convert back to simple string (eg SELECT ConCat('52', ' ml'))</span>
                        <span class="s">(</span><span class="i">$data</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">$att</span><span class="s">]</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="s">}</span>
                    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$data_ref</span>-&gt;{<span class="i">$alias</span>} }<span class="cm">,</span> <span class="i">$data</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="c">## explicitly requested attribute ##</span>
                    <span class="k">my</span> <span class="i">$data</span><span class="sc">;</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Attr</span>{<span class="i">$id</span>}{<span class="i">$attribute_requested</span>} <span class="s">)</span> <span class="s">{</span>
                        <span class="c">## normal case ##</span>
                        <span class="i">$data</span>  = <span class="i">$Attr</span>{<span class="i">$id</span>}{<span class="i">$attribute_requested</span>}<span class="sc">;</span>
                        <span class="i">$alias</span> = <span class="i">$attribute_requested</span><span class="sc">;</span>
                    <span class="s">}</span>
                    <span class="k">else</span> <span class="s">{</span>
                        <span class="c">## Attribute embedded in field_name somewhere (eg Concat(Att_Name,' ml'))</span>
                        <span class="k">my</span> <span class="i">$name</span> = <span class="i">$attribute_name</span><span class="sc">;</span>                <span class="c">## $attribute_requested; ## $Attr{$id}{'Attribute_Name'};</span>
                        <span class="k">my</span> <span class="i">$att_value</span> = <span class="i">$Attr</span>{<span class="i">$id</span>}{<span class="i">$name</span>} || <span class="q">''</span><span class="sc">;</span>
                        <span class="i">$alias</span> = <span class="i">$name</span><span class="sc">;</span>

                        <span class="k">if</span> <span class="s">(</span><span class="i">$att_value</span><span class="s">)</span> <span class="s">{</span>
                            <span class="k">my</span> <span class="i">$explicit_value</span> = <span class="i">$attribute_requested</span><span class="sc">;</span>
                            <span class="i">$explicit_value</span> =~ <span class="q">s/$name/\&quot;$att_value\&quot;/g</span><span class="sc">;</span>    <span class="c">## replace attribute name in field with actual value (quoted)</span>
                            <span class="c">## use SQL to convert back to simple string (eg SELECT ConCat('52', ' ml'))</span>
                            <span class="s">(</span><span class="i">$data</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">$explicit_value</span><span class="s">]</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
                        <span class="s">}</span>
                    <span class="s">}</span>
                    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$data_ref</span>-&gt;{<span class="i">$alias</span>} }<span class="cm">,</span> <span class="i">$data</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<a name="add_edit_comments-"></a><span class="k">sub </span><span class="m">add_edit_comments</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'edit_field,field_info,data'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$edit_fields</span> = <span class="i">$args</span>{-<span class="w">edit_fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$data_ref</span>    = <span class="i">$args</span>{-<span class="w">data</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@edit_field</span>  = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$edit_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$edit_field</span> <span class="s">(</span><span class="i">@edit_field</span><span class="s">)</span> <span class="s">{</span>

        <span class="c">#resolve alias</span>
        <span class="k">my</span> <span class="i">$real_field</span> = <span class="i">$fields</span>-&gt;{<span class="i">$edit_field</span>}<span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$field</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$real_field</span> =~ <span class="q">/(\w+)\.(\w+)/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$table</span> = <span class="i">$1</span><span class="sc">;</span> <span class="i">$field</span> = <span class="i">$2</span><span class="sc">;</span> <span class="s">}</span>

        <span class="c">#find primary field for the field</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$primary_field</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;SDB::DBIO::get_field_info</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="q">'Primary'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#add edit comment for each primary id</span>
        <span class="k">my</span> <span class="i">@ids</span> = <span class="i">@</span>{ <span class="i">$data_ref</span>-&gt;{<span class="i">$primary_field</span>} } <span class="k">if</span> <span class="k">defined</span> <span class="i">$data_ref</span>-&gt;{<span class="i">$primary_field</span>}<span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">@ids</span><span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>

        <span class="k">my</span> <span class="i">$sql_comment</span> = <span class="q">&quot;GROUP_CONCAT(CASE WHEN Old_Value = New_Value THEN concat(Date(Modified_Date),': ',Comment) ELSE concat(Date(Modified_Date),': (', Old_Value,' -&gt; ',New_Value,') ',Comment) END ORDER BY Modified_Date DESC SEPARATOR '; ')&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$DBField_ID</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;DBField&quot;</span><span class="cm">,</span> <span class="q">&quot;DBField_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Field_Table = '$table' and Field_Name = '$field'&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$id_string</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="k">grep</span> <span class="q">/.+/</span><span class="cm">,</span> <span class="i">@ids</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">%info</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
            <span class="q">'Change_History'</span><span class="cm">,</span>
            <span class="s">[</span> <span class="q">'Record_ID'</span><span class="cm">,</span> <span class="q">&quot;$sql_comment AS Edit_Comment&quot;</span><span class="cm">,</span> <span class="q">&quot;MAX(Modified_Date) AS Last_Modified&quot;</span> <span class="s">]</span><span class="cm">,</span>
            <span class="q">&quot;WHERE Change_History.Record_ID IN ($id_string) AND FK_DBField__ID = $DBField_ID GROUP BY Record_ID&quot;</span><span class="cm">,</span>
            -<span class="w">key</span> <span class="cm">=&gt;</span> <span class="q">&quot;Record_ID&quot;</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$comment_alias</span>       = <span class="i">$edit_field</span> . <span class="q">&quot;_edit_comments&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$modified_time_alias</span> = <span class="i">$edit_field</span> . <span class="q">&quot;_last_edited&quot;</span><span class="sc">;</span>
        <span class="k">for</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span><span class="i">@ids</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$comment</span> = <span class="i">$info</span>{<span class="i">$id</span>}{<span class="w">Edit_Comment</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">push</span> <span class="i">@</span>{ <span class="i">$data_ref</span>-&gt;{<span class="i">$comment_alias</span>} }<span class="cm">,</span> <span class="i">$comment</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$last_modified_time</span> = <span class="i">$info</span>{<span class="i">$id</span>}{<span class="w">Last_Modified</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">push</span> <span class="i">@</span>{ <span class="i">$data_ref</span>-&gt;{<span class="i">$modified_time_alias</span>} }<span class="cm">,</span> <span class="i">$last_modified_time</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################################</span>
<span class="c">#</span>
<span class="c">#  Method used to create new attribute types in the database.</span>
<span class="c">#</span>
<span class="c">##################################</span>
<a name="set_new_attribute_type-"></a><span class="k">sub </span><span class="m">set_new_attribute_type</span> <span class="s">{</span>
<span class="c">##################################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'class,name,inherited,group'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$class</span>   = <span class="i">$args</span>{-<span class="w">class</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$name</span>    = <span class="i">$args</span>{-<span class="w">name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$inherit</span> = <span class="i">$args</span>{-<span class="w">inherit</span>} || <span class="q">'No'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span>   = <span class="i">$args</span>{-<span class="w">group</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format</span>  = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>   = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$name</span> !~ <span class="q">/^\w+$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Invalid attribute name '$name'&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$inherit</span> !~ <span class="q">/^(yes|no)$/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Invalid inheritence mode '$inherit'&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$group</span> = <span class="i">$self</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> <span class="q">'FK_Grp__ID'</span><span class="cm">,</span> <span class="i">$group</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">$group</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@tables</span> = <span class="i">$self</span><span class="i">-&gt;tables</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span><span class="s">(</span> <span class="q">/^${class}_Attribute$/</span><span class="cm">,</span> <span class="i">@tables</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Invalid attribute type '$class'&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@fields</span> = <span class="q">qw(Attribute_Name Attribute_Format Attribute_Type FK_Grp__ID Inherited Attribute_Class)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values</span> = <span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="q">''</span><span class="cm">,</span> <span class="q">'Text'</span><span class="cm">,</span> <span class="i">$group</span><span class="cm">,</span> <span class="i">$inherit</span><span class="cm">,</span> <span class="i">$class</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$output</span> = <span class="i">$self</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="q">'Attribute'</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> \<span class="i">@values</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$output</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################</span>
<a name="query_preparation-"></a><span class="k">sub </span><span class="m">query_preparation</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%Query_parameters</span><span class="sc">;</span>
    <span class="k">return</span> \<span class="i">%Query_parameters</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################################</span>
<span class="c">#</span>
<span class="c"># Handling api output pipeline</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">################</span>
<a name="api_output-"></a><span class="k">sub </span><span class="m">api_output</span> <span class="s">{</span>
<span class="c">################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'data'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$data_ref</span> = <span class="i">$args</span>{-<span class="w">data</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$key</span>      = <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>    = <span class="i">$args</span>{-<span class="w">order</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$cache</span>    = <span class="i">$args</span>{-<span class="w">cache</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format</span>   = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sql</span>      = <span class="i">$args</span>{-<span class="w">sql</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span>    = <span class="i">$args</span>{-<span class="w">start</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$save</span>     = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input</span>    = <span class="i">$args</span>{-<span class="w">input</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>    = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>    = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$customized_output</span> ||= <span class="i">$input</span>-&gt;{-<span class="w">customized_output</span>} || <span class="i">$args</span>{-<span class="w">customized_output</span>}<span class="sc">;</span>    <span class="c">### Flag to indicate this structure should not be altered</span>
    <span class="k">my</span> <span class="i">$summary</span> = <span class="i">$args</span>{-<span class="w">summary</span>}<span class="sc">;</span>                                                          <span class="c">## optional note to be logged (if applicable)</span>
    <span class="k">my</span> <span class="i">$log</span> = <span class="k">defined</span> <span class="i">$args</span>{ -<span class="k">log</span> } ? <span class="i">$args</span>{ -<span class="k">log</span> } <span class="co">:</span> <span class="n">1</span><span class="sc">;</span>                                    <span class="c">## allow manual override of log function only</span>
    <span class="k">my</span> <span class="i">$key_hash</span><span class="sc">;</span>
    <span class="i">$key_hash</span> = <span class="i">$input</span>-&gt;{<span class="q">'-key_hash'</span>} <span class="k">if</span> <span class="k">defined</span> <span class="i">%$input</span><span class="sc">;</span>

    <span class="i">$quiet</span> ||= <span class="i">$input</span>-&gt;{-<span class="w">quiet</span>} <span class="k">if</span> <span class="k">defined</span> <span class="i">%$input</span><span class="sc">;</span>

    <span class="i">$format</span> ||= <span class="i">$input</span>-&gt;{<span class="q">'-format'</span>} <span class="k">if</span> <span class="k">defined</span> <span class="i">%$input</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$customized_output</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## correct data values regardless of the output structure ##</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="c">### this assumes the output structure is in standard form ###</span>
        <span class="c">### Getting path from loaded module because someone can call API in their own directory</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$mypath</span><span class="s">)</span> = <span class="i">$INC</span>{<span class="q">'alDente/alDente_API.pm'</span>} =~ <span class="q">/^(.*)alDente\/alDente_API\.pm$/</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@INC</span><span class="cm">,</span> <span class="q">&quot;$mypath/Imported/&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">require</span> <span class="w">Text::Unidecode</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$data_ref</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">@values</span> = <span class="i">@</span>{ <span class="i">$data_ref</span>-&gt;{<span class="i">$key</span>} }<span class="sc">;</span>
            <span class="k">map</span> <span class="s">{</span> <span class="i">$_</span> = <span class="i">Text::Unidecode::unidecode</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span> <span class="s">}</span> <span class="i">@values</span><span class="sc">;</span>
            <span class="i">$data_ref</span>-&gt;{<span class="i">$key</span>} = \<span class="i">@values</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$logged_params</span> = <span class="k">pop</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">logged_params</span>} }<span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$log</span> <span class="k">and</span> <span class="i">$logged_params</span> <span class="k">and</span> <span class="i">$self</span>-&gt;{<span class="w">log_call</span>} <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$message</span> = <span class="i">$logged_params</span><span class="sc">;</span>
        <span class="i">$message</span> .= <span class="q">&quot;** Summary **\n&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$summary</span><span class="s">)</span> <span class="s">{</span> <span class="i">$message</span> .= <span class="q">&quot;$summary\n&quot;</span> <span class="s">}</span>    <span class="c">## optional message supplied by argument</span>

        <span class="i">$message</span> .= <span class="q">&quot;Login Name: $self-&gt;{DB_user} ($self-&gt;{LIMS_user}) ($self-&gt;{web_service_user})\n&quot;</span><span class="sc">;</span>
        <span class="i">$message</span> .= <span class="q">&quot;Host: $self-&gt;{host}.$self-&gt;{dbase}\n&quot;</span><span class="sc">;</span>

        <span class="c">## estimate data output size ##</span>
        <span class="k">my</span> <span class="i">$data_dump</span> = <span class="i">Dumper</span><span class="s">(</span><span class="i">$data_ref</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$data_dump</span> =~ <span class="q">s/\s//g</span><span class="sc">;</span>
        <span class="i">$data_dump</span> =~ <span class="q">s/\'//g</span><span class="sc">;</span>
        <span class="i">$data_dump</span> =~ <span class="q">s/\$VAR\d+=\{//g</span><span class="sc">;</span>
        <span class="i">$data_dump</span> =~ <span class="q">s/=&gt;//g</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$data_size</span> = <span class="k">length</span><span class="s">(</span><span class="i">$data_dump</span><span class="s">)</span><span class="sc">;</span>

        <span class="i">$message</span> .= <span class="q">&quot;Size: ~$data_size bytes &quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$customized_output</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">%data</span><span class="sc">;</span>
            <span class="i">%data</span> = <span class="i">%</span>{<span class="i">$data_ref</span>} <span class="k">if</span> <span class="i">$data_ref</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">@fields_retrieved</span> = <span class="k">keys</span> <span class="i">%data</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$data</span>{ <span class="i">$fields_retrieved</span>[<span class="n">0</span>] } <span class="s">)</span> <span class="s">{</span>
                <span class="i">$message</span> .= <span class="q">'('</span> . <span class="k">int</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$data</span>{ <span class="i">$fields_retrieved</span>[<span class="n">0</span>] } } <span class="s">)</span> . <span class="q">&quot; records)\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$message</span> .= <span class="q">&quot;(No Records)\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>

            <span class="c">## save this data as an attribute of this object (for easily accessible records via get_record etc)</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$save</span><span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;_initialize_data</span><span class="s">(</span> \<span class="i">%data</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$message</span> .= <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c">## indicate time spent executing query ##</span>
        <span class="k">my</span> <span class="i">$DB_user</span>   = <span class="i">$self</span>-&gt;{<span class="w">DB_user</span>}<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$LIMS_user</span> = <span class="i">$self</span>-&gt;{<span class="w">LIMS_user</span>}<span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$start</span><span class="s">)</span> <span class="s">{</span>    <span class="c">## log time of query ##</span>
            <span class="k">my</span> <span class="i">$end</span>  = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$time</span> = <span class="i">$end</span> - <span class="i">$start</span><span class="sc">;</span>
            <span class="i">$message</span> .= <span class="q">&quot;*** Executed method in $time second(s) ***\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$sql</span> =~ <span class="q">/^1$/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$sql</span> = <span class="i">$self</span>-&gt;{<span class="w">last_query</span>} <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$sql</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$message</span> .= <span class="q">&quot;Query:\n************\n$sql\n&quot;</span><span class="sc">;</span>

            <span class="c">#	$message .= &quot;STDERR: $!\n&quot; if $!</span>
            <span class="i">$message</span> .= <span class="q">&quot;Error: $DBI::errstr\n&quot;</span> <span class="k">if</span> <span class="i">$DBI::errstr</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">Message</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$debug</span> &amp;&amp; !<span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#if ($self-&gt;{dbase} eq $Configs{PRODUCTION_DATABASE}) {</span>
        <span class="c">#    use Digest::MD5  qw(md5_hex);</span>
        <span class="c">#    my $md5_string = md5_hex(objToJson($data_ref));</span>
        <span class="c">#    $message .= &quot;\nMD5_Output:\t$md5_string\n&quot;;</span>
        <span class="c">#}</span>

        <span class="k">unless</span> <span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">log_file</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;set_log_file</span><span class="s">(</span><span class="s">)</span> <span class="s">}</span>

        <span class="i">&amp;log_usage</span><span class="s">(</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="i">$self</span>-&gt;{<span class="w">log_file</span>}<span class="cm">,</span> -<span class="w">message</span> <span class="cm">=&gt;</span> <span class="i">$message</span><span class="cm">,</span> -<span class="w">include</span> <span class="cm">=&gt;</span> <span class="q">'source'</span><span class="cm">,</span> -<span class="w">chmod</span> <span class="cm">=&gt;</span> <span class="n">666</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## convert  Hash of Array to Array of Hashes (for each key) ##</span>
    <span class="k">print</span> <span class="q">&quot;\n**************** KEY ON $key ******************\n&quot;</span> <span class="k">unless</span> <span class="s">(</span> <span class="i">$quiet</span> || !<span class="i">$key</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$customized_output</span> &amp;&amp; <span class="s">(</span> <span class="i">$key</span> || <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/array/i</span> <span class="s">)</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> =~ <span class="q">/(.*) as (.*)/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$key</span> = <span class="i">$2</span> <span class="s">}</span>

        <span class="c">## return values will sometimes truncate table name...</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> =~ <span class="q">/(.+)\.(.+)/</span> &amp;&amp; !<span class="k">defined</span> <span class="i">$data_ref</span>-&gt;{<span class="i">$key</span>} &amp;&amp; <span class="k">defined</span> <span class="i">$data_ref</span>-&gt;{<span class="i">$2</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$key</span> = <span class="i">$2</span> <span class="s">}</span>

        <span class="k">my</span> <span class="i">$returnval</span> = <span class="i">convert_HofA_to_AofH</span><span class="s">(</span> <span class="i">$data_ref</span><span class="cm">,</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$order</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$cache</span><span class="s">)</span> <span class="s">{</span> <span class="i">&amp;store</span><span class="s">(</span> <span class="i">$returnval</span><span class="cm">,</span> <span class="i">$cache</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">return</span> <span class="i">$returnval</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$key_hash</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$returnval</span> = <span class="i">convert_HofA_to_HHofA</span><span class="s">(</span> <span class="i">$data_ref</span><span class="cm">,</span> <span class="i">$key_hash</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$cache</span><span class="s">)</span> <span class="s">{</span> <span class="i">&amp;store</span><span class="s">(</span> <span class="i">$returnval</span><span class="cm">,</span> <span class="i">$cache</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">return</span> <span class="i">$returnval</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>

        <span class="c">#	Message(&quot;store data ($cache)&quot;);</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$cache</span><span class="s">)</span> <span class="s">{</span> <span class="i">&amp;store</span><span class="s">(</span> <span class="i">$data_ref</span><span class="cm">,</span> <span class="i">$cache</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">return</span> <span class="i">$data_ref</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">###########################</span>
<a name="customize_join_conditions-"></a><span class="k">sub </span><span class="m">customize_join_conditions</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'joins,left_joins'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$joins</span>      = <span class="i">$args</span>{-<span class="w">joins</span>}      || <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$left_joins</span> = <span class="i">$args</span>{-<span class="w">left_joins</span>} || <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$input_joins</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@keys</span> = <span class="k">keys</span> <span class="i">%$input_joins</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">@keys</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$joins</span>-&gt;{<span class="i">$key</span>} = <span class="i">$input_joins</span>-&gt;{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$input_left_joins</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@keys</span> = <span class="k">keys</span> <span class="i">%$input_left_joins</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">@keys</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$left_joins</span>-&gt;{<span class="i">$key</span>} = <span class="i">$input_left_joins</span>-&gt;{<span class="i">$key</span>} <span class="k">unless</span> <span class="k">defined</span> <span class="i">$joins</span>-&gt;{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">################</span>
<span class="c">#</span>
<span class="c"># Map aliases to the original fields in the database based upon the defined 'Aliases' hash.</span>
<span class="c">#</span>
<span class="c"># eg.  Field{library} = 'Library.Library_Name'</span>
<span class="c">#</span>
<span class="c"># Return: hash (keys = aliases for fields; values = actual fields in database)</span>
<span class="c">################</span>
<a name="map_to_fields-"></a><span class="k">sub </span><span class="m">map_to_fields</span> <span class="s">{</span>
<span class="c">################</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'list,map,tables'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$field_list</span> = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$map</span>        = <span class="i">$args</span>{ -<span class="k">map</span> }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tables</span>     = <span class="i">$args</span>{-<span class="w">tables</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$order</span>      = <span class="i">$args</span>{-<span class="w">order</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group</span><span class="sc">;</span>
    <span class="i">$group</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">group</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$args</span>{-<span class="w">group</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$KEY</span><span class="sc">;</span>
    <span class="i">$KEY</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">key</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>      = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$joins</span>      = <span class="i">$args</span>{-<span class="w">joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$left_joins</span> = <span class="i">$args</span>{-<span class="w">left_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="i">$args</span>{-<span class="w">conditions</span>} || <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Field</span><span class="sc">;</span>    <span class="c">## hash in which to store field mapping</span>
    <span class="k">my</span> <span class="i">$all_tables</span> = <span class="i">$tables</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$joins</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$all_tables</span> .= <span class="q">&quot;,$key&quot;</span> <span class="k">unless</span> <span class="i">$all_tables</span> =~ <span class="q">/\b$key\b/</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$left_joins</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$all_tables</span> .= <span class="q">&quot;,$key&quot;</span> <span class="k">unless</span> <span class="i">$all_tables</span> =~ <span class="q">/\b$key\b/</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$all_tables</span><span class="s">)</span> <span class="s">{</span> <span class="i">$all_tables</span> = <span class="k">keys</span> <span class="i">%Aliases</span><span class="sc">;</span> <span class="k">print</span> <span class="q">&quot;Checking for aliases in all tables\n&quot;</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## list of all possible alias keys.. ##</span>
    <span class="k">my</span> <span class="i">@table_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$all_tables</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">### ADD alias tables such as Read or Run</span>
    <span class="k">my</span> <span class="i">@additional_aliases</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span><span class="i">@table_list</span><span class="s">)</span> <span class="s">{</span>

        <span class="c"># just use table name - exclude AS field</span>
        <span class="k">my</span> <span class="i">$real_table</span> = <span class="i">$table</span><span class="sc">;</span>
        <span class="i">$table</span> =~ <span class="q">s/\s*(\w+)\s+AS.*/$1/i</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$object_aliases</span>{<span class="i">$table</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">@alias_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$object_aliases</span>{<span class="i">$table</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@additional_aliases</span><span class="cm">,</span> <span class="i">@alias_list</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@table_list</span><span class="cm">,</span> <span class="i">@additional_aliases</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">@table_list</span> = <span class="i">&amp;RGTools::RGIO::adjust_list</span><span class="s">(</span> \<span class="i">@table_list</span><span class="cm">,</span> <span class="q">'unique'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">### Get unique list</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$group</span><span class="s">)</span> <span class="s">{</span>    <span class="c">## add group field to field list if necessary ...</span>

        <span class="i">$group</span> = <span class="i">replace_Aliases</span><span class="s">(</span>
            -<span class="w">tables</span>  <span class="cm">=&gt;</span> \<span class="i">@table_list</span><span class="cm">,</span>
            -<span class="w">aliases</span> <span class="cm">=&gt;</span> \<span class="i">%Aliases</span><span class="cm">,</span>
            -<span class="w">query</span>   <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
            -<span class="w">debug</span>   <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">debug</span>}<span class="cm">,</span>
            -<span class="w">quiet</span>   <span class="cm">=&gt;</span> <span class="i">$quiet</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Field</span>{<span class="w">group</span>} = <span class="i">$group</span><span class="sc">;</span>

        <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/\b$group\b/</span><span class="cm">,</span> <span class="i">@$field_list</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$group</span> =~ <span class="q">/(.*) as (.*)/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$Field</span>{<span class="w">group</span>} = <span class="i">$1</span><span class="sc">;</span>    <span class="c">## remove label from group, but include label in list</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@$field_list</span><span class="cm">,</span> <span class="i">$group</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@$field_list</span><span class="cm">,</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$group</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$KEY</span><span class="s">)</span> <span class="s">{</span>                        <span class="c">## add key field to field list if necessary ...</span>
        <span class="i">$KEY</span> = <span class="i">replace_Aliases</span><span class="s">(</span>
            -<span class="w">tables</span>  <span class="cm">=&gt;</span> \<span class="i">@table_list</span><span class="cm">,</span>
            -<span class="w">aliases</span> <span class="cm">=&gt;</span> \<span class="i">%Aliases</span><span class="cm">,</span>
            -<span class="w">query</span>   <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
            -<span class="w">debug</span>   <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">debug</span>}<span class="cm">,</span>
            -<span class="w">quiet</span>   <span class="cm">=&gt;</span> <span class="i">$quiet</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/\b$KEY\b/</span><span class="cm">,</span> <span class="i">@$field_list</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$Field</span>{<span class="w">key</span>} = <span class="i">$KEY</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$KEY</span> =~ <span class="q">/(.*) as (.*)/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$label</span> = <span class="i">$2</span><span class="sc">;</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@$field_list</span><span class="cm">,</span> <span class="i">$KEY</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$Field</span>{<span class="w">key</span>} = <span class="i">$label</span><span class="sc">;</span>    <span class="c">## remove label from key, but include label in list</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$KEY</span> =~ <span class="q">/^concat/i</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$KEY</span> = <span class="q">&quot;$KEY AS KEYFIELD&quot;</span><span class="sc">;</span>    <span class="c">## leave if already concatenated ...</span>
                <span class="s">}</span>
                <span class="k">elsif</span> <span class="s">(</span> <span class="i">$KEY</span> =~ <span class="q">/,/</span> <span class="s">)</span> <span class="s">{</span>           <span class="c">## concatenate a list of fields, separated by a - ...</span>
                    <span class="k">my</span> <span class="i">@fields</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$KEY</span><span class="sc">;</span>
                    <span class="i">$KEY</span> = <span class="q">&quot;concat(&quot;</span><span class="sc">;</span>
                    <span class="i">$KEY</span> .= <span class="k">join</span> <span class="q">&quot;,'-',&quot;</span><span class="cm">,</span> <span class="i">@fields</span><span class="sc">;</span>
                    <span class="i">$KEY</span> .= <span class="q">&quot;) AS KEYFIELD&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="i">$KEY</span> = <span class="q">&quot;$KEY AS KEYFIELD&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@$field_list</span><span class="cm">,</span> <span class="i">$KEY</span> <span class="s">)</span><span class="sc">;</span>
                <span class="c">## Save this field as a separately labelled Key field ##</span>
                <span class="i">$Field</span>{<span class="w">key</span>} = <span class="q">'KEYFIELD'</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$field</span> <span class="s">(</span><span class="i">@$field_list</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$selected</span> = <span class="i">$field</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$alias</span>    = <span class="i">$field</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$prompt</span>   = <span class="i">$field</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$field</span> =~ <span class="q">/(.+) AS (\w+)/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$selected</span> = <span class="i">$1</span><span class="sc">;</span>
            <span class="i">$prompt</span>   = <span class="i">$2</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$selected</span> = <span class="i">replace_Aliases</span><span class="s">(</span>
            -<span class="w">tables</span>  <span class="cm">=&gt;</span> \<span class="i">@table_list</span><span class="cm">,</span>
            -<span class="w">aliases</span> <span class="cm">=&gt;</span> \<span class="i">%Aliases</span><span class="cm">,</span>
            -<span class="w">query</span>   <span class="cm">=&gt;</span> <span class="i">$selected</span><span class="cm">,</span>
            -<span class="w">debug</span>   <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">debug</span>}<span class="cm">,</span>
            -<span class="w">quiet</span>   <span class="cm">=&gt;</span> <span class="i">$quiet</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$prompt</span> <span class="k">eq</span> <span class="i">$selected</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$prompt</span> = <span class="q">'`'</span> . <span class="i">$prompt</span> . <span class="q">'`'</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$Field</span>{<span class="i">$prompt</span>} = <span class="i">$selected</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$order</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$order</span> = <span class="i">replace_Aliases</span><span class="s">(</span>
            -<span class="w">tables</span>  <span class="cm">=&gt;</span> \<span class="i">@table_list</span><span class="cm">,</span>
            -<span class="w">aliases</span> <span class="cm">=&gt;</span> \<span class="i">%Aliases</span><span class="cm">,</span>
            -<span class="w">query</span>   <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
            -<span class="w">debug</span>   <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">debug</span>}<span class="cm">,</span>
            -<span class="w">quiet</span>   <span class="cm">=&gt;</span> <span class="i">$quiet</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Field</span>{<span class="w">order</span>} = <span class="i">$order</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$conditions</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$conditions</span> = <span class="i">replace_Aliases</span><span class="s">(</span>
            -<span class="w">tables</span>  <span class="cm">=&gt;</span> \<span class="i">@table_list</span><span class="cm">,</span>
            -<span class="w">aliases</span> <span class="cm">=&gt;</span> \<span class="i">%Aliases</span><span class="cm">,</span>
            -<span class="w">query</span>   <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
            -<span class="w">debug</span>   <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">debug</span>}<span class="cm">,</span>
            -<span class="w">quiet</span>   <span class="cm">=&gt;</span> <span class="i">$quiet</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Field</span>{<span class="w">conditions</span>} = <span class="i">$conditions</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$Field</span>{<span class="w">table_list</span>} = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@table_list</span><span class="sc">;</span>
    <span class="k">return</span> \<span class="i">%Field</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<a name="extract_Aliases-"></a><span class="k">sub </span><span class="m">extract_Aliases</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">%args</span>      = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$table_ref</span> = <span class="i">$args</span>{-<span class="w">tables</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$alias_ref</span> = <span class="i">$args</span>{-<span class="w">aliases</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$query</span>     = <span class="i">$args</span>{-<span class="w">query</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>     = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>     = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%aliases</span> = <span class="i">$alias_ref</span> ? <span class="i">%$alias_ref</span> <span class="co">:</span> <span class="i">%Aliases</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@tables</span>  = <span class="i">$table_ref</span> ? <span class="i">@$table_ref</span> <span class="co">:</span> <span class="k">keys</span> <span class="i">%aliases</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@aliases</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span><span class="i">@tables</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$aliases</span>{<span class="i">$table</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$alias</span> = <span class="i">$aliases</span>{<span class="i">$table</span>}{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$quotes</span><span class="sc">;</span>
            <span class="s">(</span> <span class="i">$query</span><span class="cm">,</span> <span class="i">$quotes</span> <span class="s">)</span> = <span class="i">_remove_quotes</span><span class="s">(</span><span class="i">$query</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$query</span> =~ <span class="q">s/\b$key\b/$alias/g</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Found $key ($alias) in $query&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{-<span class="w">debug</span>} &amp;&amp; !<span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">push</span> <span class="i">@aliases</span><span class="cm">,</span> <span class="q">&quot;$table.$key&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$query</span> = <span class="i">_insert_quotes</span><span class="s">(</span> -<span class="w">string</span> <span class="cm">=&gt;</span> <span class="i">$query</span><span class="cm">,</span> -<span class="w">quotes</span> <span class="cm">=&gt;</span> <span class="i">$quotes</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">@aliases</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<a name="replace_Aliases-"></a><span class="k">sub </span><span class="m">replace_Aliases</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">%args</span>      = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tables</span>    = <span class="i">$args</span>{-<span class="w">tables</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$alias_ref</span> = <span class="i">$args</span>{-<span class="w">aliases</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$query</span>     = <span class="i">$args</span>{-<span class="w">query</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>     = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>     = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%aliases</span><span class="sc">;</span>
    <span class="i">%aliases</span> = <span class="i">%$alias_ref</span> <span class="k">if</span> <span class="i">$alias_ref</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span><span class="i">@$tables</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$aliases</span>{<span class="i">$table</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$alias</span> = <span class="i">$aliases</span>{<span class="i">$table</span>}{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$quotes</span><span class="sc">;</span>
            <span class="s">(</span> <span class="i">$query</span><span class="cm">,</span> <span class="i">$quotes</span> <span class="s">)</span> = <span class="i">_remove_quotes</span><span class="s">(</span><span class="i">$query</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$query</span> =~ <span class="q">s/\b$key\b/$alias/g</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Convert $key -&gt; $alias ($query)&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{-<span class="w">debug</span>} &amp;&amp; !<span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$query</span> = <span class="i">_insert_quotes</span><span class="s">(</span> -<span class="w">string</span> <span class="cm">=&gt;</span> <span class="i">$query</span><span class="cm">,</span> -<span class="w">quotes</span> <span class="cm">=&gt;</span> <span class="i">$quotes</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$query</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################</span>
<span class="c">#</span>
<span class="c"># Checks current conditions, fields etc to ensure all required tables are included.</span>
<span class="c"># Tables which can be optionally included are included if necessary</span>
<span class="c">#</span>
<span class="c"># Input:</span>
<span class="c">#</span>
<span class="c"># Return: dynamically added joins (eg 'LEFT JOIN TableA ON TableA.X=TableB.Y LEFT JOIN TableZ ON J=K')</span>
<span class="c">###########################</span>
<a name="dynamic_joins-"></a><span class="k">sub </span><span class="m">dynamic_joins</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'tables'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$table_list</span> = <span class="i">$args</span>{-<span class="w">table_list</span>}<span class="sc">;</span>                        <span class="c">## current tables</span>
    <span class="k">my</span> <span class="i">$fields</span>     = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>                            <span class="c">## current list of fields to extract</span>
    <span class="k">my</span> <span class="i">$condition</span>  = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>                         <span class="c">## current conditions</span>
    <span class="k">my</span> <span class="i">$joins</span>      = <span class="i">$args</span>{ -<span class="k">join</span> }<span class="sc">;</span>                            <span class="c">## regular join conditions (has as below)</span>
    <span class="k">my</span> <span class="i">$left_joins</span> = <span class="i">$args</span>{-<span class="w">left_join</span>}<span class="sc">;</span>                         <span class="c">## hash (keys = left join tables; values = left join condition)</span>
    <span class="k">my</span> <span class="i">$quiet</span>      = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>        = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>      = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="c">## get list of tables always included from starting table list &amp; joins</span>
    <span class="k">my</span> <span class="i">@tables</span> = <span class="i">included_tables</span><span class="s">(</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$table_list</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@required_table_list</span> = <span class="i">included_tables</span><span class="s">(</span> -<span class="w">condition</span> <span class="cm">=&gt;</span> <span class="i">$condition</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="i">$fields</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$pending_tables</span> <span class="s">)</span> = <span class="i">RGmath::intersection</span><span class="s">(</span> \<span class="i">@required_table_list</span><span class="cm">,</span> \<span class="i">@tables</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">#</span>

    <span class="c">## add left joins ##</span>
    <span class="k">my</span> <span class="i">%left_join_hash</span><span class="sc">;</span>
    <span class="i">%left_join_hash</span> = <span class="i">%$left_joins</span> <span class="k">if</span> <span class="i">$left_joins</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@add_tables</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@add_joins</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@required_tables</span> = <span class="i">@</span>{ <span class="i">RGmath::distinct_list</span><span class="s">(</span><span class="i">$pending_tables</span><span class="s">)</span> }<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$abort</span> = <span class="n">0</span><span class="sc">;</span>                                                                              <span class="c">## counter to bail if we get stuck in loop below due to poor setup logic ##</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@required_tables</span><span class="s">)</span> &gt; <span class="k">int</span><span class="s">(</span><span class="i">@add_tables</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c">#	my ($intersection, $missing) = RGmath::intersection(\@required_tables, \@add_tables);</span>
        <span class="c">#        foreach my $pending_table (@$missing) {</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$pending_table</span> <span class="s">(</span><span class="i">@required_tables</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$alias</span> = <span class="i">$pending_table</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$pending_table</span> =~ <span class="q">/(.*) AS (.*)/i</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$alias</span> = <span class="i">$2</span><span class="sc">;</span>

                <span class="c">#		if ( grep /^$pending_table$/, @add_tables &amp;&amp; !(grep /^$alias$/, @add_tables) ) { push @add_tables, $alias; next; }                                  ## already included</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^($pending_table|$alias)$/</span><span class="cm">,</span> <span class="i">@add_tables</span> <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>    <span class="c">## already included</span>

            <span class="k">if</span> <span class="s">(</span> !<span class="i">$joins</span>-&gt;{<span class="i">$pending_table</span>} &amp;&amp; !<span class="i">$left_joins</span>-&gt;{<span class="i">$pending_table</span>} <span class="s">)</span> <span class="s">{</span>

                <span class="c">#check to see there is pending table as &quot;as&quot;</span>
                <span class="k">my</span> <span class="i">$new_pending_table</span> = <span class="i">$pending_table</span><span class="sc">;</span>
                <span class="k">for</span> <span class="k">my</span> <span class="i">$condition_table</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$</span>{<span class="w">joins</span>} <span class="s">)</span> <span class="s">{</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="i">$condition_table</span> =~ <span class="q">/(\w+) AS $pending_table/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$new_pending_table</span> = <span class="i">$condition_table</span><span class="sc">;</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>
                <span class="s">}</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$new_pending_table</span> <span class="k">eq</span> <span class="i">$pending_table</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">for</span> <span class="k">my</span> <span class="i">$condition_table</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$</span>{<span class="w">left_joins</span>} <span class="s">)</span> <span class="s">{</span>
                        <span class="k">if</span> <span class="s">(</span> <span class="i">$condition_table</span> =~ <span class="q">/(\w+) AS $pending_table/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$new_pending_table</span> = <span class="i">$condition_table</span><span class="sc">;</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>
                    <span class="s">}</span>
                <span class="s">}</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$new_pending_table</span> <span class="k">ne</span> <span class="i">$pending_table</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$pending_table</span> = <span class="i">$new_pending_table</span><span class="sc">;</span> <span class="s">}</span>
            <span class="s">}</span>

            <span class="k">my</span> <span class="i">$join_condition</span> = <span class="i">$joins</span>-&gt;{<span class="i">$pending_table</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$join_type</span>      = <span class="q">'INNER JOIN'</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> !<span class="i">$join_condition</span> &amp;&amp; <span class="s">(</span> <span class="k">my</span> <span class="i">$lj</span> = <span class="i">$left_joins</span>-&gt;{<span class="i">$pending_table</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$join_type</span>      = <span class="q">'LEFT JOIN'</span><span class="sc">;</span>
                <span class="i">$join_condition</span> = <span class="i">$lj</span><span class="sc">;</span>
            <span class="s">}</span>

            <span class="k">if</span> <span class="s">(</span> <span class="i">$join_condition</span> &amp;&amp; <span class="i">necessary_tables_included</span><span class="s">(</span> -<span class="w">condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span> -<span class="w">current_tables</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="i">@tables</span><span class="cm">,</span> <span class="i">@add_tables</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="i">$alias</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="c">## join condition may be satisfied by current included tables ##</span>
                <span class="k">push</span> <span class="i">@add_tables</span><span class="cm">,</span> <span class="i">$alias</span><span class="sc">;</span>
                <span class="k">push</span> <span class="i">@add_joins</span><span class="cm">,</span>  <span class="q">&quot; $join_type $pending_table ON $join_condition&quot;</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Added $pending_table&quot;</span><span class="s">)</span> <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="c">## found join table requiring additional intermediate table - need to join it first ... ##</span>
                <span class="k">my</span> <span class="i">@intermediate_tables</span> = <span class="i">included_tables</span><span class="s">(</span> -<span class="w">condition</span> <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span> -<span class="w">exclude</span> <span class="cm">=&gt;</span> <span class="i">$pending_table</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">foreach</span> <span class="k">my</span> <span class="i">$intermediate</span> <span class="s">(</span><span class="i">@intermediate_tables</span><span class="s">)</span> <span class="s">{</span>
                    <span class="k">if</span> <span class="s">(</span> !<span class="k">grep</span> <span class="q">/^$intermediate$/</span><span class="cm">,</span> <span class="i">@required_tables</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@required_tables</span><span class="cm">,</span> <span class="i">$intermediate</span> <span class="s">}</span>
                    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;need to include @intermediate_tables first...&quot;</span><span class="s">)</span> <span class="s">}</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$abort</span>++ &gt; <span class="n">20</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">##  abort this loop if it appears to go on too long (probably a problem with the QUERY logic in the api ##</span>
            <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Warning: probable logic problem with query&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">Call_Stack</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">last</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$dynamic_join</span> = <span class="k">join</span> <span class="q">' '</span><span class="cm">,</span> <span class="i">@add_joins</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$dynamic_join</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># Simply checks current tables to see if necessary tables are included to support condition</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Return: 1 if ok</span>
<span class="c">#####################################</span>
<a name="necessary_tables_included-"></a><span class="k">sub </span><span class="m">necessary_tables_included</span> <span class="s">{</span>
<span class="c">#####################################</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$condition</span>  = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$join_table</span> = <span class="i">$args</span>{-<span class="w">table</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@tables</span>     = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">current_tables</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$included</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">$condition</span> =~ <span class="q">s /(\w+)\.(\w+)/ /</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$ref_table</span> = <span class="i">$1</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$ref_table</span> <span class="k">eq</span> <span class="i">$join_table</span> || <span class="i">$join_table</span> =~ <span class="q">/(\w+) AS $ref_table/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## ok ##</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$ref_table$/</span><span class="cm">,</span> <span class="i">@tables</span> <span class="s">)</span> || <span class="s">(</span> <span class="k">grep</span> <span class="q">/(\w+) AS $ref_table/i</span><span class="cm">,</span> <span class="i">@tables</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$included</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$included</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$included</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Retrieve list of tables based upon supplied condition / tables / fields</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">##########################</span>
<a name="included_tables-"></a><span class="k">sub </span><span class="m">included_tables</span> <span class="s">{</span>
<span class="c">##########################</span>
    <span class="k">my</span> <span class="i">%args</span>      = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$condition</span> = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@tables</span>    = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">tables</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields</span>    = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">fields</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$exclude</span>   = <span class="i">$args</span>{-<span class="w">exclude</span>}<span class="sc">;</span>                                        <span class="c">## exclude table when using condition parameter (enables ignoring of recursive references) ##</span>
    <span class="k">my</span> <span class="i">$debug</span>     = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@included</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">@tables</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span><span class="i">@tables</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span>   <span class="s">(</span> <span class="i">$table</span> =~ <span class="q">/(\w+) AS (\w+)/</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@included</span><span class="cm">,</span> <span class="i">$1</span> <span class="s">}</span>
            <span class="k">else</span>                                <span class="s">{</span> <span class="k">push</span> <span class="i">@included</span><span class="cm">,</span> <span class="i">$table</span> <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$condition</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">while</span> <span class="s">(</span> <span class="i">$condition</span> =~ <span class="q">s/(\w+)\.(\w+)//</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## extract any conditional references to tables ##</span>
            <span class="k">my</span> <span class="i">$table</span> = <span class="i">$1</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="i">$exclude</span> &amp;&amp; <span class="i">$exclude</span> !~ <span class="q">/(\w+) AS $table/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@included</span><span class="cm">,</span> <span class="i">$1</span> <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">@fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$field</span> <span class="s">(</span><span class="i">@fields</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">while</span> <span class="s">(</span> <span class="i">$field</span> =~ <span class="q">/(\w+)\.(\w+)/g</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$2</span> <span class="k">eq</span> <span class="q">'jpg'</span> <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>    <span class="c">#&lt;CONSTRUCTION&gt; Should have a better way to check this is a valid field</span>
                <span class="c">## extract table names from fully qualified fields ##</span>
                <span class="k">my</span> <span class="i">$table</span> = <span class="i">$1</span><span class="sc">;</span>
                <span class="k">push</span> <span class="i">@included</span><span class="cm">,</span> <span class="i">$table</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Returned @included&quot;</span><span class="s">)</span> <span class="s">}</span>
    <span class="k">return</span> <span class="i">@included</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################################</span>
<span class="c">#</span>
<span class="c"># Temporary routine to Map old Clone IDs to new Sample_IDs</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Examples:</span>
<span class="c">#</span>
<span class="c">#   my @ids = $API-&gt;get_sample_ids(-alias_type=&gt;'MGC',-alias=&gt;['123','456']) };</span>
<span class="c">#</span>
<span class="c">#   my @ids = $API-&gt;get_sample_ids(-plate_id=&gt;1234,-well=&gt;'A07');</span>
<span class="c">#</span>
<span class="c">#   my @ids = $API-&gt;get_sample_ids(-plate_id=&gt;[1234,1235,1236],-well=&gt;['A07','G12','B09']);</span>
<span class="c">#</span>
<span class="c">#   my %ids = $API-&gt;get_sample_ids(-plate_id=&gt;1234);       ## returns hash since wells must be associated ##</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>

<span class="c"># Return hash (keys = 'Sample_Name','old_id','new_id')</span>
<span class="c">######################</span>
<a name="get_sample_ids-"></a><span class="k">sub </span><span class="m">get_sample_ids</span> <span class="s">{</span>
<span class="c">#####################</span>

    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'plate_id,well'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$quiet</span> = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>    <span class="c">## suppress feedback</span>

    <span class="k">my</span> <span class="i">$alias</span> = <span class="i">$args</span>{-<span class="w">alias</span>} || <span class="i">$args</span>{-<span class="w">alias_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$alias_type</span> = <span class="i">$args</span>{-<span class="w">alias_type</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plates</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>} || <span class="i">$args</span>{-<span class="w">plates</span>}<span class="sc">;</span>    <span class="c">## plate or array of plates</span>
    <span class="k">my</span> <span class="i">$wells</span> = <span class="i">$args</span>{-<span class="w">wells</span>}<span class="sc">;</span>                          <span class="c">## well or array of wells (according to plasticware)</span>

    <span class="k">my</span> <span class="i">$run_id</span>         = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sequenced_well</span> = <span class="i">$args</span>{-<span class="w">sequenced_well</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$format</span><span class="sc">;</span>
    <span class="i">$format</span> = <span class="i">$args</span>{<span class="q">'-format'</span>} || <span class="q">'array'</span><span class="sc">;</span>              <span class="c">## forced to hash if no well list. ($id = $hash{$plate_id}{$well})</span>

    <span class="k">my</span> <span class="i">$application</span>  = <span class="i">$args</span>{-<span class="w">application_type</span>}<span class="sc">;</span>        <span class="c">## eg. original, pooled, rearrayed</span>
    <span class="k">my</span> <span class="i">$library</span>      = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>                 <span class="c">## at least supply library with this (since large numbers being extracted)</span>
    <span class="k">my</span> <span class="i">$plate_number</span> = <span class="i">$args</span>{-<span class="w">plate_number</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>        = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%hash</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@sample_ids</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$alias</span> &amp;&amp; <span class="i">$alias_type</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## if alias &amp; alias_type supplied, generate sample_ids, and replace arguments ##</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">ref</span><span class="s">(</span><span class="i">$alias</span><span class="s">)</span> <span class="k">eq</span> <span class="q">'ARRAY'</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$alias</span> = <span class="k">join</span> <span class="q">&quot;','&quot;</span><span class="cm">,</span> <span class="i">@$alias</span> <span class="s">}</span>
        <span class="i">@sample_ids</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Alias'</span><span class="cm">,</span> <span class="q">&quot;FK_Sample__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Alias_Type = '$alias_type' AND Alias in ('$alias')&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
        <span class="c">## replace alias arguments with sample_id argument ##</span>
        <span class="i">$args</span>{-<span class="w">alias</span>}      = <span class="q">''</span><span class="sc">;</span>
        <span class="i">$args</span>{-<span class="w">alias_type</span>} = <span class="q">''</span><span class="sc">;</span>
        <span class="i">$args</span>{-<span class="w">sample_id</span>}  = \<span class="i">@sample_ids</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$plates</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## if plates supplied, ##</span>
        <span class="k">my</span> <span class="i">$tracked_well</span><span class="sc">;</span>     <span class="c">## figure out the well as tracked on this plate format (if size != format_size)</span>
        <span class="k">my</span> <span class="i">$original_well</span><span class="sc">;</span>    <span class="c">## figure out the well on the original plate (if size != original_size)</span>

        <span class="k">my</span> <span class="i">@plate_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@well_list</span>  = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$wells</span><span class="cm">,</span>  -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$wells</span> &amp;&amp; <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@plate_list</span><span class="s">)</span> != <span class="k">scalar</span><span class="s">(</span><span class="i">@well_list</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="q">&quot;ERROR: The number of plates (@plate_list) does not match the number of wells (@well_list)&quot;</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># Get plate size and plate format size</span>
        <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$plate_id</span> <span class="s">(</span><span class="i">@plate_list</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$sample_id</span> = <span class="n">0</span><span class="sc">;</span>

            <span class="c">## First figure out the tracked well</span>

            <span class="k">my</span> <span class="i">$info</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
                <span class="q">'Plate AS CP,Library_Plate AS CLP,Plate_Format AS CPF,Plate AS OP'</span><span class="cm">,</span>
                <span class="s">[</span> <span class="q">'CP.Plate_Size AS Child_Plate_Size'</span><span class="cm">,</span> <span class="q">'CPF.Well_Capacity_mL AS Child_Plate_Format_Size'</span><span class="cm">,</span> <span class="q">'CP.Parent_Quadrant AS Child_Parent_Quadrant'</span><span class="cm">,</span> <span class="q">'OP.Plate_ID AS Original_Plate_ID'</span><span class="cm">,</span> <span class="q">'OP.Plate_Size AS Original_Plate_Size'</span> <span class="s">]</span><span class="cm">,</span>
                <span class="q">&quot;WHERE CP.Plate_ID=CLP.FK_Plate__ID AND CPF.Plate_Format_ID=CP.FK_Plate_Format__ID AND CP.FKOriginal_Plate__ID=OP.Plate_ID AND CP.Plate_ID = $plate_id&quot;</span><span class="cm">,</span>
                -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'RH'</span>
            <span class="s">)</span><span class="sc">;</span>

            <span class="k">my</span> <span class="s">(</span> <span class="i">$child_plate_size</span><span class="cm">,</span> <span class="i">$child_plate_format_size</span><span class="cm">,</span> <span class="i">$child_parent_quadrant</span><span class="cm">,</span> <span class="i">$original_plate_id</span><span class="cm">,</span> <span class="i">$original_plate_size</span> <span class="s">)</span>
                = <span class="s">(</span> <span class="i">$info</span>-&gt;{<span class="w">Child_Plate_Size</span>}<span class="cm">,</span> <span class="i">$info</span>-&gt;{<span class="w">Child_Plate_Format_Size</span>}<span class="cm">,</span> <span class="i">$info</span>-&gt;{<span class="w">Child_Parent_Quadrant</span>}<span class="cm">,</span> <span class="i">$info</span>-&gt;{<span class="w">Original_Plate_ID</span>}<span class="cm">,</span> <span class="i">$info</span>-&gt;{<span class="w">Original_Plate_Size</span>} <span class="s">)</span><span class="sc">;</span>

            <span class="c">### generate list of wells if array of wells not included ##</span>
            <span class="k">my</span> <span class="i">@wells</span><span class="sc">;</span>

            <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@well_list</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="i">@wells</span> = <span class="s">(</span> <span class="i">$well_list</span>[<span class="i">$i</span>] <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$child_plate_size</span> =~ <span class="q">/96/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">@wells</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Well_Lookup'</span><span class="cm">,</span> <span class="q">'Plate_96'</span><span class="cm">,</span> <span class="q">&quot;WHERE Quadrant = 'a' ORDER BY Plate_96&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$format</span> = <span class="q">'hash'</span><span class="sc">;</span>    <span class="c">## force to hash if no wells provided ##</span>
            <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$child_plate_size</span> =~ <span class="q">/384/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">@unformatted_wells</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Well_Lookup'</span><span class="cm">,</span> <span class="q">'Plate_384'</span><span class="cm">,</span> <span class="q">&quot;WHERE 1 ORDER BY Plate_384&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">@wells</span> = <span class="i">&amp;alDente::Well::Format_Wells</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">wells</span> <span class="cm">=&gt;</span> \<span class="i">@unformatted_wells</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$format</span> = <span class="q">'hash'</span><span class="sc">;</span>    <span class="c">## force to hash if no wells provided ##</span>
            <span class="s">}</span>

            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$well</span> <span class="s">(</span><span class="i">@wells</span><span class="s">)</span> <span class="s">{</span>    <span class="c">## foreach well (if well list NOT supplied) ##</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">@well_list</span> &amp;&amp; <span class="i">$child_plate_size</span> =~ <span class="q">/96/</span> &amp;&amp; <span class="i">$child_plate_format_size</span> =~ <span class="q">/384/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="s">(</span><span class="i">$tracked_well</span><span class="s">)</span> = <span class="i">alDente::Well::Convert_Wells</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">wells</span> <span class="cm">=&gt;</span> <span class="i">$well</span><span class="cm">,</span> -<span class="w">target_size</span> <span class="cm">=&gt;</span> <span class="q">'384'</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="i">$tracked_well</span> =~ <span class="q">s/([a-zA-Z]\d{2})[abcd]/$1/</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span> <span class="i">$tracked_well</span> = <span class="i">$well</span> <span class="s">}</span>

                <span class="c">## Now figure out the original well</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$child_plate_size</span> =~ <span class="q">/96/</span> &amp;&amp; <span class="i">$original_plate_size</span> =~ <span class="q">/384/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">if</span> <span class="s">(</span><span class="i">$child_parent_quadrant</span><span class="s">)</span> <span class="s">{</span>
                        <span class="s">(</span><span class="i">$original_well</span><span class="s">)</span> = <span class="i">alDente::Well::Convert_Wells</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">wells</span> <span class="cm">=&gt;</span> <span class="q">&quot;$tracked_well$child_parent_quadrant&quot;</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="s">}</span>
                    <span class="k">else</span> <span class="s">{</span>
                        <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;ERROR: Parent quadrant NOT found for plate $plate_id&quot;</span><span class="s">)</span><span class="sc">;</span>
                        <span class="i">$sample_ids</span>[<span class="i">$i</span>]                                         = <span class="i">$sample_id</span><span class="sc">;</span>
                        <span class="i">$hash</span>{<span class="i">$plate_id</span>}{<span class="q">&quot;$tracked_well$child_parent_quadrant&quot;</span>} = <span class="i">$sample_id</span><span class="sc">;</span>
                        <span class="i">$hash</span>{<span class="i">$plate_id</span>}{<span class="i">$well</span>}                                 = <span class="i">$sample_id</span><span class="sc">;</span>
                        <span class="i">$i</span>++<span class="sc">;</span>
                        <span class="k">next</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="i">$original_well</span> = <span class="i">$tracked_well</span><span class="sc">;</span>
                <span class="s">}</span>

                <span class="k">if</span> <span class="s">(</span> <span class="i">$original_plate_id</span> &amp;&amp; <span class="i">$original_well</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="s">(</span><span class="i">$sample_id</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Sample'</span><span class="cm">,</span> <span class="q">'FK_Sample__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE FKOriginal_Plate__ID=$original_plate_id AND Well='$original_well'&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="i">$sample_ids</span>[<span class="i">$i</span>] = <span class="i">$sample_id</span><span class="sc">;</span>

                <span class="c">#		$hash{$plate_id}{$well} = $sample_id;</span>
                <span class="i">$hash</span>{<span class="i">$plate_id</span>}{<span class="q">&quot;$tracked_well$child_parent_quadrant&quot;</span>} = <span class="i">$sample_id</span><span class="sc">;</span>

                <span class="i">$i</span>++<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$run_id</span> &amp;&amp; <span class="i">$sequenced_well</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">### if run, well supplied ###</span>
        <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Run and Sequenced_well input not yet set up...- ask LIMS admin to get on it..&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$application</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$library</span><span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;You need to specify a library to extract by application&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">my</span> <span class="i">$extra_condition</span> = <span class="q">&quot; AND FK_Library__Name='$library'&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$plate_number</span><span class="s">)</span> <span class="s">{</span> <span class="i">$extra_condition</span> .= <span class="q">&quot; AND Library_Plate_Number in ($plate_number)&quot;</span> <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$application</span> =~ <span class="q">/rearray/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">@sample_ids</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample,Clone_Sample,ReArray'</span><span class="cm">,</span> <span class="q">&quot;Sample_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Clone_Sample.FK_Sample__ID = Sample_ID AND ReArray.FK_Sample__ID=Sample_ID AND FK_Library__Name='$library'&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">@sample_ids</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample,Clone_Sample'</span><span class="cm">,</span> <span class="q">&quot;Sample_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Clone_Sample.FK_Sample__ID = Sample_ID AND FK_Library__Name='$library'&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/hash/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%hash</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">@sample_ids</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">##############################################</span>
<span class="c">##############################################</span>
<span class="c">###### Plate specific data accessors #########</span>
<span class="c">##############################################</span>
<span class="c">##############################################</span>

<span class="c">#############################################</span>
<span class="c"># Get simple plate count for library / study / project ...</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Examples:</span>
<span class="c">#   my $count = $API-&gt;get_plate_count();</span>
<span class="c">#</span>
<span class="c">#   my $count = $API-&gt;get_plate_count(-library=&gt;'MGC01',-condition=&gt;');</span>
<span class="c">#</span>
<span class="c">#   my $data = $API-&gt;get_plate_count(-key=&gt;'plate_format');   ## get count for each format type...</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Count number of plates in library/project/</span>
<span class="c">#</span>
<span class="c"># (see _generate_query method for more details on input parameter options)</span>
<span class="c">#</span>
<span class="c"># Return: Integer = number of plates found OR hash if grouping requested. (%returnval-&gt;{fields}[1..$records])</span>
<span class="c">#######################</span>
<a name="get_plate_count-"></a><span class="k">sub </span><span class="m">get_plate_count</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Include below any arguments that should appear in perldoc + any arguments needing specific attention</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$study_id</span>         = <span class="i">$args</span>{-<span class="w">study_id</span>}<span class="sc">;</span>            <span class="c">### a study id (a defined set of libraries/projects)</span>
    <span class="k">my</span> <span class="i">$project_id</span>       = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>          <span class="c">### specify project_id</span>
    <span class="k">my</span> <span class="i">$library</span>          = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>             <span class="c">### specify library</span>
    <span class="c">## plate specification options</span>
    <span class="k">my</span> <span class="i">$plate_id</span>          = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                   <span class="c">### specify plate_id</span>
    <span class="k">my</span> <span class="i">$plate_number</span>      = <span class="i">$args</span>{-<span class="w">plate_number</span>}<span class="sc">;</span>               <span class="c">### specify plate number</span>
    <span class="k">my</span> <span class="i">$plate_type</span>        = <span class="i">$args</span>{-<span class="w">plate_type</span>} || <span class="q">''</span><span class="sc">;</span>           <span class="c">### specify type of plate (tube or Library_Plate)</span>
    <span class="k">my</span> <span class="i">$plate_class</span>       = <span class="i">$args</span>{-<span class="w">plate_class</span>} || <span class="q">''</span><span class="sc">;</span>          <span class="c">### specify class of plate (clone or extraction)</span>
    <span class="k">my</span> <span class="i">$plate_application</span> = <span class="i">$args</span>{-<span class="w">plate_application</span>} || <span class="q">''</span><span class="sc">;</span>    <span class="c">### specify application of plate (Sequencing/Mapping/PCR)</span>
    <span class="k">my</span> <span class="i">$original_plate_id</span> = <span class="i">$args</span>{-<span class="w">original_plate_id</span>}<span class="sc">;</span>          <span class="c">### specify original plate id</span>
    <span class="k">my</span> <span class="i">$applied_plate_id</span>  = <span class="i">$args</span>{-<span class="w">applied_plate_id</span>}<span class="sc">;</span>           <span class="c">### specify original plate id (including ReArrays)</span>
    <span class="k">my</span> <span class="i">$quadrant</span>          = <span class="i">$args</span>{-<span class="w">quadrant</span>}<span class="sc">;</span>                   <span class="c">### specify quadrant from original plate</span>
    <span class="k">my</span> <span class="i">$sample_id</span>         = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>                  <span class="c">### specify sample_id</span>
    <span class="k">my</span> <span class="i">$library_type</span>      = <span class="i">$args</span>{-<span class="w">library_type</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                                  <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                                <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>}<span class="sc">;</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>

            <span class="c">### Re-Cast arguments as required ###</span>
            <span class="k">my</span> <span class="i">$libs</span><span class="sc">;</span>
            <span class="i">$libs</span> = <span class="i">$self</span><span class="i">-&gt;get_libraries</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$study_id</span> || <span class="i">$project_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$libs</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span><span class="sc">;</span>
    <span class="i">$plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_numbers</span><span class="sc">;</span>
    <span class="i">$plate_numbers</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_number</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$plate_number</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$samples</span><span class="sc">;</span>
    <span class="i">$samples</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$sample_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_types</span><span class="sc">;</span>
    <span class="i">$library_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$library_type</span><span class="sc">;</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library_Name IN ($libraries)&quot;</span> <span class="s">)</span>                <span class="k">if</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_ID IN ($plates)&quot;</span> <span class="s">)</span>                       <span class="k">if</span> <span class="i">$plates</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Number IN ($plate_numbers)&quot;</span> <span class="s">)</span>            <span class="k">if</span> <span class="i">$plate_numbers</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Sample.FK_Sample__ID IN ($samples)&quot;</span> <span class="s">)</span>    <span class="k">if</span> <span class="i">$samples</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library_Type IN ($library_types)&quot;</span> <span class="s">)</span>            <span class="k">if</span> <span class="i">$library_types</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Plate_Type = '$plate_type'&quot;</span> <span class="s">)</span>                  <span class="k">if</span> <span class="i">$plate_type</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library_Plate.Plate_Class = '$plate_class'&quot;</span> <span class="s">)</span>  <span class="k">if</span> <span class="i">$plate_class</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library_Plate.Parent_Quadrant = '$quadrant'&quot;</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$quadrant</span><span class="sc">;</span>

    <span class="c">## Initial Framework for query ##</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="q">'Plate,Library'</span><span class="sc">;</span>                                <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">'WHERE Plate.FK_Library__Name=Library_Name'</span><span class="sc">;</span>    <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>                                             <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">##### DYNAMICALLY JOINED Tables: #####</span>
    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="q">'Library_Plate'</span> <span class="cm">=&gt;</span> <span class="q">&quot;Library_Plate.FK_Plate__ID=Plate_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Tube'</span>          <span class="cm">=&gt;</span> <span class="q">&quot;Tube.FK_Plate__ID=Plate_ID&quot;</span><span class="cm">,</span>
        <span class="q">'Plate_Format'</span>  <span class="cm">=&gt;</span> <span class="q">'Plate.FK_Plate_Format__ID=Plate_Format_ID'</span><span class="cm">,</span>
        <span class="q">'Plate_Sample'</span>  <span class="cm">=&gt;</span> <span class="q">'Plate.FKOriginal_Plate__ID = Plate_Sample.FKOriginal_Plate__ID'</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>                                                                     <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>

    <span class="s">}</span><span class="sc">;</span>                                                                     <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## adapt conditions using appropriate aliases as required ##</span>
    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>

    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span><span class="q">'Count(Distinct Plate_ID) as plates'</span><span class="s">)</span><span class="sc">;</span>               <span class="c">## &lt;- Default list of fields to retrieve</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">################################33</span>
<span class="c"># Return lineage information (or just plate id / format if a generation is specified).</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#  Example 1 :   (to retrieve 2nd generation plate(s) given final plate_id).</span>
<span class="c">#</span>
<span class="c">#     my ($plate_id,$format) = @{$API-&gt;get_plate_lineage(-plate_id=&gt;$plate,-generation=&gt;2)};</span>
<span class="c">#</span>
<span class="c">#  Example 2 :   (to retrieve plate 1 generation behind - (relative generation = '-1')).</span>
<span class="c">#</span>
<span class="c">#     my ($plate_id,$format) = @{$API-&gt;get_plate_lineage(-plate_id=&gt;$plate,-generation=&gt;'-1')};</span>
<span class="c">#</span>
<span class="c">#  Example 3 :   (to retrieve all plates in lineage of specified plate).</span>
<span class="c">#</span>
<span class="c">#     my ($plate_id,$format) = @{$API-&gt;get_plate_lineage(-plate_id=&gt;$plate)};</span>
<span class="c">#</span>
<span class="c"># Return : hash of info (if generation NOT specified) or array reference with plate_id(s), format(s) for specified generation.</span>
<span class="c">############################</span>
<a name="get_plate_lineage-"></a><span class="k">sub </span><span class="m">get_plate_lineage</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'plate_id,generation'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$plate_id</span>   = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$generation</span> = <span class="i">$args</span>{-<span class="w">generation</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$well</span>       = <span class="i">$args</span>{-<span class="w">well</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$no_rearray</span> = <span class="i">$args</span>{-<span class="w">no_rearray</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%output_data</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%lineage</span> = <span class="i">&amp;alDente::Container::get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'hash'</span><span class="cm">,</span> -<span class="w">well</span> <span class="cm">=&gt;</span> <span class="i">$well</span><span class="cm">,</span> -<span class="w">no_rearray</span> <span class="cm">=&gt;</span> <span class="i">$no_rearray</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%child_lineage</span> = <span class="i">&amp;alDente::Container::get_Children</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'hash'</span><span class="cm">,</span> -<span class="w">include_self</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$generation</span><span class="s">)</span> <span class="s">{</span>    <span class="c">## retrieve a particular generation (where 1st generation is original) ##</span>
        <span class="k">my</span> <span class="i">$generations_above</span> = <span class="i">$lineage</span>{<span class="w">parent_generations</span>} + <span class="n">1</span><span class="sc">;</span>    <span class="c">## include current plate as last generation</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$generation</span> =~ <span class="q">/^\-[1-9]/</span> <span class="s">)</span> <span class="s">{</span>                           <span class="c">## relative generation supplied ('-' =&gt; parents)</span>
            <span class="k">my</span> <span class="i">$id</span>      = <span class="i">$lineage</span>{<span class="w">generation</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$formats</span> = <span class="i">$lineage</span>{<span class="w">formats</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$created</span> = <span class="i">$lineage</span>{<span class="w">created</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="i">%output_data</span> = <span class="s">(</span> <span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> <span class="w">format</span> <span class="cm">=&gt;</span> <span class="i">$formats</span><span class="cm">,</span> <span class="w">created</span> <span class="cm">=&gt;</span> <span class="i">$created</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$generation</span> =~ <span class="q">/^\+[1-9]/</span> <span class="s">)</span> <span class="s">{</span>                        <span class="c">## relative generation supplied ('+' =&gt; children)</span>
            <span class="k">my</span> <span class="i">$id</span>      = <span class="i">$child_lineage</span>{<span class="w">generation</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$formats</span> = <span class="i">$child_lineage</span>{<span class="w">formats</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$created</span> = <span class="i">$child_lineage</span>{<span class="w">created</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="i">%output_data</span> = <span class="s">(</span> <span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> <span class="w">format</span> <span class="cm">=&gt;</span> <span class="i">$formats</span><span class="cm">,</span> <span class="w">created</span> <span class="cm">=&gt;</span> <span class="i">$created</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$generation</span> =~ <span class="q">/^[\+\-]0/</span> <span class="s">)</span> <span class="s">{</span>                        <span class="c">## relative generation supplied (pointing to self)</span>
            <span class="k">my</span> <span class="i">$id</span>      = <span class="i">$child_lineage</span>{<span class="w">generation</span>}{<span class="n">0</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$formats</span> = <span class="i">$child_lineage</span>{<span class="w">formats</span>}{<span class="n">0</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$created</span> = <span class="i">$child_lineage</span>{<span class="w">created</span>}{<span class="n">0</span>}<span class="sc">;</span>
            <span class="i">%output_data</span> = <span class="s">(</span> <span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> <span class="w">format</span> <span class="cm">=&gt;</span> <span class="i">$formats</span><span class="cm">,</span> <span class="w">created</span> <span class="cm">=&gt;</span> <span class="i">$created</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>                                                       <span class="c">## assume generation is a single integer ##</span>
            <span class="i">$generation</span> += <span class="n">0</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$generation</span> &gt; <span class="i">$generations_above</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$generations_below</span> = <span class="i">$generation</span> - <span class="i">$generations_above</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$child_generations</span> = <span class="i">$child_lineage</span>{<span class="w">child_generations</span>}<span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$generations_below</span> &gt; <span class="i">$child_generations</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$self</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Sorry only $generations_above + $generations_below generations&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="i">$id</span>      = <span class="i">$child_lineage</span>{<span class="w">generation</span>}{<span class="q">&quot;+$generations_below&quot;</span>}<span class="sc">;</span>
                    <span class="k">my</span> <span class="i">$formats</span> = <span class="i">$child_lineage</span>{<span class="w">formats</span>}{<span class="q">&quot;+$generations_below&quot;</span>}<span class="sc">;</span>
                    <span class="k">my</span> <span class="i">$created</span> = <span class="i">$child_lineage</span>{<span class="w">created</span>}{<span class="q">&quot;+$generations_below&quot;</span>}<span class="sc">;</span>
                    <span class="i">%output_data</span> = <span class="s">(</span> <span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> <span class="w">format</span> <span class="cm">=&gt;</span> <span class="i">$formats</span><span class="cm">,</span> <span class="w">created</span> <span class="cm">=&gt;</span> <span class="i">$created</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$generation</span> =~ <span class="q">/^$generations_above$/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$format_id</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID in ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$format</span> = <span class="i">get_FK_info</span><span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> <span class="i">$format_id</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">my</span> <span class="s">(</span><span class="i">$created</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Min(Plate_Created)'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID in ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">%output_data</span> = <span class="s">(</span> <span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> <span class="w">format</span> <span class="cm">=&gt;</span> <span class="i">$format</span><span class="cm">,</span> <span class="w">created</span> <span class="cm">=&gt;</span> <span class="i">$created</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$gen</span>     = <span class="i">$generation</span> - <span class="i">$generations_above</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$id</span>      = <span class="i">$lineage</span>{<span class="w">generation</span>}{<span class="i">$gen</span>}<span class="sc">;</span>
                <span class="k">my</span> <span class="i">$format</span>  = <span class="i">$lineage</span>{<span class="w">formats</span>}{<span class="i">$gen</span>}<span class="sc">;</span>
                <span class="k">my</span> <span class="i">$created</span> = <span class="i">$lineage</span>{<span class="w">created</span>}{<span class="i">$gen</span>}<span class="sc">;</span>
                <span class="i">%output_data</span> = <span class="s">(</span> <span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> <span class="w">format</span> <span class="cm">=&gt;</span> <span class="i">$format</span><span class="cm">,</span> <span class="w">created</span> <span class="cm">=&gt;</span> <span class="i">$created</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>    <span class="c">## No generation specification supplied ##</span>
        <span class="k">my</span> <span class="i">%Ancestry</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$format_id</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID in ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$format</span> = <span class="i">get_FK_info</span><span class="s">(</span> <span class="i">$self</span><span class="cm">,</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> <span class="i">$format_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$created</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Min(Plate_Created)'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID in ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">generation</span>}-&gt;{<span class="n">0</span>} = <span class="i">$plate_id</span><span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">format</span>}-&gt;{<span class="n">0</span>}     = <span class="i">$format</span><span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">created</span>}-&gt;{<span class="n">0</span>}    = <span class="i">$created</span><span class="sc">;</span>

        <span class="i">$Ancestry</span>{<span class="w">parent_list</span>}        = <span class="i">$lineage</span>{<span class="w">list</span>}<span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">child_list</span>}         = <span class="i">$child_lineage</span>{<span class="w">list</span>}<span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">parent_generations</span>} = <span class="i">$lineage</span>{<span class="w">parent_generations</span>}<span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">child_generations</span>}  = <span class="i">$child_lineage</span>{<span class="w">child_generations</span>}<span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$lineage</span>{<span class="w">generation</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="i">$Ancestry</span>{<span class="w">generation</span>}{<span class="i">$key</span>} = <span class="i">$lineage</span>{<span class="w">generation</span>}{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">format</span>}{<span class="i">$key</span>}     = <span class="i">$lineage</span>{<span class="w">formats</span>}{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">created</span>}{<span class="i">$key</span>}    = <span class="i">$lineage</span>{<span class="w">created</span>}{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$child_lineage</span>{<span class="w">generation</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="i">$Ancestry</span>{<span class="w">generation</span>}{<span class="i">$key</span>} = <span class="i">$child_lineage</span>{<span class="w">generation</span>}{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">format</span>}{<span class="i">$key</span>}     = <span class="i">$child_lineage</span>{<span class="w">formats</span>}{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">created</span>}{<span class="i">$key</span>}    = <span class="i">$child_lineage</span>{<span class="w">created</span>}{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># for sample name, original well, and original plate</span>
        <span class="i">$Ancestry</span>{<span class="w">sample_id</span>} = <span class="i">$lineage</span>{<span class="w">sample_id</span>}<span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$Ancestry</span>{<span class="w">sample_id</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$sample_name</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Sample&quot;</span><span class="cm">,</span> <span class="q">&quot;Sample_Name&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_ID=$Ancestry{sample_id}&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">sample_name</span>}    = <span class="i">$sample_name</span><span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">original_plate</span>} = <span class="i">$lineage</span>{<span class="w">original</span>}<span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">original_well</span>}  = <span class="i">$lineage</span>{<span class="w">well</span>}<span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">%output_data</span> = <span class="i">%Ancestry</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%output_data</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">#######################################################################</span>
<span class="c"># specifically to retrieve information on where samples may be located.</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:</span>
<span class="c">#</span>
<span class="c"># my $plate_data = $API-&gt;get_Plate_list(-sample_id=&gt;\@sample_ids);</span>
<span class="c">#</span>
<span class="c"># OR  specify a list of samples by indicating an alias_type and an alias (or array of aliases)</span>
<span class="c">#</span>
<span class="c"># my $plate_data = $API-&gt;get_Plate_list(-alias_type=&gt;'AVF',-alias=&gt;['sample1','sample2','sample3');</span>
<span class="c">#</span>
<span class="c">#  ## the following is also possible though slow since it must track each sample individually through generations ##</span>
<span class="c"># my $plate_data = $API-&gt;get_Plate_list(-library=&gt;'CC001',-plate_number=&gt;1);</span>
<span class="c">#</span>
<span class="c"># Differences between LIMS 2.5 and LIMS 2.6:</span>
<span class="c"># The hash key 'actual_size' has been replaced with hash keys 'well_capacity_ml', 'capacity_units' and 'plate_format_wells'</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Return: hash of plate_id,format,size,well for each plate on which this sample resides.</span>
<span class="c">#################</span>
<a name="get_Plate_list-"></a><span class="k">sub </span><span class="m">get_Plate_list</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'sample_id,format'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'sample_id|alias_name|alias_type|library|project_id|study|since|date_field'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$sample_ids</span> = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>    <span class="c">## list of sample_ids</span>
    <span class="k">my</span> <span class="i">$alias_name</span> = <span class="i">$args</span>{-<span class="w">alias_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$alias_type</span> = <span class="i">$args</span>{-<span class="w">alias_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format_spec</span><span class="sc">;</span>
    <span class="i">$format_spec</span> = <span class="i">$args</span>{<span class="q">'-format'</span>} || <span class="i">$args</span>{-<span class="w">plate_format</span>}<span class="sc">;</span>    <span class="c">## indicate format type (checks if this string is IN format description)</span>
    <span class="k">my</span> <span class="i">$library</span>      = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$project_id</span>   = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_number</span> = <span class="i">$args</span>{-<span class="w">plate_number</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$study</span>        = <span class="i">$args</span>{ -<span class="k">study</span> }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>        = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                           <span class="c">## suppress unnecessary feedback</span>
    <span class="k">my</span> <span class="i">$since</span>        = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                           <span class="c">## only retrieve plates generated SINCE this date</span>
    <span class="k">my</span> <span class="i">$until</span>        = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                         <span class="c">## only retrieve plates generated UNTIL this date</span>
            <span class="k">my</span> <span class="i">$date_field</span>      = <span class="i">$args</span>{-<span class="w">date_field</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$clone_condition</span> = <span class="i">$args</span>{-<span class="w">clone_condition</span>}<span class="sc">;</span>           <span class="c">## condition that applies to specific clones</span>
            <span class="k">my</span> <span class="i">$plate_condition</span> = <span class="i">$args</span>{-<span class="w">plate_condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">## conditions that apply to plates extracted..</span>
            <span class="k">my</span> <span class="i">$originals_only</span>  = <span class="i">$args</span>{-<span class="w">originals_only</span>} || <span class="q">'0'</span><span class="sc">;</span>     <span class="c">## only retrieve info for the original plates..</span>
            <span class="k">my</span> <span class="i">$debug</span>           = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

            <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Library'</span><span class="cm">,</span> <span class="q">'Project'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$Aliases</span>{<span class="i">$table</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_condition</span> =~ <span class="q">/\b$key\b/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$replace</span> = <span class="i">$Aliases</span>{<span class="i">$table</span>}{<span class="i">$key</span>}<span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$replace</span> =~ <span class="q">/(.*) AS (.*)/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="i">$replace</span> = <span class="i">$1</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="i">$plate_condition</span> =~ <span class="q">s/\b$key\b/$replace/g</span><span class="sc">;</span>
            <span class="s">}</span>                                                        <span class="c">## include Alias</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$datespec</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$since</span> || <span class="i">$until</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$datespec</span> = <span class="i">$self</span><span class="i">-&gt;parse_date_condition</span><span class="s">(</span> -<span class="w">date_field</span> <span class="cm">=&gt;</span> <span class="q">&quot;$date_field&quot;</span><span class="cm">,</span> -<span class="w">since</span> <span class="cm">=&gt;</span> <span class="i">$since</span><span class="cm">,</span> -<span class="w">until</span> <span class="cm">=&gt;</span> <span class="i">$until</span><span class="cm">,</span> -<span class="w">on_fail</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$datespec</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$datespec</span> = <span class="q">&quot; AND $datespec&quot;</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">unless</span> <span class="s">(</span> <span class="i">$args</span>{-<span class="w">fields</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$args</span>{-<span class="w">fields</span>} = <span class="s">[</span> <span class="q">'plate_created'</span><span class="cm">,</span> <span class="q">'sample_id'</span><span class="cm">,</span> <span class="q">'applied_plate_id'</span><span class="cm">,</span> <span class="q">'applied_well'</span><span class="cm">,</span> <span class="q">'original_plate_id'</span><span class="cm">,</span> <span class="q">'original_well'</span><span class="cm">,</span> <span class="q">'original_quadrant'</span><span class="cm">,</span> <span class="q">'sample_name'</span> <span class="s">]</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">## First retrieve details of sample ##</span>
    <span class="k">my</span> <span class="i">$originals</span> = <span class="i">$self</span><span class="i">-&gt;get_sample_data</span><span class="s">(</span>
        -<span class="w">sample_id</span>    <span class="cm">=&gt;</span> <span class="i">$sample_ids</span><span class="cm">,</span>
        -<span class="w">alias_type</span>   <span class="cm">=&gt;</span> <span class="i">$alias_type</span><span class="cm">,</span>
        -<span class="w">alias_name</span>   <span class="cm">=&gt;</span> <span class="i">$alias_name</span><span class="cm">,</span>
        -<span class="w">library</span>      <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span>
        -<span class="w">project</span>      <span class="cm">=&gt;</span> <span class="i">$project_id</span><span class="cm">,</span>
        -<span class="w">study</span>        <span class="cm">=&gt;</span> <span class="i">$study</span><span class="cm">,</span>
        -<span class="w">plate_number</span> <span class="cm">=&gt;</span> <span class="i">$plate_number</span><span class="cm">,</span>
        -<span class="w">fields</span>       <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">fields</span>}<span class="cm">,</span>
        -<span class="w">quiet</span>        <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
        -<span class="w">condition</span>    <span class="cm">=&gt;</span> <span class="i">$clone_condition</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c">## only return information on originals if requested (faster) ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$originals_only</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$originals</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@original_ids</span><span class="sc">;</span>
    <span class="i">@original_ids</span> = <span class="i">@</span>{ <span class="i">$originals</span>-&gt;{<span class="w">original_plate_id</span>} } <span class="k">if</span> <span class="i">$originals</span>-&gt;{<span class="w">original_plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$number</span> = <span class="k">int</span><span class="s">(</span><span class="i">@original_ids</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;Following lineage for each plate back to $number defined clones...\n&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{-<span class="w">debug</span>} &amp;&amp; !<span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="i">$quiet</span> || <span class="s">(</span> <span class="i">$number</span> &lt; <span class="n">1000</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;(This may be very slow when looking at a large number of samples since we need to follow the ancestry back through all generations of plates for each sample individually - progress towards completion is indicated dynamically below)\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@original_wells</span>     = <span class="i">@</span>{ <span class="i">$originals</span>-&gt;{<span class="w">original_well</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@applied_ids</span>        = <span class="i">@</span>{ <span class="i">$originals</span>-&gt;{<span class="w">applied_plate_id</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@applied_wells</span>      = <span class="i">@</span>{ <span class="i">$originals</span>-&gt;{<span class="w">applied_well</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@original_quadrants</span> = <span class="i">@</span>{ <span class="i">$originals</span>-&gt;{<span class="w">original_quadrant</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@sample_ids</span>         = <span class="i">@</span>{ <span class="i">$originals</span>-&gt;{<span class="w">sample_id</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@sample_names</span>       = <span class="i">@</span>{ <span class="i">$originals</span>-&gt;{<span class="w">sample_name</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@creation_dates</span>     = <span class="i">@</span>{ <span class="i">$originals</span>-&gt;{<span class="w">plate_created</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@alias_names</span><span class="sc">;</span>
    <span class="i">@alias_names</span> = <span class="i">@</span>{ <span class="i">$originals</span>-&gt;{<span class="w">alias_name</span>} } <span class="k">if</span> <span class="s">(</span><span class="i">$alias_type</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Found</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$index</span> <span class="s">(</span> <span class="n">0</span> .. <span class="i">$#applied_ids</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$applied_plate_id</span>  = <span class="i">$applied_ids</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$applied_well</span>      = <span class="i">$applied_wells</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$original_id</span>       = <span class="i">$original_ids</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$original_well</span>     = <span class="i">$original_wells</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$original_quadrant</span> = <span class="i">$original_quadrants</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$sample_id</span>         = <span class="i">$sample_ids</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$sample_name</span>       = <span class="i">$sample_names</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$created</span>           = <span class="i">$creation_dates</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$alias_name</span>        = <span class="i">$alias_names</span>[<span class="i">$index</span>]<span class="sc">;</span>

        <span class="c">#print progress_tracker($index,$number) if ($args{-debug} &amp;&amp; !$quiet);</span>

        <span class="k">my</span> <span class="i">$lineage</span> = <span class="i">$self</span><span class="i">-&gt;get_plate_lineage</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$applied_plate_id</span><span class="cm">,</span> -<span class="w">well</span> <span class="cm">=&gt;</span> <span class="i">$applied_well</span><span class="cm">,</span> -<span class="w">no_rearray</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## Don't follow through rearrays</span>

        <span class="k">my</span> <span class="i">$children</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$lineage</span>-&gt;{<span class="w">child_list</span>} }<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$parents</span> .= <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$lineage</span>-&gt;{<span class="w">parent_list</span>} }<span class="sc">;</span>

        <span class="k">my</span> <span class="i">$all_ids</span> = <span class="i">$children</span><span class="sc">;</span>
        <span class="i">$all_ids</span> .= <span class="q">&quot;,$parents&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$parents</span><span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">@details</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span>
            <span class="q">'Plate,Library_Plate,Plate_Format,Rack'</span><span class="cm">,</span>
            <span class="q">'FKOriginal_Plate__ID,Plate_ID,Plate_Size,Library_Plate.Plate_Position,Parent_Quadrant,Well_Capacity_mL,Plate_Format_Type,Rack_Alias,Library_Plate.Plate_Class,FK_Rack__ID,Capacity_Units,Wells'</span><span class="cm">,</span>
            <span class="q">&quot;WHERE FK_Plate_Format__ID=Plate_Format_ID AND FK_Plate__ID=Plate_ID AND FK_Rack__ID=Rack_ID  AND Plate_ID in ($all_ids) $datespec AND $plate_condition&quot;</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$detail</span> <span class="s">(</span><span class="i">@details</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">unless</span> <span class="s">(</span><span class="i">$detail</span><span class="s">)</span> <span class="s">{</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$original_id</span><span class="cm">,</span> <span class="i">$plate_id</span><span class="cm">,</span> <span class="i">$plate_size</span><span class="cm">,</span> <span class="i">$position</span><span class="cm">,</span> <span class="i">$quadrant</span><span class="cm">,</span> <span class="i">$format_size</span><span class="cm">,</span> <span class="i">$format</span><span class="cm">,</span> <span class="i">$location</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$rack</span><span class="cm">,</span> <span class="i">$capacity_units</span><span class="cm">,</span> <span class="i">$plate_fromat_wells</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$detail</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$format_spec</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/$format_spec/</span> <span class="s">)</span> <span class="s">{</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>
            <span class="s">}</span>    <span class="c">## skip if this does NOT match specified format</span>
                 <span class="c">#print &quot;$format =&gt; $format_spec ($plate_id)\n&quot;;</span>
            <span class="k">my</span> <span class="i">$tracked_well</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$original_size</span> = <span class="i">$plate_size</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$quadrant</span><span class="s">)</span> <span class="s">{</span>    <span class="c">## if this sample was split from 384 well format</span>
                <span class="s">(</span><span class="i">$tracked_well</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Well_Lookup'</span><span class="cm">,</span> <span class="q">'Plate_96'</span><span class="cm">,</span> <span class="q">&quot;WHERE Left(Plate_384,1) = Left('$applied_well',1) AND Substring(Plate_384,2)+0 = Substring('$applied_well',2)+0 AND Quadrant = '$quadrant'&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$original_size</span> = <span class="q">'384-well'</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$tracked_well</span> = <span class="i">$applied_well</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">my</span> <span class="i">$actual_well</span> = <span class="i">$tracked_well</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$format_size</span> &gt; <span class="i">$plate_size</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## if actual plasticware is a different size, figure out actual well</span>
                <span class="s">(</span><span class="i">$actual_well</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Well_Lookup'</span><span class="cm">,</span> <span class="q">'Plate_384'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_96 = '$tracked_well' AND Quadrant = '$position'&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">(</span><span class="i">$actual_well</span><span class="s">)</span> = <span class="i">&amp;alDente::Well::Format_Wells</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">wells</span> <span class="cm">=&gt;</span> <span class="i">$actual_well</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$actual_well</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$found</span><span class="sc">;</span>
                <span class="k">if</span>   <span class="s">(</span> <span class="i">$Found</span>{<span class="i">$sample_id</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$found</span> = <span class="k">int</span><span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$Found</span>{<span class="i">$sample_id</span>} } <span class="s">)</span> + <span class="n">1</span><span class="sc">;</span> <span class="s">}</span>
                <span class="k">else</span>                        <span class="s">{</span> <span class="i">$found</span> = <span class="n">1</span><span class="sc">;</span> <span class="s">}</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">applied_well</span>}       = <span class="i">$applied_well</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">applied_plate_id</span>}   = <span class="i">$applied_plate_id</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">original_well</span>}      = <span class="i">$original_well</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">tracked_well</span>}       = <span class="i">$tracked_well</span><span class="sc">;</span>         <span class="c">## (eg. if 96-well plate is tracked on 384-well plasticware</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">actual_well</span>}        = <span class="i">$actual_well</span><span class="sc">;</span>          <span class="c">## the well (assuming user knows nothing about 'tracking' status</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">original_plate_id</span>}  = <span class="i">$original_id</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">plate_id</span>}           = <span class="i">$plate_id</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">plate_position</span>}     = <span class="i">$position</span><span class="sc">;</span>             <span class="c">## position of tracked 96-well plate on 384 (if applicable)</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">original_quadrant</span>}  = <span class="i">$quadrant</span><span class="sc">;</span>             <span class="c">## position of sample in original 384-well plate (if applicable)</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">tracked_size</span>}       = <span class="i">$plate_size</span><span class="sc">;</span>           <span class="c">## size of plate that is tracked</span>
                                                                                        <span class="c">#$Found{$sample_id}{$found}{actual_size}       = $format_size;        ## size of plasticware on which plate exists</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">well_capacity_ml</span>}   = <span class="i">$format_size</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">capacity_units</span>}     = <span class="i">$capacity_units</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">plate_format_wells</span>} = <span class="i">$plate_fromat_wells</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">original_size</span>}      = <span class="i">$original_size</span><span class="sc">;</span>        <span class="c">## size of plasticware on which plate exists</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">format</span>}             = <span class="i">$format</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">created</span>}            = <span class="i">$created</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">location</span>}           = <span class="i">$location</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">class</span>}              = <span class="i">$class</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">rack_id</span>}            = <span class="i">$rack</span><span class="sc">;</span>
                <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">sample_name</span>}        = <span class="i">$sample_name</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$alias_type</span><span class="s">)</span> <span class="s">{</span> <span class="i">$Found</span>{<span class="i">$sample_id</span>}{<span class="i">$found</span>}{<span class="w">alias_name</span>} = <span class="i">$alias_name</span><span class="sc">;</span> <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%Found</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Get prep history for a given plate</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:</span>
<span class="c">#     my $data = get_Plate_history(-plate_id=&gt;12345,-history=&gt;1);</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">###################</span>
<a name="get_Plate_history-"></a><span class="k">sub </span><span class="m">get_Plate_history</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$step</span>     = <span class="i">$args</span>{-<span class="w">step</span>}<span class="sc">;</span>                                <span class="c">## allow searching for specific step(s)[ wildcard OR list valid]</span>
    <span class="k">my</span> <span class="i">$history</span>  = <span class="i">$args</span>{-<span class="w">history</span>}<span class="sc">;</span>                             <span class="c">## follow plate history to include parent plates</span>
    <span class="k">my</span> <span class="i">$debug</span>    = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%History</span> = <span class="w">alDente::Container</span><span class="w">-&gt;get_Preps</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="i">$step</span><span class="cm">,</span> -<span class="w">history</span> <span class="cm">=&gt;</span> <span class="i">$history</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%History</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">################################################</span>
<span class="c">#</span>
<span class="c"># Retrieve list of libraries given project / study etc.</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:</span>
<span class="c">#   my @libraries = @{ $API-&gt;$self-&gt;get_libraries(-study=&gt;2) }</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Get a list of libraries by different criteria</span>
<span class="c">#</span>
<span class="c"># Return: A list of libraries in array ref</span>
<span class="c">######################</span>
<a name="get_libraries-"></a><span class="k">sub </span><span class="m">get_libraries</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'project_id'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'library|project_id|study_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$library</span>    = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$project_id</span> = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>                     <span class="c">### project id</span>
    <span class="k">my</span> <span class="i">$study_id</span>   = <span class="i">$args</span>{-<span class="w">study_id</span>} || <span class="i">$args</span>{ -<span class="k">study</span> }<span class="sc">;</span>    <span class="c">### study id</span>
    <span class="k">my</span> <span class="i">$study_name</span> = <span class="i">$args</span>{-<span class="w">study_name</span>}<span class="sc">;</span>                     <span class="c">### study name</span>
    <span class="k">my</span> <span class="i">$quiet</span>      = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>      = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$project_id</span> || <span class="i">$study_id</span> || <span class="i">$study_name</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%data</span> = <span class="i">%</span>{ <span class="i">$self</span><span class="i">-&gt;get_library_data</span><span class="s">(</span> -<span class="w">group</span> <span class="cm">=&gt;</span> <span class="q">''</span><span class="cm">,</span> -<span class="w">library</span> <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span> -<span class="w">study_id</span> <span class="cm">=&gt;</span> <span class="i">$study_id</span><span class="cm">,</span> -<span class="w">project_id</span> <span class="cm">=&gt;</span> <span class="i">$project_id</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="q">'library'</span><span class="s">]</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="i">$quiet</span> <span class="s">)</span> }<span class="sc">;</span>
        <span class="k">my</span> <span class="i">@libs</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$data</span>{<span class="w">library</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">@libs</span> = <span class="i">@</span>{ <span class="i">$data</span>{<span class="w">library</span>} }<span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Warning: No Libraries found matching conditions (Project $project_id; $library)&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">@libs</span> = <span class="s">(</span><span class="q">''</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## set to blank to avoid SQL Error ##</span>
        <span class="s">}</span>
        <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">@libs</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span><span class="k">return</span><span class="s">}</span>
<span class="s">}</span>

<span class="c">######################################</span>
<span class="c">#</span>
<span class="c"># Retrieves library changes (parameters are same as get_library_data() parameters</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#       $API-&gt;get_library_changes(-study=&gt;7,-quiet=&gt;1);</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="get_library_changes-"></a><span class="k">sub </span><span class="m">get_library_changes</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">### Get the list of library names</span>
    <span class="k">my</span> <span class="i">$library_data</span> = <span class="i">$self</span><span class="i">-&gt;get_library_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library_list</span> = <span class="i">$library_data</span>-&gt;{<span class="w">library</span>}<span class="sc">;</span>

    <span class="c">### Retrieve the changes for those librarys</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_changes</span><span class="s">(</span> -<span class="w">object</span> <span class="cm">=&gt;</span> <span class="q">'Library'</span><span class="cm">,</span> -<span class="w">record_ids</span> <span class="cm">=&gt;</span> <span class="i">$library_list</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">######################################</span>
<span class="c">#</span>
<span class="c"># Retrieves plate changes</span>
<span class="c">#</span>
<span class="c"># Inputs:  Input parameters are same as get_plate_data() parameters</span>
<span class="c"># Outputs: Returns a hash of arrays of changes</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#       $API-&gt;get_plate_changes(-plate_id=&gt;102034,-quiet=&gt;1);</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="get_plate_changes-"></a><span class="k">sub </span><span class="m">get_plate_changes</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">### Get the list of Plate IDs</span>
    <span class="k">my</span> <span class="i">$plate_data</span> = <span class="i">$self</span><span class="i">-&gt;get_plate_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_ids</span>  = <span class="i">$plate_data</span>-&gt;{<span class="w">plate_id</span>}<span class="sc">;</span>

    <span class="c">### Retrieve the changes for those Plates</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_changes</span><span class="s">(</span> -<span class="w">object</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">record_ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################################</span>
<span class="c">#</span>
<span class="c"># Retrieves sample changes</span>
<span class="c">#</span>
<span class="c"># Inputs:  Input parameters are same as get_sample_data() parameters</span>
<span class="c"># Outputs: Returns a hash of arrays of changes</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#       $API-&gt;get_sample_changes(-sample_id=&gt;102034,-quiet=&gt;1);</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="get_sample_changes-"></a><span class="k">sub </span><span class="m">get_sample_changes</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">### Get the list of Sample IDs</span>
    <span class="k">my</span> <span class="i">$sample_data</span> = <span class="i">$self</span><span class="i">-&gt;get_sample_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_ids</span>  = <span class="i">$sample_data</span>-&gt;{<span class="w">sample_id</span>}<span class="sc">;</span>

    <span class="c">### Retrieve the changes for those Samples</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_changes</span><span class="s">(</span> -<span class="w">object</span> <span class="cm">=&gt;</span> <span class="q">'Sample'</span><span class="cm">,</span> -<span class="w">record_ids</span> <span class="cm">=&gt;</span> <span class="i">$sample_ids</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################################</span>
<span class="c">#</span>
<span class="c"># Generic method to retrieve changes of an object in the database given its ID.</span>
<span class="c"># You can optionally pass in the specific fields required. By default it will retrieve all</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Inputs:  Object Name</span>
<span class="c">#          Object IDs</span>
<span class="c">#          [Specified Fields]</span>
<span class="c"># Outputs: Returns a hash of arrays of changes</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#       $API-&gt;get_changes(-object=&gt;'Plate', -fields=&gt;['plate_number'], -record_ids=&gt;102034);</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">##########################</span>
<a name="get_changes-"></a><span class="k">sub </span><span class="m">get_changes</span> <span class="s">{</span>
<span class="c">##########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'object,record_ids,fields'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'object,record_ids'</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$record_ids</span>       = <span class="i">$args</span>{-<span class="w">record_ids</span>}<span class="sc">;</span>    <span class="c">### Record IDs</span>
    <span class="k">my</span> <span class="i">$object</span>           = <span class="i">$args</span>{-<span class="w">object</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$requested_fields</span> = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>            = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="i">$record_ids</span> = <span class="k">join</span> <span class="q">&quot;','&quot;</span><span class="cm">,</span> <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$record_ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@requested_fields</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$requested_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@tables</span><span class="sc">;</span>                                   <span class="c">### Set of tables that could potentially be used</span>
    <span class="k">my</span> <span class="i">%fields</span><span class="sc">;</span>                                   <span class="c">### Mapping of fully identified filed names to their aliases</span>

    <span class="c">### Get all the fields listed in the aliases</span>
    <span class="k">foreach</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$Aliases</span>{<span class="i">$object</span>} } <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$this_field</span> = <span class="i">$Aliases</span>{<span class="i">$object</span>}{<span class="i">$_</span>}<span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$field</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">### Extract the table names and field names</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$this_field</span> =~ <span class="q">/(\w+)\.(\w+)/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$table</span> = <span class="i">$1</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$field</span> = <span class="i">$2</span><span class="sc">;</span>

            <span class="c">### If a set of specific fields have been requested, ignore the others</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$requested_fields</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">next</span> <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span><span class="s">(</span> <span class="q">/$field/i</span><span class="cm">,</span> <span class="i">@requested_fields</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$fields</span>{<span class="i">$this_field</span>} = <span class="i">$_</span><span class="sc">;</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@tables</span><span class="cm">,</span> <span class="i">$table</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="i">@tables</span> = <span class="i">@</span>{ <span class="i">&amp;unique_items</span><span class="s">(</span> \<span class="i">@tables</span> <span class="s">)</span> }<span class="sc">;</span>

    <span class="c">### If a set of specific fields have been requested, check to see if they all exist</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$requested_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span> <span class="k">keys</span> <span class="i">%fields</span> <span class="s">)</span> == <span class="k">scalar</span><span class="s">(</span><span class="i">@requested_fields</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Error: No such field(s) were found in the map.&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">Message</span><span class="s">(</span> <span class="q">&quot;Requested Fields: &quot;</span> . <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@requested_fields</span> <span class="s">)</span> <span class="k">unless</span> <span class="i">$self</span>-&gt;{<span class="w">quiet</span>}<span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">### Retrieve the DBField_ID(s) of the requried fields</span>
    <span class="k">my</span> <span class="i">$full_fields</span> = <span class="k">join</span> <span class="q">&quot;','&quot;</span><span class="cm">,</span> <span class="k">keys</span> <span class="i">%fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%DBFields</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'DBField,DBTable'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'DBField_ID'</span><span class="cm">,</span> <span class="q">&quot;CONCAT(DBTable_Name,'.',Field_Name) AS Name&quot;</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE DBTable_ID=FK_DBTable__ID and CONCAT(DBTable_Name,'.',Field_Name) IN ('$full_fields')&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$count</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="c">### Record the mapping of DBField_ID(s) to their fully identified field names</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">$DBFields</span>{<span class="w">DBField_ID</span>}-&gt;[<span class="i">$count</span>] <span class="s">)</span> <span class="s">{</span>
        <span class="i">$fields</span>{ <span class="i">$DBFields</span>{<span class="w">DBField_ID</span>}-&gt;[<span class="i">$count</span>] } = <span class="i">$DBFields</span>{<span class="w">Name</span>}-&gt;[<span class="i">$count</span>]<span class="sc">;</span>
        <span class="i">$count</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$dbfield_ids</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$DBFields</span>{<span class="w">DBField_ID</span>} }<span class="sc">;</span>

    <span class="c">### Finally retrieve all the changes for these set of DBFields</span>
    <span class="k">my</span> <span class="i">%Changes</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
        <span class="q">'Change_History,Employee'</span><span class="cm">,</span>
        <span class="s">[</span> <span class="q">'FK_DBField__ID'</span><span class="cm">,</span> <span class="q">'Record_ID'</span><span class="cm">,</span> <span class="q">'Old_Value'</span><span class="cm">,</span> <span class="q">'New_Value'</span><span class="cm">,</span> <span class="q">'FK_Employee__ID'</span><span class="cm">,</span> <span class="q">'Employee_Name'</span><span class="cm">,</span> <span class="q">'Modified_Date'</span><span class="cm">,</span> <span class="q">'Comment'</span> <span class="s">]</span><span class="cm">,</span>
        <span class="q">&quot;WHERE Employee_ID=FK_Employee__ID and FK_DBField__ID in ($dbfield_ids) and Record_ID IN('$record_ids') Order by Modified_Date asc&quot;</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$count</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="c">### Replace the DBField_ID(s) with the field names in the %Aliases hash</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">$Changes</span>{<span class="w">FK_DBField__ID</span>}-&gt;[<span class="i">$count</span>] <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$Changes</span>{<span class="w">Field_Alias</span>} }<span class="cm">,</span> <span class="i">$fields</span>{ <span class="i">$fields</span>{ <span class="i">$Changes</span>{<span class="w">FK_DBField__ID</span>}-&gt;[<span class="i">$count</span>] } } <span class="s">)</span><span class="sc">;</span>
        <span class="i">$count</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">### Remove the DBField_ID(s) from the resulting hash (hide them from end user);</span>
    <span class="k">delete</span> <span class="i">$Changes</span>{<span class="w">FK_DBField__ID</span>}<span class="sc">;</span>

    <span class="c">#    print Dumper \%Changes;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%Changes</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#############################</span>
<span class="c">#</span>
<span class="c">#  &lt;snip&gt; $self-&gt;log_parameters(\@_); &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="log_parameters-"></a><span class="k">sub </span><span class="m">log_parameters</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%input</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$package</span><span class="cm">,</span> <span class="i">$filename</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span> = <span class="k">caller</span><span class="s">(</span><span class="n">1</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$message</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$package</span> =~ <span class="q">/_API$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$self</span>-&gt;{<span class="w">logged_params</span>} <span class="k">or</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">logged_params</span>} } <span class="s">)</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">Call_Stack</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">print</span> <span class="i">Dumper</span><span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">logged_params</span>} <span class="s">)</span><span class="sc">;</span>
            <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Warning: Internal API call with no logged parameters! Please fix ASAP&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">%input</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">delete</span> <span class="i">$input</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
            <span class="k">delete</span> <span class="i">$input</span>{-<span class="w">connection</span>}<span class="sc">;</span>
            <span class="k">delete</span> <span class="i">$input</span>{-<span class="w">dbh</span>}<span class="sc">;</span>

            <span class="i">$self</span>-&gt;{<span class="w">logged_params</span>} = <span class="s">[</span><span class="s">]</span><span class="sc">;</span>
            <span class="i">$message</span> .= <span class="q">&quot;Start time: &quot;</span> . <span class="i">date_time</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
            <span class="i">$message</span> .= <span class="q">&quot;Arguments:\n************\n&quot;</span><span class="sc">;</span>
            <span class="i">$message</span> .= <span class="i">Dumper</span><span class="s">(</span> \<span class="i">%input</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$message</span> .= <span class="q">&quot;json: &quot;</span> . <span class="i">objToJson</span><span class="s">(</span> \<span class="i">%input</span> <span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$self</span>-&gt;{<span class="w">logged_params</span>} }<span class="cm">,</span> <span class="i">$message</span> <span class="k">if</span> <span class="i">$message</span><span class="sc">;</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c"># This initializes the $self-&gt;{data} hash which allows for easy access to retrieved data records</span>
<span class="c"># (enabling $self-&gt;get_record etc)</span>
<span class="c">#</span>
<span class="c"># Return:</span>
<span class="c">####################</span>
<a name="_initialize_data-"></a><span class="k">sub </span><span class="m">_initialize_data</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$data_ref</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%data</span> = <span class="i">%</span>{<span class="i">$data_ref</span>}<span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">data</span>} = \<span class="i">%data</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@keys</span> = <span class="k">keys</span> <span class="i">%data</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">records</span>} = <span class="k">int</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$data</span>{ <span class="i">$keys</span>[<span class="n">0</span>] } } <span class="s">)</span> <span class="k">if</span> <span class="k">defined</span> <span class="i">$data</span>{ <span class="i">$keys</span>[<span class="n">0</span>] }<span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">more_records</span>} = <span class="i">$self</span>-&gt;{<span class="w">records</span>} - <span class="n">1</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># Log usage to specified file</span>
<span class="c">#</span>
<span class="c"># Return : (nothing)</span>

<span class="c">###########################</span>
<span class="c"># Require users to only use (and know) their LIMS login password</span>
<span class="c">#</span>
<span class="c"># Return: 1 on validation success</span>
<span class="c">##################</span>
<a name="_password_check-"></a><span class="k">sub </span><span class="m">_password_check</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">$self</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'LIMS_password,LIMS_user,DB_user,required'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$password</span> = <span class="i">$args</span>{-<span class="w">LIMS_password</span>}<span class="sc">;</span>                                                      <span class="c">## password (LIMS)</span>
    <span class="k">my</span> <span class="i">$user</span>     = <span class="i">$args</span>{-<span class="w">LIMS_user</span>} || <span class="q">''</span><span class="sc">;</span>                                                    <span class="c">## Name (or email) of user</span>
    <span class="k">my</span> <span class="i">$DB_user</span>  = <span class="i">$args</span>{-<span class="w">DB_user</span>}<span class="sc">;</span>                                                            <span class="c">## password (LIMS)</span>
    <span class="k">my</span> <span class="i">$required</span> = <span class="i">$args</span>{-<span class="w">required</span>} || <span class="n">0</span><span class="sc">;</span>

    <span class="c">## ensure proper id / password has been entered ##</span>
    <span class="k">my</span> <span class="i">$DB_password</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbase</span>       = <span class="i">$self</span>-&gt;{<span class="w">dbase</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$host</span>        = <span class="i">$self</span>-&gt;{<span class="w">host</span>}<span class="sc">;</span>
    <span class="c">## &lt;CUSTOM&gt; ## Supply custom login passwords (put in non-readable file (?)..)</span>
    <span class="c">#</span>
    <span class="c"># Note: administrative privileges are used for WRITING to the database (must connect to production database)</span>
    <span class="c"># (non-administrators connect (with READ-ONLY permission) to the replication database</span>
    <span class="c">#</span>

    <span class="c">## change temporary viewer password to something else... ##</span>
    <span class="c">## Temporarily connect to ensure user / login / group specifications are valid ##</span>

    <span class="k">my</span> <span class="i">$Temp_Connection</span> = <span class="w">SDB::DBIO</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbase</span> <span class="cm">=&gt;</span> <span class="i">$dbase</span><span class="cm">,</span> -<span class="w">host</span> <span class="cm">=&gt;</span> <span class="i">$host</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="q">'viewer'</span><span class="cm">,</span> -<span class="w">password</span> <span class="cm">=&gt;</span> <span class="q">'viewer'</span><span class="cm">,</span> -<span class="w">connect</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$fail</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pass</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$password</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$user</span><span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;No User name supplied&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">my</span> <span class="i">$password_condition</span> = <span class="q">&quot; Password=Password('$password')&quot;</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$user_condition</span> = <span class="q">&quot;Password=Password('$password') AND (Email_Address = '$user' OR Email_Address like '$user\@' OR Employee_Name='$user')&quot;</span><span class="sc">;</span>

        <span class="c">## check to make sure group is valid ##</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$DB_user</span> &amp;&amp; <span class="i">$DB_user</span> <span class="k">ne</span> <span class="q">'viewer'</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## if DB_user is specified... ensure this DB_user is defined for this user</span>
            <span class="s">(</span><span class="i">$pass</span><span class="s">)</span> = <span class="i">$Temp_Connection</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Employee,DB_Login'</span><span class="cm">,</span> <span class="q">'count(*)'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Employee__ID=Employee_ID AND DB_User = '$DB_user' AND $user_condition&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$DB_user</span> <span class="k">eq</span> <span class="q">'viewer'</span> <span class="s">)</span> <span class="s">{</span>             <span class="c">#for viewer, just chceck for employee login</span>
            <span class="s">(</span><span class="i">$pass</span><span class="s">)</span> = <span class="i">$Temp_Connection</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Employee'</span><span class="cm">,</span> <span class="q">'count(*)'</span><span class="cm">,</span> <span class="q">&quot;WHERE $user_condition&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>                                       <span class="c">## if DB_user not specified, ensure only one valid DB_user for this user</span>
            <span class="i">$DB_user</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$Temp_Connection</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Employee,DB_Login'</span><span class="cm">,</span> <span class="q">'DB_User'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Employee__ID=Employee_ID AND $user_condition&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$DB_user</span> =~ <span class="q">/,/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Group must be supplied if connecting via LIMS (more than one valid user for $user). ('$args{-DB_user}')&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">return</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span> <span class="i">$pass</span> = <span class="n">1</span> <span class="s">}</span>                       <span class="c">## single DB_User extracted from database</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;No password supplied&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$Temp_Connection</span><span class="i">-&gt;disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$DB_user</span> &amp;&amp; <span class="i">$pass</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">DB_user</span>} = <span class="i">$DB_user</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>                                    <span class="c">## Success ##</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Verification failed for user: $user ($DB_user) - not on valid DB_Login list&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>                                          <span class="c">## Fail ##</span>
<span class="s">}</span>

<span class="c">####################################################################</span>
<span class="c"># Allow users to specify an alias for a sample (or list of samples)</span>
<span class="c">#</span>
<span class="c"># Users must specify either:</span>
<span class="c">#  - plate id(s) + well(s)</span>
<span class="c">#  - library + plate_number(s) + well(s)</span>
<span class="c">#  - sample_id(s)</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#  Examples:</span>
<span class="c">#</span>
<span class="c">#  my $data = $API-&gt;define_alias(-alias_type=&gt;'MGC',-alias=&gt;12345,-sample_id=&gt;$sample_id);</span>
<span class="c">#</span>
<span class="c">#  my $ok   = $API-&gt;define_alias(-alias_type=&gt;'AVF_ID',-alias=&gt;\@names,-library=&gt;'AVF01',-plate_number=&gt;1,-well=&gt;\@wells);</span>
<span class="c">#</span>
<span class="c">#  my $ok   = $API-&gt;define_alias(-alias_type=&gt;'AVF_ID',-alias=&gt;\@names,-plate_id=&gt;\@ids,-well=&gt;\@wells)</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># (repeat Alias_Type / Alias / Sample_ID records are ignored - no update since it already exists)</span>
<span class="c"># (repeat Alias_Type / Alias generates either:</span>
<span class="c">#    - ERROR (no update) (if 'allow_repeats' flag is not set);</span>
<span class="c">#    - WARNING but updates the database (if 'allow_repeats' flag is set);</span>
<span class="c">#</span>
<span class="c"># Return : Number of records added to Sample_Alias table.</span>
<span class="c">#####################</span>
<span class="c">###############</span>
<a name="define_alias-"></a><span class="k">sub </span><span class="m">define_alias</span> <span class="s">{</span>
<span class="c">###############</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">'alias'</span><span class="cm">,</span> <span class="q">'alias_type'</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$sample_id</span>     = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>                      <span class="c">## sample id (or array reference to list of ids)</span>
    <span class="k">my</span> <span class="i">$plate_id</span>      = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                       <span class="c">## plate id</span>
    <span class="k">my</span> <span class="i">$plate_number</span>  = <span class="i">$args</span>{-<span class="w">plate_number</span>}<span class="sc">;</span>                   <span class="c">## plate number</span>
    <span class="k">my</span> <span class="i">$library</span>       = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>                        <span class="c">## library of interest</span>
    <span class="k">my</span> <span class="i">$well</span>          = <span class="i">$args</span>{-<span class="w">well</span>}<span class="sc">;</span>                           <span class="c">## specific well(s)</span>
    <span class="k">my</span> <span class="i">$alias</span>         = <span class="i">$args</span>{-<span class="w">alias</span>} || <span class="i">$args</span>{-<span class="w">alias_name</span>}<span class="sc">;</span>    <span class="c">## alias name</span>
    <span class="k">my</span> <span class="i">$alias_type</span>    = <span class="i">$args</span>{-<span class="w">alias_type</span>}<span class="sc">;</span>                     <span class="c">## alias type</span>
    <span class="k">my</span> <span class="i">$allow_repeats</span> = <span class="i">$args</span>{-<span class="w">allow_repeats</span>} || <span class="n">0</span><span class="sc">;</span>             <span class="c">## flag necessary if alias is repeated for a separate sample</span>
    <span class="k">my</span> <span class="i">$quiet</span>         = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>         = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@alias_names</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$alias</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$number</span> = <span class="k">int</span><span class="s">(</span><span class="i">@alias_names</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@wells</span>         = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$well</span><span class="cm">,</span>         -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">pad</span> <span class="cm">=&gt;</span> <span class="i">$number</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@libraries</span>     = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span>      -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">pad</span> <span class="cm">=&gt;</span> <span class="i">$number</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@sample_ids</span>    = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span><span class="cm">,</span>    -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">pad</span> <span class="cm">=&gt;</span> <span class="i">$number</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@plate_ids</span>     = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span>     -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">pad</span> <span class="cm">=&gt;</span> <span class="i">$number</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@plate_numbers</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_number</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">pad</span> <span class="cm">=&gt;</span> <span class="i">$number</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$condition</span><span class="sc">;</span>    <span class="c">## Establish condition for extracting sample id from Clone_Sample table ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_id</span> &amp;&amp; <span class="i">$well</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$#plate_ids</span> == <span class="i">$#wells</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$#plate_ids</span> == <span class="i">$#alias_names</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Error: number of aliases should match number of wells, plate_ids&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$condition</span> = <span class="q">&quot;WHERE FKOriginal_Plate__ID = &lt;P_ID&gt; AND Original_Well = '&lt;WELL&gt;'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$library</span> &amp;&amp; <span class="i">$plate_number</span> &amp;&amp; <span class="i">$well</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$#libraries</span> == <span class="i">$#wells</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$#libraries</span> == <span class="i">$#plate_numbers</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$#libraries</span> == <span class="i">$#alias_names</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Error: number of aliases should match number of wells, libraries, plate_numbers&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$condition</span> = <span class="q">&quot;WHERE Plate.FKOriginal_Plate__ID=Plate_Sample.FKOriginal_Plate__ID AND Plate.FKOriginal_Plate__ID=Plate.Plate_ID AND FK_Library__Name = '&lt;LIB&gt;' AND Plate_Number = &lt;PNUM&gt; AND Well = '&lt;WELL&gt;' &quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$sample_id</span><span class="s">)</span> <span class="s">{</span> <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Error: you must specify Either plate_id + well, library + plate_number + well, or sample_id&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$updated</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="c">### define alias for each respective alias supplied ###</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$index</span> <span class="s">(</span> <span class="n">0</span> .. <span class="i">$#alias_names</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$alias</span> = <span class="i">$alias_names</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$sid</span><span class="sc">;</span>
        <span class="i">$sid</span> = <span class="i">$sample_ids</span>[<span class="i">$index</span>] <span class="k">if</span> <span class="i">$sample_id</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$w</span><span class="sc">;</span>
        <span class="i">$w</span> = <span class="i">$wells</span>[<span class="i">$index</span>] <span class="k">if</span> <span class="i">$well</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$pn</span><span class="sc">;</span>
        <span class="i">$pn</span> = <span class="i">$plate_numbers</span>[<span class="i">$index</span>] <span class="k">if</span> <span class="i">$plate_number</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$lib</span><span class="sc">;</span>
        <span class="i">$lib</span> = <span class="i">$libraries</span>[<span class="i">$index</span>] <span class="k">if</span> <span class="i">$library</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$pid</span><span class="sc">;</span>
        <span class="i">$pid</span> = <span class="i">$plate_ids</span>[<span class="i">$index</span>] <span class="k">if</span> <span class="i">$plate_id</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$cond</span> = <span class="i">$condition</span><span class="sc">;</span>

        <span class="i">$cond</span> =~ <span class="q">s/&lt;WELL&gt;/$w/g</span><span class="sc">;</span>
        <span class="i">$cond</span> =~ <span class="q">s/&lt;PNUM&gt;/$pn/g</span><span class="sc">;</span>
        <span class="i">$cond</span> =~ <span class="q">s/&lt;P_ID&gt;/$pid/g</span><span class="sc">;</span>
        <span class="i">$cond</span> =~ <span class="q">s/&lt;LIB&gt;/$lib/g</span><span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$sid</span><span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span><span class="i">$sid</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Sample,Plate'</span><span class="cm">,</span> <span class="q">'FK_Sample__ID'</span><span class="cm">,</span> <span class="i">$cond</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="i">$sid</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Error: Sample_ID not found for condition: $cond&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>

        <span class="c">##&lt;CONSTRUCTION&gt; This logic is convoluted a bit</span>
        <span class="c">### check to see if this Alias / Alias_Type already exists.</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$exists</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Alias'</span><span class="cm">,</span> <span class="q">'FK_Sample__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Alias = '$alias' AND Alias_Type = '$alias_type'&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$exists</span> =~ <span class="q">/^$sid$/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;$alias_type : $alias .... (This entry already exists)&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## the exact same entry (add organization ?)</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$exists</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$allow_repeats</span><span class="s">)</span> <span class="s">{</span>                                                                                        <span class="c">## allow re-using of same alias for new sample ?</span>
                <span class="i">$self</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Overwrote alias for sample: $exists&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>                                                                                                       <span class="c">## default prevents re-use of same alias</span>
                <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Error : This alias exists already for sample: $exists (use -allow_repeats switch to force new alias)&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">next</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$entry</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Alias'</span><span class="cm">,</span> <span class="q">'Alias'</span><span class="cm">,</span> <span class="q">&quot;WHERE Alias_Type = '$alias_type' AND FK_Sample__ID=$sid&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$entry</span> &amp;&amp; <span class="k">lc</span><span class="s">(</span><span class="i">$entry</span><span class="s">)</span> <span class="k">ne</span> <span class="k">lc</span><span class="s">(</span><span class="i">$alias</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$self</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;$alias_type for Sample $sid has been set to '$entry' and can not be changed.&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="i">$self</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Please contact a LIMS administrator to update this alias&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">next</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$self</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="q">'Sample_Alias'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FK_Sample__ID'</span><span class="cm">,</span> <span class="q">'Alias_Type'</span><span class="cm">,</span> <span class="q">'Alias'</span> <span class="s">]</span><span class="cm">,</span> <span class="s">[</span> <span class="i">$sid</span><span class="cm">,</span> <span class="i">$alias_type</span><span class="cm">,</span> <span class="i">$alias</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Set Alias $alias_type = $alias ($sid)&quot;</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$quiet</span><span class="sc">;</span>
        <span class="k">if</span>   <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span> <span class="i">$updated</span>++<span class="sc">;</span> <span class="s">}</span>
        <span class="k">else</span>       <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Warning: $alias_type = $alias ($sid) Failed&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$updated</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################################################</span>
<span class="c"># List aliases for fields available through the API</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example:</span>
<span class="c">#    $API-&gt;list_Aliases();</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c"># Return: none;</span>
<span class="c">################</span>
<a name="list_Aliases-"></a><span class="k">sub </span><span class="m">list_Aliases</span> <span class="s">{</span>
<span class="c">################</span>
    <span class="k">my</span> <span class="i">$self</span>    = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tables</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$verbose</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;_list_Fields</span><span class="s">(</span> <span class="i">$tables</span><span class="cm">,</span> <span class="i">$verbose</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################</span>
<span class="c"># Generate list of aliases and fields available for users to query.</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Return: (nothing) (prints list of fields / aliases to STDOUT)</span>
<span class="c">###################</span>
<a name="_list_Fields-"></a><span class="k">sub </span><span class="m">_list_Fields</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$self</span>    = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tables</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$verbose</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$table_list</span> = <span class="i">$tables</span><span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$table_list</span><span class="s">)</span> <span class="s">{</span> <span class="i">$table_list</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="k">keys</span> <span class="i">%Aliases</span> <span class="s">}</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">$table_list</span> =~ <span class="q">/(.*) LEFT JOIN (\S+) ON (.*)/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$table_list</span> = <span class="q">&quot;$1,$2&quot;</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## replace single left join in list...</span>

    <span class="k">my</span> <span class="i">$quoted_table_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$table_list</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%info</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'DBField,DBTable'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Field_Name'</span><span class="cm">,</span> <span class="q">'DBTable_Name as Table_Name'</span><span class="cm">,</span> <span class="q">'Field_Description as Description'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_DBTable__ID=DBTable_ID AND DBTable_Name in ($quoted_table_list)&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">print</span> <span class="q">&quot;\n****************\n** TABLES: **\n****************\n\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="k">join</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$table_list</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Descriptions</span><span class="sc">;</span>

    <span class="k">print</span> <span class="q">&quot;\n****************\n** FIELDS: **\n****************\n\n&quot;</span><span class="sc">;</span>

    <span class="c">## (print out list of fields and associated tables)</span>
    <span class="k">printf</span> <span class="q">&quot;\nFields:\n****************\n%-30s %-30s\n\n&quot;</span><span class="cm">,</span> <span class="q">'Field'</span><span class="cm">,</span> <span class="q">'Description'</span> <span class="k">if</span> <span class="i">$verbose</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$info</span>{<span class="w">Field_Name</span>}[ <span class="i">$index</span>++ ] <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$table</span> = <span class="i">$info</span>{<span class="w">Table_Name</span>}[ <span class="i">$index</span> - <span class="n">1</span> ]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$field</span> = <span class="i">$info</span>{<span class="w">Field_Name</span>}[ <span class="i">$index</span> - <span class="n">1</span> ]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$desc</span>  = <span class="i">$info</span>{<span class="w">Description</span>}[ <span class="i">$index</span> - <span class="n">1</span> ]<span class="sc">;</span>
        <span class="k">printf</span> <span class="q">&quot;%-30s %-30s : %s\n&quot;</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$field</span><span class="cm">,</span> <span class="i">$desc</span> <span class="k">if</span> <span class="i">$verbose</span><span class="sc">;</span>
        <span class="i">$Descriptions</span>{<span class="q">&quot;$table.$field&quot;</span>} = <span class="i">$info</span>{<span class="w">Description</span>}[ <span class="i">$index</span> - <span class="n">1</span> ]<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## Include applicable Aliases ##</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$table_list</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$object_aliases</span>{<span class="i">$table</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$add</span> = <span class="i">$object_aliases</span>{<span class="i">$table</span>}<span class="sc">;</span>
            <span class="i">$table_list</span> .= <span class="q">&quot;,&quot;</span> . <span class="i">$object_aliases</span>{<span class="i">$table</span>} <span class="k">unless</span> <span class="k">grep</span> <span class="q">/\b$add\b/</span><span class="cm">,</span> <span class="i">$table_list</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span> <span class="k">split</span> <span class="q">/\s*,\s*/</span><span class="cm">,</span> <span class="i">$table_list</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;\n$table Aliases\n*******************\n&quot;</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$Aliases</span>{<span class="i">$table</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$thisfield</span> = <span class="i">$Aliases</span>{<span class="i">$table</span>}{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="k">printf</span> <span class="q">&quot;%-30s %-30s\n&quot;</span><span class="cm">,</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$Descriptions</span>{<span class="i">$thisfield</span>} . <span class="q">&quot; [$Aliases{$table}{$key}]&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">######################</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Return hash ref to list of available fields based on a list of tables</span>
<span class="c">######################</span>
<a name="get_alias_info-"></a><span class="k">sub </span><span class="m">get_alias_info</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'tables,fields'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$table_list</span> = <span class="i">$args</span>{-<span class="w">tables</span>}<span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">$table_list</span><span class="s">)</span> <span class="s">{</span> <span class="i">$table_list</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="k">keys</span> <span class="i">%Aliases</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$alias_list</span> = <span class="i">$args</span>{-<span class="w">alias_list</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@alias_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$alias_list</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@table_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$table_list</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$quoted_table_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$table_list</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#    my $quoted_fields_list = Cast_List(-list=&gt;$fiel_list,-to=&gt;'String',-autoquote=&gt;1);</span>

    <span class="k">my</span> <span class="i">$condition</span> = <span class="q">&quot;WHERE FK_DBTable__ID=DBTable_ID AND DBTable_Name in ($quoted_table_list)&quot;</span><span class="sc">;</span>

    <span class="c"># if ($fields_list) {</span>
    <span class="c">#	push @conditions, &quot;Field_Name IN ($quoted_fields_list)&quot;;</span>
    <span class="c">#    }</span>

    <span class="k">my</span> <span class="i">%db_field_info</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'DBField,DBTable'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Field_Name'</span><span class="cm">,</span> <span class="q">'DBTable_Name as Table_Name'</span><span class="cm">,</span> <span class="q">'Field_Description as Description'</span> <span class="s">]</span><span class="cm">,</span> <span class="i">$condition</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%available_field_list</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%field_desc</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$db_field_info</span>{<span class="w">Field_Name</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$field_name</span> = <span class="i">$db_field_info</span>{<span class="w">Field_Name</span>}[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$table_name</span> = <span class="i">$db_field_info</span>{<span class="w">Table_Name</span>}[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$field_desc</span> = <span class="i">$db_field_info</span>{<span class="w">Description</span>}[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="i">$field_desc</span>{<span class="q">&quot;$table_name.$field_name&quot;</span>} = <span class="i">$field_desc</span><span class="sc">;</span>
        <span class="i">$index</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span><span class="i">@table_list</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$Aliases</span>{<span class="i">$table</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$full_field_name</span> = <span class="i">$Aliases</span>{<span class="i">$table</span>}{<span class="i">$key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$alias</span>           = <span class="i">$key</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$alias_list</span> &amp;&amp; !<span class="s">(</span> <span class="k">grep</span> <span class="q">/^$key$/i</span><span class="cm">,</span> <span class="i">@alias_list</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">next</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$available_field_list</span>{<span class="i">$table</span>}{<span class="i">$alias</span>} = <span class="s">{</span> <span class="w">full_name</span> <span class="cm">=&gt;</span> <span class="i">$full_field_name</span><span class="cm">,</span> <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">$field_desc</span>{<span class="i">$full_field_name</span>} <span class="s">}</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> \<span class="i">%available_field_list</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#       my %reasons     = $API-&gt;get_failreasons(-object=&gt;'Lane');</span>
<span class="c">#       my $reason_id   = $API-&gt;get_failreasons(-object=&gt;'Lane',-reason=&gt;'Manually Deselected');</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="get_failreasons-"></a><span class="k">sub </span><span class="m">get_failreasons</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'Object,Object_Type'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'Object'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$groups</span> = <span class="i">$self</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'group_list'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$object</span> = <span class="i">$args</span>{-<span class="w">Object</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>   = <span class="i">$args</span>{-<span class="w">Object_Type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$name</span>   = <span class="i">$args</span>{-<span class="w">reason_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>  = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span>  = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$reasons</span> = <span class="i">&amp;alDente::Fail::get_reasons</span><span class="s">(</span> -<span class="w">object</span> <span class="cm">=&gt;</span> <span class="i">$object</span><span class="cm">,</span> -<span class="w">object_type</span> <span class="cm">=&gt;</span> <span class="i">$type</span><span class="cm">,</span> -<span class="w">grps</span> <span class="cm">=&gt;</span> <span class="i">$groups</span><span class="cm">,</span> -<span class="w">reason_name</span> <span class="cm">=&gt;</span> <span class="i">$name</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$reasons</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#########################</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#   my $project_details = $API-&gt;get_project_data('Human Tum'); ### *Human Tum*</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="get_project_data-"></a><span class="k">sub </span><span class="m">get_project_data</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'project_name'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'project_name'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$project_name</span> = <span class="i">$args</span>{-<span class="w">project_name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">%project_details</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Project'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'*'</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Project_Name LIKE '%$project_name%'&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%project_details</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#  Return Submission information</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="get_submission_data-"></a><span class="k">sub </span><span class="m">get_submission_data</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Include below any arguments that should appear in perldoc + any arguments needing specific attention</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_conditions</span>   = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>     <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$study_id</span>           = <span class="i">$args</span>{-<span class="w">study_id</span>}<span class="sc">;</span>             <span class="c">### a study id (a defined set of libraries/projects)</span>
    <span class="k">my</span> <span class="i">$project_id</span>         = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>           <span class="c">### specify project_id</span>
    <span class="k">my</span> <span class="i">$library</span>            = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>              <span class="c">### specify library</span>
    <span class="k">my</span> <span class="i">$work_request_type</span>  = <span class="i">$args</span>{-<span class="w">work_request_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$submitted_employee</span> = <span class="i">$args</span>{-<span class="w">submitted_employee</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$input_joins</span>      = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span> = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>

    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>                             <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>                           <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">'Submission_DateTime'</span><span class="sc">;</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>

            <span class="c">### Re-Cast arguments as required ###</span>
            <span class="k">my</span> <span class="i">$libs</span><span class="sc">;</span>
            <span class="i">$libs</span> = <span class="i">$self</span><span class="i">-&gt;get_libraries</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$study_id</span> || <span class="i">$project_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$libs</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$work_request_types</span><span class="sc">;</span>
    <span class="i">$work_request_types</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$work_request_type</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$work_request_type</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$submitted_employees</span><span class="sc">;</span>
    <span class="i">$submitted_employees</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$submitted_employee</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$submitted_employee</span><span class="sc">;</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$libraries</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$work_request_types</span><span class="s">)</span>  <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Work_Request_Type.Work_Request_Type_Name IN ($work_request_types)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$submitted_employees</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Submission.FKSubmitted_Employee__ID IN ($submitted_employees)&quot;</span> <span class="s">)</span> <span class="s">}</span>

    <span class="c">## Initial Framework for query ##</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="q">'Submission'</span><span class="sc">;</span>    <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">'WHERE 1'</span><span class="sc">;</span>       <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>              <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">##### DYNAMICALLY JOINED Tables: #####</span>
    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>               <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="c">## standards ##</span>
        <span class="c">#	&quot;Submission_Table_Link&quot;  =&gt; &quot;Submission_ID = Submission_Table_Link.FK_Submission__ID&quot;,</span>
        <span class="c">#	&quot;Submission_Info&quot;       =&gt; &quot;Submission_Info.FK_Submission__ID = Submission_ID&quot;,</span>
        <span class="c">#	&quot;Library&quot; =&gt; &quot;Submission.Key_Value = Library.Library_Name&quot;,</span>
    <span class="s">}</span><span class="sc">;</span>                                      <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">&quot;Employee as Approver&quot;</span>  <span class="cm">=&gt;</span> <span class="q">&quot;Approver.Employee_ID = FKApproved_Employee__ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Employee as Submitter&quot;</span> <span class="cm">=&gt;</span> <span class="q">&quot;Submitter.Employee_ID = FKSubmitted_Employee__ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Work_Request&quot;</span>          <span class="cm">=&gt;</span> <span class="q">&quot;Work_Request.Work_Request_ID  = Submission.Key_Value&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Library&quot;</span>               <span class="cm">=&gt;</span> <span class="q">&quot;Work_Request.FK_Library__Name = Library.Library_Name&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Work_Request_Type&quot;</span>     <span class="cm">=&gt;</span> <span class="q">&quot;Work_Request.FK_Work_Request_Type__ID = Work_Request_Type.Work_Request_Type_ID&quot;</span>

            <span class="c">#&quot;LibraryGoal&quot; =&gt; &quot;Library.Library_Name = LibraryGoal.FK_Library__Name&quot;,</span>
    <span class="s">}</span><span class="sc">;</span>                                      <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## adapt conditions using appropriate aliases as required ##</span>
    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>

    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(submission_date submission_status approved_date submission_id submission_comments submitted_by approved_by)</span><span class="sc">;</span>    <span class="c">## &lt;- Default list of fields to retrieve</span>

    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">date_field</span>           <span class="cm">=&gt;</span> <span class="i">$date_field</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#  Returns submission volume information that is sent to different data centers ie (NCBI/cgHUB)</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">################################</span>
<a name="get_submission_volume_data-"></a><span class="k">sub </span><span class="m">get_submission_volume_data</span> <span class="s">{</span>
<span class="c">################################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">## Include below any arguments that should appear in perldoc + any arguments needing specific attention</span>

    <span class="c">## Specify conditions for data retrieval</span>
    <span class="k">my</span> <span class="i">$input_conditions</span> = <span class="i">$args</span>{-<span class="w">condition</span>} || <span class="q">'1'</span><span class="sc">;</span>    <span class="c">### extra condition (vulnerable to structure change)</span>
    <span class="k">my</span> <span class="i">$library</span>          = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$study_id</span>         = <span class="i">$args</span>{-<span class="w">study_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$project_id</span>       = <span class="i">$args</span>{-<span class="w">project_id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$input_joins</span>                          = <span class="i">$args</span>{-<span class="w">input_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input_left_joins</span>                     = <span class="i">$args</span>{-<span class="w">input_left_joins</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_analysis</span>                         = <span class="i">$args</span>{-<span class="w">run_analysis</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$multiplex_run_analysis</span>               = <span class="i">$args</span>{-<span class="w">multiplex_run_analysis</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$adapter_index</span>                        = <span class="i">$args</span>{-<span class="w">multiplex_adapter_index</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$solexa_reference_genome_id</span>           = <span class="i">$args</span>{-<span class="w">solexa_reference_genome_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$multiplex_solexa_reference_genome_id</span> = <span class="i">$args</span>{-<span class="w">multiplex_solexa_reference_genome_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$trace_submission_id</span>                  = <span class="i">$args</span>{-<span class="w">trace_submission_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$submission_volume_id</span>                 = <span class="i">$args</span>{-<span class="w">submission_volume_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$include_analysis</span>                     = <span class="i">$args</span>{-<span class="w">include_analysis</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$analysis_metadata_object_alias</span>       = <span class="i">$args</span>{-<span class="w">analysis_metadata_object_alias</span>}<span class="sc">;</span>
    <span class="c">## Inclusion / Exclusion options</span>
    <span class="k">my</span> <span class="i">$since</span> = <span class="i">$args</span>{-<span class="w">since</span>}<span class="sc">;</span>      <span class="c">### specify date to begin search (context dependent)</span>
    <span class="k">my</span> <span class="i">$until</span> = <span class="i">$args</span>{ -<span class="k">until</span> }<span class="sc">;</span>    <span class="c">### specify date to stop search (context dependent)</span>
            <span class="k">my</span> <span class="i">$date_field</span> = <span class="i">$args</span>{-<span class="w">date_field</span>} || <span class="q">'Submission_Date'</span><span class="sc">;</span>

            <span class="c">## Output options</span>
            <span class="k">my</span> <span class="i">$fields</span>      = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_fields</span>  = <span class="i">$args</span>{-<span class="w">add_fields</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$order</span>       = <span class="i">$args</span>{-<span class="w">order</span>} || <span class="q">''</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$group</span>       = <span class="i">$args</span>{-<span class="w">group</span>} || <span class="i">$args</span>{-<span class="w">group_by</span>} || <span class="i">$args</span>{-<span class="w">key</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$KEY</span>         = <span class="i">$args</span>{-<span class="w">key</span>} || <span class="i">$group</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$limit</span>       = <span class="i">$args</span>{-<span class="w">limit</span>} || <span class="q">''</span><span class="sc">;</span>                                <span class="c">### limit number of unique samples to retrieve data for</span>
            <span class="k">my</span> <span class="i">$quiet</span>       = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>                                      <span class="c">### suppress feedback by setting quiet option</span>
            <span class="k">my</span> <span class="i">$save</span>        = <span class="i">$args</span>{-<span class="w">save</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$list_fields</span> = <span class="i">$args</span>{-<span class="w">list_fields</span>}<span class="sc">;</span>                                <span class="c">### just generate a list of output fields</span>

            <span class="c">### Re-Cast arguments as required ###</span>
            <span class="k">my</span> <span class="i">$libs</span><span class="sc">;</span>
            <span class="i">$libs</span> = <span class="i">$self</span><span class="i">-&gt;get_libraries</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> || <span class="i">$study_id</span> || <span class="i">$project_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$libraries</span><span class="sc">;</span>
    <span class="i">$libraries</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$libs</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$libs</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$run_analyses</span><span class="sc">;</span>
    <span class="i">$run_analyses</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$run_analysis</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$run_analysis</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$multiplex_run_analyses</span><span class="sc">;</span>
    <span class="i">$multiplex_run_analyses</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$multiplex_run_analysis</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$multiplex_run_analysis</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$multiplex_run_indices</span><span class="sc">;</span>
    <span class="i">$multiplex_run_indices</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$adapter_index</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$adapter_index</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$solexa_reference_genome_ids</span><span class="sc">;</span>
    <span class="i">$solexa_reference_genome_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$solexa_reference_genome_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$solexa_reference_genome_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$multiplex_solexa_reference_genome_ids</span><span class="sc">;</span>
    <span class="i">$multiplex_solexa_reference_genome_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$multiplex_solexa_reference_genome_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$multiplex_solexa_reference_genome_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$trace_submission_ids</span><span class="sc">;</span>
    <span class="i">$trace_submission_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$trace_submission_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$trace_submission_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$submission_volume_ids</span><span class="sc">;</span>
    <span class="i">$submission_volume_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$submission_volume_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$submission_volume_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$analysis_metadata_object_aliases</span><span class="sc">;</span>
    <span class="i">$analysis_metadata_object_aliases</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$analysis_metadata_object_alias</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$analysis_metadata_object_alias</span><span class="sc">;</span>

    <span class="c">## Define Tables / Conditions ##</span>
    <span class="k">my</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">@extra_conditions</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$input_conditions</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">no_split</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$input_conditions</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$libraries</span><span class="s">)</span>                             <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Library.Library_Name IN ($libraries)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$run_analyses</span><span class="s">)</span>                          <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Analysis_Submission.FK_Run_Analysis__ID IN ($run_analyses)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$multiplex_run_analyses</span><span class="s">)</span>                <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Analysis_Submission.FK_Multiplex_Run_Analysis__ID IN ($multiplex_run_analyses)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$multiplex_run_indices</span><span class="s">)</span>                 <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Multiplex_Run_Analysis.Adapter_Index IN ($multiplex_run_indices)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$solexa_reference_genome_ids</span><span class="s">)</span>           <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Solexa_Run_Analysis.FK_Genome__ID IN ($solexa_reference_genome_ids)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$multiplex_solexa_reference_genome_ids</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Multiplex_Solexa_Run_Analysis.FK_Genome__ID IN ($multiplex_solexa_reference_genome_ids)&quot;</span> <span class="s">)</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$trace_submission_ids</span><span class="s">)</span>             <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Trace_Submission_ID IN ($trace_submission_ids)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$submission_volume_ids</span><span class="s">)</span>            <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;Submission_Volume_ID IN ($submission_volume_ids)&quot;</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$analysis_metadata_object_aliases</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;analysis_metadata_object_alias IN ($analysis_metadata_object_aliases)&quot;</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$include_analysis</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@extra_conditions</span><span class="cm">,</span> <span class="q">&quot;(Multiplex_Run_Analysis.FK_Sample__ID = Sample_ID OR Run_Analysis.FK_Sample__ID = Sample_ID) &quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="c">## Initial Framework for query ##</span>
    <span class="k">my</span> <span class="i">$tables</span>           = <span class="q">'Submission_Volume,Trace_Submission'</span><span class="sc">;</span>                                                          <span class="c">## &lt;- Supply list of Tables to retrieve data from ##</span>
    <span class="k">my</span> <span class="i">$join_condition</span>   = <span class="q">'WHERE Submission_Volume.Submission_Volume_ID = Trace_Submission.FK_Submission_Volume__ID'</span><span class="sc">;</span>    <span class="c">## &lt;- Supply join condition for Tables retrieved (if &gt; 1) ##</span>
    <span class="k">my</span> <span class="i">$left_join_tables</span> = <span class="q">''</span><span class="sc">;</span>                                                                                            <span class="c">## &lt;- Supply additional tables to left_join (includes condition)</span>

    <span class="c">##### DYNAMICALLY JOINED Tables: #####</span>
    <span class="c">## add Tables as necessary based with specified join conditions ##</span>
    <span class="k">my</span> <span class="i">$join_conditions</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>                                                                                             <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="i">$join_conditions</span> = <span class="s">{</span>
        <span class="c">## standards ##</span>
        <span class="q">&quot;Run&quot;</span>                               <span class="cm">=&gt;</span> <span class="q">&quot;Trace_Submission.FK_Run__ID = Run.Run_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Plate&quot;</span>                             <span class="cm">=&gt;</span> <span class="q">&quot;Plate.Plate_ID = Run.FK_Plate__ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Sample&quot;</span>                            <span class="cm">=&gt;</span> <span class="q">&quot;Sample.Sample_ID = Trace_Submission.FK_Sample__ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Library&quot;</span>                           <span class="cm">=&gt;</span> <span class="q">&quot;Sample.FK_Library__Name = Library.Library_Name&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Status&quot;</span>                            <span class="cm">=&gt;</span> <span class="q">&quot;Submission_Volume.FK_Status__ID = Status.Status_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Status as Trace_Submission_Status&quot;</span> <span class="cm">=&gt;</span> <span class="q">&quot;Trace_Submission.FK_Status__ID = Trace_Submission_Status.Status_ID&quot;</span>
    <span class="s">}</span><span class="sc">;</span>                                                                                                                    <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## specify optional tables to LEFT JOIN - used in 'include_if_necessary' method  ##</span>
    <span class="k">my</span> <span class="i">$left_join_conditions</span> = <span class="s">{</span>
        <span class="q">&quot;Metadata_Submission&quot;</span> <span class="cm">=&gt;</span> <span class="q">&quot;Metadata_Submission.FK_Submission_Volume__ID = Submission_Volume.Submission_Volume_ID&quot;</span><span class="cm">,</span>

        <span class="c">#&quot;Metadata_Object&quot; =&gt; &quot;Metadata_Submission.FK_Metadata_Object__ID = Metadata_Object.Metadata_Object_ID &quot;,</span>
        <span class="c">#&quot;Analysis_Link&quot; =&gt; &quot;Analysis_Link.FKAnalysis_Metadata_Object__ID = Metadata_Object.Metadata_Object_ID&quot;,</span>
        <span class="c">#&quot;Metadata_Object as Analysis_Metadata_Object&quot; =&gt; &quot;Metadata_Submission.FK_Metadata_Object__ID = Analysis_Metadata_Object.Metadata_Object_ID &quot;,</span>
        <span class="c">#&quot;Analysis_Link&quot;                               =&gt; &quot;Analysis_Link.FKAnalysis_Metadata_Object__ID = Analysis_Metadata_Object.Metadata_Object_ID&quot;,</span>
        <span class="c">#&quot;Analysis_File&quot;                               =&gt; &quot;Analysis_Link.FK_Analysis_File__ID = Analysis_File.Analysis_File_ID&quot;,</span>
        <span class="q">&quot;Metadata_Object as Analysis_Metadata_Object&quot;</span> <span class="cm">=&gt;</span> <span class="q">&quot;Analysis_Metadata_Object.Metadata_Object_ID = Analysis_Link.FKAnalysis_Metadata_Object__ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Metadata_Object as Sample_Metadata_Object&quot;</span>   <span class="cm">=&gt;</span> <span class="q">&quot;Sample_Metadata_Object.Metadata_Object_ID = Analysis_Link.FKSample_Metadata_Object__ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Analysis_Link&quot;</span>                               <span class="cm">=&gt;</span> <span class="q">&quot;Analysis_Link.FK_Analysis_File__ID = Analysis_File.Analysis_File_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Analysis_File&quot;</span>                               <span class="cm">=&gt;</span> <span class="q">&quot;Analysis_Submission.FK_Analysis_File__ID = Analysis_File.Analysis_File_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Analysis_Submission&quot;</span>                         <span class="cm">=&gt;</span> <span class="q">&quot;Analysis_Submission.FK_Submission_Volume__ID = Submission_Volume.Submission_Volume_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Multiplex_Run_Analysis&quot;</span>                      <span class="cm">=&gt;</span> <span class="q">&quot;Analysis_Submission.FK_Multiplex_Run_Analysis__ID = Multiplex_Run_Analysis.Multiplex_Run_Analysis_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Multiplex_Solexa_Run_Analysis&quot;</span>               <span class="cm">=&gt;</span> <span class="q">&quot;Multiplex_Solexa_Run_Analysis.FK_Multiplex_Run_Analysis__ID = Multiplex_Run_Analysis.Multiplex_Run_Analysis_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Run_Analysis&quot;</span>                                <span class="cm">=&gt;</span> <span class="q">&quot;Analysis_Submission.FK_Run_Analysis__ID = Run_Analysis.Run_Analysis_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Solexa_Run_Analysis&quot;</span>                         <span class="cm">=&gt;</span> <span class="q">&quot;Solexa_Run_Analysis.FK_Run_Analysis__ID = Run_Analysis.Run_Analysis_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Status as Analysis_Submission_Status&quot;</span>        <span class="cm">=&gt;</span> <span class="q">&quot;Analysis_Submission.FK_Status__ID = Analysis_Submission_Status.Status_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Status as Analysis_Metadata_Status&quot;</span>          <span class="cm">=&gt;</span> <span class="q">&quot;Analysis_Metadata_Object.FK_Status__ID = Analysis_Metadata_Status.Status_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Organization&quot;</span>                                <span class="cm">=&gt;</span> <span class="q">&quot;Submission_Volume.FK_Organization__ID = Organization.Organization_ID&quot;</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>    <span class="c">##	eg { '&lt;TABLENAME&gt;'      =&gt; &quot;&lt;JOIN_CONDITION&gt;&quot;, ... } ,</span>

    <span class="c">## adapt conditions using appropriate aliases as required ##</span>
    <span class="i">&amp;customize_join_conditions</span><span class="s">(</span> <span class="i">$join_conditions</span><span class="cm">,</span> <span class="i">$left_join_conditions</span><span class="cm">,</span> -<span class="w">input_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_joins</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">input_left_joins</span> <span class="cm">=&gt;</span> <span class="i">$input_left_joins</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## Add extra_conditions as required by input parameters   eg...##</span>
    <span class="c">## &lt;- if ($samples) { push(@extra_conditions,&quot;FK_Sample__ID IN ($samples)&quot;};</span>
    <span class="c">## Concatenate conditions ##</span>
    <span class="k">my</span> <span class="i">$conditions</span> = <span class="k">join</span> <span class="q">' AND '</span><span class="cm">,</span> <span class="i">@extra_conditions</span><span class="sc">;</span>
    <span class="i">$conditions</span> ||= <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="q">qw(Volume_Name volume_status)</span><span class="sc">;</span>    <span class="c">## &lt;- Default list of fields to retrieve</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$include_analysis</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="s">(</span> <span class="q">'multiplex_analysis_sample'</span><span class="cm">,</span> <span class="q">'run_analysis_sample'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">## IF fields specified, over-ride default list ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$add_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@add_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$add_fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@add_list</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;generate_data</span><span class="s">(</span>
        -<span class="w">input</span>                <span class="cm">=&gt;</span> \<span class="i">%args</span><span class="cm">,</span>
        -<span class="w">field_list</span>           <span class="cm">=&gt;</span> \<span class="i">@field_list</span><span class="cm">,</span>
        -<span class="w">group</span>                <span class="cm">=&gt;</span> <span class="i">$group</span><span class="cm">,</span>
        -<span class="w">key</span>                  <span class="cm">=&gt;</span> <span class="i">$KEY</span><span class="cm">,</span>
        -<span class="w">order</span>                <span class="cm">=&gt;</span> <span class="i">$order</span><span class="cm">,</span>
        -<span class="w">tables</span>               <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span>
        -<span class="w">join_condition</span>       <span class="cm">=&gt;</span> <span class="i">$join_condition</span><span class="cm">,</span>
        -<span class="w">conditions</span>           <span class="cm">=&gt;</span> <span class="i">$conditions</span><span class="cm">,</span>
        -<span class="w">left_join_tables</span>     <span class="cm">=&gt;</span> <span class="i">$left_join_tables</span><span class="cm">,</span>
        -<span class="w">left_join_conditions</span> <span class="cm">=&gt;</span> <span class="i">$left_join_conditions</span><span class="cm">,</span>
        -<span class="w">join_conditions</span>      <span class="cm">=&gt;</span> <span class="i">$join_conditions</span><span class="cm">,</span>
        -<span class="w">date_field</span>           <span class="cm">=&gt;</span> <span class="i">$date_field</span><span class="cm">,</span>
        -<span class="w">limit</span>                <span class="cm">=&gt;</span> <span class="i">$limit</span><span class="cm">,</span>
        -<span class="w">quiet</span>                <span class="cm">=&gt;</span> <span class="i">$quiet</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">##############################</span>
<span class="c">#</span>
<span class="c"># Arguments:    'reference'        #  Data References</span>
<span class="c">#               'annot_type'       #  RunDataAnnotation_Type_ID or RunDataAnnotation_Type_Name</span>
<span class="c">#               'annot_value'      #  The value we are setting it to</span>
<span class="c">#               'comments'         #  Optional comments</span>
<span class="c">#               'quiet'            #  Supress the output</span>
<span class="c"># Returns:      1 on success, 0 on failure</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#      my $ok = $API-&gt;set_rundata_annotations(</span>
<span class="c">#                             -reference =&gt; ['50:A01','51:A01'],</span>
<span class="c">#                             -annot_type  =&gt; 'Sulston Score',</span>
<span class="c">#                             -annot_value =&gt; '5.32e-10'</span>
<span class="c">#                             );</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">##############################</span>
<a name="set_rundata_annotations-"></a><span class="k">sub </span><span class="m">set_rundata_annotations</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'reference,annot_type,annot_value'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'reference,annot_type,annot_value'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">### Connection parameters ###</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">### Mandatory ###</span>
    <span class="k">my</span> <span class="i">$reference</span>   = <span class="i">$args</span>{-<span class="w">reference</span>}<span class="sc">;</span>      <span class="c">#  Data References</span>
    <span class="k">my</span> <span class="i">$annot_type</span>  = <span class="i">$args</span>{-<span class="w">annot_type</span>}<span class="sc">;</span>     <span class="c">#  RunDataAnnotation_Type_ID or RunDataAnnotation_Type_Name</span>
    <span class="k">my</span> <span class="i">$annot_value</span> = <span class="i">$args</span>{-<span class="w">annot_value</span>}<span class="sc">;</span>    <span class="c">#  The value we are setting it to</span>

    <span class="c">### Optional ###</span>
    <span class="k">my</span> <span class="i">$comments</span> = <span class="i">$args</span>{-<span class="w">comments</span>}<span class="sc">;</span>          <span class="c">#  Optional comments</span>
    <span class="k">my</span> <span class="i">$quiet</span>    = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>

    <span class="k">require</span> <span class="w">alDente::RunDataReference</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$obj</span> = <span class="w">alDente::RunDataReference</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$return</span> = <span class="i">$obj</span><span class="i">-&gt;save_annotations</span><span class="s">(</span> -<span class="w">reference</span> <span class="cm">=&gt;</span> <span class="i">$reference</span><span class="cm">,</span> -<span class="w">annot_type</span> <span class="cm">=&gt;</span> <span class="i">$annot_type</span><span class="cm">,</span> -<span class="w">annot_value</span> <span class="cm">=&gt;</span> <span class="i">$annot_value</span><span class="cm">,</span> -<span class="w">comments</span> <span class="cm">=&gt;</span> <span class="i">$comments</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$return</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># Arguments:    'run_id'                #  Run_ID of interest [mandatory]</span>
<span class="c">#               'well'                  #  Specific field on the given Run [optional]</span>
<span class="c">#               'annot_type'            #  RunDataAnnotation_Type_ID or RunDataAnnotation_Type_Name</span>
<span class="c">#               'quiet'                 #  Supress the output</span>
<span class="c">#</span>
<span class="c"># Returns:      'annotations hash' on success, 'undef' on failure</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#       my $score = $API-&gt;get_rundata_annotation_sets(</span>
<span class="c">#                             -run_id           =&gt; 5000,</span>
<span class="c">#                             -well             =&gt; 'A01',</span>
<span class="c">#                             -annot_type       =&gt; 'Sulston Score'</span>
<span class="c">#                             );</span>
<span class="c">##############################</span>
<a name="get_rundata_annotation_sets-"></a><span class="k">sub </span><span class="m">get_rundata_annotation_sets</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'run_id,well'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'run_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">### Connection parameters ###</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">### Mandatory ###</span>
    <span class="k">my</span> <span class="i">$run_id</span> = <span class="i">$args</span>{-<span class="w">run_id</span>}<span class="sc">;</span>    <span class="c">#  Run_ID of interest</span>
    <span class="k">my</span> <span class="i">$well</span>   = <span class="i">$args</span>{-<span class="w">well</span>}<span class="sc">;</span>      <span class="c">#  Specific field on the given Run [optional]</span>

    <span class="c">### Optional ###</span>
    <span class="k">my</span> <span class="i">$annot_type</span> = <span class="i">$args</span>{-<span class="w">annot_type</span>}<span class="sc">;</span>    <span class="c">#  RunDataAnnotation_Type_ID or RunDataAnnotation_Type_Name</span>
    <span class="k">my</span> <span class="i">$quiet</span>      = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>

    <span class="k">require</span> <span class="w">alDente::RunDataReference</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$obj</span> = <span class="w">alDente::RunDataReference</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$return</span> = <span class="i">$obj</span><span class="i">-&gt;get_annotation_sets</span><span class="s">(</span> -<span class="w">run_id</span> <span class="cm">=&gt;</span> <span class="i">$run_id</span><span class="cm">,</span> -<span class="w">well</span> <span class="cm">=&gt;</span> <span class="i">$well</span><span class="cm">,</span> -<span class="w">annot_type</span> <span class="cm">=&gt;</span> <span class="i">$annot_type</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="i">$quiet</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$return</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># Arguments:    'reference'              #  Run_ID of interest [mandatory]</span>
<span class="c">#               'annot_type'            #  RunDataAnnotation_Type_ID or RunDataAnnotation_Type_Name</span>
<span class="c">#</span>
<span class="c"># Returns:      'annotations hash' on success, 'undef' on failure</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#       my $score = $API-&gt;get_rundata_annotation_value(</span>
<span class="c">#                             -reference=&gt;['50:A01','50:A01'],</span>
<span class="c">#                             -annot_type       =&gt; 'Sulston Score'</span>
<span class="c">#                             );</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">##############################</span>
<a name="get_rundata_annotation_value-"></a><span class="k">sub </span><span class="m">get_rundata_annotation_value</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'reference,annot_type'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'reference,annot_type'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">### Connection parameters ###</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$reference</span>  = <span class="i">$args</span>{-<span class="w">reference</span>}<span class="sc">;</span>     <span class="c">#  Run_ID of interest [mandatory]</span>
    <span class="k">my</span> <span class="i">$annot_type</span> = <span class="i">$args</span>{-<span class="w">annot_type</span>}<span class="sc">;</span>    <span class="c">#  RunDataAnnotation_Type_ID or RunDataAnnotation_Type_Name</span>

    <span class="k">require</span> <span class="w">alDente::RunDataReference</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$obj</span> = <span class="w">alDente::RunDataReference</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$return</span> = <span class="i">$obj</span><span class="i">-&gt;get_annotation_value</span><span class="s">(</span> -<span class="w">reference</span> <span class="cm">=&gt;</span> <span class="i">$reference</span><span class="cm">,</span> -<span class="w">annot_type</span> <span class="cm">=&gt;</span> <span class="i">$annot_type</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$return</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">##############################################################################################################</span>
<span class="c">#</span>
<span class="c"># Convert the parameters passed to get_xxx_summary to parameters acceptable by the corresponding get_xxx_data</span>
<span class="c"># eg. given:</span>
<span class="c">#</span>
<span class="c">#  get_read_summary(-group_by=&gt;['project_id', 'library'], -count=&gt;['run_id','run_status'], -avg=&gt;['Q20','Q30','quality_length'], -max=&gt;['Q30'], -sum=&gt;['quality_length'], -min=&gt;['Q20'], -stddev=&gt;['Q20'], -plate_type=&gt;'Library_Plate')</span>
<span class="c">#</span>
<span class="c">#  to be passed to</span>
<span class="c">#  get_read_data(-group_by=&gt;['project_id', 'library'], -fields=&gt;['project_id', 'library', 'count(run_id) as count_run_id', 'count(run_status) as count_run_status', 'avg(Q20) as avg_Q20', 'avg(Q30) as avg_Q30', 'avg(quality_length) as avg_quality_length', 'max(Q30) as max_Q30', 'sum(quality_length) as sum_quality_length', 'min(Q20) as min_Q20', 'stddev(Q20) as stddev_Q20'], -plate_type=&gt;'Library_Plate')</span>
<span class="c">#</span>
<span class="c"># Return: hash ref of the arguments to be passed to get_xxx_data</span>
<span class="c">######################################</span>
<a name="convert_parameters_for_summary-"></a><span class="k">sub </span><span class="m">convert_parameters_for_summary</span> <span class="s">{</span>
<span class="c">######################################</span>

    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$scope</span> = <span class="i">$args</span>{-<span class="w">scope</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$group_by</span> = <span class="i">$args</span>{-<span class="w">group_by</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$count</span>  = <span class="i">$args</span>{-<span class="w">count</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$avg</span>    = <span class="i">$args</span>{-<span class="w">avg</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sum</span>    = <span class="i">$args</span>{-<span class="w">sum</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$min</span>    = <span class="i">$args</span>{-<span class="w">min</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$max</span>    = <span class="i">$args</span>{-<span class="w">max</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$stddev</span> = <span class="i">$args</span>{-<span class="w">stddev</span>}<span class="sc">;</span>

    <span class="k">delete</span> <span class="i">$args</span>{-<span class="w">count</span>}<span class="sc">;</span>
    <span class="k">delete</span> <span class="i">$args</span>{-<span class="w">avg</span>}<span class="sc">;</span>
    <span class="k">delete</span> <span class="i">$args</span>{-<span class="w">sum</span>}<span class="sc">;</span>
    <span class="k">delete</span> <span class="i">$args</span>{-<span class="w">min</span>}<span class="sc">;</span>
    <span class="k">delete</span> <span class="i">$args</span>{-<span class="w">max</span>}<span class="sc">;</span>
    <span class="k">delete</span> <span class="i">$args</span>{-<span class="w">stddev</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$function</span> = <span class="q">&quot;get_&quot;</span> . <span class="i">$scope</span> . <span class="q">&quot;_data&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@field_list</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$values</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$count</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$values</span> = <span class="i">_convert_parameters</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'count'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$count</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$values</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">@field_list</span> = <span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@$values</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$avg</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$values</span> = <span class="i">_convert_parameters</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'avg'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$avg</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$values</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">@field_list</span> = <span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@$values</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$sum</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$values</span> = <span class="i">_convert_parameters</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'sum'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$sum</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$values</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">@field_list</span> = <span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@$values</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$min</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$values</span> = <span class="i">_convert_parameters</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'min'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$min</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$values</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">@field_list</span> = <span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@$values</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$max</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$values</span> = <span class="i">_convert_parameters</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'max'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$max</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$values</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">@field_list</span> = <span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@$values</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$stddev</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$values</span> = <span class="i">_convert_parameters</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'stddev'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$stddev</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$values</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">@field_list</span> = <span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="i">@$values</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$group_by</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@field_list</span> = <span class="s">(</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="k">split</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="i">$group_by</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$args</span>{-<span class="w">fields</span>} = \<span class="i">@field_list</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;$function</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">######################</span>
<a name="add_work_request-"></a><span class="k">sub </span><span class="m">add_work_request</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>              = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'library,goal'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$goal_target</span>       = <span class="i">$args</span>{-<span class="w">goal_target</span>}<span class="sc">;</span>                                    <span class="c"># the goal target</span>
    <span class="k">my</span> <span class="i">$comments</span>          = <span class="i">$args</span>{-<span class="w">comment</span>}<span class="sc">;</span>                                        <span class="c"># optional comments</span>
    <span class="k">my</span> <span class="i">$work_request_type</span> = <span class="i">$args</span>{-<span class="w">work_request_type</span>} || <span class="q">'Default Work Request'</span><span class="sc">;</span>    <span class="c"># optional</span>
    <span class="k">my</span> <span class="i">$funding</span>           = <span class="i">$args</span>{-<span class="w">funding</span>}<span class="sc">;</span>                                        <span class="c"># mandatory SOW for the work request</span>
    <span class="k">my</span> <span class="i">$library</span>           = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>                                        <span class="c"># mandatory library</span>
    <span class="k">my</span> <span class="i">$goal_target_type</span>  = <span class="i">$args</span>{-<span class="w">goal_target_type</span>} || <span class="q">'Original Request'</span><span class="sc">;</span>         <span class="c"># optional</span>
    <span class="k">my</span> <span class="i">$goal</span>              = <span class="i">$args</span>{-<span class="w">goal</span>}<span class="sc">;</span>                                           <span class="c"># type of goal</span>
    <span class="k">my</span> <span class="i">$scope</span>             = <span class="i">$args</span>{-<span class="w">scope</span>} || <span class="q">'Library'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$self</span><span class="sc">;</span>

    <span class="c">## find the goal in the available goals</span>
    <span class="k">require</span> <span class="w">alDente::Work_Request</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$work_request_obj</span> = <span class="w">alDente::Work_Request</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="q">'Work_Request'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$work_request_id</span> = <span class="i">$work_request_obj</span><span class="i">-&gt;add_work_request</span><span class="s">(</span>
        -<span class="w">goal_target</span>       <span class="cm">=&gt;</span> <span class="i">$goal_target</span><span class="cm">,</span>
        -<span class="w">comment</span>           <span class="cm">=&gt;</span> <span class="i">$comments</span><span class="cm">,</span>
        -<span class="w">work_request_type</span> <span class="cm">=&gt;</span> <span class="i">$work_request_type</span><span class="cm">,</span>
        -<span class="w">funding</span>           <span class="cm">=&gt;</span> <span class="i">$funding</span><span class="cm">,</span>
        -<span class="w">library</span>           <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span>
        -<span class="w">goal_target_type</span>  <span class="cm">=&gt;</span> <span class="i">$goal_target_type</span><span class="cm">,</span>
        -<span class="w">goal</span>              <span class="cm">=&gt;</span> <span class="i">$goal</span><span class="cm">,</span>
        -<span class="w">scope</span>             <span class="cm">=&gt;</span> <span class="i">$scope</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$work_request_id</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">###################</span>
<span class="c">#</span>
<span class="c"># Sets attribute on a given object and overwrites if there are existing attributes. Returns the number of updates/inserts</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#        %attributes = (</span>
<span class="c">#            5001 =&gt; 'test01',</span>
<span class="c">#            5002 =&gt; 'test02',</span>
<span class="c">#        );</span>
<span class="c">#</span>
<span class="c">#        $set = $self-&gt;set_attribute(-object=&gt;'Plate',-attribute=&gt;'Concentration',-list=&gt;\%attributes);</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">###################</span>
<a name="set_attribute-"></a><span class="k">sub </span><span class="m">set_attribute</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'object,attribute,list'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$object</span> = <span class="i">$args</span>{-<span class="w">object</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$att</span>    = <span class="i">$args</span>{-<span class="w">attribute</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">%list</span>   = <span class="i">%</span>{ <span class="i">$args</span>{-<span class="w">list</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>  = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span>  = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@tables</span> = <span class="i">$self</span><span class="i">-&gt;tables</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">grep</span><span class="s">(</span> <span class="q">/^$object$/</span><span class="cm">,</span> <span class="i">@tables</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;Error: Unknown object '$object'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">grep</span><span class="s">(</span> <span class="q">/^${object}_Attribute$/</span><span class="cm">,</span> <span class="i">@tables</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;Error: Can not store attributes for '$object'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$attrib_id</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Attribute'</span><span class="cm">,</span> <span class="q">'Attribute_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Attribute_Class='$object' AND Attribute_Name='$att'&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$attrib_id</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;Error: Unknown attribute '$att' for '$object'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$user_id</span>  = <span class="i">$self</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'user_id'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$datetime</span> = <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$primary_field</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;get_field_info</span><span class="s">(</span> <span class="i">$object</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="q">'Primary'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$fk_field</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;_get_FK_name</span><span class="s">(</span> <span class="q">&quot;${object}_Attribute&quot;</span><span class="cm">,</span> <span class="i">$object</span><span class="cm">,</span> <span class="i">$primary_field</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@fields</span> = <span class="s">(</span> <span class="i">$fk_field</span><span class="cm">,</span> <span class="q">'FK_Attribute__ID'</span><span class="cm">,</span> <span class="q">'Attribute_Value'</span><span class="cm">,</span> <span class="q">'FK_Employee__ID'</span><span class="cm">,</span> <span class="q">'Set_DateTime'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%values</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@keys</span> = <span class="k">map</span> <span class="s">{</span><span class="q">&quot;'$_'&quot;</span><span class="s">}</span> <span class="k">keys</span> <span class="i">%list</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@to_update_records</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;${object}_Attribute&quot;</span><span class="cm">,</span> <span class="i">$fk_field</span><span class="cm">,</span> <span class="q">&quot;WHERE $fk_field IN (&quot;</span> . <span class="k">join</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@keys</span> <span class="s">)</span> . <span class="q">&quot;) AND FK_Attribute__ID=$attrib_id&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$updates</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">@to_update_records</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$updates</span> += <span class="i">$self</span><span class="i">-&gt;set_data</span><span class="s">(</span>
            -<span class="w">table</span>        <span class="cm">=&gt;</span> <span class="q">&quot;${object}_Attribute&quot;</span><span class="cm">,</span>
            -<span class="w">fields</span>       <span class="cm">=&gt;</span> <span class="s">[</span><span class="q">'Attribute_Value'</span><span class="s">]</span><span class="cm">,</span>
            -<span class="w">values</span>       <span class="cm">=&gt;</span> <span class="s">[</span> <span class="i">$list</span>{<span class="i">$key</span>} <span class="s">]</span><span class="cm">,</span>
            -<span class="w">condition</span>    <span class="cm">=&gt;</span> <span class="q">&quot;WHERE $fk_field = '$key' AND FK_Attribute__ID=$attrib_id&quot;</span><span class="cm">,</span>
            -<span class="w">valid_fields</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="q">'Attribute_Value'</span><span class="s">]</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">delete</span> <span class="i">$list</span>{<span class="i">$key</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$count</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%list</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$values</span>{ ++<span class="i">$count</span> } = <span class="s">[</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$attrib_id</span><span class="cm">,</span> <span class="i">$list</span>{<span class="i">$key</span>}<span class="cm">,</span> <span class="i">$user_id</span><span class="cm">,</span> <span class="i">$datetime</span> <span class="s">]</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$newids</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">%values</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$newids</span> = <span class="i">$self</span><span class="i">-&gt;smart_append</span><span class="s">(</span> <span class="q">&quot;${object}_Attribute&quot;</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> \<span class="i">%values</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$updates</span> += <span class="k">int</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$newids</span>-&gt;{<span class="q">&quot;${object}_Attribute&quot;</span>}-&gt;{<span class="w">newids</span>} } <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$updates</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################</span>
<span class="c">#</span>
<span class="c"># Retrieves an already preset attribute and returns a key/value pairs of objects and their attribute value</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#   $API-&gt;get_attribute(-object=&gt;'Plate',-attribute=&gt;'Concentration',-keys=&gt;[500,501,503]);   ## get concentrations for all plates in given list {&lt;plate_id&gt; =&gt; &lt;concentration&gt;, ...}</span>
<span class="c">#</span>
<span class="c">#   $API-&gt;get_attribute(-object=&gt;'Plate',-attribute=&gt;'Concentration',-values[0.5]);   ## get ids for all plates with concentration of 0.5 {&lt;plate_id&gt; = &lt;concentration&gt;, ...}</span>
<span class="c">#</span>
<span class="c">#   $API-&gt;get_attribute(-object=&gt;'Plate',-keys=&gt;[500,501,503]);   ## get ALL attributes for given plate {&lt;attribute&gt; =&gt; &lt;value&gt;, ...}</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">###################</span>
<a name="get_attribute-"></a><span class="k">sub </span><span class="m">get_attribute</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'object,keys|values'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">### Limitation:</span>
    <span class="c">### Either 1 Attribute should be provided with multiple Keys (or values), or Multiple Attributes with 1 Key</span>

    <span class="k">my</span> <span class="i">$object</span> = <span class="i">$args</span>{-<span class="w">object</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$attrib</span> = <span class="i">$args</span>{-<span class="w">attribute</span>} || <span class="i">$args</span>{-<span class="w">attributes</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@att</span>    = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$attrib</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@keys</span>   = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{ -<span class="k">keys</span> }<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{ -<span class="k">values</span> }<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>  = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>  = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span>  = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@tables</span> = <span class="i">$self</span><span class="i">-&gt;tables</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">grep</span><span class="s">(</span> <span class="q">/^$object$/</span><span class="cm">,</span> <span class="i">@tables</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;Error: Unknown object '$object'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">grep</span><span class="s">(</span> <span class="q">/^${object}_Attribute$/</span><span class="cm">,</span> <span class="i">@tables</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;Error: Can not store attributes for '$object'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$primary_field</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;get_field_info</span><span class="s">(</span> <span class="i">$object</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="q">'Primary'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$fk_field</span><span class="s">)</span> = <span class="i">$self</span><span class="i">-&gt;_get_FK_name</span><span class="s">(</span> <span class="q">&quot;${object}_Attribute&quot;</span><span class="cm">,</span> <span class="i">$object</span><span class="cm">,</span> <span class="i">$primary_field</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%return</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields</span> = <span class="s">(</span> <span class="i">$fk_field</span><span class="cm">,</span> <span class="q">'Attribute_Value'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$condition</span> = <span class="q">&quot;FK_Attribute__ID=Attribute_ID&quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@att</span><span class="s">)</span> == <span class="n">1</span> &amp;&amp; <span class="k">int</span><span class="s">(</span><span class="i">@keys</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$condition</span> .= <span class="q">&quot; AND $fk_field IN ('&quot;</span> . <span class="k">join</span><span class="s">(</span> <span class="q">&quot;','&quot;</span><span class="cm">,</span> <span class="i">@keys</span> <span class="s">)</span> . <span class="q">&quot;')&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@keys</span><span class="s">)</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">@groups</span> = <span class="i">$self</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'group_list'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@att</span><span class="s">)</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## only one object indicated, so return all attributes if none specified ##</span>
            <span class="i">@att</span> = <span class="i">$self</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Attribute'</span><span class="cm">,</span> <span class="q">'Attribute_Name'</span><span class="cm">,</span> <span class="q">&quot;WHERE Attribute_Class='$object' AND FK_Grp__ID IN (&quot;</span> . <span class="k">join</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@groups</span> <span class="s">)</span> . <span class="q">&quot;)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$fields</span>[<span class="n">0</span>] = <span class="q">'Attribute_Name'</span><span class="sc">;</span>
        <span class="i">$condition</span> .= <span class="q">&quot; AND $fk_field = '$keys[0]'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@att</span><span class="s">)</span> == <span class="n">1</span> &amp;&amp; <span class="k">int</span><span class="s">(</span><span class="i">@values</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$condition</span> .= <span class="q">&quot; AND Attribute_Value IN ('&quot;</span> . <span class="k">join</span><span class="s">(</span> <span class="q">&quot;','&quot;</span><span class="cm">,</span> <span class="i">@values</span> <span class="s">)</span> . <span class="q">&quot;')&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;If requesting multiple ids or values, only one attribute at a time may be requested.&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$att_list</span> = <span class="k">join</span> <span class="q">&quot;','&quot;</span><span class="cm">,</span> <span class="i">@att</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%results</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">&quot;${object}_Attribute,Attribute&quot;</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> <span class="q">&quot;WHERE $condition AND Attribute_Name IN ('$att_list')&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">%results</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@return</span>{ <span class="i">@</span>{ <span class="i">$results</span>{ <span class="i">$fields</span>[<span class="n">0</span>] } } } = <span class="i">@</span>{ <span class="i">$results</span>{ <span class="i">$fields</span>[<span class="n">1</span>] } }<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%return</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">######################</span>
<span class="c">#</span>
<span class="c"># Get process deviation based on a process deviation number, retrieve a list of all the process deviation codes, or retrieve all objects affected by a process deviations</span>
<span class="c">#</span>
<span class="c"># Returns: hash of process deviation data</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#</span>
<span class="c">#  ## lists out all process deviations including fields 'Process_Deviation_Name','Process_Deviation_Description','Deviation_No'</span>
<span class="c">#  $API-&gt;get_process_deviation_data(-list=&gt;1);</span>
<span class="c">#  ## get informations given a list of process deviation numbers</span>
<span class="c">#  $API-&gt;get_process_deviation_data(-process_deviation=&gt;['PD.562','PD.563']);</span>
<span class="c">#  ## get informations given a list of process deviation numbers based on a set of objects you are interested in</span>
<span class="c">#  $API-&gt;get_process_deviation_data(-process_deviation=&gt;['PD.562','PD.563'],-object=&gt;['Library','Plate']);</span>
<span class="c">#  ## Get deviations for a given object</span>
<span class="c">#  $API-&gt;get_process_deviation_data(-object=&gt;'Library',-object_id=&gt;['A00001','A00002']);</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">################################</span>
<a name="get_process_deviation_data-"></a><span class="k">sub </span><span class="m">get_process_deviation_data</span> <span class="s">{</span>
<span class="c">################################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'list|process_deviation|object|object_id'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">### Limitation:</span>
    <span class="c">### Either 1 Attribute should be provided with multiple Keys (or values), or Multiple Attributes with 1 Key</span>

    <span class="k">my</span> <span class="i">$object</span>            = <span class="i">$args</span>{-<span class="w">object</span>}<span class="sc">;</span>               <span class="c">## list one or more objects ie Sample,Library,Plate,Source</span>
    <span class="k">my</span> <span class="i">$process_deviation</span> = <span class="i">$args</span>{-<span class="w">process_deviation</span>}<span class="sc">;</span>    <span class="c">## process deviation number(s)</span>
    <span class="k">my</span> <span class="i">$debug</span>             = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>             = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$object_id</span>         = <span class="i">$args</span>{-<span class="w">object_id</span>}<span class="sc">;</span>            <span class="c">## list of one or more object ID's, only works if only one object specified</span>
    <span class="k">my</span> <span class="i">$list</span>              = <span class="i">$args</span>{-<span class="w">list</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span>             = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@tables</span> = <span class="i">$self</span><span class="i">-&gt;tables</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%return</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$query_tables</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@query_fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$object_ids</span>         = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$object_id</span><span class="cm">,</span>         -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$process_deviations</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$process_deviation</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@object</span>             = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$object</span><span class="cm">,</span>            -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$condition</span>          = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$list</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$query_tables</span> = <span class="q">'Process_Deviation'</span><span class="sc">;</span>
        <span class="i">@query_fields</span> = <span class="s">(</span> <span class="q">'Process_Deviation_Name'</span><span class="cm">,</span> <span class="q">'Process_Deviation_Description'</span><span class="cm">,</span> <span class="q">'Deviation_No'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$condition</span>    = <span class="q">&quot;WHERE 1&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$process_deviation</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$object_cond</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">@object</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$object_str</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$object</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$object_cond</span> = <span class="q">&quot; AND Object_Class IN ($object_str) &quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">@query_fields</span> = <span class="s">(</span> <span class="q">'Process_Deviation_Name'</span><span class="cm">,</span> <span class="q">'Process_Deviation_Description'</span><span class="cm">,</span> <span class="q">'Deviation_No'</span><span class="cm">,</span> <span class="q">'Object_Class as Object'</span><span class="cm">,</span> <span class="q">'Object_ID as ID'</span><span class="cm">,</span> <span class="q">'Set_DateTime'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$query_tables</span> = <span class="q">'Process_Deviation,Process_Deviation_Object,Object_Class'</span><span class="sc">;</span>
        <span class="i">$condition</span>    = <span class="q">&quot;WHERE Process_Deviation_ID = Process_Deviation_Object.FK_Process_Deviation__ID and   </span>
                      <span class="q">                      Object_Class_ID = Process_Deviation_Object.FK_Object_Class__ID and </span>
                      <span class="q">                      Deviation_No IN ($process_deviations) $object_cond&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@object</span><span class="s">)</span> == <span class="n">1</span> &amp;&amp; <span class="i">$object_id</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$query_tables</span> = <span class="q">'Process_Deviation,Process_Deviation_Object,Object_Class'</span><span class="sc">;</span>
        <span class="i">@query_fields</span> = <span class="s">(</span> <span class="q">'Process_Deviation_Name'</span><span class="cm">,</span> <span class="q">'Process_Deviation_Description'</span><span class="cm">,</span> <span class="q">'Deviation_No'</span><span class="cm">,</span> <span class="q">'Object_Class as Object'</span><span class="cm">,</span> <span class="q">'Object_ID as ID'</span><span class="cm">,</span> <span class="q">'Set_DateTime'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$condition</span>    = <span class="q">&quot;WHERE Process_Deviation_ID = Process_Deviation_Object.FK_Process_Deviation__ID and   </span>
                      <span class="q">                      Object_Class_ID = Process_Deviation_Object.FK_Object_Class__ID </span>
                      <span class="q">                      AND Object_Class = '$object[0]' and Object_ID IN ($object_ids)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;If requesting multiple ids or values, only one object at a time may be requested.&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">%results</span> = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">&quot;$query_tables&quot;</span><span class="cm">,</span> \<span class="i">@query_fields</span><span class="cm">,</span> <span class="q">&quot;$condition&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%results</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###########################################################</span>
<span class="c"># This is an accessor used to update data in the database.</span>
<span class="c">#</span>
<span class="c"># It should NEVER be called directly but used to repidly create application specific functionality</span>
<span class="c">#</span>
<span class="c"># External wrappers should be written to supply the mandatory fields:</span>
<span class="c"># -tables =&gt; list of tables updated within the SQL update command</span>
<span class="c"># -join_condition =&gt; join condition for tables above</span>
<span class="c"># -fields =&gt; fields to set</span>
<span class="c"># -values =&gt; values for each of fields above</span>
<span class="c"># -valid_fields =&gt; mandatory list of fields available for updating.  (this is how we control what is being updated)</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Example of usage (application specific wrapper):</span>
<span class="c">#</span>
<span class="c">#	sub set_run_data() {</span>
<span class="c">#		my $self = shift;</span>
<span class="c">#		my %args = &amp;filter_input(\@_,-mandatory=&gt;'fields,values,run_id|flowcell');</span>
<span class="c">#       my $table  = $args{-table} ||</span>
<span class="c"># ;     ## eg SolexaRun or Solexa_Read</span>
<span class="c">#		my $fields = $args{-fields};	## list of fields to update (using defined aliases)</span>
<span class="c">#		my $values = $args{-values};	## associated list of values</span>
<span class="c">#		my $run_id = $args{-run_id};	   ## specify update based upon run_id</span>
<span class="c">#		my $flowcell = $args{-flowcell};   ## specify update based upon flowcell</span>
<span class="c">#		my $condition = $args{-condition} || 1;</span>

<span class="c">#	### Generate condition based upon input parameters ###</span>
<span class="c">#</span>
<span class="c">#       ## pass all parameters to allow use of filtering options to retrieve list of run_ids</span>
<span class="c">#       $args{-fields} = 'run_id';</span>
<span class="c">#       my %run_data = %{ $self-&gt;get_run_data(%args) };</span>
<span class="c">#       my @run_ids  = @{%run_data-&gt;{Run_ID}}</span>
<span class="c">#</span>
<span class="c">#       my $run_list = Cast_List(-list=&gt;\@run_ids,-to=&gt;'string');</span>

<span class="c">#		my @valid_fields = qw(solexa_qmean, solexa_cycles);</span>

<span class="c">#		if ($run_list) {</span>
<span class="c">#			push @conditions, &quot;FK_Run__ID IN ($run_list)&quot;;</span>
<span class="c">#		}</span>
<span class="c">#       else {</span>
<span class="c">#           Message(&quot;No runs found&quot;);</span>
<span class="c">#           return;</span>
<span class="c">#       }</span>
<span class="c">#</span>
<span class="c">#		my $updated = $self-&gt;set_data(</span>
<span class="c">#			-table=&gt;$table,</span>
<span class="c">#			-fields=&gt;$fields,</span>
<span class="c">#			-values=&gt;$values,</span>
<span class="c">#			-condition=&gt;$condition,</span>
<span class="c">#			-valid_fields=&gt;\@valid_fields</span>
<span class="c">#		);</span>
<span class="c">#</span>
<span class="c">#		Message(&quot;update $updated records&quot;);</span>
<span class="c">#		return $updated;</span>
<span class="c">#	}</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Return: number of updated records</span>
<span class="c">######################################</span>
<a name="set_data-"></a><span class="k">sub </span><span class="m">set_data</span> <span class="s">{</span>
<span class="c">######################################</span>
    <span class="k">my</span> <span class="i">$self</span>         = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>         = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'fields,values,table,condition,valid_fields'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fields</span>       = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>                                                                     <span class="c">## list of fields to update</span>
    <span class="k">my</span> <span class="i">$values</span>       = <span class="i">$args</span>{ -<span class="k">values</span> }<span class="sc">;</span>                                                                   <span class="c">## list of values to update</span>
    <span class="k">my</span> <span class="i">$table</span>        = <span class="i">$args</span>{-<span class="w">table</span>}<span class="sc">;</span>                                                                      <span class="c">## list of tables to update (all tables in SQL update command)</span>
    <span class="k">my</span> <span class="i">$condition</span>    = <span class="i">$args</span>{-<span class="w">condition</span>}<span class="sc">;</span>                                                                  <span class="c">## condition</span>
    <span class="k">my</span> <span class="i">$valid_fields</span> = <span class="i">$args</span>{-<span class="w">valid_fields</span>}<span class="sc">;</span>                                                               <span class="c">## list of valid field aliases to update</span>
    <span class="k">my</span> <span class="i">$quiet</span>        = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>        = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$comment</span>      = <span class="i">$args</span>{-<span class="w">comment</span>}<span class="sc">;</span>

    <span class="c">## allow use of aliases if supplied in field list ##</span>
    <span class="k">map</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$field</span> = <span class="i">$_</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$tab</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$table</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$Aliases</span>{<span class="i">$tab</span>}{<span class="i">$field</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$field</span> = <span class="i">$Aliases</span>{<span class="i">$tab</span>}{<span class="i">$field</span>}<span class="sc">;</span> <span class="k">last</span><span class="sc">;</span> <span class="s">}</span>
        <span class="s">}</span>
        <span class="i">$_</span> = <span class="i">$field</span><span class="sc">;</span>
    <span class="s">}</span> <span class="i">@$fields</span><span class="sc">;</span>
    <span class="c">## validate list of fields (ensure fields to update are all in list of valid fields) ##</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$intersection</span><span class="cm">,</span> <span class="i">$invalid</span> <span class="s">)</span> = <span class="i">RGmath::intersection</span><span class="s">(</span> <span class="i">$fields</span><span class="cm">,</span> <span class="i">$valid_fields</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$invalid</span> &amp;&amp; <span class="i">@$invalid</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Specified fields not in valid field list (@$invalid)&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">## cast list of fields and values into SQL format ##</span>
    <span class="k">my</span> <span class="i">@field_list</span> = <span class="i">@$fields</span><span class="sc">;</span>    <span class="c">#  Cast_List(-list=&gt;$fields,-to=&gt;'array');</span>
    <span class="k">my</span> <span class="i">@value_list</span> = <span class="i">@$values</span><span class="sc">;</span>    <span class="c"># Cast_List(-list=&gt;$values,-to=&gt;'array');;</span>

    <span class="k">unless</span> <span class="s">(</span> <span class="i">$table</span> &amp;&amp; <span class="i">$condition</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Table and condition must be supplied&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> \<span class="i">@field_list</span><span class="cm">,</span> \<span class="i">@value_list</span><span class="cm">,</span> <span class="i">$condition</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span> -<span class="w">comment</span> <span class="cm">=&gt;</span> <span class="i">$comment</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#########################</span>
<span class="c">#</span>
<span class="c">#   Set No Grows &amp; Slow Grows for a given Library Plate.</span>
<span class="c">#</span>
<span class="c">#   &lt;snip&gt;</span>
<span class="c">#       $API-&gt;set_plate_growth(</span>
<span class="c">#            -plate_id  =&gt; $plate_id,</span>
<span class="c">#            -no_grows  =&gt; \@no_grow_well_list,</span>
<span class="c">#            -slow_grows=&gt; \@slow_grow_well_list</span>
<span class="c">#            );</span>
<span class="c">#   &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="set_plate_growth-"></a><span class="k">sub </span><span class="m">set_plate_growth</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'plate_id,no_grows,slow_grows'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'plate_id'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plate_id</span>   = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@no_grows</span>   = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">no_grows</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@slow_grows</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">slow_grows</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">require</span> <span class="w">alDente::Library_Plate</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%existing</span>           = <span class="i">$self</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Library_Plate'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'No_Grows'</span><span class="cm">,</span> <span class="q">'Slow_Grows'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID=$plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@existing_no_grow</span>   = <span class="i">@</span>{ <span class="i">$existing</span>{<span class="q">'No_Grows'</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@existing_slow_grow</span> = <span class="i">@</span>{ <span class="i">$existing</span>{<span class="q">'Slow_Grows'</span>} }<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">@no_grows</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">&amp;alDente::Library_Plate::set_Wells</span><span class="s">(</span> -<span class="w">plate_ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">select_type</span> <span class="cm">=&gt;</span> <span class="q">'No Grow'</span><span class="cm">,</span> -<span class="w">well_list</span> <span class="cm">=&gt;</span> \<span class="i">@no_grows</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">@slow_grows</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">&amp;alDente::Library_Plate::set_Wells</span><span class="s">(</span> -<span class="w">plate_ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">select_type</span> <span class="cm">=&gt;</span> <span class="q">'Slow Grow'</span><span class="cm">,</span> -<span class="w">well_list</span> <span class="cm">=&gt;</span> \<span class="i">@slow_grows</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Allow updating of the well map for a rearray</span>
<span class="c">#</span>
<span class="c"># Example:</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#     my $num_wells_updated = $API-&gt;update_rearray_well_map(-rearray_request=&gt;12345,</span>
<span class="c">#                                                           -target_plate=&gt;117,</span>
<span class="c">#                                                           -target_wells=&gt;['A02','A01'],</span>
<span class="c">#                                                           -source_wells=&gt;['A01','A03'],</span>
<span class="c">#                                                           -source_plates=&gt;[5000,5001]);</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Returns: Number of wells updated</span>
<span class="c">#############################</span>
<a name="update_rearray_well_map-"></a><span class="k">sub </span><span class="m">update_rearray_well_map</span> <span class="s">{</span>
<span class="c">#############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">&quot;rearray_request,target_plate,target_wells,source_wells,source_plates&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">require</span> <span class="w">alDente::ReArray1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rearray_obj</span> = <span class="w">alDente::ReArray1</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$num_wells_updated</span> = <span class="i">$rearray_obj</span><span class="i">-&gt;update_rearray_well_map</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> <span class="i">$num_wells_updated</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">#################################</span>
<a name="add_custom_aliases-"></a><span class="k">sub </span><span class="m">add_custom_aliases</span> <span class="s">{</span>
<span class="c">#################################</span>
    <span class="k">my</span> <span class="i">$self</span>           = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>           = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$custom_aliases</span> = <span class="i">$args</span>{-<span class="w">custom_aliases</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">%custom_aliases</span><span class="sc">;</span>
    <span class="i">%custom_aliases</span> = <span class="i">%$custom_aliases</span> <span class="k">if</span> <span class="i">$custom_aliases</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@table_keys</span> = <span class="k">keys</span> <span class="i">%custom_aliases</span><span class="sc">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span><span class="i">@table_keys</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@field_keys</span> = <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$custom_aliases</span>{<span class="i">$table</span>} }<span class="sc">;</span>
        <span class="k">for</span> <span class="k">my</span> <span class="i">$field</span> <span class="s">(</span><span class="i">@field_keys</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$Aliases</span>{<span class="i">$table</span>}{<span class="i">$field</span>} = <span class="i">$custom_aliases</span>{<span class="i">$table</span>}{<span class="i">$field</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##########################################################</span>
<span class="c">#  This Method merges two arrays of hashes based on a field</span>
<span class="c">#   The original hash gets additional info from the &quot;additional&quot; input</span>
<span class="c">#   the relation is n-1 not n-0</span>
<span class="c">#   if there are any problems with input it will return null and send apporpriate message</span>
<span class="c"># input:</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># output:</span>
<span class="c">#	a reference to an array of hash exact same format as input</span>
<span class="c">#</span>
<span class="c"># example:</span>
<span class="c">#	    my $lib_data = $API -&gt; get_library_data(-library =&gt; 'AS001,AS002,HB001',-format=&gt;'array');</span>
<span class="c">#       my $run_data = $API -&gt; get_run_data(-library =&gt; 'AS002,HB001',-format=&gt;'array');</span>
<span class="c">#</span>
<span class="c">#        my $mix_dat =  $API -&gt; merge_Data_on_Field (-original=&gt;$run_data,-additional=&gt;$lib_data,-field=&gt;'library');</span>
<span class="c">#</span>
<span class="c">############################</span>
<a name="merge_Data_on_Field-"></a><span class="k">sub </span><span class="m">merge_Data_on_Field</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span>           = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>           = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'original,additional,field'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_ref</span>   = <span class="i">$args</span>{-<span class="w">original</span>}<span class="sc">;</span>                                                  <span class="c"># The original array where the additional info will be added (reference to  Array of Hash)</span>
    <span class="k">my</span> <span class="i">$additional_ref</span> = <span class="i">$args</span>{-<span class="w">additional</span>}<span class="sc">;</span>                                                <span class="c"># The array containing additional info (reference to  Array of Hash)</span>
    <span class="k">my</span> <span class="i">$field</span>          = <span class="i">$args</span>{-<span class="w">field</span>}<span class="sc">;</span>                                                     <span class="c"># The field which the two array will be matched on</span>
    <span class="k">my</span> <span class="i">@original</span><span class="sc">;</span>
    <span class="i">@original</span> = <span class="i">@$original_ref</span> <span class="k">if</span> <span class="i">$original_ref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@additional</span><span class="sc">;</span>
    <span class="i">@additional</span> = <span class="i">@$additional_ref</span> <span class="k">if</span> <span class="i">$additional_ref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@results</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$additional</span>[<span class="n">0</span>]{<span class="i">$field</span>} &amp;&amp; <span class="i">$original</span>[<span class="n">0</span>]{<span class="i">$field</span>} <span class="s">)</span> <span class="s">{</span>

        <span class="k">for</span> <span class="k">my</span> <span class="i">$orig_hash_ref</span> <span class="s">(</span><span class="i">@original</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">%original_hash</span> = <span class="i">%$orig_hash_ref</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">%results</span>       = <span class="i">%original_hash</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$counter</span><span class="sc">;</span>

            <span class="k">for</span> <span class="k">my</span> <span class="i">$add_hash_ref</span> <span class="s">(</span><span class="i">@additional</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">%additional_hash</span> = <span class="i">%$add_hash_ref</span><span class="sc">;</span>

                <span class="k">if</span> <span class="s">(</span> <span class="i">$additional_hash</span>{<span class="i">$field</span>} <span class="k">eq</span> <span class="i">$original_hash</span>{<span class="i">$field</span>} <span class="s">)</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="i">@keys</span> = <span class="k">keys</span> <span class="i">%additional_hash</span><span class="sc">;</span>

                    <span class="k">for</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="i">@keys</span><span class="s">)</span> <span class="s">{</span>
                        <span class="k">if</span> <span class="s">(</span> !<span class="i">$original_hash</span>{<span class="i">$key</span>} || <span class="i">$original_hash</span>{<span class="i">$key</span>} <span class="k">eq</span> <span class="i">$additional_hash</span>{<span class="i">$key</span>} <span class="s">)</span> <span class="s">{</span>
                            <span class="i">$results</span>{<span class="i">$key</span>} = <span class="i">$additional_hash</span>{<span class="i">$key</span>}<span class="sc">;</span>
                        <span class="s">}</span>
                        <span class="k">else</span> <span class="s">{</span>
                            <span class="w">Message</span> <span class="q">&quot;the two hases contain conflicting information&quot;</span><span class="sc">;</span>
                            <span class="k">return</span><span class="sc">;</span>
                        <span class="s">}</span>
                    <span class="s">}</span>
                    <span class="i">$counter</span>++<span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="k">next</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$counter</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">push</span> <span class="i">@results</span><span class="cm">,</span> \<span class="i">%results</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="w">Message</span> <span class="q">&quot;more than one match for the key field&quot;</span><span class="sc">;</span>
                    <span class="k">return</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="w">Message</span> <span class="q">&quot;Key field ($field) missing&quot;</span> <span class="s">}</span>
    <span class="k">return</span> \<span class="i">@results</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<a name="get_Atomic_data-"></a><span class="k">sub </span><span class="m">get_Atomic_data</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;get_lane_data</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################################</span>
<a name="_convert_parameters-"></a><span class="k">sub </span><span class="m">_convert_parameters</span> <span class="s">{</span>
<span class="c">#################################</span>
    <span class="k">my</span> <span class="i">%args</span>   = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$name</span>   = <span class="i">$args</span>{-<span class="w">name</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$values</span> = <span class="i">$args</span>{-<span class="w">value</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@array</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$name</span> &amp;&amp; <span class="i">$values</span> &amp;&amp; <span class="k">ref</span> <span class="i">$values</span> <span class="k">eq</span> <span class="q">'ARRAY'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$value</span> <span class="s">(</span><span class="i">@$values</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$value</span> =~ <span class="q">/^\w+$/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$item</span> = <span class="i">$name</span> . <span class="q">&quot;(&quot;</span> . <span class="i">$value</span> . <span class="q">&quot;) as &quot;</span> . <span class="i">$value</span> . <span class="q">&quot;_&quot;</span> . <span class="i">$name</span><span class="sc">;</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@array</span><span class="cm">,</span> <span class="i">$item</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> \<span class="i">@array</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<span class="c">#</span>
<span class="c"># Convert string of values and/or aliases based upon the supplied domain (list of tables used)</span>
<span class="c"># eg. given:</span>
<span class="c">#</span>
<span class="c">#  $domain = &quot;Library,Plate,Sample&quot;;</span>
<span class="c">#  $Aliases{Library}{library} = 'Library.Library_Name'</span>
<span class="c">#</span>
<span class="c">#  _convert_Aliases converts condition:</span>
<span class="c">#         WHERE library = 'AS001'  -&gt;  WHERE Library.Library_Name = 'AS001'</span>
<span class="c">#</span>
<span class="c"># Return: replaces alias with their value everywhere in supplied string, array</span>
<span class="c">##################</span>
<a name="_convert_Aliases-"></a><span class="k">sub </span><span class="m">_convert_Aliases</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">%args</span>         = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$domain</span>       = <span class="i">$args</span>{-<span class="w">domain</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$array</span>        = <span class="i">$args</span>{-<span class="w">array</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$string_ref</span>   = <span class="i">$args</span>{-<span class="w">string</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$alias_fields</span> = <span class="i">$args</span>{-<span class="w">alias_fields</span>}<span class="sc">;</span>    <span class="c">##  Boolean - change 'key' -&gt; 'key as alias'</span>
    <span class="k">my</span> <span class="i">$replace</span>      = <span class="i">$args</span>{-<span class="w">replace</span>}<span class="sc">;</span>         <span class="c">##  Boolean - change 'key' -&gt; 'alias'</span>

    <span class="k">my</span> <span class="i">$string</span> = <span class="i">$$string_ref</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$domain</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Aliases</span>{<span class="i">$table</span>} <span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;No $table aliases defined&quot;</span><span class="sc">;</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>
        <span class="k">my</span> <span class="i">@keys</span> = <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$Aliases</span>{<span class="i">$table</span>} }<span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$alias</span> <span class="s">(</span><span class="i">@keys</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$value</span> = <span class="i">$Aliases</span>{<span class="i">$table</span>}{<span class="i">$alias</span>}<span class="sc">;</span>
            <span class="c">## handling strings</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$string</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">$string</span> =~ <span class="q">s/\b$alias\b/$value/g</span><span class="sc">;</span>    <span class="c">## substitute aliases in condition</span>
            <span class="s">}</span>
            <span class="c">## handling arrays ##</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$array</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">foreach</span> <span class="k">my</span> <span class="i">$element</span> <span class="s">(</span><span class="i">@$array</span><span class="s">)</span> <span class="s">{</span>
                    <span class="i">$element</span> =~ <span class="q">s/^$alias$/$value AS $alias/</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#######################</span>
<a name="_insert_quotes-"></a><span class="k">sub </span><span class="m">_insert_quotes</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">%args</span>   = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$string</span> = <span class="i">$args</span>{-<span class="w">string</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quotes</span> = <span class="i">$args</span>{-<span class="w">quotes</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@quotes</span> = <span class="i">@$quotes</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quote</span>  = <span class="k">shift</span> <span class="i">@quotes</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="i">$string</span> =~ <span class="q">s/~/&quot;$quote&quot;/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$quote</span> = <span class="k">shift</span> <span class="i">@quotes</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$string</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#######################</span>
<a name="_remove_quotes-"></a><span class="k">sub </span><span class="m">_remove_quotes</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$str</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@quotes</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="i">$str</span> =~ <span class="q">s/&quot;(.*?)&quot;/~/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@quotes</span><span class="cm">,</span> <span class="i">$1</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$str</span><span class="cm">,</span> \<span class="i">@quotes</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################################</span>
<span class="c"># Retrieve the ancestry tree and the original starting sources for the given sources</span>
<span class="c">#</span>
<span class="c"># Usage:</span>
<span class="c">#     my %result = %{$API-&gt;get_source_lineage(-source_id=&gt;$source_id)};					# retrieve ancestry tree including pooled parents</span>
<span class="c">#     my %result = %{$API-&gt;get_source_lineage(-source_id=&gt;$source_id, -no_pools =&gt; 1)};	# retrieve ancestry tree excluding pooled parents</span>
<span class="c">#</span>
<span class="c"># Return : hash of info</span>
<span class="c"># Return:	Hash.</span>
<span class="c">#			$result{original} is the array ref of the original starting source ids;</span>
<span class="c">#			$result{tree} is the hash ref of the ancestry tree, with the input source as the root and its original starting sources as the leaves.</span>
<span class="c">#</span>
<span class="c">#           An example:</span>
<span class="c">#        	my ($originals, $parents) = $self-&gt;get_ancestry_tree( -id =&gt; '60513', -no_pools =&gt; 0 );</span>
<span class="c">#        	Dump of $original:</span>
<span class="c">#			['60234','60210','60202','60214','60208','60232','60206','60204','60236','60212'];</span>
<span class="c">#        	Dump of $parents:</span>
<span class="c">#			{</span>
<span class="c">#          	'60513' =&gt; {</span>
<span class="c">#                       '60512' =&gt; {</span>
<span class="c">#                                    '60498' =&gt; {</span>
<span class="c">#                                                 '60436' =&gt; {</span>
<span class="c">#                                                              '60210' =&gt; 0,</span>
<span class="c">#                                                              '60202' =&gt; 0,</span>
<span class="c">#                                                              '60214' =&gt; 0,</span>
<span class="c">#                                                              '60208' =&gt; 0,</span>
<span class="c">#                                                              '60206' =&gt; 0,</span>
<span class="c">#                                                              '60204' =&gt; 0,</span>
<span class="c">#                                                              '60212' =&gt; 0</span>
<span class="c">#                                                            },</span>
<span class="c">#                                                 '60442' =&gt; {</span>
<span class="c">#                                                              '60234' =&gt; 0,</span>
<span class="c">#                                                              '60232' =&gt; 0,</span>
<span class="c">#                                                              '60236' =&gt; 0</span>
<span class="c">#                                                            }</span>
<span class="c">#                                               }</span>
<span class="c">#                                  }</span>
<span class="c">#                     }</span>
<span class="c">#        	};</span>
<span class="c">############################</span>
<a name="get_source_lineage-"></a><span class="k">sub </span><span class="m">get_source_lineage</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;log_parameters</span><span class="s">(</span><span class="i">@_</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'source_id,no_pools,'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$source_id</span> = <span class="i">$args</span>{-<span class="w">source_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$no_pools</span>  = <span class="i">$args</span>{-<span class="w">no_pools</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>     = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$start</span> = <span class="i">timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$Source</span> = <span class="i">new</span> <span class="i">alDente::Source</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$originals</span><span class="cm">,</span> <span class="i">$tree</span> <span class="s">)</span> = <span class="i">$Source</span><span class="i">-&gt;get_ancestry_tree</span><span class="s">(</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$source_id</span><span class="cm">,</span> -<span class="w">no_pools</span> <span class="cm">=&gt;</span> <span class="i">$no_pools</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%output_data</span><span class="sc">;</span>
    <span class="i">$output_data</span>{<span class="w">original</span>} = <span class="i">$originals</span><span class="sc">;</span>
    <span class="i">$output_data</span>{<span class="w">tree</span>}     = <span class="i">$tree</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;api_output</span><span class="s">(</span> -<span class="w">data</span> <span class="cm">=&gt;</span> \<span class="i">%output_data</span><span class="cm">,</span> -<span class="w">start</span> <span class="cm">=&gt;</span> <span class="i">$start</span><span class="cm">,</span> -<span class="w">log</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">customized_output</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>
<span class="k">return</span> <span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
