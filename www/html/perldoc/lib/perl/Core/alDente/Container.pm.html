<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Container.pm</title>
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Container.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name__uplink_">NAME &lt;UPLINK&gt;</a></li>
	<li><a href="#synopsis__uplink_">SYNOPSIS &lt;UPLINK&gt;</a></li>
	<li><a href="#description__uplink_">DESCRIPTION &lt;UPLINK&gt;</a></li>
	<li><a href="#known_issues__uplink_">KNOWN ISSUES &lt;UPLINK&gt;</a></li>
	<li><a href="#future_improvements__uplink_">FUTURE IMPROVEMENTS &lt;UPLINK&gt;</a></li>
	<li><a href="#authors__uplink_">AUTHORS &lt;UPLINK&gt;</a></li>
	<li><a href="#created__uplink_">CREATED &lt;UPLINK&gt;</a></li>
	<li><a href="#revision__uplink_">REVISION &lt;UPLINK&gt;</a></li>
</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-alDente::Container-">package alDente::Container</a>
<ul>
<li><a href="#new-">new</a></li>
<li><a href="#plate_QC_trigger-">plate_QC_trigger</a></li>
<li><a href="#reset_current_plates-">reset_current_plates</a></li>
<li><a href="#add_to_current_plates-">add_to_current_plates</a></li>
<li><a href="#prefix-">prefix</a></li>
<li><a href="#batch_Aliquot-">batch_Aliquot</a></li>
<li><a href="#Aliquot_Container-">Aliquot_Container</a></li>
<li><a href="#new_container_trigger-">new_container_trigger</a></li>
<li><a href="#new_container_batch_trigger-">new_container_batch_trigger</a></li>
<li><a href="#plate_filter-">plate_filter</a></li>
<li><a href="#parse_plate_filter-">parse_plate_filter</a></li>
<li><a href="#prompt_for_content_details-">prompt_for_content_details</a></li>
<li><a href="#load_Object-">load_Object</a></li>
<li><a href="#home_page-">home_page</a></li>
<li><a href="#Display_Input-">Display_Input</a></li>
<li><a href="#_init_table-">_init_table</a></li>
<li><a href="#get_plate_schedule_code-">get_plate_schedule_code</a></li>
<li><a href="#get_prev_gen-">get_prev_gen</a></li>
<li><a href="#get_next_gen-">get_next_gen</a></li>
<li><a href="#plate_icon-">plate_icon</a></li>
<li><a href="#inherit_attributes-">inherit_attributes</a></li>
<li><a href="#inherit_funding-">inherit_funding</a></li>
<li><a href="#batch_inherit_attributes-">batch_inherit_attributes</a></li>
<li><a href="#update_plate_info-">update_plate_info</a></li>
<li><a href="#update_Plate_volumes-">update_Plate_volumes</a></li>
<li><a href="#set_work_request_btn-">set_work_request_btn</a></li>
<li><a href="#empty_Plate_volumes-">empty_Plate_volumes</a></li>
<li><a href="#get_source-">get_source</a></li>
<li><a href="#obsolete_add_Record-">obsolete_add_Record</a></li>
<li><a href="#link_source_details-">link_source_details</a></li>
<li><a href="#get_Solutions-">get_Solutions</a></li>
<li><a href="#get_Applications-">get_Applications</a></li>
<li><a href="#get_Preps-">get_Preps</a></li>
<li><a href="#get_Sample-">get_Sample</a></li>
<li><a href="#get_original_locations-">get_original_locations</a></li>
<li><a href="#get_protocol_history-">get_protocol_history</a></li>
<li><a href="#inherit_Parent_fields-">inherit_Parent_fields</a></li>
<li><a href="#save_Container-">save_Container</a></li>
<li><a href="#validate_pool-">validate_pool</a></li>
<li><a href="#pool_tray-">pool_tray</a></li>
<li><a href="#get_recent_prepped_ids-">get_recent_prepped_ids</a></li>
<li><a href="#get_recent_ids-">get_recent_ids</a></li>
<li><a href="#get_Prep_mates-">get_Prep_mates</a></li>
<li><a href="#get_Sets-">get_Sets</a></li>
<li><a href="#get_Parents-">get_Parents</a></li>
<li><a href="#get_Siblings-">get_Siblings</a></li>
<li><a href="#get_Children-">get_Children</a></li>
<li><a href="#get_Notes-">get_Notes</a></li>
<li><a href="#get_Reagents-">get_Reagents</a></li>
<li><a href="#withdraw_sample-">withdraw_sample</a></li>
<li><a href="#get_remaining_quantity-">get_remaining_quantity</a></li>
<li><a href="#get_Plate_notes-">get_Plate_notes</a></li>
<li><a href="#Plate_Attribute_trigger-">Plate_Attribute_trigger</a></li>
<li><a href="#Delete_Container-">Delete_Container</a></li>
<li><a href="#_delete-">_delete</a></li>
<li><a href="#add_Note-">add_Note</a></li>
<li><a href="#fail_container-">fail_container</a></li>
<li><a href="#set_pipeline_btn-">set_pipeline_btn</a></li>
<li><a href="#catch_pipeline_btn-">catch_pipeline_btn</a></li>
<li><a href="#set_pipeline-">set_pipeline</a></li>
<li><a href="#save_plate_set_btn-">save_plate_set_btn</a></li>
<li><a href="#confirm_fail-">confirm_fail</a></li>
<li><a href="#move-">move</a></li>
<li><a href="#onhold_plate_btn-">onhold_plate_btn</a></li>
<li><a href="#catch_onhold_plate_btn-">catch_onhold_plate_btn</a></li>
<li><a href="#set_plate_status-">set_plate_status</a></li>
<li><a href="#plate_archive_btn-">plate_archive_btn</a></li>
<li><a href="#catch_plate_archive_btn-">catch_plate_archive_btn</a></li>
<li><a href="#set_plate_archive_status-">set_plate_archive_status</a></li>
<li><a href="#get_plate_status_list-">get_plate_status_list</a></li>
<li><a href="#home-">home</a></li>
<li><a href="#throw_away-">throw_away</a></li>
<li><a href="#export_Plate-">export_Plate</a></li>
<li><a href="#activate_Plate-">activate_Plate</a></li>
<li><a href="#thaw_Plate-">thaw_Plate</a></li>
<li><a href="#Check_Library_Plates-">Check_Library_Plates</a></li>
<li><a href="#store-">store</a></li>
<li><a href="#get_plate_name-">get_plate_name</a></li>
<li><a href="#clear_plate_set-">clear_plate_set</a></li>
<li><a href="#get_birth_protocol-">get_birth_protocol</a></li>
<li><a href="#label-">label</a></li>
<li><a href="#add_Plate-">add_Plate</a></li>
<li><a href="#define_Plate_as_Source-">define_Plate_as_Source</a></li>
<li><a href="#_get_parent_sample-">_get_parent_sample</a></li>
<li><a href="#SB_trigger-">SB_trigger</a></li>
<li><a href="#manually_generate_Plate_records-">manually_generate_Plate_records</a></li>
<li><a href="#_update_rna_plate-">_update_rna_plate</a></li>
<li><a href="#_update_seq_plate-">_update_seq_plate</a></li>
<li><a href="#_update_tube-">_update_tube</a></li>
<li><a href="#_home_barcode-">_home_barcode</a></li>
<li><a href="#_update_clone_source-">_update_clone_source</a></li>
<li><a href="#map_tray_to_plates-">map_tray_to_plates</a></li>
<li><a href="#get_sample_id-">get_sample_id</a></li>
<li><a href="#set_plate_info_btn-">set_plate_info_btn</a></li>
<li><a href="#merge_libs-">merge_libs</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<pre>#!/usr/local/bin/perl
<span class="c">################################################################################</span>
<span class="c"># Container.pm</span>
<span class="c">#</span>
<span class="c"># This module handles Container (Plate) based functions</span>
<span class="c">#</span>
<span class="c">###############################################################################</span>
<a name="package-alDente::Container-"></a><span class="k">package </span><span class="i">alDente::Container</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># perldoc_header             #</span>
<span class="c">##############################</span>

</pre><p></p>
<hr />
<h1><a name="name__uplink_">NAME &lt;UPLINK&gt;</a></h1>
<p>Container.pm - This module handles Container (Plate) based functions</p>
<p>
</p>
<hr />
<h1><a name="synopsis__uplink_">SYNOPSIS &lt;UPLINK&gt;</a></h1>
<pre>
        &lt;&lt;SYNOPSIS&gt;&gt;</pre>
<p>
</p>
<hr />
<h1><a name="description__uplink_">DESCRIPTION &lt;UPLINK&gt;</a></h1>
This module handles Container (Plate) based functions<BR><pre>
<span class="c">##############################</span>
<span class="c"># superclasses               #</span>
<span class="c">##############################</span>

<span class="i">@ISA</span> = <span class="q">qw(SDB::DB_Object)</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># system_variables           #</span>
<span class="c">##############################</span>
<span class="k">require</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="i">@EXPORT_OK</span> = <span class="q">qw(get_Children get_Parents Check_Library_Plates)</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="c">##############################</span>
<span class="c"># standard_modules_ref       #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="i">CGI::Carp</span><span class="s">(</span><span class="q">'fatalsToBrowser'</span><span class="s">)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">CGI</span> <span class="q">qw(:standard)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">URI::Escape</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::Barcode</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Benchmark</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># custom_modules_ref         #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="w">alDente::Library</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Barcoding</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Form</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::SDB_Defaults</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Solution</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Plate_Prep</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Protocol</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Prep</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Container_Set</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Tools</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Rack</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Rack_Views</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">alDente::Prep</span><span class="sc">;</span>    <span class="c">## cleans up looping usage calls</span>

<span class="c">#use alDente::Protocol;</span>
<span class="k">use</span> <span class="w">alDente::Fail</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Validation</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::DB_Object</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::Session</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::DBIO</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::CustomSettings</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::DB_Form_Viewer</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::HTML</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">RGTools::RGIO</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::Views</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">RGTools::Conversion</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># global_vars                #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw($current_plates $plate_set $plate_id $Sess)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@plate_formats @plate_info @plate_sizes @libraries $user_id $Connection %Std_Parameters $image_dir @protocols)</span><span class="sc">;</span>

<span class="c">#use vars qw(%Plate_Contents);</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(%Benchmark %Prefix)</span><span class="sc">;</span>
<span class="c">##############################</span>
<span class="c"># modular_vars               #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># constants                  #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># main_header                #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># constructor                #</span>
<span class="c">##############################</span>

<span class="k">my</span> <span class="i">$prefix</span> = <span class="i">$Prefix</span>{<span class="w">Plate</span>}<span class="sc">;</span>

<span class="c">############</span>
<a name="new-"></a><span class="k">sub </span><span class="m">new</span> <span class="s">{</span>
<span class="c">############</span>
    <span class="c"># Constructor</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$this</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$id</span>         = <span class="i">$args</span>{-<span class="w">id</span>} || <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>       = <span class="i">$args</span>{-<span class="w">type</span>}<span class="sc">;</span>                          <span class="c">## type of Plate (ie Tube or Library_Plate)</span>
    <span class="k">my</span> <span class="i">$type_id</span>    = <span class="i">$args</span>{-<span class="w">type_id</span>}<span class="sc">;</span>                       <span class="c">## id of subtype if supplied instead...</span>
    <span class="k">my</span> <span class="i">$table</span>      = <span class="i">$args</span>{-<span class="w">table</span>} || <span class="q">'Plate'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tables</span>     = <span class="i">$args</span>{-<span class="w">tables</span>} || <span class="q">'Plate'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$FK_tables</span>  = <span class="i">$args</span>{-<span class="w">FK_tables</span>} || <span class="q">'Plate_Format'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quick_load</span> = <span class="i">$args</span>{-<span class="w">quick_load</span>}<span class="sc">;</span>                    <span class="c">## ignore child tables, left joins for now.</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$attributes</span> = <span class="i">$args</span>{-<span class="w">attributes</span>}<span class="sc">;</span>                    <span class="c">## allow inclusion of attributes for new record</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$type_id</span> &amp;&amp; <span class="i">$type</span> <span class="s">)</span> <span class="s">{</span>                              <span class="c">## or get id based on type &amp; type_id...</span>
        <span class="s">(</span><span class="i">$id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate,$type&quot;</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate__ID=Plate_ID AND $type&quot;</span> . <span class="q">&quot;_ID in ($type_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$id</span><span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span><span class="i">$type</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_Type'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID in ($id)&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$type</span><span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span><span class="i">$type_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="i">$type</span><span class="cm">,</span> <span class="q">&quot;${type}_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate__ID in ($id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Container $id record appears to be missing or incomplete (?)&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$frozen</span>  = <span class="i">$args</span>{-<span class="w">frozen</span>}  || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">$args</span>{-<span class="w">encoded</span>} || <span class="n">0</span><span class="sc">;</span>    <span class="c">## reference to encoded object (frozen)</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="i">$this</span><span class="i">-&gt;SDB::DB_Object::new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="i">$tables</span><span class="cm">,</span> -<span class="w">FK_tables</span> <span class="cm">=&gt;</span> <span class="i">$FK_tables</span><span class="cm">,</span> -<span class="w">frozen</span> <span class="cm">=&gt;</span> <span class="i">$frozen</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$class</span><span class="s">)</span> = <span class="k">ref</span><span class="s">(</span><span class="i">$this</span><span class="s">)</span> || <span class="i">$this</span><span class="sc">;</span>

    <span class="k">bless</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">$class</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} = <span class="i">$dbc</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$id</span> =~ <span class="q">/(\d+),/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$self</span>-&gt;{<span class="w">list</span>} = <span class="i">$id</span><span class="sc">;</span> <span class="i">$id</span> = <span class="i">$1</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## get the first in the list if more than one...</span>
    <span class="i">$self</span>-&gt;{<span class="w">prefix</span>} = <span class="i">$Prefix</span>{<span class="q">'Plate'</span>}<span class="sc">;</span>

    <span class="c">### Customizable settings ##</span>
    <span class="i">$self</span>-&gt;{<span class="w">Tabs</span>} = <span class="s">{</span>
        <span class="q">'Links'</span>     <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="q">'Summaries'</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="q">'Extract'</span>   <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
        <span class="q">'Transfer'</span>  <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="q">'Ancestry'</span>  <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="q">'Data'</span>      <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$encoded</span> || <span class="i">$frozen</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$self</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$id</span><span class="s">)</span> <span class="s">{</span>

        <span class="c">#$self-&gt;{id}       = $id;        ## generic attribute ##</span>
        <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} = <span class="i">$id</span><span class="sc">;</span>        <span class="c">## list of current plate_ids</span>
        <span class="i">$self</span>-&gt;{<span class="w">type</span>}     = <span class="i">$type</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">type_id</span>}  = <span class="i">$type_id</span><span class="sc">;</span>
        <span class="i">$self</span><span class="i">-&gt;primary_value</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## same thing as above..</span>
        <span class="i">$self</span><span class="i">-&gt;load_Object</span><span class="s">(</span> -<span class="w">quick_load</span> <span class="cm">=&gt;</span> <span class="i">$quick_load</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$attributes</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;add_Record</span><span class="s">(</span> -<span class="w">attributes</span> <span class="cm">=&gt;</span> <span class="i">$attributes</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">################################</span>
<a name="plate_QC_trigger-"></a><span class="k">sub </span><span class="m">plate_QC_trigger</span> <span class="s">{</span>
<span class="c">################################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>   = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$status</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'QC_Status'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID = $id&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$children</span> = <span class="i">get_Children</span><span class="s">(</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$status</span> <span class="k">eq</span> <span class="q">'Failed'</span> &amp;&amp; <span class="i">$children</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$link</span> = <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">&quot;Details&quot;</span><span class="cm">,</span> <span class="q">&quot;&amp;cgi_application=alDente::Container_App&amp;ID=$children&quot;</span><span class="cm">,</span> <span class="q">'red'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Setting QC status to Failed for the following daughter plates: $children $link&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'QC_Status'</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="q">'Failed'</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($children)&quot;</span><span class="cm">,</span> -<span class="w">no_triggers</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="i">$ok</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$children</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$count</span> = <span class="k">int</span><span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$children</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$link</span> = <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">&quot;$count plates&quot;</span><span class="cm">,</span> <span class="q">&quot;&amp;cgi_application=alDente::Container_App&amp;rm=default&amp;ID=$children&quot;</span><span class="cm">,</span> <span class="q">'red'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;The QC Status for these daughter plates remains unchanged $link&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">################################</span>
<a name="reset_current_plates-"></a><span class="k">sub </span><span class="m">reset_current_plates</span> <span class="s">{</span>
<span class="c">################################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,current_plates,plate_set'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>   = <span class="i">$args</span>{-<span class="w">current_plates</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$set</span>  = <span class="i">$args</span>{-<span class="w">plate_set</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$dbc</span>-&gt;{<span class="w">current_plates</span>} = \<span class="i">@ids</span><span class="sc">;</span>
    <span class="i">$dbc</span>-&gt;{<span class="w">plate_set</span>}      = <span class="i">$set</span><span class="sc">;</span>

    <span class="c">## temporarily maintain globals until fully phased out.. ##</span>
    <span class="i">$current_plates</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@ids</span><span class="sc">;</span>
    <span class="i">$plate_set</span> = <span class="i">$set</span><span class="sc">;</span>

    <span class="k">return</span> \<span class="i">@ids</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">################################</span>
<a name="add_to_current_plates-"></a><span class="k">sub </span><span class="m">add_to_current_plates</span> <span class="s">{</span>
<span class="c">################################</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>  = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">push</span> <span class="i">@</span>{ <span class="i">$dbc</span>-&gt;{<span class="w">current_plates</span>} }<span class="cm">,</span> <span class="i">@ids</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$dbc</span>-&gt;{<span class="w">current_plates</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># Extractor for Plate/Container prefix</span>
<span class="c">#</span>
<span class="c">#############</span>
<a name="prefix-"></a><span class="k">sub </span><span class="m">prefix</span> <span class="s">{</span>
<span class="c">#############</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">prefix</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">################################</span>
<a name="batch_Aliquot-"></a><span class="k">sub </span><span class="m">batch_Aliquot</span> <span class="s">{</span>
<span class="c">################################</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span>      = <span class="i">$args</span>{-<span class="w">ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$label</span>    = <span class="i">$args</span>{-<span class="w">label</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline</span> = <span class="i">$args</span>{-<span class="w">pipeline</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format</span>   = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$values</span>   = <span class="i">$args</span>{ -<span class="k">values</span> }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>     = <span class="i">$args</span>{-<span class="w">type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@ids</span>      = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$ids</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$count</span>    = <span class="i">@ids</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@new_ids</span><span class="sc">;</span>

    <span class="k">for</span> <span class="k">my</span> <span class="i">$index</span> <span class="s">(</span> <span class="n">0</span> .. <span class="i">$count</span> - <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$ids</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$new_id</span>   = <span class="i">Aliquot_Container</span><span class="s">(</span>
            -<span class="w">dbc</span>      <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span>
            -<span class="w">volume</span>   <span class="cm">=&gt;</span> <span class="i">$values</span>-&gt;{<span class="w">Current_Volume</span>}{<span class="i">$plate_id</span>}<span class="cm">,</span>
            -<span class="w">units</span>    <span class="cm">=&gt;</span> <span class="i">$values</span>-&gt;{<span class="w">Current_Volume_Units</span>}{<span class="i">$plate_id</span>}<span class="cm">,</span>
            -<span class="w">format</span>   <span class="cm">=&gt;</span> <span class="i">$format</span><span class="cm">,</span>
            -<span class="w">pipeline</span> <span class="cm">=&gt;</span> <span class="i">$pipeline</span><span class="cm">,</span>
            -<span class="w">label</span>    <span class="cm">=&gt;</span> <span class="i">$label</span><span class="cm">,</span>
            -<span class="w">id</span>       <span class="cm">=&gt;</span> <span class="i">$ids</span>[<span class="i">$index</span>]<span class="cm">,</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@new_ids</span><span class="cm">,</span> <span class="i">$new_id</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">@new_ids</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">################################</span>
<a name="Aliquot_Container-"></a><span class="k">sub </span><span class="m">Aliquot_Container</span> <span class="s">{</span>
<span class="c">################################</span>
    <span class="k">my</span> <span class="i">%args</span>              = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>               = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>                = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$label</span>             = <span class="i">$args</span>{-<span class="w">label</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline</span>          = <span class="i">$args</span>{-<span class="w">pipeline</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format</span>            = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$units</span>             = <span class="i">$args</span>{-<span class="w">units</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$volume</span>            = <span class="i">$args</span>{-<span class="w">volume</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>              = <span class="i">$args</span>{-<span class="w">type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ignore_attributes</span> = <span class="i">$args</span>{-<span class="w">ignore_attributes</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$temp_rack</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Rack'</span><span class="cm">,</span> <span class="q">'Rack_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Rack_Name = 'Temporary'&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@fields</span> = <span class="s">(</span> <span class="q">'Plate_Number'</span><span class="cm">,</span> <span class="q">'QC_Status'</span><span class="cm">,</span> <span class="q">'Plate_Label'</span><span class="cm">,</span> <span class="q">'FKLast_Prep__ID'</span><span class="cm">,</span> <span class="q">'FKParent_Plate__ID'</span><span class="cm">,</span> <span class="q">'Plate_Status'</span><span class="cm">,</span> <span class="q">'Current_Volume'</span><span class="cm">,</span> <span class="q">'Current_Volume_Units'</span><span class="cm">,</span> <span class="q">'FK_Rack__ID'</span><span class="cm">,</span> <span class="q">'FK_Employee__ID'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values</span> = <span class="s">(</span> <span class="q">''</span><span class="cm">,</span> <span class="q">'N/A'</span><span class="cm">,</span> <span class="i">$label</span><span class="cm">,</span> <span class="q">''</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="q">'Active'</span><span class="cm">,</span> <span class="i">$volume</span><span class="cm">,</span> <span class="i">$units</span><span class="cm">,</span> <span class="i">$temp_rack</span><span class="cm">,</span> <span class="i">$user_id</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$type</span><span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span><span class="i">$type</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_Type'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID = $id&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$pipeline</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$pipeline_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Pipeline__ID'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$pipeline</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$pipeline_id</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@fields</span><span class="cm">,</span> <span class="q">'FK_Pipeline__ID'</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$format</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$format</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$format</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$format</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@fields</span><span class="cm">,</span> <span class="q">'FK_Plate_Format__ID'</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="s">(</span> <span class="k">my</span> <span class="i">$new_id</span><span class="cm">,</span> <span class="k">my</span> <span class="i">$copy_time</span> <span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_copy</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">condition</span> <span class="cm">=&gt;</span> <span class="q">&quot;where Plate_ID = $id&quot;</span><span class="cm">,</span> -<span class="w">time_stamp</span> <span class="cm">=&gt;</span> <span class="q">'Plate_Created'</span><span class="cm">,</span> -<span class="w">exclude</span> <span class="cm">=&gt;</span> \<span class="i">@fields</span><span class="cm">,</span> -<span class="w">replace</span> <span class="cm">=&gt;</span> \<span class="i">@values</span><span class="cm">,</span> -<span class="w">ignore_attributes</span> <span class="cm">=&gt;</span> <span class="i">$ignore_attributes</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$dbc</span><span class="i">-&gt;table_loaded</span><span class="s">(</span><span class="i">$type</span><span class="s">)</span> &amp;&amp; <span class="i">$type</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$primary_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;get_field_info</span><span class="s">(</span> <span class="i">$type</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="q">'Primary'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$sec_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$primary_id</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID = $id &quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@sec_fields</span> = <span class="s">(</span> <span class="q">&quot;$primary_id&quot;</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@sec_values</span> = <span class="s">(</span> <span class="q">''</span><span class="cm">,</span>            <span class="i">$new_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">(</span> <span class="k">my</span> <span class="i">$new_secondary_id</span><span class="cm">,</span> <span class="k">my</span> <span class="i">$copy_time</span> <span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_copy</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="i">$type</span><span class="cm">,</span> -<span class="w">condition</span> <span class="cm">=&gt;</span> <span class="q">&quot;where $primary_id = $sec_id&quot;</span><span class="cm">,</span> -<span class="w">exclude</span> <span class="cm">=&gt;</span> \<span class="i">@sec_fields</span><span class="cm">,</span> -<span class="w">replace</span> <span class="cm">=&gt;</span> \<span class="i">@sec_values</span><span class="cm">,</span> -<span class="w">ignore_attributes</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$new_id</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># update the Plate Number of a Plate</span>
<span class="c">#</span>
<span class="c"># $self-&gt;new_container_trigger();</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">##############################</span>
<a name="new_container_trigger-"></a><span class="k">sub </span><span class="m">new_container_trigger</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">$self</span>            = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$starting_number</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Starting Plate Number'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>             = <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;load_Object</span><span class="s">(</span> -<span class="w">quick_load</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## -force=&gt;1,   ## redundant ??</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_ID'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Error loading simple plate object (requires Sample_Type, Plate_Format, Rack_ID, Library_Name references)&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#$self-&gt;inherit_attributes();	# this part has been moved to new_container_batch_trigger</span>

    <span class="k">my</span> <span class="i">$parent_id</span> = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.FKParent_Plate__ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span> = <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} || <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;update_plate_info</span><span class="s">(</span> -<span class="w">number</span> <span class="cm">=&gt;</span> <span class="i">$starting_number</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## also updates rack to default if it is not set.</span>

    <span class="k">my</span> <span class="i">$class</span>   = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Class'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rearray</span> = <span class="s">(</span> <span class="i">$class</span> =~ <span class="q">/(Rearray|Extraction|Oligo)/i</span> <span class="s">)</span><span class="sc">;</span>                    <span class="c">## flag indicating that this is a rearray plate</span>

    <span class="k">my</span> <span class="i">$action_parameter</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Plate_Action'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pooling</span> = <span class="s">(</span> <span class="i">$action_parameter</span> <span class="k">eq</span> <span class="q">'Pool'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$id</span> &amp;&amp; !<span class="i">$parent_id</span> &amp;&amp; !<span class="i">$rearray</span> &amp;&amp; !<span class="i">$pooling</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## ...previously checked for param('FormNav') ) {</span>

        <span class="c">## trigger applicable only for original plates only ... exclude rearray plates for now...##</span>
        <span class="i">$self</span><span class="i">-&gt;SB_trigger</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'New Plate Contents'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## if content type of plate is changing, prompt for new information ##</span>
        <span class="k">my</span> <span class="i">$new_type_id</span> = <span class="i">param</span><span class="s">(</span><span class="q">'FK_Sample_Type__ID'</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span><span class="i">-&gt;load_Object</span><span class="s">(</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span><span class="i">$content</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Type'</span><span class="cm">,</span> <span class="q">'Sample_Type'</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_Type_ID = $new_type_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$Configs</span>{<span class="w">plateContent_tracking</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$content$/</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;DB_tables</span> <span class="s">)</span> <span class="s">{</span>
                <span class="c">### only generate prompt if the sub table exists in the database ###</span>
                <span class="k">print</span> <span class="i">$self</span><span class="i">-&gt;prompt_for_content_details</span><span class="s">(</span> <span class="i">$content</span><span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$reset_current_plates</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c">## skips resetting of current_plates;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'Protocol Step Name'</span><span class="s">)</span> =~ <span class="q">/ out to /</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$reset_current_plates</span> = <span class="n">0</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$Sess</span>-&gt;{<span class="w">session_id</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$id</span> = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_ID'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$Sess</span>-&gt;{<span class="w">homepage</span>} =~ <span class="q">/^Plate=\d/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## append to list ##</span>
            <span class="i">$Sess</span>-&gt;{<span class="w">homepage</span>} .= <span class="q">&quot;,$id&quot;</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$reset_current_plates</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">alDente::Container::add_to_current_plates</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$Sess</span><span class="i">-&gt;homepage</span><span class="s">(</span><span class="q">&quot;Plate=$id&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$reset_current_plates</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">alDente::Container::reset_current_plates</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">## Upgrade Library from 'Submitted' to 'In Production' if this is the first created plate ##</span>
    <span class="k">my</span> <span class="i">$lib</span> = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.FK_Library__Name'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$lib_status</span><span class="s">)</span> = <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Library'</span><span class="cm">,</span> <span class="q">'Library_Status'</span><span class="cm">,</span> <span class="q">&quot;WHERE Library_Name like '$lib'&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$lib_status</span> <span class="k">eq</span> <span class="q">'Submitted'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Library'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'Library_Status'</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="q">'In Production'</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Library_Name like '$lib'&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Marked $lib as 'In Production'&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># Batch trigger for new containers</span>
<span class="c">#</span>
<span class="c"># $self-&gt;new_container_batch_trigger();</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">##############################</span>
<a name="new_container_batch_trigger-"></a><span class="k">sub </span><span class="m">new_container_batch_trigger</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>   = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>                                <span class="c"># array ref</span>

    <span class="i">&amp;batch_inherit_attributes</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############################</span>
<span class="c">#</span>
<span class="c"># Generic Plate Filter form</span>
<span class="c">#</span>
<span class="c"># - options:</span>
<span class="c">#  -form =&gt; &lt;form name&gt;   (defaults to 'Plate_Filter')</span>
<span class="c">#  -filter =&gt; &lt;filter_list&gt;  (eg &quot;FK_Library__Name, FK_Pipeline__ID, Plate_Status&quot;)</span>
<span class="c">#  -default =&gt; &lt;hash of preset values&gt; (eg {'FK_Library__Name' =&gt; ['AS001','AS002'], 'FK_Pipeline__ID = 4 })</span>
<span class="c">#</span>
<span class="c"># Note: Form is NOT started or ended within this method</span>
<span class="c">#</span>
<span class="c"># return: filter table (HTML)</span>
<span class="c">#########################</span>
<a name="plate_filter-"></a><span class="k">sub </span><span class="m">plate_filter</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">%args</span>          = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>           = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$display</span>       = <span class="i">$args</span>{-<span class="w">display</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library</span>       = <span class="i">$args</span>{-<span class="w">library</span>} || <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Library__Name'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline</span>      = <span class="i">$args</span>{-<span class="w">pipeline</span>} || <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Pipeline__ID'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$status</span>        = <span class="i">$args</span>{-<span class="w">status</span>} || <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'Plate_Status'</span><span class="cm">,</span> -<span class="w">default</span> <span class="cm">=&gt;</span> <span class="q">'Active'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format</span>        = <span class="i">$args</span>{<span class="q">'-format'</span>} || <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_numbers</span> = <span class="i">$args</span>{-<span class="w">plate_numbers</span>} || <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'Plate_Number'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$form</span>          = <span class="i">$args</span>{-<span class="w">form</span>} || <span class="q">'Plate_Filter'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$buttons</span>       = <span class="i">$args</span>{-<span class="w">buttons</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$title</span>         = <span class="i">$args</span>{-<span class="w">title</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$filter</span>        = <span class="i">$args</span>{-<span class="w">filter</span>} || <span class="q">'Pipeline, Library, Project, Status'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@plate_filters</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$filter</span> =~ <span class="q">/\bPipeline\b/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@plate_filters</span><span class="cm">,</span> <span class="q">'Plate.FK_Pipeline__ID'</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$filter</span> =~ <span class="q">/\bPlate_Created\b/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@plate_filters</span><span class="cm">,</span> <span class="q">'Plate.Plate_Created'</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$filter</span> =~ <span class="q">/\bLibrary\b/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@plate_filters</span><span class="cm">,</span> <span class="q">'Plate.FK_Library__Name'</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$filter</span> =~ <span class="q">/\bPlate_Number\b/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@plate_filters</span><span class="cm">,</span> <span class="q">'Plate.Plate_Number'</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$filter</span> =~ <span class="q">/\bStatus\b/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@plate_filters</span><span class="cm">,</span> <span class="q">'Plate.Plate_Status'</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$filter</span> =~ <span class="q">/\bProject\b/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@plate_filters</span><span class="cm">,</span> <span class="q">'Library.FK_Project__ID'</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$filter</span> =~ <span class="q">/\bPlate_Format\b/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@plate_filters</span><span class="cm">,</span> <span class="q">'Plate.FK_Plate_Format__ID'</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$preset</span> = <span class="s">{</span>
        <span class="q">'Plate_Status'</span>        <span class="cm">=&gt;</span> <span class="i">$status</span><span class="cm">,</span>
        <span class="q">'FK_Pipeline__ID'</span>     <span class="cm">=&gt;</span> <span class="i">$pipeline</span><span class="cm">,</span>
        <span class="q">'Plate_Number'</span><span class="cm">,</span>       <span class="cm">=&gt;</span> <span class="i">$plate_numbers</span><span class="cm">,</span>
        <span class="q">'FK_Library__Name'</span>    <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span>
        <span class="q">'FK_Plate_Format__ID'</span> <span class="cm">=&gt;</span> <span class="i">$format</span><span class="cm">,</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plate_filters</span> = <span class="i">new</span> <span class="i">SDB::DB_Form</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">wrap</span> <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> \<span class="i">@plate_filters</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$plate_filters</span><span class="i">-&gt;configure</span><span class="s">(</span> -<span class="w">preset</span> <span class="cm">=&gt;</span> <span class="i">$preset</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$filter_form</span> = <span class="i">$plate_filters</span><span class="i">-&gt;generate</span><span class="s">(</span>
        -<span class="w">return_html</span>    <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        -<span class="w">action</span>         <span class="cm">=&gt;</span> <span class="q">'search'</span><span class="cm">,</span>
        -<span class="w">title</span>          <span class="cm">=&gt;</span> <span class="q">&quot;Select Filtering Criteria&quot;</span><span class="cm">,</span>
        -<span class="w">filter_by_dept</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        -<span class="w">navigator_on</span>   <span class="cm">=&gt;</span> <span class="n">0</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$filter_table</span> = <span class="w">HTML_Table</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">title</span> <span class="cm">=&gt;</span> <span class="i">$title</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$filter_table</span><span class="i">-&gt;Set_Row</span><span class="s">(</span> <span class="s">[</span><span class="i">$filter_form</span><span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$buttons</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$button</span> <span class="s">(</span><span class="i">@$buttons</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$filter_table</span><span class="i">-&gt;Set_Row</span><span class="s">(</span> <span class="s">[</span><span class="i">$button</span><span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$filter_page</span> = <span class="i">lbr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$filter_page</span> .= <span class="i">$filter_table</span><span class="i">-&gt;Printout</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$filter_page</span> .= <span class="i">hr</span><span class="s">(</span><span class="s">)</span> . <span class="i">$display</span> <span class="k">if</span> <span class="i">$display</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$filter_page</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##########################</span>
<span class="c">#</span>
<span class="c"># Use plate_filter input to generate SQL conditions</span>
<span class="c">#</span>
<span class="c"># Return: list of Conditions</span>
<span class="c">#####################</span>
<a name="parse_plate_filter-"></a><span class="k">sub </span><span class="m">parse_plate_filter</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$dbc</span>             = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library</span>         = <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Library__Name'</span><span class="cm">,</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_numbers</span>   = <span class="i">param</span><span class="s">(</span><span class="q">'Plate_Number'</span><span class="s">)</span> || <span class="i">param</span><span class="s">(</span><span class="q">'Plate Numbers'</span><span class="s">)</span> || <span class="i">param</span><span class="s">(</span><span class="q">'Plate Number'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group_name_list</span> = <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Grp__ID'</span><span class="cm">,</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Library'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$status</span>          = <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'Plate_Status'</span><span class="cm">,</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format_id</span>       = <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$project</span>         = <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Project__ID'</span><span class="cm">,</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Library'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_id</span>     = <span class="i">get_Table_Params</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Pipeline__ID'</span><span class="cm">,</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$protocol_id</span>     = <span class="i">param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span> || <span class="i">param</span><span class="s">(</span><span class="q">'FK_Lab_Protocol__ID'</span><span class="s">)</span> || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span>             = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$dbc</span>-&gt;{<span class="w">current_plates</span>} }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$days_ago</span>        = <span class="i">param</span><span class="s">(</span><span class="q">'Days_Ago'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@group_list_array</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$ids</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$ids</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">param</span><span class="s">(</span><span class="q">'FK_Plate__ID'</span><span class="s">)</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">@conditions</span><span class="sc">;</span>

    <span class="c">## parse group ##</span>
    <span class="k">my</span> <span class="i">$group_list</span><span class="sc">;</span>
    <span class="i">$group_list</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> <span class="q">'FK_Grp__ID'</span><span class="cm">,</span> <span class="i">$group_name_list</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$group_name_list</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$group_options</span><span class="sc">;</span>
    <span class="i">$group_options</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$group_list</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$group_list</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$group_options</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Library.FK_Grp__ID IN ($group_options)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## parse library ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> =~ <span class="q">/\S/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$library</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> <span class="q">'FK_Library__Name'</span><span class="cm">,</span> <span class="i">$library</span> <span class="s">)</span> <span class="s">}</span>    <span class="c">## convert if name supplied ##</span>
    <span class="k">my</span> <span class="i">$library_options</span><span class="sc">;</span>
    <span class="i">$library_options</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$library</span> =~ <span class="q">/\S/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$library_options</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.FK_Library__Name IN ($library_options)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## parse plate numbers ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_numbers</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$plate_numbers</span> = <span class="i">&amp;extract_range</span><span class="s">(</span><span class="i">$plate_numbers</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_Number in ($plate_numbers)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## parse date range ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$days_ago</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_Created &gt; '&quot;</span> . <span class="i">&amp;date_time</span><span class="s">(</span><span class="q">&quot;-${days_ago}d&quot;</span><span class="s">)</span> . <span class="q">&quot;'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## parse plate ids ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$ids</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_ID IN ($ids)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## parse protocol ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$protocol_id</span> =~ <span class="q">/[a-zA-Z]/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$protocol_id</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> <span class="q">'FK_Protocol__ID'</span><span class="cm">,</span> <span class="i">$protocol_id</span> <span class="s">)</span> <span class="s">}</span>    <span class="c">## convert if name supplied ##</span>
    <span class="k">my</span> <span class="i">$protocol_options</span><span class="sc">;</span>
    <span class="i">$protocol_options</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$protocol_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$protocol_id</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$protocol_options</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Prep.FK_Lab_Protocol__ID IN ($protocol_options)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## parse project ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$project</span> =~ <span class="q">/[a-zA-Z]/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$project</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> <span class="q">'FK_Project__ID'</span><span class="cm">,</span> <span class="i">$project</span> <span class="s">)</span> <span class="s">}</span>                 <span class="c">## convert if name supplied ##</span>
    <span class="k">my</span> <span class="i">$project_options</span><span class="sc">;</span>
    <span class="i">$project_options</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$project</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$project</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$project_options</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Library.FK_Project__ID IN ($project_options)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## parse pipeline ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$pipeline_id</span> =~ <span class="q">/[a-zA-Z]/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$pipeline_id</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> <span class="q">'FK_Pipeline__ID'</span><span class="cm">,</span> <span class="i">$pipeline_id</span> <span class="s">)</span> <span class="s">}</span>    <span class="c">## convert if name supplied ##</span>
    <span class="k">my</span> <span class="i">$pipeline_options</span><span class="sc">;</span>
    <span class="i">$pipeline_options</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$pipeline_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$pipeline_id</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$pipeline_options</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.FK_Pipeline__ID IN ($pipeline_options)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## parse status ##</span>
    <span class="k">my</span> <span class="i">$status_options</span><span class="sc">;</span>
    <span class="i">$status_options</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$status</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$status</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$status_options</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.Plate_Status IN ($status_options)&quot;</span> <span class="k">if</span> <span class="i">$status_options</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## parse format ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$format_id</span> =~ <span class="q">/[a-zA-Z]/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$format_id</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> <span class="i">$format_id</span> <span class="s">)</span> <span class="s">}</span>    <span class="c">## convert if name supplied ##</span>
    <span class="k">my</span> <span class="i">$format_options</span><span class="sc">;</span>
    <span class="i">$format_options</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$format_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$format_id</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$format_options</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@conditions</span><span class="cm">,</span> <span class="q">&quot;Plate.FK_Plate_Format__ID IN ($format_options)&quot;</span> <span class="k">if</span> <span class="i">$format_options</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">@conditions</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################################</span>
<a name="prompt_for_content_details-"></a><span class="k">sub </span><span class="m">prompt_for_content_details</span> <span class="s">{</span>
<span class="c">##################################</span>
    <span class="k">my</span> <span class="i">$self</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$current_plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">param</span><span class="s">(</span><span class="q">'Current Plates'</span><span class="s">)</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$form</span> = <span class="w">SDB::DB_Form</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="i">$type</span><span class="cm">,</span> -<span class="w">target</span> <span class="cm">=&gt;</span> <span class="q">'Database'</span><span class="cm">,</span> -<span class="w">parameters</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="i">&amp;Set_Parameters</span><span class="s">(</span><span class="s">)</span> <span class="s">}</span><span class="cm">,</span> -<span class="w">start_form</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">end_form</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">form_name</span> <span class="cm">=&gt;</span> <span class="q">'Content_Info'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%preset</span><span class="sc">;</span>
    <span class="i">$dbc</span><span class="i">-&gt;merge_data</span><span class="s">(</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="q">&quot;Plate,$type&quot;</span><span class="cm">,</span> -<span class="w">primary_list</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span><span class="cm">,</span> -<span class="w">primary_field</span> <span class="cm">=&gt;</span> <span class="q">'Plate.Plate_ID'</span><span class="cm">,</span> -<span class="w">preset</span> <span class="cm">=&gt;</span> \<span class="i">%preset</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$preset</span>{<span class="q">'FK_Plate__ID'</span>} = <span class="i">$plate</span><span class="sc">;</span>    <span class="c">## over-ride reference to this plate.</span>
    <span class="k">my</span> <span class="i">$homepage</span> = <span class="q">&quot;Plate=$plate&quot;</span><span class="sc">;</span>
    <span class="i">$form</span><span class="i">-&gt;configure</span><span class="s">(</span>
        -<span class="w">grey</span>    <span class="cm">=&gt;</span> <span class="s">{</span> <span class="q">'FK_Plate__ID'</span>     <span class="cm">=&gt;</span> <span class="i">$plate</span> <span class="s">}</span><span class="cm">,</span>
        -<span class="w">title</span>   <span class="cm">=&gt;</span> <span class="q">'Extraction Details'</span><span class="cm">,</span>
        -<span class="w">preset</span>  <span class="cm">=&gt;</span> \<span class="i">%preset</span><span class="cm">,</span>
        -<span class="w">include</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="q">'Session_homepage'</span> <span class="cm">=&gt;</span> <span class="i">$homepage</span> <span class="s">}</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c">#		     -list=&gt;\%list,-include=&gt;\%include,-extra=&gt;\%extra,-omit=&gt;\%omit</span>
    <span class="i">$form</span><span class="i">-&gt;generate</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># load Plate object - sets DBobject attribute and loads object depending upon type. (eg Tube / Gel_Plate / Library_Plate)</span>
<span class="c">#</span>
<span class="c"># may be called given plate_id or plate_type (in which case the primary field in the associated table should already have been specified - allowing the object to be loaded directly)</span>
<span class="c">#</span>
<span class="c">###################</span>
<a name="load_Object-"></a><span class="k">sub </span><span class="m">load_Object</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'plate_id'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>}      || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>     = <span class="i">$args</span>{-<span class="w">type</span>}     || <span class="i">$self</span>-&gt;{<span class="w">type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>} || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$quick_load</span> = <span class="i">$args</span>{-<span class="w">quick_load</span>}<span class="sc">;</span>    <span class="c">## ignore child, left join tables</span>
    <span class="k">my</span> <span class="i">$debug</span>      = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$force</span>      = <span class="i">$args</span>{-<span class="w">force</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">'Library_Plate'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## NEW Plate object created directly</span>
        <span class="i">$plate_id</span> ||= <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Library_Plate&quot;</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Library_Plate_ID = $self-&gt;{id}&quot;</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$self</span>-&gt;{<span class="w">id</span>}<span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} ||= <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">'Array'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## NEW Plate object created directly</span>
        <span class="i">$plate_id</span> ||= <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Library_Plate&quot;</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Library_Plate_ID = $self-&gt;{id}&quot;</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$self</span>-&gt;{<span class="w">id</span>}<span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} ||= <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> &amp;&amp; <span class="s">(</span> <span class="i">$type</span> <span class="k">ne</span> <span class="q">'Plate'</span> <span class="s">)</span> &amp;&amp; <span class="i">$self</span>-&gt;{<span class="w">id</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="c">## if Tube type + id or Library_Plate + id supplied</span>
        <span class="k">my</span> <span class="i">$type_id</span> = <span class="i">$self</span>-&gt;{<span class="w">id</span>}<span class="sc">;</span>
        <span class="s">(</span><span class="i">$plate_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="i">$type</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE $type&quot;</span> . <span class="q">&quot;_ID IN ($type_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} = <span class="i">$plate_id</span> <span class="k">if</span> <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> &amp;&amp; <span class="s">(</span> <span class="i">$type</span> <span class="k">ne</span> <span class="q">'Plate'</span> &amp;&amp; <span class="i">$plate_id</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## if Tube type or Library_Plate, but original plate_ID is supplied ##</span>
        <span class="k">my</span> <span class="i">$type_id</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$type</span> . <span class="q">'_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID IN ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">id</span>} = <span class="i">$type_id</span> <span class="k">if</span> <span class="i">$type_id</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} = <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">$type</span><span class="s">)</span> <span class="s">{</span><span class="k">return</span><span class="s">}</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$plate_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Error: No id found for this container $plate_id(?)&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">Call_Stack</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$plate_id</span> = <span class="i">get_aldente_id</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$plate_id</span><span class="cm">,</span> <span class="q">'Plate'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$type</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span><span class="i">$type</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_Type'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$content</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$Configs</span>{<span class="w">plateContent_tracking</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span><span class="i">$content</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate,Sample_Type'</span><span class="cm">,</span> <span class="q">'Sample_Type'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Sample_Type__ID=Sample_Type_ID AND Plate_ID IN ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$additional_condition</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">$quick_load</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span><span class="i">$type</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span><span class="i">$content</span><span class="s">)</span> <span class="k">if</span> <span class="i">$content</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">'Tube'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$plate_parent_well</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_Parent_Well'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($self-&gt;{plate_id})&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$additional_condition</span> .= <span class="q">&quot;Plate_ID IN ($self-&gt;{plate_id}) AND Plate_Sample.Well = '$plate_parent_well'&quot;</span> <span class="k">if</span> <span class="i">$plate_parent_well</span><span class="sc">;</span>
            <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span> <span class="q">'Plate_Sample'</span><span class="cm">,</span>    <span class="q">'Plate.FKOriginal_Plate__ID=Plate_Sample.FKOriginal_Plate__ID'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span> <span class="q">'Sample'</span><span class="cm">,</span>          <span class="q">'Plate_Sample.FK_Sample__ID=Sample_ID'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span> <span class="q">'Source'</span><span class="cm">,</span>          <span class="q">'Sample.FK_Source__ID=Source_ID'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span> <span class="q">'Original_Source'</span><span class="cm">,</span> <span class="q">'Source.FK_Original_Source__ID=Original_Source_ID'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span> <span class="q">'Library'</span><span class="cm">,</span>         <span class="q">'Plate.FK_Library__Name=Library_Name'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span> <span class="q">'Library'</span><span class="cm">,</span>         <span class="q">'Plate.FK_Library__Name=Library_Name'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span> <span class="q">'Original_Source'</span><span class="cm">,</span> <span class="q">'Library.FK_Original_Source__ID=Original_Source_ID'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="i">$self</span><span class="i">-&gt;add_tables</span><span class="s">(</span> <span class="q">'Plate_Format'</span><span class="cm">,</span> <span class="q">'Plate.FK_Plate_Format__ID=Plate_Format_ID'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;no_joins</span><span class="s">(</span><span class="q">'Library,Employee,Sample,Plate,Sample_Type'</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># Do not join the Library and Employee table (eg. Lib created by..)</span>
    <span class="i">$self</span><span class="i">-&gt;SUPER::load_Object</span><span class="s">(</span> -<span class="w">quick_load</span> <span class="cm">=&gt;</span> <span class="i">$quick_load</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="i">$force</span><span class="cm">,</span> -<span class="w">condition</span> <span class="cm">=&gt;</span> <span class="i">$additional_condition</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;set</span><span class="s">(</span> <span class="q">'DBobject'</span><span class="cm">,</span> <span class="i">$type</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} = <span class="i">$self</span><span class="i">-&gt;get_data</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$plate_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## get protocol in which plate was created ##</span>
        <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">get_birth_protocol</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$self</span>-&gt;{<span class="w">protocol_name</span>} = <span class="i">$protocol</span>-&gt;{<span class="w">protocol_name</span>} <span class="k">if</span> <span class="s">(</span> <span class="i">$protocol</span> &amp;&amp; <span class="i">$Configs</span>{<span class="w">protocol_tracking</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># public_methods             #</span>
<span class="c">##############################</span>

<span class="c">##################</span>
<a name="home_page-"></a><span class="k">sub </span><span class="m">home_page</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">$self</span>        = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>        = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'-brief'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$brief</span>       = <span class="i">$args</span>{-<span class="w">brief</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hide_header</span> = <span class="i">$args</span>{-<span class="w">hide_header</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$simple</span>      = <span class="i">$args</span>{-<span class="w">simple</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span> = <span class="i">$self</span>-&gt;{<span class="w">type</span>} || <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Type'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>   = <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} || <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$list</span> = <span class="i">$self</span>-&gt;{<span class="w">list</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$list</span><span class="s">)</span> <span class="s">{</span> <span class="i">$id</span> = <span class="i">$list</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> &amp;&amp; <span class="i">$id</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">'Array'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">require</span> <span class="w">alDente::Array</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$type</span> = <span class="q">'alDente::'</span> . <span class="i">$type</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$object</span> = <span class="i">$self</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">ne</span> <span class="q">'Container'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$object</span> = <span class="i">$type</span><span class="i">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">Plate</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">return</span> <span class="i">$object</span><span class="i">-&gt;home_page</span><span class="s">(</span> -<span class="w">brief</span> <span class="cm">=&gt;</span> <span class="i">$scanner_mode</span><span class="cm">,</span> -<span class="w">hide_header</span> <span class="cm">=&gt;</span> <span class="i">$hide_header</span><span class="cm">,</span> -<span class="w">simple</span> <span class="cm">=&gt;</span> <span class="i">$simple</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;No Type ($type) or ID ($id)&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="i">Call_Stack</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################################################</span>
<span class="c">#</span>
<span class="c"># Display current status (eg. plates / plate sets.. )</span>
<span class="c">#</span>
<span class="c">#############################</span>
<a name="Display_Input-"></a><span class="k">sub </span><span class="m">Display_Input</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$current</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$dbc</span>-&gt;{<span class="w">current_plates</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$current</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$dbc</span>-&gt;{<span class="w">current_plates</span>} } <span class="s">}</span>
    <span class="i">$current</span> ||= <span class="i">$current_plates</span><span class="sc">;</span>    <span class="c">## temporary (phasing out..)</span>

    <span class="i">$plate_set</span> ||= <span class="i">$dbc</span>-&gt;{<span class="w">plate_set</span>}<span class="sc">;</span>
    <span class="i">$plate_set</span> ||= <span class="i">param</span><span class="s">(</span><span class="q">'Plate Set Number'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$protocol</span>  ||= <span class="i">$dbc</span>-&gt;{<span class="w">protocol</span>}<span class="sc">;</span>
    <span class="c">### If we have come this far, show Current Plates, Plate Set Status ###</span>
    <span class="k">my</span> <span class="i">$Header</span> = <span class="w">HTML_Table</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'small'</span><span class="cm">,</span> -<span class="w">padding</span> <span class="cm">=&gt;</span> <span class="q">'0'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$Header</span><span class="i">-&gt;Set_Line_Colour</span><span class="s">(</span><span class="q">'CCCCCC'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$protocol</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$Header</span><span class="i">-&gt;Set_Row</span><span class="s">(</span> <span class="s">[</span> <span class="q">'Protocol:'</span><span class="cm">,</span> <span class="q">&quot;&lt;B&gt;$protocol&lt;/B&gt;&quot;</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$current</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">@list</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$current</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$tables</span><span class="cm">,</span> <span class="i">$set_order</span> <span class="s">)</span> = <span class="s">(</span> <span class="q">'Plate, Plate_Format'</span><span class="cm">,</span> <span class="q">''</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$Header</span><span class="i">-&gt;Set_Row</span><span class="s">(</span> <span class="s">[</span> <span class="q">'Current Set:'</span><span class="cm">,</span> <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="i">b</span><span class="s">(</span><span class="i">$plate_set</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;&amp;HomePage=Plate_Set&amp;ID=$plate_set&quot;</span><span class="cm">,</span> <span class="q">'red'</span> <span class="s">)</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$tables</span>    .= <span class="q">',Plate_Set'</span><span class="sc">;</span>
            <span class="i">$set_order</span> .= <span class="q">&quot; AND Plate_Set.FK_Plate__ID=Plate_ID AND Plate_Set_Number = $plate_set ORDER BY Plate_Set_ID&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">@types</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="i">$tables</span><span class="cm">,</span> <span class="q">'Plate_ID,Plate_Format_Type,Well_Capacity_mL,Plate_Size'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate_Format__ID=Plate_Format_ID AND Plate_ID in ($current) $set_order&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">%counts</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="s">(</span><span class="i">@types</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$format_size</span><span class="cm">,</span> <span class="i">$size</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$counts</span>{<span class="i">$type</span>}{<span class="w">ids</span>} }<span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$format_size</span> <span class="k">ne</span> <span class="i">$size</span> &amp;&amp; <span class="i">$size</span> <span class="s">)</span> <span class="s">{</span>

                <span class="c">#	    $counts{$type}{count}++;</span>
                <span class="c">### Extract the size by dividing (ie. 384/96)</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="i">$counts</span>{<span class="i">$type</span>}{<span class="w">maxcount</span>} <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$counts</span>{<span class="i">$type</span>}{<span class="w">maxcount</span>} = <span class="s">[</span> <span class="k">split</span><span class="s">(</span> <span class="q">'-'</span><span class="cm">,</span> <span class="i">$format_size</span> <span class="s">)</span> <span class="s">]</span>-&gt;[<span class="n">0</span>] / <span class="s">[</span> <span class="k">split</span><span class="s">(</span> <span class="q">'-'</span><span class="cm">,</span> <span class="i">$size</span> <span class="s">)</span> <span class="s">]</span>-&gt;[<span class="n">0</span>]<span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$plate_info</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%counts</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">@list</span> = <span class="i">@</span>{ <span class="i">$counts</span>{<span class="i">$_</span>}{<span class="w">ids</span>} }<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$tray_groups</span> = <span class="i">alDente::Tray::group_ids</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">'Plate'</span><span class="cm">,</span> \<span class="i">@list</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$display</span><span class="sc">;</span>
            <span class="i">$display</span> .= <span class="q">' '</span> . <span class="i">$tray_groups</span>-&gt;{<span class="w">physical_plates</span>}<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$tray_groups</span>-&gt;{<span class="w">tray_singlets</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="i">$display</span> .= <span class="q">' ('</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$tray_groups</span>-&gt;{<span class="w">complete_trays</span>} <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$display</span> .= <span class="i">$tray_groups</span>-&gt;{<span class="w">complete_trays</span>} . <span class="q">' full+'</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="i">$display</span> .= <span class="i">$tray_groups</span>-&gt;{<span class="w">tray_singlets</span>} . <span class="q">'/'</span> . <span class="i">$counts</span>{<span class="i">$_</span>}{<span class="w">maxcount</span>} <span class="k">if</span> <span class="s">(</span> <span class="i">$tray_groups</span>-&gt;{<span class="w">tray_singlets</span>} <span class="s">)</span><span class="sc">;</span>
                <span class="i">$display</span> .= <span class="q">')'</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$display</span> .= <span class="q">&quot; $_&quot;</span><span class="sc">;</span>
            <span class="i">$plate_info</span> .= <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="i">$display</span><span class="cm">,</span> <span class="q">&quot;&amp;Info=1&amp;Table=Plate&amp;Field=Plate_ID&amp;Like=&quot;</span> . <span class="k">join</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@list</span> <span class="s">)</span><span class="cm">,</span> <span class="q">'red'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span> . <span class="q">'&lt;br&gt;'</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$Header</span><span class="i">-&gt;Set_Row</span><span class="s">(</span> <span class="s">[</span> <span class="q">'Current Samples:'</span><span class="cm">,</span> <span class="i">$plate_info</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$Header</span><span class="i">-&gt;Printout</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##########################</span>
<a name="_init_table-"></a><span class="k">sub </span><span class="m">_init_table</span> <span class="s">{</span>
<span class="c">##########################</span>
    <span class="k">my</span> <span class="i">$title</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$width</span> = <span class="k">shift</span> || <span class="q">&quot;100%&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$table</span> = <span class="w">HTML_Table</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$table</span><span class="i">-&gt;Set_Class</span><span class="s">(</span><span class="q">'small'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$table</span><span class="i">-&gt;Set_Width</span><span class="s">(</span><span class="i">$width</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$table</span><span class="i">-&gt;Toggle_Colour</span><span class="s">(</span><span class="q">'off'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$table</span><span class="i">-&gt;Set_Line_Colour</span><span class="s">(</span> <span class="q">'#eeeeff'</span><span class="cm">,</span> <span class="q">'#eeeeff'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$table</span><span class="i">-&gt;Set_Title</span><span class="s">(</span> <span class="i">$title</span><span class="cm">,</span> <span class="w">bgcolour</span> <span class="cm">=&gt;</span> <span class="q">'#ccccff'</span><span class="cm">,</span> <span class="w">fclass</span> <span class="cm">=&gt;</span> <span class="q">'small'</span><span class="cm">,</span> <span class="w">fstyle</span> <span class="cm">=&gt;</span> <span class="q">'bold'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$table</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Display the schedule for a given plate</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">############################</span>
<a name="get_plate_schedule_code-"></a><span class="k">sub </span><span class="m">get_plate_schedule_code</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">require</span> <span class="w">alDente::Plate_Schedule</span><span class="sc">;</span>
    <span class="k">use</span> <span class="w">RGTools::RGmath</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_schedule</span> = <span class="w">alDente::Plate_Schedule</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span>             <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$schedule</span>       = <span class="i">$plate_schedule</span><span class="i">-&gt;get_plate_schedule</span><span class="s">(</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipelines</span>      = <span class="i">$schedule</span>-&gt;{<span class="w">FK_Pipeline__ID</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_codes</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$pipelines</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%Codes</span><span class="sc">;</span>
        <span class="k">map</span> <span class="s">{</span>
            <span class="s">(</span><span class="i">$_</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Pipeline'</span><span class="cm">,</span> <span class="q">'Pipeline_Code'</span><span class="cm">,</span> <span class="q">&quot;WHERE Pipeline_ID = $_&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Codes</span>{<span class="i">$_</span>} = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span> <span class="i">@</span>{<span class="i">$pipelines</span>}<span class="sc">;</span>

        <span class="i">$pipeline_codes</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="k">keys</span> <span class="i">%Codes</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$pipeline_codes</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############################</span>
<span class="c"># Retrieve list of plates directly above current plate in hierarchy.  (eg parents)</span>
<span class="c">#</span>
<span class="c"># This also retrieves extraction parents, rearray parents, and pooling parents if the -follow flag is set.</span>
<span class="c"># (It will not follow through the above for multi-well plates unless the -extended_follow flag is set.</span>
<span class="c">#</span>
<span class="c">#####################</span>
<a name="get_prev_gen-"></a><span class="k">sub </span><span class="m">get_prev_gen</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id,fields,follow'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>             = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span>        = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fields</span>          = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$include</span>         = <span class="i">$args</span>{-<span class="w">include</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$extended_follow</span> = <span class="i">$args</span>{-<span class="w">extended_follow</span>}<span class="sc">;</span>                                                         <span class="c">## follow through rearrays etc even for multi-well plates.</span>
    <span class="k">my</span> <span class="i">$well</span>            = <span class="i">$args</span>{-<span class="w">well</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$follow</span>          = <span class="i">$args</span>{-<span class="w">follow</span>} || <span class="i">$extended_follow</span><span class="sc">;</span>                                              <span class="c">## flag to indicate if we are to follow through extractions, pooling etc.</span>

    <span class="k">my</span> <span class="i">$match</span>            = <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@group</span>            = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>                                                                             <span class="c">## array to store children (re-grouped if necessary to arrange 96x4 plates together ##</span>
    <span class="k">my</span> <span class="i">$follow_condition</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>                                                                             <span class="c">#&quot; AND Plate_Type like 'Tube'&quot; unless $extended_follow;</span>

    <span class="c">## form children into groups of mul plates if applicable... ## ie @children = ('1,2,3,4','5,6,7,8');</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%Child</span><span class="sc">;</span>
    <span class="i">$Child</span>{<span class="q">'Child'</span>} = <span class="s">{</span> <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Plate LEFT JOIN Plate_Tray on FK_Plate__ID=Plate_ID'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FKParent_Plate__ID as Plate_ID'</span><span class="cm">,</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'Plate_Position'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($plate_id) ORDER BY Plate_ID&quot;</span> <span class="s">)</span> <span class="s">}</span><span class="sc">;</span>

    <span class="c">### also allow tracking through extractions, pooling, rearrays etc. ###</span>
    <span class="k">my</span> <span class="i">$well_condition</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$well</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$well_condition</span> = <span class="q">&quot; AND Target_Well = '$well'&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#@field_list = (&quot;concat(FK_Library__Name,Plate_Number) as Pnum&quot;</span>
    <span class="c">#Message(&quot;Plate $plate_id&quot;);</span>
    <span class="c">#my $result = $dbc-&gt;call_stored_procedure(-sp_name=&gt;'get_prev_rearray_gen',-arguments=&gt;&quot;\&quot;$plate_id\&quot;&quot;);</span>
    <span class="i">$Child</span>{<span class="q">'Rearray'</span>} = <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
            <span class="q">'Plate,ReArray_Request,ReArray'</span><span class="cm">,</span>
            <span class="s">[</span> <span class="q">'FKSource_Plate__ID as Plate_ID'</span><span class="cm">,</span> <span class="i">@field_list</span> <span class="s">]</span><span class="cm">,</span>
            <span class="q">&quot;WHERE FKTarget_Plate__ID=Plate_ID $well_condition AND FK_ReArray_Request__ID=ReArray_Request_ID AND ReArray_Type &lt;&gt; 'Extraction ReArray' and Plate_ID in ($plate_id) $follow_condition ORDER BY FKTarget_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span>
        <span class="s">)</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="i">$Child</span>{<span class="q">'Extraction'</span>} = <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
            <span class="q">'Plate,ReArray_Request,ReArray'</span><span class="cm">,</span>
            <span class="s">[</span> <span class="q">'FKSource_Plate__ID as Plate_ID'</span><span class="cm">,</span> <span class="i">@field_list</span> <span class="s">]</span><span class="cm">,</span>
            <span class="q">&quot;WHERE FKTarget_Plate__ID=Plate_ID AND FK_ReArray_Request__ID=ReArray_Request_ID AND ReArray_Type = 'Extraction ReArray' and Plate_ID in ($plate_id) $follow_condition ORDER BY FKTarget_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span>
        <span class="s">)</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="i">$Child</span>{<span class="q">'Pooling'</span>} = <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
            <span class="q">'Plate,Sample_Pool,PoolSample'</span><span class="cm">,</span>
            <span class="s">[</span> <span class="q">'FK_Plate__ID as Plate_ID'</span><span class="cm">,</span> <span class="i">@field_list</span> <span class="s">]</span><span class="cm">,</span>
            <span class="q">&quot;WHERE FKTarget_Plate__ID=Plate_ID AND Sample_Pool.FK_Pool__ID=PoolSample.FK_Pool__ID AND Plate_ID in ($plate_id) $follow_condition ORDER BY FKTarget_Plate__ID&quot;</span>
        <span class="s">)</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@variations</span> = <span class="s">(</span><span class="q">'Child'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@variations</span><span class="cm">,</span> <span class="s">(</span> <span class="q">'Pooling'</span><span class="cm">,</span> <span class="q">'Rearray'</span><span class="cm">,</span> <span class="q">'Extraction'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$follow</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$array</span> <span class="s">(</span><span class="i">@variations</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Child</span>{<span class="i">$array</span>} <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>
        <span class="k">my</span> <span class="i">%Array</span> = <span class="i">%</span>{ <span class="i">$Child</span>{<span class="i">$array</span>} }<span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$#</span>{ <span class="i">$Array</span>{<span class="w">Plate_ID</span>} } &gt; <span class="n">500</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;More than $#{$Array{Plate_ID}} $array, ignored)&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">next</span> <span class="s">}</span>
        <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Array</span>{<span class="w">Plate_ID</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$id</span> = <span class="i">$Array</span>{<span class="w">Plate_ID</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">unless</span> <span class="s">(</span><span class="i">$id</span><span class="s">)</span> <span class="s">{</span> <span class="i">$index</span>++<span class="sc">;</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$include</span> &amp;&amp; <span class="i">$include</span> !~ <span class="q">/\b$id\b/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$index</span>++<span class="sc">;</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## skip if not in supplied list</span>
            <span class="k">my</span> <span class="i">$pos</span>    = <span class="i">$Array</span>{<span class="w">Plate_Position</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$number</span> = <span class="i">$Array</span>{<span class="w">Pnum</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$pos</span> &amp;&amp; <span class="i">$match</span> =~ <span class="q">/^$number$pos$/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$group</span>[<span class="n">-1</span>] = <span class="q">&quot;$group[-1],$id&quot;</span> <span class="k">unless</span> <span class="s">(</span> <span class="i">$group</span>[<span class="n">-1</span>] =~ <span class="q">/\b$id\b/</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>                                                               <span class="c">## include with last plate</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@group</span><span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span> <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$id$/</span><span class="cm">,</span> <span class="i">@group</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">my</span> <span class="i">$lastpos</span> = <span class="i">$pos</span><span class="sc">;</span>
            <span class="i">$lastpos</span>++<span class="sc">;</span>
            <span class="i">$match</span> = <span class="q">&quot;$number$lastpos&quot;</span><span class="sc">;</span>                                     <span class="c">## if this matches the next plate, combine them together...</span>
            <span class="i">$index</span>++<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@group</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###############################</span>
<span class="c"># Retrieve list of plates directly below current plate in hierarchy.  (eg children)</span>
<span class="c">#</span>
<span class="c"># This also retrieves extraction parents, rearray parents, and pooling parents if the -follow flag is set.</span>
<span class="c"># (It will not follow through the above for multi-well plates unless the -extended_follow flag is set.</span>
<span class="c">#</span>
<span class="c">#####################</span>
<a name="get_next_gen-"></a><span class="k">sub </span><span class="m">get_next_gen</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id,fields,follow'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>}      || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>} || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fields</span>   = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$include</span>  = <span class="i">$args</span>{-<span class="w">include</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$extended_follow</span> = <span class="i">$args</span>{-<span class="w">extended_follow</span>}<span class="sc">;</span>               <span class="c">## follow through rearrays etc even for multi-well plates.</span>
    <span class="k">my</span> <span class="i">$follow</span>          = <span class="i">$args</span>{-<span class="w">follow</span>} || <span class="i">$extended_follow</span><span class="sc">;</span>    <span class="c">## flag to indicate if we are to follow through extractions, pooling etc.</span>
    <span class="k">my</span> <span class="i">$debug</span>           = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$match</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@group</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>                                              <span class="c">## array to store children (re-grouped if necessary to arrange 96x4 plates together ##</span>
    <span class="k">my</span> <span class="i">$follow_condition</span><span class="sc">;</span>
    <span class="i">$follow_condition</span> = <span class="q">&quot; AND Plate_Type like 'Tube'&quot;</span> <span class="k">unless</span> <span class="i">$extended_follow</span><span class="sc">;</span>

    <span class="c">## form children into groups of mul plates if applicable... ## ie @children = ('1,2,3,4','5,6,7,8');</span>

    <span class="k">my</span> <span class="i">@field_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$fields</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%Child</span><span class="sc">;</span>

    <span class="i">$Child</span>{<span class="q">'Child'</span>} = <span class="s">{</span> <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Plate LEFT JOIN Plate_Tray on FK_Plate__ID=Plate_ID'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="i">@field_list</span><span class="cm">,</span> <span class="q">'Plate_Position'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FKParent_Plate__ID IN ($plate_id) ORDER BY Plate_ID&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span> <span class="s">}</span><span class="sc">;</span>

    <span class="c">### also allow tracking through extractions, pooling, rearrays etc. ###</span>
    <span class="i">$Child</span>{<span class="q">'Rearray'</span>} = <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
            <span class="q">'Plate,ReArray_Request,ReArray'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FKTarget_Plate__ID as Plate_ID'</span><span class="cm">,</span> <span class="i">@field_list</span> <span class="s">]</span><span class="cm">,</span>
            <span class="q">&quot;WHERE FKSource_Plate__ID=Plate_ID AND FK_ReArray_Request__ID=ReArray_Request_ID AND ReArray_Type &lt;&gt;'Extraction Rearray' AND Plate_ID in ($plate_id) $follow_condition ORDER BY FKTarget_Plate__ID&quot;</span><span class="cm">,</span>
            -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">debug</span>    <span class="cm">=&gt;</span> <span class="i">$debug</span>
        <span class="s">)</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="i">$Child</span>{<span class="q">'Extraction'</span>} = <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
            <span class="q">'Plate,ReArray_Request,ReArray'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FKTarget_Plate__ID as Plate_ID'</span><span class="cm">,</span> <span class="i">@field_list</span> <span class="s">]</span><span class="cm">,</span>
            <span class="q">&quot;WHERE FKSource_Plate__ID=Plate_ID AND FK_ReArray_Request__ID=ReArray_Request_ID AND ReArray_Type = 'Extraction Rearray' AND Plate_ID in ($plate_id) $follow_condition ORDER BY FKSource_Plate__ID&quot;</span><span class="cm">,</span>
            -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">debug</span>    <span class="cm">=&gt;</span> <span class="i">$debug</span>
        <span class="s">)</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="i">$Child</span>{<span class="q">'Pooling'</span>} = <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
            <span class="q">'Plate,Sample_Pool,PoolSample'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FKTarget_Plate__ID as Plate_ID'</span><span class="cm">,</span> <span class="i">@field_list</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID=Plate_ID AND Sample_Pool.FK_Pool__ID=PoolSample.FK_Pool__ID AND Plate_ID in ($plate_id) $follow_condition ORDER BY FKTarget_Plate__ID&quot;</span><span class="cm">,</span>
            -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">debug</span>    <span class="cm">=&gt;</span> <span class="i">$debug</span>
        <span class="s">)</span>
    <span class="s">}</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@variations</span> = <span class="s">(</span><span class="q">'Child'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@variations</span><span class="cm">,</span> <span class="q">'Pooling'</span><span class="cm">,</span> <span class="q">'Rearray'</span><span class="cm">,</span> <span class="q">'Extraction'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$follow</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$array</span> <span class="s">(</span><span class="i">@variations</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="i">$Child</span>{<span class="i">$array</span>} <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>
        <span class="k">my</span> <span class="i">%Array</span> = <span class="i">%</span>{ <span class="i">$Child</span>{<span class="i">$array</span>} }<span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Array</span>{<span class="w">Plate_ID</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$id</span> = <span class="i">$Array</span>{<span class="w">Plate_ID</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">unless</span> <span class="s">(</span><span class="i">$id</span><span class="s">)</span> <span class="s">{</span> <span class="i">$index</span>++<span class="sc">;</span> <span class="k">next</span> <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$include</span> &amp;&amp; <span class="i">$include</span> !~ <span class="q">/\b$id\b/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$index</span>++<span class="sc">;</span> <span class="k">next</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## skip if not in supplied list</span>
            <span class="k">my</span> <span class="i">$pos</span>    = <span class="i">$Array</span>{<span class="w">Plate_Position</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$number</span> = <span class="i">$Array</span>{<span class="w">Pnum</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$pos</span> &amp;&amp; <span class="i">$match</span> =~ <span class="q">/^$number$pos$/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$group</span>[<span class="n">-1</span>] = <span class="q">&quot;$group[-1],$id&quot;</span> <span class="k">unless</span> <span class="s">(</span> <span class="i">$group</span>[<span class="n">-1</span>] =~ <span class="q">/\b$id\b/</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>                                                               <span class="c">## include with last plate</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@group</span><span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span> <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$id$/</span><span class="cm">,</span> <span class="i">@group</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">my</span> <span class="i">$lastpos</span> = <span class="i">$pos</span><span class="sc">;</span>
            <span class="i">$lastpos</span>++<span class="sc">;</span>
            <span class="i">$match</span> = <span class="q">&quot;$number$lastpos&quot;</span><span class="sc">;</span>                                     <span class="c">## if this matches the next plate, combine them together...</span>
            <span class="i">$index</span>++<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@group</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################################################</span>
<span class="c"># Simple plate icon showing basic plate information.</span>
<span class="c">#</span>
<span class="c"># &lt;CONSTRUCTION&gt; - need to adapt run example to apply to specific plates (or just show no grows etc.)</span>
<span class="c">#</span>
<span class="c"># Return: label.</span>
<span class="c">##############</span>
<a name="plate_icon-"></a><span class="k">sub </span><span class="m">plate_icon</span> <span class="s">{</span>
<span class="c">##############</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>   = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'highlight'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$highlight</span> = <span class="i">$args</span>{-<span class="w">highlight</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@idlist</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$id</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$label</span>  = <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$img</span>    = <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$suffix</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$index</span>  = <span class="n">1</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$Configs</span>{<span class="w">protocol_tracking</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span><span class="i">@idlist</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">%details</span> = <span class="i">%</span>{ <span class="i">get_birth_protocol</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$id</span> <span class="s">)</span> }<span class="sc">;</span>

            <span class="k">my</span> <span class="i">$runexample</span> = <span class="n">34447</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$details</span>{<span class="w">size</span>} =~ <span class="q">/384/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$runexample</span> = <span class="n">34449</span><span class="sc">;</span> <span class="s">}</span>

            <span class="i">$label</span> .= <span class="q">&quot;$id &quot;</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$prefix</span> = <span class="q">''</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$index</span> == <span class="n">2</span> || <span class="i">$index</span> == <span class="n">4</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$prefix</span> = <span class="q">' '</span><span class="sc">;</span> <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$index</span> == <span class="n">3</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$prefix</span> = <span class="q">&quot;&lt;BR&gt;&quot;</span><span class="sc">;</span> <span class="s">}</span>
            <span class="i">$index</span>++<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$project_path</span> = <span class="i">&amp;alDente::Run::get_data_path</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">run_id</span> <span class="cm">=&gt;</span> <span class="i">$runexample</span><span class="cm">,</span> -<span class="w">simple</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$img</span> .= <span class="q">&quot;$prefix&lt;Img Src='../dynamic/data_home/private/Projects/$project_path/phd_dir/Run$runexample.png'&gt;&quot;</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$created</span> = <span class="i">$details</span>{<span class="w">protocol_name</span>} || <span class="q">'(made o/s protocol)'</span><span class="sc">;</span>
            <span class="k">unless</span> <span class="s">(</span><span class="i">$suffix</span><span class="s">)</span> <span class="s">{</span>    <span class="c">## only add this once</span>
                <span class="i">$suffix</span> .= <span class="w">lbr</span> . <span class="i">$created</span><span class="sc">;</span>
                <span class="i">$suffix</span> .= <span class="w">lbr</span> . <span class="i">$details</span>{<span class="w">format</span>}<span class="sc">;</span>
            <span class="s">}</span>

            <span class="c">#    $label .= &quot;&lt;BR&gt;Format..&quot;;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$returnval</span> = <span class="q">&quot;$label&lt;BR&gt;$img&lt;BR&gt;$suffix&quot;</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$highlight</span><span class="s">)</span> <span class="s">{</span> <span class="i">$returnval</span> = <span class="q">&quot;&lt;Font color='red'&gt;$returnval&lt;/Font&gt;&quot;</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">return</span> <span class="i">$returnval</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># Inherit parent plate's attributes</span>
<span class="c">#</span>
<span class="c"># $self-&gt;inherit_attributes(-parent_id=&gt;$pid,-child_ids=&gt;$cids);</span>
<span class="c">#</span>
<span class="c"># Returns: number of records updated</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="inherit_attributes-"></a><span class="k">sub </span><span class="m">inherit_attributes</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span>       = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>        = <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'attributes'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$attributes</span> = <span class="i">$args</span>{-<span class="w">attributes</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} || <span class="i">$self</span><span class="i">-&gt;primary_value</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># check if this plate is an original plate. If it isn't, use parent's plate number</span>

    <span class="k">my</span> <span class="i">@parent</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> <span class="q">&quot;FKParent_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID=$plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ok</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@parent</span><span class="s">)</span> == <span class="n">1</span> &amp;&amp; <span class="i">$parent</span>[<span class="n">0</span>] != <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># simple case - one parent only</span>
        <span class="k">my</span> <span class="i">$parent_id</span> = <span class="i">$parent</span>[<span class="n">0</span>]<span class="sc">;</span>

        <span class="k">my</span> <span class="i">$attributes_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$attributes</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$attrib_condition</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$attributes_list</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$attrib_condition</span> = <span class="q">&quot; and Attribute_Name in ($attributes_list) &quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">my</span> <span class="i">%inherited_attributes</span>
            = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">&quot;Plate_Attribute,Attribute&quot;</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FK_Attribute__ID'</span><span class="cm">,</span> <span class="q">'Attribute_Value'</span><span class="cm">,</span> <span class="q">'FK_Employee__ID'</span><span class="cm">,</span> <span class="q">'Set_DateTime'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Attribute__ID=Attribute_ID AND Inherited = 'Yes' AND FK_Plate__ID = $parent_id $attrib_condition&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@fields</span> = <span class="s">(</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'FK_Attribute__ID'</span><span class="cm">,</span> <span class="q">'Attribute_Value'</span><span class="cm">,</span> <span class="q">'FK_Employee__ID'</span><span class="cm">,</span> <span class="q">'Set_DateTime'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">%attr_values</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$inherited_attributes</span>{<span class="w">FK_Attribute__ID</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">@values</span> = <span class="s">(</span><span class="i">$plate_id</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$inherited_attributes</span>{<span class="w">FK_Attribute__ID</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$inherited_attributes</span>{<span class="w">Attribute_Value</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$inherited_attributes</span>{<span class="w">FK_Employee__ID</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$inherited_attributes</span>{<span class="w">Set_DateTime</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="i">$attr_values</span>{ ++<span class="i">$index</span> } = \<span class="i">@values</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$dbc</span><span class="i">-&gt;smart_append</span><span class="s">(</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="q">&quot;Plate_Attribute&quot;</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> \<span class="i">@fields</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> \<span class="i">%attr_values</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@parent</span><span class="s">)</span> &gt; <span class="n">1</span> &amp;&amp; <span class="i">$parent</span>[<span class="n">0</span>] != <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$ok</span> = <span class="i">$self</span><span class="i">-&gt;inherit_Attribute</span><span class="s">(</span> -<span class="w">parent_ids</span> <span class="cm">=&gt;</span> \<span class="i">@parent</span><span class="cm">,</span> -<span class="w">child_ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="q">'FK_Employee__ID'</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span> <span class="s">}</span><span class="cm">,</span> -<span class="w">attributes</span> <span class="cm">=&gt;</span> <span class="i">$attributes</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@parent_ids</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Sample_Pool,PoolSample&quot;</span><span class="cm">,</span> <span class="q">&quot;FK_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_Pool.FK_Pool__ID = PoolSample.FK_Pool__ID AND FKTarget_Plate__ID=$plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@parent_ids</span><span class="s">)</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c"># check for rearrays</span>
            <span class="i">@parent_ids</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;ReArray_Request,ReArray&quot;</span><span class="cm">,</span> <span class="q">&quot;FKSource_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_ReArray_Request__ID = ReArray_Request_ID AND FKTarget_Plate__ID=$plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@parent_ids</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$ok</span> = <span class="i">$self</span><span class="i">-&gt;inherit_Attribute</span><span class="s">(</span> -<span class="w">parent_ids</span> <span class="cm">=&gt;</span> \<span class="i">@parent_ids</span><span class="cm">,</span> -<span class="w">child_ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="q">'FK_Employee__ID'</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span> <span class="s">}</span><span class="cm">,</span> -<span class="w">attributes</span> <span class="cm">=&gt;</span> <span class="i">$attributes</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$ok</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># This function changes the work_request of the plate.</span>
<span class="c"># It takes all selected downstream plates and changes the work_request to the sameone.</span>
<span class="c"># This also updates the Invoiceable_Work items that may be on the plate</span>
<span class="c">#</span>
<span class="c"># Returns: number of plate records updated</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="inherit_funding-"></a><span class="k">sub </span><span class="m">inherit_funding</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">$self</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'attributes'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} || <span class="i">$self</span><span class="i">-&gt;primary_value</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>    = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="i">$debug</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@parent</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> <span class="q">&quot;FKParent_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID=$plate_id &quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parents</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@parent</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@work_request</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> <span class="q">&quot;FK_Work_Request__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($parents) AND FK_Work_Request__ID IS NOT NULL&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$work_requests</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@work_request</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@work_request</span><span class="s">)</span> != <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Warning: Cannot inherent Work_Request&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'FK_Work_Request__ID'</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="q">&quot;$work_requests&quot;</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID = $plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$ok</span> &amp;&amp; <span class="i">$debug</span> <span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Plate Updated: $plate_id Parent Plate: @parent Work_Request: $work_requests&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$funding</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Work_Request&quot;</span><span class="cm">,</span> <span class="q">&quot;FK_Funding__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Work_Request_ID = $work_requests&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@ok2</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">&quot;Invoiceable_Work&quot;</span><span class="cm">,</span> <span class="s">[</span><span class="q">&quot;FKApplicable_Funding__ID&quot;</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="q">&quot;$funding&quot;</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID = $plate_id OR FK_Plate__ID in ($parents)&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">@ok2</span> &amp;&amp; <span class="i">$debug</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$iw</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Invoiceable_Work&quot;</span><span class="cm">,</span> <span class="q">&quot;Invoiceable_Work_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID = $plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$iw</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Invoiceable_Work Updated: $iw Funding: $funding&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$ok</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># Inherit parent plate's attributes in batch</span>
<span class="c">#</span>
<span class="c"># alDente::Container::batch_inherit_attributes(-ids=&gt;$ids);</span>
<span class="c">#</span>
<span class="c"># Returns: number of records updated</span>
<span class="c">#</span>
<span class="c">#########################</span>
<a name="batch_inherit_attributes-"></a><span class="k">sub </span><span class="m">batch_inherit_attributes</span> <span class="s">{</span>
<span class="c">#########################</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>        = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>         = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>                                <span class="c"># array ref</span>
    <span class="k">my</span> <span class="i">$attributes</span> = <span class="i">$args</span>{-<span class="w">attributes</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'Array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$id</span> || <span class="i">$plate_list</span> <span class="k">eq</span> <span class="q">&quot;''&quot;</span> <span class="s">)</span> <span class="s">{</span><span class="k">return</span><span class="s">}</span>                 <span class="c"># empty string</span>

    <span class="c">## check if this plate is an original plate. If it isn't, use parent's plate number</span>

    <span class="c">## get parents for each plate</span>
    <span class="k">my</span> <span class="i">@parents</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> <span class="q">&quot;Plate_ID,FKParent_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID in ( $plate_list)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%parents</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$parent_info</span> <span class="s">(</span><span class="i">@parents</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$plate_id</span><span class="cm">,</span> <span class="i">$parent_id</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$parent_info</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$parent_id</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$parents</span>{<span class="i">$plate_id</span>} = <span class="i">$parent_id</span><span class="sc">;</span>                   <span class="c"># no multiple parents in this case</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">## separate plates with a parent and plates without FKParent_Plate__ID</span>
    <span class="k">my</span> <span class="i">@no_FKParent</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span><span class="i">@ids</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">exists</span> <span class="i">$parents</span>{<span class="i">$id</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@no_FKParent</span><span class="cm">,</span> <span class="i">$id</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$ok</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="c">## the plates with a parent go to the simple case</span>
    <span class="k">my</span> <span class="i">@plates_with_parent</span> = <span class="k">keys</span> <span class="i">%parents</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@plates_with_parent</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$with_parent_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@plates_with_parent</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#Message( &quot;list: $with_parent_list&quot;);</span>

        <span class="k">my</span> <span class="i">$extra_condition</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$attributes</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$attributes</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$attributes</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$extra_condition</span> .= <span class="q">&quot; AND Attribute_Name IN ($attributes) &quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c">## CANNOT do it in one command since plates may have attributes set already and the existing attributes need to be excluded. Replaced this block with the loop through @plates_with_parent</span>
        <span class="c">##</span>
        <span class="c">#my $command = &quot;INSERT INTO Plate_Attribute (FK_Plate__ID, FK_Attribute__ID, Attribute_Value, FK_Employee__ID, Set_DateTime)&quot;</span>
        <span class="c">#			. &quot; SELECT Plate_ID, FK_Attribute__ID, Attribute_Value, Plate_Attribute.FK_Employee__ID, Set_DateTime&quot;</span>
        <span class="c">#			. &quot; FROM Plate, Plate_Attribute, Attribute&quot;</span>
        <span class="c">#			. &quot; WHERE Plate_ID in ( $with_parent_list ) AND FKParent_Plate__ID = Plate_Attribute.FK_Plate__ID AND FK_Attribute__ID=Attribute_ID AND Inherited = 'Yes' $extra_condition&quot;;</span>
        <span class="c">#$ok = $dbc-&gt;execute_command( -command =&gt; $command );</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$plate_id</span> <span class="s">(</span><span class="i">@plates_with_parent</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$additional_condition</span> = <span class="i">$extra_condition</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">@existing_attributes</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate_Attribute&quot;</span><span class="cm">,</span> <span class="q">&quot;FK_Attribute__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID = $plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@existing_attributes</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$existing_attribute_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@existing_attributes</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$additional_condition</span> .= <span class="q">&quot; and FK_Attribute__ID not in ($existing_attribute_list)&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">my</span> <span class="i">$command</span>
                = <span class="q">&quot;INSERT INTO Plate_Attribute (FK_Plate__ID, FK_Attribute__ID, Attribute_Value, FK_Employee__ID, Set_DateTime)&quot;</span>
                . <span class="q">&quot; SELECT Plate_ID, FK_Attribute__ID, Attribute_Value, Plate_Attribute.FK_Employee__ID, Set_DateTime&quot;</span>
                . <span class="q">&quot; FROM Plate, Plate_Attribute, Attribute&quot;</span>
                . <span class="q">&quot; WHERE Plate_ID = $plate_id AND FKParent_Plate__ID = Plate_Attribute.FK_Plate__ID AND FK_Attribute__ID=Attribute_ID AND Inherited = 'Yes' $additional_condition&quot;</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$insert_count</span> = <span class="i">$dbc</span><span class="i">-&gt;execute_command</span><span class="s">(</span> -<span class="w">command</span> <span class="cm">=&gt;</span> <span class="i">$command</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$ok</span> += <span class="i">$insert_count</span><span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

    <span class="c">## handle the plates without FKParent_Plate__ID</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@no_FKParent</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$plate_id</span> <span class="s">(</span><span class="i">@no_FKParent</span><span class="s">)</span> <span class="s">{</span>

            <span class="c"># check pools</span>
            <span class="k">my</span> <span class="i">@parent_ids</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Sample_Pool,PoolSample&quot;</span><span class="cm">,</span> <span class="q">&quot;FKTarget_Plate__ID,FK_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_Pool.FK_Pool__ID = PoolSample.FK_Pool__ID AND FKTarget_Plate__ID=$plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@parent_ids</span><span class="s">)</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>

                <span class="c"># check rearrays</span>
                <span class="i">@parent_ids</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;ReArray_Request,ReArray&quot;</span><span class="cm">,</span> <span class="q">&quot;FKTarget_Plate__ID,FKSource_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_ReArray_Request__ID = ReArray_Request_ID AND FKTarget_Plate__ID=$plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@parent_ids</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$plate_obj</span> = <span class="i">new</span> <span class="i">alDente::Container</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">quick_load</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$ok</span> = <span class="i">$plate_obj</span><span class="i">-&gt;inherit_Attribute</span><span class="s">(</span> -<span class="w">parent_ids</span> <span class="cm">=&gt;</span> \<span class="i">@parent_ids</span><span class="cm">,</span> -<span class="w">child_ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="q">'FK_Employee__ID'</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span> <span class="s">}</span><span class="cm">,</span> -<span class="w">attributes</span> <span class="cm">=&gt;</span> <span class="i">$attributes</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$ok</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># update the Plate information of a Plate</span>
<span class="c">#</span>
<span class="c"># $self-&gt;update_plate_info();</span>
<span class="c">#</span>
<span class="c"># Returns: number of records updated</span>
<span class="c">#</span>
<span class="c">##############################</span>
<a name="update_plate_info-"></a><span class="k">sub </span><span class="m">update_plate_info</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">$self</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'number,label'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$number</span>   = <span class="i">$args</span>{-<span class="w">number</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$label</span>    = <span class="i">$args</span>{-<span class="w">label</span>} || <span class="i">param</span><span class="s">(</span><span class="q">'Target Plate Label'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># check if this plate is an original plate. If it isn't, use parent's plate number</span>

    <span class="k">my</span> <span class="i">$updated</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$plate_info</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span>
        <span class="q">&quot;Plate LEFT JOIN Plate as Parent On Parent.Plate_ID = Plate.FKParent_Plate__ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;Plate.FKParent_Plate__ID, Plate.FK_Rack__ID, Plate.FK_Library__Name, Plate.Plate_Created, Plate.Plate_Label, Parent.FK_Work_Request__ID,Parent.Plate_Number,Parent.Plate_Label&quot;</span><span class="cm">,</span>
        <span class="q">&quot;where Plate.Plate_ID=$plate_id&quot;</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$parent_id</span><span class="cm">,</span> <span class="i">$rack_id</span><span class="cm">,</span> <span class="i">$lib</span><span class="cm">,</span> <span class="i">$created</span><span class="cm">,</span> <span class="i">$plate_label</span><span class="cm">,</span> <span class="i">$parent_work_request</span><span class="cm">,</span> <span class="i">$parent_num</span><span class="cm">,</span> <span class="i">$parent_label</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$plate_info</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@update_fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@update_values</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$parent_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## Inherit the plate scheduling</span>
        <span class="k">require</span> <span class="w">alDente::Plate_Schedule</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$plate_schedule</span> = <span class="w">alDente::Plate_Schedule</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$plate_schedule</span><span class="i">-&gt;inherit_plate_schedule</span><span class="s">(</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">## Inherit the plate FK_Work_Request__ID</span>
        <span class="c">## Find the parent plate</span>

        <span class="c">## Add the FK_Work_Request__ID for the plate</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$parent_work_request</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@update_fields</span><span class="cm">,</span> <span class="q">'FK_Work_Request__ID'</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@update_values</span><span class="cm">,</span> <span class="i">$parent_work_request</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$self</span><span class="i">-&gt;inherit_Parent_fields</span><span class="s">(</span> -<span class="w">daughter</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">parent</span> <span class="cm">=&gt;</span> <span class="i">$parent_id</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">push</span><span class="s">(</span> <span class="i">@update_fields</span><span class="cm">,</span> <span class="q">'Plate_Number'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@update_values</span><span class="cm">,</span> <span class="i">$parent_num</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="i">$label</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## inherit label from parent if not specified ##</span>
            <span class="i">$label</span> = <span class="i">$parent_label</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>

        <span class="c"># count all original plates in the same library that is not this plate</span>
        <span class="k">my</span> <span class="i">$next_num</span> = <span class="i">alDente::Library::get_next_plate_number</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$lib</span><span class="cm">,</span> <span class="i">$number</span><span class="cm">,</span> -<span class="w">exclude</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span> <span class="s">)</span> || <span class="n">1</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@update_fields</span><span class="cm">,</span> <span class="q">'Plate_Number'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@update_values</span><span class="cm">,</span> <span class="i">$next_num</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$label</span> &amp;&amp; !<span class="i">$plate_label</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@update_fields</span><span class="cm">,</span> <span class="q">'Plate_Label'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@update_values</span><span class="cm">,</span> <span class="i">$label</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$rack_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$tbd_rack</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Rack,Equipment'</span><span class="cm">,</span> <span class="q">'Rack_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Equipment__ID=Equipment_ID AND Rack_Name='Temporary' LIMIT 1&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$tbd_rack</span> ||= <span class="n">1</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@update_fields</span><span class="cm">,</span> <span class="q">'FK_Rack__ID'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@update_values</span><span class="cm">,</span> <span class="i">$tbd_rack</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$created</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## set plate creation date if not already defined ##</span>
        <span class="k">my</span> <span class="i">$time</span> = <span class="i">date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@update_fields</span><span class="cm">,</span> <span class="q">'Plate_Created'</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@update_values</span><span class="cm">,</span> <span class="i">$time</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">################ commented out the block below, need to revisit the logic for this and intended behavior LIMS-8914 #############</span>
    <span class="c">#my $format_id = $self-&gt;value('Plate.FK_Plate_Format__ID');</span>
    <span class="c">#my @pipelines = $dbc-&gt;Table_find( 'Pipeline', 'Pipeline_ID', &quot;WHERE FKApplicable_Plate_Format__ID = $format_id&quot; );</span>
    <span class="c">#if ( int(@pipelines) == 1 ) {</span>
    <span class="c">#    ## only one defined pipeline for this given plate format ##</span>
    <span class="c">#    push @update_fields, 'FK_Pipeline__ID';</span>
    <span class="c">#    push @update_values, $pipelines[0];</span>
    <span class="c">#}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">@update_fields</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$updated</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> \<span class="i">@update_fields</span><span class="cm">,</span> \<span class="i">@update_values</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID=$plate_id&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#    else { Message(&quot;nothing to update&quot;) }</span>

    <span class="k">return</span> <span class="i">$updated</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<a name="update_Plate_volumes-"></a><span class="k">sub </span><span class="m">update_Plate_volumes</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">%args</span>         = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,id'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'self|dbc'</span><span class="cm">,</span> -<span class="w">self</span> <span class="cm">=&gt;</span> <span class="q">'alDente::Container'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$self</span>         = <span class="i">$args</span>{-<span class="w">self</span>}<span class="sc">;</span>                                                                                       <span class="c">## enable use as either method or function</span>
    <span class="k">my</span> <span class="i">$dbc</span>          = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span>          = <span class="i">$args</span>{-<span class="w">ids</span>} || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$volume</span>       = <span class="i">$args</span>{-<span class="w">volume</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$volume_units</span> = <span class="i">$args</span>{-<span class="w">units</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$status</span>       = <span class="i">$args</span>{-<span class="w">status</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$initialize</span>   = <span class="i">$args</span>{-<span class="w">initialize</span>}<span class="sc">;</span>                                                                                 <span class="c">## required to update volumes if not currently empty or null</span>
    <span class="k">my</span> <span class="i">$force</span>        = <span class="i">$args</span>{-<span class="w">force</span>}<span class="sc">;</span>                                                                                      <span class="c">## update volumes even if current volume is zero (otherwise will only update when existing volume is non-zero)</span>
    <span class="k">my</span> <span class="i">$debug</span>        = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$negative</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$volume</span> =~ <span class="q">/^\-(.+)$/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$negative</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="i">$volume</span>   = <span class="i">$1</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$fields</span> = <span class="i">$args</span>{-<span class="w">fields</span>}   || <span class="s">[</span><span class="s">]</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$values</span> = <span class="i">$args</span>{ -<span class="k">values</span> } || <span class="s">[</span><span class="s">]</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$volume</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="n">0</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">@ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pad</span> = <span class="k">int</span><span class="s">(</span><span class="i">@ids</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@volumes</span>       = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$volume</span><span class="cm">,</span>       -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">pad</span> <span class="cm">=&gt;</span> <span class="i">$pad</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@volumes_units</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$volume_units</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span><span class="cm">,</span> -<span class="w">pad</span> <span class="cm">=&gt;</span> <span class="i">$pad</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$updated</span>       = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$index</span>         = <span class="n">0</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span><span class="i">@ids</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$condition</span> = <span class="q">&quot;WHERE Plate_ID = $id&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$initialize</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$condition</span> .= <span class="q">&quot; AND Current_Volume &gt; 0&quot;</span> <span class="s">}</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$current_qty</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Current_Volume,Current_Volume_Units'</span><span class="cm">,</span> <span class="i">$condition</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$current_volume</span><span class="cm">,</span> <span class="i">$current_volume_units</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$current_qty</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$volume</span> = <span class="i">$volumes</span>[<span class="i">$index</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$volume_units</span> = <span class="i">$volumes_units</span>[<span class="i">$index</span>] || <span class="i">$volumes_units</span>[<span class="n">0</span>]<span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$volume</span> <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$negative</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$volume</span> = <span class="q">'-'</span> . <span class="i">$volume</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$add_volume</span><span class="cm">,</span> <span class="i">$add_volume_units</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$current_volume</span> &amp;&amp; <span class="i">$volume</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$add_volume</span><span class="cm">,</span> <span class="i">$add_volume_units</span> <span class="s">)</span> = <span class="i">RGTools::Conversion::add_amounts</span><span class="s">(</span> -<span class="w">qty1</span> <span class="cm">=&gt;</span> <span class="i">$current_volume</span><span class="cm">,</span> -<span class="w">units1</span> <span class="cm">=&gt;</span> <span class="i">$current_volume_units</span><span class="cm">,</span> -<span class="w">qty2</span> <span class="cm">=&gt;</span> <span class="i">$volume</span><span class="cm">,</span> -<span class="w">units2</span> <span class="cm">=&gt;</span> <span class="i">$volume_units</span><span class="cm">,</span> -<span class="w">check_negative</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Updating Qty: $current_volume $current_volume_units + $volume $volume_units = $add_volume $add_volume_units&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span><span class="i">$force</span><span class="s">)</span> <span class="s">{</span>
            <span class="c">### force volume update even if current volume not defined ##</span>
            <span class="s">(</span> <span class="i">$add_volume</span><span class="cm">,</span> <span class="i">$add_volume_units</span> <span class="s">)</span> = <span class="s">(</span> <span class="i">$volume</span><span class="cm">,</span> <span class="i">$volume_units</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">@local_fields</span> = <span class="i">@$fields</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@local_values</span> = <span class="i">@$values</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$add_volume</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@local_fields</span><span class="cm">,</span> <span class="s">(</span> <span class="q">'Current_Volume'</span><span class="cm">,</span> <span class="q">'Current_Volume_Units'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@local_values</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$add_volume</span><span class="cm">,</span> <span class="i">$add_volume_units</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">@local_fields</span><span class="s">)</span> <span class="s">{</span> <span class="i">$updated</span> += <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> \<span class="i">@local_fields</span><span class="cm">,</span> \<span class="i">@local_values</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID = $id&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span> <span class="s">}</span>
        <span class="i">$index</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$updated</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################</span>
<span class="c">#</span>
<span class="c"># A button which is used in the Invoiceable_Work_Missing_Funding view</span>
<span class="c"># Given a plate you set the Work_Request</span>
<span class="c"># Also updates the funding for any Invoiceable_Work item that it is attached to.</span>
<span class="c">#</span>
<span class="c"># returns button</span>
<span class="c">##############################</span>
<a name="set_work_request_btn-"></a><span class="k">sub </span><span class="m">set_work_request_btn</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$work_request_list</span> = <span class="q">&quot;  Work Request: &quot;</span> . <span class="i">&amp;alDente::Tools::search_list</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'FK_Work_Request__ID'</span><span class="cm">,</span> -<span class="w">filter_by_dept</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">search</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">filter</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">##Opens a new tab when you click on it</span>
    <span class="c">##Have read that &quot;_blank&quot; expression might not work with internet explorer</span>
    <span class="k">my</span> <span class="i">$onClick</span> = <span class="q">&quot;sub_cgi_app( 'alDente::Container_App' )&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$form_output</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="i">$form_output</span> .= <span class="i">Show_Tool_Tip</span><span class="s">(</span> <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'rm'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'Set Work Request'</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Action'</span><span class="cm">,</span> -<span class="w">onClick</span> <span class="cm">=&gt;</span> <span class="i">$onClick</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="cm">,</span> <span class="q">&quot;Add a work request to a plate&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$form_output</span> .= <span class="i">$work_request_list</span><span class="sc">;</span>
    <span class="i">$form_output</span> .= <span class="i">hidden</span><span class="s">(</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="q">'sub_cgi_application'</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$form_output</span> .= <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'DISPLAY_SUB_CGI_PAGE'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'true'</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$form_output</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<span class="c"># Set volume to 0 for all the plates</span>
<span class="c"># Return total volume emptied</span>
<span class="c">############################</span>
<a name="empty_Plate_volumes-"></a><span class="k">sub </span><span class="m">empty_Plate_volumes</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,id'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'self|dbc'</span><span class="cm">,</span> -<span class="w">self</span> <span class="cm">=&gt;</span> <span class="q">'alDente::Container'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$self</span>       = <span class="i">$args</span>{-<span class="w">self</span>}<span class="sc">;</span>                                                                                       <span class="c">## enable use as either method or function</span>
    <span class="k">my</span> <span class="i">$dbc</span>        = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span>        = <span class="i">$args</span>{-<span class="w">ids</span>} || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>}<span class="sc">;</span>                                                                   <span class="c">## required to update volumes if not currently empty or null</span>
    <span class="k">my</span> <span class="i">$initialize</span> = <span class="i">$args</span>{-<span class="w">initialize</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>      = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pad</span> = <span class="k">int</span><span class="s">(</span><span class="i">@ids</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$fields</span> = <span class="i">$args</span>{-<span class="w">fields</span>}   || <span class="s">[</span><span class="s">]</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$values</span> = <span class="i">$args</span>{ -<span class="k">values</span> } || <span class="s">[</span><span class="s">]</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$updated</span>            = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$total_volume</span>       = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$total_volume_units</span> = <span class="q">'ml'</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span><span class="i">@ids</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$condition</span> = <span class="q">&quot;WHERE Plate_ID = $id&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$initialize</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$condition</span> .= <span class="q">&quot; AND Current_Volume &gt; 0&quot;</span> <span class="s">}</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$current_qty</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Current_Volume,Current_Volume_Units'</span><span class="cm">,</span> <span class="i">$condition</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$current_volume</span><span class="cm">,</span> <span class="i">$current_volume_units</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$current_qty</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="i">$current_volume</span> <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$add_volume</span><span class="cm">,</span> <span class="i">$add_volume_units</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$current_volume</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$add_volume</span><span class="cm">,</span> <span class="i">$add_volume_units</span> <span class="s">)</span> = <span class="i">RGTools::Conversion::add_amounts</span><span class="s">(</span> -<span class="w">qty1</span> <span class="cm">=&gt;</span> <span class="i">$current_volume</span><span class="cm">,</span> -<span class="w">units1</span> <span class="cm">=&gt;</span> <span class="i">$current_volume_units</span><span class="cm">,</span> -<span class="w">qty2</span> <span class="cm">=&gt;</span> <span class="q">&quot;-$current_volume&quot;</span><span class="cm">,</span> -<span class="w">units2</span> <span class="cm">=&gt;</span> <span class="i">$current_volume_units</span><span class="cm">,</span> -<span class="w">check_negative</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Updating Qty: $current_volume $current_volume_units - $current_volume $current_volume_units = $add_volume $add_volume_units&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="s">(</span> <span class="i">$total_volume</span><span class="cm">,</span> <span class="i">$total_volume_units</span> <span class="s">)</span> = <span class="i">RGTools::Conversion::add_amounts</span><span class="s">(</span> -<span class="w">qty1</span> <span class="cm">=&gt;</span> <span class="i">$total_volume</span><span class="cm">,</span> -<span class="w">units1</span> <span class="cm">=&gt;</span> <span class="i">$total_volume_units</span><span class="cm">,</span> -<span class="w">qty2</span> <span class="cm">=&gt;</span> <span class="i">$current_volume</span><span class="cm">,</span> -<span class="w">units2</span> <span class="cm">=&gt;</span> <span class="i">$current_volume_units</span><span class="cm">,</span> -<span class="w">check_negative</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">@local_fields</span> = <span class="i">@$fields</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@local_values</span> = <span class="i">@$values</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@local_fields</span><span class="cm">,</span> <span class="s">(</span> <span class="q">'Current_Volume'</span><span class="cm">,</span> <span class="q">'Current_Volume_Units'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@local_values</span><span class="cm">,</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$add_volume_units</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">@local_fields</span><span class="s">)</span> <span class="s">{</span> <span class="i">$updated</span> += <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> \<span class="i">@local_fields</span><span class="cm">,</span> \<span class="i">@local_values</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID = $id&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$total_volume</span><span class="cm">,</span> <span class="i">$total_volume_units</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###################</span>
<a name="get_source-"></a><span class="k">sub </span><span class="m">get_source</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="c">#</span>
    <span class="c"># Retrieve original source information</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$id</span>  = <span class="i">$args</span>{-<span class="w">id</span>}  || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Ancestry</span> = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## add parents to Ancestry</span>

    <span class="k">return</span> <span class="i">$Ancestry</span>{<span class="w">original</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################################</span>
<span class="c">#  Defining and Creating New Plates</span>
<span class="c">##############################################</span>

<span class="c">##############################</span>
<a name="obsolete_add_Record-"></a><span class="k">sub </span><span class="m">obsolete_add_Record</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="c">#</span>
    <span class="c"># Add new Record given hash containing attributes.</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$attributes</span> = <span class="i">$args</span>{-<span class="w">attributes</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Return</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="i">$Return</span>{<span class="w">errors</span>}   = <span class="q">''</span><span class="sc">;</span>
    <span class="i">$Return</span>{<span class="w">plate_id</span>} = <span class="q">''</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Info</span> = <span class="i">%</span>{<span class="i">$attributes</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@fields</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$field</span> <span class="s">(</span> <span class="i">$self</span><span class="i">-&gt;fields</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Info</span>{<span class="i">$field</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$value</span> = <span class="i">$Info</span>{<span class="i">$field</span>}<span class="sc">;</span>

            <span class="k">if</span> <span class="s">(</span> <span class="i">check_foreign_key</span><span class="s">(</span><span class="i">$field</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$value</span> = <span class="i">get_FK_ID</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$field</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## Convert to ID if descriptive FK used</span>
            <span class="s">}</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@fields</span><span class="cm">,</span> <span class="i">$field</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@values</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">### Append database if no errors encountered so far ###</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="i">$Return</span>{<span class="w">errors</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@fields</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$newid</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="i">$self</span>-&gt;{<span class="w">tables</span>}<span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> \<span class="i">@values</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$newid</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$Return</span>{<span class="w">id</span>} = <span class="i">$newid</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$Return</span>{<span class="w">errors</span>} .= <span class="q">&quot;Unable to append Table ($DBI::errstr)&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$Return</span>{<span class="w">errors</span>} .= <span class="q">&quot;No Fields entered\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">%Return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<span class="c">## Extract Information ##</span>
<span class="c">#########################</span>

<span class="c">######################</span>
<a name="link_source_details-"></a><span class="k">sub </span><span class="m">link_source_details</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$file</span> = <span class="i">$args</span>{-<span class="w">file</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$file</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## file provided - open and check information ##</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="c">## prompt user to select file ##</span>
        <span class="k">print</span> <span class="i">Views::Heading</span><span class="s">(</span><span class="q">&quot;Select Source Details file for this plate&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<a name="get_Solutions-"></a><span class="k">sub </span><span class="m">get_Solutions</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="c">#</span>
    <span class="c"># get list of solutions applied to container(s)</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ids</span>      = <span class="i">$args</span>{-<span class="w">ids</span>}      || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} || <span class="n">0</span><span class="sc">;</span>    <span class="c">## plate_id (or list)</span>
    <span class="k">my</span> <span class="i">$reagents</span> = <span class="i">$args</span>{-<span class="w">reagents</span>} || <span class="n">0</span><span class="sc">;</span>                         <span class="c">## extract original reagents from mixture records</span>
    <span class="k">my</span> <span class="i">$order</span>    = <span class="i">$args</span>{-<span class="w">order</span>}    || <span class="q">''</span><span class="sc">;</span>                        <span class="c">## not yet set up</span>

    <span class="k">my</span> <span class="i">$Used</span>      = <span class="i">$self</span><span class="i">-&gt;get_Applications</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@used_list</span> = <span class="k">keys</span> <span class="i">%$Used</span><span class="sc">;</span>

    <span class="k">return</span> \<span class="i">@used_list</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">################</span>
<a name="get_Applications-"></a><span class="k">sub </span><span class="m">get_Applications</span> <span class="s">{</span>
<span class="c">################</span>
    <span class="c">#</span>
    <span class="c"># get list of applications to container(s)</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'ids'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'ids'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>}      || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span>      = <span class="i">$args</span>{-<span class="w">ids</span>}      || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} || <span class="n">0</span><span class="sc">;</span>    <span class="c">## plate_id (or list)</span>
    <span class="k">my</span> <span class="i">$reagents</span> = <span class="i">$args</span>{-<span class="w">reagents</span>} || <span class="n">0</span><span class="sc">;</span>                         <span class="c">## extract original reagents from mixture records</span>
    <span class="k">my</span> <span class="i">$order</span>    = <span class="i">$args</span>{-<span class="w">order</span>}    || <span class="q">''</span><span class="sc">;</span>                        <span class="c">## not yet set up</span>

    <span class="k">my</span> <span class="i">@Applied</span>
        = <span class="i">$dbc</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> <span class="q">'Plate_Prep,Prep'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Plate_Prep.FK_Solution__ID as Solution_ID'</span><span class="cm">,</span> <span class="q">'FK_Prep__ID'</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'Plate_Prep.Solution_Quantity'</span><span class="cm">,</span> <span class="q">'Solution_Quantity_Units'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Prep__ID=Prep_ID AND FK_Plate__ID in ($ids)&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Used</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$reagents</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## look further for original reagent components of solutions...</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$solution</span> <span class="s">(</span><span class="i">@Applied</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$sol_id</span><span class="cm">,</span> <span class="i">$prep_id</span><span class="cm">,</span> <span class="i">$plate_id</span><span class="cm">,</span> <span class="i">$used</span><span class="cm">,</span> <span class="i">$units</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$solution</span><span class="sc">;</span>
            <span class="i">$prep_id</span> ||= <span class="q">'0'</span><span class="sc">;</span>
            <span class="i">$used</span>    ||= <span class="n">0</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">@reagents</span> = <span class="i">&amp;alDente::Solution::get_original_reagents</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$sol_id</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">map</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$id</span> = <span class="i">$_</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$id</span> != <span class="i">$sol_id</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$id</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$Used</span>{<span class="i">$plate_id</span>}{<span class="i">$prep_id</span>}{<span class="w">original_reagent</span>}{<span class="i">$id</span>} = <span class="q">&quot;(?/$used)&quot;</span> <span class="s">}</span>
                <span class="k">else</span>                                            <span class="s">{</span> <span class="i">$Used</span>{<span class="i">$plate_id</span>}{<span class="i">$prep_id</span>}{<span class="w">original_reagent</span>}{<span class="n">0</span>}++<span class="sc">;</span> <span class="s">}</span>
            <span class="s">}</span> <span class="i">@reagents</span><span class="sc">;</span>
            <span class="i">$Used</span>{<span class="i">$plate_id</span>}{<span class="i">$prep_id</span>}{<span class="w">applied</span>}{<span class="i">$sol_id</span>} = <span class="i">$used</span> . <span class="q">&quot; &quot;</span> . <span class="i">$units</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$solution</span> <span class="s">(</span><span class="i">@Applied</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$sol_id</span><span class="cm">,</span> <span class="i">$prep_id</span><span class="cm">,</span> <span class="i">$plate_id</span><span class="cm">,</span> <span class="i">$used</span><span class="cm">,</span> <span class="i">$units</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$solution</span><span class="sc">;</span>
            <span class="i">$prep_id</span> ||= <span class="q">'0'</span><span class="sc">;</span>
            <span class="i">$used</span>    ||= <span class="n">0</span><span class="sc">;</span>
            <span class="i">$Used</span>{<span class="i">$plate_id</span>}{<span class="i">$prep_id</span>}{<span class="w">applied</span>}{<span class="i">$sol_id</span>} = <span class="i">$used</span> . <span class="q">&quot; &quot;</span> . <span class="i">$units</span><span class="sc">;</span>
            <span class="i">$Used</span>{<span class="i">$plate_id</span>}{<span class="i">$prep_id</span>}{<span class="w">original_reagent</span>}{<span class="n">0</span>}++<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">@used_list</span> = <span class="k">keys</span> <span class="i">%Used</span><span class="sc">;</span>

    <span class="k">return</span> \<span class="i">%Used</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################</span>
<a name="get_Preps-"></a><span class="k">sub </span><span class="m">get_Preps</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="c">#</span>
    <span class="c"># get list of solutions applied to container(s)</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'ids'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>} || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>} || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$field_ref</span> = <span class="i">$args</span>{-<span class="w">fields</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$reagents</span>  = <span class="i">$args</span>{-<span class="w">reagents</span>} || <span class="n">0</span><span class="sc">;</span>    <span class="c">## extract reagents from mixture records</span>
    <span class="k">my</span> <span class="i">$view</span>      = <span class="i">$args</span>{-<span class="w">view</span>} || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$step</span>      = <span class="i">$args</span>{-<span class="w">step</span>}<span class="sc">;</span>             <span class="c">## allow searching for specific step(s);</span>
    <span class="k">my</span> <span class="i">$history</span>   = <span class="i">$args</span>{-<span class="w">history</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$distinct</span>  = <span class="i">$args</span>{-<span class="w">distinct</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$extra_condition</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$step</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$step</span> =~ <span class="q">/,/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$step</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$step</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$extra_condition</span> .= <span class="q">&quot; AND Prep_Name in ($step)&quot;</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$step</span> =~ <span class="q">/\*/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Warning: cannot handle BOTH list and wildcard simultaneously (using list)&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$step</span> = <span class="i">convert_to_regexp</span><span class="s">(</span><span class="i">$step</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">$extra_condition</span> .= <span class="q">&quot; AND Prep_Name LIKE \&quot;$step\&quot;&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="i">$id</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Preps</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields</span> = <span class="s">(</span> <span class="q">'Prep_ID'</span><span class="cm">,</span> <span class="q">'Prep_Name'</span><span class="cm">,</span> <span class="q">'Prep_DateTime'</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">@fields</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$field_ref</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$field_ref</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$this_id</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## get parents is history flag set</span>
        <span class="k">my</span> <span class="i">$ids</span> = <span class="i">$this_id</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$history</span><span class="s">)</span> <span class="s">{</span> <span class="i">$ids</span> = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$this_id</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>

        <span class="c">### key on each input id at a time ###</span>
        <span class="k">my</span> <span class="i">%data</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Plate_Prep,Prep,Lab_Protocol'</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> <span class="q">&quot;where FK_Prep__ID=Prep_ID AND FK_Lab_Protocol__ID=Lab_Protocol_ID AND FK_Plate__ID in ($ids) $extra_condition&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="i">$distinct</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Preps</span>{<span class="i">$this_id</span>} = \<span class="i">%data</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">%Preps</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<a name="get_Sample-"></a><span class="k">sub </span><span class="m">get_Sample</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span>   = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate</span> = <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$well</span>  = <span class="i">$args</span>{-<span class="w">well</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sample</span><span class="sc">;</span>
    <span class="i">$well</span> = <span class="i">extract_range</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$well</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$well</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$wells</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$well</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$well</span> &amp;&amp; <span class="i">$wells</span> !~ <span class="q">/,/</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">%Ancestry</span>  = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$plate</span><span class="cm">,</span> -<span class="w">well</span> <span class="cm">=&gt;</span> <span class="i">$well</span><span class="cm">,</span> -<span class="w">simple</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$sample_id</span> = <span class="i">$Ancestry</span>{<span class="w">sample_id</span>}<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$original</span>  = <span class="i">$Ancestry</span>{<span class="w">original</span>}<span class="sc">;</span>
        <span class="i">$sample</span> = <span class="w">alDente::Sample</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$sample</span><span class="i">-&gt;home_page</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Extraction_Sample LEFT JOIN Extraction_Details ON Extraction_Sample_ID=FK_Extraction_Sample__ID'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Extraction_Sample_ID'</span><span class="cm">,</span> <span class="q">'Extraction_Details_ID'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FKOriginal_Plate__ID = $plate&quot;</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'RH'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$rna_sample_id</span><span class="cm">,</span> <span class="i">$rna_details_id</span> <span class="s">)</span> = <span class="s">(</span> <span class="i">$info</span>-&gt;{<span class="w">Extraction_Sample_ID</span>}<span class="cm">,</span> <span class="i">$info</span>-&gt;{<span class="w">Extraction_Details_ID</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">%configs</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$rna_details_id</span><span class="s">)</span> <span class="s">{</span>

            <span class="k">print</span> <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">'Edit Extraction Details'</span><span class="cm">,</span> <span class="q">&quot;&amp;Search=1&amp;Table=Extraction_Details&amp;Search+List=$rna_details_id&quot;</span><span class="cm">,</span> <span class="i">$Settings</span>{<span class="w">LINK_COLOUR</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$configs</span>{<span class="q">'-grey'</span>}{<span class="w">FK_Extraction_Sample__ID</span>} = <span class="i">$rna_sample_id</span><span class="sc">;</span>

            <span class="c"># Freeze the configs hash</span>
            <span class="k">my</span> <span class="i">$frozen_configs</span> = <span class="i">Safe_Freeze</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&quot;DB_Form_Configs&quot;</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> \<span class="i">%configs</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'url'</span><span class="cm">,</span> -<span class="w">encode</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">print</span> <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">'Add Extraction Details'</span><span class="cm">,</span> <span class="q">&quot;&amp;New+Entry=New+Extraction_Details&amp;$frozen_configs&quot;</span><span class="cm">,</span> <span class="i">$Settings</span>{<span class="w">LINK_COLOUR</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="c">### Display recursive list of parent samples: Plate_Content_Type :  Link To Extraction Details</span>

        <span class="i">_get_parent_sample</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">sample_id</span> <span class="cm">=&gt;</span> <span class="i">$sample_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$plate</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%Ancestry</span> = <span class="i">&amp;alDente::Container::get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$plate</span><span class="cm">,</span> -<span class="w">simple</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$original</span> = <span class="i">$Ancestry</span>{<span class="w">original</span>}<span class="sc">;</span>

        <span class="k">my</span> <span class="i">$condition</span> = <span class="q">&quot;WHERE Plate_Sample.FKOriginal_Plate__ID = $original and Plate_Sample.FK_Sample__ID=Sample_ID&quot;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$well</span><span class="s">)</span> <span class="s">{</span> <span class="i">$condition</span> .= <span class="q">&quot; AND WELL IN ($wells)&quot;</span> <span class="s">}</span>
        <span class="i">$condition</span> .= <span class="q">&quot; AND FK_Source__ID = Source_ID&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$samples</span> = <span class="i">&amp;Table_retrieve_display</span><span class="s">(</span>
            <span class="i">$dbc</span><span class="cm">,</span>
            <span class="q">'Plate_Sample, Sample, Source'</span><span class="cm">,</span>
            <span class="s">[</span> <span class="q">&quot;Sample_ID as ID&quot;</span><span class="cm">,</span> <span class="q">&quot;Sample_Name as Sample&quot;</span><span class="cm">,</span> <span class="q">&quot;FKParent_Sample__ID as ParentSample&quot;</span><span class="cm">,</span> <span class="q">&quot;Well&quot;</span><span class="cm">,</span> <span class="q">'FK_Source__ID as Source'</span><span class="cm">,</span> <span class="q">&quot;FK_Original_Source__ID as Original_Source&quot;</span><span class="cm">,</span> <span class="q">'FK_Sample_Type__ID'</span> <span class="s">]</span><span class="cm">,</span> <span class="i">$condition</span>
        <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">else</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;No info for this Sample ($plate : $well)&quot;</span><span class="s">)</span> <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># A fast direct function to quickly retrieving original plate positions given downstream plate_id &amp; well.</span>
<span class="c">#</span>
<span class="c"># (This is useful for get_sample_id since it enables rapid retrieval of sample_ids from downstream plate specifications)</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Return:  array reference for original Plate ids, original wells</span>
<span class="c">#################################</span>
<a name="get_original_locations-"></a><span class="k">sub </span><span class="m">get_original_locations</span> <span class="s">{</span>
<span class="c">#################################</span>
    <span class="k">my</span> <span class="i">%args</span>        = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'plate_id,well'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'plate_id|plate_ids'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>         = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_ids</span>   = <span class="i">$args</span>{-<span class="w">plate_id</span>} || <span class="i">$args</span>{-<span class="w">plate_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$wells</span>       = <span class="i">$args</span>{-<span class="w">well</span>} || <span class="i">$args</span>{-<span class="w">wells</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$generations</span> = <span class="i">$args</span>{-<span class="w">generations</span>} || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>       = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">@plate_ids</span>  = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span><span class="cm">,</span>  -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@wells</span>      = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$wells</span><span class="cm">,</span>      -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@plate_ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$debug</span> &amp;&amp; !<span class="i">$generations</span> <span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Get original list for $plate_list (@plate_ids) (@wells)&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="i">Call_Stack</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$plate_list</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="s">(</span> <span class="s">[</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="s">]</span> <span class="s">)</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">%Positions</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
        <span class="q">'Plate LEFT JOIN Plate as Parent ON Parent.Plate_ID=Plate.FKParent_Plate__ID'</span><span class="cm">,</span>
        <span class="s">[</span> <span class="q">'Plate.Plate_ID'</span><span class="cm">,</span> <span class="q">'Plate.FKParent_Plate__ID'</span><span class="cm">,</span> <span class="q">'Plate.Plate_Parent_Well'</span><span class="cm">,</span> <span class="q">'Plate.Parent_Quadrant'</span><span class="cm">,</span> <span class="q">'Plate.Plate_Size'</span><span class="cm">,</span> <span class="q">'Parent.Plate_Size as Parent_Size'</span> <span class="s">]</span><span class="cm">,</span>
        <span class="q">&quot;WHERE Plate.Plate_ID IN ($plate_list)&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">%P</span><span class="cm">,</span> <span class="i">%Q</span><span class="cm">,</span> <span class="i">%W</span><span class="cm">,</span> <span class="i">%PS</span><span class="cm">,</span> <span class="i">%S</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$i</span> = <span class="n">-1</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Positions</span>{<span class="w">Plate_ID</span>}[ ++<span class="i">$i</span> ] <span class="s">)</span> <span class="s">{</span>
        <span class="c">## generate hash for quadrant and well position for each plate ##</span>
        <span class="k">my</span> <span class="i">$plate_id</span>    = <span class="i">$Positions</span>{<span class="w">Plate_ID</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$parent</span>      = <span class="i">$Positions</span>{<span class="w">FKParent_Plate__ID</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$well</span>        = <span class="i">$Positions</span>{<span class="w">Plate_Parent_Well</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$quad</span>        = <span class="i">$Positions</span>{<span class="w">Parent_Quadrant</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$size</span>        = <span class="i">$Positions</span>{<span class="w">Plate_Size</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$parent_size</span> = <span class="i">$Positions</span>{<span class="w">Parent_Size</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="i">$P</span>{<span class="i">$plate_id</span>}  = <span class="i">$parent</span><span class="sc">;</span>
        <span class="i">$Q</span>{<span class="i">$plate_id</span>}  = <span class="i">$quad</span><span class="sc">;</span>
        <span class="i">$W</span>{<span class="i">$plate_id</span>}  = <span class="i">$well</span><span class="sc">;</span>
        <span class="i">$S</span>{<span class="i">$plate_id</span>}  = <span class="i">$size</span><span class="sc">;</span>
        <span class="i">$PS</span>{<span class="i">$plate_id</span>} = <span class="i">$parent_size</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">@Oplates</span><span class="cm">,</span>         <span class="i">@Owells</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">@daughter_plates</span><span class="cm">,</span> <span class="i">@daughter_wells</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@index</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$i</span> <span class="s">(</span> <span class="n">0</span> .. <span class="i">$#plate_ids</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] } <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@daughter_plates</span><span class="cm">,</span> <span class="i">$P</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] }<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$Q</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] } <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$well</span> = <span class="i">$wells</span>[<span class="i">$i</span>]<span class="sc">;</span>    <span class="c">## convert well to larger mapping position eg d-A01 -&gt; B02 ##</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$well</span> &amp;&amp; <span class="s">(</span> <span class="i">$PS</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] } != <span class="i">$S</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] } <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="i">$converted_well</span> = <span class="i">alDente::Well::well_convert</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">wells</span> <span class="cm">=&gt;</span> <span class="i">$well</span><span class="cm">,</span> -<span class="w">source_size</span> <span class="cm">=&gt;</span> <span class="i">$S</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] }<span class="cm">,</span> -<span class="w">quadrant</span> <span class="cm">=&gt;</span> <span class="i">$Q</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] }<span class="cm">,</span> -<span class="w">target_size</span> <span class="cm">=&gt;</span> <span class="i">$PS</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] } <span class="s">)</span><span class="sc">;</span>
                    <span class="k">push</span> <span class="i">@daughter_wells</span><span class="cm">,</span> <span class="i">$converted_well</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="c">## use same well mapping for parent if same size ... ##</span>
                    <span class="k">push</span> <span class="i">@daughter_wells</span><span class="cm">,</span> <span class="i">$well</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$W</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] } <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$well</span> = <span class="i">$wells</span>[<span class="i">$i</span>]<span class="sc">;</span>    <span class="c">## convert well to plate_parent_well for tube aliquot from plate, check the pass in well is actually tube well, do a size check just in case</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$well</span> <span class="k">eq</span> <span class="q">'N/A'</span> &amp;&amp; <span class="s">(</span> <span class="i">$PS</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] } != <span class="i">$S</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] } <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">push</span> <span class="i">@daughter_wells</span><span class="cm">,</span> <span class="i">$W</span>{ <span class="i">$plate_ids</span>[<span class="i">$i</span>] }<span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="k">push</span> <span class="i">@daughter_wells</span><span class="cm">,</span> <span class="i">$well</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">push</span> <span class="i">@daughter_wells</span><span class="cm">,</span> <span class="i">$wells</span>[<span class="i">$i</span>]<span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">push</span> <span class="i">@Oplates</span><span class="cm">,</span> <span class="q">''</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@Owells</span><span class="cm">,</span>  <span class="q">''</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@index</span><span class="cm">,</span>   <span class="i">$i</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@Oplates</span><span class="cm">,</span> <span class="i">$plate_ids</span>[<span class="i">$i</span>]<span class="sc">;</span>
            <span class="k">push</span> <span class="i">@Owells</span><span class="cm">,</span>  <span class="i">$wells</span>[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">@daughter_plates</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$parent_plates</span><span class="cm">,</span> <span class="i">$parent_wells</span> <span class="s">)</span> = <span class="i">get_original_locations</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_ids</span> <span class="cm">=&gt;</span> \<span class="i">@daughter_plates</span><span class="cm">,</span> -<span class="w">wells</span> <span class="cm">=&gt;</span> \<span class="i">@daughter_wells</span><span class="cm">,</span> -<span class="w">generations</span> <span class="cm">=&gt;</span> <span class="i">$generations</span> + <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$i</span> <span class="s">(</span> <span class="n">1</span> .. <span class="k">int</span><span class="s">(</span><span class="i">@$parent_plates</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## fill in previously skipped values values ##</span>
            <span class="i">$Oplates</span>[ <span class="i">$index</span>[ <span class="i">$i</span> - <span class="n">1</span> ] ] = <span class="i">$parent_plates</span>-&gt;[ <span class="i">$i</span> - <span class="n">1</span> ]<span class="sc">;</span>
            <span class="i">$Owells</span>[ <span class="i">$index</span>[ <span class="i">$i</span> - <span class="n">1</span> ] ]  = <span class="i">$parent_wells</span>-&gt;[ <span class="i">$i</span> - <span class="n">1</span> ]<span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$generations</span> &gt; <span class="n">20</span> <span class="s">)</span> <span class="s">{</span> <span class="k">last</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## abort in case of endless loop bug</span>

    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$debug</span> &amp;&amp; !<span class="i">$generations</span> <span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="i">HTML_Dump</span> <span class="q">&quot;*** FINAL ($generations) -&gt; ***&quot;</span><span class="cm">,</span> \<span class="i">@Oplates</span><span class="cm">,</span> \<span class="i">@Owells</span> <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> \<span class="i">@Oplates</span><span class="cm">,</span> \<span class="i">@Owells</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################</span>
<span class="c"># Get Protocol History for Plate(s)</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">###############################</span>
<a name="get_protocol_history-"></a><span class="k">sub </span><span class="m">get_protocol_history</span> <span class="s">{</span>
<span class="c">###############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span>         = <span class="i">$args</span>{-<span class="w">dbc</span>}         || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$thisplate</span>   = <span class="i">$args</span>{-<span class="w">id</span>}          || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>}<span class="sc">;</span>                                                                <span class="c"># plate id (or list of plate_ids)</span>
    <span class="k">my</span> <span class="i">$verbose</span>     = <span class="i">$args</span>{-<span class="w">verbose</span>}     || <span class="n">0</span><span class="sc">;</span>                                                                                <span class="c"># 0 for no output, 1 for basic, 2 for garrulous (not yet used)</span>
    <span class="k">my</span> <span class="i">$protocol_id</span> = <span class="i">$args</span>{-<span class="w">protocol_id</span>} || <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library</span>     = <span class="i">$args</span>{-<span class="w">library</span>}     || <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$generations</span> = <span class="i">Extract_Values</span><span class="s">(</span> <span class="s">[</span> <span class="i">$args</span>{-<span class="w">generations</span>}<span class="cm">,</span> <span class="n">20</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>                                                           <span class="c"># optional limit on # of gen's to search back..</span>

    <span class="k">my</span> <span class="i">%PHistory</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>                                                                                                         <span class="c">####### object storing various history info..</span>

    <span class="k">my</span> <span class="i">$timestamp</span> = <span class="i">&amp;RGTools::RGIO::timestamp</span><span class="sc">;</span>

    <span class="k">print</span> <span class="i">h3</span><span class="s">(</span><span class="q">&quot;Protocol History for $library Container(s) $thisplate&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$line_sep</span>  = <span class="q">&quot;&lt;BR&gt;&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$field_sep</span> = <span class="q">&quot;,&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_sets</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$thisplate_set</span><span class="sc">;</span>

    <span class="c">#    Future: display original tube source if available.. (or at least provide a link)</span>
    <span class="k">my</span> <span class="i">$parents</span> = <span class="i">$thisplate</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$thisplate</span><span class="s">)</span> <span class="s">{</span>                                                                                                          <span class="c">### if plate(s) specified</span>

        <span class="c">#	print &quot;History for $generations generations&quot;.br();</span>
        <span class="c">## get list of all plates in ancestry of 'thisplate'</span>
        <span class="i">$parents</span> = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$thisplate</span><span class="cm">,</span> -<span class="w">generations</span> <span class="cm">=&gt;</span> <span class="i">$generations</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="c">## get list of all applicable Plate Sets including any of above plates</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="i">$parents</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;No valid Ancestry&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span> <span class="n">0</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$plate_sets</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Set'</span><span class="cm">,</span> <span class="q">'Plate_Set_Number'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate__ID in ($parents)&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">## get actual plate set only for 'thisplate' (not including ancestry)</span>
        <span class="i">$thisplate_set</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Set'</span><span class="cm">,</span> <span class="q">'Plate_Set_Number'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate__ID in ($thisplate)&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#    my $Table = HTML_Table-&gt;new(-size=&gt;'small',-colour=&gt;'white',-border=&gt;1);</span>
    <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">Plate_Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$parents</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## if looking at a plate with history...</span>
        <span class="i">$Prep</span><span class="i">-&gt;get_Prep_history</span><span class="s">(</span> -<span class="w">plate_ids</span> <span class="cm">=&gt;</span> <span class="i">$parents</span><span class="cm">,</span> -<span class="w">protocol_id</span> <span class="cm">=&gt;</span> <span class="i">$protocol_id</span><span class="cm">,</span> -<span class="w">view</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$library</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## if looking at whole library...</span>
        <span class="i">$Prep</span><span class="i">-&gt;get_Prep_history</span><span class="s">(</span> -<span class="w">library</span> <span class="cm">=&gt;</span> <span class="i">$library</span><span class="cm">,</span> -<span class="w">protocol_id</span> <span class="cm">=&gt;</span> <span class="i">$protocol_id</span><span class="cm">,</span> -<span class="w">view</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<a name="inherit_Parent_fields-"></a><span class="k">sub </span><span class="m">inherit_Parent_fields</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">$self</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$daughter</span> = <span class="i">$args</span>{-<span class="w">daughter</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parent</span>   = <span class="i">$args</span>{-<span class="w">parent</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$parent</span> <span class="s">)</span> <span class="s">{</span><span class="k">return</span><span class="s">}</span>    <span class="c">## don't need to do anything if this is an original plate ##</span>
    <span class="k">my</span> <span class="i">@fields</span> = <span class="s">(</span><span class="q">'QC_Status'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$result</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> <span class="q">&quot; WHERE Plate_ID = $parent&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$result</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$success</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> \<span class="i">@values</span><span class="cm">,</span> <span class="q">&quot; WHERE Plate_ID = $daughter&quot;</span><span class="cm">,</span> -<span class="w">no_triggers</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$success</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">################</span>
<a name="save_Container-"></a><span class="k">sub </span><span class="m">save_Container</span> <span class="s">{</span>
<span class="c">################</span>
    <span class="c">#</span>
    <span class="c"># save new record.</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># public_functions           #</span>
<span class="c">##############################</span>

<span class="c">###################################################################</span>
<span class="c"># The following routines may be called without creating an object #</span>
<span class="c">###################################################################</span>

<span class="c">##############################</span>
<a name="validate_pool-"></a><span class="k">sub </span><span class="m">validate_pool</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'dbc,format,plate_ids'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>        = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_format</span> = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_ids</span>  = <span class="i">$args</span>{-<span class="w">plate_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$is_tray</span>    = <span class="i">$args</span>{-<span class="w">is_tray</span>}<span class="sc">;</span>

    <span class="i">$plate_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">## Get target size and plate size</span>
    <span class="k">my</span> <span class="i">$format_id</span> = <span class="i">get_FK_ID</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> <span class="i">$new_format</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$target_size</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Format'</span><span class="cm">,</span> <span class="q">'Wells'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_Format_ID = '$format_id'&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@plate_sizes</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_Size'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($plate_ids)&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@plate_sizes</span><span class="s">)</span> != <span class="n">1</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Must have identical plate sizes&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span> <span class="n">0</span><span class="sc">;</span> <span class="s">}</span>
    <span class="i">$plate_sizes</span>[<span class="n">0</span>] =~ <span class="q">s/-well//</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$is_tray</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span>   <span class="s">(</span> <span class="i">$target_size</span> &gt; <span class="i">$plate_sizes</span>[<span class="n">0</span>] <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="n">1</span> <span class="s">}</span>
        <span class="k">else</span>                                    <span class="s">{</span> <span class="k">return</span> <span class="n">0</span> <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># if target size &gt; plate size then try to pool individual quadrants</span>
<span class="c"># return list of pooled target plates or 0</span>
<span class="c"># usage: target = &amp;pool_tray( -dbc =&gt; $dbc, -plate_ids =&gt; $current, -format =&gt; $new_format, -pack_quadrants =&gt; $pack_quadrants, -quadrants=&gt;\@quadrants);</span>
<span class="c">#</span>
<span class="c">###################</span>
<a name="pool_tray-"></a><span class="k">sub </span><span class="m">pool_tray</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">%args</span>           = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'dbc,format,plate_ids'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>            = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_format</span>     = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_ids</span>      = <span class="i">$args</span>{-<span class="w">plate_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pack_quadrants</span> = <span class="i">$args</span>{-<span class="w">pack_quadrants</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quadrants_ref</span>  = <span class="i">$args</span>{-<span class="w">quadrants</span>} || <span class="s">[</span><span class="s">]</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@quadrants</span>      = <span class="i">@</span>{<span class="i">$quadrants_ref</span>}<span class="sc">;</span>

    <span class="i">$plate_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">@quadrants</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## Use Plate_Position in Plate_Tray to determine quadrants used</span>
        <span class="i">@quadrants</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Tray'</span><span class="cm">,</span> <span class="q">'Distinct Plate_Position'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID in ($plate_ids) Order by Plate_Position&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">@quadrants</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Please provide quadrants&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#try to pool individual quadrants since target size &gt; plate size</span>

    <span class="k">my</span> <span class="i">@plates</span> = <span class="k">split</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="i">$plate_ids</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@targets</span><span class="sc">;</span>

    <span class="c">#pool plates every n quadrants where n is number of quadrants</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$i</span> <span class="s">(</span> <span class="n">0</span> .. <span class="i">$#quadrants</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@in_plates</span><span class="sc">;</span>
        <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i2</span> = <span class="i">$i</span><span class="sc">;</span> <span class="i">$i2</span> &lt;= <span class="i">$#plates</span><span class="sc">;</span> <span class="i">$i2</span> = <span class="i">$i2</span> + <span class="i">$#quadrants</span> + <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@in_plates</span><span class="cm">,</span> <span class="i">$plates</span>[<span class="i">$i2</span>]<span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">my</span> <span class="i">$in_plate</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="i">@in_plates</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$target</span> = <span class="i">$set</span><span class="i">-&gt;pool_identical_plates</span><span class="s">(</span> -<span class="w">plate_ids</span> <span class="cm">=&gt;</span> <span class="i">$in_plate</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="i">$new_format</span><span class="cm">,</span> -<span class="w">pool_x</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">no_print</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$target</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@targets</span><span class="cm">,</span> <span class="i">$target</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Problem pooling one of the quadrants&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">#create tray</span>
    <span class="k">my</span> <span class="i">@newtrays</span> = <span class="i">alDente::Tray::create_multiple_trays</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> \<span class="i">@targets</span><span class="cm">,</span> <span class="i">$pack_quadrants</span><span class="cm">,</span> -<span class="w">pos_list</span> <span class="cm">=&gt;</span> \<span class="i">@quadrants</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">##Tray Barcode</span>
    <span class="k">my</span> <span class="i">$target</span> = <span class="k">join</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@targets</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">&amp;alDente::Barcoding::PrintBarcode</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">'Trays'</span><span class="cm">,</span> <span class="i">$target</span><span class="cm">,</span> <span class="q">'print,library_plate'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$target</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># Retrieve valid plate ids that have been preped within the last N days.</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">###########################</span>
<a name="get_recent_prepped_ids-"></a><span class="k">sub </span><span class="m">get_recent_prepped_ids</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="k">shift</span> || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$days_ago</span> = <span class="k">shift</span> || <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$since</span> = <span class="i">&amp;date_time</span><span class="s">(</span> <span class="q">'-'</span> . <span class="i">$days_ago</span> . <span class="q">'d'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@recent_plates</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate, Plate_Prep, Prep'</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID = Plate_ID and FK_Prep__ID = Prep_ID and Prep_DateTime &gt;= '$since'&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">@recent_plates</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Found $#recent_plates..since $since..&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> \<span class="i">@recent_plates</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;No plates found since $since&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">[</span><span class="s">]</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># Retrieve valid plate ids that have been created within the last N days.</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#################</span>
<a name="get_recent_ids-"></a><span class="k">sub </span><span class="m">get_recent_ids</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="k">shift</span> || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$days_ago</span> = <span class="k">shift</span> || <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$since</span> = <span class="i">&amp;date_time</span><span class="s">(</span> <span class="q">'-'</span> . <span class="i">$days_ago</span> . <span class="q">'d'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@recent_plates</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_Created &gt;= '$since'&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;found $#recent_plates..since $since..&lt;BR&gt;&quot;</span><span class="sc">;</span>
    <span class="k">return</span> \<span class="i">@recent_plates</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################################################################################</span>
<span class="c"># Return: list of plates that have been prepped at the same time as the current plate</span>
<span class="c">########################</span>
<a name="get_Prep_mates-"></a><span class="k">sub </span><span class="m">get_Prep_mates</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'plate_id'</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## input arguments: ##</span>
    <span class="k">my</span> <span class="i">$dbc</span>       = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$thisplate</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                                                                <span class="c"># id or barcode for current plate</span>
    <span class="k">my</span> <span class="i">$direct</span>    = <span class="i">$args</span>{-<span class="w">direct</span>}<span class="sc">;</span>                                                                  <span class="c"># get only plates associated to this plate directly (ie not parent plates)</span>
    <span class="k">my</span> <span class="i">$protocol</span>  = <span class="i">$args</span>{-<span class="w">protocol</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$field_ref</span> = <span class="i">$args</span>{-<span class="w">fields</span>} || <span class="s">[</span><span class="q">'FK_Plate__ID'</span><span class="s">]</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@fields</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$field_ref</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$mates</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plates</span> = <span class="i">$thisplate</span><span class="sc">;</span>
    <span class="i">$plates</span> = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$thisplate</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span> <span class="s">)</span> <span class="k">unless</span> <span class="i">$direct</span><span class="sc">;</span>      <span class="c">## get list of parent plates</span>

    <span class="k">my</span> <span class="i">$protocol_condition</span><span class="sc">;</span>
    <span class="i">$protocol_condition</span> = <span class="q">&quot; AND FK_Lab_Protocol__ID IN ($protocol)&quot;</span> <span class="k">if</span> <span class="i">$protocol</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$preps</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Prep,Prep'</span><span class="cm">,</span> <span class="q">'Prep_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Prep__ID=Prep_ID AND FK_Plate__ID IN ($plates) $protocol_condition&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%mates</span><span class="sc">;</span>
    <span class="i">%mates</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Prep,Lab_Protocol,Plate_Prep'</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Prep__ID=Prep_ID AND FK_Lab_Protocol__ID=Lab_Protocol_ID AND Prep_ID IN ($preps)&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$preps</span><span class="sc">;</span>

    <span class="k">return</span> \<span class="i">%mates</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################</span>
<a name="get_Sets-"></a><span class="k">sub </span><span class="m">get_Sets</span> <span class="s">{</span>
<span class="c">################</span>
    <span class="c">#</span>
    <span class="c"># find all plate sets containing current plate</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span>      = <span class="i">@_</span><span class="sc">;</span>                                                                              <span class="c">## input arguments: ##</span>
    <span class="k">my</span> <span class="i">$dbc</span>       = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$thisplate</span> = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>                                                                      <span class="c"># id or barcode for current plate</span>
    <span class="k">my</span> <span class="i">$direct</span>    = <span class="i">$args</span>{-<span class="w">direct</span>}<span class="sc">;</span>                                                                  <span class="c"># get only sets containing this plate directly</span>

    <span class="k">my</span> <span class="i">$table</span>    = <span class="q">'Plate'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rkey</span>     = <span class="q">'FKParent_Plate__ID'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$idfield</span>  = <span class="q">'Plate_ID'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parents</span>  = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$thisplate</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@all_sets</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Set'</span><span class="cm">,</span> <span class="q">'Plate_Set_Number'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate__ID in ($parents)&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sets</span>     = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@all_sets</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@plate_sets</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Set'</span><span class="cm">,</span> <span class="q">'Plate_Set_Number'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate__ID in ($thisplate)&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$direct_sets</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@plate_sets</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$direct</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$direct_sets</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$sets</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

<span class="c">############################################################</span>
<span class="c"># Extract various information about the history of a plate</span>
<span class="c">#</span>
<span class="c"># Example:</span>
<span class="c">#   my %ancestry = get_Parents(-dbc=&gt;$dbc,-id=&gt;$plate_id,-well=&gt;'A05');</span>
<span class="c">#   my $sample_id = $ancestry{sample_id};</span>
<span class="c">#   my $original_plate   = $ancestry{original}</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="get_Parents-"></a><span class="k">sub </span><span class="m">get_Parents</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="c">#</span>
    <span class="c"># Return ids of containers from which given id originated</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,id,generations,format'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$id</span>          = <span class="i">$args</span>{-<span class="w">id</span>}          || <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>    <span class="c">## plate id</span>
    <span class="k">my</span> <span class="i">$generations</span> = <span class="i">$args</span>{-<span class="w">generations</span>} || <span class="n">40</span><span class="sc">;</span>                  <span class="c">## number of generations to go back...</span>
    <span class="k">my</span> <span class="i">$rearrays</span>    = <span class="i">$args</span>{-<span class="w">rearrays</span>}    || <span class="n">8</span><span class="sc">;</span>                   <span class="c">## number of generations to go back...</span>
    <span class="k">my</span> <span class="i">$format</span>      = <span class="i">$args</span>{<span class="q">'-format'</span>}    || <span class="q">'hash'</span><span class="sc">;</span>              <span class="c">## format of output ('hash' or comma-delimited 'list' or 'original')</span>
    <span class="k">my</span> <span class="i">$ancestry</span>         = <span class="i">$args</span>{-<span class="w">ancestry</span>}<span class="sc">;</span>                      <span class="c">## include current hash if expanding ...</span>
    <span class="k">my</span> <span class="i">$well</span>             = <span class="i">$args</span>{-<span class="w">well</span>}<span class="sc">;</span>                          <span class="c">## specify well (allows full clone traceback through re-arrays)</span>
    <span class="k">my</span> <span class="i">$no_rearray</span>       = <span class="i">$args</span>{-<span class="w">no_rearray</span>} || <span class="n">0</span><span class="sc">;</span>               <span class="c">## Don't follow through rearrays even if well is specified</span>
    <span class="k">my</span> <span class="i">$well_lookup_hash</span> = <span class="i">$args</span>{-<span class="w">well_lookup</span>}<span class="sc">;</span>                   <span class="c">## (HashRef) [Optional] (Recursion argument) well lookup hash. Used for recursion so it doesn't need to be built again</span>
    <span class="k">my</span> <span class="i">$simple</span>           = <span class="i">$args</span>{-<span class="w">simple</span>} || <span class="i">$no_rearray</span><span class="sc">;</span>         <span class="c">## option to exclude tracking through pooling, rearrays, extractions etc.</span>
    <span class="k">my</span> <span class="i">$no_sample</span>        = <span class="i">$args</span>{-<span class="w">no_sample</span>}<span class="sc">;</span>                     <span class="c">## No need to retrieve sample information if set</span>
    <span class="k">my</span> <span class="i">$generation_only</span>  = <span class="i">$args</span>{-<span class="w">generation_only</span>}<span class="sc">;</span>               <span class="c">## Only retrieve information for generations and created</span>
    <span class="k">my</span> <span class="i">$debug</span>            = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="i">$well</span> = <span class="i">&amp;format_well</span><span class="s">(</span><span class="i">$well</span><span class="s">)</span><span class="sc">;</span>                                  <span class="c">## (in case it is in other format) ##</span>

    <span class="c"># if well is N/A, then just don't give a well designation</span>
    <span class="i">$well</span> = <span class="q">''</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$well</span> <span class="k">eq</span> <span class="q">'N/A'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Ancestry</span><span class="sc">;</span>
    <span class="k">if</span>   <span class="s">(</span><span class="i">$ancestry</span><span class="s">)</span> <span class="s">{</span> <span class="i">%Ancestry</span>       = <span class="i">%</span>{<span class="i">$ancestry</span>} <span class="s">}</span>           <span class="c">## update hash if provided</span>
    <span class="k">else</span>             <span class="s">{</span> <span class="i">$Ancestry</span>{<span class="w">list</span>} = <span class="s">[</span><span class="i">$id</span><span class="s">]</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$recursion</span> = <span class="i">$args</span>{-<span class="w">recurse</span>}<span class="sc">;</span>                              <span class="c">## Flag that determines if the function is an instance of a recursion call. Used for efficiency purposes - DO NOT SET!</span>

    <span class="i">$Ancestry</span>{<span class="w">parent_generations</span>} = <span class="n">0</span><span class="sc">;</span>
    <span class="i">$Ancestry</span>{<span class="w">well</span>}               = <span class="i">$well</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$generation</span>    = <span class="i">$id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rearray_index</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$gen_index</span>     = <span class="n">0</span><span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span> <span class="i">$generations</span> =~ <span class="q">/\d+/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$generations</span> = <span class="n">20</span> <span class="s">}</span>        <span class="c">## continue until finished...</span>

    <span class="k">my</span> <span class="i">$original_well</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$well</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$original_well</span> = <span class="i">$well</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># build lookup table</span>
    <span class="k">my</span> <span class="i">%well_lookup</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%well_384_to_96</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%well_96_to_384</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$well</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$well_lookup_hash</span> &amp;&amp; <span class="k">keys</span><span class="s">(</span> <span class="i">%</span>{<span class="i">$well_lookup_hash</span>} <span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">%well_384_to_96</span> = <span class="i">%</span>{ <span class="i">$well_lookup_hash</span>-&gt;{<span class="q">'384_to_96'</span>} }<span class="sc">;</span>
            <span class="i">%well_96_to_384</span> = <span class="i">%</span>{ <span class="i">$well_lookup_hash</span>-&gt;{<span class="q">'96_to_384'</span>} }<span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">%well_lookup</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">&quot;Well_Lookup&quot;</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Quadrant'</span><span class="cm">,</span> <span class="q">'Plate_96'</span><span class="cm">,</span> <span class="q">'Plate_384'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">'order by Quadrant,Plate_96'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$well</span> <span class="s">(</span> <span class="i">@</span>{ <span class="i">$well_lookup</span>{<span class="q">'Plate_96'</span>} } <span class="s">)</span> <span class="s">{</span>
                <span class="i">$well_lookup</span>{<span class="q">'Plate_384'</span>}[<span class="i">$index</span>]                                                            = <span class="i">&amp;format_well</span><span class="s">(</span> <span class="i">$well_lookup</span>{<span class="q">'Plate_384'</span>}[<span class="i">$index</span>] <span class="s">)</span><span class="sc">;</span>
                <span class="i">$well_96_to_384</span>{ <span class="k">uc</span><span class="s">(</span> <span class="i">$well_lookup</span>{<span class="q">'Plate_96'</span>}[<span class="i">$index</span>] . <span class="i">$well_lookup</span>{<span class="q">'Quadrant'</span>}[<span class="i">$index</span>] <span class="s">)</span> } = <span class="i">$well_lookup</span>{<span class="q">'Plate_384'</span>}[<span class="i">$index</span>]<span class="sc">;</span>
                <span class="i">$well_384_to_96</span>{ <span class="i">$well_lookup</span>{<span class="q">'Plate_384'</span>}[<span class="i">$index</span>] }                                         = <span class="k">uc</span><span class="s">(</span> <span class="i">$well_lookup</span>{<span class="q">'Plate_96'</span>}[<span class="i">$index</span>] <span class="s">)</span> . <span class="i">$well_lookup</span>{<span class="q">'Quadrant'</span>}[<span class="i">$index</span>]<span class="sc">;</span>
                <span class="i">$index</span>++<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">while</span> <span class="s">(</span><span class="i">$generation</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@elders</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'FKParent_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID in ($generation) AND FKParent_Plate__ID &gt; 0&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$well</span> &amp;&amp; <span class="i">@elders</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## For now, only retrieve parents up until the 'original plate' (most recent in which new sample defined) ##</span>
            <span class="k">my</span> <span class="i">@size_info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span>
                <span class="q">'Plate as Parent, Plate as Target'</span><span class="cm">,</span>
                <span class="q">'Target.Parent_Quadrant, Parent.Plate_Size, Target.Plate_Size'</span><span class="cm">,</span>
                <span class="q">&quot;WHERE Target.Plate_ID in ($generation) AND Parent.Plate_ID=Target.FKParent_Plate__ID AND Target.Plate_ID != Target.FKOriginal_Plate__ID&quot;</span>
            <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$position_in_parent</span><span class="cm">,</span> <span class="i">$parent_size</span><span class="cm">,</span> <span class="i">$target_size</span><span class="cm">,</span> <span class="i">$target_parent_well</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$size_info</span>[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$parent_size</span> =~ <span class="q">/384/</span> &amp;&amp; <span class="i">$target_size</span> =~ <span class="q">/96/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$original_well</span> = <span class="i">$well_96_to_384</span>{ <span class="k">uc</span><span class="s">(</span> <span class="i">$well</span> . <span class="i">$position_in_parent</span> <span class="s">)</span> }<span class="sc">;</span>
                <span class="i">$Ancestry</span>{<span class="w">well</span>} = <span class="i">$original_well</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span><span class="i">@elders</span><span class="s">)</span> <span class="s">{</span>

            <span class="c"># handling for plate to tube transfers</span>
            <span class="c">## For now, only retrieve parents up until the 'original plate' (most recent in which new sample defined) ##</span>
            <span class="k">my</span> <span class="i">@size_info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span>
                <span class="q">'Plate as Parent, Plate as Target'</span><span class="cm">,</span>
                <span class="q">'Parent.Plate_Size, Target.Plate_Size,Target.Plate_Parent_Well'</span><span class="cm">,</span>
                <span class="q">&quot;WHERE Target.Plate_ID in ($generation) AND Parent.Plate_ID=Target.FKParent_Plate__ID AND Target.Plate_ID != Target.FKOriginal_Plate__ID&quot;</span>
            <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$parent_size</span><span class="cm">,</span> <span class="i">$target_size</span><span class="cm">,</span> <span class="i">$target_parent_well</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$size_info</span>[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$parent_size</span> !~ <span class="q">/^1-well$/</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$target_size</span> =~ <span class="q">/^1-well$/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$original_well</span> = <span class="i">$target_parent_well</span><span class="sc">;</span>
                <span class="i">$Ancestry</span>{<span class="w">well</span>} = <span class="i">$original_well</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="c">## Extend tracking to extractions, poolings, rearrays ##</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$simple</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">@more_parents</span> = <span class="i">get_prev_gen</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$generation</span><span class="cm">,</span> -<span class="w">well</span> <span class="cm">=&gt;</span> <span class="i">$original_well</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="q">&quot;concat(FK_Library__Name,Plate_Number) as Pnum&quot;</span><span class="s">]</span><span class="cm">,</span> -<span class="w">follow</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_ons</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@more_parents</span><span class="sc">;</span>    <span class="c">### ( need to account for ['1', '2,3,4' etc] )</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$parent</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$add_ons</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$generation</span> =~ <span class="q">/\b$parent\b/</span> <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>    <span class="c">## skip plates in current generation</span>
                <span class="k">push</span> <span class="i">@elders</span><span class="cm">,</span> <span class="i">$parent</span> <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$parent$/</span><span class="cm">,</span> <span class="i">@elders</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>

            <span class="k">if</span> <span class="s">(</span><span class="i">@more_parents</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">$Ancestry</span>{<span class="w">notes</span>}{<span class="q">&quot;-$gen_index&quot;</span>} .= <span class="q">&quot;Followed through rearrays;&quot;</span><span class="sc">;</span>

                <span class="i">$rearray_index</span>++<span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$rearray_index</span> &gt; <span class="i">$rearrays</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="c">## turn off rearray tracking after specified number of rearrays encountered</span>

                    <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Limited tracking to $rearrays Rearray Generation(s)&quot;</span><span class="s">)</span><span class="sc">;</span>
                    <span class="i">$simple</span> = <span class="n">1</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>

            <span class="c">### Take the first parent (in case of rearrays)</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$first_plate</span><span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$generation</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$bp</span> = <span class="i">get_birth_protocol</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$first_plate</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">birth</span>}{<span class="q">&quot;-$gen_index&quot;</span>} = <span class="i">$bp</span>-&gt;{<span class="w">protocol_name</span>} <span class="k">if</span> <span class="s">(</span> <span class="i">$bp</span>-&gt;{<span class="w">protocol_name</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># change well if the plate is transferred from a 384-well plate to a 96-well plate</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">@elders</span><span class="s">)</span> <span class="s">{</span> <span class="i">$Ancestry</span>{<span class="w">original</span>} = <span class="i">$generation</span><span class="sc">;</span> <span class="k">last</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$generation</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@elders</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$gen_index</span>++ &gt;= <span class="i">$generations</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Stopping Ancestry Extraction at generation # $gen_index ...&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">last</span><span class="sc">;</span> <span class="s">}</span>
        <span class="i">$Ancestry</span>{<span class="w">generation</span>}-&gt;{<span class="q">&quot;-$gen_index&quot;</span>} = <span class="i">$generation</span><span class="sc">;</span>

        <span class="k">unless</span> <span class="s">(</span><span class="i">$generation_only</span><span class="s">)</span> <span class="s">{</span>

            <span class="c">#my $label_field = &quot;CASE WHEN Well_Capacity_mL &gt; 0 THEN concat(Well_Capacity_mL,' mL ',Plate_Format_Type) ELSE Plate_Format_Type END as PF_Type&quot;;</span>
            <span class="k">my</span> <span class="i">$label_field</span> = <span class="q">&quot;CASE WHEN Capacity_Units = 'well' THEN concat(Wells,'-well ',Plate_Format_Type) ELSE CASE WHEN Well_Capacity_mL &gt; 0 THEN concat(Well_Capacity_mL,' mL ',Plate_Format_Type) ELSE Plate_Format_Type END END as PF_Type&quot;</span><span class="sc">;</span>
            <span class="i">$label_field</span> = <span class="q">'Sample_Type'</span> <span class="k">if</span> <span class="i">$Configs</span>{<span class="w">plateContent_tracking</span>}<span class="sc">;</span>

            <span class="k">my</span> <span class="i">$formats</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> <span class="q">'Plate,Plate_Format,Sample_Type'</span><span class="cm">,</span> <span class="s">[</span><span class="i">$label_field</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where FK_Sample_Type__ID=Sample_Type_ID AND FK_Plate_Format__ID=Plate_Format_ID AND Plate_ID in ($generation)&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">formats</span>}-&gt;{<span class="q">&quot;-$gen_index&quot;</span>} = <span class="i">$formats</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="s">(</span><span class="i">$created</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span><span class="q">&quot;MIN(Plate_Created)&quot;</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID in ($generation)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">created</span>}-&gt;{<span class="q">&quot;-$gen_index&quot;</span>} = <span class="i">$created</span><span class="sc">;</span>

        <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">list</span>} }<span class="cm">,</span> <span class="i">$generation</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">parent_generations</span>}++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$Ancestry</span>{<span class="w">original</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="c">## no original plate found ? ##</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$gen_index</span> &gt; <span class="i">$generations</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Generation limit encountered prior to identification of Original Plate... continuing&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="c">## fatal if not because of generation limit ##</span>
            <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;No Original plate found ?&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$generation_only</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">### extract rearray information... ###</span>
        <span class="k">my</span> <span class="i">%rearray_info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'ReArray,ReArray_Request'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'FKSource_Plate__ID'</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where FK_ReArray_Request__ID=ReArray_Request_ID AND FKTarget_Plate__ID in ( &quot;</span> . <span class="i">$Ancestry</span>{<span class="w">original</span>} . <span class="q">&quot;) order by FKSource_Plate__ID&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">@rearrays</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@wells</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$rearray_info</span>{<span class="w">FKSource_Plate__ID</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">@rearrays</span> = <span class="i">@</span>{ <span class="i">$rearray_info</span>{<span class="w">FKSource_Plate__ID</span>} }<span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">@rearray_pools</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span>
            <span class="q">'ReArray_Request,ReArray'</span><span class="cm">,</span> <span class="q">'FKSource_Plate__ID'</span><span class="cm">,</span>
            <span class="q">&quot;WHERE FKTarget_Plate__ID in ($id) and </span>
					    <span class="q">					    FK_ReArray_Request__ID = ReArray_Request_ID and ReArray_Type = 'Pool Rearray' </span>
					    <span class="q">					    ORDER BY FKSource_Plate__ID&quot;</span><span class="cm">,</span>
            -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@rearrays</span><span class="cm">,</span> <span class="i">@rearray_pools</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@rearrays</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">rearray_sources</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">rearray_sources</span>} }<span class="cm">,</span> <span class="i">@rearrays</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$Ancestry</span>{<span class="w">rearray_sources</span>} = \<span class="i">@rearrays</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$well</span> &amp;&amp; <span class="k">int</span><span class="s">(</span><span class="i">@rearrays</span><span class="s">)</span> &amp;&amp; !<span class="i">$no_rearray</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## if looking at a specific well and there are clone or reaction rearrays... follow them back... ###</span>
            <span class="k">my</span> <span class="i">$well_spec</span> = <span class="q">&quot; AND Target_Well in ('$original_well')&quot;</span><span class="sc">;</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$rearray_type</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;ReArray_Request&quot;</span><span class="cm">,</span> <span class="q">&quot;ReArray_Type&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE FKTarget_Plate__ID in ( &quot;</span> . <span class="i">$Ancestry</span>{<span class="w">original</span>} . <span class="q">&quot;)&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$rearray_type</span> =~ <span class="q">/Clone|Reaction/i</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">%rearray_info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
                    <span class="q">'ReArray,ReArray_Request'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FKSource_Plate__ID'</span><span class="cm">,</span> <span class="q">'Source_Well'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where FK_ReArray_Request__ID=ReArray_Request_ID AND FKTarget_Plate__ID in ( &quot;</span> . <span class="i">$Ancestry</span>{<span class="w">original</span>} . <span class="q">&quot;) $well_spec&quot;</span><span class="cm">,</span>
                    -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
                    -<span class="w">debug</span>    <span class="cm">=&gt;</span> <span class="i">$debug</span>
                <span class="s">)</span><span class="sc">;</span>

                <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$rearray_info</span>{<span class="w">FKSource_Plate__ID</span>} <span class="s">)</span> <span class="s">{</span>
                    <span class="i">@rearrays</span> = <span class="i">@</span>{ <span class="i">$rearray_info</span>{<span class="w">FKSource_Plate__ID</span>} }<span class="sc">;</span>
                    <span class="i">@wells</span>    = <span class="i">@</span>{ <span class="i">$rearray_info</span>{<span class="w">Source_Well</span>} }<span class="sc">;</span>

                    <span class="i">$Ancestry</span>{<span class="w">original</span>} = <span class="i">$rearrays</span>[<span class="n">0</span>]<span class="sc">;</span>
                    <span class="i">$Ancestry</span>{<span class="w">well</span>}     = <span class="i">$wells</span>[<span class="n">0</span>]<span class="sc">;</span>

                    <span class="c"># if the well is N/A or blank, omit the wells</span>
                    <span class="k">my</span> <span class="i">$source_well</span> = <span class="i">$wells</span>[<span class="n">0</span>]<span class="sc">;</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> !<span class="i">$source_well</span> <span class="s">)</span> || <span class="s">(</span> <span class="i">$well</span> <span class="k">eq</span> <span class="q">'N/A'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                        <span class="i">$source_well</span> = <span class="q">''</span><span class="sc">;</span>
                    <span class="s">}</span>
                    <span class="k">if</span> <span class="s">(</span><span class="i">$recursion</span><span class="s">)</span> <span class="s">{</span>
                        <span class="i">%Ancestry</span> = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$rearrays</span>[<span class="n">0</span>]<span class="cm">,</span> -<span class="w">well</span> <span class="cm">=&gt;</span> <span class="i">$source_well</span><span class="cm">,</span> -<span class="w">ancestry</span> <span class="cm">=&gt;</span> \<span class="i">%Ancestry</span><span class="cm">,</span> -<span class="w">well_lookup</span> <span class="cm">=&gt;</span> <span class="i">$well_lookup_hash</span><span class="cm">,</span> -<span class="w">recurse</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">simple</span> <span class="cm">=&gt;</span> <span class="i">$simple</span> <span class="s">)</span><span class="sc">;</span>
                        <span class="k">return</span> <span class="i">%Ancestry</span><span class="sc">;</span>
                    <span class="s">}</span>
                    <span class="k">else</span> <span class="s">{</span>
                        <span class="i">%Ancestry</span> = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$rearrays</span>[<span class="n">0</span>]<span class="cm">,</span> -<span class="w">well</span> <span class="cm">=&gt;</span> <span class="i">$source_well</span><span class="cm">,</span> -<span class="w">ancestry</span> <span class="cm">=&gt;</span> \<span class="i">%Ancestry</span><span class="cm">,</span> -<span class="w">well_lookup</span> <span class="cm">=&gt;</span> <span class="i">$well_lookup_hash</span><span class="cm">,</span> -<span class="w">recurse</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">simple</span> <span class="cm">=&gt;</span> <span class="i">$simple</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="k">print</span> <span class="q">&quot;ERROR: Cannot follow through rearray: Target pla&quot;</span> . <span class="i">$Ancestry</span>{<span class="w">original</span>} . <span class="q">&quot; - $well does not exist in ReArray table\n&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="c">### extract extraction information... ###</span>
        <span class="c">#    my $extractions = $dbc-&gt;load_Object(-sql=&gt;&quot;SELECT DISTINCT FKSource_Plate__ID FROM Extraction WHERE FKTarget_Plate__ID in ($id) ORDER BY FKSource_Plate__ID&quot;,-format=&gt;'CA');</span>
        <span class="c">## why use retrieve ? (unnecessary) ...</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$dbc</span><span class="i">-&gt;table_loaded</span><span class="s">(</span><span class="q">'Extraction'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">@extractions</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Extraction'</span><span class="cm">,</span> <span class="q">'FKSource_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE FKTarget_Plate__ID in ($id) ORDER BY FKSource_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$extractions</span>[<span class="n">0</span>] =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">extraction_sources</span>} <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">extraction_sources</span>} }<span class="cm">,</span> <span class="i">@extractions</span> <span class="s">)</span> <span class="s">}</span>
                <span class="k">else</span>                                         <span class="s">{</span> <span class="i">$Ancestry</span>{<span class="w">extraction_sources</span>} = \<span class="i">@extractions</span> <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="c">### extract pooling information... ###</span>
        <span class="c">#    my $poolings = $dbc-&gt;load_Object(-sql=&gt;&quot;SELECT FK_Plate__ID FROM Sample_Pool,PoolSample WHERE Sample_Pool.FK_Pool__ID=PoolSample.FK_Pool__ID AND FKTarget_Plate__ID in ($id) ORDER BY FK_Plate__ID&quot;,-format=&gt;'CA');</span>

        <span class="k">my</span> <span class="i">@poolings</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Pool,PoolSample'</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_Pool.FK_Pool__ID=PoolSample.FK_Pool__ID AND FKTarget_Plate__ID in ($id) ORDER BY FK_Plate__ID&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$poolings</span>[<span class="n">0</span>] =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">pooling_sources</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">pooling_sources</span>} }<span class="cm">,</span> <span class="i">@poolings</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span> <span class="i">$Ancestry</span>{<span class="w">pooling_sources</span>} = \<span class="i">@poolings</span> <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="c">## Get Sample ID ##</span>
    <span class="c">#    my $sample = SDB::DB_Object-&gt;new(-dbc=&gt;$dbc,-tables=&gt;'Plate_Sample,Sample');</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$no_sample</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$Ancestry</span>{<span class="w">original</span>} <span class="s">)</span> <span class="s">{</span>

            <span class="c"># get plate type of original</span>
            <span class="k">my</span> <span class="i">$orig</span> = <span class="i">$Ancestry</span>{<span class="w">original</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$plate_type</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> <span class="q">&quot;Plate_Type&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($Ancestry{original})&quot;</span> <span class="s">)</span><span class="sc">;</span>

            <span class="k">my</span> <span class="i">$condition</span> = <span class="q">&quot; AND Plate_Sample.FKOriginal_Plate__ID IN ($Ancestry{original})&quot;</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$plate_type</span> =~ <span class="q">/^Library_Plate$/i</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$Ancestry</span>{<span class="w">well</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

                <span class="c"># library plate</span>
                <span class="i">$condition</span> .= <span class="q">&quot; AND Well = '$Ancestry{well}'&quot;</span><span class="sc">;</span>
            <span class="s">}</span>

            <span class="c"># don't trace back if $plate_type is Library_Plate and has no well - cannot find specific sample</span>
            <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$plate_type</span> =~ <span class="q">/^Library_Plate$/i</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$Ancestry</span>{<span class="w">well</span>} <span class="s">)</span> <span class="s">)</span> || <span class="s">(</span> <span class="i">$plate_type</span> =~ <span class="q">/^Tube$/i</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">@sample_info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate_Sample,Sample LEFT JOIN Sample_Type ON FK_Sample_Type__ID=Sample_Type_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;FK_Sample__ID,Sample_Type.Sample_Type,Sample_Name&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Sample__ID=Sample_ID $condition&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

                <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@sample_info</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="s">(</span> <span class="i">$sample_id</span><span class="cm">,</span> <span class="i">$sample_type</span><span class="cm">,</span> <span class="i">$sample_name</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$sample_info</span>[<span class="n">0</span>]<span class="sc">;</span>

                    <span class="k">if</span> <span class="s">(</span><span class="i">$sample_id</span><span class="s">)</span> <span class="s">{</span>
                        <span class="i">$Ancestry</span>{<span class="w">sample_id</span>}   = <span class="i">$sample_id</span><span class="sc">;</span>
                        <span class="i">$Ancestry</span>{<span class="w">sample_name</span>} = <span class="i">$sample_name</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="k">print</span> <span class="q">&quot;Sample not found (Plate &quot;</span> . <span class="i">$Ancestry</span>{<span class="w">original</span>} . <span class="q">&quot;; Well: &quot;</span> . <span class="i">$Ancestry</span>{<span class="w">well</span>} . <span class="q">&quot;)\n&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>

                <span class="c"># nothing - cannot find sample for nonspecific well</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/hash/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">%Ancestry</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/list/</span> &amp;&amp; <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">list</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$list</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">list</span>} }<span class="sc">;</span>
        <span class="k">return</span> <span class="i">$list</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/original/</span> &amp;&amp; <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">original</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$Ancestry</span>{<span class="w">original</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/sample_id/</span> &amp;&amp; <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">sample_id</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$Ancestry</span>{<span class="w">sample_id</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/list/</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="q">''</span> <span class="s">}</span>
    <span class="k">else</span>                        <span class="s">{</span> <span class="k">return</span> <span class="q">'0'</span> <span class="s">}</span>
<span class="s">}</span>

<span class="c">###############</span>
<a name="get_Siblings-"></a><span class="k">sub </span><span class="m">get_Siblings</span> <span class="s">{</span>
<span class="c">###############</span>
    <span class="c">#</span>
    <span class="c"># Return list of sibling containers (spawned from same parent)</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>       = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>                                                                                            <span class="c">## plate_id</span>
    <span class="k">my</span> <span class="i">$format</span>   = <span class="i">$args</span>{<span class="q">'-format'</span>} || <span class="q">'hash'</span><span class="sc">;</span>                                                                            <span class="c">## format of output ('hash' or comma-delimited 'list')</span>
    <span class="k">my</span> <span class="i">$ancestry</span> = <span class="i">$args</span>{-<span class="w">ancestry</span>}<span class="sc">;</span>                                                                                      <span class="c">## include hash if expanding</span>

    <span class="k">my</span> <span class="i">%Ancestry</span><span class="sc">;</span>
    <span class="k">if</span>   <span class="s">(</span><span class="i">$ancestry</span><span class="s">)</span> <span class="s">{</span> <span class="i">%Ancestry</span>       = <span class="i">%</span>{<span class="i">$ancestry</span>} <span class="s">}</span>                                                                   <span class="c">## update hash if provided</span>
    <span class="k">else</span>             <span class="s">{</span> <span class="i">$Ancestry</span>{<span class="w">list</span>} = <span class="s">[</span><span class="i">$id</span><span class="s">]</span> <span class="s">}</span>

    <span class="i">$Ancestry</span>{<span class="w">generation</span>}-&gt;{<span class="q">'+0'</span>} = <span class="i">$id</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$parent</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'FKParent_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID in ($id) ORDER BY Plate_ID&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$created</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Min(Plate_Created)'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID in ($id) ORDER BY Plate_ID&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$Ancestry</span>{<span class="w">created</span>}-&gt;{<span class="q">'+0'</span>} = <span class="i">$created</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$siblings</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$parent</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$siblings</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">&quot;where FKParent_Plate__ID = '$parent' ORDER BY Plate_ID&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$siblings</span> =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$Ancestry</span>{<span class="w">generation</span>}-&gt;{<span class="q">'+0'</span>} = <span class="i">$siblings</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">@sibling_list</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$siblings</span><span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">list</span>} = \<span class="i">@sibling_list</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">## generate list of formats used for this generation ##</span>

    <span class="c">#    my $label_field = &quot;concat(Well_Capacity_mL,' ',Plate_Format_Type)&quot;;</span>
    <span class="c">#my $label_field = &quot;CASE WHEN Well_Capacity_mL &gt; 0 THEN concat(Well_Capacity_mL,' mL ',Plate_Format_Type) ELSE Plate_Format_Type END as PF_Type&quot;;</span>
    <span class="k">my</span> <span class="i">$label_field</span> = <span class="q">&quot;CASE WHEN Capacity_Units = 'well' THEN concat(Wells,'-well ',Plate_Format_Type) ELSE CASE WHEN Well_Capacity_mL &gt; 0 THEN concat(Well_Capacity_mL,' mL ',Plate_Format_Type) ELSE Plate_Format_Type END END as PF_Type&quot;</span><span class="sc">;</span>
    <span class="i">$label_field</span> = <span class="q">'Sample_Type'</span> <span class="k">if</span> <span class="i">$Configs</span>{<span class="w">plateContent_tracking</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$formats</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> <span class="q">'Plate,Plate_Format,Sample_Type'</span><span class="cm">,</span> <span class="s">[</span><span class="i">$label_field</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where FK_Sample_Type__ID=Sample_Type_ID AND FK_Plate_Format__ID=Plate_Format_ID AND Plate_ID in ($siblings,$id)&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$Ancestry</span>{<span class="w">formats</span>}-&gt;{<span class="q">&quot;+0&quot;</span>} = <span class="i">$formats</span><span class="sc">;</span>

    <span class="c">## Return list or expanded hash ##</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/hash/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">%Ancestry</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/list/</span> &amp;&amp; <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">list</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$list</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">list</span>} }<span class="sc">;</span>
        <span class="k">return</span> <span class="i">$list</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/list/</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="q">''</span> <span class="s">}</span>
    <span class="k">else</span>                        <span class="s">{</span> <span class="k">return</span> <span class="q">'0'</span> <span class="s">}</span>
<span class="s">}</span>

<span class="c">#####################</span>
<a name="get_Children-"></a><span class="k">sub </span><span class="m">get_Children</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="c">#</span>
    <span class="c"># Return ids for containers spawned by given id</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>         = <span class="i">$args</span>{-<span class="w">dbc</span>}         || <span class="i">$args</span>{-<span class="w">connection</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>          = <span class="i">$args</span>{-<span class="w">id</span>}          || <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                                                                       <span class="c">## plate_id</span>
    <span class="k">my</span> <span class="i">$generations</span> = <span class="i">$args</span>{-<span class="w">generations</span>} || <span class="n">40</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format</span>      = <span class="i">$args</span>{<span class="q">'-format'</span>}    || <span class="q">'hash'</span><span class="sc">;</span>                                                                                 <span class="c">## format of output ('hash' or comma-delimited 'list')</span>
    <span class="k">my</span> <span class="i">$ancestry</span>     = <span class="i">$args</span>{-<span class="w">ancestry</span>}<span class="sc">;</span>                                                                                             <span class="c">## include hash if expanding (for repeated calls)</span>
    <span class="k">my</span> <span class="i">$include_self</span> = <span class="i">$args</span>{-<span class="w">include_self</span>} || <span class="n">0</span><span class="sc">;</span>                                                                                    <span class="c">## indicate whether to include the plate ID passed in as children list</span>
    <span class="k">my</span> <span class="i">$simple</span>       = <span class="i">$args</span>{-<span class="w">simple</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Ancestry</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$ancestry</span><span class="s">)</span> <span class="s">{</span> <span class="i">%Ancestry</span> = <span class="i">%</span>{<span class="i">$ancestry</span>} <span class="s">}</span>                                                                                      <span class="c">## update hash if provided</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$include_self</span><span class="s">)</span> <span class="s">{</span> <span class="i">$Ancestry</span>{<span class="w">list</span>} = <span class="s">[</span><span class="i">$id</span><span class="s">]</span><span class="sc">;</span> <span class="s">}</span>

    <span class="i">$Ancestry</span>{<span class="w">child_generations</span>} = <span class="n">0</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$generation</span> = <span class="i">$id</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$gen_index</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span><span class="i">$generation</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@progeny</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">&quot;where FKParent_Plate__ID in ($generation)&quot;</span><span class="cm">,</span> <span class="q">'DISTINCT'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">## Extend tracking to extractions, poolings, rearrays ##</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$simple</span><span class="s">)</span> <span class="s">{</span>
            <span class="c">## assume follow = 1, but if we need to use extended_follow this should be explicity passed as a separate parameter (and should be similar for get_Parents &amp; get_children)</span>
            <span class="k">my</span> <span class="i">@more_kids</span> = <span class="i">get_next_gen</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$generation</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="q">&quot;concat(FK_Library__Name,Plate_Number) as Pnum&quot;</span><span class="s">]</span><span class="cm">,</span> -<span class="w">follow</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$add_ons</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@more_kids</span><span class="sc">;</span>    <span class="c">## need to account for ['1','2,4,6'...]</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$child</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$add_ons</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span> <span class="i">@progeny</span><span class="cm">,</span> <span class="i">$child</span> <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$child$/</span><span class="cm">,</span> <span class="i">@progeny</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$Ancestry</span>{<span class="w">notes</span>}{<span class="q">&quot;-$gen_index&quot;</span>} .= <span class="q">&quot;Followed through rearrays;&quot;</span> <span class="k">if</span> <span class="i">@more_kids</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">unless</span> <span class="s">(</span><span class="i">@progeny</span><span class="s">)</span> <span class="s">{</span><span class="k">last</span><span class="s">}</span>

        <span class="i">$generation</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@progeny</span><span class="sc">;</span>
        <span class="i">$gen_index</span>++<span class="sc">;</span>

        <span class="i">$Ancestry</span>{<span class="w">generation</span>}-&gt;{<span class="q">&quot;+$gen_index&quot;</span>} = <span class="i">$generation</span><span class="sc">;</span>

        <span class="c">## generate list of formats used for this generation ##</span>

        <span class="c">#my $label_field = &quot;CASE WHEN Well_Capacity_mL &gt; 0 THEN concat(Well_Capacity_mL,' mL ',Plate_Format_Type) ELSE Plate_Format_Type END as PF_Type&quot;;</span>
        <span class="k">my</span> <span class="i">$label_field</span> = <span class="q">&quot;CASE WHEN Capacity_Units = 'well' THEN concat(Wells,'-well ',Plate_Format_Type) ELSE CASE WHEN Well_Capacity_mL &gt; 0 THEN concat(Well_Capacity_mL,' mL ',Plate_Format_Type) ELSE Plate_Format_Type END END as PF_Type&quot;</span><span class="sc">;</span>

        <span class="c">#        my $label_field = &quot;concat(Well_Capacity_mL,' ',Plate_Format_Type)&quot;;</span>
        <span class="i">$label_field</span> = <span class="q">'Sample_Type'</span> <span class="k">if</span> <span class="i">$Configs</span>{<span class="w">plateContent_tracking</span>}<span class="sc">;</span>    <span class="c">## change label to content type if tracking ##</span>

        <span class="k">my</span> <span class="i">$formats</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> <span class="q">'Plate,Plate_Format,Sample_Type'</span><span class="cm">,</span> <span class="s">[</span><span class="i">$label_field</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where FK_Sample_Type__ID=Sample_Type_ID AND FK_Plate_Format__ID=Plate_Format_ID AND Plate_ID in ($generation)&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">formats</span>}-&gt;{<span class="q">&quot;+$gen_index&quot;</span>} = <span class="i">$formats</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span><span class="i">$created</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span><span class="q">&quot;MIN(Plate_Created)&quot;</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID in ($generation)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">created</span>}-&gt;{<span class="q">&quot;+$gen_index&quot;</span>} = <span class="i">$created</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$test</span> = <span class="i">$Ancestry</span>{<span class="w">list</span>}<span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">list</span>} }<span class="cm">,</span> <span class="i">$generation</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Ancestry</span>{<span class="w">child_generations</span>}++<span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$gen_index</span> &gt; <span class="i">$generations</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Stopping Ancestry Extraction after $gen_index generations...&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">last</span><span class="sc">;</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">### extract extraction information... ###</span>
    <span class="c">#    my $extractions = $dbc-&gt;load_Object(-sql=&gt;&quot;SELECT DISTINCT FKTarget_Plate__ID FROM Extraction WHERE FKSource_Plate__ID in ($id) ORDER BY FKTarget_Plate__ID&quot;,-format=&gt;'CA');</span>
    <span class="c">#    my @extractions = $dbc-&gt;Table_find('Extraction','FKTarget_Plate__ID',&quot;WHERE FKSource_Plate__ID in ($id) ORDER BY FKTarget_Plate__ID&quot;,'Distinct');</span>
    <span class="c">#    if ($extractions[0] =~/[1-9]/) {</span>
    <span class="c">#	 if (defined $Ancestry{extraction_targets}) {push(@{$Ancestry{extraction_targets}}, @extractions)}</span>
    <span class="c">#	 else {$Ancestry{extraction_targets} = \@extractions}</span>
    <span class="c">#    }</span>
    <span class="k">my</span> <span class="i">@extractions</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'ReArray_Request,ReArray'</span><span class="cm">,</span> <span class="q">'FKTarget_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_ReArray_Request__ID=ReArray_Request_ID AND ReArray_Type='Extraction Rearray' AND FKSource_Plate__ID in ($id) ORDER BY FKTarget_Plate__ID&quot;</span><span class="cm">,</span> <span class="q">'Distinct'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$extractions</span>[<span class="n">0</span>] =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">rearray_targets</span>} <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">rearray_targets</span>} }<span class="cm">,</span> <span class="i">@extractions</span> <span class="s">)</span> <span class="s">}</span>
        <span class="k">else</span>                                      <span class="s">{</span> <span class="i">$Ancestry</span>{<span class="w">rearray_targets</span>} = \<span class="i">@extractions</span> <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">@rearray_pools</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span>
        <span class="q">'ReArray_Request,ReArray'</span><span class="cm">,</span> <span class="q">'FKTarget_Plate__ID'</span><span class="cm">,</span>
        <span class="q">&quot;WHERE FKSource_Plate__ID in ($id) and </span>
                                        <span class="q">                                        FK_ReArray_Request__ID = ReArray_Request_ID and ReArray_Type = 'Pool ReArray' </span>
                                        <span class="q">                                        ORDER BY FKTarget_Plate__ID&quot;</span><span class="cm">,</span>
        -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$rearray_pools</span>[<span class="n">0</span>] =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">rearray_targets</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">rearray_targets</span>} }<span class="cm">,</span> <span class="i">@rearray_pools</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$Ancestry</span>{<span class="w">rearray_targets</span>} = \<span class="i">@rearray_pools</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="c">### extract pooling information... ###</span>
    <span class="c">#    my $poolings = $dbc-&gt;load_Object(-sql=&gt;&quot;SELECT FKTarget_Plate__ID FROM Sample_Pool,PoolSample WHERE Sample_Pool.FK_Pool__ID=PoolSample.FK_Pool__ID AND FK_Plate__ID in ($id) ORDER BY FKTarget_Plate__ID&quot;,-format=&gt;'CA');</span>

    <span class="k">my</span> <span class="i">@poolings</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Pool,PoolSample'</span><span class="cm">,</span> <span class="q">'FKTarget_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_Pool.FK_Pool__ID=PoolSample.FK_Pool__ID AND FK_Plate__ID in ($id) ORDER BY FKTarget_Plate__ID&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$poolings</span>[<span class="n">0</span>] =~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c">#if (defined $Ancestry{pooling_targets}) {push(@{$Ancestry{pooling_targets}}, @$poolings)}</span>
        <span class="c">#else {$Ancestry{pooling_targets} = $poolings}</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$target</span> <span class="s">(</span><span class="i">@poolings</span><span class="s">)</span> <span class="s">{</span>    <span class="c"># Get other pooling parents as well</span>
                <span class="c">#	    my $pooling_parents = $dbc-&gt;load_Object(-sql=&gt;&quot;SELECT FK_Plate__ID FROM Sample_Pool,PoolSample WHERE Sample_Pool.FK_Pool__ID=PoolSample.FK_Pool__ID AND FKTarget_Plate__ID = $target ORDER BY FK_Plate__ID&quot;,-format=&gt;'CA');</span>
            <span class="k">my</span> <span class="i">@pooling_parents</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Pool,PoolSample'</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_Pool.FK_Pool__ID=PoolSample.FK_Pool__ID AND FKTarget_Plate__ID = $target ORDER BY FK_Plate__ID&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Ancestry</span>{<span class="w">pooling_targets</span>}{<span class="i">$target</span>} = \<span class="i">@pooling_parents</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/hash/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">%Ancestry</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/list/</span> &amp;&amp; <span class="k">defined</span> <span class="i">$Ancestry</span>{<span class="w">list</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$list</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@</span>{ <span class="i">$Ancestry</span>{<span class="w">list</span>} }<span class="sc">;</span>
        <span class="k">return</span> <span class="i">$list</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$format</span> =~ <span class="q">/list/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">''</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">'0'</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">##################</span>
<a name="get_Notes-"></a><span class="k">sub </span><span class="m">get_Notes</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="c">#</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span>   = <span class="i">$args</span>{-<span class="w">output</span>} || <span class="q">'list'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$generations</span> = <span class="i">Extract_Values</span><span class="s">(</span> <span class="s">[</span> <span class="k">shift</span><span class="cm">,</span> <span class="n">10</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plates</span> = <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%ancestry</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$generations</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">%ancestry</span> = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">simple</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$self_info</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate,Plate_Format'</span><span class="cm">,</span> <span class="q">'Plate_Comments,Plate_Format_Type'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate_Format__ID=Plate_Format_ID AND Plate_ID IN ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">### since get_Parents doesn't include self :(</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$self_comments</span><span class="cm">,</span> <span class="i">$self_format</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$self_info</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$ancestry</span>{<span class="w">comments</span>}{<span class="q">&quot;0&quot;</span>}   = <span class="i">$self_comments</span><span class="sc">;</span>
    <span class="i">$ancestry</span>{<span class="w">generation</span>}{<span class="q">&quot;0&quot;</span>} = <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="i">$ancestry</span>{<span class="w">formats</span>}{<span class="q">&quot;0&quot;</span>}    = <span class="i">$self_format</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$output</span> <span class="k">eq</span> <span class="q">'list'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@comments</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$generation</span> <span class="s">(</span> <span class="k">sort</span> <span class="s">{</span> <span class="i">$a</span> &lt;=&gt; <span class="i">$b</span> <span class="s">}</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$ancestry</span>{<span class="w">comments</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$comment</span>   = <span class="i">$ancestry</span>{<span class="w">comments</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$thisplate</span> = <span class="i">$ancestry</span>{<span class="w">generation</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$thisplate</span> =~ <span class="q">/,/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$thisplate</span> = <span class="q">'prior to pool/rearray'</span><span class="sc">;</span> <span class="s">}</span>                                                                                                  <span class="c">## dissociate notes from full generation list if &gt; 1 (pooled / rearrayed)</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$comment</span> &amp;&amp; !<span class="s">(</span> <span class="i">$comment</span> <span class="k">eq</span> <span class="q">'NULL'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

                <span class="c"># the grep'd comment is qq'd so that the contents of the comment are not interpreted as a regexp.</span>

                <span class="k">my</span> <span class="i">$quoted_comment</span> = <span class="q">qq{comment}</span><span class="sc">;</span>
                <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/\Q$quoted_comment\E/</span><span class="cm">,</span> <span class="i">@comments</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">push</span><span class="s">(</span> <span class="i">@comments</span><span class="cm">,</span> <span class="q">&quot;$thisplate: $comment.&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">return</span> <span class="i">@comments</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$output</span> <span class="k">eq</span> <span class="q">'tooltip'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@comments</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$generation</span> <span class="s">(</span> <span class="k">sort</span> <span class="s">{</span> <span class="i">$a</span> &lt;=&gt; <span class="i">$b</span> <span class="s">}</span> <span class="k">keys</span> <span class="i">%</span>{ <span class="i">$ancestry</span>{<span class="w">comments</span>} } <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$comment</span> = <span class="i">$ancestry</span>{<span class="w">comments</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$format</span>  = <span class="i">$ancestry</span>{<span class="w">formats</span>}{<span class="i">$generation</span>}<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$comment</span> &amp;&amp; !<span class="s">(</span> <span class="i">$comment</span> <span class="k">eq</span> <span class="q">'NULL'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@comments</span><span class="cm">,</span> <span class="q">&quot;$format: $comment&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">@comments</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">return</span> <span class="i">Show_Tool_Tip</span><span class="s">(</span> <span class="q">'Comments'</span><span class="cm">,</span> <span class="k">join</span><span class="s">(</span> <span class="w">lbr</span><span class="cm">,</span> <span class="i">@comments</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">return</span> <span class="q">'-'</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Error: Unknown output format '$output'&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">###############</span>
<a name="get_Reagents-"></a><span class="k">sub </span><span class="m">get_Reagents</span> <span class="s">{</span>
<span class="c">###############</span>
    <span class="c">#</span>
    <span class="c"># get list of original reagents applied to container(s)</span>
    <span class="c">#</span>

<span class="s">}</span>

<span class="c">###################################################################################################################</span>
<span class="c"># Withdraw sample from tube or plate and update quantity used</span>
<span class="c"># Returns a hash that indicates whether the withdraw is OK and update Current_Volume.</span>
<span class="c"># - If choose to update, then the number of records updated will be returned as well</span>
<span class="c">###################################################################################################################</span>
<a name="withdraw_sample-"></a><span class="k">sub </span><span class="m">withdraw_sample</span> <span class="s">{</span>
    <span class="c">########################</span>
    <span class="k">my</span> <span class="i">$self</span>              = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>              = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>               = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$withdraw_quantity</span> = <span class="i">$args</span>{-<span class="w">quantity</span>}<span class="sc">;</span>                                                                                <span class="c"># Quantity to be withdrwan  (for plates - quantity is per well)</span>
    <span class="k">my</span> <span class="i">$withdraw_units</span>    = <span class="i">$args</span>{-<span class="w">units</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$update</span>            = <span class="i">$args</span>{-<span class="w">update</span>} || <span class="n">0</span><span class="sc">;</span>                                                                             <span class="c"># Whether to update the databas with the new Quantity_Used and new Quantity_Used_Units</span>
    <span class="k">my</span> <span class="i">$empty</span>             = <span class="i">$args</span>{-<span class="w">empty</span>}<span class="sc">;</span>                                                                                   <span class="c"># flag to empty current plate (and throw away plate)</span>

    <span class="k">my</span> <span class="i">$current_volume</span>       = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Current_Volume'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$current_volume_units</span> = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Current_Volume_Units'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$empty</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$withdraw_quantity</span> = <span class="i">$current_volume</span><span class="sc">;</span>
        <span class="i">$withdraw_units</span>    = <span class="i">$current_volume_units</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;emptying $self-&gt;{plate_id}&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">throw_away</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>}<span class="cm">,</span> -<span class="w">confirmed</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">%retval</span><span class="sc">;</span>

    <span class="c"># Normalize the units</span>
    <span class="k">my</span> <span class="i">$withdraw_base_units</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$current_volume_base_units</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$withdraw_units</span>       =~ <span class="q">/(l|g)$/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$withdraw_base_units</span>       = <span class="i">$1</span> <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$current_volume_units</span> =~ <span class="q">/(l|g)$/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$current_volume_base_units</span> = <span class="i">$1</span> <span class="s">}</span>

    <span class="s">(</span> <span class="i">$withdraw_quantity</span><span class="cm">,</span> <span class="i">$withdraw_units</span> <span class="s">)</span>       = <span class="i">&amp;convert_to_mils</span><span class="s">(</span> <span class="i">$withdraw_quantity</span><span class="cm">,</span> <span class="i">$withdraw_units</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$current_volume</span><span class="cm">,</span>    <span class="i">$current_volume_units</span> <span class="s">)</span> = <span class="i">&amp;convert_to_mils</span><span class="s">(</span> <span class="i">$current_volume</span><span class="cm">,</span>    <span class="i">$current_volume_units</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$current_volume_base_units</span> =~ <span class="q">/g/</span> &amp;&amp; !<span class="i">$empty</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Sess</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Not tracking sample qty (g)&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> !<span class="i">$withdraw_base_units</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## undefined withdrawal volume units</span>
        <span class="i">$Sess</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Units required for amount to withdraw&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$retval</span>{<span class="w">error</span>} = <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> !<span class="i">$current_volume_base_units</span> &amp;&amp; <span class="k">defined</span> <span class="i">$current_volume</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## undefined current volume units</span>
        <span class="i">$Sess</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;current volume has no units ??&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$retval</span>{<span class="w">error</span>} = <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="k">lc</span><span class="s">(</span><span class="i">$current_volume_base_units</span><span class="s">)</span> <span class="k">ne</span> <span class="k">lc</span><span class="s">(</span><span class="i">$withdraw_base_units</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## do not track g if l removed (and visa versa)</span>
        <span class="i">$Sess</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Not tracking withdrawal of $withdraw_base_units (current qty in $current_volume_units)&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> !<span class="s">(</span> <span class="k">defined</span> <span class="i">$current_volume</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>                                  <span class="c">## not tracking source volume</span>
        <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Note: Current Volume not being tracked in Source Container&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$withdraw_quantity</span> &gt; <span class="i">$current_volume</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$withdraw_quantity</span><span class="cm">,</span> <span class="i">$withdraw_units</span> <span class="s">)</span> = <span class="i">&amp;Get_Best_Units</span><span class="s">(</span> -<span class="w">amount</span> <span class="cm">=&gt;</span> <span class="i">$withdraw_quantity</span><span class="cm">,</span> -<span class="w">units</span> <span class="cm">=&gt;</span> <span class="i">$withdraw_units</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Sess</span><span class="i">-&gt;warning</span><span class="s">(</span>
                <span class="q">&quot;Not enough sample to be withdrawn from $self-&gt;{prefix}$self-&gt;{plate_id}. (Current quantity: $current_volume $current_volume_units; Quantity attemped to withdraw: $withdraw_quantity $withdraw_units) Setting current volume to zero.&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">$current_volume</span> = <span class="q">'0'</span><span class="sc">;</span>
            <span class="c">## leave units as they were.. ##</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="c">## we need to track the amount ... ##</span>
            <span class="i">$current_volume</span> -= <span class="i">$withdraw_quantity</span><span class="sc">;</span>
            <span class="s">(</span> <span class="i">$current_volume</span><span class="cm">,</span> <span class="i">$current_volume_units</span> <span class="s">)</span> = <span class="i">&amp;Get_Best_Units</span><span class="s">(</span> -<span class="w">amount</span> <span class="cm">=&gt;</span> <span class="i">$current_volume</span><span class="cm">,</span> -<span class="w">units</span> <span class="cm">=&gt;</span> <span class="i">$current_volume_units</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$retval</span>{<span class="w">error</span>} = <span class="n">0</span><span class="sc">;</span>
        <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;reset volume for $self-&gt;{prefix}$self-&gt;{plate_id} to $current_volume ($current_volume_units) (used $withdraw_quantity)&quot;</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span><span class="i">$update</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$update</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$updated</span> = <span class="i">$self</span><span class="i">-&gt;update</span><span class="s">(</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">'Current_Volume'</span><span class="cm">,</span> <span class="q">'Current_Volume_Units'</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="i">$current_volume</span><span class="cm">,</span> <span class="i">$current_volume_units</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$updated</span>-&gt;{<span class="w">Plate</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="i">$retval</span>{<span class="w">updated</span>} = <span class="i">$updated</span>-&gt;{<span class="w">Plate</span>}<span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$retval</span>{<span class="w">error</span>} = <span class="n">1</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="s">(</span> <span class="i">$retval</span>{<span class="w">quantity_used</span>}<span class="cm">,</span> <span class="i">$retval</span>{<span class="w">quantity_used_units</span>} <span class="s">)</span> = <span class="i">&amp;Get_Best_Units</span><span class="s">(</span> -<span class="w">amount</span> <span class="cm">=&gt;</span> <span class="i">$withdraw_quantity</span><span class="cm">,</span> -<span class="w">units</span> <span class="cm">=&gt;</span> <span class="i">$withdraw_units</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="s">(</span> <span class="i">$retval</span>{<span class="w">quantity_used</span>}<span class="cm">,</span> <span class="i">$retval</span>{<span class="w">quantity_used_units</span>} <span class="s">)</span> = <span class="i">&amp;Get_Best_Units</span><span class="s">(</span> -<span class="w">amount</span> <span class="cm">=&gt;</span> <span class="i">$withdraw_quantity</span><span class="cm">,</span> -<span class="w">units</span> <span class="cm">=&gt;</span> <span class="i">$withdraw_units</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$retval</span>{<span class="w">quantity_available</span>}       = <span class="i">$current_volume</span><span class="sc">;</span>
    <span class="i">$retval</span>{<span class="w">quantity_available_units</span>} = <span class="i">$current_volume_units</span><span class="sc">;</span>

    <span class="k">return</span> \<span class="i">%retval</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################################################</span>
<span class="c"># Gets the remaining quantity of a tube or plate</span>
<span class="c"># Returns an array of quantity and units</span>
<span class="c">#################################################</span>
<a name="get_remaining_quantity-"></a><span class="k">sub </span><span class="m">get_remaining_quantity</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$quantity</span><span class="cm">,</span> <span class="i">$quantity_units</span> <span class="s">)</span> = <span class="s">(</span> <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Current_Volume'</span><span class="s">)</span><span class="cm">,</span> <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Current_Volume_Units'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">(</span> <span class="i">$quantity</span><span class="cm">,</span> <span class="i">$quantity_units</span> <span class="s">)</span> = <span class="i">&amp;Get_Best_Units</span><span class="s">(</span> -<span class="w">amount</span> <span class="cm">=&gt;</span> <span class="i">$quantity</span><span class="cm">,</span> -<span class="w">units</span> <span class="cm">=&gt;</span> <span class="i">$quantity_units</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$quantity</span><span class="cm">,</span> <span class="i">$quantity_units</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#########################</span>
<a name="get_Plate_notes-"></a><span class="k">sub </span><span class="m">get_Plate_notes</span> <span class="s">{</span>
<span class="c">#########################</span>

    <span class="k">my</span> <span class="i">$dbc</span>         = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate</span>       = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$generations</span> = <span class="i">Extract_Values</span><span class="s">(</span> <span class="s">[</span> <span class="k">shift</span><span class="cm">,</span> <span class="n">10</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plates</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$generations</span><span class="s">)</span> <span class="s">{</span>

        <span class="c">#$plates = &amp;get_Plate_parents($dbc,$plate,$generations);</span>
        <span class="i">$plates</span> = <span class="i">get_Parents</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$plate</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span><span class="cm">,</span> -<span class="w">generations</span> <span class="cm">=&gt;</span> <span class="i">$generations</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@comments</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$thisplate</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$plates</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$comment</span> = <span class="k">join</span> <span class="q">'; '</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_Comments'</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID=$thisplate&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$comment</span> &amp;&amp; !<span class="s">(</span> <span class="i">$comment</span> <span class="k">eq</span> <span class="q">'NULL'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/$comment/</span><span class="cm">,</span> <span class="i">@comments</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@comments</span><span class="cm">,</span> <span class="q">&quot;$thisplate: $comment.&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@comments</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># Part 1: Trigger to warn users that inherited plate attributes are not applied to existing daughters.</span>
<span class="c"># part 2: to update sample records if Source ID is not set</span>
<span class="c"># part 3: to calculate and update plate volumes if the attribute name is &quot;Measured_Tube_Weight_in_g&quot; and Plate_Format.Wells = 1 AND Container Format has defined Empty_Container_Weight_in_g.</span>
<span class="c">#</span>
<span class="c">###############################</span>
<a name="Plate_Attribute_trigger-"></a><span class="k">sub </span><span class="m">Plate_Attribute_trigger</span> <span class="s">{</span>
<span class="c">###############################</span>
    <span class="k">my</span> <span class="i">%args</span>      = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>       = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$record_id</span> = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Plate_Attribute,Attribute'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'Attribute_Name'</span><span class="cm">,</span> <span class="q">'Attribute_Value'</span><span class="cm">,</span> <span class="q">'Inherited'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Attribute__ID=Attribute_ID AND Plate_Attribute_ID = $record_id&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#print Dumper \%info;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">defined</span> <span class="i">$info</span>{<span class="w">FK_Plate__ID</span>}[<span class="n">0</span>] || !<span class="i">$info</span>{<span class="w">FK_Plate__ID</span>}[<span class="n">0</span>] <span class="s">)</span> <span class="s">{</span><span class="k">return</span><span class="s">}</span>

    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$info</span>{<span class="w">FK_Plate__ID</span>}[<span class="n">0</span>]<span class="sc">;</span>

    <span class="c">## PART 1</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$info</span>{<span class="w">Inherited</span>}[<span class="n">0</span>] =~ <span class="q">/Yes/xms</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$daughters</span> = <span class="i">get_Children</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span><span class="cm">,</span> -<span class="w">include_self</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$daughters</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Warning = Daughter plates exist that will not inherit this attribute ($daughters)&quot;</span><span class="s">)</span> <span class="s">}</span>
    <span class="s">}</span>
    <span class="c">## PART 2</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$info</span>{<span class="w">Attribute_Name</span>}[<span class="n">0</span>] <span class="k">eq</span> <span class="q">'Redefined_Source_For'</span> &amp;&amp; <span class="i">$info</span>{<span class="w">Attribute_Value</span>}[<span class="n">0</span>] <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$source_id</span> = <span class="i">$info</span>{<span class="w">Attribute_Value</span>}[<span class="n">0</span>]<span class="sc">;</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_update</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Sample'</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="q">'FK_Source__ID'</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="i">$source_id</span><span class="cm">,</span> -<span class="w">condition</span> <span class="cm">=&gt;</span> <span class="q">&quot;WHERE FKOriginal_Plate__ID = $plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## PART 3</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$info</span>{<span class="w">Attribute_Name</span>}[<span class="n">0</span>] <span class="k">eq</span> <span class="q">'Measured_Tube_Weight_in_g'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%plate_format</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Plate,Plate_Format'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Wells'</span><span class="cm">,</span> <span class="q">'Empty_Container_Weight_in_g'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate.FK_Plate_Format__ID = Plate_Format_ID AND Plate_ID = $plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$plate_format</span>{<span class="w">Wells</span>}[<span class="n">0</span>] &amp;&amp; <span class="i">$plate_format</span>{<span class="w">Wells</span>}[<span class="n">0</span>] == <span class="n">1</span> &amp;&amp; <span class="k">defined</span> <span class="i">$plate_format</span>{<span class="w">Empty_Container_Weight_in_g</span>}[<span class="n">0</span>] <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$content_weight_in_g</span> = <span class="i">$info</span>{<span class="w">Attribute_Value</span>}[<span class="n">0</span>] - <span class="i">$plate_format</span>{<span class="w">Empty_Container_Weight_in_g</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="c">## convert to volume unit ( g -&gt; ml )</span>
            <span class="k">my</span> <span class="i">$content_volume_in_ml</span> = <span class="i">$content_weight_in_g</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$content_volume_in_ml</span> &gt;= <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="s">(</span> <span class="i">$amount</span><span class="cm">,</span> <span class="i">$units</span> <span class="s">)</span> = <span class="i">Get_Best_Units</span><span class="s">(</span> -<span class="w">amount</span> <span class="cm">=&gt;</span> <span class="i">$content_volume_in_ml</span><span class="cm">,</span> -<span class="w">units</span> <span class="cm">=&gt;</span> <span class="q">'ml'</span><span class="cm">,</span> -<span class="w">base</span> <span class="cm">=&gt;</span> <span class="q">'l'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="q">'Current_Volume,Current_Volume_Units'</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="q">&quot;$amount,$units&quot;</span><span class="cm">,</span> -<span class="w">condition</span> <span class="cm">=&gt;</span> <span class="q">&quot;WHERE Plate_ID = $plate_id&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span>
                    <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Calculated volume as $amount $units (assuming water density)&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>

        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################################</span>
<span class="c"># Function for deleting containers</span>
<span class="c">######################################</span>
<a name="Delete_Container-"></a><span class="k">sub </span><span class="m">Delete_Container</span> <span class="s">{</span>
<span class="c">##########################</span>
    <span class="k">my</span> <span class="i">%args</span>    = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,id'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'self|dbc'</span><span class="cm">,</span> -<span class="w">self</span> <span class="cm">=&gt;</span> <span class="q">'alDente::Container'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$self</span>    = <span class="i">$args</span>{-<span class="w">self</span>}<span class="sc">;</span>                                                                                       <span class="c">## enable use as either method or function</span>
    <span class="k">my</span> <span class="i">$dbc</span>     = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span>     = <span class="i">$args</span>{-<span class="w">ids</span>} || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$replace</span> = <span class="i">$args</span>{-<span class="w">replace</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$cascade</span> = <span class="i">$args</span>{-<span class="w">cascade</span>}<span class="sc">;</span>                                                                                    <span class="c">## additional tables to include in cascade delete if desired</span>
    <span class="k">my</span> <span class="i">$force</span>   = <span class="i">$args</span>{-<span class="w">force</span>}<span class="sc">;</span>                                                                                      <span class="c">## force deletion even if Plate_Prep records exist</span>
    <span class="k">my</span> <span class="i">$confirm</span> = <span class="i">$args</span>{-<span class="w">confirm</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$force_hours</span> = <span class="n">4</span><span class="sc">;</span>                                                                                              <span class="c">## force deletion if plate created within this number of hours (and current user created plate)</span>
    <span class="k">my</span> <span class="i">@info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FK_Employee__ID'</span><span class="cm">,</span> <span class="q">&quot;CASE WHEN NOW() &lt; ADDTIME(Plate_Created,'$force_hours:00') THEN 'ON' ELSE 'OFF' END as Force_Expiry&quot;</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($ids)&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@info</span><span class="s">)</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## all plates associated with the same user and have the same force expiry status ##</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$emp</span><span class="cm">,</span> <span class="i">$forced</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$info</span>[<span class="n">0</span>]<span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$emp</span> == <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'user_id'</span><span class="s">)</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$forced</span> <span class="k">eq</span> <span class="q">'ON'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## current user created plate, and plate created within the last hour ##</span>
            <span class="i">$force</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@cascade</span> = <span class="s">(</span> <span class="q">'Library_Plate'</span><span class="cm">,</span> <span class="q">'Tube'</span><span class="cm">,</span> <span class="q">'Array'</span><span class="cm">,</span> <span class="q">'Plate_Set'</span><span class="cm">,</span> <span class="q">'Plate_Attribute'</span><span class="cm">,</span> <span class="q">'Plate_Schedule'</span><span class="cm">,</span> <span class="q">'Plate_Tray'</span><span class="cm">,</span> <span class="q">'Invoiceable_Work'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$force</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@cascade</span> = <span class="s">(</span> <span class="q">'Plate_Prep'</span><span class="cm">,</span> <span class="i">@cascade</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$cascade</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@cascade</span><span class="cm">,</span> <span class="i">@$cascade</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$dbc</span><span class="i">-&gt;check_permissions</span><span class="s">(</span> <span class="i">$user_id</span><span class="cm">,</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'delete'</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="i">$ids</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># First see whether user has permission to delete at the DBTable level</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="i">$confirm</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Sess</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$Sess</span><span class="i">-&gt;warning</span><span class="s">(</span> <span class="q">&quot;Are you sure you want to delete these plate(s) ($ids) ?&quot;</span><span class="cm">,</span> -<span class="w">now</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="c">## Command-line</span>
                <span class="k">my</span> <span class="i">$ok</span> = <span class="i">Prompt_Input</span><span class="s">(</span> -<span class="w">prompt</span> <span class="cm">=&gt;</span> <span class="q">&quot;Are you sure you want to delete these plate(s) ($ids) ?&quot;</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'c'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$ok</span> !~ <span class="q">/^y/i</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="q">&quot;Aborting deletion\n&quot;</span><span class="sc">;</span> <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="c"># Find out whether there are any original plates.  If so, then special handling is needed and only lab admins should be able to delete them</span>
        <span class="k">my</span> <span class="i">%info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
            <span class="q">'Plate LEFT JOIN ReArray_Request ON ReArray_Request.FKTarget_Plate__ID=Plate_ID LEFT JOIN Sample_Pool ON Sample_Pool.FKTarget_Plate__ID=Plate_ID'</span><span class="cm">,</span>
            <span class="s">[</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">'FKOriginal_Plate__ID'</span><span class="cm">,</span> <span class="q">'Group_Concat(ReArray_Request_ID) as ReArrays'</span><span class="cm">,</span> <span class="q">'Group_Concat(FK_Pool__ID) as Pools'</span> <span class="s">]</span><span class="cm">,</span>
            <span class="q">&quot;WHERE Plate_ID IN ($ids) GROUP BY Plate_ID&quot;</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="i">@info</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;warning</span><span class="s">(</span> <span class="q">&quot;No plates found to delete (?)&quot;</span><span class="cm">,</span> -<span class="w">session</span> <span class="cm">=&gt;</span> <span class="i">$Sess</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$info</span>{<span class="w">Plate_ID</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$pid</span>     = <span class="i">$info</span>{<span class="w">Plate_ID</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$opid</span>    = <span class="i">$info</span>{<span class="w">FKOriginal_Plate__ID</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$rearray</span> = <span class="i">$info</span>{<span class="w">ReArrays</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$pool</span>    = <span class="i">$info</span>{<span class="w">Pools</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="i">$index</span>++<span class="sc">;</span>

            <span class="k">my</span> <span class="i">$original</span> = <span class="n">0</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">@sids</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$ok</span>  = <span class="n">0</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$ok2</span> = <span class="n">0</span><span class="sc">;</span>

            <span class="c"># check if the current plate is an original palte</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$pid</span> == <span class="i">$opid</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$original</span> = <span class="n">1</span><span class="sc">;</span>
            <span class="s">}</span>

            <span class="c"># ensure that original plates can only be deleted by Administrators</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$original</span> &amp;&amp; <span class="i">$Security</span> &amp;&amp; !<span class="i">$Security</span><span class="i">-&gt;department_access</span><span class="s">(</span><span class="i">$Current_Department</span><span class="s">)</span> =~ <span class="q">/\bAdmin\b/i</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$Sess</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;ERROR: Cannot delete Plate ($pid). Original plates can only be deleted by lab admins.&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">next</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$original</span><span class="s">)</span> <span class="s">{</span>
                    <span class="i">@sids</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate,Sample,Plate_Sample'</span><span class="cm">,</span> <span class="q">&quot;Sample_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample.Sample_ID = Plate_Sample.FK_Sample__ID AND Plate.Plate_ID = Plate_Sample.FKOriginal_Plate__ID AND Plate_Sample.FKOriginal_Plate__ID in ($pid)&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>

                <span class="i">$dbc</span><span class="i">-&gt;start_trans</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&quot;delete_container $pid&quot;</span> <span class="s">)</span><span class="sc">;</span>

                <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Deleting (O: $original; R: $rearray; P: $pool) $pid vs $opid &quot;</span><span class="s">)</span><span class="sc">;</span>

                <span class="c"># Delete the plate</span>
                <span class="k">my</span> <span class="i">$plate_cascade</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$rearray</span><span class="s">)</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="i">$clear_rearray_ok</span> = <span class="i">$dbc</span><span class="i">-&gt;delete_records</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'ReArray_Request'</span><span class="cm">,</span> -<span class="w">id_list</span> <span class="cm">=&gt;</span> <span class="i">$rearray</span><span class="cm">,</span> -<span class="w">cascade</span> <span class="cm">=&gt;</span> <span class="i">get_cascade_tables</span><span class="s">(</span><span class="q">'ReArray_Request'</span><span class="s">)</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Removed ReArray Request ($rearray) for plate $pid.&quot;</span><span class="s">)</span><span class="sc">;</span>
                    <span class="i">$plate_cascade</span> = <span class="i">get_cascade_tables</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Rearray'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">elsif</span> <span class="s">(</span><span class="i">$pool</span><span class="s">)</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="i">$clear_pool_ok</span> = <span class="i">$dbc</span><span class="i">-&gt;delete_records</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Pool'</span><span class="cm">,</span> -<span class="w">id_list</span> <span class="cm">=&gt;</span> <span class="i">$pool</span><span class="cm">,</span> -<span class="w">cascade</span> <span class="cm">=&gt;</span> <span class="i">get_cascade_tables</span><span class="s">(</span><span class="q">'Pool'</span><span class="s">)</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Removed Pool ($pool) for plate $pid.&quot;</span><span class="s">)</span><span class="sc">;</span>
                    <span class="i">$plate_cascade</span> = <span class="i">get_cascade_tables</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Original'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">elsif</span> <span class="s">(</span><span class="i">$original</span><span class="s">)</span> <span class="s">{</span>
                    <span class="i">$plate_cascade</span> = <span class="i">get_cascade_tables</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Original'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="i">$plate_cascade</span> = <span class="i">get_cascade_tables</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Daughter'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>

                <span class="k">if</span> <span class="s">(</span><span class="i">$force</span><span class="s">)</span> <span class="s">{</span>
                    <span class="k">push</span> <span class="i">@$plate_cascade</span><span class="cm">,</span> <span class="q">'Plate_Prep'</span><span class="sc">;</span>
                <span class="s">}</span>

                <span class="k">my</span> <span class="i">$invoiceable_work_cascade</span> = <span class="i">get_cascade_tables</span><span class="s">(</span><span class="q">'Invoiceable_Work'</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">%cascade_list</span>             = <span class="s">(</span>
                    <span class="q">'Invoiceable_Work'</span> <span class="cm">=&gt;</span> <span class="i">$invoiceable_work_cascade</span><span class="cm">,</span>
                    <span class="q">'Plate'</span>            <span class="cm">=&gt;</span> <span class="i">$plate_cascade</span><span class="cm">,</span>
                <span class="s">)</span><span class="sc">;</span>

                <span class="k">my</span> <span class="i">%cascade_condition</span> = <span class="s">(</span> <span class="q">'Invoiceable_Work'</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="q">'Invoiceable_Work_Reference'</span> <span class="cm">=&gt;</span> <span class="q">'Invoiceable_Work_Reference.FK_Invoice__ID IS NULL'</span><span class="cm">,</span> <span class="s">}</span><span class="cm">,</span> <span class="s">)</span><span class="sc">;</span>

                <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;delete_records</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> -<span class="w">id_list</span> <span class="cm">=&gt;</span> <span class="i">$pid</span><span class="cm">,</span> -<span class="w">cascade</span> <span class="cm">=&gt;</span> \<span class="i">%cascade_list</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">replace</span> <span class="cm">=&gt;</span> <span class="i">$replace</span><span class="cm">,</span> -<span class="w">cascade_condition</span> <span class="cm">=&gt;</span> \<span class="i">%cascade_condition</span> <span class="s">)</span><span class="sc">;</span>

                <span class="c">#if the plate was deleted successfully</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span>
                    <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;message</span><span class="s">(</span> -<span class="w">text</span> <span class="cm">=&gt;</span> <span class="q">&quot;Plate $pid deleted successfully&quot;</span><span class="cm">,</span> -<span class="w">session</span> <span class="cm">=&gt;</span> <span class="i">$Sess</span> <span class="s">)</span><span class="sc">;</span>

                    <span class="c"># if the plate has samples associated with it delete them</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@sids</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> &amp;&amp; !<span class="i">$rearray</span> <span class="s">)</span> <span class="s">{</span>

                        <span class="c"># Delete the sample records</span>
                        <span class="k">my</span> <span class="i">$ids</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@sids</span><span class="sc">;</span>
                        <span class="i">$ok2</span> = <span class="i">$dbc</span><span class="i">-&gt;delete_records</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Sample'</span><span class="cm">,</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'Sample_ID'</span><span class="cm">,</span> -<span class="w">id_list</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
                        <span class="k">if</span> <span class="s">(</span><span class="i">$ok2</span><span class="s">)</span> <span class="s">{</span>
                            <span class="c">## deleted samples successfully ##</span>
                            <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span><span class="q">&quot;delete_container $pid&quot;</span><span class="s">)</span><span class="sc">;</span>
                        <span class="s">}</span>
                        <span class="k">else</span> <span class="s">{</span>
                            <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span> <span class="q">&quot;delete_container $pid&quot;</span><span class="cm">,</span> <span class="q">'Failed to delete associated samples'</span> <span class="s">)</span><span class="sc">;</span>
                        <span class="s">}</span>
                    <span class="s">}</span>
                    <span class="k">else</span> <span class="s">{</span>
                        <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span><span class="q">&quot;delete_container $pid&quot;</span><span class="s">)</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span> <span class="q">&quot;delete_container $pid&quot;</span><span class="cm">,</span> -<span class="w">error</span> <span class="cm">=&gt;</span> <span class="q">&quot;Failed to delete $self-&gt;{prefix} $pid&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;User does not have permission to delete these plates&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################################################</span>
<span class="c"># Function that handles the deletion of plate set and plate</span>
<span class="c">############################################################</span>
<a name="_delete-"></a><span class="k">sub </span><span class="m">_delete</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span>  = <span class="i">$args</span>{-<span class="w">ids</span>}<span class="sc">;</span>
    <span class="i">$dbc</span><span class="i">-&gt;delete_records</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$ids</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#############################</span>
<span class="c">## Act on current Plate(s) ##</span>
<span class="c">#############################</span>

<span class="c">###############</span>
<a name="add_Note-"></a><span class="k">sub </span><span class="m">add_Note</span> <span class="s">{</span>
<span class="c">###############</span>
    <span class="c">#</span>
    <span class="c"># Add comments for this plate</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$self</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'plate_id,notes'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$notes</span>    = <span class="i">$args</span>{-<span class="w">notes</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ok_msg</span>     = <span class="q">&quot;Annotated &quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@field_list</span> = <span class="s">(</span><span class="q">'Plate_Comments'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$new_notes</span>  = <span class="i">$dbc</span><span class="i">-&gt;dbh</span><span class="s">(</span><span class="s">)</span><span class="i">-&gt;quote</span><span class="s">(</span><span class="q">&quot;; $notes&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$first_note</span> = <span class="i">$dbc</span><span class="i">-&gt;dbh</span><span class="s">(</span><span class="s">)</span><span class="i">-&gt;quote</span><span class="s">(</span><span class="q">&quot;; $notes&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@value_list</span> = <span class="s">(</span><span class="q">&quot;CASE WHEN Plate_Comments IS NULL THEN $first_note ELSE CONCAT(Plate_Comments,$new_notes) END&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> \<span class="i">@field_list</span><span class="cm">,</span> \<span class="i">@value_list</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID in ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;$ok_msg $ok Plate(s)&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;No changes made to database&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c"># Creates a record in the Fail table</span>
<span class="c">#</span>
<span class="c">########################</span>
<a name="fail_container-"></a><span class="k">sub </span><span class="m">fail_container</span> <span class="s">{</span>
<span class="c">##########################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_ids,reason_id,notes,throw_out'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_ids,reason_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>        = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_ids</span>  = <span class="i">$args</span>{-<span class="w">plate_ids</span>}<span class="sc">;</span>                                                               <span class="c">## (string) list of plate ids</span>
    <span class="k">my</span> <span class="i">$reason_id</span>  = <span class="i">$args</span>{-<span class="w">reason_id</span>}<span class="sc">;</span>                                                               <span class="c">## FK_FailReason__ID</span>
    <span class="k">my</span> <span class="i">$notes</span>      = <span class="i">$args</span>{-<span class="w">notes</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$throw_away</span> = <span class="i">$args</span>{-<span class="w">throw_out</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$started</span><span class="sc">;</span>
    <span class="i">$started</span> = <span class="i">$dbc</span><span class="i">-&gt;start_trans</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'fail_container'</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$dbc</span><span class="sc">;</span>                                <span class="c">### start transaction</span>

    <span class="c">## Find the list of plates that have been thrown out or failed in the given list of plates</span>
    <span class="k">my</span> <span class="i">@plate_list</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> <span class="q">&quot;Plate_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($plate_ids) and (Plate_Status = 'Failed' OR Plate_Status = 'Thrown Out')&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@failed_plates</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span>
        <span class="q">&quot;Fail,FailReason,Object_Class&quot;</span><span class="cm">,</span> <span class="q">&quot;Object_ID&quot;</span><span class="cm">,</span>
        <span class="q">&quot;WHERE Object_ID IN ($plate_ids) and FK_FailReason__ID = FailReason_ID and </span>
                                          <span class="q">                                          Object_Class_ID = Fail.FK_Object_Class__ID and Object_Class = 'Plate'&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">@plate_list</span> &amp;&amp; <span class="i">@failed_plates</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$failed_plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@plate_list</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Sess</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;The following plates ($failed_plates) have been failed already&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## Create the failure prep</span>
    <span class="c">## Should be done this way, but Record does not support Transactions just yet &lt;CONSTRUCTION&gt;</span>
    <span class="c">#    my %input;</span>
    <span class="c">#    $input{'Current Plates'} = $ids;</span>
    <span class="c">#    $input{'Prep_Comments'} = $fail_reason</span>
    <span class="c">#    $Prep-&gt;Record(-ids=&gt;$ids,-protocol=&gt;'Standard',-step=&gt;'Fail Plate',-input=&gt;\%input);</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$std_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Lab_Protocol'</span><span class="cm">,</span> <span class="q">'Lab_Protocol_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Lab_Protocol_Name = 'Standard'&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$failreason_name</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'FailReason'</span><span class="cm">,</span> <span class="q">'FailReason_Name'</span><span class="cm">,</span> <span class="q">&quot;WHERE FailReason_ID=$reason_id&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$prep_id</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="q">'Prep'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Prep_Name'</span><span class="cm">,</span> <span class="q">'FK_Employee__ID'</span><span class="cm">,</span> <span class="q">'Prep_DateTime'</span><span class="cm">,</span> <span class="q">'Prep_Comments'</span><span class="cm">,</span> <span class="q">'FK_Lab_Protocol__ID'</span> <span class="s">]</span><span class="cm">,</span> <span class="s">[</span> <span class="q">&quot;Fail Plate: $failreason_name;&quot;</span><span class="cm">,</span> <span class="i">$user_id</span><span class="cm">,</span> <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="i">$notes</span><span class="cm">,</span> <span class="i">$std_id</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$index</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%plate_prep_inserts</span><span class="sc">;</span>
    <span class="k">map</span> <span class="s">{</span> <span class="i">$plate_prep_inserts</span>{ ++<span class="i">$index</span> } = <span class="s">[</span> <span class="i">$_</span><span class="cm">,</span> <span class="i">$prep_id</span> <span class="s">]</span> <span class="s">}</span> <span class="k">split</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$plate_ids</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$pp_newids</span> = <span class="i">$dbc</span><span class="i">-&gt;smart_append</span><span class="s">(</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="q">'Plate_Prep'</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'FK_Prep__ID'</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> \<span class="i">%plate_prep_inserts</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$new_pps</span><span class="sc">;</span>
    <span class="i">$new_pps</span> = <span class="k">scalar</span><span class="s">(</span> <span class="i">@</span>{ <span class="i">$pp_newids</span>-&gt;{<span class="w">Plate_Prep</span>}-&gt;{<span class="w">newids</span>} } <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$pp_newids</span>-&gt;{<span class="w">Plate_Prep</span>}-&gt;{<span class="w">newids</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$fails_ref</span> = <span class="i">alDente::Fail::Fail</span><span class="s">(</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span><span class="cm">,</span> -<span class="w">object</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">reason</span> <span class="cm">=&gt;</span> <span class="i">$reason_id</span><span class="cm">,</span> -<span class="w">comments</span> <span class="cm">=&gt;</span> <span class="i">$notes</span><span class="cm">,</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$count</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$fails_ref</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$count</span> = <span class="k">scalar</span> <span class="i">@</span>{<span class="i">$fails_ref</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$throw_away</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">throw_away</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span><span class="cm">,</span> -<span class="w">notes</span> <span class="cm">=&gt;</span> <span class="i">$notes</span><span class="cm">,</span> -<span class="w">confirmed</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$count</span> &amp;&amp; <span class="i">$started</span> &amp;&amp; <span class="i">$prep_id</span> &amp;&amp; <span class="i">$new_pps</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span><span class="q">'fail_container'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;Failed plate(s): $plate_ids&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>

        <span class="c">#      Call_Stack();</span>
        <span class="i">$dbc</span><span class="i">-&gt;rollback_trans</span><span class="s">(</span> <span class="q">'fail_container'</span><span class="cm">,</span> -<span class="w">error</span> <span class="cm">=&gt;</span> <span class="q">'No plates failed'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;An error has occured!&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c"># Button and setting the pipeline for a plate</span>
<span class="c">#</span>
<span class="c"># Returns:  button and dropdown list</span>
<span class="c">######################</span>
<a name="set_pipeline_btn-"></a><span class="k">sub </span><span class="m">set_pipeline_btn</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'dbc'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_set</span> = <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Set Pipeline for Plate'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'Set Pipeline for Plate'</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Action'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$pipeline_set</span> .= <span class="i">&amp;alDente::Tools::search_list</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'FK_Pipeline__ID'</span><span class="cm">,</span> -<span class="w">filter_by_dept</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">search</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">filter</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$pipeline_set</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Catches the parameters for a pipeline</span>
<span class="c">#</span>
<span class="c"># Returns: None</span>
<span class="c">########################</span>
<a name="catch_pipeline_btn-"></a><span class="k">sub </span><span class="m">catch_pipeline_btn</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,quiet'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@plates</span>   = <span class="i">param</span><span class="s">(</span><span class="q">'Mark'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline</span> = <span class="i">get_Table_Param</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="q">'FK_Pipeline__ID'</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'Set Pipeline for Plate'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$container</span> = <span class="w">alDente::Container</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$updated</span> = <span class="i">$container</span><span class="i">-&gt;set_pipeline</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> \<span class="i">@plates</span><span class="cm">,</span> -<span class="w">pipeline</span> <span class="cm">=&gt;</span> <span class="i">$pipeline</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Updated pipeline to $pipeline for $updated records&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Set the pipeline for a given set of plates</span>
<span class="c">#</span>
<span class="c"># Returns: Number of plates updated</span>
<span class="c">##################</span>
<a name="set_pipeline-"></a><span class="k">sub </span><span class="m">set_pipeline</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">$self</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id,pipeline'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_ID</span><span class="s">(</span> <span class="q">'FK_Pipeline__ID'</span><span class="cm">,</span> <span class="i">$args</span>{-<span class="w">pipeline</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">&quot;String&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ok</span>       = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'FK_Pipeline__ID'</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="i">$pipeline</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($plate_id)&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$ok</span> . <span class="q">&quot; plate ($plate_id)&quot;</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Save the plate set for given set of plates</span>
<span class="c">#</span>
<span class="c"># Usage: alDente::Container::save_plate_set_btn(-dbc=&gt;$dbc,-admin_only=&gt;1, -plate_set_label=&gt;&quot;Save Plate Set&quot;);</span>
<span class="c"># Return: Plate Set Button</span>
<span class="c">########################</span>
<a name="save_plate_set_btn-"></a><span class="k">sub </span><span class="m">save_plate_set_btn</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">%args</span>       = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc, plate_set_label,admin_only'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$admin_only</span> = <span class="i">$args</span>{-<span class="w">admin_only</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>        = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$admin_only</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$access</span> = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'Access'</span><span class="s">)</span>-&gt;{<span class="i">$Current_Department</span>}<span class="sc">;</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/Admin/</span><span class="cm">,</span> <span class="i">@$access</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$plate_set_label</span> = <span class="i">$args</span>{-<span class="w">plate_set_label</span>} || <span class="q">'Save Plate Set'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plate_set_button</span><span class="sc">;</span>

    <span class="i">$plate_set_button</span> = <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Save Plate Set'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$plate_set_label</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Action'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$plate_set_button</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################################</span>
<span class="c">#</span>
<span class="c">#  Method to display a list of plates that are going to be failed, and prompting the user with a</span>
<span class="c">#   Fail reason</span>
<span class="c">#</span>
<span class="c">####################</span>
<a name="confirm_fail-"></a><span class="k">sub </span><span class="m">confirm_fail</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">%args</span>      = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,marked,notes'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'dbc,marked,notes'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>       = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@marked</span>    = <span class="i">@</span>{ <span class="i">$args</span>{-<span class="w">marked</span>} }<span class="sc">;</span>                                                                   <span class="c">### (array) List of plates selected to be failed</span>
    <span class="k">my</span> <span class="i">$notes</span>     = <span class="i">$args</span>{-<span class="w">notes</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$reason_id</span> = <span class="i">$args</span>{-<span class="w">reason_id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$container</span> = <span class="i">new</span> <span class="i">alDente::Container</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fail_list</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="s">(</span><span class="i">@marked</span><span class="s">)</span> <span class="s">{</span>                                                                                    <span class="c">## Retrieve the offsprings of each of the selected plates</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@fail_list</span><span class="cm">,</span> <span class="k">split</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">&amp;get_Children</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$_</span><span class="cm">,</span> -<span class="w">format</span> <span class="cm">=&gt;</span> <span class="q">'list'</span><span class="cm">,</span> -<span class="w">include_self</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## Make the list a unique list</span>
    <span class="i">@fail_list</span> = <span class="i">@</span>{ <span class="i">RGTools::RGIO::unique_items</span><span class="s">(</span> \<span class="i">@fail_list</span> <span class="s">)</span> }<span class="sc">;</span>

    <span class="c">#    my $marked_list= join (',', @marked);</span>
    <span class="k">my</span> <span class="i">$plates</span> = <span class="k">join</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@fail_list</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$Sess</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Please confirm the failing of these plates&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">alDente::Container_Views::fail_toolbox</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">tree</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########</span>
<a name="move-"></a><span class="k">sub </span><span class="m">move</span> <span class="s">{</span>
<span class="c">########</span>
    <span class="c">#</span>
    <span class="c"># Move location</span>
    <span class="c">#</span>

<span class="s">}</span>

<span class="c"># Create an On hold button</span>
<span class="c">#</span>
<span class="c"># Returns: HTML Button</span>
<span class="c">######################</span>
<a name="onhold_plate_btn-"></a><span class="k">sub </span><span class="m">onhold_plate_btn</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$onhold_btn</span> = <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Set Onhold Plate'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'Set Plate Status to On Hold'</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Std'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_comment_field</span> = <span class="q">&quot; Add to plate comments (Optional) &quot;</span> . <span class="i">textfield</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Plate_Comments'</span><span class="cm">,</span> -<span class="w">size</span> <span class="cm">=&gt;</span> <span class="n">20</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$onhold_btn</span> . <span class="i">$plate_comment_field</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Catches the on hold plate btn, sets the status of plates to On Hold</span>
<span class="c"># Added the ability to set the status of plates to Failed when param('Set Failed Plate') is set</span>
<span class="c"># Returns: none</span>
<span class="c">############################</span>
<a name="catch_onhold_plate_btn-"></a><span class="k">sub </span><span class="m">catch_onhold_plate_btn</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">%args</span>   = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>    = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@plates</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Mark'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">@plates</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@plates</span> = <span class="i">param</span><span class="s">(</span><span class="q">'FK_Plate__ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$num_updated</span>    = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$status</span>         = <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_comments</span> = <span class="q">''</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'Set Onhold Plate'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$status</span>         = <span class="q">'On Hold'</span><span class="sc">;</span>
        <span class="i">$plate_comments</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Plate_Comments'</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#    if (param('Set Failed Plate')) {</span>
    <span class="c">#        $status = 'Failed';</span>
    <span class="c">#        $plate_comments = param('Failed_Plate_Comments');</span>
    <span class="c">#    }</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$status</span> <span class="k">ne</span> <span class="q">''</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$num_updated</span> = <span class="i">set_plate_status</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> \<span class="i">@plates</span><span class="cm">,</span> -<span class="w">status</span> <span class="cm">=&gt;</span> <span class="i">$status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$plate_comments</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@plates</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$container_obj</span> = <span class="w">alDente::Container</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$container_obj</span><span class="i">-&gt;add_Note</span><span class="s">(</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">notes</span> <span class="cm">=&gt;</span> <span class="i">$plate_comments</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$Sess</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;$num_updated plates were set to '$status'&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################################</span>
<span class="c"># Set the plate status</span>
<span class="c">#</span>
<span class="c"># Returns: number of plates updated</span>
<span class="c">######################</span>
<a name="set_plate_status-"></a><span class="k">sub </span><span class="m">set_plate_status</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id,status'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$status</span>   = <span class="i">$args</span>{-<span class="w">status</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plate_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@available_statuses</span> = <span class="i">get_plate_status_list</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$num_plates_updated</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$status$/</span><span class="cm">,</span> <span class="i">@available_statuses</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$num_plates_updated</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'Plate_Status'</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="i">$status</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($plate_ids)&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Status was not in available list of plate statuses&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$num_plates_updated</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Create an On hold button</span>
<span class="c">#</span>
<span class="c"># Returns: HTML Button</span>
<span class="c">######################</span>
<a name="plate_archive_btn-"></a><span class="k">sub </span><span class="m">plate_archive_btn</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$archive_btn</span> = <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Set Plate Archive'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'Set Plate Status to Archived'</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Std'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$archive_btn</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Catches the on hold plate btn, sets the status of plates to On Hold</span>
<span class="c">#</span>
<span class="c"># Returns: none</span>
<span class="c">############################</span>
<a name="catch_plate_archive_btn-"></a><span class="k">sub </span><span class="m">catch_plate_archive_btn</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">%args</span>   = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>    = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@plates</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Mark'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">@plates</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@plates</span> = <span class="i">param</span><span class="s">(</span><span class="q">'FK_Plate__ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">@library_plate_number</span> = <span class="i">param</span><span class="s">(</span><span class="q">'library_plate_number'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">@library_plate_number</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$condition</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="k">map</span> <span class="s">{</span><span class="q">&quot;'$_'&quot;</span><span class="s">}</span> <span class="i">@library_plate_number</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">@plates</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_Status = 'Active' AND CONCAT(FK_Library__Name,'-',Plate_Number) IN ($condition)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$plate_comments</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Plate_Comments'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$num_updated</span>    = <span class="n">0</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'Set Plate Archive'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$num_updated</span> = <span class="i">set_plate_archive_status</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> \<span class="i">@plates</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$plate_comments</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@plates</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$container_obj</span> = <span class="w">alDente::Container</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$container_obj</span><span class="i">-&gt;add_Note</span><span class="s">(</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">notes</span> <span class="cm">=&gt;</span> <span class="i">$plate_comments</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$Sess</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;$num_updated plates were set to 'Archived'&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Set the plates to archived</span>
<span class="c">#</span>
<span class="c"># Returns: number of plates archived</span>
<span class="c">##############################</span>
<a name="set_plate_archive_status-"></a><span class="k">sub </span><span class="m">set_plate_archive_status</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">$self</span>     = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plate_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'String'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">### Find the current locations of the plates &lt;CONSTRUCTION&gt;</span>
    <span class="c">#my @current_locations = $dbc-&gt;Table_find( 'Plate', 'FK_Rack__ID', &quot;WHERE Plate_ID IN ($plate_ids)&quot; );</span>
    <span class="c">### Check if the plate is in temporary rack or not...</span>
    <span class="c">#my @temporary_racks = $dbc-&gt;Table_find( 'Rack,Equipment', &quot;Rack_ID&quot;, &quot;WHERE FK_Equipment__ID = Equipment_ID and Equipment_Name = 'TBD'&quot; );</span>
    <span class="c">#my ( $intersec, $a_only, $b_only ) = &amp;RGmath::intersection( \@current_locations, \@temporary_racks );</span>
    <span class="c">#if ( int(@$intersec) &gt; 0 ) {</span>
    <span class="c">#$dbc-&gt;error(&quot;One or more plates is located in a temporary storage location&quot;);</span>
    <span class="c">#return 0;</span>
    <span class="c">#}</span>

    <span class="c">#get a list of tmp location</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$temporary_racks</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Rack,Equipment'</span><span class="cm">,</span> <span class="q">&quot;Group_Concat(Rack_ID)&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Equipment__ID = Equipment_ID and Equipment_Name = 'TBD'&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#see if any plate in tmp location</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$tmp_plates</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Group_Concat(Plate_ID)'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($plate_ids) AND FK_Rack__ID IN ($temporary_racks)&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$tmp_plates</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$tmp_plates_link</span> = <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="i">$tmp_plates</span><span class="cm">,</span> <span class="q">&quot;&amp;Info=1&amp;Table=Plate&amp;Field=Plate_ID&amp;Like=$tmp_plates&quot;</span><span class="cm">,</span> -<span class="w">window</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$dbc</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;One or more plates ($tmp_plates_link) is located in a temporary storage location&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@plates_in_TBD</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate,Rack,Equipment'</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Rack_ID = FK_Rack__ID AND FK_Equipment__ID = Equipment_ID AND Equipment_Name = 'TBD' AND Plate_ID IN ($plate_ids)&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates_in_TBD</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="k">map</span> <span class="s">{</span> <span class="i">$self</span><span class="i">-&gt;prefix</span> . <span class="i">$_</span> <span class="s">}</span> <span class="i">@plates_in_TBD</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$plates_in_TBD</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Warning: The following plate(s) is located in a temporary storage location but still archived: $plates_in_TBD&quot;</span><span class="s">)</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$archived</span> = <span class="i">set_plate_status</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span><span class="cm">,</span> -<span class="w">status</span> <span class="cm">=&gt;</span> <span class="q">'Archived'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$archived</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># Get a list of available plate statuses</span>
<span class="c">#</span>
<span class="c"># Returns: Array of plate statuses</span>
<span class="c">###########################</span>
<a name="get_plate_status_list-"></a><span class="k">sub </span><span class="m">get_plate_status_list</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">%args</span>         = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>          = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@plate_status</span> = <span class="i">$dbc</span><span class="i">-&gt;get_enum_list</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="q">'Plate_Status'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">@plate_status</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################################################################</span>
<span class="c"># The methods are essentially externally available routines</span>
<span class="c"># Generally they may act on more than one container at a time</span>
<span class="c">#################################################################</span>

<span class="c">##########</span>
<span class="s">{</span>
    <span class="k">no</span> <span class="w">warnings</span><span class="sc">;</span>

<a name="home-"></a>    <span class="k">sub </span><span class="m">home</span> <span class="s">{</span>
        <span class="c">##########</span>
        <span class="c">#</span>
        <span class="c"># home page for Containers...</span>
        <span class="c">#</span>
        <span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;home page for Containers under construction..&quot;</span><span class="sc">;</span>

        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">#################</span>
<a name="throw_away-"></a><span class="k">sub </span><span class="m">throw_away</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="c">#</span>
    <span class="c"># Throw away containers listed</span>
    <span class="c"># If a plate is being thrown out, there will be a Thrown Out prep recorded for it and it will be moved to garbage rack</span>
    <span class="c">#</span>

    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,ids,notes'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span> = <span class="i">$args</span>{-<span class="w">ids</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$notes</span>     = <span class="i">$args</span>{-<span class="w">notes</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$confirmed</span> = <span class="i">$args</span>{-<span class="w">confirmed</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$confirmed</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">### Garbage Location</span>
        <span class="s">(</span> <span class="k">my</span> <span class="i">$garbage</span> <span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Rack'</span><span class="cm">,</span> <span class="q">'Rack_ID'</span><span class="cm">,</span> <span class="q">&quot;where Rack_name = 'Garbage'&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="c">### Move to garbage, set status to Thrown Out</span>
        <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'FK_Rack__ID'</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="i">$garbage</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID in ($ids)&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'Plate_Status'</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="q">'Thrown Out'</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID in ($ids) AND Plate_Status NOT IN ('Failed','Exported')&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#      Message(&quot;$ok container(s) Thrown away &quot;);</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$myPrep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span> <span class="s">)</span><span class="sc">;</span>

            <span class="c"># flag plates to be thrown away as 'current plates' for now</span>
            <span class="k">my</span> <span class="i">%input</span><span class="sc">;</span>
            <span class="i">$input</span>{<span class="q">'Current Plates'</span>} = <span class="i">$ids</span><span class="sc">;</span>
            <span class="i">$input</span>{<span class="q">'Prep Step Name'</span>} = <span class="q">'Throw Away'</span><span class="sc">;</span>
            <span class="i">$myPrep</span><span class="i">-&gt;Record</span><span class="s">(</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="q">'Standard'</span><span class="cm">,</span> -<span class="w">input</span> <span class="cm">=&gt;</span> \<span class="i">%input</span><span class="cm">,</span> -<span class="w">change_location</span> <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span> -<span class="w">local_focus</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="i">$ok</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">alDente::Container_Views::confirm_event</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">event</span> <span class="cm">=&gt;</span> <span class="q">'Throw Out'</span><span class="cm">,</span> -<span class="w">notes</span> <span class="cm">=&gt;</span> <span class="i">$notes</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###################</span>
<a name="export_Plate-"></a><span class="k">sub </span><span class="m">export_Plate</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="c">#</span>
    <span class="c"># Export containers listed</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,ids'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'ids,dbc'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span> = <span class="i">$args</span>{-<span class="w">ids</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$notes</span>     = <span class="i">$args</span>{-<span class="w">notes</span>}<span class="sc">;</span>       <span class="c">## mandatory to ensure we know where it went...</span>
    <span class="k">my</span> <span class="i">$confirmed</span> = <span class="i">$args</span>{-<span class="w">confirmed</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$comments</span>  = <span class="i">$args</span>{-<span class="w">comments</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$notes</span> =~ <span class="q">/untracked/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$notes</span> = <span class="q">''</span> <span class="s">}</span>    <span class="c">## place holder for dropdown menu - defaults to std export rack..</span>

    <span class="k">my</span> <span class="i">$default_location</span> = <span class="q">'untracked export rack'</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="i">$notes</span> || <span class="i">$comments</span> <span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;comments (destination details) required&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span> <span class="n">0</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">$ids</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;List of plate ids required&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span> <span class="n">0</span><span class="sc">;</span> <span class="s">}</span>

    <span class="i">$ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$confirmed</span><span class="s">)</span> <span class="s">{</span>

        <span class="c">#   (my $exported) = $dbc-&gt;Table_find('Rack','Rack_ID',&quot;where Rack_Name like 'Exported'&quot;);</span>
        <span class="k">my</span> <span class="i">$exported</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$notes</span> &amp;&amp; !<span class="s">(</span> <span class="i">$notes</span> =~ <span class="q">/not tracked/i</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span><span class="i">$exported</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Location,Equipment,Rack'</span><span class="cm">,</span> <span class="q">'Rack_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Location__ID = Location_ID AND FK_Equipment__ID = Equipment_ID AND Location_Name='$notes' &quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="s">(</span><span class="i">$exported</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Rack'</span><span class="cm">,</span> <span class="q">'Rack_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Rack_Name = 'Exported'&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FK_Rack__ID'</span><span class="cm">,</span> <span class="q">'Plate_Status'</span> <span class="s">]</span><span class="cm">,</span> <span class="s">[</span> <span class="i">$exported</span><span class="cm">,</span> <span class="q">'Exported'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID in ($ids)&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Updated $ok records&quot;</span><span class="s">)</span><span class="sc">;</span>

        <span class="i">$notes</span> .= <span class="i">$default_location</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Prep</span><span class="i">-&gt;Record</span><span class="s">(</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="q">'Standard'</span><span class="cm">,</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="q">'Export'</span><span class="cm">,</span> -<span class="w">notes</span> <span class="cm">=&gt;</span> <span class="q">'To: '</span> . <span class="i">$notes</span> . <span class="q">&quot; - Comments: $comments&quot;</span><span class="cm">,</span> -<span class="w">change_location</span> <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span> -<span class="w">local_focus</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve_display</span><span class="s">(</span> <span class="q">'Plate,Rack'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">'FK_Library__Name as Library'</span><span class="cm">,</span> <span class="q">'Plate_Number as Number'</span><span class="cm">,</span> <span class="q">'Rack_Alias as Current_Location'</span><span class="cm">,</span> <span class="q">'Plate_Status as Current_Status'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Rack__ID=Rack_ID AND Plate_ID in ($ids)&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$stats</span> = <span class="i">alDente::Tray::group_ids</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="i">$ids</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Warning: Are you sure?&quot;</span><span class="s">)</span><span class="sc">;</span>

        <span class="k">print</span> <span class="i">start_custom_form</span><span class="s">(</span> <span class="q">'ExportPlates'</span><span class="cm">,</span> -<span class="w">parameters</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="i">&amp;Set_Parameters</span><span class="s">(</span><span class="s">)</span> <span class="s">}</span> <span class="s">)</span>
            . <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'rm'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'Export Plates'</span> <span class="s">)</span>
            . <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'cgi_application'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'alDente::Container_App'</span> <span class="s">)</span>
            . <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&quot;Export Plates&quot;</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">&quot;Confirm Export of these  $stats-&gt;{physical_plates} Container(s)&quot;</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Action'</span> <span class="s">)</span>
            . <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Move_Plate_IDs'</span><span class="cm">,</span>  -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$ids</span> <span class="s">)</span>
            . <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Export_Comments'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$comments</span> <span class="s">)</span>
            . <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Destination'</span><span class="cm">,</span>     -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$notes</span> <span class="s">)</span>
            . <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Confirmed'</span><span class="cm">,</span>       -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span>
            . <span class="q">&quot;&lt;/form&gt;&quot;</span><span class="sc">;</span>

        <span class="k">print</span> <span class="i">create_tree</span><span class="s">(</span> -<span class="w">tree</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="q">'Shipping Manifest'</span> <span class="cm">=&gt;</span> <span class="i">alDente::Rack_Views::shipping_manifest</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id_list</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">key</span> <span class="cm">=&gt;</span> <span class="q">'Original_Source_Name as Subject'</span><span class="cm">,</span> -<span class="w">group</span> <span class="cm">=&gt;</span> <span class="q">'Sample_Type.Sample_Type'</span> <span class="s">)</span> <span class="s">}</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$notes</span> ||= <span class="i">$default_location</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Exporting to '$notes'.  Note: $notes $comments&quot;</span><span class="s">)</span><span class="sc">;</span>

        <span class="i">&amp;main::leave</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#######################</span>
<a name="activate_Plate-"></a><span class="k">sub </span><span class="m">activate_Plate</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="c">#</span>
    <span class="c"># Export containers listed</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,ids'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'ids,dbc'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span>     = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span>     = <span class="i">$args</span>{-<span class="w">ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rack_id</span> = <span class="i">$args</span>{-<span class="w">rack_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$confirm</span> = <span class="i">$args</span>{-<span class="w">confirm</span>}<span class="sc">;</span>

    <span class="i">$ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$rack_id</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$rack_id</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Rack'</span><span class="cm">,</span> <span class="q">'Rack_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Rack_Alias = 'In Use'&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$confirm</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Plate_Status'</span><span class="cm">,</span> <span class="q">'FK_Rack__ID'</span> <span class="s">]</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Active'</span><span class="cm">,</span> <span class="n">1</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID in ($ids)&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Re-activated $ok plate(s): $ids.&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$rack_id</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">use</span> <span class="w">alDente::Rack</span><span class="sc">;</span>
            <span class="i">&amp;alDente::Rack::move_Items</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">rack</span> <span class="cm">=&gt;</span> <span class="i">$rack_id</span><span class="cm">,</span> -<span class="w">confirmed</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve_display</span><span class="s">(</span> <span class="q">'Plate,Rack'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">'FK_Library__Name as Library'</span><span class="cm">,</span> <span class="q">'Plate_Number as Number'</span><span class="cm">,</span> <span class="q">'Rack_Alias as Current_Location'</span><span class="cm">,</span> <span class="q">'Plate_Status as Current_Status'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Rack__ID=Rack_ID AND Plate_ID in ($ids)&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">print</span> <span class="i">start_custom_form</span><span class="s">(</span> -<span class="w">parameters</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="i">&amp;Set_Parameters</span><span class="s">(</span><span class="s">)</span> <span class="s">}</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Plate_ID'</span><span class="cm">,</span>        -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$ids</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'rm'</span><span class="cm">,</span>              -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'Re-Activate'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'cgi_application'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'alDente::Container_App'</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Rack_ID'</span><span class="cm">,</span>         -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="i">$rack_id</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Confirm Re-Activation'</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">&quot;Action&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">print</span> <span class="i">end_form</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">&amp;main::leave</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">##################</span>
<a name="thaw_Plate-"></a><span class="k">sub </span><span class="m">thaw_Plate</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'ids'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'ids'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ids</span> = <span class="i">$args</span>{-<span class="w">ids</span>}<span class="sc">;</span>
    <span class="i">Message</span><span class="s">(</span> <span class="q">&quot;Thawing Plate(s): &quot;</span> . <span class="i">$ids</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$Prep</span><span class="i">-&gt;Record</span><span class="s">(</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$ids</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="q">'Standard'</span><span class="cm">,</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="q">'Thaw'</span><span class="cm">,</span> -<span class="w">local_focus</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$object</span> = <span class="w">alDente::Container</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$ids</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$object</span><span class="i">-&gt;home_page</span><span class="s">(</span> -<span class="w">brief</span> <span class="cm">=&gt;</span> <span class="i">$scanner_mode</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">################################################################################</span>
<span class="c">#  Functions relating to Library</span>
<span class="c">################################################################################</span>

<span class="c">################################################################################</span>
<span class="c"># General Plate Functions  (barcode, info)</span>
<span class="c">################################################################################</span>

<span class="c">##############################</span>
<a name="Check_Library_Plates-"></a><span class="k">sub </span><span class="m">Check_Library_Plates</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="c">#</span>
    <span class="c"># OLD</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$library</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate</span>   = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>     = <span class="i">$Connection</span><span class="sc">;</span>

    <span class="k">print</span> <span class="q">&quot;Old ?&quot;</span> . <span class="i">Call_Stack</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$library</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%Status</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">%Plates</span>
            = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'count(*) as Count'</span><span class="cm">,</span> <span class="q">'Plate_Number as Number'</span><span class="cm">,</span> <span class="q">'FK_Plate_Format__ID as Format'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;where FK_Library__Name like '$library' GROUP BY Plate_Number,FK_Plate_Format__ID Order by Plate_Number,Plate_Created ASC&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">%Counts</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@formats</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@numbers</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Plates</span>{<span class="w">Count</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$count</span>  = <span class="i">$Plates</span>{<span class="w">Count</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$number</span> = <span class="i">$Plates</span>{<span class="w">Number</span>}[<span class="i">$index</span>] || <span class="n">0</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$format</span> = <span class="i">$Plates</span>{<span class="w">Format</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$format$/</span><span class="cm">,</span> <span class="i">@formats</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@formats</span><span class="cm">,</span> <span class="i">$format</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
            <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="q">/^$number$/</span><span class="cm">,</span> <span class="i">@numbers</span> <span class="s">)</span> <span class="s">{</span> <span class="k">push</span><span class="s">(</span> <span class="i">@numbers</span><span class="cm">,</span> <span class="i">$number</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
            <span class="i">$Counts</span>{<span class="i">$format</span>}{<span class="i">$number</span>} = <span class="i">$count</span><span class="sc">;</span>
            <span class="i">$index</span>++<span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">print</span> <span class="i">&amp;vspace</span><span class="s">(</span><span class="n">10</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$Show</span> = <span class="w">HTML_Table</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$Show</span><span class="i">-&gt;Set_Title</span><span class="s">(</span> <span class="q">&quot;$library Plates&gt;&quot;</span><span class="cm">,</span> <span class="w">fsize</span> <span class="cm">=&gt;</span> <span class="q">'-1'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">@headers</span> = <span class="s">(</span><span class="q">&quot;Plate Number&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$format</span> <span class="s">(</span><span class="i">@formats</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$format_info</span><span class="s">)</span> = <span class="i">&amp;get_FK_info</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> <span class="i">$format</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$format_info</span> =~ <span class="q">s /well\s/well&lt;BR&gt;/</span><span class="sc">;</span>
            <span class="k">push</span><span class="s">(</span> <span class="i">@headers</span><span class="cm">,</span> <span class="i">$format_info</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$Show</span><span class="i">-&gt;Set_Headers</span><span class="s">(</span> \<span class="i">@headers</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$number</span> <span class="s">(</span><span class="i">@numbers</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">@line</span> = <span class="s">(</span><span class="i">$number</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$format</span> <span class="s">(</span><span class="i">@formats</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$count</span> = <span class="i">$Counts</span>{<span class="i">$format</span>}{<span class="i">$number</span>} || <span class="n">0</span><span class="sc">;</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@line</span><span class="cm">,</span> <span class="i">$count</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$Show</span><span class="i">-&gt;Set_Row</span><span class="s">(</span> \<span class="i">@line</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$Show</span><span class="i">-&gt;Printout</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Need to choose Library&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############</span>
<a name="store-"></a><span class="k">sub </span><span class="m">store</span> <span class="s">{</span>
<span class="c">############</span>
    <span class="c">#OLD..</span>
    <span class="c"># Save plate Storage location to database</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'plate_id,rack'</span><span class="cm">,</span> -<span class="w">mandatory</span> <span class="cm">=&gt;</span> <span class="q">'plate_id'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plates</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>                                                                <span class="c"># list of plates</span>
    <span class="k">my</span> <span class="i">$rack</span>   = <span class="i">$args</span>{-<span class="w">rack</span>}<span class="sc">;</span>                                                                    <span class="c"># rack id or barcode;</span>
    <span class="k">my</span> <span class="i">$event</span>  = <span class="i">$args</span>{-<span class="w">event</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>    = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>  = <span class="i">$args</span>{-<span class="w">quiet</span>}<span class="sc">;</span>

    <span class="i">$rack</span> ||= <span class="i">param</span><span class="s">(</span><span class="q">'Rack Choice'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$num_plates</span> = <span class="k">int</span><span class="s">(</span> <span class="k">my</span> <span class="i">@list</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$plates</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$current_plate_set</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Set'</span><span class="cm">,</span> <span class="q">'Plate_Set_Number'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate__ID in ($plates) group by Plate_Set_Number having count(*) = $num_plates&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$current_plate_set</span> =~ <span class="q">/,/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Plate Set possibilities not unique Possible Plate Sets:($current_plate_set)&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$current_plate_set</span> = <span class="q">'NULL'</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$current_plate_set</span> ||= <span class="q">'NULL'</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$rack_id</span><span class="sc">;</span>
    <span class="k">if</span>    <span class="s">(</span> <span class="i">$rack</span> =~ <span class="q">/Rac(\d+)/i</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$rack_id</span> = <span class="i">$1</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$rack</span> =~ <span class="q">/(\d+)/</span> <span class="s">)</span>     <span class="s">{</span> <span class="i">$rack_id</span> = <span class="i">$rack</span><span class="sc">;</span> <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Error Storing on Rack $rack&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">####### if this is during Protocol steps ...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'Step Name'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$current_date</span> = <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;Storing Plates: $plates&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Protocol'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$Lprotocol_id</span> = <span class="i">get_FK_ID</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">'FK_Lab_Protocol__ID'</span><span class="cm">,</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$thisplate</span> <span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$plates</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span>
                <span class="q">'Prep'</span><span class="cm">,</span>
                <span class="s">[</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'FK_Plate_Set__Number'</span><span class="cm">,</span> <span class="q">'FK_Employee__ID'</span><span class="cm">,</span> <span class="q">'Prep_DateTime'</span><span class="cm">,</span> <span class="q">'Prep_Name'</span><span class="cm">,</span>       <span class="q">'FK_Lab_Protocol__ID'</span> <span class="s">]</span><span class="cm">,</span>
                <span class="s">[</span> <span class="i">$thisplate</span><span class="cm">,</span>     <span class="i">$current_plate_set</span><span class="cm">,</span>     <span class="i">$user_id</span><span class="cm">,</span>          <span class="i">$current_date</span><span class="cm">,</span>   <span class="q">'Store Plate Set'</span><span class="cm">,</span> <span class="i">$Lprotocol_id</span> <span class="s">]</span><span class="cm">,</span>
                -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span>
            <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span> <span class="i">Test_Message</span><span class="s">(</span> <span class="q">&quot;Stored Plate $thisplate&quot;</span><span class="cm">,</span> <span class="i">$testing</span> <span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
            <span class="k">else</span>     <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Error saving Storage Step&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@fields</span> = <span class="s">(</span><span class="q">'FK_Rack__ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values</span> = <span class="s">(</span><span class="i">$rack_id</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">#### Change status to Exported if moved to 'Exported' rack... ###</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$rack_name</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Rack'</span><span class="cm">,</span> <span class="q">'Rack_Name'</span><span class="cm">,</span> <span class="q">&quot;WHERE Rack_ID = $rack_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$rack_name</span> =~ <span class="q">/Export/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@fields</span><span class="cm">,</span> <span class="q">'Plate_Status'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@values</span><span class="cm">,</span> <span class="q">'Exported'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> \<span class="i">@values</span><span class="cm">,</span> <span class="q">&quot;where Plate_ID in ($plates)&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$ok</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$rack_name</span> !~ <span class="q">/In Use/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Stored $ok plates ($plates) on Rack $rack_id ($rack_name)&quot;</span><span class="s">)</span> <span class="s">}</span>
        <span class="i">clear_plate_set</span><span class="s">(</span><span class="i">$dbc</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$Sess</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;plates $plates not moved&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$event</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$user_id</span> = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'user_id'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span><span class="i">-&gt;Record</span><span class="s">(</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="q">'Standard'</span><span class="cm">,</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="i">$event</span><span class="cm">,</span> -<span class="w">change_location</span> <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span> -<span class="w">local_focus</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$rack_id</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################################</span>
<span class="c"># generates the plate name from a plate_id</span>
<span class="c"># return: the plate name</span>
<span class="c">##################################</span>
<a name="get_plate_name-"></a><span class="k">sub </span><span class="m">get_plate_name</span> <span class="s">{</span>
    <span class="c">##################################</span>
    <span class="c"># First handle method VS function call</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="i">UNIVERSAL::isa</span><span class="s">(</span> <span class="i">$_</span>[<span class="n">0</span>]<span class="cm">,</span> <span class="q">'alDente::Container'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,id'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$id</span>   = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$obj</span>  = <span class="w">alDente::Container</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="i">$obj</span><span class="i">-&gt;get_plate_name</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,id'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$id</span> = <span class="i">$args</span>{-<span class="w">id</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$name_str</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> <span class="q">&quot;FK_Library__Name,Plate_Number,Parent_Quadrant,Plate_Parent_Well&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID=$id&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$libname</span><span class="cm">,</span> <span class="i">$platenum</span><span class="cm">,</span> <span class="i">$quad</span><span class="cm">,</span> <span class="i">$well</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$name_str</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$name</span> = <span class="q">&quot;$libname-$platenum&quot;</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$quad</span> &amp;&amp; <span class="s">(</span> <span class="i">$quad</span> <span class="k">ne</span> <span class="q">''</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$name</span> .= <span class="i">$quad</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$well</span> &amp;&amp; <span class="s">(</span> <span class="i">$well</span> <span class="k">ne</span> <span class="q">''</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$name</span> .= <span class="q">&quot;_${well}&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$name</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################################</span>
<a name="clear_plate_set-"></a><span class="k">sub </span><span class="m">clear_plate_set</span> <span class="s">{</span>
<span class="c">##################################</span>
    <span class="c">#</span>
    <span class="c"># Clears Defined Plate Set</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$current_plates</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="i">$plate_set</span>      = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="i">$plate_id</span>       = <span class="q">&quot;&quot;</span><span class="sc">;</span>

    <span class="i">alDente::Container::reset_current_plates</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">''</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$dbc</span>-&gt;{<span class="w">plate_set</span>} = <span class="q">''</span><span class="sc">;</span>
    <span class="i">$dbc</span>-&gt;{<span class="w">plate_id</span>}  = <span class="q">''</span><span class="sc">;</span>
    <span class="i">$dbc</span>-&gt;{<span class="w">step_name</span>} = <span class="q">''</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################################</span>
<span class="c"># A function to retrieve the birth protocol of a plate</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># Eg. my %info = get_birth_protocol($dbc,$plate_id);</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Options: -dbc (database handle)</span>
<span class="c">#          -plate_id</span>
<span class="c">#</span>
<span class="c"># Return: Returns a hash ref info about birth protocol of this plate</span>
<span class="c">#</span>
<span class="c">############################</span>
<a name="get_birth_protocol-"></a><span class="k">sub </span><span class="m">get_birth_protocol</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$interval</span> = <span class="i">$args</span>{-<span class="w">interval</span>} || <span class="n">2000</span><span class="sc">;</span>                                                        <span class="c">## optional interval in seconds (plates created within N seconds of prep)</span>

    <span class="k">my</span> <span class="i">%Result</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%Data</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Plate,Plate_Format'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">'FKParent_Plate__ID'</span><span class="cm">,</span> <span class="q">'Plate_Created'</span><span class="cm">,</span> <span class="q">'Plate_Size'</span><span class="cm">,</span> <span class="q">'Plate_Format_Type'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate_Format__ID=Plate_Format_ID AND Plate.Plate_ID IN ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span> <span class="i">$Data</span>{<span class="w">Plate_ID</span>}[<span class="n">0</span>] <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;No Plate ($plate_id) found in database (?)&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Plate,Plate_Format'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">'FKParent_Plate__ID'</span><span class="cm">,</span> <span class="q">'Plate_Created'</span><span class="cm">,</span> <span class="q">'Plate_Size'</span><span class="cm">,</span> <span class="q">'Plate_Format_Type'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate_Format__ID=Plate_Format_ID AND Plate.Plate_ID IN ($plate_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>                                                                                               <span class="c">## return if not found...</span>

    <span class="i">$Result</span>{<span class="w">parent</span>}  = <span class="i">$Data</span>{<span class="w">FKParent_Plate__ID</span>}[<span class="n">0</span>]<span class="sc">;</span>
    <span class="i">$Result</span>{<span class="w">created</span>} = <span class="i">$Data</span>{<span class="w">Plate_Created</span>}[<span class="n">0</span>]<span class="sc">;</span>
    <span class="i">$Result</span>{<span class="w">size</span>}    = <span class="i">$Data</span>{<span class="w">Plate_Size</span>}[<span class="n">0</span>]<span class="sc">;</span>
    <span class="i">$Result</span>{<span class="w">format</span>}  = <span class="i">$Data</span>{<span class="w">Plate_Format_Type</span>}[<span class="n">0</span>]<span class="sc">;</span>

    <span class="k">unless</span> <span class="s">(</span> <span class="i">$Result</span>{<span class="w">parent</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="c">### If a plate has been pooled</span>
        <span class="k">my</span> <span class="i">@poolings</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Pool,PoolSample'</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_Pool.FK_Pool__ID=PoolSample.FK_Pool__ID AND FKTarget_Plate__ID in ($plate_id) ORDER BY FK_Plate__ID&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">@poolings</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$Result</span>{<span class="w">parent</span>} = <span class="k">join</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@poolings</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="c">## original plate - (not created within protocol)</span>
            <span class="i">$Result</span>{<span class="w">protocol_name</span>} = <span class="q">&quot;Original Plate&quot;</span><span class="sc">;</span>
            <span class="k">return</span> \<span class="i">%Result</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">## check if plate is created within a protocol ##</span>
    <span class="c"># Figure out if the prep date time of the transfer step is whitin 3 seconds of the creation of the plate</span>

    <span class="k">my</span> <span class="i">$sql_date</span> = <span class="i">convert_date</span><span class="s">(</span> <span class="i">$Result</span>{<span class="w">created</span>}<span class="cm">,</span> <span class="q">'SQL'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$prep_condition</span> = <span class="q">&quot;Plate_Prep.FK_Plate__ID IN($Result{parent}) AND Prep.Prep_DateTime BETWEEN DATE_SUB('$sql_date',INTERVAL $interval SECOND) AND DATE_ADD('$sql_date',INTERVAL $interval SECOND)&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Found</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
        <span class="q">'Prep,Plate_Prep,Lab_Protocol'</span><span class="cm">,</span>
        <span class="s">[</span> <span class="q">'Prep_Name'</span><span class="cm">,</span> <span class="q">'Prep.FK_Employee__ID'</span><span class="cm">,</span> <span class="q">'Lab_Protocol_Name'</span><span class="cm">,</span> <span class="q">'Lab_Protocol_ID'</span> <span class="s">]</span><span class="cm">,</span>
        <span class="q">&quot;WHERE Lab_Protocol.Lab_Protocol_ID=Prep.FK_Lab_Protocol__ID AND Prep.Prep_ID=Plate_Prep.FK_Prep__ID AND $prep_condition&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Found</span>{<span class="w">Lab_Protocol_ID</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$step_name</span> = <span class="i">$Found</span>{<span class="w">Prep_Name</span>}[<span class="i">$index</span>]<span class="sc">;</span>

        <span class="c">#    unless ($step_name) { next }</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">&amp;alDente::Protocol::new_plate</span><span class="s">(</span><span class="i">$step_name</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## IF this is a transfer step...</span>
            <span class="i">$Result</span>{<span class="w">protocol_name</span>} = <span class="i">$Found</span>{<span class="q">'Lab_Protocol_Name'</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="i">$Result</span>{<span class="w">employee</span>}      = <span class="i">$Found</span>{<span class="q">'FK_Employee__ID'</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">last</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$index</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">### If we could not find the birth protocol, look to see if this plate has been preprinted, and if it has, what protocol was it at?</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$Result</span>{<span class="w">protocol_name</span>} <span class="s">)</span> <span class="s">{</span>

        <span class="c">#   if(alDente::Protocol::new_plate($step_name,-step_type=&gt;'Pre-Print')) { &lt;CONSTRUCTION&gt; when check_if_new_plate() is fixed, use this line instead</span>
        <span class="i">$index</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Found</span>{<span class="w">Lab_Protocol_ID</span>}[<span class="i">$index</span>] <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$step_name</span> = <span class="i">$Found</span>{<span class="w">Prep_Name</span>}[<span class="i">$index</span>]<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$step_name</span> =~ <span class="q">/^Pre-Print/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$Result</span>{<span class="w">protocol_name</span>} = <span class="q">'Pre-Printed in '</span> . <span class="i">$Found</span>{<span class="q">'Lab_Protocol_Name'</span>}[<span class="i">$index</span>]<span class="sc">;</span>
                <span class="i">$Result</span>{<span class="w">employee</span>}      = <span class="i">$Found</span>{<span class="q">'FK_Employee__ID'</span>}[<span class="i">$index</span>]<span class="sc">;</span>
                <span class="k">last</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$index</span>++<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> \<span class="i">%Result</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">########################################</span>
<span class="c"># Generates a small label describing the container</span>
<span class="c">#</span>
<span class="c"># Returns a string containing info about a container</span>
<span class="c">####################</span>
<a name="label-"></a><span class="k">sub </span><span class="m">label</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$self</span>      = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>      = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">&quot;plate_id,highlight&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>       = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span>  = <span class="i">$args</span>{-<span class="w">plate_id</span>} || <span class="i">$self</span>-&gt;{<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$highlight</span> = <span class="i">$args</span>{-<span class="w">highlight</span>}<span class="sc">;</span>                                                                               <span class="c">## highlight plates (eg direct ancestorss</span>
    <span class="k">my</span> <span class="i">$colour</span>    = <span class="i">$args</span>{-<span class="w">colour</span>} || <span class="q">'White'</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$highlight</span> &amp;&amp; !<span class="i">$colour</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$colour</span> = <span class="q">'lightgreen'</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$P</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span>-&gt;{<span class="w">id</span>} == <span class="i">$plate_id</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$P</span> = <span class="i">$self</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$P</span> = <span class="w">alDente::Container</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$fk_os_id</span> = <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Library.FK_Original_Source__ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$os_name</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Original_Source'</span><span class="cm">,</span> <span class="q">'Original_Source_Name'</span><span class="cm">,</span> <span class="q">&quot;where Original_Source_ID = &quot;</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Library.FK_Original_Source__ID'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$rac_name</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Rack'</span><span class="cm">,</span> <span class="q">'Rack_Name'</span><span class="cm">,</span> <span class="q">&quot;where Rack_ID = &quot;</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.FK_Rack__ID'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@plate_info</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@plate_info</span><span class="cm">,</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Class'</span><span class="s">)</span> <span class="s">)</span>              <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Class'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@plate_info</span><span class="cm">,</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate_Format.Well_Capacity_mL'</span><span class="s">)</span> <span class="s">)</span>  <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate_Format.Well_Capacity_mL'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@plate_info</span><span class="cm">,</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate_Format.Plate_Format_Type'</span><span class="s">)</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate_Format.Plate_Format_Type'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span><span class="s">(</span> <span class="i">@plate_info</span><span class="cm">,</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Library_Plate.Plate_Position'</span><span class="s">)</span> <span class="s">)</span>   <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Library_Plate.Plate_Position'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$name</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Type'</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Type'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="q">' ('</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Size'</span><span class="s">)</span> . <span class="q">')'</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Size'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="w">lbr</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.FK_Library__Name'</span><span class="s">)</span> . <span class="q">'-'</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Number'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Parent_Quadrant'</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Parent_Quadrant'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Parent_Well'</span><span class="s">)</span> <span class="k">if</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Parent_Well'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="q">' ('</span> . <span class="k">join</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@plate_info</span> <span class="s">)</span> . <span class="q">')'</span> <span class="k">if</span> <span class="s">(</span><span class="i">@plate_info</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="w">lbr</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Library.Library_FullName'</span><span class="s">)</span>                           <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Library.Library_FullName'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="w">lbr</span> . <span class="q">'&lt;i&gt;'</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Employee.Initials'</span><span class="s">)</span> . <span class="q">'&lt;/i&gt;'</span>                 <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Employee.Initials'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="q">' ('</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Created'</span><span class="s">)</span> . <span class="q">')'</span>                         <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Created'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="w">lbr</span> . <span class="i">$P</span>-&gt;{<span class="w">protocol_name</span>}                                             <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span>-&gt;{<span class="w">protocol_name</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="w">lbr</span> . <span class="q">'RAC'</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.FK_Rack__ID'</span><span class="s">)</span> . <span class="q">' ('</span> . <span class="i">$rac_name</span> . <span class="q">')'</span> <span class="k">if</span> <span class="s">(</span><span class="i">$rac_name</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="w">lbr</span> . <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Tube.Position'</span><span class="s">)</span>                                      <span class="k">if</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Tube.Position'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$name</span> .= <span class="w">lbr</span> . <span class="i">$os_name</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$P</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Type'</span><span class="s">)</span> <span class="k">eq</span> <span class="q">'Tube'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#comments... should it be added?</span>

    <span class="k">return</span> <span class="q">&quot;&lt;Table cellspacing=0 cellpadding=0 nowrap&gt;&lt;TR&gt;&lt;TD bgcolor='$colour'&gt;$name&lt;/TD&gt;&lt;/TR&gt;&lt;/Table&gt;&quot;</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">####################################</span>
<span class="c"># Add Plate record to the database.</span>
<span class="c">#  (requires specification of ALL mandatory fields)</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c">#</span>
<span class="c"># Examples:</span>
<span class="c">#</span>
<span class="c"># To make a plate with Clone Samples for Sequencing:</span>
<span class="c">#&amp;Library_Plate::add_Plate(-plate_size=&gt;$plate_size, -library=&gt;$library_name, -rack_id=&gt;'1', -employee=&gt;$user_id, -plate_format_id=&gt;$format_id, -plate_status=&gt;'Active', -plate_type=&gt;'Library_Plate', -plate_test_status=&gt;'Production',-add_samples=&gt;'clone', -plate_contents=&gt;$plate_contents, -parent_plate_id=&gt;$plate_id,-plate_comments=&gt;'Test comments');</span>
<span class="c">#</span>
<span class="c"># To make a plate with Extraction Samples for Lib_Construction:</span>
<span class="c">#</span>
<span class="c">#&amp;Library_Plate::add_Plate(-plate_size=&gt;$plate_size, -library=&gt;$library_name, -rack_id=&gt;'1', -employee=&gt;$user_id, -plate_format_id=&gt;$format_id, -plate_status=&gt;'Active', -plate_type=&gt;'Library_Plate', -plate_test_status=&gt;'Production',-add_samples=&gt;$extraction, -plate_contents=&gt;$plate_contents, -parent_plate_id=&gt;$plate_id,-plate_comments=&gt;'Test comments');</span>
<span class="c">#</span>
<span class="c"># &lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Return: 0 on failure, 1 if success</span>
<span class="c">####################################</span>
<a name="add_Plate-"></a><span class="k">sub </span><span class="m">add_Plate</span> <span class="s">{</span>
<span class="c">#############</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="w">ERRORS</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Input Errors Found: $args{ERRORS}&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$input</span> = <span class="i">$args</span>{-<span class="w">input</span>}<span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%</span>{<span class="i">$input</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$args</span>{<span class="q">&quot;-$key&quot;</span>} = <span class="i">$input</span>-&gt;{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$dbc</span>         = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_size</span>  = <span class="i">$args</span>{-<span class="w">plate_size</span>}<span class="sc">;</span>                 <span class="c">### size of new plate (96 or 384)</span>
    <span class="k">my</span> <span class="i">$created</span>     = <span class="i">$args</span>{-<span class="w">created</span>} || <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>    <span class="c">### default to now..</span>
    <span class="k">my</span> <span class="i">$library</span>     = <span class="i">$args</span>{-<span class="w">library</span>}<span class="sc">;</span>                    <span class="c">### library (must be unique, 5 alpha-num characters)</span>
    <span class="k">my</span> <span class="i">$rack_id</span>     = <span class="i">$args</span>{-<span class="w">rack_id</span>}<span class="sc">;</span>                    <span class="c">### rack_id</span>
    <span class="k">my</span> <span class="i">$employee_id</span> = <span class="i">$args</span>{-<span class="w">employee_id</span>}<span class="sc">;</span>                <span class="c">### employee (id) requesting new plate</span>
    <span class="k">my</span> <span class="i">$employee</span>    = <span class="i">$args</span>{-<span class="w">employee</span>}<span class="sc">;</span>                   <span class="c">### employee (name) requesting new plate</span>

    <span class="k">my</span> <span class="i">$comments</span>          = <span class="i">$args</span>{-<span class="w">comments</span>}<span class="sc">;</span>                             <span class="c">### (optional)</span>
    <span class="k">my</span> <span class="i">$plate_status</span>      = <span class="i">$args</span>{-<span class="w">plate_status</span>} || <span class="q">'Active'</span><span class="sc">;</span>             <span class="c">### (generally 'Active' or 'Reserved' (for later ReArray)</span>
    <span class="k">my</span> <span class="i">$plate_test_status</span> = <span class="i">$args</span>{-<span class="w">plate_test_status</span>} || <span class="q">'Production'</span><span class="sc">;</span>    <span class="c">### (optional: production or test) - default to production</span>
    <span class="k">my</span> <span class="i">$format</span>            = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>                             <span class="c">### (format in text format)</span>
    <span class="k">my</span> <span class="i">$plate_format_id</span>   = <span class="i">$args</span>{-<span class="w">plate_format_id</span>}<span class="sc">;</span>                      <span class="c">### (format_id if known)</span>

    <span class="k">my</span> <span class="i">$plate_type</span> = <span class="i">$args</span>{-<span class="w">type</span>}  || <span class="q">'Library_Plate'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quiet</span>      = <span class="i">$args</span>{-<span class="w">quiet</span>} || <span class="n">0</span><span class="sc">;</span>                                  <span class="c">### quiet output (generate no stdout print statements)</span>
    <span class="k">my</span> <span class="i">$sample_alias</span> = <span class="i">$args</span>{-<span class="w">sample_alias_hash</span>}<span class="sc">;</span>                         <span class="c">### hashref that defines the sample aliases</span>
    <span class="c">### in the form { '&lt;well&gt;' =&gt; {'alias' =&gt; '&lt;aliasname&gt;', 'type' =&gt; '&lt;aliastype&gt;' .... } }</span>
    <span class="k">my</span> <span class="i">$parent_plate_id</span> = <span class="i">$args</span>{-<span class="w">parent_plate_id</span>}<span class="sc">;</span>                        <span class="c">### optional set parent plate ID</span>

    <span class="k">my</span> <span class="i">$plate_contents</span> = <span class="i">$args</span>{-<span class="w">plate_contents</span>} || <span class="q">'clone'</span><span class="sc">;</span>               <span class="c">### optional set plate contents.. defaults to 'clone'</span>
    <span class="k">my</span> <span class="i">$sample_type_id</span> = <span class="i">$args</span>{-<span class="w">sample_type_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_samples</span>    = <span class="i">$args</span>{-<span class="w">add_samples</span>} || <span class="q">'n'</span><span class="sc">;</span>                      <span class="c">### optionally add clone samples, extraction samples or none (defaults to 'n')</span>
    <span class="k">my</span> <span class="i">$pipeline_id</span>    = <span class="i">$args</span>{-<span class="w">pipeline_id</span>}<span class="sc">;</span>                             <span class="c">### pipeline id of the plate</span>
    <span class="k">my</span> <span class="i">$source_id</span>      = <span class="i">$args</span>{-<span class="w">source_id</span>}<span class="sc">;</span>                               <span class="c">### add source ID for clones</span>
    <span class="k">my</span> <span class="i">$qc_status</span>      = <span class="i">$args</span>{-<span class="w">qc_status</span>} || <span class="q">'N/A'</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">qc_status</span>}         ||= <span class="q">'N/A'</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">plate_status</span>}      ||= <span class="q">'Active'</span><span class="sc">;</span>
    <span class="i">$args</span>{-<span class="w">current_vol_units</span>} ||= <span class="q">'uL'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%Aliases</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_id</span>}          = <span class="q">'Plate.Plate_ID'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">original_plate_id</span>} = <span class="q">'Plate.FKOriginal_Plate__ID'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">parent_plate_id</span>}   = <span class="q">'Plate.FKParent_Plate__ID'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">employee</span>}          = <span class="q">'Plate.FK_Employee__ID'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_number</span>}      = <span class="q">'Plate.Plate_Number'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">library</span>}           = <span class="q">'Plate.FK_Library__Name'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">rack_id</span>}           = <span class="q">'Plate.FK_Rack__ID'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_format_id</span>}   = <span class="q">'Plate.FK_Plate_Format__ID'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_status</span>}      = <span class="q">'Plate.Plate_Status'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_size</span>}        = <span class="q">'Plate.Plate_Size'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">sample_type_id</span>}    = <span class="q">'Plate.FK_Sample_Type__ID'</span><span class="sc">;</span>

    <span class="c">#    $Aliases{Plate}{plate_contents}    = 'Plate.Plate_Content_Type';</span>

    <span class="c">#    $Aliases{Plate}{plate_application} = 'Plate.Plate_Application';</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_type</span>}        = <span class="q">'Plate.Plate_Type'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_test_status</span>} = <span class="q">'Plate.Plate_Test_Status'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_comments</span>}    = <span class="q">'Plate.Plate_Comments'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">parent_quadrant</span>}   = <span class="q">'Plate.Parent_Quadrant'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_position</span>}    = <span class="q">'Plate_Tray.Plate_Position'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_class</span>}       = <span class="q">'Plate.Plate_Class'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">unused_wells</span>}      = <span class="q">'Library_Plate.Unused_Wells'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">problematic_wells</span>} = <span class="q">'Library_Plate.Problematic_Wells'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">empty_wells</span>}       = <span class="q">'Library_Plate.Empty_Wells'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">NGs</span>}               = <span class="q">'Library_Plate.No_Grows'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">SGs</span>}               = <span class="q">'Library_Plate.Slow_Grows'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_created</span>}     = <span class="q">'Plate.Plate_Created'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">qc_status</span>}         = <span class="q">'Plate.QC_Status'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">pipeline_id</span>}       = <span class="q">'Plate.FK_Pipeline__ID'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">current_vol_units</span>} = <span class="q">'Plate.Current_Volume_Units'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">sample_type_id</span>}    = <span class="q">'Plate.FK_Sample_Type__ID'</span><span class="sc">;</span>
    <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="w">plate_label</span>}       = <span class="q">'Plate.Plate_Label'</span><span class="sc">;</span>

    <span class="c">## Set values ##</span>
    <span class="i">$args</span>{-<span class="w">type</span>} = <span class="q">'Library_Plate'</span><span class="sc">;</span>

    <span class="c"># if pipeline_id is not defined, set it now</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$args</span>{-<span class="w">pipeline_id</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$args</span>{-<span class="w">pipeline_id</span>} <span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">&quot;Pipeline&quot;</span><span class="cm">,</span> <span class="q">&quot;Pipeline_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE Pipeline_Name='TBD'&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">### Error Checking ###</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">$dbc</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;No Database handle supplied&quot;</span><span class="sc">;</span> <span class="k">return</span> <span class="n">0</span><span class="sc">;</span> <span class="s">}</span>

    <span class="c">### Ensure all info is available ###</span>
    <span class="k">my</span> <span class="i">$failed</span>          = <span class="q">''</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@mandatory_input</span> = <span class="s">(</span> <span class="q">'plate_size'</span><span class="cm">,</span> <span class="q">'library'</span><span class="cm">,</span> <span class="q">'rack_id'</span><span class="cm">,</span> <span class="q">'sample_type_id'</span><span class="cm">,</span> <span class="q">'employee'</span><span class="cm">,</span> <span class="q">'plate_format_id'</span><span class="cm">,</span> <span class="q">'plate_status'</span><span class="cm">,</span> <span class="q">'plate_type'</span><span class="cm">,</span> <span class="q">'qc_status'</span><span class="cm">,</span> <span class="q">'pipeline_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@optional_input</span>  = <span class="s">(</span> <span class="q">'plate_class'</span><span class="cm">,</span> <span class="q">'plate_test_status'</span><span class="cm">,</span> <span class="q">'plate_comments'</span><span class="cm">,</span> <span class="q">'parent_plate_id'</span><span class="cm">,</span> <span class="q">'plate_contents'</span><span class="cm">,</span> <span class="q">'current_vol_units'</span><span class="cm">,</span> <span class="q">'plate_label'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$input</span> <span class="s">(</span><span class="i">@mandatory_input</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$args</span>{<span class="q">&quot;-$input&quot;</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="k">unless</span> <span class="s">(</span><span class="i">$quiet</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;$input = &quot;</span> . <span class="i">$args</span>{<span class="q">&quot;-$input&quot;</span>} . <span class="q">&quot;\n&quot;</span> <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span> <span class="i">$failed</span> .= <span class="q">&quot;$input\n&quot;</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$failed</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">unless</span> <span class="s">(</span><span class="i">$quiet</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;Failed - Missing Data:\n***********************\n$failed\n&quot;</span> <span class="s">}</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$input</span> <span class="s">(</span><span class="i">@mandatory_input</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$value</span> = <span class="i">$args</span>{<span class="q">&quot;-$input&quot;</span>}<span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="i">$input</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$input</span> = <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="i">$input</span>} <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">/(.*)\.(.+)/</span> <span class="s">)</span> <span class="s">{</span> <span class="s">}</span>                            <span class="c">## table spec already supplied...</span>
        <span class="k">else</span>                             <span class="s">{</span> <span class="i">$input</span> = <span class="q">&quot;Plate.$input&quot;</span> <span class="s">}</span>    <span class="c">## add table to field specficiation</span>

        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$value</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c">#print &quot;input: $input value: $value\n&quot;;</span>
            <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span> <span class="i">$input</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$input</span> <span class="s">(</span><span class="i">@optional_input</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$value</span> = <span class="i">$args</span>{<span class="q">&quot;-$input&quot;</span>}<span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="i">$input</span>} <span class="s">)</span> <span class="s">{</span> <span class="i">$input</span> = <span class="i">$Aliases</span>{<span class="w">Plate</span>}{<span class="i">$input</span>} <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">/(.*)\.(.+)/</span> <span class="s">)</span> <span class="s">{</span> <span class="s">}</span>                            <span class="c">## table spec already supplied...</span>
        <span class="k">else</span>                             <span class="s">{</span> <span class="i">$input</span> = <span class="q">&quot;Plate.$input&quot;</span> <span class="s">}</span>    <span class="c">## add table to field specficiation</span>

        <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$value</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c">#print &quot;input: $input value: $value\n&quot;;</span>
            <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span> <span class="i">$input</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="i">$self</span><span class="i">-&gt;insert</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>                                                    <span class="c">## trigger logic handled specifically in new_container_trigger  -no_triggers=&gt;1);# insert plate record</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$returnval</span><span class="s">)</span> = <span class="i">@</span>{ <span class="i">$self</span><span class="i">-&gt;newids</span><span class="s">(</span><span class="q">'Plate'</span><span class="s">)</span> }<span class="sc">;</span>

    <span class="c"># insert original plate id (pointing to itself)</span>
    <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FKOriginal_Plate__ID'</span><span class="cm">,</span> <span class="q">'Plate_Created'</span> <span class="s">]</span><span class="cm">,</span> <span class="s">[</span> <span class="i">$returnval</span><span class="cm">,</span> <span class="i">$created</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID=$returnval&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># line below moved somewhere else ... (Eric)</span>
    <span class="c">#    my $Sample = alDente::Sample::create_samples( -dbc =&gt; $dbc, -plate_id =&gt; $returnval, -source_id =&gt; $source_id, -type =&gt; $add_samples );</span>

    <span class="k">return</span> <span class="i">$returnval</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##################################################################################</span>
<span class="c"># Record Source record for a given plate (used during extraction of new samples)</span>
<span class="c">#</span>
<span class="c"># Options: -format (defaults to virtual)</span>
<span class="c">#</span>
<span class="c"># &lt;snip&gt;</span>
<span class="c"># eg.</span>
<span class="c"># my $new_source_id = alDente::Container::define_Plate_as_Source($dbc,$plate_id);</span>
<span class="c">#&lt;/snip&gt;</span>
<span class="c">#</span>
<span class="c"># Return: Source_ID</span>
<span class="c">##################################</span>
<a name="define_Plate_as_Source-"></a><span class="k">sub </span><span class="m">define_Plate_as_Source</span> <span class="s">{</span>
<span class="c">##################################</span>
    <span class="k">my</span> <span class="i">%args</span>          = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc,plate_id'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>           = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span>      = <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$format</span>        = <span class="i">$args</span>{<span class="q">'-format'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_type</span>   = <span class="i">$args</span>{-<span class="w">sample_type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parent_source</span> = <span class="i">$args</span>{-<span class="w">parent_source</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>         = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="c">## retrieve sample_type, parent plate, parent source information from plate</span>
    <span class="k">my</span> <span class="i">@plate_info</span>
        = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate,Library'</span><span class="cm">,</span> <span class="q">'Plate_ID,Plate.FK_Sample_Type__ID,FKParent_Plate__ID,FK_Plate_Format__ID,FK_Original_Source__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate.FK_Library__Name=Library_Name AND Plate_ID IN ($plate_id)&quot;</span><span class="cm">,</span> -<span class="w">distinct</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$rack</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$user</span> = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'user_id'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$now</span>  = <span class="i">&amp;date_time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$label</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Barcode_Label'</span><span class="cm">,</span> <span class="q">'Barcode_Label_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Barcode_Label_Name = 'src_no_barcode'&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$new_source_id</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span><span class="i">@plate_info</span><span class="s">)</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">## unambiguous source ##</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$plate</span><span class="cm">,</span> <span class="i">$sample</span><span class="cm">,</span> <span class="i">$parent</span><span class="cm">,</span> <span class="i">$plate_format</span><span class="cm">,</span> <span class="i">$os</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$plate_info</span>[<span class="n">0</span>]<span class="sc">;</span>
        <span class="i">$sample_type</span> ||= <span class="i">$sample</span><span class="sc">;</span>
        <span class="i">$format</span>      ||= <span class="i">$plate_format</span><span class="sc">;</span>

        <span class="i">$new_source_id</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span>
            <span class="q">'Source'</span><span class="cm">,</span>
            <span class="s">[</span> <span class="q">'FKParent_Source__ID'</span><span class="cm">,</span> <span class="q">'FK_Sample_Type__ID'</span><span class="cm">,</span> <span class="q">'FK_Original_Source__ID'</span><span class="cm">,</span> <span class="q">'Received_Date'</span><span class="cm">,</span> <span class="q">'FKReceived_Employee__ID'</span><span class="cm">,</span> <span class="q">'FK_Rack__ID'</span><span class="cm">,</span> <span class="q">'FKSource_Plate__ID'</span><span class="cm">,</span> <span class="q">'FK_Plate_Format__ID'</span><span class="cm">,</span> <span class="q">'FK_Barcode_Label__ID'</span> <span class="s">]</span><span class="cm">,</span>
            <span class="s">[</span> <span class="i">$parent_source</span><span class="cm">,</span>        <span class="i">$sample_type</span><span class="cm">,</span>         <span class="i">$os</span><span class="cm">,</span>                      <span class="i">$now</span><span class="cm">,</span>            <span class="i">$user</span><span class="cm">,</span>                     <span class="i">$rack</span><span class="cm">,</span>         <span class="i">$plate</span><span class="cm">,</span>               <span class="i">$format</span><span class="cm">,</span>               <span class="i">$label</span> <span class="s">]</span><span class="cm">,</span>
            -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
            -<span class="w">debug</span>     <span class="cm">=&gt;</span> <span class="i">$debug</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Source information ambiguous for this plate ($plate_id)&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## define format if applicable (along with barcode option if applicable)</span>

    <span class="c">## set amounts only if tracked (if format supplied) - otherwise set to null (virtual)</span>

    <span class="c">## add Source record</span>
    <span class="k">return</span> <span class="i">$new_source_id</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># private_methods            #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># private_functions          #</span>
<span class="c">##############################</span>

<span class="c">############################</span>
<a name="_get_parent_sample-"></a><span class="k">sub </span><span class="m">_get_parent_sample</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="c"># Display link and description of child issues given a parent issue ID, recursive</span>
    <span class="c">#</span>
    <span class="c"># &lt;snip&gt;</span>
    <span class="c">#</span>
    <span class="c"># &lt;/snip&gt;</span>
    <span class="c"># Return: 1 on success</span>

    <span class="k">my</span> <span class="i">%args</span> = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sample_id</span> = <span class="i">$args</span>{-<span class="w">sample_id</span>}<span class="sc">;</span>    <span class="c">#  Parent Issue ID</span>

    <span class="c"># Find the list of child issues</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$sample_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$parent_sample</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample'</span><span class="cm">,</span> <span class="q">'FKParent_Sample__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_ID = $sample_id&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$parent_sample</span><span class="s">)</span> <span class="s">{</span>

            <span class="c">#  get the issue description for each child issue</span>
            <span class="k">my</span> <span class="i">@parent_info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample,Sample_Type'</span><span class="cm">,</span> <span class="q">'Sample_Name,Sample_Type'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Sample_Type__ID=Sample_Type_ID and Sample_ID=$parent_sample&quot;</span> <span class="s">)</span><span class="sc">;</span>

            <span class="k">my</span> <span class="s">(</span> <span class="i">$sample_name</span><span class="cm">,</span> <span class="i">$sample_type</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$parent_info</span>[<span class="n">0</span>]<span class="sc">;</span>

            <span class="k">my</span> <span class="i">$sample_info</span> = <span class="q">&quot;&lt;BR&gt;&quot;</span> . <span class="i">hspace</span><span class="s">(</span><span class="n">20</span><span class="s">)</span> . <span class="q">&quot;Parent Sample Name: $sample_name, Extraction Type: $sample_type &quot;</span><span class="sc">;</span>

            <span class="k">print</span> <span class="i">$sample_info</span><span class="sc">;</span>

            <span class="c"># recursive call to find the children for each child issue</span>
            <span class="i">_get_parent_sample</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">sample_id</span> <span class="cm">=&gt;</span> <span class="i">$parent_sample</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#### Moved from Special Branches</span>
<span class="c">##################</span>
<a name="SB_trigger-"></a><span class="k">sub </span><span class="m">SB_trigger</span> <span class="s">{</span>
<span class="c">##################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span>       = <span class="i">$self</span>-&gt;{<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span>      = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Type'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span>  = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$returnval</span> = <span class="i">$plate_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$home_barcode</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_type_id</span> = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.FK_Sample_Type__ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sample_type</span>    = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Sample_Type.Sample_Type'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$add_source_id</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Add Plate Source_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pipeline_id</span>   = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.FK_Pipeline__ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$library</span>       = <span class="i">$self</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.FK_Library__Name'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$lib_type</span> = <span class="i">&amp;alDente::Library::check_Library_Type</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">library</span> <span class="cm">=&gt;</span> <span class="i">$library</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$added_source</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$dbc</span><span class="i">-&gt;transaction</span><span class="i">-&gt;newids</span>-&gt;{<span class="q">'Source'</span>}[<span class="n">0</span>] <span class="s">)</span> <span class="s">{</span>
        <span class="i">$added_source</span> = <span class="i">$dbc</span><span class="i">-&gt;transaction</span><span class="i">-&gt;newids</span>-&gt;{<span class="q">'Source'</span>}[<span class="n">0</span>]<span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$add_source_id</span> ||= <span class="i">$added_source</span><span class="sc">;</span>

    <span class="s">(</span><span class="i">$sample_type</span><span class="s">)</span>    = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Type'</span><span class="cm">,</span> <span class="q">'Sample_Type'</span><span class="cm">,</span>    <span class="q">&quot;WHERE Sample_Type_ID = $sample_type_id&quot;</span> <span class="s">)</span> <span class="k">if</span> !<span class="i">$sample_type</span><span class="sc">;</span>
    <span class="s">(</span><span class="i">$sample_type_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Sample_Type'</span><span class="cm">,</span> <span class="q">'Sample_Type_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Sample_Type = '$sample_type'&quot;</span> <span class="s">)</span>     <span class="k">if</span> !<span class="i">$sample_type_id</span><span class="sc">;</span>

    <span class="c">#    require alDente::Plate_Schedule;</span>
    <span class="c">#    my $plate_schedule = alDente::Plate_Schedule-&gt;new(-dbc=&gt;$self-&gt;{dbc});</span>
    <span class="c">#    $plate_schedule-&gt;add_plate_schedule(-plate_id =&gt; $plate_id,-pipeline_id=&gt;$pipeline_id);</span>

    <span class="k">my</span> <span class="i">%src_info</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$add_source_id</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">%src_info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Source'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Current_Amount'</span><span class="cm">,</span> <span class="q">'Amount_Units'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Source_ID = $add_source_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">'Library_Plate'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$lib_type</span> ||= <span class="q">'seq_lib'</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$lib_type</span> <span class="k">eq</span> <span class="q">'seq_lib'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$home_barcode</span> = <span class="i">_update_seq_plate</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">new_ids</span> <span class="cm">=&gt;</span> <span class="i">$returnval</span><span class="cm">,</span> -<span class="w">add_source_id</span> <span class="cm">=&gt;</span> <span class="i">$add_source_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$lib_type</span> <span class="k">eq</span> <span class="q">'rna_lib'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">### Where's param('New') coming from?? can't find it, maybe old? (reza)</span>
            <span class="i">$home_barcode</span> = <span class="i">_update_rna_plate</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">new_ids</span> <span class="cm">=&gt;</span> <span class="i">$returnval</span><span class="cm">,</span> -<span class="w">add_source_id</span> <span class="cm">=&gt;</span> <span class="i">$add_source_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$add_source_id</span><span class="s">)</span> <span class="s">{</span>

            <span class="c"># volume tracking for tubes</span>
            <span class="k">my</span> <span class="i">$source_vol</span>   = <span class="i">$src_info</span>{<span class="w">Current_Amount</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$source_units</span> = <span class="i">$src_info</span>{<span class="w">Amount_Units</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">%plate_info</span>   = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">&quot;Plate,Plate_Format&quot;</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Current_Volume'</span><span class="cm">,</span> <span class="q">'Current_Volume_Units'</span><span class="cm">,</span> <span class="q">'Wells'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($plate_id) AND FK_Plate_Format__ID = Plate_Format_ID&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$plate_vol</span>    = <span class="i">$plate_info</span>{<span class="w">Current_Volume</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$plate_units</span>  = <span class="i">$plate_info</span>{<span class="w">Current_Volume_Units</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$plate_size</span>   = <span class="i">$plate_info</span>{<span class="w">Wells</span>}[<span class="n">0</span>]<span class="sc">;</span>

            <span class="k">if</span> <span class="s">(</span> <span class="i">$source_vol</span> &amp;&amp; <span class="s">(</span> <span class="i">$source_units</span> <span class="k">eq</span> <span class="q">'ml'</span> || <span class="i">$source_units</span> <span class="k">eq</span> <span class="q">'ul'</span> <span class="s">)</span> &amp;&amp; <span class="i">$plate_vol</span> &amp;&amp; <span class="i">$plate_units</span> &amp;&amp; <span class="i">$plate_size</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$total_plate_vol</span> = <span class="i">$plate_size</span> * <span class="i">$plate_vol</span><span class="sc">;</span>
                <span class="i">&amp;alDente::Source::_subtract_source_volume</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">source_id</span> <span class="cm">=&gt;</span> <span class="i">$add_source_id</span><span class="cm">,</span> -<span class="w">amnt</span> <span class="cm">=&gt;</span> <span class="i">$total_plate_vol</span><span class="cm">,</span> -<span class="w">amnt_units</span> <span class="cm">=&gt;</span> <span class="i">$plate_units</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">'Tube'</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># Create a RNA sample for type other than rearrays</span>
        <span class="k">my</span> <span class="i">$library</span> = <span class="i">param</span><span class="s">(</span><span class="q">'FK_Library__Name'</span><span class="s">)</span><span class="sc">;</span>

        <span class="c">## &lt;CONSTRUCTION&gt; - hack fix - remove all logic in special branches if possible ... way to funky...</span>
        <span class="i">$home_barcode</span> = <span class="i">_update_tube</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">Plate</span> <span class="cm">=&gt;</span> <span class="i">$self</span><span class="cm">,</span> -<span class="w">new_ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span><span class="cm">,</span> -<span class="w">add_source_id</span> <span class="cm">=&gt;</span> <span class="i">$add_source_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="i">$sample_type</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$add_source_id</span><span class="s">)</span> <span class="s">{</span>

            <span class="c"># volume tracking for tubes</span>
            <span class="k">my</span> <span class="i">$source_vol</span>   = <span class="i">$src_info</span>{<span class="w">Current_Amount</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$source_units</span> = <span class="i">$src_info</span>{<span class="w">Amount_Units</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">%plate_info</span>   = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">&quot;Plate,Plate_Format&quot;</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Current_Volume'</span><span class="cm">,</span> <span class="q">'Current_Volume_Units'</span><span class="cm">,</span> <span class="q">'Wells'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID IN ($plate_id) AND FK_Plate_Format__ID = Plate_Format_ID&quot;</span> <span class="s">)</span><span class="sc">;</span>

            <span class="k">my</span> <span class="i">$plate_vol</span>   = <span class="i">$plate_info</span>{<span class="w">Current_Volume</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$plate_units</span> = <span class="i">$plate_info</span>{<span class="w">Current_Volume_Units</span>}[<span class="n">0</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="i">$plate_size</span>  = <span class="i">$plate_info</span>{<span class="w">Wells</span>}[<span class="n">0</span>]<span class="sc">;</span>

            <span class="k">if</span> <span class="s">(</span> <span class="i">$source_vol</span> &amp;&amp; <span class="s">(</span> <span class="i">$source_units</span> <span class="k">eq</span> <span class="q">'ml'</span> || <span class="i">$source_units</span> <span class="k">eq</span> <span class="q">'ul'</span> <span class="s">)</span> &amp;&amp; <span class="i">$plate_vol</span> &amp;&amp; <span class="i">$plate_units</span> &amp;&amp; <span class="i">$plate_size</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$total_plate_vol</span> = <span class="i">$plate_size</span> * <span class="i">$plate_vol</span><span class="sc">;</span>
                <span class="i">&amp;alDente::Source::_subtract_source_volume</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">source_id</span> <span class="cm">=&gt;</span> <span class="i">$add_source_id</span><span class="cm">,</span> -<span class="w">amnt</span> <span class="cm">=&gt;</span> <span class="i">$total_plate_vol</span><span class="cm">,</span> -<span class="w">amnt_units</span> <span class="cm">=&gt;</span> <span class="i">$plate_units</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="i">&amp;alDente::Barcoding::PrintBarcode</span><span class="s">(</span> <span class="i">$self</span><span class="i">-&gt;dbc</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="i">$plate_id</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################################</span>
<a name="manually_generate_Plate_records-"></a><span class="k">sub </span><span class="m">manually_generate_Plate_records</span> <span class="s">{</span>
<span class="c">#############################################</span>
    <span class="k">my</span> <span class="i">%args</span>                       = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>                        = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$Formats</span>                    = <span class="i">$args</span>{<span class="q">'-formats'</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$attributes</span>                 = <span class="i">$args</span>{-<span class="w">attributes</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_id</span>                  = <span class="i">$args</span>{-<span class="w">source_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$source_attributes</span>          = <span class="i">$args</span>{-<span class="w">source_attributes</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$original_source_attributes</span> = <span class="i">$args</span>{-<span class="w">original_source_attributes</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>                      = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="i">$dbc</span><span class="i">-&gt;start_trans</span><span class="s">(</span><span class="q">'barcode_plates'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@added_formats</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$Formats</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">@added_formats</span> = <span class="k">keys</span> <span class="i">%</span>{<span class="i">$Formats</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">@added_formats</span> = <span class="i">$attributes</span>-&gt;{<span class="w">FK_Plate_Format__ID</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## add Source Record ##</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$source_id</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$source_id</span><span class="cm">,</span> <span class="k">my</span> <span class="i">$original_source_id</span> <span class="s">)</span> = <span class="i">alDente::Source::add_Source</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">input</span> <span class="cm">=&gt;</span> <span class="i">$source_attributes</span><span class="cm">,</span> -<span class="w">original_source_attributes</span> <span class="cm">=&gt;</span> <span class="i">$original_source_attributes</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$attributes</span>-&gt;{<span class="w">FK_Library__Name</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="c">## if the library is defined for this plate, then link this library automatically to the new source generated.</span>
            <span class="k">my</span> <span class="i">$lib</span> = <span class="i">$attributes</span>-&gt;{<span class="w">FK_Library__Name</span>}<span class="sc">;</span>
            <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="q">'Library_Source'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FK_Library__Name'</span><span class="cm">,</span> <span class="q">'FK_Source__ID'</span> <span class="s">]</span><span class="cm">,</span> <span class="s">[</span> <span class="i">$lib</span><span class="cm">,</span> <span class="i">$source_id</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

            <span class="c"># Message(&quot;Linked new Library_Source&quot;);</span>

            <span class="k">my</span> <span class="s">(</span><span class="i">$lib_OS_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Library'</span><span class="cm">,</span> <span class="q">'FK_Original_Source__ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Library_Name = '$lib'&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$original_source_id</span> &amp;&amp; <span class="s">(</span> <span class="i">$original_source_id</span> != <span class="i">$lib_OS_id</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="c">## OS for source needs to be added to the hybrid original source defined for the library ##</span>
                <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="q">'Hybrid_Original_Source'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FKParent_Original_Source__ID'</span><span class="cm">,</span> <span class="q">'FKChild_Original_Source__ID'</span> <span class="s">]</span><span class="cm">,</span> <span class="s">[</span> <span class="i">$lib_OS_id</span><span class="cm">,</span> <span class="i">$original_source_id</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>

                <span class="c"># Message(&quot;Added Hybrid OS&quot;);</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="i">&amp;alDente::Source::throw_away_source</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$source_id</span><span class="cm">,</span> -<span class="w">confirmed</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">quiet</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## source is only created for tracking purposes; actual container will be tracked as a container defined below....</span>
    <span class="s">}</span>

    <span class="c">## link to Library Record ##</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$sample_type_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Source,Sample_Type'</span><span class="cm">,</span> <span class="q">'Sample_Type_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Source_ID = $source_id AND FK_Sample_Type__ID = Sample_Type_ID&quot;</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## assume that Source_Type options are a subset of Sample_Type options</span>
    <span class="i">$attributes</span>-&gt;{<span class="q">'FK_Sample_Type__ID'</span>} = <span class="i">$sample_type_id</span><span class="sc">;</span>                                                                                                        <span class="c">## $dbc-&gt;get_FK_info('FK_Sample_Type__ID',$sample_type_id);</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$sample_type_id</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;No Sample Type for Src$source_id&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## Create Plates ##</span>
    <span class="k">my</span> <span class="i">@new_ids</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$format</span> <span class="s">(</span><span class="i">@added_formats</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$format_id</span> = <span class="i">$format</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$format_id</span> !~ <span class="q">/^\d+$/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## if format key is NOT a simple integer, assume it is the Format name... ##</span>
            <span class="s">(</span><span class="i">$format_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Format'</span><span class="cm">,</span> <span class="q">'Plate_Format_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_Format_Type = '$format'&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="s">(</span><span class="i">$wells</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Format'</span><span class="cm">,</span> <span class="q">'Wells'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_Format_ID = $format_id&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$wells</span> &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$attributes</span>-&gt;{<span class="q">'Plate_Type'</span>} = <span class="q">'Library_Plate'</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$attributes</span>-&gt;{<span class="q">'Plate_Type'</span>} = <span class="q">'Tube'</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c">#	Message(&quot;Adding $Formats-&gt;{$format} x &quot; . $dbc-&gt;get_FK_info('FK_Plate_Format__ID',$format_id)  . ' record(s)');</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$format_size</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Format'</span><span class="cm">,</span> <span class="q">'Wells'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_Format_ID = $format_id&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span>   <span class="s">(</span> <span class="i">$format_size</span> &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$attributes</span>-&gt;{<span class="w">Plate_Type</span>} = <span class="q">'Library_Plate'</span> <span class="s">}</span>
        <span class="k">else</span>                      <span class="s">{</span> <span class="i">$attributes</span>-&gt;{<span class="w">Plate_Type</span>} = <span class="q">'Tube'</span> <span class="s">}</span>

        <span class="i">$attributes</span>-&gt;{<span class="w">FK_Plate_Format__ID</span>} = <span class="i">$format_id</span><span class="sc">;</span>

        <span class="c">#	my $Plate = new alDente::Container(-dbc=&gt;$dbc);</span>
        <span class="c">#	my $new_id = $Plate-&gt;manual_add_Container(-attributes=&gt;$attributes,-repeat=&gt;$Formats-&gt;{$format});</span>

        <span class="k">my</span> <span class="i">$repeat</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$Formats</span><span class="s">)</span> <span class="s">{</span> <span class="i">$repeat</span> = <span class="i">$Formats</span>-&gt;{<span class="i">$format</span>} <span class="s">}</span>

        <span class="i">$Benchmark</span>{<span class="q">&quot;ADD_PLA_FOR_$source_id&quot;</span>} = <span class="i">new</span> <span class="i">Benchmark</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$new_id</span> = <span class="i">$dbc</span><span class="i">-&gt;add_Record</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">input</span> <span class="cm">=&gt;</span> <span class="i">$attributes</span><span class="cm">,</span> -<span class="w">repeat</span> <span class="cm">=&gt;</span> <span class="i">$repeat</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Benchmark</span>{<span class="q">&quot;ADDED_PLA_FOR_$source_id&quot;</span>} = <span class="i">new</span> <span class="i">Benchmark</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

        <span class="k">push</span> <span class="i">@new_ids</span><span class="cm">,</span> <span class="i">$new_id</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span><span class="q">'barcode_plates'</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$dbc</span>-&gt;{<span class="w">session</span>}{<span class="w">homepage</span>} = <span class="q">''</span><span class="sc">;</span>    <span class="c">## clear homepage to prevent going to plates home page</span>
    <span class="c">## generate barcodes</span>

    <span class="k">my</span> <span class="i">$ids</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@new_ids</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$ids</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<a name="_update_rna_plate-"></a><span class="k">sub </span><span class="m">_update_rna_plate</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">%args</span>          = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_plate_ids</span> = <span class="i">$args</span>{-<span class="w">new_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>           = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_source_id</span> = <span class="i">$args</span>{-<span class="w">add_source_id</span>}<span class="sc">;</span>

    <span class="c">#my $new_plate_ids = $returnval;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$first_plate_id</span><span class="s">)</span> = <span class="i">$new_plate_ids</span> =~ <span class="q">/^(\d+)/</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_plate_count</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="i">$dbc</span><span class="i">-&gt;start_trans</span><span class="s">(</span><span class="q">'update_rna_plate'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$new_plate_id</span> <span class="s">(</span> <span class="k">split</span> <span class="q">/,/</span><span class="cm">,</span> <span class="i">$new_plate_ids</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$name</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_info</span><span class="s">(</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="i">$new_plate_id</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$Plate</span> = <span class="w">alDente::Library_Plate</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$new_plate_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$Plate</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_ID'</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## (returnval is Library_Plate_ID )</span>

        <span class="c"># Get plate size of the newly create plate</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$plate_size</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate,Plate_Format'</span><span class="cm">,</span> <span class="q">'Wells'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate_Format__ID=Plate_Format_ID AND Plate_ID=$new_plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># 	$plate_size =~ s/(\d+)-well/$1/i;</span>
        <span class="k">my</span> <span class="i">$sub_quadrants</span><span class="sc">;</span>
        <span class="k">if</span>   <span class="s">(</span> <span class="i">$plate_size</span> =~ <span class="q">/384/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$sub_quadrants</span> = <span class="q">&quot;a,b,c,d&quot;</span> <span class="s">}</span>
        <span class="k">else</span>                          <span class="s">{</span> <span class="i">$sub_quadrants</span> = <span class="q">&quot;&quot;</span> <span class="s">}</span>

        <span class="c"># Create the Library_Plate record</span>
        <span class="c">#my $returnval = $dbc-&gt;Table_append_array( 'Library_Plate', [ 'FK_Plate__ID', 'Plate_Class', 'Sub_Quadrants' ], [ $new_plate_id, 'Standard', $sub_quadrants ], -autoquote =&gt; 1 );</span>
        <span class="k">my</span> <span class="i">$returnval</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="q">'Library_Plate'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'Sub_Quadrants'</span> <span class="s">]</span><span class="cm">,</span> <span class="s">[</span> <span class="i">$new_plate_id</span><span class="cm">,</span> <span class="i">$sub_quadrants</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># insert original plate id (pointing to itself)</span>
        <span class="c">### set plate size based on plate format ###</span>

        <span class="i">$plate_size</span> .= <span class="q">'-well'</span><span class="sc">;</span>
        <span class="i">$Plate</span><span class="i">-&gt;update</span><span class="s">(</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">'Plate.Plate_Size'</span><span class="cm">,</span> <span class="q">'Plate.Parent_Quadrant'</span><span class="cm">,</span> <span class="q">'FKOriginal_Plate__ID'</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="i">$plate_size</span><span class="cm">,</span> <span class="q">''</span><span class="cm">,</span> <span class="i">$plate_id</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">### set unused wells if sub_quadrants chosen ###</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'Sub_Quadrants'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$sub_quadrants</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">param</span><span class="s">(</span><span class="q">'Sub_Quadrants'</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">unless</span> <span class="s">(</span> <span class="i">$sub_quadrants</span> =~ <span class="q">/a,b,c,d/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$Plate</span><span class="i">-&gt;reset_SubQuadrants</span><span class="s">(</span> -<span class="w">quadrants</span> <span class="cm">=&gt;</span> <span class="i">$sub_quadrants</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">print</span> <span class="q">&quot;Reset subquadrants for $returnval to $sub_quadrants (rest marked as unused)&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="s">(</span><span class="i">$newplate</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Library_Plate,Plate'</span><span class="cm">,</span> <span class="q">'FKParent_Plate__ID,Plate.Plate_Status,Plate.FK_Sample_Type__ID'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate__ID=Plate_ID AND Library_Plate_ID=$returnval&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$parent</span><span class="cm">,</span> <span class="i">$plate_status</span><span class="cm">,</span> <span class="i">$sample_type</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$newplate</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$new_plate_id</span> &amp;&amp; <span class="s">(</span> <span class="i">$parent</span> !~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$rearrayed</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'ReArray_Request'</span><span class="cm">,</span> <span class="q">'count(*)'</span><span class="cm">,</span> <span class="q">&quot;where FKTarget_Plate__ID = $new_plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$rearrayed</span><span class="s">)</span> <span class="s">{</span>

                <span class="c"># Message(&quot;Rearrayed Plate Detected : link to Clone&quot;)</span>
            <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plate_status</span> <span class="k">eq</span> <span class="q">'Reserved'</span> <span class="s">)</span> <span class="s">{</span>
                <span class="c">### Do not create plate_samples/samples</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Saved extraction info for plate $new_plate_id&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="i">alDente::Sample::create_samples</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$new_plate_id</span><span class="cm">,</span> -<span class="w">source_id</span> <span class="cm">=&gt;</span> <span class="i">$add_source_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="i">$sample_type</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="i">$new_plate_count</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># If more than one plate created then show links for multi-edit of plates</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$new_plate_count</span> &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># Plate table</span>
        <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span> <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">&quot;Multi-record edit of new Plate records&quot;</span><span class="cm">,</span> <span class="q">&quot;&amp;Edit+Table=Plate&amp;Field=Plate_ID&amp;Like=$new_plate_ids&quot;</span><span class="cm">,</span> <span class="q">'blue'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># Library_Plate table</span>
        <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span> <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">&quot;Multi-record edit of new Library_Plate records&quot;</span><span class="cm">,</span> <span class="q">&quot;&amp;Edit+Table=Library_Plate&amp;Field=FK_Plate__ID&amp;Like=$new_plate_ids&quot;</span><span class="cm">,</span> <span class="q">'blue'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span><span class="q">'update_rna_plate'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">_home_barcode</span><span class="s">(</span> <span class="i">$new_plate_ids</span><span class="cm">,</span> <span class="i">$prefix</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">################################</span>
<a name="_update_seq_plate-"></a><span class="k">sub </span><span class="m">_update_seq_plate</span> <span class="s">{</span>
<span class="c">################################</span>
    <span class="k">my</span> <span class="i">%args</span>          = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_plate_ids</span> = <span class="i">$args</span>{-<span class="w">new_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>           = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_source_id</span> = <span class="i">$args</span>{-<span class="w">add_source_id</span>}<span class="sc">;</span>

    <span class="c">#my $new_plate_ids = $returnval;</span>
    <span class="k">my</span> <span class="i">$new_plate_count</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="i">$dbc</span><span class="i">-&gt;start_trans</span><span class="s">(</span><span class="q">'update_seq_plate'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$new_plate_id</span> <span class="s">(</span> <span class="k">split</span> <span class="q">/,/</span><span class="cm">,</span> <span class="i">$new_plate_ids</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$name</span> = <span class="i">$dbc</span><span class="i">-&gt;get_FK_info</span><span class="s">(</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="i">$new_plate_id</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$Plate</span> = <span class="w">alDente::Library_Plate</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$new_plate_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$Plate</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_ID'</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## (returnval is Library_Plate_ID )</span>

        <span class="c"># Get plate size of the newly create plate</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$plate_size</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate,Plate_Format'</span><span class="cm">,</span> <span class="q">'Wells'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate_Format__ID=Plate_Format_ID AND Plate_ID=$new_plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#$plate_size =~ s/(\d+)-well/$1/i</span>
        <span class="k">my</span> <span class="i">$sub_quadrants</span><span class="sc">;</span>
        <span class="k">if</span>   <span class="s">(</span> <span class="i">$plate_size</span> =~ <span class="q">/384/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$sub_quadrants</span> = <span class="q">&quot;a,b,c,d&quot;</span> <span class="s">}</span>
        <span class="k">else</span>                          <span class="s">{</span> <span class="i">$sub_quadrants</span> = <span class="q">&quot;&quot;</span> <span class="s">}</span>

        <span class="c"># Create the Library_Plate record</span>
        <span class="c">#my $returnval = $dbc-&gt;Table_append_array( 'Library_Plate', [ 'FK_Plate__ID', 'Plate_Class', 'Sub_Quadrants' ], [ $new_plate_id, 'Standard', $sub_quadrants ], -autoquote =&gt; 1 );</span>
        <span class="k">my</span> <span class="i">$returnval</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="q">'Library_Plate'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'Sub_Quadrants'</span> <span class="s">]</span><span class="cm">,</span> <span class="s">[</span> <span class="i">$new_plate_id</span><span class="cm">,</span> <span class="i">$sub_quadrants</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># insert original plate id (pointing to itself)</span>

        <span class="c">### set plate size based on plate format ###</span>

        <span class="i">$plate_size</span> .= <span class="q">'-well'</span><span class="sc">;</span>
        <span class="i">$Plate</span><span class="i">-&gt;update</span><span class="s">(</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">'Plate.Plate_Size'</span><span class="cm">,</span> <span class="q">'Plate.Parent_Quadrant'</span><span class="cm">,</span> <span class="q">'FKOriginal_Plate__ID'</span> <span class="s">]</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="i">$plate_size</span><span class="cm">,</span> <span class="q">''</span><span class="cm">,</span> <span class="i">$plate_id</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">### set unused wells if sub_quadrants chosen ###</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">'Sub_Quadrants'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$sub_quadrants</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">param</span><span class="s">(</span><span class="q">'Sub_Quadrants'</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">unless</span> <span class="s">(</span> <span class="i">$sub_quadrants</span> =~ <span class="q">/a,b,c,d/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$Plate</span><span class="i">-&gt;reset_SubQuadrants</span><span class="s">(</span> -<span class="w">quadrants</span> <span class="cm">=&gt;</span> <span class="i">$sub_quadrants</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">print</span> <span class="q">&quot;Reset subquadrants for $returnval to $sub_quadrants (rest marked as unused)&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$newplate</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Library_Plate,Plate'</span><span class="cm">,</span> <span class="q">'FKParent_Plate__ID,Plate_Status,FK_Sample_Type__ID'</span><span class="cm">,</span> <span class="q">&quot;where FK_Plate__ID=Plate_ID AND Library_Plate_ID=$returnval&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$parent</span><span class="cm">,</span> <span class="i">$plate_status</span><span class="cm">,</span> <span class="i">$sample_type</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$newplate</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$new_plate_id</span> &amp;&amp; <span class="s">(</span> <span class="i">$parent</span> !~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$rearrayed</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'ReArray_Request'</span><span class="cm">,</span> <span class="q">'count(*)'</span><span class="cm">,</span> <span class="q">&quot;where FKTarget_Plate__ID = $new_plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$rearrayed</span><span class="s">)</span> <span class="s">{</span> <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Rearrayed Plate Detected : link to Clone&quot;</span><span class="s">)</span> <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plate_status</span> <span class="k">eq</span> <span class="q">'Reserved'</span> <span class="s">)</span> <span class="s">{</span>
                <span class="c">### Do not create plate_samples/samples</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">alDente::Sample::create_samples</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$new_plate_id</span><span class="cm">,</span> -<span class="w">source_id</span> <span class="cm">=&gt;</span> <span class="i">$add_source_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="i">$sample_type</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="i">$new_plate_count</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># If more than one plate created then show links for multi-edit of plates</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$new_plate_count</span> &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># Plate table</span>
        <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span> <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">&quot;Multi-record edit of new Plate records&quot;</span><span class="cm">,</span> <span class="q">&quot;&amp;Edit+Table=Plate&amp;Field=Plate_ID&amp;Like=$new_plate_ids&quot;</span><span class="cm">,</span> <span class="q">'blue'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># Library_Plate table</span>
        <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span> <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">&quot;Multi-record edit of new Library_Plate records&quot;</span><span class="cm">,</span> <span class="q">&quot;&amp;Edit+Table=Library_Plate&amp;Field=FK_Plate__ID&amp;Like=$new_plate_ids&quot;</span><span class="cm">,</span> <span class="q">'blue'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span><span class="q">'update_seq_plate'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">_home_barcode</span><span class="s">(</span> <span class="i">$new_plate_ids</span><span class="cm">,</span> <span class="i">$prefix</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>
<span class="c">########################</span>
<a name="_update_tube-"></a><span class="k">sub </span><span class="m">_update_tube</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">%args</span>          = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>           = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$add_source_id</span> = <span class="i">$args</span>{-<span class="w">add_source_id</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_plate_ids</span> = <span class="i">$args</span>{-<span class="w">new_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$Plate</span>         = <span class="i">$args</span>{-<span class="w">Plate</span>}<span class="sc">;</span>

    <span class="c">#    my $contents      = $args{-contents};</span>
    <span class="k">my</span> <span class="i">@new_plate_ids</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$first_plate_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_plate_count</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$lib_type</span> = <span class="i">$args</span>{-<span class="w">lib_type</span>}<span class="sc">;</span>

    <span class="i">$dbc</span><span class="i">-&gt;start_trans</span><span class="s">(</span><span class="q">'update_tube'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$new_plate_id</span> <span class="s">(</span> <span class="k">split</span> <span class="q">/,/</span><span class="cm">,</span> <span class="i">$new_plate_ids</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$Plate</span> || <span class="i">$new_plate_ids</span> =~ <span class="q">/,/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$Plate</span> = <span class="w">alDente::Tube</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$new_plate_id</span><span class="cm">,</span> -<span class="w">quick_load</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$plate_id</span> = <span class="i">$Plate</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_ID'</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## (returnval is Tube_ID )</span>

        <span class="c">#  Tube SHOULD be created at the same time as the plate.  IF NOT, then the logic below needs to be more specific.</span>
        <span class="c">#  (ie this loop should not need to be executed, but some plate creation processes may require tube record additions (?) - check using DB_Integrity.</span>
        <span class="c">#</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$tube_id</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Tube'</span><span class="cm">,</span> <span class="q">'Tube_ID'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID='$plate_id'&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$tube_id</span> &amp;&amp; !<span class="i">param</span><span class="s">(</span><span class="q">'FormNav'</span><span class="s">)</span> &amp;&amp; <span class="i">param</span><span class="s">(</span><span class="q">'rm'</span><span class="s">)</span> <span class="k">ne</span> <span class="q">'Confirm Upload'</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## Tube doesn't exist yet... so create it ##</span>
            <span class="i">$dbc</span><span class="i">-&gt;Table_append_array</span><span class="s">(</span> <span class="q">'Tube'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'FK_Plate__ID'</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="i">$new_plate_id</span><span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$new_plate_count</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$first_plate_id</span> = <span class="i">$plate_id</span> <span class="s">}</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@new_plate_ids</span><span class="cm">,</span> <span class="i">$plate_id</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># insert original plate id (pointing to itself)</span>
        <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">&quot;Plate&quot;</span><span class="cm">,</span> <span class="s">[</span><span class="q">&quot;FKOriginal_Plate__ID&quot;</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="q">&quot;$plate_id&quot;</span><span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID=$plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">### set plate size based on plate format ###</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$plate_size</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate,Plate_Format'</span><span class="cm">,</span> <span class="q">'Wells'</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate_Format__ID=Plate_Format_ID AND Plate_ID = $plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$plate_size</span> .= <span class="q">'-well'</span><span class="sc">;</span>
        <span class="i">$Plate</span><span class="i">-&gt;update</span><span class="s">(</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="q">'Plate.Plate_Size'</span><span class="s">]</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">$plate_size</span><span class="s">]</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span><span class="i">$newplate</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Tube,Plate,Sample_Type'</span><span class="cm">,</span> <span class="q">'FKParent_Plate__ID,FK_Library__Name,Plate.Plate_Number, Sample_Type'</span><span class="cm">,</span> <span class="q">&quot;where FK_Sample_Type__ID=Sample_Type_ID AND FK_Plate__ID=Plate_ID AND Plate_ID=$new_plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$parent</span><span class="cm">,</span> <span class="i">$lib</span><span class="cm">,</span> <span class="i">$number</span><span class="cm">,</span> <span class="i">$plate_content_type</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$newplate</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$new_plate_id</span> &amp;&amp; <span class="s">(</span> <span class="i">$parent</span> !~ <span class="q">/[1-9]/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## Original ##</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$rearrayed</span><span class="s">)</span>  = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'ReArray_Request'</span><span class="cm">,</span> <span class="q">'count(*)'</span><span class="cm">,</span>             <span class="q">&quot;where FKTarget_Plate__ID = $new_plate_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="s">(</span><span class="i">$extraction</span><span class="s">)</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate'</span><span class="cm">,</span>           <span class="q">'Plate_ID,Plate_Class'</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID = $new_plate_id AND Plate_Class like 'Extraction'&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$rearrayed</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Rearrayed Plate Detected : link to RNA&quot;</span><span class="s">)</span> <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$condition</span><span class="sc">;</span>

                <span class="k">my</span> <span class="i">@plate_sample_rows</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$sample_id</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$rna_sample_id</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$clone_sample_id</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span><span class="i">$extraction</span><span class="s">)</span> <span class="s">{</span>
                    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Track source of new sample from $plate_id ($add_source_id)&quot;</span><span class="s">)</span><span class="sc">;</span>
                    <span class="i">$add_source_id</span> = <span class="i">define_Plate_as_Source</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$new_plate_id</span><span class="cm">,</span> -<span class="w">parent_source</span> <span class="cm">=&gt;</span> <span class="i">$add_source_id</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>

                <span class="k">my</span> <span class="i">$Sample</span> = <span class="i">alDente::Sample::create_samples</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$new_plate_id</span><span class="cm">,</span> -<span class="w">source_id</span> <span class="cm">=&gt;</span> <span class="i">$add_source_id</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># ,-type=&gt;$contents);</span>

            <span class="s">}</span>
        <span class="s">}</span>
        <span class="i">$new_plate_count</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># If more than one plate created then show links for multi-edit of plates</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$new_plate_count</span> &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># Plate table</span>
        <span class="i">Message</span><span class="s">(</span> <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">&quot;Multi-record edit of new Plate records&quot;</span><span class="cm">,</span> <span class="q">&quot;&amp;Edit+Table=Plate&amp;Field=Plate_ID&amp;Like=&quot;</span> . <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="i">@new_plate_ids</span> <span class="s">)</span><span class="cm">,</span> <span class="q">'blue'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># Library_Plate table</span>
        <span class="i">Message</span><span class="s">(</span> <span class="i">&amp;Link_To</span><span class="s">(</span> <span class="i">$homelink</span><span class="cm">,</span> <span class="q">&quot;Multi-record edit of new Tube records&quot;</span><span class="cm">,</span> <span class="q">&quot;&amp;Edit+Table=Tube&amp;Field=FK_Plate__ID&amp;Like=&quot;</span> . <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="i">@new_plate_ids</span> <span class="s">)</span><span class="cm">,</span> <span class="q">'blue'</span><span class="cm">,</span> <span class="s">[</span><span class="q">'newwin'</span><span class="s">]</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span><span class="q">'update_tube'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">_home_barcode</span><span class="s">(</span> <span class="i">$new_plate_ids</span><span class="cm">,</span> <span class="i">$prefix</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># simply returns barcode equivalent when new plates are being generated</span>
<span class="c"># Input: list of new ids</span>
<span class="c">#</span>
<span class="c"># Output: text string of equivalent barcode (eg Pla9Pla10) for new containers</span>
<span class="c">####################</span>
<a name="_home_barcode-"></a><span class="k">sub </span><span class="m">_home_barcode</span> <span class="s">{</span>
<span class="c">####################</span>
    <span class="k">my</span> <span class="i">$new_plate_ids</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$prefix</span>        = <span class="k">shift</span><span class="sc">;</span>    <span class="c">## prefix for the container objects</span>

    <span class="k">my</span> <span class="i">$max_show</span> = <span class="n">20</span><span class="sc">;</span>            <span class="c">## variable - maximum plates to pull up on home page by default after generation</span>

    <span class="c"># Go to the plate's home page after creation</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$first_plate_id</span><span class="s">)</span> = <span class="i">$new_plate_ids</span> =~ <span class="q">/^(\d+)/</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$first_plate_id</span> <span class="s">)</span> <span class="s">{</span><span class="k">return</span><span class="s">}</span>    <span class="c">## no new barcodes generated ..</span>
    <span class="k">my</span> <span class="i">$home_barcode</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span> <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$new_plate_ids</span> <span class="s">)</span> &gt; <span class="i">$max_show</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$home_barcode</span> = <span class="i">$prefix</span> . <span class="i">$first_plate_id</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$home_barcode</span> = <span class="i">$new_plate_ids</span><span class="sc">;</span>
        <span class="i">$home_barcode</span> =~ <span class="q">s /,/$Prefix{Plate}/g</span><span class="sc">;</span>
        <span class="i">$home_barcode</span> = <span class="i">$prefix</span> . <span class="i">$home_barcode</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$home_barcode</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#############################</span>
<span class="c"># When entering this routine, a single record was added for a plate.</span>
<span class="c">#  This will update that record, and add new similar records for each sample on the plate</span>
<span class="c">#</span>
<span class="c"># &lt;CONSTRUCTION&gt; Custom method...</span>
<span class="c">#############################</span>
<a name="_update_clone_source-"></a><span class="k">sub </span><span class="m">_update_clone_source</span> <span class="s">{</span>
<span class="c">#############################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>} || <span class="i">$args</span>{-<span class="w">connection</span>} || <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span> <span class="q">&quot;Connection&quot;</span><span class="cm">,</span> <span class="i">$Connection</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_id</span> = <span class="i">$args</span>{-<span class="w">new_ids</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$prefix</span> = <span class="i">$Prefix</span>{<span class="w">Plate</span>}<span class="sc">;</span>

    <span class="i">$dbc</span><span class="i">-&gt;start_trans</span><span class="s">(</span><span class="q">'update_clone_source'</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># Get information regarding this new clone source</span>
    <span class="k">my</span> <span class="i">%info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Clone_Source,Plate'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Source_Description'</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'Plate_Size'</span><span class="cm">,</span> <span class="q">'FKSource_Organization__ID'</span><span class="cm">,</span> <span class="q">'Source_Collection'</span><span class="cm">,</span> <span class="q">'Source_Plate'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE Plate_ID=FK_Plate__ID AND Clone_Source_ID = $new_id&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$sd</span><span class="cm">,</span> <span class="i">$pid</span><span class="cm">,</span> <span class="i">$ps</span><span class="cm">,</span> <span class="i">$oid</span><span class="cm">,</span> <span class="i">$sc</span><span class="cm">,</span> <span class="i">$sp</span> <span class="s">)</span> = <span class="s">(</span> <span class="i">$info</span>{<span class="w">Source_Description</span>}[<span class="n">0</span>]<span class="cm">,</span> <span class="i">$info</span>{<span class="w">FK_Plate__ID</span>}[<span class="n">0</span>]<span class="cm">,</span> <span class="i">$info</span>{<span class="w">Plate_Size</span>}[<span class="n">0</span>]<span class="cm">,</span> <span class="i">$info</span>{<span class="w">FKSource_Organization__ID</span>}[<span class="n">0</span>]<span class="cm">,</span> <span class="i">$info</span>{<span class="w">Source_Collection</span>}[<span class="n">0</span>]<span class="cm">,</span> <span class="i">$info</span>{<span class="w">Source_Plate</span>}[<span class="n">0</span>] <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@wells</span> = <span class="i">&amp;alDente::Well::Get_Wells</span><span class="s">(</span> -<span class="w">size</span> <span class="cm">=&gt;</span> <span class="i">$ps</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields</span> = <span class="s">(</span> <span class="q">'Source_Description'</span><span class="cm">,</span> <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'FKSource_Organization__ID'</span><span class="cm">,</span> <span class="q">'Source_Collection'</span><span class="cm">,</span> <span class="q">'Source_Plate'</span><span class="cm">,</span> <span class="q">'FK_Clone_Sample__ID'</span><span class="cm">,</span> <span class="q">'Clone_Well'</span><span class="cm">,</span> <span class="q">'Source_Row'</span><span class="cm">,</span> <span class="q">'Source_Col'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%values</span><span class="sc">;</span>

    <span class="c"># Obtain Clone_Sample info as well</span>
    <span class="i">%info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Clone_Sample'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Clone_Sample_ID'</span><span class="cm">,</span> <span class="q">'Original_Well'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FKOriginal_Plate__ID=$pid&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%cs_info</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$info</span>{<span class="w">Clone_Sample_ID</span>}[<span class="i">$i</span>] <span class="s">)</span> <span class="s">{</span>
        <span class="i">$cs_info</span>{ <span class="i">$info</span>{<span class="w">Original_Well</span>}[<span class="i">$i</span>] } = <span class="i">$info</span>{<span class="w">Clone_Sample_ID</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="i">$i</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@converted_wells</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$ps</span> =~ <span class="q">/384/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@fields</span><span class="cm">,</span> <span class="q">'Clone_Quadrant'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@fields</span><span class="cm">,</span> <span class="q">'Well_384'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># Get the 96-size designation of the wells</span>
        <span class="i">@converted_wells</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find_array</span><span class="s">(</span> <span class="q">'Well_Lookup'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'Plate_96'</span><span class="cm">,</span> <span class="q">'Quadrant'</span> <span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt;= <span class="i">$#wells</span><span class="sc">;</span> <span class="i">$i</span>++ <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@vals</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$ps</span> =~ <span class="q">/384/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$well_384</span> = <span class="i">$wells</span>[<span class="i">$i</span>]<span class="sc">;</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$well_96</span><span class="cm">,</span> <span class="i">$quadrant</span> <span class="s">)</span> = <span class="k">split</span> <span class="q">/,/</span><span class="cm">,</span> <span class="i">$converted_wells</span>[<span class="i">$i</span>]<span class="sc">;</span>
            <span class="i">@vals</span> = <span class="s">(</span> <span class="i">$sd</span><span class="cm">,</span> <span class="i">$pid</span><span class="cm">,</span> <span class="i">$oid</span><span class="cm">,</span> <span class="i">$sc</span><span class="cm">,</span> <span class="i">$sp</span><span class="cm">,</span> <span class="i">$cs_info</span>{ <span class="i">format_well</span><span class="s">(</span><span class="i">$well_384</span><span class="s">)</span> }<span class="cm">,</span> <span class="i">$well_96</span><span class="cm">,</span> <span class="k">substr</span><span class="s">(</span> <span class="i">$well_384</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="cm">,</span> <span class="k">substr</span><span class="s">(</span> <span class="i">$well_384</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">2</span> <span class="s">)</span><span class="cm">,</span> <span class="i">$quadrant</span><span class="cm">,</span> <span class="i">$well_384</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$well</span> = <span class="i">$wells</span>[<span class="i">$i</span>]<span class="sc">;</span>
            <span class="i">@vals</span> = <span class="s">(</span> <span class="i">$sd</span><span class="cm">,</span> <span class="i">$pid</span><span class="cm">,</span> <span class="i">$oid</span><span class="cm">,</span> <span class="i">$sc</span><span class="cm">,</span> <span class="i">$sp</span><span class="cm">,</span> <span class="i">$cs_info</span>{<span class="i">$well</span>}<span class="cm">,</span> <span class="i">$well</span><span class="cm">,</span> <span class="k">substr</span><span class="s">(</span> <span class="i">$well</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="cm">,</span> <span class="k">substr</span><span class="s">(</span> <span class="i">$well</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">2</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$i</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># Update the first one</span>
            <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_update_array</span><span class="s">(</span> <span class="q">'Clone_Source'</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> \<span class="i">@vals</span><span class="cm">,</span> <span class="q">&quot;WHERE Clone_Source_ID = $new_id&quot;</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> !<span class="i">$ok</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Failed to update to Clone Source for $prefix$pid!&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Updated Clone Source for $prefix$pid&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>              <span class="c"># All other ones - insert</span>
            <span class="i">$values</span>{<span class="i">$i</span>} = \<span class="i">@vals</span><span class="sc">;</span>

            <span class="c">#print &quot;&gt;&gt;Set values hash ($i) to &quot; . join &quot;,&quot;, @vals;</span>
            <span class="c">#print br;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># Insert the new clone sources,no triggers for the rest of these clone source records!</span>
    <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$dbc</span><span class="i">-&gt;smart_append</span><span class="s">(</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="q">'Clone_Source'</span><span class="cm">,</span> -<span class="w">fields</span> <span class="cm">=&gt;</span> \<span class="i">@fields</span><span class="cm">,</span> -<span class="w">values</span> <span class="cm">=&gt;</span> \<span class="i">%values</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">no_triggers</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$ok</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Failed to insert to Clone Source for $prefix$pid!&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Added Clone Source for $prefix$pid&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$dbc</span><span class="i">-&gt;finish_trans</span><span class="s">(</span><span class="q">'update_clone_source'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Map tray &amp; position specs to plate / well specs</span>
<span class="c">#</span>
<span class="c"># Return hash of plate_id(s), well(s)</span>
<span class="c">#######################</span>
<a name="map_tray_to_plates-"></a><span class="k">sub </span><span class="m">map_tray_to_plates</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">%args</span>     = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>      = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@tray_ids</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">tray_ids</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@tray_pos</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">tray_pos</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'array'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>    = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$tray_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@tray_ids</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$well_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> \<span class="i">@tray_pos</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## get all positions for indicated tray &amp; well combinations ##</span>
    <span class="k">my</span> <span class="i">%Found</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="q">'Plate_Tray,Plate,Plate_Format'</span><span class="cm">,</span> <span class="s">[</span> <span class="q">'FK_Tray__ID'</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">'Plate_Position'</span><span class="cm">,</span> <span class="q">'Plate_Size'</span><span class="cm">,</span> <span class="q">'Wells'</span> <span class="s">]</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Plate__ID=Plate_ID AND FK_Plate_Format__ID=Plate_Format_ID AND FK_Tray__ID IN ($tray_list)&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Map</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$i</span> = <span class="n">-1</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Found</span>{<span class="w">Plate_ID</span>}[ ++<span class="i">$i</span> ] <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$tray</span>     = <span class="i">$Found</span>{<span class="w">FK_Tray__ID</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$position</span> = <span class="i">$Found</span>{<span class="w">Plate_Position</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$size</span>     = <span class="i">$Found</span>{<span class="w">Plate_Size</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$format</span>   = <span class="i">$Found</span>{<span class="w">Wells</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$plate</span>    = <span class="i">$Found</span>{<span class="w">Plate_ID</span>}[<span class="i">$i</span>]<span class="sc">;</span>

        <span class="i">$Map</span>{<span class="i">$tray</span>}{<span class="i">$position</span>} = <span class="q">&quot;$plate&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">## generate well map hash once (quicker than converting each time ##</span>
    <span class="k">my</span> <span class="i">%map</span> = <span class="i">alDente::Well::map_wells</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">target_size</span> <span class="cm">=&gt;</span> <span class="n">96</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">## generate the new ordered plate / well hashes ##</span>
    <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">@plates</span><span class="cm">,</span> <span class="i">@wells</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$tray</span> <span class="s">(</span><span class="i">@tray_ids</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$well</span> = <span class="i">$tray_pos</span>[<span class="i">$i</span>]<span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$Map</span>{ <span class="i">$tray_ids</span>[<span class="i">$i</span>] }{<span class="i">$well</span>} =~ <span class="q">/^(\d+)/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="c">## Mapped actual wells in Tray to tube ##</span>
            <span class="k">push</span> <span class="i">@plates</span><span class="cm">,</span> <span class="i">$1</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@wells</span><span class="cm">,</span>  <span class="q">'A01'</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="c">## Mapped quadrants in Tray ##</span>
            <span class="k">my</span> <span class="i">$mapped</span> = <span class="i">$map</span>{<span class="i">$well</span>}<span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$mapped</span> =~ <span class="q">/^(\w\d+)([abcd])$/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="i">$position</span> = <span class="i">$1</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$quadrant</span> = <span class="i">$2</span><span class="sc">;</span>

                <span class="k">my</span> <span class="i">$plate</span> = <span class="i">$Map</span>{<span class="i">$tray</span>}{<span class="i">$quadrant</span>}<span class="sc">;</span>
                <span class="k">push</span> <span class="i">@plates</span><span class="cm">,</span> <span class="i">$plate</span><span class="sc">;</span>
                <span class="k">push</span> <span class="i">@wells</span><span class="cm">,</span>  <span class="i">$position</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Cannot determine mapping for plate $tray_ids[$i]&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">push</span> <span class="i">@plates</span><span class="cm">,</span> <span class="q">''</span><span class="sc">;</span>
                <span class="k">push</span> <span class="i">@wells</span><span class="cm">,</span>  <span class="q">''</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="i">$i</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Mapped @tray_ids (@tray_pos) -&gt; @plates (@wells)&quot;</span><span class="s">)</span> <span class="s">}</span>
    <span class="k">return</span> \<span class="i">@plates</span><span class="cm">,</span> \<span class="i">@wells</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># Return sample ids for the given wells on plates</span>
<span class="c"># Input: array of plate ids / tray ids</span>
<span class="c">#        array of wells</span>
<span class="c">#</span>
<span class="c"># Output: A hash ref with plate id as key 1 and well position as key 2 and sample id as value</span>
<span class="c">########################</span>
<a name="get_sample_id-"></a><span class="k">sub </span><span class="m">get_sample_id</span> <span class="s">{</span>
<span class="c">########################</span>
    <span class="k">my</span> <span class="i">%args</span>      = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>       = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_ids</span> = <span class="i">$args</span>{-<span class="w">plate_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$wells</span>     = <span class="i">$args</span>{-<span class="w">wells</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tray_ids</span>  = <span class="i">$args</span>{-<span class="w">tray_ids</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$tray_pos</span>  = <span class="i">$args</span>{-<span class="w">wells</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>     = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Tray_map</span><span class="sc">;</span>    <span class="c">## keep track of tray mapping to make reversion faster at the end ...</span>
    <span class="k">my</span> <span class="i">$use_NA</span><span class="sc">;</span>      <span class="c">## flag to keep track of wells which are defined as 'N/A' - as opposed to 'A01' for tubes ##</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$tray_ids</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## if input uses tray ids, first map tray positions to plate / well combinations ##</span>
        <span class="s">(</span> <span class="i">$plate_ids</span><span class="cm">,</span> <span class="i">$wells</span> <span class="s">)</span> = <span class="i">map_tray_to_plates</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">tray_ids</span> <span class="cm">=&gt;</span> <span class="i">$tray_ids</span><span class="cm">,</span> -<span class="w">tray_pos</span> <span class="cm">=&gt;</span> <span class="i">$tray_pos</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$i</span> <span class="s">(</span> <span class="n">1</span> .. <span class="k">int</span><span class="s">(</span><span class="i">@$tray_ids</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$Tray_map</span>{ <span class="i">$plate_ids</span>-&gt;[ <span class="i">$i</span> - <span class="n">1</span> ] }{ <span class="i">$wells</span>-&gt;[ <span class="i">$i</span> - <span class="n">1</span> ] } = <span class="q">&quot;$tray_ids-&gt;[$i-1]-$tray_pos-&gt;[$i-1]&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="i">HTML_Dump</span> <span class="q">&quot;REMAPPED TO &quot;</span><span class="cm">,</span> <span class="i">$plate_ids</span><span class="cm">,</span> <span class="i">$wells</span><span class="cm">,</span> <span class="q">' FROM '</span><span class="cm">,</span> <span class="i">$tray_ids</span><span class="cm">,</span> <span class="i">$tray_pos</span><span class="sc">;</span> <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$original_plates</span><span class="cm">,</span> <span class="i">$original_wells</span> <span class="s">)</span> = <span class="i">get_original_locations</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span><span class="cm">,</span> -<span class="w">wells</span> <span class="cm">=&gt;</span> <span class="i">$wells</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@list</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%Map</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$i</span> <span class="s">(</span> <span class="n">1</span> .. <span class="k">int</span><span class="s">(</span> <span class="i">@</span>{<span class="i">$original_plates</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$plate</span> = <span class="i">$original_plates</span>-&gt;[ <span class="i">$i</span> - <span class="n">1</span> ]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$well</span>  = <span class="i">$original_wells</span>-&gt;[ <span class="i">$i</span> - <span class="n">1</span> ]<span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$well</span> <span class="k">eq</span> <span class="q">'N/A'</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$use_NA</span>++ <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$plate</span><span class="s">)</span> <span class="s">{</span> <span class="k">push</span> <span class="i">@list</span><span class="cm">,</span> <span class="q">&quot;$plate-$well&quot;</span> <span class="s">}</span>

        <span class="c">#if ( $plate != $plate_ids-&gt;[ $i - 1 ] ) {</span>
        <span class="i">$Map</span>{<span class="q">&quot;$plate-$well&quot;</span>} .= <span class="q">&quot;$plate_ids-&gt;[ $i - 1 ]-$wells-&gt;[ $i - 1 ];&quot;</span><span class="sc">;</span>

        <span class="c">#}</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="i">HTML_Dump</span> <span class="q">&quot;MAPPED&quot;</span><span class="cm">,</span> \<span class="i">%Map</span><span class="sc">;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$original_plate_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$original_plates</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$q_list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">@list</span><span class="s">]</span><span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Samples</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$q_list</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> \<span class="i">%Samples</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">%Sample_info</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span>
        <span class="q">'Plate_Sample,Plate'</span><span class="cm">,</span>
        <span class="s">[</span> <span class="q">'FK_Sample__ID'</span><span class="cm">,</span> <span class="q">'Plate_ID'</span><span class="cm">,</span> <span class="q">'Well'</span><span class="cm">,</span> <span class="q">'Plate_Size'</span> <span class="s">]</span><span class="cm">,</span>
        <span class="q">&quot;WHERE Plate_Sample.FKOriginal_Plate__ID=Plate_ID AND Plate_ID IN ($original_plate_list) AND ( CONCAT(Plate_ID,'-',Well) IN ($q_list) OR Well = 'N/A')&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="i">HTML_Dump</span> \<span class="i">%Map</span> <span class="s">}</span>
    <span class="k">my</span> <span class="i">$i</span> = <span class="n">-1</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Sample_info</span>{<span class="q">'FK_Sample__ID'</span>}[ ++<span class="i">$i</span> ] <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$original_plate</span> = <span class="i">$Sample_info</span>{<span class="w">Plate_ID</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$original_well</span>  = <span class="i">$Sample_info</span>{<span class="w">Well</span>}[<span class="i">$i</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$size</span>           = <span class="i">$Sample_info</span>{<span class="w">Plate_Size</span>}[<span class="i">$i</span>]<span class="sc">;</span>

        <span class="k">my</span> <span class="i">$plate</span> = <span class="i">$original_plate</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$well</span>  = <span class="i">$original_well</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="i">$use_NA</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$size</span> =~ <span class="q">/^1\b/</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$well</span> <span class="k">eq</span> <span class="q">'N/A'</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$well</span> = <span class="q">'A01'</span> <span class="s">}</span>
        <span class="s">}</span>

        <span class="c">## get originally specified plate / wells from mapping hash ##</span>
        <span class="k">my</span> <span class="i">$input_plates</span> = <span class="i">$Map</span>{<span class="q">&quot;$plate-$well&quot;</span>}<span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span> <span class="i">$input_plates</span> =~ <span class="q">/(\d+)\-(.*?)\;/g</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$plate</span> = <span class="i">$1</span><span class="sc">;</span>
            <span class="i">$well</span>  = <span class="i">$2</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$size</span> =~ <span class="q">/^1\b/</span> <span class="s">)</span> &amp;&amp; <span class="i">$well</span> =~ <span class="q">/^(N\/A|A01)/</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span>   <span class="s">(</span><span class="i">$use_NA</span><span class="s">)</span> <span class="s">{</span> <span class="i">$well</span> = <span class="q">'N/A'</span> <span class="s">}</span>
                <span class="k">else</span>           <span class="s">{</span> <span class="i">$well</span> = <span class="q">'A01'</span> <span class="s">}</span>
            <span class="s">}</span>

            <span class="k">if</span> <span class="s">(</span><span class="i">$tray_ids</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$Tray_map</span>{<span class="i">$plate</span>}{<span class="i">$well</span>} =~ <span class="q">/(\d+)\-(.*)/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="i">$tray</span>     = <span class="i">$1</span><span class="sc">;</span>
                    <span class="k">my</span> <span class="i">$position</span> = <span class="i">$2</span><span class="sc">;</span>
                    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Map $plate $well back to Tray $tray $position.&quot;</span><span class="s">)</span> <span class="s">}</span>
                    <span class="i">$Samples</span>{<span class="i">$tray</span>}{<span class="i">$position</span>} = <span class="i">$Sample_info</span>{<span class="w">FK_Sample__ID</span>}[<span class="i">$i</span>]<span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">else</span> <span class="s">{</span>
                    <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Could not find mapping for Tray to PLA $plate $well&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="i">$Samples</span>{<span class="i">$plate</span>}{<span class="i">$well</span>} = <span class="i">$Sample_info</span>{<span class="w">FK_Sample__ID</span>}[<span class="i">$i</span>]<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="i">HTML_Dump</span> \<span class="i">%Samples</span> <span class="s">}</span>

    <span class="k">return</span> \<span class="i">%Samples</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################</span>
<span class="c"># displays button for create new Tray from selected plate items</span>
<span class="c">#</span>
<span class="c">##############################</span>
<a name="set_plate_info_btn-"></a><span class="k">sub </span><span class="m">set_plate_info_btn</span> <span class="s">{</span>
<span class="c">##############################</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span><span class="cm">,</span> -<span class="w">args</span> <span class="cm">=&gt;</span> <span class="q">'dbc'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>

    <span class="c">##Opens a new tab when you click on it</span>
    <span class="c">##Have read that &quot;_blank&quot; expression might not work with internet explorer</span>
    <span class="k">my</span> <span class="i">$onClick</span> = <span class="q">&quot;this.form.target='_blank';sub_cgi_app( 'alDente::Container_App' )&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$form_output</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="i">$form_output</span> .= <span class="q">&quot;Tray Label:&quot;</span> . <span class="i">textfield</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Tray Label'</span><span class="cm">,</span> -<span class="w">size</span> <span class="cm">=&gt;</span> <span class="n">20</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$form_output</span> .= <span class="i">Show_Tool_Tip</span><span class="s">(</span> <span class="i">submit</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'rm'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'Create New Tray'</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Action'</span><span class="cm">,</span> -<span class="w">onClick</span> <span class="cm">=&gt;</span> <span class="i">$onClick</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="cm">,</span> <span class="q">&quot;Create new tray from selected plate items&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$form_output</span> .= <span class="i">hidden</span><span class="s">(</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="q">'sub_cgi_application'</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$form_output</span> .= <span class="i">hidden</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'DISPLAY_SUB_CGI_PAGE'</span><span class="cm">,</span> -<span class="w">value</span> <span class="cm">=&gt;</span> <span class="q">'true'</span><span class="cm">,</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$form_output</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># Wrapper to merge libraries from a list of plates into a new hybrid library</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Return: new library name</span>
<span class="c">#################</span>
<a name="merge_libs-"></a><span class="k">sub </span><span class="m">merge_libs</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="k">my</span> <span class="i">%args</span>        = <span class="i">&amp;filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>         = <span class="i">$args</span>{-<span class="w">dbc</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_id</span>    = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{-<span class="w">plate_id</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$on_conflict</span> = <span class="i">$args</span>{-<span class="w">on_conflict</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$test</span>        = <span class="i">$args</span>{-<span class="w">test</span>}<span class="sc">;</span>                                              <span class="c">## suppress messages (use this flag if calling only to retrieve conflict values first)</span>

    <span class="c">## CUSTOM PRESET VARIOUS On_Conflict Settings ##</span>

    <span class="i">$on_conflict</span>-&gt;{<span class="w">Library_Obtained_Date</span>}  = <span class="i">&amp;today</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">External_Library_Name</span>}  = <span class="q">'&lt;clear&gt;'</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">FK_Patient__ID</span>}         = <span class="q">'&lt;clear&gt;'</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">Defined_Date</span>}           = <span class="i">&amp;today</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">FK_Pathology__ID</span>}       = <span class="q">''</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">Pathology_Grade</span>}        = <span class="q">'&lt;distinct concat&gt;'</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">Pathology_Occurrence</span>}   = <span class="q">'Unspecified'</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">FK_Anatomic_Site__ID</span>}   = <span class="q">''</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">FK_Contact__ID</span>}         = <span class="q">'&lt;clear&gt;'</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">FKCreated_Employee__ID</span>} = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'user_id'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">Disease_Status</span>}         = <span class="q">'Mixed'</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">Library_Description</span>}    = <span class="q">'pooled hybrid library'</span><span class="sc">;</span>
    <span class="i">$on_conflict</span>-&gt;{<span class="w">Description</span>}            = <span class="q">'hybrid OS'</span><span class="sc">;</span>

    <span class="c">######################################</span>

    <span class="c">## hash input references for feedback ##</span>
    <span class="k">my</span> <span class="i">$unresolved</span> = <span class="i">$args</span>{-<span class="w">unresolved</span>} || <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$preset</span>     = <span class="i">$args</span>{-<span class="w">preset</span>}     || <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span>      = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$tables</span>         = <span class="q">'Plate,Library,Original_Source,Plate_Sample,Sample'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields</span>         = <span class="s">(</span> <span class="q">'Group_Concat(DISTINCT Plate_ID) as Plate'</span><span class="cm">,</span> <span class="q">'Group_Concat(DISTINCT FK_Source__ID) as Source'</span><span class="cm">,</span> <span class="q">'Group_Concat(DISTINCT Library_Name) as Library'</span><span class="cm">,</span> <span class="q">'Group_Concat(DISTINCT Original_Source_ID) as Original_Source'</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$join_condition</span> = <span class="q">&quot;Plate.FK_Library__Name=Library_Name AND Library.FK_Original_Source__ID=Original_Source_ID AND Plate.FKOriginal_Plate__ID = Plate_Sample.FKOriginal_Plate__ID AND Plate_Sample.FK_Sample__ID=Sample_ID&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%Distinct</span>       = <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve</span><span class="s">(</span> <span class="i">$tables</span><span class="cm">,</span> \<span class="i">@fields</span><span class="cm">,</span> <span class="q">&quot;WHERE $join_condition AND Plate_ID IN ($plate_id)&quot;</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@retrieved</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$Distinct</span>{<span class="w">Plate</span>}[<span class="n">0</span>]<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@input</span>     = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$plate_id</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$OSid</span><span class="cm">,</span> <span class="i">$Lib</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$table</span> <span class="s">(</span> <span class="q">'Original_Source'</span><span class="cm">,</span> <span class="q">'Library'</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$list</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$Distinct</span>{<span class="i">$table</span>}[<span class="n">0</span>]<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span><span class="cm">,</span> -<span class="w">autoquote</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$id</span> = <span class="i">$dbc</span><span class="i">-&gt;create_merged_data</span><span class="s">(</span> -<span class="w">table</span> <span class="cm">=&gt;</span> <span class="i">$table</span><span class="cm">,</span> -<span class="w">primary_list</span> <span class="cm">=&gt;</span> <span class="i">$list</span><span class="cm">,</span> -<span class="w">preset</span> <span class="cm">=&gt;</span> <span class="i">$preset</span><span class="cm">,</span> -<span class="w">unresolved_conflict</span> <span class="cm">=&gt;</span> <span class="i">$unresolved</span><span class="cm">,</span> -<span class="w">on_conflict</span> <span class="cm">=&gt;</span> <span class="i">$on_conflict</span><span class="cm">,</span> -<span class="w">debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span><span class="cm">,</span> -<span class="w">test</span> <span class="cm">=&gt;</span> <span class="i">$test</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$id</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">'Original_Source'</span> <span class="s">)</span> <span class="s">{</span>
                <span class="c">## add reference to new hybrid OS ##</span>
                <span class="i">$OSid</span> = <span class="i">$id</span><span class="sc">;</span>
                <span class="i">$on_conflict</span>-&gt;{<span class="w">FK_Original_Source__ID</span>} = <span class="i">$id</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">elsif</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">'Library'</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$Lib</span> = <span class="i">$id</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> !<span class="i">$test</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">&quot;Failed to create merged $table&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">%</span>{<span class="i">$unresolved</span>} &amp;&amp; !<span class="i">$test</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Unresolved conflicts remain&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$msg</span> = <span class="w">HTML_Dump</span> <span class="q">'Unresolved'</span><span class="cm">,</span> <span class="i">$unresolved</span><span class="cm">,</span> <span class="q">'Preset'</span><span class="cm">,</span> <span class="i">$preset</span><span class="cm">,</span> <span class="q">'OC'</span><span class="cm">,</span> <span class="i">$on_conflict</span><span class="sc">;</span>
        <span class="i">$dbc</span><span class="i">-&gt;debug_message</span><span class="s">(</span><span class="i">$msg</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> !<span class="i">$test</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Creating Merged Hybrid Records for Libray $Lib [OS = $OSid]&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$Lib</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">##############################################</span>
<span class="c">#  Defining and Creating New Plates</span>
<span class="c">##############################################</span>

<span class="c">##################################################</span>
<span class="c"># Layers in main plate page (plate object loaded)</span>
<span class="c">##################################################</span>

<span class="c">##############################</span>
<span class="c"># main_footer                #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># perldoc_footer             #</span>
<span class="c">##############################</span>

</pre><p></p>
<hr />
<h1><a name="known_issues__uplink_">KNOWN ISSUES &lt;UPLINK&gt;</a></h1>
<p>&lt;&lt;KNOWN ISSUES&gt;&gt;</p>
<p>
</p>
<hr />
<h1><a name="future_improvements__uplink_">FUTURE IMPROVEMENTS &lt;UPLINK&gt;</a></h1>
<p>&lt;&lt;FUTURE IMPROVEMENTS&gt;&gt;</p>
<p>
</p>
<hr />
<h1><a name="authors__uplink_">AUTHORS &lt;UPLINK&gt;</a></h1>
<p>&lt;&lt;AUTHORS&gt;&gt;</p>
<p>
</p>
<hr />
<h1><a name="created__uplink_">CREATED &lt;UPLINK&gt;</a></h1>
<p>2003-11-27</p>
<p>
</p>
<hr />
<h1><a name="revision__uplink_">REVISION &lt;UPLINK&gt;</a></h1>
<p>$Id: Container.pm,v 1.169 2004/12/03 20:10:19 echuah Exp $ (Release: $Name:  $)</p>

<pre>
<span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<a name="EOF-"></a></pre></body>

</html>
