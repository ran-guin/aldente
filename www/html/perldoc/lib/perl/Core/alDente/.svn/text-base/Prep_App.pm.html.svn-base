<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by perltidy on Mon Jan  7 15:28:51 2013 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/perl/Core/alDente/Prep_App.pm</title>
<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #FFFFFF;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
</head>
<body>
<a name="-top-"></a>
<h1>lib/perl/Core/alDente/Prep_App.pm</h1>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-alDente::Prep_App-">package alDente::Prep_App</a>
<ul>
<li><a href="#setup-">setup</a></li>
<li><a href="#home_page-">home_page</a></li>
<li><a href="#get_param_input-">get_param_input</a></li>
<li><a href="#complete_Protocol_Step-">complete_Protocol_Step</a></li>
<li><a href="#skip_Protocol_Step-">skip_Protocol_Step</a></li>
<li><a href="#edit_Prep-">edit_Prep</a></li>
<li><a href="#annotate_Protocol_Step-">annotate_Protocol_Step</a></li>
<li><a href="#fail_Prep-">fail_Prep</a></li>
<li><a href="#get_Instructions-">get_Instructions</a></li>
<li><a href="#check_History-">check_History</a></li>
<li><a href="#repeat_Protocol_Step-">repeat_Protocol_Step</a></li>
<li><a href="#reprint_Barcodes-">reprint_Barcodes</a></li>
<li><a href="#batch_update_Protocol-">batch_update_Protocol</a></li>
<li><a href="#_continue_Protocol-">_continue_Protocol</a></li>
<li><a href="#continue_Protocol-">continue_Protocol</a></li>
<li><a href="#thaw_Protocol-">thaw_Protocol</a></li>
<li><a href="#inside_Protocol-">inside_Protocol</a></li>
<li><a href="#apply_Solution_to_plate-">apply_Solution_to_plate</a></li>
<li><a href="#batch_Prep-">batch_Prep</a></li>
<li><a href="#continue_Prep-">continue_Prep</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->
<hr />
<!-- contents of filename: lib/perl/Core/alDente/Prep_App.pm -->
<pre>
<span class="c">##################</span>
<span class="c"># Prep_App.pm #</span>
<span class="c">##################</span>
<span class="c">#</span>
<span class="c"># This is a template for the use of various MVC App modules (using the CGI Application module)</span>
<span class="c">##################</span>

<span class="c">##################</span>
<span class="c"># Prep_App.pm #</span>
<span class="c">##################</span>
<span class="c">#</span>
<span class="c"># This module is used to prompt users through Preps.</span>
<span class="c">#</span>
<a name="package-alDente::Prep_App-"></a><span class="k">package </span><span class="i">alDente::Prep_App</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># superclasses               #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># system_variables           #</span>
<span class="c">##############################</span>
<span class="c">##############################</span>
<span class="c"># standard_modules_ref       #</span>
<span class="c">##############################</span>
<span class="c">## Standard modules required ##</span>
<span class="c">#use Imported::CGI_App::Application;</span>
<span class="c">#use base 'CGI::Application';</span>

<span class="c">#use CGI qw(:standard);</span>
<span class="c">#use Imported::CGI_App::Application;</span>
<span class="c">#use base 'CGI::Application';</span>

<span class="k">use</span> <span class="w">base</span> <span class="w">RGTools::Base_App</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="c">##############################</span>
<span class="c"># custom_modules_ref         #</span>
<span class="c">##############################</span>
<span class="c">## Local modules required ##</span>
<span class="k">use</span> <span class="w">RGTools::RGIO</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::DBIO</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::HTML</span> <span class="q">qw(vspace HTML_Dump)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SDB::CustomSettings</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">alDente::Tools</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::SDB_Defaults</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Tray</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Validation</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">alDente::Prep</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">alDente::Prep_Views</span><span class="sc">;</span>
<span class="c">##############################</span>
<span class="c"># global_vars                #</span>
<span class="c">##############################</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(%Configs $URL_temp_dir $html_header)</span><span class="sc">;</span>    <span class="c"># $current_plates $testing %Std_Parameters $homelink $Connection %Benchmark $URL_temp_dir $html_header);</span>

<span class="c">############</span>
<a name="setup-"></a><span class="k">sub </span><span class="m">setup</span> <span class="s">{</span>
<span class="c">############</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;start_mode</span><span class="s">(</span><span class="q">'Show Prep'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;header_type</span><span class="s">(</span><span class="q">'none'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;mode_param</span><span class="s">(</span><span class="q">'rm'</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$self</span><span class="i">-&gt;run_modes</span><span class="s">(</span>
        <span class="s">{</span>   <span class="q">'Get Instructions'</span>                        <span class="cm">=&gt;</span> <span class="q">'get_Instructions'</span><span class="cm">,</span>
            <span class="q">'Completed Step'</span>                          <span class="cm">=&gt;</span> <span class="q">'complete_Protocol_Step'</span><span class="cm">,</span>
            <span class="q">'Skip Step'</span>                               <span class="cm">=&gt;</span> <span class="q">'skip_Protocol_Step'</span><span class="cm">,</span>
            <span class="q">'Go Back One Step'</span>                        <span class="cm">=&gt;</span> <span class="q">'repeat_Protocol_Step'</span><span class="cm">,</span>
            <span class="q">'Repeat Last Step'</span>                        <span class="cm">=&gt;</span> <span class="q">'repeat_Protocol_Step'</span><span class="cm">,</span>
            <span class="q">'Fail Step'</span>                               <span class="cm">=&gt;</span> <span class="q">'fail_Prep'</span><span class="cm">,</span>
            <span class="q">'Re-Print Plate Barcodes'</span>                 <span class="cm">=&gt;</span> <span class="q">'reprint_Barcodes'</span><span class="cm">,</span>
            <span class="q">'Prep Notes'</span>                              <span class="cm">=&gt;</span> <span class="q">'annotate_Protocol_Step'</span><span class="cm">,</span>
            <span class="q">'Fail Prep, Remove Container(s) from Set'</span> <span class="cm">=&gt;</span> <span class="q">'fail_Prep'</span><span class="cm">,</span>

            <span class="q">'Continue with Lab Protocol'</span>            <span class="cm">=&gt;</span> <span class="q">'continue_Protocol'</span><span class="cm">,</span>
            <span class="q">'Continue with Production Protocol'</span>     <span class="cm">=&gt;</span> <span class="q">'continue_Protocol'</span><span class="cm">,</span>
            <span class="q">'Continue with Approved TechD Protocol'</span> <span class="cm">=&gt;</span> <span class="q">'continue_Protocol'</span><span class="cm">,</span>
            <span class="q">'Continue with Pending TechD Protocol'</span>  <span class="cm">=&gt;</span> <span class="q">'continue_Protocol'</span><span class="cm">,</span>

            <span class="q">'Apply Solution to Plate'</span> <span class="cm">=&gt;</span> <span class="q">'apply_Solution_to_plate'</span><span class="cm">,</span>
            <span class="q">'Show Prep'</span>               <span class="cm">=&gt;</span> <span class="q">'home_page'</span><span class="cm">,</span>
            <span class="q">'Edit Prep'</span>               <span class="cm">=&gt;</span> <span class="q">'edit_Prep'</span><span class="cm">,</span>
            <span class="q">'Batch Update'</span>            <span class="cm">=&gt;</span> <span class="q">'batch_Prep'</span><span class="cm">,</span>
            <span class="q">'Update Steps Completed'</span>  <span class="cm">=&gt;</span> <span class="q">'batch_Prep'</span><span class="cm">,</span>
            <span class="q">'Continue with Protocol'</span>  <span class="cm">=&gt;</span> <span class="q">'continue_Prep'</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$ENV</span>{<span class="w">CGI_APP_RETURN_ONLY</span>} = <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$goal</span> = <span class="w">new</span> <span class="i">alDente::Goal</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#    my $lib  = new alDente::Library(-dbc=&gt;$dbc);</span>

    <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span>
        <span class="q">'Goal_Model'</span> <span class="cm">=&gt;</span> <span class="i">$goal</span><span class="cm">,</span>

        <span class="c">#        'Library_Model' =&gt; $lib,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################</span>
<span class="c">#</span>
<span class="c"># home_page (default)</span>
<span class="c">#</span>
<span class="c"># Return: display (table)</span>
<span class="c">#####################</span>
<a name="home_page-"></a><span class="k">sub </span><span class="m">home_page</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$id</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$page</span> = <span class="i">alDente_ref</span><span class="s">(</span> <span class="q">'Prep'</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$page</span> .= <span class="i">$dbc</span><span class="i">-&gt;Table_retrieve_display</span><span class="s">(</span>
        <span class="q">'Prep,Plate_Prep'</span><span class="cm">,</span>
        <span class="s">[</span>   <span class="q">'FK_Plate__ID'</span><span class="cm">,</span> <span class="q">'Prep_Name'</span><span class="cm">,</span>
            <span class="q">'Prep_DateTime as Completed'</span><span class="cm">,</span>
            <span class="q">'FK_Employee__ID as Prepped_By'</span><span class="cm">,</span>
            <span class="q">&quot;FK_Equipment__ID as Equipment&quot;</span><span class="cm">,</span>
            <span class="q">'FK_Solution__ID as Solution'</span><span class="cm">,</span>
            <span class="q">&quot;CONCAT(Solution_Quantity,' ', Solution_Quantity_Units) as Sol_Qty&quot;</span><span class="cm">,</span>
            <span class="q">&quot;CONCAT(Transfer_Quantity,' ', Transfer_Quantity_Units) as Xfer_Qty&quot;</span>
        <span class="s">]</span><span class="cm">,</span>
        <span class="q">&quot;WHERE FK_Prep__ID=Prep_ID AND Prep_ID = '$id'&quot;</span><span class="cm">,</span>
        -<span class="w">return_html</span> <span class="cm">=&gt;</span> <span class="n">1</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$page</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################</span>
<a name="get_param_input-"></a><span class="k">sub </span><span class="m">get_param_input</span> <span class="s">{</span>
<span class="c">######################</span>
    <span class="k">my</span> <span class="i">$self</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span>  = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>     = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>   = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$debug</span> = <span class="i">$args</span>{-<span class="w">debug</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Input</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$name</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$value</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="i">$name</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$dbc</span><span class="i">-&gt;foreign_key_check</span><span class="s">(</span> -<span class="w">field</span> <span class="cm">=&gt;</span> <span class="i">$name</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$value</span> = <span class="i">alDente::Scanner::scanned_barcode</span><span class="s">(</span><span class="i">$name</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span>    <span class="c">## enable custom scanned barcode conversions for Foreign key fields ##</span>
        <span class="i">$Input</span>{<span class="i">$name</span>} = <span class="i">$value</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span>                                                                                               <span class="c">### testing is a global variable that provides verbose feedback</span>
            <span class="k">my</span> <span class="i">$values</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="i">$name</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Input: $name = ($values)&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">%Input</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># Completed single step of protocol - Records and goes to next step...</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">############################</span>
<a name="complete_Protocol_Step-"></a><span class="k">sub </span><span class="m">complete_Protocol_Step</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%Input</span> = <span class="i">$self</span><span class="i">-&gt;get_param_input</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="c">## allow input parameters for testing only ##</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Prep</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Freeze Protocol'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">Safe_Thaw</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Freeze Protocol'</span><span class="cm">,</span> -<span class="w">thaw</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plates</span> &amp;&amp; <span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No Frozen Protocol or Plate/Protocol specifications'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$step</span> = <span class="i">$Prep</span>-&gt;{<span class="w">Step</span>}-&gt;{ <span class="i">$Prep</span>-&gt;{<span class="w">thisStep</span>} }<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$comments</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Append Comments'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$comments</span><span class="s">)</span> <span class="s">{</span> <span class="i">$Input</span>{<span class="w">Prep_Comments</span>} = <span class="q">&quot;$comments;\n&quot;</span> . <span class="i">$Input</span>{<span class="w">Prep_Comments</span>} <span class="s">}</span>
    <span class="k">my</span> <span class="i">$action</span> = <span class="q">'Completed'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$Prep</span><span class="i">-&gt;Record</span><span class="s">(</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="i">$step</span><span class="cm">,</span> -<span class="w">input</span> <span class="cm">=&gt;</span> \<span class="i">%Input</span><span class="cm">,</span> -<span class="w">action</span> <span class="cm">=&gt;</span> <span class="i">$action</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## -input =&gt; $input );</span>

    <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Recorded $step... continue&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$output</span> = <span class="i">$self</span><span class="i">-&gt;_continue_Protocol</span><span class="s">(</span><span class="i">$Prep</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$output</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<a name="skip_Protocol_Step-"></a><span class="k">sub </span><span class="m">skip_Protocol_Step</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="c">## allow input parameters for testing only ##</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Prep</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Freeze Protocol'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">Safe_Thaw</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Freeze Protocol'</span><span class="cm">,</span> -<span class="w">thaw</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plates</span> &amp;&amp; <span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No Frozen Protocol or Plate/Protocol specifications'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$step</span> = <span class="i">$Prep</span>-&gt;{<span class="w">Step</span>}-&gt;{ <span class="i">$Prep</span>-&gt;{<span class="w">thisStep</span>} }<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$action</span> = <span class="q">'Skipped'</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$Prep</span><span class="i">-&gt;Record</span><span class="s">(</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="i">$step</span><span class="cm">,</span> -<span class="w">action</span> <span class="cm">=&gt;</span> <span class="i">$action</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">##  -input =&gt; $input );</span>

    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;_continue_Protocol</span><span class="s">(</span><span class="i">$Prep</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<a name="edit_Prep-"></a><span class="k">sub </span><span class="m">edit_Prep</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span>    = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>     = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>       = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$prep_id</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'FK_Prep__ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$prep_id</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$dbc</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;Must provide prep id to edit&quot;</span><span class="s">)</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">@plate_preps</span> = <span class="i">$dbc</span><span class="i">-&gt;Table_find</span><span class="s">(</span> <span class="q">'Plate_Prep'</span><span class="cm">,</span> <span class="q">&quot;Plate_Prep_ID&quot;</span><span class="cm">,</span> <span class="q">&quot;WHERE FK_Prep__ID IN ($prep_id)&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$pp_ids</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@plate_preps</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$pp_ids</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="q">&quot;No IDs ($pp_ids) specified.&quot;</span> <span class="s">}</span>

    <span class="k">my</span> <span class="i">$page</span> = <span class="i">SDB::DB_Form_Views::choose_Fields</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$pp_ids</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Plate_Prep'</span> <span class="s">)</span> . <span class="q">&quot;&lt;hr&gt;&quot;</span><span class="sc">;</span>
    <span class="i">$page</span> .= <span class="i">SDB::DB_Form_Views::choose_Fields</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$prep_id</span><span class="cm">,</span> -<span class="w">class</span> <span class="cm">=&gt;</span> <span class="q">'Prep'</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$page</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">############################</span>
<a name="annotate_Protocol_Step-"></a><span class="k">sub </span><span class="m">annotate_Protocol_Step</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="c">## allow input parameters for testing only ##</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Prep</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Freeze Protocol'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">Safe_Thaw</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Freeze Protocol'</span><span class="cm">,</span> -<span class="w">thaw</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plates</span> &amp;&amp; <span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No Frozen Protocol or Plate/Protocol specifications'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$note</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Prep Plate Note'</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$Prep</span><span class="i">-&gt;annotate_Plates</span><span class="s">(</span> -<span class="w">note</span> <span class="cm">=&gt;</span> <span class="i">$note</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;_continue_Protocol</span><span class="s">(</span><span class="i">$Prep</span><span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#############################################################</span>
<span class="c"># Remove plates from plate set, and fail them for this step</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#################</span>
<a name="fail_Prep-"></a><span class="k">sub </span><span class="m">fail_Prep</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="c">## allow input parameters for testing only ##</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Prep</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Freeze Protocol'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">Safe_Thaw</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Freeze Protocol'</span><span class="cm">,</span> -<span class="w">thaw</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plates</span> &amp;&amp; <span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No Frozen Protocol or Plate/Protocol specifications'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$step</span> = <span class="i">$Prep</span>-&gt;{<span class="w">Step</span>}-&gt;{ <span class="i">$Prep</span>-&gt;{<span class="w">thisStep</span>} }<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ok</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plates To Fail Prep'</span><span class="s">)</span> <span class="k">eq</span> <span class="q">''</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c">### The user is trying to fail all the plates, ask for confirmation</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Confirm Fail'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c"># Fail all of current plates</span>
            <span class="k">my</span> <span class="i">$plate_ids</span> = <span class="i">&amp;get_aldente_id</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Current Plates'</span><span class="s">)</span><span class="cm">,</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">validate</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$ok</span> = <span class="i">$Prep</span><span class="i">-&gt;fail_Plate</span><span class="s">(</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span><span class="cm">,</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="i">$step</span><span class="cm">,</span> -<span class="w">note</span> <span class="cm">=&gt;</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Prep Plate Note'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="k">return</span> <span class="i">$Prep</span><span class="i">-&gt;prompt_User</span><span class="s">(</span> -<span class="w">confirm_fail</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="c">### The user is only failing a set of plates, check to see if plates are in Current_Plates</span>

        <span class="k">my</span> <span class="i">$plate_ids</span> = <span class="i">get_aldente_id</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plates To Fail Prep'</span><span class="s">)</span><span class="cm">,</span> <span class="q">'Plate'</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># Check to see if requested plates exist in the current plates list</span>
        <span class="k">my</span> <span class="i">@Current_Plates</span> = <span class="k">split</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Current Plates'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">@ToFail</span> = <span class="k">split</span><span class="s">(</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$plate_ids</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@invalids</span><span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$id</span> <span class="s">(</span><span class="i">@ToFail</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> !<span class="k">grep</span><span class="s">(</span> <span class="q">/^$id$/</span><span class="cm">,</span> <span class="i">@Current_Plates</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span><span class="s">(</span> <span class="i">@invalids</span><span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">@invalids</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$ids</span> = <span class="k">join</span> <span class="q">','</span><span class="cm">,</span> <span class="i">@invalids</span><span class="sc">;</span>
            <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Container $ids not in the current plate set&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$ok</span> = <span class="i">$Prep</span><span class="i">-&gt;fail_Plate</span><span class="s">(</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span><span class="cm">,</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="i">$step</span><span class="cm">,</span> -<span class="w">note</span> <span class="cm">=&gt;</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Prep Plate Note'</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;_continue_Protocol</span><span class="s">(</span><span class="i">$Prep</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###########################</span>
<a name="get_Instructions-"></a><span class="k">sub </span><span class="m">get_Instructions</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>

    <span class="c">## allow input parameters for testing only ##</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Prep</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Freeze Protocol'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">Safe_Thaw</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Freeze Protocol'</span><span class="cm">,</span> -<span class="w">thaw</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plates</span> &amp;&amp; <span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No Frozen Protocol or Plate/Protocol specifications'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$prompted</span> = <span class="i">$Prep</span><span class="i">-&gt;prompt_User</span><span class="s">(</span> -<span class="w">instructions</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$prompted</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###########################</span>
<a name="check_History-"></a><span class="k">sub </span><span class="m">check_History</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="c">## allow input parameters for testing only ##</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Prep</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Freeze Protocol'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">Safe_Thaw</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Freeze Protocol'</span><span class="cm">,</span> -<span class="w">thaw</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plates</span> &amp;&amp; <span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No Frozen Protocol or Plate/Protocol specifications'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$prompted</span> = <span class="i">$Prep</span><span class="i">-&gt;check_History</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$prompted</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">###########################</span>
<a name="repeat_Protocol_Step-"></a><span class="k">sub </span><span class="m">repeat_Protocol_Step</span> <span class="s">{</span>
<span class="c">###########################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="c">## allow input parameters for testing only ##</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Prep</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Freeze Protocol'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">Safe_Thaw</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Freeze Protocol'</span><span class="cm">,</span> -<span class="w">thaw</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plates</span> &amp;&amp; <span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No Frozen Protocol or Plate/Protocol specifications'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$prev_step</span> = <span class="i">$Prep</span>-&gt;{<span class="w">thisStep</span>}<span class="sc">;</span>
    <span class="i">$prev_step</span> = --<span class="i">$prev_step</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$prev_step_name</span> = <span class="i">$Prep</span>-&gt;{<span class="w">Step</span>}-&gt;{<span class="i">$prev_step</span>}<span class="sc">;</span>
    <span class="i">$dbc</span><span class="i">-&gt;session</span><span class="i">-&gt;message</span><span class="s">(</span><span class="q">&quot;Repeating step $prev_step_name&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$prompted</span> = <span class="i">$Prep</span><span class="i">-&gt;prompt_User</span><span class="s">(</span> -<span class="w">step_num</span> <span class="cm">=&gt;</span> <span class="i">$prev_step</span><span class="cm">,</span> -<span class="w">repeat_last_step</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$prompted</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c"># Reprint barcodes for current plates</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#######################</span>
<a name="reprint_Barcodes-"></a><span class="k">sub </span><span class="m">reprint_Barcodes</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="c">## allow input parameters for testing only ##</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Prep</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Freeze Protocol'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">Safe_Thaw</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Freeze Protocol'</span><span class="cm">,</span> -<span class="w">thaw</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plates</span> &amp;&amp; <span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No Frozen Protocol or Plate/Protocol specifications'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$barcode_name</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Barcode Name'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$curr_plates</span>  = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Current Plates'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%printed_trays</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@plate_list</span> = <span class="k">split</span> <span class="q">','</span><span class="cm">,</span> <span class="i">$curr_plates</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$curr_id</span> <span class="s">(</span><span class="i">@plate_list</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$curr_id</span> <span class="s">)</span> <span class="s">{</span><span class="k">next</span><span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$tray_id</span> = <span class="i">&amp;alDente::Tray::exists_on_tray</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="i">$curr_id</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span><span class="n">1</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">'hello2'</span> <span class="s">}</span>
            <span class="k">unless</span> <span class="s">(</span> <span class="i">$printed_trays</span>{<span class="i">$tray_id</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="i">&amp;alDente::Barcoding::PrintBarcode</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">'Tray'</span><span class="cm">,</span> <span class="i">$curr_id</span><span class="cm">,</span> <span class="q">'print,library_plate'</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$printed_trays</span>{<span class="i">$tray_id</span>} = <span class="n">1</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">&amp;alDente::Barcoding::PrintBarcode</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="q">'Plate'</span><span class="cm">,</span> <span class="i">$curr_id</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;_continue_Protocol</span><span class="s">(</span><span class="i">$Prep</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">######################################################</span>
<span class="c"># Update entire Protcol in one step using batch mode</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">############################</span>
<a name="batch_update_Protocol-"></a><span class="k">sub </span><span class="m">batch_update_Protocol</span> <span class="s">{</span>
<span class="c">############################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$batch_edit</span> = <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plate_set</span> = <span class="i">param</span><span class="s">(</span><span class="q">'Plate_Set_Number'</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## ||=</span>

    <span class="c"># get the plate set number</span>

    <span class="c"># get the plate numbers associated with the plate set</span>
    <span class="k">my</span> <span class="i">$plate_ids</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_IDs'</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># get the lab protocol id</span>
    <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol'</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># get the number of input rows</span>
    <span class="k">my</span> <span class="i">$input_steps</span>  = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'NumInputRows'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_pipeline</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'FK_Pipeline__ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$completed</span>    = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Completed Protocol'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$user_id</span>      = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'user_id'</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">### process all the parameters into a hash of {STEP_NAME}-&gt;{COLUMN_NAME} = VALUE to be passed to update_Protocol</span>

    <span class="k">my</span> <span class="i">%inputhash</span><span class="sc">;</span>

    <span class="c"># get all fields in Prep</span>
    <span class="k">my</span> <span class="i">$dbo</span>     = <span class="w">new</span> <span class="i">SDB::DB_Object</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="q">&quot;Prep&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields</span>  = <span class="i">@</span>{ <span class="i">$dbo</span><span class="i">-&gt;fields</span><span class="s">(</span><span class="s">)</span> }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@checked</span> = <span class="i">param</span><span class="s">(</span><span class="q">'SELECTED'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@order</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$i</span> <span class="s">(</span><span class="i">@checked</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%rowhash</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$prep_name</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$field</span> <span class="s">(</span><span class="i">@fields</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$localfield</span> = <span class="i">$field</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$field</span> =~ <span class="q">/(.+)\.(.+)/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$localfield</span> = <span class="i">$2</span><span class="sc">;</span> <span class="s">}</span>

            <span class="i">$rowhash</span>{<span class="i">$localfield</span>} = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;$field-$i&quot;</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;$localfield-$i&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$field</span> =~ <span class="q">/\bPrep_Name$/i</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$prep_name</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;$field-$i&quot;</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;$localfield-$i&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="i">$inputhash</span>{<span class="i">$prep_name</span>} = \<span class="i">%rowhash</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@order</span><span class="cm">,</span> <span class="i">$prep_name</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> &amp;&amp; <span class="i">$batch_edit</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">@order</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$errors_ref</span> = <span class="i">$Prep</span><span class="i">-&gt;update_Protocol</span><span class="s">(</span> -<span class="w">values</span> <span class="cm">=&gt;</span> \<span class="i">%inputhash</span><span class="cm">,</span> -<span class="w">userid</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">order</span> <span class="cm">=&gt;</span> \<span class="i">@order</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Prep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span><span class="cm">,</span> -<span class="w">suppress_messages_load</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Prep</span><span class="i">-&gt;check_Protocol</span><span class="s">(</span> -<span class="w">error_step</span> <span class="cm">=&gt;</span> <span class="i">$errors_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$Prep</span><span class="i">-&gt;track_completion</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c">#$Prep-&gt;Record( -step =&gt; 'Completed $Prep-&gt;{protocol_name} Protocol', -change_location =&gt; 0 );</span>
            <span class="i">$Prep</span><span class="i">-&gt;Record</span><span class="s">(</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="q">'Completed Protocol'</span><span class="cm">,</span> -<span class="w">change_location</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;no Set defined&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################</span>
<span class="c">## Local method(s) ##</span>
<span class="c">#####################</span>

<span class="c">#</span>
<span class="c"># Continues with current protocol given a Prep object</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#######################</span>
<a name="_continue_Protocol-"></a><span class="k">sub </span><span class="m">_continue_Protocol</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$Prep</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$q</span> = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>

    <span class="c"># Get info regarding previous step</span>
    <span class="k">my</span> <span class="i">$prev_step</span> = <span class="i">$Prep</span>-&gt;{<span class="w">Step</span>}-&gt;{ <span class="i">$Prep</span>-&gt;{<span class="w">thisStep</span>} }<span class="sc">;</span>

    <span class="c"># $dbc-&gt;message(&quot;$action step '$prev_step'&lt;br&gt;&quot;);</span>
    <span class="c"># if ( $q-&gt;param('FK_Solution__ID') ) {</span>
    <span class="c"># $dbc-&gt;message(&quot;Applied solution $input-&gt;{FK_Solution__ID}&lt;BR&gt;&quot;);</span>
    <span class="c"># }</span>
    <span class="i">$Prep</span><span class="i">-&gt;load_Preparation</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span> = <span class="i">$self</span><span class="i">-&gt;thaw_Protocol</span><span class="s">(</span><span class="i">$Prep</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">#if (defined $Prep &amp;&amp; defined $Prep-&gt;{Completed} &amp;&amp; defined $Prep-&gt;{Completed}{&quot;Completed $Prep-&gt;{protocol_name} Protocol&quot;}) {</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$Prep</span> &amp;&amp; <span class="k">defined</span> <span class="i">$Prep</span>-&gt;{<span class="w">Completed</span>} &amp;&amp; <span class="k">defined</span> <span class="i">$Prep</span>-&gt;{<span class="w">Completed</span>}{<span class="q">&quot;Completed Protocol&quot;</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="c">## if protocol is completed revert to display home page for list of current plates ##</span>
        <span class="k">my</span> <span class="i">$current_plates</span> = <span class="i">Cast_List</span><span class="s">(</span> -<span class="w">list</span> <span class="cm">=&gt;</span> <span class="i">$Prep</span>-&gt;{<span class="w">plate_ids</span>}<span class="cm">,</span> -<span class="w">to</span> <span class="cm">=&gt;</span> <span class="q">'string'</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$plates</span> = <span class="w">new</span> <span class="i">alDente::Container</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$output</span> .= <span class="i">$plates</span><span class="i">-&gt;home_page</span><span class="s">(</span> -<span class="w">hide_header</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$output</span><span class="sc">;</span>

    <span class="c">#    return '&lt;hr&gt;';</span>
<span class="s">}</span>

<span class="c">###############################################</span>
<span class="c"># Continues with Protocol one step at a time</span>
<span class="c"># (only comes here to start a Protocol - otherwise it uses thaw_Protocol)</span>
<span class="c">#</span>
<span class="c"># Return: page generated</span>
<span class="c">#######################</span>
<a name="continue_Protocol-"></a><span class="k">sub </span><span class="m">continue_Protocol</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">filter_input</span><span class="s">(</span> \<span class="i">@_</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## if called from another method</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plate_set</span> = <span class="i">$args</span>{-<span class="w">plate_set</span>} || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_Set_Number'</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate Set'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$current_plates</span> = <span class="i">$args</span>{-<span class="w">plate_ids</span>} || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Current Plates'</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate ID'</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_IDs'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$args</span>{-<span class="w">protocol</span>} || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$user_id</span>      = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'user_id'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$scanner_mode</span> = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'scanner_mode'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$rm</span>            = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'rm'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$protocol_type</span> = <span class="q">'Lab Protocol'</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$rm</span> =~ <span class="q">/Continue with (.+)/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$protocol_type</span> = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$protocol</span>      = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="i">$protocol_type</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$batch_edit</span>   = <span class="i">$args</span>{-<span class="w">batch_edit</span>}   || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;Batch_Edit $protocol_type&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dynamic_text</span> = <span class="i">$args</span>{-<span class="w">dynamic_text</span>} || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;Enable Dynamic Text Fields for $protocol_type&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span> <span class="i">Message</span><span class="s">(</span><span class="q">&quot;No protocol chosen&quot;</span><span class="s">)</span><span class="sc">;</span> <span class="k">return</span><span class="sc">;</span> <span class="s">}</span>

    <span class="i">alDente::Container::reset_current_plates</span><span class="s">(</span> <span class="i">$dbc</span><span class="cm">,</span> <span class="i">$current_plates</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># $dbc-&gt;{current_plates} = [split ',', $current_plates];   ## reset current_plates info</span>

    <span class="k">use</span> <span class="w">alDente::Container_Set</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$output</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$shipping</span> = <span class="s">(</span> <span class="i">$protocol</span> =~ <span class="q">/Ship Samples/</span> <span class="s">)</span><span class="sc">;</span>    <span class="c">## if shipping samples, skip container validation..</span>

    <span class="k">my</span> <span class="i">$Set</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> =~ <span class="q">/new/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span><span class="cm">,</span> -<span class="w">skip_validation</span> <span class="cm">=&gt;</span> <span class="i">$shipping</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$plate_set</span> = <span class="i">$Set</span><span class="i">-&gt;save_Set</span><span class="s">(</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Added new set: $plate_set&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span><span class="i">$plate_set</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$Set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span><span class="cm">,</span> -<span class="w">skip_validation</span> <span class="cm">=&gt;</span> <span class="i">$shipping</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> &amp;&amp; <span class="i">$batch_edit</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span> -<span class="w">Set</span> <span class="cm">=&gt;</span> <span class="i">$Set</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span><span class="cm">,</span> -<span class="w">dynamic_text</span> <span class="cm">=&gt;</span> <span class="i">$dynamic_text</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$output</span> .= <span class="i">$Prep</span><span class="i">-&gt;check_Protocol</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span> -<span class="w">Set</span> <span class="cm">=&gt;</span> <span class="i">$Set</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span><span class="cm">,</span> -<span class="w">dynamic_text</span> <span class="cm">=&gt;</span> <span class="i">$dynamic_text</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$output</span> .= <span class="i">$Prep</span><span class="i">-&gt;prompt_User</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> &amp;&amp; !<span class="i">$output</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## re-post container set options ..</span>
        <span class="k">return</span> <span class="q">'&lt;hr&gt;'</span> . <span class="i">$Set</span><span class="i">-&gt;Set_home_info</span><span class="s">(</span> -<span class="w">brief</span> <span class="cm">=&gt;</span> <span class="i">$scanner_mode</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$output</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#########################</span>
<span class="c">#</span>
<span class="c"># Methods below are phased out ? ###</span>
<span class="c">#</span>
<span class="c">###############</span>
<span class="c">###################</span>
<a name="thaw_Protocol-"></a><span class="k">sub </span><span class="m">thaw_Protocol</span> <span class="s">{</span>
<span class="c">###################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$Prep</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>   = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>

    <span class="c">## allow input parameters for testing only ##</span>
    <span class="k">my</span> <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$Prep</span><span class="s">)</span> <span class="s">{</span> <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Freeze Protocol'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$encoded</span> = <span class="i">Safe_Thaw</span><span class="s">(</span> -<span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">'Freeze Protocol'</span><span class="cm">,</span> -<span class="w">thaw</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">encoded</span> <span class="cm">=&gt;</span> <span class="i">$encoded</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$plates</span> &amp;&amp; <span class="i">$protocol</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No Frozen Protocol or Plate/Protocol specifications'</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$scanner_mode</span> = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'scanner_mode'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$prompt</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$Prep</span> &amp;&amp; !<span class="i">$Prep</span><span class="i">-&gt;prompted</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$prompt</span> = <span class="i">$Prep</span><span class="i">-&gt;prompt_User</span><span class="sc">;</span> <span class="s">}</span>

    <span class="i">$Benchmark</span>{<span class="w">deep_freeze</span>} = <span class="w">new</span> <span class="w">Benchmark</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span><span class="i">$prompt</span><span class="s">)</span> <span class="s">{</span>
        <span class="c">## return to main plate(s) pages..</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$Prep</span><span class="i">-&gt;plate_set</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$Set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$Prep</span><span class="i">-&gt;plate_set</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$prompt</span> .= <span class="i">$Set</span><span class="i">-&gt;Set_home_info</span><span class="s">(</span> -<span class="w">brief</span> <span class="cm">=&gt;</span> <span class="i">$scanner_mode</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$Prep</span><span class="i">-&gt;current_plates</span> =~ <span class="q">/,/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$Set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$Prep</span><span class="i">-&gt;current_plates</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$prompt</span> .= <span class="i">$Set</span><span class="i">-&gt;Set_home_info</span><span class="s">(</span> -<span class="w">brief</span> <span class="cm">=&gt;</span> <span class="i">$scanner_mode</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">elsif</span> <span class="s">(</span> <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Current Plates'</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">##  $plate_id || $current_plates ) {</span>
            <span class="k">my</span> <span class="i">$id</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Current Plates'</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>    <span class="c">## $current_plates || $plate_id;</span>
            <span class="k">my</span> <span class="i">$Plate</span> = <span class="w">alDente::Container</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$id</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$type</span> = <span class="i">$Plate</span><span class="i">-&gt;value</span><span class="s">(</span><span class="q">'Plate.Plate_Type'</span><span class="s">)</span> || <span class="q">'Container'</span><span class="sc">;</span>
            <span class="i">$type</span> = <span class="q">'alDente::'</span> . <span class="i">$type</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$object</span> = <span class="i">$type</span><span class="i">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">plate_id</span> <span class="cm">=&gt;</span> <span class="i">$plate_id</span> <span class="s">)</span><span class="sc">;</span>

            <span class="i">$prompt</span> .= <span class="i">$object</span><span class="i">-&gt;home_page</span><span class="s">(</span> -<span class="w">brief</span> <span class="cm">=&gt;</span> <span class="i">$scanner_mode</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
            <span class="i">$prompt</span> = <span class="q">&quot;no current plates or plate sets&quot;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="i">$Benchmark</span>{<span class="w">end_freeze</span>} = <span class="w">new</span> <span class="w">Benchmark</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$prompt</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#######################</span>
<a name="inside_Protocol-"></a><span class="k">sub </span><span class="m">inside_Protocol</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>  = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>    = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$protocol</span>       = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_set</span>      = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_Set_Number'</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate Set'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$current_plates</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Current Plates'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$batch_edit</span>     = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Batch_Edit'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$user_id</span>      = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'user_id'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$scanner_mode</span> = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'scanner_mode'</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span><span class="q">&quot;inside_Protocol&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$prompt</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> =~ <span class="q">/new/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$Set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$plate_set</span> = <span class="i">$Set</span><span class="i">-&gt;save_Set</span><span class="s">(</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">unless</span> <span class="s">(</span><span class="i">$plate_set</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Error: No Plate Sets found.&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">print</span> <span class="i">&amp;alDente::Container::Display_Input</span><span class="s">(</span><span class="i">$dbc</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$page_generated</span><span class="sc">;</span>
    <span class="k">require</span> <span class="w">alDente::Prep</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$Prep</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> &amp;&amp; <span class="i">$batch_edit</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span>
            -<span class="w">dbc</span>      <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span>
            -<span class="w">user</span>     <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span>
            -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span>
            -<span class="w">set</span>      <span class="cm">=&gt;</span> <span class="i">$plate_set</span><span class="cm">,</span>
            -<span class="w">plates</span>   <span class="cm">=&gt;</span> <span class="i">$current_plates</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span><span class="i">-&gt;check_Protocol</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span>
            -<span class="w">dbc</span>      <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span>
            -<span class="w">user</span>     <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span>
            -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span>
            -<span class="w">set</span>      <span class="cm">=&gt;</span> <span class="i">$plate_set</span><span class="cm">,</span>
            -<span class="w">plates</span>   <span class="cm">=&gt;</span> <span class="i">$current_plates</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">$prompt</span> = <span class="i">$Prep</span><span class="i">-&gt;prompt_User</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> &amp;&amp; !<span class="i">$prompt</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## re-post container set options ..</span>
        <span class="k">my</span> <span class="i">$Set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="i">$Set</span><span class="i">-&gt;Set_home_info</span><span class="s">(</span> -<span class="w">brief</span> <span class="cm">=&gt;</span> <span class="i">$scanner_mode</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$prompt</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#######################</span>
<a name="apply_Solution_to_plate-"></a><span class="k">sub </span><span class="m">apply_Solution_to_plate</span> <span class="s">{</span>
<span class="c">#######################</span>
    <span class="k">my</span> <span class="i">$self</span>   = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>    = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>      = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$count</span>  = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Number_of_Solutions'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plates</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">for</span> <span class="k">my</span> <span class="i">$index</span> <span class="s">(</span> <span class="n">0</span> .. <span class="i">$count</span> - <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$solution</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span> <span class="q">'Solution_'</span> . <span class="i">$index</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$amount</span>   = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span> <span class="q">'Apply Quantity_'</span> . <span class="i">$index</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$units</span>    = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span> <span class="q">'Quantity_Units_'</span> . <span class="i">$index</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$Prep</span><span class="i">-&gt;apply_Solution_to_Plate</span><span class="s">(</span> -<span class="w">solution</span> <span class="cm">=&gt;</span> <span class="i">$solution</span><span class="cm">,</span> -<span class="w">plate</span> <span class="cm">=&gt;</span> <span class="i">$plates</span><span class="cm">,</span> -<span class="w">qty</span> <span class="cm">=&gt;</span> <span class="i">$amount</span><span class="cm">,</span> -<span class="w">units</span> <span class="cm">=&gt;</span> <span class="i">$units</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#################</span>
<a name="batch_Prep-"></a><span class="k">sub </span><span class="m">batch_Prep</span> <span class="s">{</span>
<span class="c">#################</span>
    <span class="k">my</span> <span class="i">$self</span>       = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbc</span>        = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>          = <span class="i">$self</span><span class="i">-&gt;query</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$batch_edit</span> = <span class="n">1</span><span class="sc">;</span>

    <span class="c"># get the plate set number</span>
    <span class="i">$plate_set</span> ||= <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_Set_Number'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$plate_ids</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_IDs'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> =~ <span class="q">/new/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$Set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$plate_ids</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$plate_set</span> = <span class="i">$Set</span><span class="i">-&gt;save_Set</span><span class="s">(</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">Message</span><span class="s">(</span><span class="q">&quot;Added new set: $plate_set&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># get the lab protocol id</span>
    <span class="i">$protocol</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol'</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># get the number of input rows</span>
    <span class="k">my</span> <span class="i">$input_steps</span>  = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'NumInputRows'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_pipeline</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'FK_Pipeline__ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$completed</span>    = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Completed Protocol'</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">### process all the parameters into a hash of {STEP_NAME}-&gt;{COLUMN_NAME} = VALUE to be passed to update_Protocol</span>

    <span class="k">my</span> <span class="i">%inputhash</span><span class="sc">;</span>

    <span class="c"># get all fields in Prep</span>
    <span class="k">my</span> <span class="i">$dbo</span>     = <span class="w">new</span> <span class="i">SDB::DB_Object</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">tables</span> <span class="cm">=&gt;</span> <span class="q">&quot;Prep, Plate_Prep&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields</span>  = <span class="i">@</span>{ <span class="i">$dbo</span><span class="i">-&gt;fields</span><span class="s">(</span><span class="s">)</span> }<span class="sc">;</span>
    <span class="k">my</span> <span class="i">@checked</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'SELECTED'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@order</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$i</span> <span class="s">(</span><span class="i">@checked</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%rowhash</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$prep_name</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$field</span> <span class="s">(</span><span class="i">@fields</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$localfield</span> = <span class="i">$field</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$field</span> =~ <span class="q">/(.+)\.(.+)/</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$localfield</span> = <span class="i">$2</span><span class="sc">;</span> <span class="s">}</span>

            <span class="i">$rowhash</span>{<span class="i">$localfield</span>} = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;$field-$i&quot;</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;$localfield-$i&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$field</span> =~ <span class="q">/\bPrep_Name$/i</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$prep_name</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;$field-$i&quot;</span><span class="s">)</span> || <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">&quot;$localfield-$i&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="i">$inputhash</span>{<span class="i">$prep_name</span>} = \<span class="i">%rowhash</span><span class="sc">;</span>
        <span class="k">push</span><span class="s">(</span> <span class="i">@order</span><span class="cm">,</span> <span class="i">$prep_name</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> &amp;&amp; <span class="i">$batch_edit</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">@order</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$ok</span> = <span class="i">$Prep</span><span class="i">-&gt;update_Protocol</span><span class="s">(</span> -<span class="w">values</span> <span class="cm">=&gt;</span> \<span class="i">%inputhash</span><span class="cm">,</span> -<span class="w">userid</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">order</span> <span class="cm">=&gt;</span> \<span class="i">@order</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$Prep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span><span class="cm">,</span> -<span class="w">suppress_messages_load</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span> <span class="s">)</span><span class="sc">;</span>

            <span class="k">if</span> <span class="s">(</span> !<span class="i">$ok</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">Message</span><span class="s">(</span><span class="q">&quot;FAILED...&quot;</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$errors_ref</span> = <span class="i">$Prep</span>-&gt;{<span class="w">errors</span>}<span class="sc">;</span>
                <span class="i">$Prep</span><span class="i">-&gt;check_Protocol</span><span class="s">(</span> -<span class="w">error_step</span> <span class="cm">=&gt;</span> <span class="i">$errors_ref</span> <span class="s">)</span><span class="sc">;</span>

                <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;continue_Protocol</span><span class="s">(</span> -<span class="w">plate_set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span><span class="cm">,</span> -<span class="w">batch_edit</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">else</span> <span class="s">{</span>
                <span class="k">return</span> <span class="i">$self</span><span class="i">-&gt;continue_Protocol</span><span class="s">(</span> -<span class="w">plate_set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span><span class="cm">,</span> -<span class="w">batch_edit</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$completed</span> =~ <span class="q">/yes/i</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$Prep</span><span class="i">-&gt;Record</span><span class="s">(</span> -<span class="w">step</span> <span class="cm">=&gt;</span> <span class="q">'Completed Protocol'</span><span class="cm">,</span> -<span class="w">change_location</span> <span class="cm">=&gt;</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;no Set defined&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#####################</span>
<a name="continue_Prep-"></a><span class="k">sub </span><span class="m">continue_Prep</span> <span class="s">{</span>
<span class="c">#####################</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbc</span> = <span class="i">$self</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'dbc'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$q</span>   = <span class="i">$self</span><span class="i">-&gt;query</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$protocol</span>       = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Protocol'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$plate_set</span>      = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_Set_Number'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$current_plates</span> = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Plate_ID'</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$batch_edit</span>     = <span class="i">$q</span><span class="i">-&gt;param</span><span class="s">(</span><span class="q">'Batch_Edit'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$current_plates</span> <span class="s">)</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$dbc</span><span class="i">-&gt;warning</span><span class="s">(</span><span class="q">'No current plates'</span><span class="s">)</span> <span class="s">}</span>

    <span class="i">SDB::Errors::log_deprecated_usage</span><span class="s">(</span><span class="q">&quot;continue_Prep&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$user_id</span> = <span class="i">$dbc</span><span class="i">-&gt;get_local</span><span class="s">(</span><span class="q">'userid'</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> =~ <span class="q">/new/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$Set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">ids</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$plate_set</span> = <span class="i">$Set</span><span class="i">-&gt;save_Set</span><span class="s">(</span> -<span class="w">force</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$page</span> = <span class="q">&quot;Continuing prep...($batch_edit - $plate_set)&quot;</span><span class="sc">;</span>

    <span class="i">$self</span>-&gt;{<span class="w">set_number</span>} = <span class="i">$plate_set</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$plate_set</span> &amp;&amp; <span class="i">$batch_edit</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">alDente::Prep</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$page</span> .= <span class="i">$Prep</span><span class="i">-&gt;check_Protocol</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
        <span class="k">use</span> <span class="w">alDente::Prep</span><span class="sc">;</span>

        <span class="c">#require &amp;alDente::Prep;  ## &lt;CONSTRUCTION&gt; - WHY is this necessary ??</span>
        <span class="k">my</span> <span class="i">$Prep</span> = <span class="w">new</span> <span class="i">alDente::Prep</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">user</span> <span class="cm">=&gt;</span> <span class="i">$user_id</span><span class="cm">,</span> -<span class="w">type</span> <span class="cm">=&gt;</span> <span class="q">'Plate'</span><span class="cm">,</span> -<span class="w">protocol</span> <span class="cm">=&gt;</span> <span class="i">$protocol</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span><span class="cm">,</span> -<span class="w">plates</span> <span class="cm">=&gt;</span> <span class="i">$current_plates</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$page</span> .= <span class="i">$Prep</span><span class="i">-&gt;prompt_User</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="n">0</span> &amp;&amp; <span class="i">$plate_set</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">## re-post container set options ..</span>
        <span class="k">my</span> <span class="i">$Set</span> = <span class="w">alDente::Container_Set</span><span class="w">-&gt;new</span><span class="s">(</span> -<span class="w">dbc</span> <span class="cm">=&gt;</span> <span class="i">$dbc</span><span class="cm">,</span> -<span class="w">set</span> <span class="cm">=&gt;</span> <span class="i">$plate_set</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$page</span> .= <span class="i">$Set</span><span class="i">-&gt;Set_home_info</span><span class="s">(</span> -<span class="w">brief</span> <span class="cm">=&gt;</span> <span class="i">$scanner_mode</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$page</span><span class="sc">;</span>
<span class="s">}</span>

<span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<a name="EOF-"></a></pre>
</body>
</html>
